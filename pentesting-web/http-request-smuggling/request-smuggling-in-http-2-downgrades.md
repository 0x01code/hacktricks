# Contrabando de Requisi√ß√µes em Downgrades de HTTP/2

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Origens

A principal origem dessa vulnerabilidade √© o fato de que o **reverse proxy** vai **comunicar-se com o cliente** usando **HTTP/2** mas depois vai **transformar** essa **comunica√ß√£o** com o **servidor back-end** para **HTTP/1.1**.

![](<../../.gitbook/assets/image (636) (1).png>)

O problema com essa abordagem √© que o **usu√°rio** vai poder **injetar** **headers** desnecess√°rios na **comunica√ß√£o HTTP/2** que provavelmente **n√£o ser√£o verificados** pelo proxy. Mas ent√£o, quando esses s√£o **injetados cegamente na comunica√ß√£o HTTP/1.1**, **um ataque de contrabando de requisi√ß√µes pode ser realizado**.

## Exemplos

### Desincroniza√ß√£o H2.CL

A especifica√ß√£o do HTTP/2 indica que o **header Content-Length n√£o √© necess√°rio, mas pode ser indicado**. Portanto, o **reverse proxy** vai **tratar todo o conte√∫do enviado pelos usu√°rios** como a requisi√ß√£o, mas ent√£o, ao **rebaixar para HTTP/1.1**, esse **header** vai ser **injetado** na **requisi√ß√£o** e, portanto, o **back-end vai tratar a requisi√ß√£o como 2 requisi√ß√µes diferentes**, como voc√™ pode ver na imagem abaixo:

![](<../../.gitbook/assets/image (639).png>)

### Sequestro de Token de URL H2.TE Desync

A especifica√ß√£o do HTTP/2 tamb√©m indica que **qualquer mensagem contendo campos de cabe√ßalho espec√≠ficos da conex√£o DEVE ser tratada como malformada... mas se voc√™ n√£o seguir essa regra, voc√™ est√° vulner√°vel**.

Esta t√©cnica foi abusada no balanceador de carga da AWS, ent√£o garantir que os usu√°rios acessem um cabe√ßalho Host apontando para um servidor controlado pelo atacante far√° com que eles acessem esse servidor.

![](<../../.gitbook/assets/image (631) (1).png>)

### Sequestro de Cabe√ßalho H2.TE Desync

Esta √© exatamente a mesma t√©cnica que a anterior, mas verificando as requisi√ß√µes, James notou que os clientes estavam pedindo para enviar suas credenciais, ent√£o ele apenas modificou seu servidor para permitir que o CORS lhe enviasse as credenciais das pessoas:

![](<../../.gitbook/assets/image (662) (1) (1) (1) (1) (1).png>)

### H2.TE via Inje√ß√£o de Cabe√ßalho de Requisi√ß√£o

**HTTP/2 tamb√©m n√£o permite colocar caracteres n√£o permitidos nos cabe√ßalhos**, mas se o servidor **n√£o respeitar** essa regra, voc√™ pode **injetar cabe√ßalhos arbitr√°rios** quando a comunica√ß√£o for **rebaixada** para HTTP/1.1.

Neste caso, **o cabe√ßalho Transfer-Encoding foi injetado**.

![](<../../.gitbook/assets/image (648) (1) (1) (1) (1) (1).png>)

### H2.TE via Inje√ß√£o de Nome de Cabe√ßalho

HTTP/2 em alguns servidores permite colocar um **dois-pontos no nome do cabe√ßalho, e com um** voc√™ pode injetar um novo cabe√ßalho dentro do nome do cabe√ßalho como este:

![](<../../.gitbook/assets/image (632) (1).png>)

Note que se voc√™ colocar apenas os caracteres de nova linha enviando um cabe√ßalho sem conte√∫do, a requisi√ß√£o ser√° tratada como **inv√°lida**:

![](<../../.gitbook/assets/image (647) (1) (1) (1).png>)

### H2.TE via Inje√ß√£o de Linha de Requisi√ß√£o

Neste caso, a inje√ß√£o foi realizada dentro da linha de requisi√ß√£o:

![](<../../.gitbook/assets/image (640) (1).png>)

### Inje√ß√£o de Prefixo de URL

Dentro do esquema da conex√£o HTTP/2, voc√™ pode ser capaz de enviar uma URL completa que sobrescrever√° a indicada no caminho:

![](<../../.gitbook/assets/image (661) (1) (1).png>)

### Inje√ß√£o de Linha de Requisi√ß√£o via espa√ßos

![](<../../.gitbook/assets/image (641) (1).png>)

## Reutiliza√ß√£o de conex√£o Frontend->backend

√Äs vezes, voc√™ descobrir√° que ao realizar um ataque de Contrabando de Requisi√ß√µes HTTP **voc√™ s√≥ pode atacar a si mesmo**. Isso pode ser porque o reverse proxy decidiu **usar uma conex√£o diferente com o servidor back-end** por IP.

Note que **mesmo** com essa **restri√ß√£o** voc√™ ainda pode realizar ataques como **bypass de autoriza√ß√£o**, vazamento de cabe√ßalhos internos e ataques de **decep√ß√£o e envenenamento de cache**.

Geralmente essa restri√ß√£o n√£o existe, ent√£o voc√™ pode **contrabandear requisi√ß√µes na conex√£o entre o reverse proxy e o back-end** que outras pessoas est√£o usando, mas √© at√© **poss√≠vel** que o **proxy** n√£o **reutilize uma conex√£o com conex√µes do mesmo IP** (restri√ß√£o bastante pesada para esse tipo de ataque).

![](<../../.gitbook/assets/image (646) (1) (1).png>)

Na restri√ß√£o mais pesada (sem reutiliza√ß√£o de conex√£o), voc√™ detectar√° a vulnerabilidade com a t√©cnica Baseada em Tempo, mas ao test√°-la, voc√™ descobrir√° que √© um "falso positivo".

### Confirma√ß√£o de T√∫nel

Uma maneira de **confirmar** se o **ponto final √© vulner√°vel** mas a conex√£o est√° **dentro de um "t√∫nel"** √© **contrabandear 2 requisi√ß√µes completas** em 1.

O **problema** com **HTTP/1.1** √© que se voc√™ **receber 2 respostas HTTP** voc√™ **n√£o sabe** se o ponto final era **vulner√°vel** ou n√£o e a **requisi√ß√£o "contrabandeada" foi apenas tratada como uma requisi√ß√£o regular**.

No entanto, esta t√©cnica pode ser usada **em HTTP/2** porque se o ponto final era **vulner√°vel** e voc√™ contrabandeou uma requisi√ß√£o, voc√™ ver√° os **cabe√ßalhos da resposta √† requisi√ß√£o contrabandeada na resposta do reverse proxy**:

![](<../../.gitbook/assets/image (652) (1) (1) (1).png>)

### Problema de Vis√£o de T√∫nel

Pode haver outro problema, se a **resposta** √† requisi√ß√£o leg√≠tima **contiver** um **Content-Length**, o **reverse proxy** s√≥ vai **ler os bytes especificados l√° e nada mais, ent√£o voc√™ n√£o ser√° capaz de ler a resposta da requisi√ß√£o contrabandeada.**

No entanto, a **requisi√ß√£o HEAD** **n√£o cont√©m um corpo** mas geralmente **cont√©m** o **Content-Length** como se a requisi√ß√£o fosse um GET. Portanto, enviando uma **requisi√ß√£o HEAD** **em vez de uma POST** voc√™ pode **ler os bytes do Content-Length da HEAD** da resposta da requisi√ß√£o contrabandeada.

![](<../../.gitbook/assets/image (628) (1) (1).png>)

### Vazamento de Cabe√ßalhos Internos via T√∫nel

Se voc√™ encontrar um **par√¢metro POST** dentro da aplica√ß√£o cujo **conte√∫do** vai ser **refletido** na **resposta**, ent√£o voc√™ pode tentar injetar caracteres HTTP/1.1 \r\n dentro de um cabe√ßalho de requisi√ß√£o HTTP/2 para que os novos cabe√ßalhos injetados pelo proxy sejam anexados no par√¢metro POST que ser√° refletido na resposta:

![](<../../.gitbook/assets/image (656) (1) (1).png>)

Note que neste caso o **atacante** s√≥ se importa com a **resposta** √† **primeira** **requisi√ß√£o**, ele n√£o precisa ler a resposta √† segunda requisi√ß√£o contrabandeada inv√°lida.

{% hint style="info" %}
Usando este ataque **contra diferentes partes da web (m√©todo, caminho...)** pode levar a diferentes back-ends sendo usados e **diferentes informa√ß√µes sens√≠veis sendo vazadas**
{% endhint %}

### Envenenamento de Cache via T√∫nel

Neste cen√°rio, uma **requisi√ß√£o HEAD** para a **URL** **cujo** **cache** vai ser **envenenado** √© enviada enquanto **contrabandeia** uma **requisi√ß√£o** cujo **conte√∫do da resposta conter√° o payload** (talvez algum payload XSS).

Devido ao fato de que a **resposta HEAD cont√©m o `Content-Type: text/html`** e porque o reverse proxy acha que a **resposta inteira √† requisi√ß√£o contrabandeada √© o corpo da requisi√ß√£o HEAD**, o **payload XSS** vai ser **tratado como HTML** mesmo que a p√°gina n√£o fosse vulner√°vel a XSS.

![](<../../.gitbook/assets/image (659) (1).png>)

## HTTP/2 Oculto

Geralmente os servidores anunciam o suporte via campo ALPN no handshake TLS, mas alguns n√£o.

Pode ser facilmente detectado usando `curl --http2 --http2-prior-knowledge`

## Ferramentas

* Extens√£o Burp: HTTP Request Smuggler
* [https://github.com/neex/http2smugl](https://github.com/neex/http2smugl)

## Refer√™ncias

* Esta palestra explica perfeitamente todas as t√©cnicas indicadas aqui: [https://www.youtube.com/watch?v=rHxVVeM9R-M](https://www.youtube.com/watch?v=rHxVVeM9R-M)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
