# HTTP/2ダウングレードにおけるリクエストスミグリング

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricks swag**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## 起源

この脆弱性の主な原因は、**リバースプロキシ**が**HTTP/2**を使用して**クライアント**と**通信**するが、その後、**バックエンドサーバ**との**通信**を**HTTP/1.1**に**変換**することです。

![](<../../.gitbook/assets/image (636) (1).png>)

このアプローチの問題は、**ユーザ**が**HTTP/2通信**に不必要な**ヘッダ**を**注入**できることであり、おそらくプロキシによって**チェックされない**可能性があります。しかし、それらが**HTTP/1.1通信に盲目的に注入**されると、**リクエストスミグリング攻撃**が実行される可能性があります。

## 例

### H2.CLデシンク

HTTP/2の仕様では、**Content-Lengthヘッダは必要ではないが指定できる**とされています。したがって、**リバースプロキシ**は**ユーザが送信したすべてのコンテンツ**をリクエストとして扱いますが、その後、**HTTP/1.1にダウングレード**すると、この**ヘッダ**が**リクエストに注入**されるため、**バックエンドはリクエストを2つの異なるリクエストとして処理**します。以下の画像で確認できます。

![](<../../.gitbook/assets/image (639).png>)

### H2.TEデシンクURLトークンハイジャック

HTTP/2の仕様では、**接続固有のヘッダフィールドを含むメッセージは不正形式として扱われるべきですが、このルールに従わない場合は脆弱性があります**。

この技術はAWSロードバランサで悪用され、攻撃者が制御するサーバを指すホストヘッダにユーザがアクセスするようにすると、ユーザはそのサーバにアクセスします。

![](<../../.gitbook/assets/image (631) (1).png>)

### H2.TEデシンクヘッダハイジャック

これは前述の技術とまったく同じですが、Jamesはクライアントが彼に自分の資格情報を送信するよう要求していることに気付きました。そのため、彼は自分のサーバを変更してCORSを許可し、人々の資格情報を送信するようにしました。

![](<../../.gitbook/assets/image (662) (1) (1) (1) (1) (1).png>)

### H2.TEを介したリクエストヘッダの注入

**HTTP/2では許可されていない文字をヘッダに入れることはできません**が、サーバがこのルールを**守っていない**場合、通信が**HTTP/1.1にダウングレード**されたときに**任意のヘッダを注入**することができます。

この場合、**Transfer-Encodingヘッダが注入**されました。

![](<../../.gitbook/assets/image (648) (1) (1) (1) (1) (1).png>)

### H2.TEを介したヘッダ名の注入

一部のサーバでは、HTTP/2でヘッダ名に**コロンを入れることができ、**でヘッダ名内に新しいヘッダを注入することができます。

![](<../../.gitbook/assets/image (632) (1).png>)

ただし、コンテンツのないヘッダを送信するために改行文字のみを入れた場合、リクエストは**無効**として扱われることに注意してください。

![](<../../.gitbook/assets/image (647) (1) (1) (1).png>)

### H2.TEを介したリクエストラインの注入

この場合、注入はリクエストライン内で行われました。

![](<../../.gitbook/assets/image (640) (1).png>)

### URLプレフィックスの注入

HTTP/2接続のスキーム内には、パスで指定されたURLを上書きすることができる場合があります。

![](<../../.gitbook/assets/image (661) (1) (1).png>)

### スペースを介したリクエストラインの注入

![](<../../.gitbook/assets/image (641) (1).png>)

## フロントエンド->バックエンドの接続再利用

時々、HTTPリクエストスミグリング攻撃を実行すると、**自分自身に攻撃できるだけ**の場合があります。これは、リバースプロキシがIPごとに**バックエンドサーバとは異なる接続を使用**することを決定したためかもしれません。

ただし、この制限があっても、**認証バイパス**、内部ヘッダの漏洩、**キャッシュの欺瞞とキャッシュの汚染**などの攻撃を実行することはできます。

通常、この制限は存在しないため、他の人が使用しているリバースプロキシとバックエンドの接続に**リクエストをスミグリング**することができますが、**プロキシ**が**同じIPからの接続と接続を再利用しない**可能性もあります（この種の攻撃にはかなりの制限があります）。

![](<../../.gitbook/assets/image (646) (1) (1).png>)

最も制限が厳しい場合（接続の再利用なし）は、タイムベースの技術で脆弱性を検出しますが、テストしてみると「偽陽性」であることがわかります。
### トンネリングの確認

**エンドポイントが脆弱**であるが、接続が**「トンネル」**内にある場合、**2つの完全なリクエストを1つに組み込む**ことで確認する方法があります。

**HTTP/1.1**の問題は、**2つのHTTPレスポンスを受け取った場合**、エンドポイントが脆弱であるかどうか、または**「組み込まれた」リクエストが通常のリクエストとして処理されたかどうかがわからない**ことです。

しかし、このテクニックは**HTTP/2**で使用することができます。なぜなら、エンドポイントが脆弱であり、リクエストを組み込んだ場合、リバースプロキシからのレスポンスには組み込まれたリクエストのヘッダが含まれているからです。

![](<../../.gitbook/assets/image (652) (1) (1) (1).png>)

### トンネルビジョンの問題

もう1つの問題があります。正規のリクエストへの**レスポンスにContent-Lengthが含まれている場合**、リバースプロキシは指定されたバイト数のみを読み取ります。そのため、組み込まれたリクエストのレスポンスを読み取ることはできません。

ただし、**HEAD**リクエストは**ボディを含まない**が、通常はGETリクエストと同じように**Content-Lengthを含む**ことがあります。したがって、POSTリクエストの代わりにHEADリクエストを送信すると、組み込まれたリクエストのレスポンスのHEAD Content-Lengthバイトを読み取ることができます。

![](<../../.gitbook/assets/image (628) (1) (1).png>)

### トンネリングによる内部ヘッダの漏洩

アプリケーション内に**POSTパラメータ**があり、その**内容がレスポンスに反映**される場合、HTTP/2リクエストヘッダにHTTP/1.1 \r\n文字を注入して、プロキシによって新たに注入されたヘッダがPOSTパラメータに追加され、レスポンスに反映されるようにすることができます。

![](<../../.gitbook/assets/image (656) (1) (1).png>)

この場合、**攻撃者**は**最初のリクエスト**への**レスポンス**にのみ関心があり、組み込まれた無効な2番目のリクエストのリクエストを読み取る必要はありません。

{% hint style="info" %}
この攻撃を**Webのさまざまな部分（メソッド、パスなど）**に対して使用すると、異なるバックエンドが使用され、**異なる機密情報が漏洩する**可能性があります。
{% endhint %}

### トンネリングによるキャッシュの汚染

このシナリオでは、**キャッシュが汚染**される**URL**に対して**HEAD**リクエストが送信され、同時に**レスポンスの内容にペイロードが含まれる**リクエストが組み込まれます（おそらくXSSペイロード）。

**HEADレスポンスには`Content-Type: text/html`**が含まれているため、リバースプロキシは**組み込まれたリクエストの全体のレスポンスをHEADリクエストのボディとして処理**するため、XSSペイロードはXSSに脆弱ではないページでも**HTMLとして処理**されます。

![](<../../.gitbook/assets/image (659) (1).png>)

## 隠されたHTTP/2

通常、サーバーはTLSハンドシェイクのALPNフィールドでサポートを宣伝しますが、一部のサーバーは宣伝しません。

`curl --http2 --http2-prior-knowledge`を使用して簡単に検出できます。

## ツール

* Burp拡張機能：HTTP Request Smuggler
* [https://github.com/neex/http2smugl](https://github.com/neex/http2smugl)

## 参考文献

* このトークでは、ここで説明されているすべてのテクニックが完璧に説明されています：[https://www.youtube.com/watch?v=rHxVVeM9R-M](https://www.youtube.com/watch?v=rHxVVeM9R-M)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロードしたりしたいですか？** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)をご覧ください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **にPRを提出してください。**

</details>
