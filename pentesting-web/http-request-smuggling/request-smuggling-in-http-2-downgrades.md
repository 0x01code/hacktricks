# HTTP/2降级中的请求劫持

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## 起源

这个漏洞的主要起源是**反向代理**将使用**HTTP/2**与**客户端**进行通信，然后将该通信与**后端服务器**转换为**HTTP/1.1**。

![](<../../.gitbook/assets/image (636) (1).png>)

这种方法的问题在于**用户**可以在**HTTP/2通信**中**注入**不必要的**头部**，而这些头部可能**不会被代理检查**。但是，当这些头部**盲目注入到HTTP/1.1通信**中时，就可以进行**请求劫持攻击**。

## 示例

### H2.CL Desync

HTTP/2规范指出**Content-Length头部不是必需的，但可以指定**。因此，**反向代理**将**将用户发送的所有内容**视为请求，但是，当**降级到HTTP/1.1**时，该**头部**将被**注入**到**请求**中，因此，**后端将将请求视为两个不同的请求**，如下图所示：

![](<../../.gitbook/assets/image (639).png>)

### H2.TE Desync URL Token劫持

HTTP/2规范还指出，**任何包含连接特定头部字段的消息都必须被视为格式错误...但如果你不遵循这个规则，你就会有漏洞**。

这种技术被滥用在AWS负载均衡器上，所以确保用户访问一个指向攻击者控制的服务器的Host头部将使他们访问该服务器。

![](<../../.gitbook/assets/image (631) (1).png>)

### H2.TE Desync Header劫持

这与之前的技术完全相同，但是通过检查请求，James注意到客户端要求将其凭据发送给他，所以他只需修改自己的服务器以允许CORS将人们的凭据发送给他：

![](<../../.gitbook/assets/image (662) (1) (1) (1) (1) (1).png>)

### H2.TE通过请求头注入

**HTTP/2也不允许在头部中放置不允许的字符**，但如果服务器**不遵守**这个规则，当通信**降级**到HTTP/1.1时，你可以**注入任意头部**。

在这种情况下，**注入了Transfer-Encoding头部**。

![](<../../.gitbook/assets/image (648) (1) (1) (1) (1) (1).png>)

### H2.TE通过头部名称注入

在某些服务器上，HTTP/2允许在头部名称中放置一个**冒号，然后用一个**可以在头部名称中注入一个新的头部，如下所示：

![](<../../.gitbook/assets/image (632) (1).png>)

请注意，如果只发送换行字符而不发送内容的头部，请求将被视为**无效**：

![](<../../.gitbook/assets/image (647) (1) (1) (1).png>)

### H2.TE通过请求行注入

在这种情况下，注入是在请求行中进行的：

![](<../../.gitbook/assets/image (640) (1).png>)

### URL前缀注入

在HTTP/2连接的方案中，您可以发送一个完整的URL，它将覆盖路径中指定的URL：

![](<../../.gitbook/assets/image (661) (1) (1).png>)

### 通过空格注入请求行

![](<../../.gitbook/assets/image (641) (1).png>)

## 前端->后端连接重用

有时候你会发现进行HTTP请求劫持攻击**只能攻击自己**。这可能是因为反向代理决定每个IP与后端服务器使用**不同的连接**。

请注意，即使有这个**限制**，你仍然可以进行**授权绕过**、内部头部泄漏和**缓存欺骗和缓存污染**等攻击。

通常情况下，这种限制是不存在的，因此你可以**将请求劫持到反向代理和后端之间的连接**，其他人也在使用该连接，但是甚至**可能**代理**不会与来自同一IP的连接重用连接**（对于这种类型的攻击来说是相当严重的限制）。

![](<../../.gitbook/assets/image (646) (1) (1).png>)

在最严格的限制（不重用连接）下，你将使用基于时间的技术检测到漏洞，但在测试时你会发现这是一个“误报”。
### 隧道确认

一种**确认**端点是否存在漏洞但连接位于**隧道内**的方法是将**两个完整请求**伪装成一个。

**HTTP/1.1**的问题在于，如果你**收到两个HTTP响应**，你无法确定端点是否存在漏洞，或者**“伪装”请求是否只被视为常规请求**。

然而，这种技术可以在**HTTP/2**中使用，因为如果端点存在漏洞并且你伪装了一个请求，你将在来自反向代理的响应中看到对伪装请求的响应头：

![](<../../.gitbook/assets/image (652) (1) (1) (1).png>)

### 隧道视野问题

如果合法请求的**响应**包含**Content-Length**，反向代理只会**读取指定的字节数，而不会读取更多，因此你无法读取伪装请求的响应**。

然而，**HEAD**请求**不包含正文**，但通常会像GET请求一样包含**Content-Length**。因此，发送**HEAD**请求而不是POST请求，你可以读取伪装请求响应的**HEAD Content-Length**字节。

![](<../../.gitbook/assets/image (628) (1) (1).png>)

### 通过隧道泄露内部头部信息

如果你在应用程序中找到一个**POST参数**，其**内容**将在**响应中反射**，那么你可以尝试在HTTP/2请求头中注入HTTP/1.1的\r\n字符，以便代理注入的新头部将附加在将在响应中反射的POST参数中：

![](<../../.gitbook/assets/image (656) (1) (1).png>)

请注意，在这种情况下，**攻击者**只关心**第一个请求**的**响应**，他不需要读取伪装的无效第二个请求的请求。

{% hint style="info" %}
使用此攻击**针对Web的不同部分（方法、路径等）**可能导致使用不同的后端，并**泄露不同的敏感信息**
{% endhint %}

### 通过隧道进行缓存污染

在这种情况下，发送一个**HEAD**请求到**URL**，该URL的**缓存将被污染**，同时**伪装**一个**请求**，其**响应内容将包含有效负载**（可能是一些XSS有效负载）。

由于**HEAD响应包含`Content-Type: text/html`**，并且反向代理认为**伪装请求的整个响应是HEAD请求的正文**，即使页面不容易受到XSS攻击，**XSS有效负载**也将被**视为HTML**。

![](<../../.gitbook/assets/image (659) (1).png>)

## 隐藏的HTTP/2

通常，服务器通过TLS握手中的ALPN字段来广告其支持，但有些服务器不会这样做。

可以使用`curl --http2 --http2-prior-knowledge`轻松检测到。

## 工具

* Burp扩展：HTTP请求劫持
* [https://github.com/neex/http2smugl](https://github.com/neex/http2smugl)

## 参考资料

* 这个演讲完美地解释了这里提到的所有技术：[https://www.youtube.com/watch?v=rHxVVeM9R-M](https://www.youtube.com/watch?v=rHxVVeM9R-M)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中**为你的公司做广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>
