# Instalar Certificado Burp

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## Em uma M√°quina Virtual

Primeiramente, voc√™ precisa baixar o certificado Der do Burp. Voc√™ pode fazer isso em _**Proxy**_ --> _**Op√ß√µes**_ --> _**Importar/Exportar certificado CA**_

![](<../../.gitbook/assets/image (367).png>)

**Exporte o certificado no formato Der** e vamos **transform√°-lo** em um formato que o **Android** ser√° capaz de **entender.** Note que **para configurar o certificado burp na m√°quina Android no AVD** voc√™ precisa **executar** esta m√°quina **com** a op√ß√£o **`-writable-system`**.\
Por exemplo, voc√™ pode execut√°-lo assim:

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

Em seguida, para **configurar o certificado do burp**, fa√ßa o seguinte:

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

Uma vez que a **m√°quina terminar de reiniciar**, o certificado do Burp estar√° em uso por ela!

## Usando Magisc

Se voc√™ **rootou seu dispositivo com Magisc** (talvez um emulador), e voc√™ **n√£o consegue seguir** os **passos anteriores** para instalar o certificado do Burp porque o **sistema de arquivos √© somente leitura** e voc√™ n√£o pode remont√°-lo como grav√°vel, h√° outra maneira.

Explicado neste [**v√≠deo**](https://www.youtube.com/watch?v=qQicUW0svB8) voc√™ precisa:

1. **Instalar um certificado CA**: Apenas **arraste e solte** o certificado DER do Burp **alterando a extens√£o** para `.crt` no celular para que seja armazenado na pasta Downloads e v√° para `Instalar um certificado` -> `Certificado CA`

<figure><img src="../../.gitbook/assets/image (50).png" alt="" width="164"><figcaption></figcaption></figure>

* Verifique se o certificado foi armazenado corretamente indo para `Credenciais confi√°veis` -> `USU√ÅRIO`

<figure><img src="../../.gitbook/assets/image (51).png" alt="" width="334"><figcaption></figcaption></figure>

2. **Torn√°-lo confi√°vel pelo sistema**: Baixe o m√≥dulo Magisc [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts) (um arquivo .zip), **arraste e solte** no telefone, v√° para o aplicativo **Magics** no telefone para a se√ß√£o **`M√≥dulos`**, clique em **`Instalar do armazenamento`**, selecione o m√≥dulo `.zip` e uma vez instalado **reinicie** o telefone:

<figure><img src="../../.gitbook/assets/image (52).png" alt="" width="345"><figcaption></figcaption></figure>

* Ap√≥s reiniciar, v√° para `Credenciais confi√°veis` -> `SISTEMA` e verifique se o certificado do Postswigger est√° l√°

<figure><img src="../../.gitbook/assets/image (53).png" alt="" width="314"><figcaption></figcaption></figure>

## P√≥s Android 14

No lan√ßamento mais recente do Android 14, observou-se uma mudan√ßa significativa no tratamento de certificados de Autoridade de Certifica√ß√£o (CA) confi√°veis pelo sistema. Anteriormente, esses certificados estavam localizados em **`/system/etc/security/cacerts/`**, acess√≠veis e modific√°veis por usu√°rios com privil√©gios de root, o que permitia a aplica√ß√£o imediata em todo o sistema. No entanto, com o Android 14, o local de armazenamento foi movido para **`/apex/com.android.conscrypt/cacerts`**, um diret√≥rio dentro do caminho **`/apex`**, que √© imut√°vel por natureza.

Tentativas de remontar o caminho **APEX cacerts** como grav√°vel s√£o frustradas, pois o sistema n√£o permite tais opera√ß√µes. Mesmo tentativas de desmontar ou sobrepor o diret√≥rio com um sistema de arquivos tempor√°rio (tmpfs) n√£o contornam a imutabilidade; aplicativos continuam acessando os dados de certificado originais, independentemente de altera√ß√µes no n√≠vel do sistema de arquivos. Essa resili√™ncia se deve √† montagem **`/apex`** ser configurada com propaga√ß√£o PRIVADA, garantindo que quaisquer modifica√ß√µes dentro do diret√≥rio **`/apex`** n√£o afetem outros processos.

A inicializa√ß√£o do Android envolve o processo `init`, que, ao iniciar o sistema operacional, tamb√©m inicia o processo Zygote. Esse processo √© respons√°vel por lan√ßar processos de aplicativos com um novo namespace de montagem que inclui uma montagem privada **`/apex`**, isolando assim as altera√ß√µes neste diret√≥rio de outros processos.

No entanto, existe uma solu√ß√£o alternativa para aqueles que precisam modificar os certificados CA confi√°veis pelo sistema dentro do diret√≥rio **`/apex`**. Isso envolve remontar manualmente o **`/apex`** para remover a propaga√ß√£o PRIVADA, tornando-o grav√°vel. O processo inclui copiar o conte√∫do de **`/apex/com.android.conscrypt`** para outra localiza√ß√£o, desmontar o diret√≥rio **`/apex/com.android.conscrypt`** para eliminar a restri√ß√£o de somente leitura e, em seguida, restaurar o conte√∫do para sua localiza√ß√£o original dentro de **`/apex`**. Esta abordagem requer a√ß√£o r√°pida para evitar falhas no sistema. Para garantir a aplica√ß√£o dessas altera√ß√µes em todo o sistema, √© recomend√°vel reiniciar o `system_server`, o que efetivamente reinicia todos os aplicativos e coloca o sistema em um estado consistente.
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### Montagem de liga√ß√£o atrav√©s do NSEnter

1. **Configurar um Diret√≥rio Grav√°vel**: Inicialmente, um diret√≥rio grav√°vel √© estabelecido montando um `tmpfs` sobre o diret√≥rio existente de certificados do sistema n√£o-APEX. Isso √© alcan√ßado com o seguinte comando:
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **Preparando Certificados CA**: Ap√≥s configurar o diret√≥rio grav√°vel, os certificados CA que se pretende usar devem ser copiados para este diret√≥rio. Isso pode envolver copiar os certificados padr√£o de `/apex/com.android.conscrypt/cacerts/`. √â essencial ajustar as permiss√µes e r√≥tulos SELinux desses certificados adequadamente.
3. **Montagem de Bind para Zygote**: Utilizando `nsenter`, entra-se no namespace de montagem do Zygote. O Zygote, sendo o processo respons√°vel por iniciar aplicativos Android, requer este passo para garantir que todos os aplicativos iniciados daqui em diante utilizem os certificados CA rec√©m-configurados. O comando usado √©:
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
Isso garante que todo novo aplicativo iniciado seguir√° a configura√ß√£o atualizada de certificados CA.

4. **Aplicando Altera√ß√µes aos Aplicativos em Execu√ß√£o**: Para aplicar as altera√ß√µes aos aplicativos que j√° est√£o em execu√ß√£o, `nsenter` √© novamente usado para entrar individualmente no namespace de cada aplicativo e realizar uma montagem de bind semelhante. O comando necess√°rio √©:
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **Abordagem Alternativa - Reinicializa√ß√£o Suave**: Um m√©todo alternativo envolve realizar o bind mount no processo `init` (PID 1) seguido por uma reinicializa√ß√£o suave do sistema operacional com os comandos `stop && start`. Esta abordagem propagaria as altera√ß√µes em todos os namespaces, evitando a necessidade de abordar individualmente cada aplicativo em execu√ß√£o. No entanto, este m√©todo geralmente √© menos preferido devido ao inconveniente de reinicializa√ß√£o.

## Refer√™ncias

* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
