# Secuestro de Tareas en Android

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para poder arreglarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en todo tu stack tecnol√≥gico, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Tarea, Pila de Vuelta y Actividades en Primer Plano

Una tarea es una colecci√≥n de actividades con las que los usuarios interact√∫an al realizar un trabajo determinado. Las actividades est√°n organizadas en una pila‚Äîla _**pila de vuelta**_‚Äîen el orden en que se abre cada actividad.

La actividad que se **muestra** en la pantalla se llama actividad en **primer plano** y su **tarea** se llama tarea en **primer plano**. En un momento dado, solo **una tarea en primer plano es visible en la pantalla**.

Este es un flujo de actividad simple:

* Solo hay Actividad 1 en primer plano.
* Se inicia la Actividad 2, lo que empuja la Actividad 1 a la Pila de Vuelta. Ahora la Actividad 2 est√° en primer plano.
* Se inicia la Actividad 3, lo que empuja tanto la Actividad 1 como la 2 a la Pila de Vuelta.
* Ahora, cuando se cierra la Actividad 3, la actividad anterior, es decir, la 2, se trae autom√°ticamente al primer plano. As√≠ es como funciona la navegaci√≥n de tareas en Android.

![](<../../.gitbook/assets/image (548).png>)

### Multitarea en Android - Una Tarea

Una tarea est√° compuesta por varias actividades

![](<../../.gitbook/assets/image (549).png>)

### Multitarea en Android - Varias Tareas

Android generalmente gestiona varias tareas

![](<../../.gitbook/assets/image (550).png>)

## Controles de Tarea

![](<../../.gitbook/assets/image (551).png>)

## Ataque de afinidad de tarea

### Afinidad de tarea y Modos de Lanzamiento

La **afinidad de tarea** es un atributo que se define en cada etiqueta `<activity>` en el archivo `AndroidManifest.xml`. Describe a qu√© Tarea prefiere unirse una Actividad.
Por defecto, cada actividad tiene la misma afinidad que el nombre del **paquete**.

Usaremos esto al crear nuestra aplicaci√≥n PoC.
```markup
<activity android:taskAffinity=""/>
```
**Los modos de lanzamiento** permiten definir c√≥mo se asocia una nueva instancia de una actividad con la tarea actual. El atributo [`launchMode`](https://developer.android.com/guide/topics/manifest/activity-element#lmode) especifica una instrucci√≥n sobre c√≥mo se debe lanzar la actividad en una tarea.
Hay cuatro diferentes **Modos de Lanzamiento**:

1. standard (Predeterminado)
2. singleTop
3. **singleTask**
4. singleInstance

Cuando el launchMode est√° configurado como `singleTask`, el sistema Android eval√∫a tres posibilidades y una de ellas es la raz√≥n por la cual nuestro ataque es posible. Aqu√≠ est√°n:

* **Si la instancia de Activity ya existe**:\
Android reanuda la instancia existente en lugar de crear una nueva. Significa que hay como m√°ximo una instancia de actividad en el sistema bajo este modo.
* **Si es necesario crear una nueva instancia de actividad**:\
El Activity Manager Service (AMS) selecciona una tarea para alojar la instancia reci√©n creada encontrando una tarea ‚Äú**coincidente**‚Äù entre todas las tareas existentes. **Una actividad "coincide" con una tarea si tienen la misma afinidad de tarea**. Esta es la raz√≥n por la cual podemos **especificar la misma afinidad de tarea que la aplicaci√≥n vulnerable en nuestra aplicaci√≥n de malware/atacante para que se lance en su tarea en lugar de crear la suya propia**.
* **Sin encontrar una tarea ‚Äúcoincidente‚Äù**:\
El AMS crea una nueva tarea y hace que la nueva instancia de actividad sea la actividad ra√≠z de la tarea reci√©n creada.

### Ataque

La v√≠ctima necesita tener la **aplicaci√≥n maliciosa** **instalada** en su dispositivo. Luego, necesita **abrir** **la** antes de abrir la **aplicaci√≥n vulnerable**. Entonces, cuando se **abre** la **aplicaci√≥n vulnerable**, la **aplicaci√≥n maliciosa** se **abrir√°** **en su lugar**. Si esta aplicaci√≥n maliciosa presenta el **mismo** **inicio de sesi√≥n** que la aplicaci√≥n vulnerable, el **usuario no tendr√° forma de saber que est√° ingresando sus credenciales en una aplicaci√≥n maliciosa**.

**Puedes encontrar un ataque implementado aqu√≠:** [**https://github.com/az0mb13/Task\_Hijacking\_Strandhogg**](https://github.com/az0mb13/Task\_Hijacking\_Strandhogg)

## Prevenci√≥n del secuestro de tareas

Establecer **`taskAffinity=""`** puede ser una soluci√≥n r√°pida para este problema. El modo de lanzamiento tambi√©n se puede configurar como **singleInstance** si la aplicaci√≥n no quiere que otras actividades se unan a tareas que le pertenecen. Tambi√©n se puede agregar una funci√≥n **onBackPressed()** personalizada, para sobrescribir el comportamiento predeterminado.

## **Referencias**

* [**https://blog.dixitaditya.com/android-task-hijacking/**](https://blog.dixitaditya.com/android-task-hijacking/)
* [**https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html**](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para poder solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en todo tu stack tecnol√≥gico, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
