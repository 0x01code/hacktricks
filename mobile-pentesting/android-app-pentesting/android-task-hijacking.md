# Android Task Hijacking

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que importam mais para que voc√™ possa corrigi-las mais r√°pido. Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Tarefa, Pilha de Retorno e Atividades em Primeiro Plano

Uma tarefa √© uma cole√ß√£o de atividades com as quais os usu√°rios interagem ao realizar um determinado trabalho. As atividades s√£o organizadas em uma pilha‚Äî_**pilha de retorno**_‚Äîna ordem em que cada atividade √© aberta.

A atividade que est√° **exibida** na tela √© chamada de **atividade em primeiro plano** e sua **tarefa** √© chamada de **tarefa em primeiro plano**. A qualquer momento, apenas **uma tarefa em primeiro plano √© vis√≠vel na tela**.

Este √© um fluxo de atividade simples:

* H√° apenas a Atividade 1 em primeiro plano.
* A Atividade 2 √© iniciada, o que empurra a Atividade 1 para a Pilha de Retorno. Agora a Atividade 2 est√° em primeiro plano.
* A Atividade 3 √© iniciada, o que empurra as Atividades 1 e 2 para a Pilha de Retorno.
* Agora, quando a Atividade 3 √© fechada, a atividade anterior, ou seja, 2, √© automaticamente trazida para o primeiro plano. √â assim que a navega√ß√£o de tarefas funciona no Android.

![](<../../.gitbook/assets/image (548).png>)

### Multitarefa no Android - Uma Tarefa

Uma tarefa √© composta por v√°rias atividades

![](<../../.gitbook/assets/image (549).png>)

### Multitarefa no Android - V√°rias Tarefas

O Android geralmente gerencia v√°rias tarefas

![](<../../.gitbook/assets/image (550).png>)

## Controles de Tarefa

![](<../../.gitbook/assets/image (551).png>)

## Ataque de afinidade de tarefa

### Afinidade de tarefa e Modos de Lan√ßamento

**Afinidade de tarefa** √© um atributo definido em cada tag `<activity>` no arquivo `AndroidManifest.xml`. Descreve qual Tarefa uma Atividade prefere se juntar.
Por padr√£o, toda atividade tem a mesma afinidade que o nome do **pacote**.

Usaremos isso ao criar nosso aplicativo PoC.
```markup
<activity android:taskAffinity=""/>
```
**Modos de lan√ßamento** permitem definir como uma nova inst√¢ncia de uma atividade √© associada √† tarefa atual. O atributo [`launchMode`](https://developer.android.com/guide/topics/manifest/activity-element#lmode) especifica uma instru√ß√£o sobre como a atividade deve ser lan√ßada em uma tarefa.
Existem quatro diferentes **Modos de Lan√ßamento**:

1. standard (Padr√£o)
2. singleTop
3. **singleTask**
4. singleInstance

Quando o launchMode est√° definido como `singleTask`, o sistema Android avalia tr√™s possibilidades e uma delas √© a raz√£o pela qual nosso ataque √© poss√≠vel. Aqui est√£o elas -

* **Se a inst√¢ncia da Atividade j√° existe**:\
O Android retoma a inst√¢ncia existente em vez de criar uma nova. Isso significa que h√° no m√°ximo uma inst√¢ncia de atividade no sistema sob este modo.
* **Se for necess√°rio criar uma nova inst√¢ncia de atividade**:\
O Activity Manager Service (AMS) seleciona uma tarefa para hospedar a inst√¢ncia rec√©m-criada, encontrando uma correspondente em todas as tarefas existentes. **Uma atividade "corresponde" a uma tarefa se elas t√™m a mesma afinidade de tarefa**. Esta √© a raz√£o pela qual podemos **especificar a mesma afinidade de tarefa que o aplicativo vulner√°vel em nosso malware/aplicativo do atacante para que ele seja lan√ßado em sua tarefa em vez de criar a sua pr√≥pria**.
* **Sem encontrar uma tarefa "correspondente"**:\
O AMS cria uma nova tarefa e torna a nova inst√¢ncia de atividade a atividade raiz da tarefa rec√©m-criada.

### Ataque

A v√≠tima precisa ter o **aplicativo malicioso** **instalado** em seu dispositivo. Em seguida, ela precisa **abri-lo** **antes** de abrir o **aplicativo vulner√°vel**. Ent√£o, quando o **aplicativo vulner√°vel** √© **aberto**, o **aplicativo malicioso** ser√° **aberto** **em vez disso**. Se este aplicativo malicioso apresentar o **mesmo** **login** que o aplicativo vulner√°vel, o **usu√°rio n√£o ter√° como saber que est√° inserindo suas credenciais em um aplicativo malicioso**.

**Voc√™ pode encontrar um ataque implementado aqui:** [**https://github.com/az0mb13/Task\_Hijacking\_Strandhogg**](https://github.com/az0mb13/Task\_Hijacking\_Strandhogg)

## Prevenindo o sequestro de tarefas

Definir **`taskAffinity=""`** pode ser uma corre√ß√£o r√°pida para este problema. O modo de lan√ßamento tamb√©m pode ser definido para **singleInstance** se o aplicativo n√£o quiser que outras atividades se juntem √†s tarefas pertencentes a ele. Uma fun√ß√£o **onBackPressed()** personalizada tamb√©m pode ser adicionada, para substituir o comportamento padr√£o.

## **Refer√™ncias**

* [**https://blog.dixitaditya.com/android-task-hijacking/**](https://blog.dixitaditya.com/android-task-hijacking/)
* [**https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html**](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que importam mais para que voc√™ possa corrigi-las mais rapidamente. Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha de tecnologia, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
