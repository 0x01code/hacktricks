# Android Task Hijacking

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## T√¢che, Pile arri√®re et Activit√©s en premier plan

Une t√¢che est une collection d'activit√©s avec lesquelles les utilisateurs interagissent lorsqu'ils effectuent une certaine t√¢che. Les activit√©s sont organis√©es dans une pile - la _**pile arri√®re**_ - dans l'ordre d'ouverture de chaque activit√©.

L'activit√© qui est **affich√©e** √† l'√©cran est appel√©e une **activit√© en premier plan** et sa **t√¢che** est appel√©e la **t√¢che en premier plan**. √Ä un moment donn√©, seule **une t√¢che en premier plan est visible √† l'√©cran**.

Voici un exemple simple de flux d'activit√© :

* Il n'y a que l'activit√© 1 en premier plan.
* L'activit√© 2 est d√©marr√©e, ce qui pousse l'activit√© 1 dans la pile arri√®re. Maintenant, l'activit√© 2 est en premier plan.
* L'activit√© 3 est d√©marr√©e, ce qui pousse √† la fois l'activit√© 1 et 2 dans la pile arri√®re.
* Maintenant, lorsque l'activit√© 3 est ferm√©e, l'activit√© pr√©c√©dente, c'est-√†-dire 2, est automatiquement ramen√©e en premier plan. C'est ainsi que fonctionne la navigation des t√¢ches sur Android.

![](<../../.gitbook/assets/image (548).png>)

### Multit√¢che Android - Une t√¢che

Une t√¢che est compos√©e de plusieurs activit√©s

![](<../../.gitbook/assets/image (549).png>)

### Multit√¢che Android - Plusieurs t√¢ches

Android g√®re g√©n√©ralement plusieurs t√¢ches

![](<../../.gitbook/assets/image (550).png>)

## Contr√¥le des t√¢ches

![](<../../.gitbook/assets/image (551).png>)

## Attaque par affinit√© de t√¢che

### Affinit√© de t√¢che et modes de lancement

L'**affinit√© de t√¢che** est un attribut d√©fini dans chaque balise `<activity>` du fichier `AndroidManifest.xml`. Il d√©crit √† quelle t√¢che une activit√© pr√©f√®re se joindre.\
Par d√©faut, chaque activit√© a la m√™me affinit√© que le nom du **package**.

Nous utiliserons cela lors de la cr√©ation de notre application PoC.
```markup
<activity android:taskAffinity=""/>
```
**Les modes de lancement** vous permettent de d√©finir comment une nouvelle instance d'une activit√© est associ√©e √† la t√¢che en cours. L'attribut [`launchMode`](https://developer.android.com/guide/topics/manifest/activity-element#lmode) sp√©cifie une instruction sur la fa√ßon dont l'activit√© doit √™tre lanc√©e dans une t√¢che.\
Il existe quatre **modes de lancement** diff√©rents :

1. standard (par d√©faut)
2. singleTop
3. **singleTask**
4. singleInstance

Lorsque le mode de lancement est d√©fini sur `singleTask`, le syst√®me Android √©value trois possibilit√©s et l'une d'entre elles est la raison pour laquelle notre attaque est possible. Les voici :

* **Si l'instance de l'activit√© existe d√©j√†** :\
Android reprend l'instance existante au lieu d'en cr√©er une nouvelle. Cela signifie qu'il y a au plus une instance d'activit√© dans le syst√®me sous ce mode.
* **Si la cr√©ation d'une nouvelle instance d'activit√© est n√©cessaire** :\
Le service de gestion des activit√©s (AMS) s√©lectionne une t√¢che pour h√©berger la nouvelle instance cr√©√©e en recherchant une t√¢che "correspondante" parmi toutes les t√¢ches existantes. **Une activit√© "correspond" √† une t√¢che si elles ont la m√™me affinit√© de t√¢che**. C'est la raison pour laquelle nous pouvons **sp√©cifier la m√™me affinit√© de t√¢che que l'application vuln√©rable dans notre application malveillante/pirate afin qu'elle se lance dans leur t√¢che au lieu de cr√©er la sienne**.
* **Sans trouver de t√¢che "correspondante"** :\
Le AMS cr√©e une nouvelle t√¢che et fait de la nouvelle instance d'activit√© l'activit√© racine de la t√¢che nouvellement cr√©√©e.

### Attaque

La victime doit avoir l'**application malveillante** install√©e sur son appareil. Ensuite, elle doit **l'ouvrir** avant d'ouvrir l'**application vuln√©rable**. Ensuite, lorsque l'**application vuln√©rable** est **ouverte**, l'**application malveillante** sera **ouverte √† la place**. Si cette application malveillante pr√©sente le **m√™me formulaire de connexion** que l'application vuln√©rable, **l'utilisateur n'aura aucun moyen de savoir qu'il saisit ses identifiants dans une application malveillante**.

**Vous pouvez trouver une attaque mise en ≈ìuvre ici** : [**https://github.com/az0mb13/Task\_Hijacking\_Strandhogg**](https://github.com/az0mb13/Task\_Hijacking\_Strandhogg)

## Pr√©vention du d√©tournement de t√¢che

D√©finir **`taskAffinity=""`** peut √™tre une solution rapide √† ce probl√®me. Le mode de lancement peut √©galement √™tre d√©fini sur **singleInstance** si l'application ne souhaite pas que d'autres activit√©s rejoignent les t√¢ches qui lui appartiennent. Une fonction **onBackPressed()** personnalis√©e peut √©galement √™tre ajout√©e pour remplacer le comportement par d√©faut.

## **R√©f√©rences**

* [**https://blog.dixitaditya.com/android-task-hijacking/**](https://blog.dixitaditya.com/android-task-hijacking/)
* [**https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html**](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
