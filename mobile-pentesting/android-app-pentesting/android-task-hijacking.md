# Tarefa, Pilha de Retorno e Atividades em Primeiro Plano

Uma tarefa √© uma cole√ß√£o de atividades com as quais os usu√°rios interagem ao realizar um determinado trabalho. As atividades s√£o organizadas em uma pilha - a _**pilha de retorno**_ - na ordem em que cada atividade √© aberta.

A atividade que est√° **exibida** na tela √© chamada de **atividade em primeiro plano** e sua **tarefa** √© chamada de **tarefa em primeiro plano**. Em um determinado momento, apenas **uma tarefa em primeiro plano √© vis√≠vel na tela**.

Este √© um fluxo simples de atividade:

* H√° apenas a Atividade 1 em primeiro plano.
* A Atividade 2 √© iniciada, o que empurra a Atividade 1 para a Pilha de Retorno. Agora a Atividade 2 est√° em primeiro plano.
* A Atividade 3 √© iniciada, o que empurra tanto a Atividade 1 quanto a 2 para a Pilha de Retorno.
* Agora, quando a Atividade 3 √© fechada, a atividade anterior, ou seja, 2, √© trazida automaticamente para o primeiro plano. √â assim que a navega√ß√£o de tarefas funciona no Android.

![](<../../.gitbook/assets/image (548).png>)

## Multitarefa do Android - Uma Tarefa

Uma tarefa √© composta por v√°rias atividades

![](<../../.gitbook/assets/image (549).png>)

## Multitarefa do Android - V√°rias Tarefas

O Android geralmente gerencia v√°rias tarefas

![](<../../.gitbook/assets/image (550).png>)

# Controles de Tarefa

![](<../../.gitbook/assets/image (551).png>)

# Ataque de Afinidade de Tarefa

## Afinidade de Tarefa e Modos de Inicializa√ß√£o

A **afinidade de tarefa** √© um atributo definido em cada tag `<activity>` no arquivo `AndroidManifest.xml`. Ele descreve a qual tarefa uma atividade prefere se juntar.\
Por padr√£o, cada atividade tem a mesma afinidade que o **nome do pacote**.

Vamos usar isso ao criar nosso aplicativo PoC.
```markup
<activity android:taskAffinity=""/>
```
**Modos de lan√ßamento** permitem definir como uma nova inst√¢ncia de uma atividade est√° associada √† tarefa atual. O atributo [`launchMode`](https://developer.android.com/guide/topics/manifest/activity-element#lmode) especifica uma instru√ß√£o sobre como a atividade deve ser lan√ßada em uma tarefa. Existem quatro modos de lan√ßamento diferentes:

1. padr√£o (padr√£o)
2. singleTop
3. **singleTask**
4. singleInstance

Quando o `launchMode` √© definido como `singleTask`, o sistema Android avalia tr√™s possibilidades e uma delas √© a raz√£o pela qual nosso ataque √© poss√≠vel. Aqui est√£o elas:

* **Se a inst√¢ncia da atividade j√° existe**:\
  O Android retoma a inst√¢ncia existente em vez de criar uma nova. Isso significa que h√° no m√°ximo uma inst√¢ncia de atividade no sistema sob este modo.
* **Se for necess√°rio criar uma nova inst√¢ncia de atividade**:\
  O Servi√ßo de Gerenciador de Atividades (AMS) seleciona uma tarefa para hospedar a nova inst√¢ncia criada encontrando uma tarefa "correspondente" em todas as tarefas existentes. **Uma atividade "corresponde" a uma tarefa se elas t√™m a mesma afinidade de tarefa**. Esta √© a raz√£o pela qual podemos **especificar a mesma afinidade de tarefa que o aplicativo vulner√°vel em nosso aplicativo de malware/atacante para que ele seja lan√ßado em sua tarefa em vez de criar a sua pr√≥pria**.
* **Sem encontrar uma tarefa "correspondente"**:\
  O AMS cria uma nova tarefa e torna a nova inst√¢ncia de atividade a atividade raiz da tarefa rec√©m-criada.

## Ataque

A v√≠tima precisa ter o **aplicativo malicioso instalado** em seu dispositivo. Em seguida, ele precisa **abri-lo** antes de abrir o **aplicativo vulner√°vel**. Ent√£o, quando o **aplicativo vulner√°vel √© aberto**, o **aplicativo malicioso** ser√° **aberto em seu lugar**. Se este aplicativo malicioso apresentar o **mesmo login** que o aplicativo vulner√°vel, o **usu√°rio n√£o ter√° meios de saber que est√° inserindo suas credenciais em um aplicativo malicioso**.

**Voc√™ pode encontrar um ataque implementado aqui:** [**https://github.com/az0mb13/Task\_Hijacking\_Strandhogg**](https://github.com/az0mb13/Task\_Hijacking\_Strandhogg)

# Prevenindo o sequestro de tarefas

Definir `taskAffinity=""` pode ser uma solu√ß√£o r√°pida para este problema. O modo de lan√ßamento tamb√©m pode ser definido como **singleInstance** se o aplicativo n√£o quiser que outras atividades se juntem a tarefas pertencentes a ele. Uma fun√ß√£o personalizada **onBackPressed()** tamb√©m pode ser adicionada para substituir o comportamento padr√£o.

# **Refer√™ncias**

* [**https://blog.dixitaditya.com/android-task-hijacking/**](https://blog.dixitaditya.com/android-task-hijacking/)
* [**https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html**](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
