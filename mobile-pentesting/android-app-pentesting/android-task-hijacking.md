# Androidタスクハイジャッキング

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## タスク、バックスタック、フォアグラウンドアクティビティ

タスクは、特定の作業を実行する際にユーザーが対話するアクティビティのコレクションです。アクティビティは、開かれた順にスタック（**バックスタック**）に配置されます。

画面に**表示される**アクティビティは、**フォアグラウンドアクティビティ**と呼ばれ、その**タスク**は**フォアグラウンドタスク**と呼ばれます。一度に、**画面には1つのフォアグラウンドタスクが表示されます**。

以下は、シンプルなアクティビティのフローです：

* フォアグラウンドにはアクティビティ1しかありません。
* アクティビティ2が開始され、アクティビティ1がバックスタックにプッシュされます。これにより、アクティビティ2がフォアグラウンドになります。
* アクティビティ3が開始され、アクティビティ1と2がバックスタックにプッシュされます。
* これでアクティビティ3が閉じられると、前のアクティビティである2が自動的にフォアグラウンドに表示されます。これがAndroidでのタスクナビゲーションの動作方法です。

![](<../../.gitbook/assets/image (548).png>)

### Androidのマルチタスキング - 1つのタスク

1つのタスクは複数のアクティビティで構成されます

![](<../../.gitbook/assets/image (549).png>)

### Androidのマルチタスキング - 複数のタスク

通常、Androidは複数のタスクを管理します

![](<../../.gitbook/assets/image (550).png>)

## タスク制御ツール

![](<../../.gitbook/assets/image (551).png>)

## タスクアフィニティ攻撃

### タスクアフィニティと起動モード

**タスクアフィニティ**は、`AndroidManifest.xml`ファイルの各`<activity>`タグで定義される属性です。それはアクティビティが参加するタスクを指定します。\
デフォルトでは、すべてのアクティビティは**パッケージ**名と同じアフィニティを持ちます。

PoCアプリを作成する際にこれを使用します。
```markup
<activity android:taskAffinity=""/>
```
**起動モード**は、新しいアクティビティのインスタンスが現在のタスクと関連付けられる方法を定義することができます。[`launchMode`](https://developer.android.com/guide/topics/manifest/activity-element#lmode)属性は、アクティビティがどのようにタスクに起動されるかに関する指示を指定します。\
以下には、4つの異なる**起動モード**があります：

1. standard（デフォルト）
2. singleTop
3. **singleTask**
4. singleInstance

`launchMode`が`singleTask`に設定されている場合、Androidシステムは3つの可能性を評価し、そのうちの1つが攻撃が可能な理由です。以下にそれらを示します。

* **アクティビティのインスタンスが既に存在する場合**：\
Androidは新しいインスタンスを作成する代わりに既存のインスタンスを再開します。つまり、このモードではシステムに最大で1つのアクティビティインスタンスが存在します。
* **新しいアクティビティインスタンスの作成が必要な場合**：\
アクティビティマネージャーサービス（AMS）は、すべての既存のタスクの中から「**マッチング**」タスクを見つけることで、新しく作成されたインスタンスをホストするタスクを選択します。**アクティビティがタスクと「マッチング」している場合、タスクアフィニティが同じである**という理由から、**脆弱なアプリと同じタスクアフィニティをマルウェア/攻撃者のアプリに指定することで、自分自身のタスクを作成する代わりにそのタスクで起動できる**のです。
* **「マッチング」タスクが見つからない場合**：\
AMSは新しいタスクを作成し、新しく作成されたアクティビティインスタンスを新しいタスクのルートアクティビティにします。

### 攻撃

被害者は、自分のデバイスに**悪意のあるアプリ**を**インストール**する必要があります。その後、**脆弱な**アプリケーションを**開く****前に**、**悪意のある**アプリケーションを**開く**必要があります。その後、**脆弱な**アプリケーションが**開かれる**と、**悪意のある**アプリケーションが**代わりに開かれます**。この悪意のあるアプリケーションが脆弱なアプリケーションと**同じログイン画面を表示する場合、ユーザーは自分の資格情報を悪意のあるアプリケーションに入力していることを知る手段を持っていません**。

**攻撃の実装例はこちらで見つけることができます:** [**https://github.com/az0mb13/Task\_Hijacking\_Strandhogg**](https://github.com/az0mb13/Task\_Hijacking\_Strandhogg)

## タスクハイジャックの防止

この問題のクイックフィックスとして、**`taskAffinity=""`**を設定することができます。アプリが他のアクティビティを自身のタスクに参加させたくない場合は、起動モードを**singleInstance**に設定することもできます。また、デフォルトの動作を上書きするために、カスタムの**onBackPressed()**関数を追加することもできます。

## **参考文献**

* [**https://blog.dixitaditya.com/android-task-hijacking/**](https://blog.dixitaditya.com/android-task-hijacking/)
* [**https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html**](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロードしたりしたいですか？** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)をご覧ください。独占的な[NFT](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**をフォローしてください**。
* **ハッキングのトリックを共有するには、**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **にPRを提出してください**。

</details>
