# Smali - Decompilando/\[Modificando]/Compilando

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

√Äs vezes √© interessante modificar o c√≥digo do aplicativo para acessar informa√ß√µes ocultas para voc√™ (talvez senhas bem ofuscadas ou flags). Nesse caso, pode ser interessante decompilar o apk, modificar o c√≥digo e recompil√°-lo.

**Refer√™ncia de Opcodes:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Forma R√°pida

Usando o **Visual Studio Code** e a extens√£o [APKLab](https://github.com/APKLab/APKLab), voc√™ pode **decompilar**, modificar, **recompilar**, assinar e instalar automaticamente o aplicativo sem executar nenhum comando.

Outro **script** que facilita muito essa tarefa √© [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## Decompilar o APK

Usando o APKTool, voc√™ pode acessar o **c√≥digo smali e recursos**:
```bash
apktool d APP.apk
```
Se o **apktool** apresentar algum erro, tente [instalar a **√∫ltima vers√£o**](https://ibotpeaches.github.io/Apktool/install/)

Alguns **arquivos interessantes que voc√™ deve procurar s√£o**:

* _res/values/strings.xml_ (e todos os xmls dentro de res/values/\*)
* _AndroidManifest.xml_
* Qualquer arquivo com a extens√£o _.sqlite_ ou _.db_

Se o `apktool` tiver **problemas ao decodificar o aplicativo**, d√™ uma olhada em [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) ou tente usar o argumento **`-r`** (N√£o decodificar recursos). Ent√£o, se o problema estiver em um recurso e n√£o no c√≥digo-fonte, voc√™ n√£o ter√° o problema (voc√™ tamb√©m n√£o descompilar√° os recursos).

## Alterar o c√≥digo Smali

Voc√™ pode **alterar** **instru√ß√µes**, alterar o **valor** de algumas vari√°veis ou **adicionar** novas instru√ß√µes. Eu altero o c√≥digo Smali usando [**VS Code**](https://code.visualstudio.com), ent√£o voc√™ instala a **extens√£o smalise** e o editor ir√° informar se alguma **instru√ß√£o estiver incorreta**.\
Alguns **exemplos** podem ser encontrados aqui:

* [Exemplos de altera√ß√µes no Smali](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Ou voc√™ pode [**ver abaixo algumas altera√ß√µes no Smali explicadas**](smali-changes.md#modifying-smali).

## Recompilar o APK

Ap√≥s modificar o c√≥digo, voc√™ pode **recompilar** o c√≥digo usando:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Ele ir√° **compilar** o novo APK **dentro** da pasta _**dist**_.

Se o **apktool** lan√ßar um **erro**, tente [instalar a **√∫ltima vers√£o**](https://ibotpeaches.github.io/Apktool/install/)

### **Assine o novo APK**

Em seguida, voc√™ precisa **gerar uma chave** (ser√° solicitada uma senha e algumas informa√ß√µes que voc√™ pode preencher aleatoriamente):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Finalmente, **assin** o novo APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Otimizar nova aplica√ß√£o

**zipalign** √© uma ferramenta de alinhamento de arquivos que fornece otimiza√ß√£o importante para arquivos de aplicativos Android (APK). [Mais informa√ß√µes aqui](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Assinar o novo APK (novamente?)**

Se voc√™ **preferir** usar [**apksigner**](https://developer.android.com/studio/command-line/) em vez de jarsigner, **voc√™ deve assinar o apk** ap√≥s aplicar **a otimiza√ß√£o com** zipalign. MAS OBSERVE QUE VOC√ä S√ì PRECISA **ASSINAR O APLICATIVO UMA VEZ** COM jarsigner (antes do zipalign) OU COM apksigner (ap√≥s o zipalign).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Modificando Smali

Para o seguinte c√≥digo Java Hello World:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
O c√≥digo Smali seria:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
O conjunto de instru√ß√µes Smali est√° dispon√≠vel [aqui](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Altera√ß√µes Leves

### Modificar valores iniciais de uma vari√°vel dentro de uma fun√ß√£o

Algumas vari√°veis s√£o definidas no in√≠cio da fun√ß√£o usando o opcode _const_, voc√™ pode modificar seus valores, ou pode definir novas:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Opera√ß√µes B√°sicas
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Mudan√ßas Maiores

### Registro
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recomenda√ß√µes:

* Se voc√™ for usar vari√°veis declaradas dentro da fun√ß√£o (declaradas v0, v1, v2...), coloque essas linhas entre o _.local \<n√∫mero>_ e as declara√ß√µes das vari√°veis (_const v0, 0x1_)
* Se voc√™ deseja inserir o c√≥digo de log no meio do c√≥digo de uma fun√ß√£o:
* Adicione 2 ao n√∫mero de vari√°veis declaradas: Ex: de _.locals 10_ para _.locals 12_
* As novas vari√°veis devem ser os pr√≥ximos n√∫meros das vari√°veis j√° declaradas (neste exemplo, seriam _v10_ e _v11_, lembre-se de que come√ßa em v0).
* Altere o c√≥digo da fun√ß√£o de log e use _v10_ e _v11_ em vez de _v5_ e _v1_.

### Toasting

Lembre-se de adicionar 3 ao n√∫mero de _.locals_ no in√≠cio da fun√ß√£o.

Este c√≥digo est√° preparado para ser inserido no **meio de uma fun√ß√£o** (**altere** o n√∫mero das **vari√°veis** conforme necess√°rio). Ele ir√° pegar o **valor de this.o**, **transform√°-lo** em **String** e ent√£o **fazer** um **toast** com seu valor.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
