# Smali - デコンパイル/修正/コンパイル

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

アプリケーションコードを変更して、隠された情報にアクセスすることは、時に興味深いです（おそらくよく難読化されたパスワードやフラグなど）。そのため、apkをデコンパイルしてコードを変更し、再コンパイルすることが興味深いかもしれません。

**オペコードリファレンス:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## 早い方法

**Visual Studio Code**と[APKLab](https://github.com/APKLab/APKLab)拡張機能を使用すると、コマンドを実行せずにアプリケーションを**自動的にデコンパイル**、修正、**再コンパイル**、署名してインストールすることができます。

このタスクを大幅に簡略化する**スクリプト**もあります。[**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)****

## APKをデコンパイルする

APKToolを使用すると、**smaliコードとリソース**にアクセスできます：
```
apktool d APP.apk
```
もし**apktool**にエラーが出る場合は、[**最新バージョン**](https://ibotpeaches.github.io/Apktool/install/)をインストールしてみてください。

注目すべき**興味深いファイル**は以下の通りです：

* _res/values/strings.xml_ (およびres/values/\*内のすべてのxml)
* _AndroidManifest.xml_
* 拡張子が_.sqlite_または_.db_の任意のファイル

もし`apktool`が**アプリケーションのデコードに問題**を抱えている場合は、[https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files)を参照するか、引数**`-r`**を使用してみてください（リソースをデコードしない）。その後、問題がソースコードではなくリソースにある場合、問題は発生しなくなります（リソースも逆コンパイルされません）。

## Smaliコードの変更

**命令を変更**したり、一部の変数の**値を変更**したり、新しい命令を**追加**することができます。私は[**VS Code**](https://code.visualstudio.com)を使用してSmaliコードを変更します。その後、**smalise拡張機能**をインストールし、エディタが**不正な命令**を教えてくれます。\
以下にいくつかの**例**があります：

* [Smaliの変更の例](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

または、[**以下でSmaliの変更の詳細**を確認できます](smali-changes.md#modifying-smali)。

## APKの再コンパイル

コードを変更した後、以下のコマンドを使用してコードを**再コンパイル**できます：
```bash
apktool b . #In the folder generated when you decompiled the application
```
新しいAPKを**dist**フォルダーの**内部**に**コンパイル**します。

もし**apktool**が**エラー**を出した場合は、[**最新バージョン**](https://ibotpeaches.github.io/Apktool/install/)をインストールしてみてください。

### **新しいAPKに署名する**

次に、**キーを生成**する必要があります（パスワードといくつかの情報が求められますが、ランダムに入力しても構いません）。
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
最後に、新しいAPKに**署名**してください：
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### 新しいアプリケーションの最適化

**zipalign**は、Androidアプリケーション（APK）ファイルに重要な最適化を提供するアーカイブの整列ツールです。[詳細はこちら](https://developer.android.com/studio/command-line/zipalign)。
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **新しいAPKに署名する（再度？）**

もしjarsignerの代わりに\[**apksigner**]\([**https://developer.android.com/studio/command-line/apksigner**](https://developer.android.com/studio/command-line/apksigner))を使用したい場合、zipalignを適用した後にapkに署名する必要があります。ただし、注意してください。apkはjarsigner（zipalignの前）またはaspsigner（zipalignの後）で**一度だけ**署名する必要があります。
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Smaliの変更

以下のHello World Javaコードに対して：
```
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smaliコードは次のようになります：
```
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
Smali命令セットは[こちら](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions)で利用可能です。

### 軽微な変更

### 関数内の変数の初期値を変更する

一部の変数は、関数の最初に_opcode_ _const_を使用して定義されます。これらの値を変更することができます。または、新しい変数を定義することもできます。
```
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### 基本的な操作

In this section, we will cover some basic operations that can be performed on Smali code.

このセクションでは、Smaliコードで実行できるいくつかの基本的な操作について説明します。

#### 1. Modifying Constants

#### 1. 定数の変更

To modify a constant value in Smali code, you need to locate the instruction that loads the constant value onto the stack and replace it with a new value.

Smaliコードで定数値を変更するには、スタックに定数値をロードする命令を見つけて、新しい値に置き換える必要があります。

For example, if you want to change the value of a constant from 123 to 456, you would look for the instruction `const/16 v0, 123` and replace it with `const/16 v0, 456`.

例えば、定数の値を123から456に変更したい場合、命令`const/16 v0, 123`を探して、`const/16 v0, 456`に置き換えます。

#### 2. Modifying Method Calls

#### 2. メソッド呼び出しの変更

To modify a method call in Smali code, you need to locate the instruction that invokes the method and replace it with a new method call.

Smaliコードでメソッド呼び出しを変更するには、メソッドを呼び出す命令を見つけて、新しいメソッド呼び出しに置き換える必要があります。

For example, if you want to change a method call from `invoke-virtual {v0, v1}, Lcom/example/Class;->method()V` to `invoke-static {v0, v1}, Lcom/example/Class;->newMethod()V`, you would replace the `invoke-virtual` instruction with `invoke-static`.

例えば、メソッド呼び出しを`invoke-virtual {v0, v1}, Lcom/example/Class;->method()V`から`invoke-static {v0, v1}, Lcom/example/Class;->newMethod()V`に変更したい場合、`invoke-virtual`命令を`invoke-static`に置き換えます。

#### 3. Modifying Field Access

#### 3. フィールドアクセスの変更

To modify a field access in Smali code, you need to locate the instruction that accesses the field and replace it with a new field access.

Smaliコードでフィールドアクセスを変更するには、フィールドにアクセスする命令を見つけて、新しいフィールドアクセスに置き換える必要があります。

For example, if you want to change a field access from `iget-object v0, v1, Lcom/example/Class;->field:Lcom/example/Field;` to `sget-object v0, Lcom/example/Class;->newField:Lcom/example/Field;`, you would replace the `iget-object` instruction with `sget-object`.

例えば、フィールドアクセスを`iget-object v0, v1, Lcom/example/Class;->field:Lcom/example/Field;`から`sget-object v0, Lcom/example/Class;->newField:Lcom/example/Field;`に変更したい場合、`iget-object`命令を`sget-object`に置き換えます。

#### 4. Modifying Control Flow

#### 4. 制御フローの変更

To modify the control flow in Smali code, you need to locate the instructions that control the flow and modify them accordingly.

Smaliコードで制御フローを変更するには、フローを制御する命令を見つけて、適宜変更する必要があります。

For example, if you want to change a conditional branch from `if-eqz v0, :label` to `if-nez v0, :label`, you would replace the `if-eqz` instruction with `if-nez`.

例えば、条件付き分岐を`if-eqz v0, :label`から`if-nez v0, :label`に変更したい場合、`if-eqz`命令を`if-nez`に置き換えます。

These are just a few examples of the basic operations that can be performed on Smali code. With these operations, you can modify the behavior of an Android app and potentially exploit vulnerabilities.

これらは、Smaliコードで実行できる基本的な操作の一部です。これらの操作を使用することで、Androidアプリの動作を変更し、潜在的な脆弱性を悪用することができます。
```
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### 大きな変更

### ロギング
```
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
推奨事項：

* 関数内で宣言された変数（v0、v1、v2など）を使用する場合は、これらの行を _.local \<number>_ と変数の宣言（_const v0, 0x1_）の間に配置してください。
* 関数のコードの途中にログ出力コードを配置したい場合：
* 宣言された変数の数に2を追加してください。例：_.locals 10_ から _.locals 12_ に変更します。
* 新しい変数は、既に宣言された変数の次の番号である必要があります（この例では _v10_ と _v11_ になります。v0から始まることを忘れないでください）。
* ログ出力関数のコードを変更し、_v5_ と _v1_ の代わりに _v10_ と _v11_ を使用してください。

### トースティング

関数の先頭で _.locals_ の数に3を追加することを忘れないでください。

このコードは、**関数の途中に挿入するために準備されています**（必要に応じて**変数の数**を**変更**してください）。これは、**this.o** の値を**String**に変換し、その値で**トースト**を作成します。
```
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
