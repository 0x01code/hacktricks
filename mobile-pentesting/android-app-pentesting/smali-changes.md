# Smali - Dekompilieren/\[Modifizieren]/Kompilieren

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>

Manchmal ist es interessant, den Anwendungscode zu modifizieren, um auf versteckte Informationen zuzugreifen (vielleicht gut verschleierte Passw√∂rter oder Flags). In diesem Fall kann es interessant sein, die APK zu dekompilieren, den Code zu modifizieren und ihn anschlie√üend neu zu kompilieren.

**Opcodes-Referenz:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Schneller Weg

Mit **Visual Studio Code** und der Erweiterung [APKLab](https://github.com/APKLab/APKLab) k√∂nnen Sie die Anwendung automatisch dekompilieren, den Code modifizieren, neu kompilieren, signieren und installieren, ohne einen Befehl auszuf√ºhren.

Ein weiteres **Skript**, das diese Aufgabe sehr erleichtert, ist [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## APK dekompilieren

Mit APKTool k√∂nnen Sie auf den **Smali-Code und die Ressourcen** zugreifen:
```bash
apktool d APP.apk
```
Wenn **apktool** einen Fehler anzeigt, versuchen Sie, die **neueste Version** zu installieren.

Einige **interessante Dateien, auf die Sie achten sollten**, sind:

* _res/values/strings.xml_ (und alle xml-Dateien in res/values/\*)
* _AndroidManifest.xml_
* Jede Datei mit der Erweiterung _.sqlite_ oder _.db_

Wenn `apktool` **Probleme beim Dekodieren der Anwendung** hat, werfen Sie einen Blick auf [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) oder versuchen Sie, das Argument **`-r`** zu verwenden (Ressourcen nicht dekodieren). Wenn das Problem in einer Ressource und nicht im Quellcode lag, haben Sie das Problem nicht (Sie dekodieren auch nicht die Ressourcen).

## √Ñndern des Smali-Codes

Sie k√∂nnen **Anweisungen √§ndern**, den **Wert** einiger Variablen √§ndern oder neue Anweisungen **hinzuf√ºgen**. Ich √§ndere den Smali-Code mit [**VS Code**](https://code.visualstudio.com). Sie installieren dann die **smalise-Erweiterung** und der Editor zeigt Ihnen an, ob eine **Anweisung falsch ist**.\
Einige **Beispiele** finden Sie hier:

* [Beispiele f√ºr Smali-√Ñnderungen](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Oder Sie k√∂nnen [**unten einige erkl√§rte Smali-√Ñnderungen √ºberpr√ºfen**](smali-changes.md#modifying-smali).

## APK neu kompilieren

Nachdem Sie den Code ge√§ndert haben, k√∂nnen Sie den Code mit folgendem Befehl **neu kompilieren**:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Es wird die neue APK im Ordner _**dist**_ **kompilieren**.

Wenn **apktool** einen **Fehler** wirft, versuchen Sie, die **neueste Version** zu installieren.

### **Signieren Sie die neue APK**

Dann m√ºssen Sie einen **Schl√ºssel generieren** (Sie werden nach einem Passwort und einigen Informationen gefragt, die Sie zuf√§llig ausf√ºllen k√∂nnen):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Schlie√ülich **signieren** Sie die neue APK-Datei:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Optimiere die neue Anwendung

**zipalign** ist ein Archivausrichtungswerkzeug, das wichtige Optimierungen f√ºr Android-Anwendungsdateien (APK) bietet. [Weitere Informationen hier](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Signiere die neue APK (erneut?)**

Wenn du **lieber** [**apksigner**](https://developer.android.com/studio/command-line/) anstelle von jarsigner verwenden m√∂chtest, **solltest du die APK** nach der Anwendung der **Optimierung mit** zipalign signieren. ABER BEACHTE, DASS DU DIE ANWENDUNG NUR EINMAL MIT jarsigner (vor zipalign) ODER MIT apksigner (nach zipalign) **SIGNIEREN MUSST**.
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## √Ñndern von Smali

F√ºr den folgenden Hello World Java-Code:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Der Smali-Code w√§re:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
Der Smali-Befehlssatz ist [hier](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions) verf√ºgbar.

### Leichte √Ñnderungen

### √Ñndern der Anfangswerte einer Variablen innerhalb einer Funktion

Einige Variablen werden zu Beginn der Funktion mit dem Opcode _const_ definiert. Sie k√∂nnen ihre Werte √§ndern oder neue Variablen definieren:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Grundlegende Operationen

#### √Ñndern von Smali-Code

Um eine Android-App zu hacken, m√ºssen wir den Smali-Code √§ndern. Smali ist eine Assemblersprache f√ºr die Dalvik Virtual Machine (DVM), die von Android verwendet wird. Hier sind einige grundlegende Operationen, die wir durchf√ºhren k√∂nnen:

- **√Ñndern von Konstanten**: Wir k√∂nnen die Werte von Konstanten √§ndern, um das Verhalten der App zu beeinflussen.
- **√Ñndern von Methodenaufrufen**: Wir k√∂nnen Methodenaufrufe √§ndern, um die App dazu zu bringen, andere Funktionen auszuf√ºhren oder bestimmte Bedingungen zu umgehen.
- **√Ñndern von Variablen**: Wir k√∂nnen Variablenwerte √§ndern, um das Verhalten der App zu beeinflussen.
- **Hinzuf√ºgen von Code**: Wir k√∂nnen zus√§tzlichen Code einf√ºgen, um neue Funktionen zur App hinzuzuf√ºgen oder vorhandenen Code zu erweitern.
- **Entfernen von Code**: Wir k√∂nnen Code entfernen, um bestimmte Funktionen der App zu deaktivieren oder zu umgehen.

Diese grundlegenden Operationen erm√∂glichen es uns, den Smali-Code einer Android-App zu manipulieren und sie f√ºr unsere Zwecke anzupassen. Es ist wichtig, vorsichtig vorzugehen und die Auswirkungen unserer √Ñnderungen zu verstehen, um unerw√ºnschte Nebenwirkungen zu vermeiden.
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Gr√∂√üere √Ñnderungen

### Protokollierung
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Empfehlungen:

* Wenn Sie deklarierte Variablen innerhalb der Funktion verwenden m√∂chten (deklariert v0, v1, v2...), platzieren Sie diese Zeilen zwischen _.local \<Zahl>_ und den Deklarationen der Variablen (_const v0, 0x1_)
* Wenn Sie den Protokollierungscode in der Mitte des Codes einer Funktion platzieren m√∂chten:
* F√ºgen Sie 2 zur Anzahl der deklarierten Variablen hinzu: z.B. von _.locals 10_ zu _.locals 12_
* Die neuen Variablen sollten die n√§chsten Zahlen der bereits deklarierten Variablen sein (in diesem Beispiel sollten es _v10_ und _v11_ sein, denken Sie daran, dass es mit v0 beginnt).
* √Ñndern Sie den Code der Protokollierungsfunktion und verwenden Sie _v10_ und _v11_ anstelle von _v5_ und _v1_.

### Toasten

Denken Sie daran, 3 zur Anzahl der _.locals_ am Anfang der Funktion hinzuzuf√ºgen.

Dieser Code ist darauf vorbereitet, in der **Mitte einer Funktion** eingef√ºgt zu werden (**√§ndern** Sie die Anzahl der **Variablen** bei Bedarf). Er nimmt den **Wert von this.o**, **wandelt** ihn in einen **String** um und **zeigt** dann einen **Toast** mit seinem Wert an.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
