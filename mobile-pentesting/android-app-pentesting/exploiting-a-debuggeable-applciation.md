# デバッガブルなアプリケーションの悪用

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **ハッキングトリックを共有するには、**[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

# **ルートおよびデバッガブルチェックのバイパス**

この投稿のこのセクションは、[**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)からの要約です。

## Androidアプリをデバッガブルにする手順とチェックをバイパスする方法

### **アプリをデバッガブルにする**

https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0に基づくコンテンツ

1. **APKを逆コンパイルする:**
   - APKを逆コンパイルするためにAPK-GUIツールを使用します。
   - _android-manifest_ファイルに`android:debuggable=true`を挿入してデバッグモードを有効にします。
   - 修正されたアプリケーションを再コンパイル、署名、およびzipalignします。

2. **修正されたアプリケーションをインストールする:**
   - コマンドを使用します：`adb install <application_name>`。

3. **パッケージ名を取得する:**
   - サードパーティアプリケーションをリストアップし、パッケージ名を見つけるために`adb shell pm list packages –3`を実行します。

4. **アプリをデバッガ接続を待機するように設定する:**
   - コマンド：`adb shell am setup-debug-app –w <package_name>`。
   - **注意:** このコマンドは、アプリケーションを起動する前に毎回実行する必要があり、デバッガが待機することを確認します。
   - 永続化するには、`adb shell am setup-debug-app –w -–persistent <package_name>`を使用します。
   - すべてのフラグを削除するには、`adb shell am clear-debug-app <package_name>`を使用します。

5. **Android Studioでデバッグの準備をする:**
   - Android Studioで_File -> Open Profile or APK_に移動します。
   - 再コンパイルされたAPKを開きます。

6. **主要なJavaファイルにブレークポイントを設定する:**
   - `MainActivity.java`（特に`onCreate`メソッド）、`b.java`、および`ContextWrapper.java`にブレークポイントを設定します。

### **チェックをバイパスする**

アプリケーションは、特定のポイントでデバッガブルであるかどうかを確認し、ルート化されたデバイスを示すバイナリをチェックします。デバッガを使用してアプリ情報を変更し、デバッガブルビットを解除し、検索されたバイナリの名前を変更してこれらのチェックをバイパスできます。

デバッガブルチェックの場合：

1. **フラグ設定を変更する:**
   - デバッガコンソールの変数セクションで、`this mLoadedAPK -> mApplicationInfo -> flags = 814267974`に移動します。
   - **注意:** `flags = 814267974`のバイナリ表現は`11000011100111011110`であり、「Flag_debuggable」がアクティブであることを示します。

![https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png](https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png)

これらの手順は、アプリケーションをデバッグできるようにし、デバッガを使用して特定のセキュリティチェックをバイパスできるようにするため、アプリケーションの動作をより詳細に分析または変更できるようにします。

ステップ2では、バイナリ表現で814267972にフラグ値を変更する必要があります。

# **脆弱性の悪用**

ボタンとテキストビューを含む脆弱なアプリケーションを使用してデモが提供されました。最初に、アプリケーションは「Crack Me」と表示されます。ソースコードを変更せずに、ランタイムでメッセージを「Try Again」から「Hacked」に変更することを目指します。

## **脆弱性のチェック**
- `apktool`を使用してアプリケーションを逆コンパイルして`AndroidManifest.xml`ファイルにアクセスしました。
- AndroidManifest.xmlに`android_debuggable="true"`が存在すると、アプリケーションがデバッガブルであり、悪用の可能性があることを示します。
- `apktool`はコードを変更せずにデバッグ可能な状態をチェックするためにのみ使用されることに注意してください。

## **セットアップの準備**
- エミュレータを起動し、脆弱なアプリケーションをインストールし、リッスンしているDalvik VMポートを特定するために`adb jdwp`を使用するプロセスが含まれていました。
- JDWP（Java Debug Wire Protocol）は、VMで実行されているアプリケーションのデバッグを可能にするために一意のポートを公開することで、VM内のアプリケーションのデバッグを許可します。
- リモートデバッグのためにポートフォワーディングが必要であり、その後、JDBをターゲットアプリケーションにアタッチする必要がありました。

## **ランタイムでコードをインジェクトする**
- アプリケーションの構造を明らかにするために`classes`および`methods <class_name>`のようなコマンドが使用されました。
- `onClick`メソッドでブレークポイントが設定され、その実行が制御されました。
- `locals`、`next`、および`set`コマンドが使用され、特に「Try Again」メッセージを「Hacked」に変更するためにローカル変数を検査および変更しました。
- 修正されたコードは`run`コマンドを使用して実行され、アプリケーションの出力がリアルタイムで変更されました。

この例は、デバッガブルなアプリケーションの動作が操作される方法を示し、アプリケーションのコンテキストでデバイスにシェルアクセスを取得するなどのより複雑な悪用の可能性を示しています。



## 参考文献
- [https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)
- [https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **ハッキングトリックを共有するには、**[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
