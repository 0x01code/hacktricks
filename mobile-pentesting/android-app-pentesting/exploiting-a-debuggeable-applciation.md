# Explotando una aplicaci√≥n depurable

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Evadiendo controles de root y depuraci√≥n**

**Esta secci√≥n del post es un resumen del post** [**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)

### Hacer la aplicaci√≥n depurable y ejecutarla esperando un depurador

Paso 1 ‚Äî Descompila el APK usando la herramienta APK-GUI. Edita el archivo _android-manifest_ y a√±ade _**android:debuggable=true**,_ para hacer la aplicaci√≥n depurable. Recompila, firma y alinea el APK con zipalign.

Paso 2 ‚Äî Instala la aplicaci√≥n mediante -

_**adb install \<nombre_de_la_aplicaci√≥n>**._

Paso 3 ‚Äî Obt√©n el nombre del paquete usando _-_

_**adb shell pm list packages ‚Äì3**_ (para listar las aplicaciones de terceros).

Paso 4 ‚Äî Ahora haz que la aplicaci√≥n espere por el depurador con este comando ‚Äî _**adb shell am setup-debug-app ‚Äìw \<nombre_del_paquete>**_.

**Nota ‚Äî** Necesitar√°s ejecutar este comando cada vez, antes de iniciar la aplicaci√≥n, para que la aplicaci√≥n espere al depurador.

Para hacerlo persistente puedes usar ‚Äì

_**adb shell am setup-debug-app ‚Äìw -‚Äìpersistent \<nombre_del_paquete>**._

Para limpiar todas las banderas ‚Äì

_**adb shell am clear-debug-app \<nombre_del_paquete>**._

Paso 5 ‚Äî Abre _**Android Studio -> File -> Open Profile or APK**_ -> Abre el APK recompilado.

Paso 6 ‚Äî A√±ade puntos de interrupci√≥n a los archivos java

* _**MainActivity.java ‚Äî m√©todo onCreate, b.java, ContextWrapper.java**_

### Evadir controles

En alg√∫n momento la aplicaci√≥n obtendr√° informaci√≥n sobre s√≠ misma para verificar si es depurable y tambi√©n buscar√° algunos binarios para ver si el m√≥vil est√° rooteado. Usando el depurador es posible cambiar la informaci√≥n de la aplicaci√≥n para desactivar el bit depurable y cambiar tambi√©n los nombres de los binarios buscados para que esos controles sean evadidos. Por ejemplo, para el control de depuraci√≥n:

Paso 1 ‚Äî En la secci√≥n de variables de la consola del depurador, navega a "_**this mLoadedAPK -> mApplicationInfo -> flags = 814267974**_"

<figure><img src="https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png" alt="" height="192" width="700"><figcaption><p>captura de pantalla 9</p></figcaption></figure>

_**Nota: flags = 814267974 en bits binarios es 11000011100111011110. Esto significa que "Flag_debuggable" est√° activado.**_

Paso 2 ‚Äî Cambia el valor de la bandera a 814267972. Conversi√≥n de bits binarios ‚Äî 110000101101000000100010100.

## **Explotando una vulnerabilidad**

**La siguiente parte del post fue copiada de** [**https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications/#article**](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications/#article)

Para hacer este art√≠culo m√°s interesante, he desarrollado una aplicaci√≥n vulnerable para fines de demostraci√≥n, que tiene un ‚Äú**bot√≥n**‚Äù y un ‚Äú**textview**‚Äú.

Rellena el formulario a continuaci√≥n para descargar el c√≥digo asociado con este art√≠culo.

Si lanzamos la aplicaci√≥n, muestra el mensaje ‚Äú**Crack Me**‚Äú.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack1.png)

Figura 1

Si hacemos clic en el bot√≥n, dice ‚Äú**Intenta de nuevo**‚Äú. Ahora, nuestro objetivo es cambiar el mensaje ‚ÄúIntenta de nuevo‚Äù por ‚ÄúHackeado‚Äù sin modificar el c√≥digo fuente de la aplicaci√≥n. Para ser precisos, tenemos que cambiarlo en tiempo de ejecuci√≥n.

### **Herramientas necesarias**

* Emulador
* adb ‚Äì Android Debug Bridge
* jdb ‚Äì Java Debugger

En mi caso, para facilitar las instalaciones, estoy usando Android Tamer ya que todas las herramientas requeridas anteriormente est√°n preinstaladas.

### **Temas involucrados**

* Verificaci√≥n de Vulnerabilidad.
* Prepar√°ndose con la Configuraci√≥n.
* Inyecci√≥n de C√≥digo en Tiempo de Ejecuci√≥n.

Comencemos el juego.

### **Verificaci√≥n de vulnerabilidad**

De hecho, esta es la parte m√°s f√°cil de todo el art√≠culo.

* Descompila la aplicaci√≥n usando `apktool` para obtener el archivo `AndroidManifest.xml` usando el siguiente comando.
```bash
apktool d <vulnerableapp>.apk
```
* Inspecciona el archivo `Androidmanifest.xml` en busca de la siguiente l√≠nea.
```bash
android_debuggable="true"
```
Si encuentras la l√≠nea anterior en el archivo AndroidManifest.xml, la aplicaci√≥n es depurable y puede ser explotada.

**Nota:** Utilizamos `apktool` para ver si la app es depurable o no. No tocaremos ni modificaremos ning√∫n fragmento de c√≥digo como se mencion√≥ anteriormente.

### **Prepar√°ndonos con la configuraci√≥n**

En este paso, configuraremos todo lo necesario para inyectar c√≥digo en la aplicaci√≥n durante su ejecuci√≥n. Como se mencion√≥ en el art√≠culo anterior, utilizaremos la depuraci√≥n remota en este art√≠culo.

* Inicia tu emulador
* Instala la aplicaci√≥n vulnerable
* Abre tu terminal y ejecuta el siguiente comando para ver los puertos de la VM Dalvik que est√°n escuchando en el emulador.

_**adb jdwp**_

El comando anterior muestra todos los puertos en los que podemos conectar y depurar como se muestra a continuaci√≥n.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack2.png)

Figura 2

**Nota:** JDWP significa Java Debug Wire Protocol. Si una aplicaci√≥n que se ejecuta en su VM es depurable, expone un puerto √∫nico al que podemos conectarnos usando JDB. Esto es posible en M√°quinas Virtuales Dalvik con el soporte de JDWP.

* Ahora, lanza nuestra aplicaci√≥n objetivo y ejecuta el mismo comando para ver el puerto de escucha asociado con nuestra aplicaci√≥n objetivo. Se ve como se muestra a continuaci√≥n.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack3.png)

Figura 2

Si observamos la diferencia entre la Figura 2 y la Figura 3, hay un puerto extra 543 escuchando despu√©s de lanzar la aplicaci√≥n objetivo en la Figura 3. Nos conectaremos a JDB a la aplicaci√≥n usando este puerto, ya que este es nuestro objetivo.

* Antes de adjuntarnos a la aplicaci√≥n, necesitamos reenviar el puerto usando adb ya que estamos utilizando la depuraci√≥n remota. Esto se muestra en la Figura 4.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack4.png)

Figura 4

* Ahora, adjuntemos JDB a la aplicaci√≥n como se muestra en la siguiente figura.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack5.png)

Figura 5

### **Inyecci√≥n de c√≥digo en tiempo de ejecuci√≥n**

En este paso, realmente explotaremos la aplicaci√≥n vulnerable modificando su comportamiento en tiempo de ejecuci√≥n.

Para modificar el comportamiento de la aplicaci√≥n en tiempo de ejecuci√≥n, necesitamos establecer puntos de interrupci√≥n y controlar el flujo. Pero, no sabemos qu√© clases y m√©todos se utilizan en la aplicaci√≥n. Entonces, usemos los siguientes comandos para averiguar las clases y m√©todos utilizados en la aplicaci√≥n.

Para encontrar las clases: ‚Äú**classes**‚Äù

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack6.png)

Figura 6.1

Dado que tengo demasiadas clases listadas, solo estoy enumerando algunas clases. Pero si sigues desplaz√°ndote hacia abajo, ver√°s algunas clases definidas por el usuario interesantes como se muestra en la figura a continuaci√≥n.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack7.png)

Figura 6.2

Ahora, veamos los m√©todos asociados con la clase MainActivity$1 usando el siguiente comando.

‚Äú_**methods com.example.debug.MainActivity$1**_‚Äù

Esto se muestra en la figura 7.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack8.png)

Figura 7

Ahora, establezcamos un punto de interrupci√≥n en el m√©todo onClick y controlemos la ejecuci√≥n de la app como se muestra en la Figura 8.

_**‚Äústop in com.example.debug.MainActivity$1.onClick(android.view.View)‚Äù**_

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack9.png)

Figura 8

Para activar el punto de interrupci√≥n, tendremos que hacer clic manualmente en el bot√≥n de la aplicaci√≥n. Una vez despu√©s de hacer clic en el bot√≥n, se activar√° el punto de interrupci√≥n y aparecer√° como se muestra en la Figura 9.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack10.png)

Figura 9

A partir de aqu√≠, podremos controlar y ver los valores sensibles, argumentos de m√©todos, etc., utilizando varios comandos.

Solo para entender qu√© est√° sucediendo en segundo plano, estoy siguiendo el c√≥digo asociado con el m√©todo onClick, que se muestra en la Figura 10.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack11.png)

Figura 10

Antes de continuar, veamos si hay alguna variable local en este momento usando el comando ‚Äú**locals**‚Äú.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack12.png)

Figura 11

Como podemos ver, no hay informaci√≥n interesante para nosotros.

Entonces, ejecutemos la siguiente l√≠nea usando el comando ‚Äú**next**‚Äù como se muestra a continuaci√≥n.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack13.png)

Figura 12

Intentemos nuevamente ejecutar el comando ‚Äú**locals**‚Äù para ver qu√© sucedi√≥ en el comando anterior.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack14.png)

Figura 13

Est√° bastante claro que TextView se ha cargado en los argumentos del m√©todo. Si miramos el c√≥digo fuente proporcionado en la Figura 10, se ha ejecutado la l√≠nea asociada con la instanciaci√≥n de TextView.

Ahora, ejecutemos las siguientes l√≠neas ejecutando el comando ‚Äú**next**‚Äù y revisemos las variables locales como se muestra en la figura a continuaci√≥n.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack15.png)

Figura 14

Como podemos ver, se han mostrado todas las variables locales. La cadena ‚Äú**secret**‚Äù parece interesante. El valor ‚ÄúTry Again‚Äù es lo que se va a imprimir cuando hagamos clic en el bot√≥n.

Desde la Figura 10, est√° muy claro que se est√° ejecutando el m√©todo **setText** para imprimir el valor ‚Äú**Try Again**‚Äú. Entonces, usemos el comando ‚Äú**step**‚Äù para entrar en la definici√≥n del m√©todo ‚Äú**setText**‚Äù y modificar din√°micamente el texto a imprimir.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack16.png)

Figura 15

Veamos las variables locales dentro de la definici√≥n usando ‚Äú**locals**‚Äú.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack17.png)

Figura 16

Ahora, cambiemos el valor de ‚Äú**text**‚Äù de ‚Äú**Try Again**‚Äù a ‚Äú**Hacked**‚Äù usando el comando ‚Äú**set**‚Äù.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack18.png)

Figura 17

No podemos ver ning√∫n cambio en la aplicaci√≥n, ya que no hemos ejecutado el c√≥digo modificado.

Entonces, ejecutemos la aplicaci√≥n usando el comando ‚Äú**run**‚Äù como se muestra a continuaci√≥n, y veamos la salida de la aplicaci√≥n en su pantalla.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack19.png)

Figura 18

Veamos la aplicaci√≥n ejecut√°ndose en el emulador.

![](https://resources.infosecinstitute.com/wp-content/uploads/052314_1204_AndroidHack20.png)

Figura 19

Hemos modificado con √©xito la salida de la aplicaci√≥n en tiempo de ejecuci√≥n. Esto es solo un ejemplo para mostrar c√≥mo se puede modificar el comportamiento de una aplicaci√≥n si la aplicaci√≥n es depurable. Podemos realizar varias otras cosas, incluyendo ‚Äú**Obtener una shell**‚Äù en el dispositivo en el contexto de la aplicaci√≥n vulnerable.

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
