# Explotando una aplicaci√≥n depurable

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Eludiendo verificaciones de root y depurables**

**Esta secci√≥n del post es un resumen del post** [**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)

### Pasos para hacer una aplicaci√≥n Android depurable y eludir verificaciones

#### **Haciendo la aplicaci√≥n depurable**

Contenido basado en https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0

1. **Descompilar el APK:**
- Utiliza la herramienta APK-GUI para descompilar el APK.
- En el archivo _android-manifest_, inserta `android:debuggable=true` para habilitar el modo de depuraci√≥n.
- Recompila, firma y alinea el APK modificado.

2. **Instalar la aplicaci√≥n modificada:**
- Usa el comando: `adb install <nombre_de_la_aplicaci√≥n>`.

3. **Recuperar el nombre del paquete:**
- Ejecuta `adb shell pm list packages ‚Äì3` para listar aplicaciones de terceros y encontrar el nombre del paquete.

4. **Configurar la aplicaci√≥n para esperar la conexi√≥n del depurador:**
- Comando: `adb shell am setup-debug-app ‚Äìw <nombre_del_paquete>`.
- **Nota:** Este comando debe ejecutarse cada vez antes de iniciar la aplicaci√≥n para asegurar que espera al depurador.
- Para persistencia, usa `adb shell am setup-debug-app ‚Äìw -‚Äìpersistent <nombre_del_paquete>`.
- Para eliminar todas las banderas, usa `adb shell am clear-debug-app <nombre_del_paquete>`.

5. **Prepararse para la depuraci√≥n en Android Studio:**
- Navega en Android Studio a _Archivo -> Abrir perfil o APK_.
- Abre el APK recompilado.

6. **Establecer puntos de interrupci√≥n en archivos Java clave:**
- Coloca puntos de interrupci√≥n en `MainActivity.java` (espec√≠ficamente en el m√©todo `onCreate`), `b.java` y `ContextWrapper.java`.

#### **Eludiendo verificaciones**

La aplicaci√≥n, en ciertos puntos, verificar√° si es depurable y tambi√©n buscar√° binarios que indiquen un dispositivo rooteado. El depurador puede ser utilizado para modificar la informaci√≥n de la aplicaci√≥n, desactivar el bit depurable y alterar los nombres de los binarios buscados para eludir estas verificaciones.

Para la verificaci√≥n depurable:

1. **Modificar la configuraci√≥n de banderas:**
- En la secci√≥n de variables de la consola del depurador, navega a: `this mLoadedAPK -> mApplicationInfo -> flags = 814267974`.
- **Nota:** La representaci√≥n binaria de `flags = 814267974` es `11000011100111011110`, indicando que la "Flag_debuggable" est√° activa.

![Captura de pantalla del depurador](https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png)
*Figura: Captura de pantalla que ilustra la vista del depurador y la modificaci√≥n de la configuraci√≥n de banderas.*

Estos pasos aseguran colectivamente que la aplicaci√≥n pueda ser depurada y que ciertas verificaciones de seguridad puedan ser eludidas usando el depurador, facilitando un an√°lisis o modificaci√≥n m√°s profundos del comportamiento de la aplicaci√≥n.

El paso 2 implica cambiar un valor de bandera a 814267972, que se representa en binario como 110000101101000000100010100.

## **Explotando una vulnerabilidad**

Se proporcion√≥ una demostraci√≥n utilizando una aplicaci√≥n vulnerable que contiene un bot√≥n y un textview. Inicialmente, la aplicaci√≥n muestra "Crack Me". El objetivo es alterar el mensaje de "Try Again" a "Hacked" en tiempo de ejecuci√≥n, sin modificar el c√≥digo fuente.

### **Comprobando la vulnerabilidad**
- La aplicaci√≥n fue descompilada usando `apktool` para acceder al archivo `AndroidManifest.xml`.
- La presencia de `android_debuggable="true"` en el AndroidManifest.xml indica que la aplicaci√≥n es depurable y susceptible a ser explotada.
- Es importante se√±alar que `apktool` se emplea √∫nicamente para verificar el estado depurable sin alterar ning√∫n c√≥digo.

### **Preparando la configuraci√≥n**
- El proceso involucr√≥ iniciar un emulador, instalar la aplicaci√≥n vulnerable y usar `adb jdwp` para identificar los puertos de Dalvik VM que est√°n escuchando.
- El JDWP (Java Debug Wire Protocol) permite la depuraci√≥n de una aplicaci√≥n que se ejecuta en una VM exponiendo un puerto √∫nico.
- El reenv√≠o de puertos fue necesario para la depuraci√≥n remota, seguido de la conexi√≥n de JDB a la aplicaci√≥n objetivo.

### **Inyectando c√≥digo en tiempo de ejecuci√≥n**
- La explotaci√≥n se llev√≥ a cabo estableciendo puntos de interrupci√≥n y controlando el flujo de la aplicaci√≥n.
- Comandos como `classes` y `methods <nombre_de_la_clase>` se utilizaron para descubrir la estructura de la aplicaci√≥n.
- Se estableci√≥ un punto de interrupci√≥n en el m√©todo `onClick`, y se control√≥ su ejecuci√≥n.
- Los comandos `locals`, `next` y `set` se utilizaron para inspeccionar y modificar variables locales, particularmente cambiando el mensaje "Try Again" a "Hacked".
- El c√≥digo modificado se ejecut√≥ usando el comando `run`, alterando con √©xito la salida de la aplicaci√≥n en tiempo real.

Este ejemplo demostr√≥ c√≥mo se puede manipular el comportamiento de una aplicaci√≥n depurable, destacando el potencial para explotaciones m√°s complejas como obtener acceso a la shell en el dispositivo en el contexto de la aplicaci√≥n.



# Referencias
* [https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)
* [https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
