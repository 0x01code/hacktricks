# デバッグ可能なアプリケーションの悪用

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) でゼロからヒーローまで AWS ハッキングを学ぶ</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告掲載したい場合**や **HackTricks を PDF でダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングテクニックを共有する。

</details>

## **ルートとデバッグ可能なチェックのバイパス**

**このセクションは、投稿** [**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0) **からの要約です**

### Android アプリをデバッグ可能にしてチェックをバイパスする手順

#### **アプリをデバッグ可能にする**

内容は https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0 に基づいています

1. **APK の逆コンパイル:**
- APK-GUI ツールを使用して APK を逆コンパイルします。
- _android-manifest_ ファイルに `android:debuggable=true` を挿入してデバッグモードを有効にします。
- 変更されたアプリケーションを再コンパイル、署名、zipalign します。

2. **変更されたアプリケーションのインストール:**
- コマンド: `adb install <application_name>` を使用します。

3. **パッケージ名の取得:**
- `adb shell pm list packages –3` を実行してサードパーティアプリケーションをリストし、パッケージ名を見つけます。

4. **アプリがデバッガー接続を待機するように設定:**
- コマンド: `adb shell am setup-debug-app –w <package_name>`。
- **注:** このコマンドは、アプリケーションがデバッガーを待機するようにするため、アプリケーションを開始する前に毎回実行する必要があります。
- 永続性のためには、`adb shell am setup-debug-app –w -–persistent <package_name>` を使用します。
- すべてのフラグを削除するには、`adb shell am clear-debug-app <package_name>` を使用します。

5. **Android Studio でデバッグの準備:**
- Android Studio で _File -> Open Profile or APK_ に移動します。
- 再コンパイルされた APK を開きます。

6. **重要な Java ファイルにブレークポイントを設定:**
- `MainActivity.java`（特に `onCreate` メソッド）、`b.java`、`ContextWrapper.java` にブレークポイントを設置します。

#### **チェックのバイパス**

アプリケーションは、特定のポイントでデバッグ可能かどうかを検証し、ルートされたデバイスを示すバイナリの存在もチェックします。デバッガーを使用してアプリ情報を変更し、デバッグ可能ビットを解除し、検索されるバイナリの名前を変更してこれらのチェックをバイパスできます。

デバッグ可能なチェックの場合:

1. **フラグ設定の変更:**
- デバッガーコンソールの変数セクションで、次の場所に移動します: `this mLoadedAPK -> mApplicationInfo -> flags = 814267974`。
- **注:** `flags = 814267974` のバイナリ表現は `11000011100111011110` で、"Flag_debuggable" がアクティブであることを示しています。

![Debugger Screenshot](https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png)
*図: デバッガービューとフラグ設定の変更を示すスクリーンショット。*

これらのステップを総合すると、アプリケーションをデバッグ可能にし、デバッガーを使用して特定のセキュリティチェックをバイパスできるため、アプリケーションの動作のより深い分析や変更が容易になります。

ステップ 2 では、フラグ値を 814267972 に変更し、これはバイナリで 110000101101000000100010100 と表されます。

## **脆弱性の悪用**

ボタンとテキストビューを含む脆弱なアプリケーションを使用したデモンストレーションが提供されました。初期状態ではアプリケーションは "Crack Me" を表示します。目標は、ソースコードを変更せずに、実行時に "Try Again" メッセージを "Hacked" に変更することです。

### **脆弱性のチェック**
- `apktool` を使用してアプリケーションを逆コンパイルし、`AndroidManifest.xml` ファイルにアクセスしました。
- AndroidManifest.xml に `android_debuggable="true"` が存在することは、アプリケーションがデバッグ可能であり、悪用される可能性があることを示しています。
- `apktool` は、コードを変更せずにデバッグ可能な状態をチェックするためだけに使用されることに注意してください。

### **セットアップの準備**
- プロセスには、エミュレータの起動、脆弱なアプリケーションのインストール、および `adb jdwp` を使用してリスニングしている Dalvik VM ポートを特定することが含まれていました。
- JDWP (Java Debug Wire Protocol) は、VM で実行されているアプリケーションのデバッグを可能にするために、ユニークなポートを公開します。
- リモートデバッグのためにポートフォワーディングが必要であり、その後、ターゲットアプリケーションに JDB をアタッチしました。

### **実行時のコード注入**
- ブレークポイントを設定し、アプリケーションのフローを制御することによって悪用が行われました。
- `classes` や `methods <class_name>` などのコマンドを使用して、アプリケーションの構造を明らかにしました。
- `onClick` メソッドにブレークポイントを設定し、その実行を制御しました。
- `locals`、`next`、`set` コマンドを使用してローカル変数を検査し、特に "Try Again" メッセージを "Hacked" に変更しました。
- `run` コマンドを使用して変更されたコードを実行し、リアルタイムでアプリケーションの出力を成功裏に変更しました。

この例は、デバッグ可能なアプリケーションの動作を操作する方法を示し、アプリケーションのコンテキストでデバイス上でシェルアクセスを取得するなど、より複雑な悪用の可能性を浮き彫りにしました。



# 参考文献
* [https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)
* [https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) でゼロからヒーローまで AWS ハッキングを学ぶ</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告掲載したい場合**や **HackTricks を PDF でダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングテクニックを共有する。

</details>
