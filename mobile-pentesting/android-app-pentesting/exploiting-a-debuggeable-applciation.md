# 利用可调试应用程序

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向[**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## **绕过root和可调试检查**

**本文节摘自帖子** [**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)

### 使Android应用程序可调试并绕过检查的步骤

#### **使应用程序可调试**

基于 https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0 的内容

1. **反编译APK：**
- 使用APK-GUI工具反编译APK。
- 在_android-manifest_文件中插入`android:debuggable=true`以启用调试模式。
- 重新编译、签名并对修改后的应用程序进行zipalign。

2. **安装修改后的应用程序：**
- 使用命令：`adb install <application_name>`。

3. **检索包名：**
- 执行`adb shell pm list packages –3`列出第三方应用程序并找到包名。

4. **设置应用程序等待调试器连接：**
- 命令：`adb shell am setup-debug-app –w <package_name>`。
- **注意：**每次启动应用程序之前都必须运行此命令，以确保它等待调试器。
- 要持久化，使用`adb shell am setup-debug-app –w -–persistent <package_name>`。
- 要移除所有标志，使用`adb shell am clear-debug-app <package_name>`。

5. **在Android Studio中准备调试：**
- 在Android Studio中导航到_文件 -> 打开配置文件或APK_。
- 打开重新编译的APK。

6. **在关键Java文件中设置断点：**
- 在`MainActivity.java`（特别是在`onCreate`方法中）、`b.java`和`ContextWrapper.java`中放置断点。

#### **绕过检查**

应用程序在某些点会验证它是否可调试，并且还会检查指示设备已root的二进制文件。调试器可用于修改应用信息，取消设置可调试位，并更改搜索的二进制文件的名称以绕过这些检查。

对于可调试检查：

1. **修改标志设置：**
- 在调试器控制台的变量部分，导航到：`this mLoadedAPK -> mApplicationInfo -> flags = 814267974`。
- **注意：**`flags = 814267974`的二进制表示是`11000011100111011110`，表明"Flag_debuggable"是活动的。

![调试器截图](https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png)
*图：截图展示了调试器视图和标志设置的修改。*

这些步骤共同确保了应用程序可以被调试，并且可以使用调试器绕过某些安全检查，便于更深入地分析或修改应用程序的行为。

步骤2涉及将标志值更改为814267972，其二进制表示为110000101101000000100010100。

## **利用漏洞**

使用一个包含按钮和文本视图的易受攻击的应用程序进行了演示。最初，应用程序显示“Crack Me”。目标是在运行时将消息从“Try Again”更改为“Hacked”，而不修改源代码。

### **检查漏洞**
- 使用`apktool`反编译应用程序以访问`AndroidManifest.xml`文件。
- `AndroidManifest.xml`中存在`android_debuggable="true"`表明应用程序是可调试的，并且容易受到攻击。
- 值得注意的是，`apktool`仅用于检查可调试状态，而不更改任何代码。

### **准备设置**
- 过程包括启动模拟器，安装易受攻击的应用程序，并使用`adb jdwp`识别正在监听的Dalvik VM端口。
- JDWP（Java Debug Wire Protocol）允许通过暴露唯一端口来调试在VM中运行的应用程序。
- 远程调试需要端口转发，然后将JDB附加到目标应用程序。

### **在运行时注入代码**
- 通过设置断点和控制应用程序流程进行了利用。
- 使用`classes`和`methods <class_name>`命令来揭示应用程序的结构。
- 在`onClick`方法处设置了一个断点，并控制了其执行。
- 使用`locals`、`next`和`set`命令来检查和修改局部变量，特别是将“Try Again”消息更改为“Hacked”。
- 使用`run`命令执行修改后的代码，成功地实时更改了应用程序的输出。

这个例子展示了如何操纵可调试应用程序的行为，突出了更复杂的利用可能性，如在应用程序的上下文中获得设备的shell访问权限。



# 参考资料
* [https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)
* [https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向[**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
