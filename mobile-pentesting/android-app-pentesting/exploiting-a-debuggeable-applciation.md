# Explotando una aplicaci√≥n con modo de depuraci√≥n

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

# **Saltando las verificaciones de root y modo de depuraci√≥n**

Esta secci√≥n del post es un resumen del post [**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)

## Pasos para hacer una aplicaci√≥n de Android depurable y saltar las verificaciones

### **Haciendo la aplicaci√≥n depurable**

Contenido basado en https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0

1. **Descompilar el APK:**
- Utiliza la herramienta APK-GUI para descompilar el APK.
- En el archivo _android-manifest_, inserta `android:debuggable=true` para habilitar el modo de depuraci√≥n.
- Recompila, firma y alinea el APK modificado.

2. **Instalar la Aplicaci√≥n Modificada:**
- Usa el comando: `adb install <nombre_aplicaci√≥n>`.

3. **Obtener el Nombre del Paquete:**
- Ejecuta `adb shell pm list packages ‚Äì3` para listar las aplicaciones de terceros y encontrar el nombre del paquete.

4. **Configurar la Aplicaci√≥n para Esperar la Conexi√≥n del Depurador:**
- Comando: `adb shell am setup-debug-app ‚Äìw <nombre_paquete>`.
- **Nota:** Este comando debe ejecutarse cada vez antes de iniciar la aplicaci√≥n para asegurarse de que espere al depurador.
- Para persistencia, usa `adb shell am setup-debug-app ‚Äìw -‚Äìpersistent <nombre_paquete>`.
- Para eliminar todas las banderas, usa `adb shell am clear-debug-app <nombre_paquete>`.

5. **Prepararse para la Depuraci√≥n en Android Studio:**
- Navega en Android Studio a _Archivo -> Abrir Perfil o APK_.
- Abre el APK recompilado.

6. **Establecer Puntos de Interrupci√≥n en Archivos Java Clave:**
- Coloca puntos de interrupci√≥n en `MainActivity.java` (espec√≠ficamente en el m√©todo `onCreate`), `b.java` y `ContextWrapper.java`.

### **Saltando las Verificaciones**

La aplicaci√≥n, en ciertos puntos, verificar√° si es depurable y tambi√©n comprobar√° los binarios que indican un dispositivo rooteado. El depurador se puede utilizar para modificar la informaci√≥n de la aplicaci√≥n, desactivar el bit depurable y alterar los nombres de los binarios buscados para saltar estas verificaciones.

Para la verificaci√≥n de depuraci√≥n:

1. **Modificar la Configuraci√≥n de la Bandera:**
- En la secci√≥n de variables de la consola del depurador, navega a: `this mLoadedAPK -> mApplicationInfo -> flags = 814267974`.
- **Nota:** La representaci√≥n binaria de `flags = 814267974` es `11000011100111011110`, lo que indica que la "Flag_debuggable" est√° activa.

![https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png](https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png)

Estos pasos aseguran colectivamente que la aplicaci√≥n se pueda depurar y que ciertas verificaciones de seguridad se puedan saltar utilizando el depurador, facilitando un an√°lisis o modificaci√≥n m√°s profunda del comportamiento de la aplicaci√≥n.

El paso 2 implica cambiar un valor de bandera a 814267972, que se representa en binario como 110000101101000000100010100.

# **Explotando una Vulnerabilidad**

Se proporcion√≥ una demostraci√≥n utilizando una aplicaci√≥n vulnerable que contiene un bot√≥n y un textview. Inicialmente, la aplicaci√≥n muestra "Crack Me". El objetivo es alterar el mensaje de "Try Again" a "Hacked" en tiempo de ejecuci√≥n, sin modificar el c√≥digo fuente.

## **Comprobando la Vulnerabilidad**
- La aplicaci√≥n se descompil√≥ usando `apktool` para acceder al archivo `AndroidManifest.xml`.
- La presencia de `android_debuggable="true"` en AndroidManifest.xml indica que la aplicaci√≥n es depurable y susceptible a explotaci√≥n.
- Vale la pena se√±alar que `apktool` se emplea √∫nicamente para verificar el estado depurable sin alterar ning√∫n c√≥digo.

## **Preparando la Configuraci√≥n**
- El proceso implic√≥ iniciar un emulador, instalar la aplicaci√≥n vulnerable y usar `adb jdwp` para identificar los puertos de Dalvik VM que est√°n escuchando.
- El JDWP (Java Debug Wire Protocol) permite la depuraci√≥n de una aplicaci√≥n en ejecuci√≥n en una VM al exponer un puerto √∫nico.
- Fue necesario el reenv√≠o de puertos para la depuraci√≥n remota, seguido de la conexi√≥n de JDB a la aplicaci√≥n objetivo.

## **Inyectando C√≥digo en Tiempo de Ejecuci√≥n**
- La explotaci√≥n se llev√≥ a cabo estableciendo puntos de interrupci√≥n y controlando el flujo de la aplicaci√≥n.
- Se utilizaron comandos como `classes` y `methods <nombre_clase>` para descubrir la estructura de la aplicaci√≥n.
- Se estableci√≥ un punto de interrupci√≥n en el m√©todo `onClick`, y se control√≥ su ejecuci√≥n.
- Se utilizaron los comandos `locals`, `next` y `set` para inspeccionar y modificar variables locales, especialmente cambiando el mensaje de "Try Again" a "Hacked".
- El c√≥digo modificado se ejecut√≥ utilizando el comando `run`, alterando con √©xito la salida de la aplicaci√≥n en tiempo real.

Este ejemplo demostr√≥ c√≥mo se puede manipular el comportamiento de una aplicaci√≥n depurable, destacando el potencial para exploits m√°s complejos como obtener acceso a la shell en el dispositivo en el contexto de la aplicaci√≥n.

## Referencias
* [https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)
* [https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
