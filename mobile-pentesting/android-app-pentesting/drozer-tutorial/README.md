# Tutorial di Drozer

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Suggerimento per bug bounty**: **iscriviti** a **Intigriti**, una piattaforma premium per bug bounty creata da hacker, per hacker! Unisciti a noi su [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) oggi stesso e inizia a guadagnare ricompense fino a **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## APK da testare

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (da mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)


**Parti di questo tutorial sono state estratte dal [pdf di documentazione di Drozer](https://labs.withsecure.com/content/dam/labs/docs/mwri-drozer-user-guide-2015-03-23.pdf).**

## Installazione

Installa Drozer Client all'interno del tuo host. Scaricalo dalle [ultime versioni](https://github.com/mwrlabs/drozer/releases).
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
Scarica e installa l'APK di drozer dalle [ultime versioni](https://github.com/mwrlabs/drozer/releases). Al momento, √® [questa](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).
```bash
adb install drozer.apk
```
### Avvio del server

L'agente √® in esecuzione sulla porta 31415, √® necessario [effettuare il port forwarding](https://it.wikipedia.org/wiki/Port\_forwarding) per stabilire la comunicazione tra il client Drozer e l'agente. Ecco il comando da utilizzare:
```bash
adb forward tcp:31415 tcp:31415
```
Infine, **avvia** l'**applicazione** e premi il pulsante "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

E connettiti ad essa:
```bash
drozer console connect
```
## Comandi Interessanti

| **Comandi**    | **Descrizione**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | Mostra l'aiuto del modulo selezionato                                                                                                                      |
| **list**        | Mostra un elenco di tutti i moduli drozer che possono essere eseguiti nella sessione corrente. Questo nasconde i moduli per i quali non si dispone delle autorizzazioni appropriate per eseguirli. |
| **shell**       | Avvia una shell Linux interattiva sul dispositivo, nel contesto dell'Agente.                                                                           |
| **clean**       | Rimuove i file temporanei memorizzati da drozer sul dispositivo Android.                                                                                         |
| **load**        | Carica un file contenente comandi drozer ed eseguili in sequenza.                                                                                   |
| **module**      | Trova e installa moduli drozer aggiuntivi da Internet.                                                                                          |
| **unset**       | Rimuove una variabile nominata che drozer passa a qualsiasi shell Linux che avvia.                                                                         |
| **set**         | Memorizza un valore in una variabile che verr√† passata come variabile ambientale a qualsiasi shell Linux avviata da drozer.                                   |
| **shell**       | Avvia una shell Linux interattiva sul dispositivo, nel contesto dell'Agente                                                                            |
| **run MODULE**  | Esegue un modulo drozer                                                                                                                                |
| **exploit**     | Drozer pu√≤ creare exploit da eseguire nel dispositivo. `drozer exploit list`                                                                             |
| **payload**     | Gli exploit hanno bisogno di un payload. `drozer payload list`                                                                                                     |

### Pacchetto

Trova il **nome** del pacchetto filtrando per parte del nome:
```bash
dz> run app.package.list -f sieve
com.mwr.example.sieve
```
**Informazioni di base** del pacchetto:
```bash
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```
Leggi **Manifest**:
```bash
run app.package.manifest jakhar.aseem.diva
```
**Superficie di attacco** del pacchetto:
```bash
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```
* **Attivit√†**: Forse puoi avviare un'attivit√† e bypassare qualche tipo di autorizzazione che dovrebbe impedirti di lanciarla.
* **Provider di contenuti**: Forse puoi accedere a dati privati o sfruttare qualche vulnerabilit√† (SQL Injection o Path Traversal).
* **Servizi**:
* **is debuggable**: [Scopri di pi√π](./#is-debuggeable)

### Attivit√†

Il valore "android:exported" di un componente di attivit√† esportato √® impostato su **"true"** nel file AndroidManifest.xml:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**Elenco delle attivit√† esportate**:
```bash
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```
**Avviare un'attivit√†**:

Forse puoi avviare un'attivit√† e bypassare qualche tipo di autorizzazione che dovrebbe impedirti di lanciarla.

{% code overflow="wrap" %}
```bash
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
{% endcode %}

Puoi anche avviare un'attivit√† esportata da **adb**:

* Il nome del pacchetto √® com.example.demo
* Il nome dell'attivit√† esportata √® com.example.test.MainActivity
```bash
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### Fornitori di contenuti

Questo post era troppo grande per essere qui, quindi **puoi** [**accedere ad esso nella sua pagina dedicata qui**](exploiting-content-providers.md).

### Servizi

Un servizio esportato viene dichiarato all'interno del Manifest.xml:

{% code overflow="wrap" %}
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
{% endcode %}

All'interno del codice **controlla** la funzione \*\*`handleMessage`\*\* che **ricever√†** il **messaggio**:

![](<../../../.gitbook/assets/image (194).png>)

#### Elenco dei servizi
```bash
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```
#### **Interagire** con un servizio

To interact with a service, you need to establish a connection and send requests to it. In the context of Android app pentesting, this means interacting with the app's components and APIs.

Drozer provides several modules that allow you to interact with different services. These modules can be used to perform various actions, such as sending intents, making HTTP requests, and accessing content providers.

Here are some examples of how you can use Drozer to interact with services:

- **Intents**: You can use the `app.activity.start` module to send intents to the app's activities. This can be useful for launching specific activities or triggering certain actions within the app.

- **HTTP requests**: The `app.webview.inject` module allows you to inject JavaScript code into the app's WebView component. This can be used to perform actions such as clicking buttons or filling out forms on web pages.

- **Content providers**: Drozer provides the `content.provider.query` module, which allows you to query the app's content providers and retrieve data from them. This can be useful for extracting sensitive information or testing for data leakage vulnerabilities.

By using these modules and understanding how the app's services work, you can effectively interact with the app and uncover potential security issues.
```bash
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```
#### Esempio

Dai un'occhiata all'aiuto di **drozer** per `app.service.send`:

![](<../../../.gitbook/assets/image (196) (1).png>)

Nota che invierai prima i dati all'interno di "_msg.what_", poi "_msg.arg1_" e "_msg.arg2_", dovresti controllare all'interno del codice **quali informazioni vengono utilizzate** e dove.\
Utilizzando l'opzione `--extra` puoi inviare qualcosa interpretato da "_msg.replyTo"_, e utilizzando `--bundle-as-obj` crei un oggetto con i dettagli forniti.

Nell'esempio seguente:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```bash
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### Ricevitori di trasmissione

**Nella sezione Informazioni di base su Android puoi vedere cosa √® un ricevitore di trasmissione**.

Dopo aver scoperto questi ricevitori di trasmissione, dovresti **controllare il codice** di essi. Presta particolare attenzione alla funzione **`onReceive`** poich√© gestir√† i messaggi ricevuti.

#### **Rileva tutti** i ricevitori di trasmissione
```bash
run app.broadcast.info #Detects all
```
#### Verifica i ricevitori di trasmissione di un'app

To check the broadcast receivers of an app, you can use the `drozer` tool. This tool allows you to interact with Android devices and applications, and it provides a wide range of functionalities for mobile penetration testing.

To begin, make sure you have `drozer` installed on your machine. Once installed, follow these steps:

1. Connect your Android device to your machine using a USB cable.
2. Enable USB debugging on your Android device by going to **Settings > Developer options** and toggling the **USB debugging** option.
3. Open a terminal and run the following command to start the `drozer` console:

   ```
   drozer console connect
   ```

4. Once connected, run the following command to list all the installed applications on the device:

   ```
   run app.package.list -f
   ```

   This will display a list of installed applications along with their package names.

5. Identify the package name of the app you want to check the broadcast receivers for.

6. Run the following command to list the broadcast receivers of the app:

   ```
   run app.broadcast.info -a <package_name>
   ```

   Replace `<package_name>` with the actual package name of the app.

   This command will display information about the broadcast receivers registered by the app, including their names, permissions, and exported status.

By checking the broadcast receivers of an app, you can identify potential security vulnerabilities or misconfigurations that could be exploited by attackers.
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```
#### Interazioni di **Broadcast**

Broadcast √® un meccanismo utilizzato nelle applicazioni Android per consentire la comunicazione tra diverse componenti dell'applicazione o tra diverse applicazioni. Le interazioni di broadcast consentono alle applicazioni di inviare e ricevere messaggi di broadcast, che possono essere utilizzati per scopi diversi, come la notifica di eventi o l'aggiornamento dei dati.

Le interazioni di broadcast possono essere utilizzate anche per scopi malevoli, come l'intercettazione di informazioni sensibili o l'esecuzione di azioni non autorizzate. Pertanto, √® importante comprendere come funzionano le interazioni di broadcast e come proteggere le applicazioni da potenziali attacchi.

In questo tutorial, impareremo come utilizzare Drozer per esplorare e testare le interazioni di broadcast nelle applicazioni Android. Drozer √® uno strumento di test delle applicazioni Android che consente di analizzare e manipolare le applicazioni Android in esecuzione su un dispositivo o un emulatore.

Continua a leggere per scoprire come utilizzare Drozer per identificare e sfruttare le vulnerabilit√† nelle interazioni di broadcast delle applicazioni Android.
```bash
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### Invia un messaggio

In questo esempio, sfruttando l'apk [FourGoats](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk) Content Provider, √® possibile **inviare un SMS arbitrario** a una destinazione non premium **senza chiedere** il permesso all'utente.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Se leggi il codice, i parametri "_phoneNumber_" e "_message_" devono essere inviati al Content Provider.
```bash
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### √à debuggabile

Un APK di produzione non dovrebbe mai essere debuggabile.\
Questo significa che √® possibile **collegare un debugger Java** all'applicazione in esecuzione, ispezionarla durante l'esecuzione, impostare punti di interruzione, procedere passo dopo passo, raccogliere valori delle variabili e persino modificarli. [InfoSec institute ha un eccellente articolo](../exploiting-a-debuggeable-applciation.md) su come approfondire quando l'applicazione √® debuggabile e iniettare codice in tempo di esecuzione.

Quando un'applicazione √® debuggabile, apparir√† nel Manifest:
```xml
<application theme="@2131296387" debuggable="true"
```
Puoi trovare tutte le applicazioni debuggabili con **Drozer**:
```bash
run app.package.debuggable
```
## Tutorial

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md](https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md)
* [https://www.hackingarticles.in/android-penetration-testing-drozer/](https://www.hackingarticles.in/android-penetration-testing-drozer/)
* [https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac](https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac)

## Ulteriori informazioni

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Suggerimento per bug bounty**: **iscriviti** a **Intigriti**, una piattaforma premium per bug bounty creata da hacker, per hacker! Unisciti a noi su [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) oggi stesso e inizia a guadagnare ricompense fino a **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
