# Tutorial de Drozer

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Consejo de recompensa por errores**: **reg√≠strate** en **Intigriti**, una plataforma premium de **recompensas por errores creada por hackers, para hackers**. ¬°√önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## APKs para probar

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (de mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## Instalaci√≥n

Instala el cliente Drozer en tu host. Desc√°rgalo desde las [√∫ltimas versiones](https://github.com/mwrlabs/drozer/releases).
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
Descarga e instala el archivo APK de drozer desde las [√∫ltimas versiones](https://github.com/mwrlabs/drozer/releases). En este momento, la versi√≥n es [esta](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).
```
adb install drozer.apk
```
### Iniciando el Servidor

El agente se est√° ejecutando en el puerto 31415, necesitamos [hacer un reenv√≠o de puerto](https://es.wikipedia.org/wiki/Reenv%C3%ADo_de_puertos) para establecer la comunicaci√≥n entre el Cliente Drozer y el Agente. Aqu√≠ est√° el comando para hacerlo:
```
adb forward tcp:31415 tcp:31415
```
Finalmente, **lanza** la **aplicaci√≥n** y presiona el bot√≥n "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

Y con√©ctate a ella:
```
drozer console connect
```
## Comandos Interesantes

| **Comandos**    | **Descripci√≥n**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Ayuda M√ìDULO** | Muestra la ayuda del m√≥dulo seleccionado                                                                                                                      |
| **lista**        | Muestra una lista de todos los m√≥dulos de drozer que se pueden ejecutar en la sesi√≥n actual. Esto oculta los m√≥dulos para los cuales no tienes los permisos adecuados para ejecutarlos. |
| **shell**       | Inicia una shell interactiva de Linux en el dispositivo, en el contexto del Agente.                                                                           |
| **limpiar**       | Elimina los archivos temporales almacenados por drozer en el dispositivo Android.                                                                                         |
| **cargar**        | Carga un archivo que contiene comandos de drozer y los ejecuta en secuencia.                                                                                   |
| **m√≥dulo**      | Encuentra e instala m√≥dulos adicionales de drozer desde Internet.                                                                                          |
| **desestablecer**       | Elimina una variable con nombre que drozer pasa a cualquier shell de Linux que inicia.                                                                         |
| **establecer**         | Almacena un valor en una variable que se pasar√° como variable de entorno a cualquier shell de Linux iniciada por drozer.                                   |
| **shell**       | Inicia una shell interactiva de Linux en el dispositivo, en el contexto del Agente                                                                            |
| **ejecutar M√ìDULO**  | Ejecuta un m√≥dulo de drozer                                                                                                                                |
| **explotar**     | Drozer puede crear exploits para ejecutar en el dispositivo. `drozer exploit list`                                                                             |
| **carga √∫til**     | Los exploits necesitan una carga √∫til. `drozer payload list`                                                                                                     |

### Paquete

Encuentra el **nombre** del paquete filtrando por parte del nombre:
```
dz> run app.package.list -f sieve
com.mwr.example.sieve
```
**Informaci√≥n b√°sica** del paquete:
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```
Lee **Manifest**:
```
run app.package.manifest jakhar.aseem.diva
```
**Superficie de ataque** del paquete:
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```
* **Actividades**: Tal vez puedas iniciar una actividad y evadir alg√∫n tipo de autorizaci√≥n que deber√≠a impedirte lanzarla.
* **Proveedores de contenido**: Tal vez puedas acceder a datos privados o aprovechar alguna vulnerabilidad (Inyecci√≥n SQL o Traversal de Ruta).
* **Servicios**:
* **es depurable**: [M√°s informaci√≥n](./#es-depurable)

### Actividades

El valor "android:exported" de un componente de actividad exportado se establece en **"true"** en el archivo AndroidManifest.xml:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**Lista de actividades exportadas**:

Para obtener una lista de las actividades exportadas de una aplicaci√≥n Android, puedes utilizar la herramienta `drozer`. Sigue los siguientes pasos:

1. Aseg√∫rate de tener `drozer` instalado en tu m√°quina de trabajo.
2. Conecta tu dispositivo Android al equipo mediante un cable USB.
3. Abre una terminal y ejecuta el siguiente comando para iniciar una sesi√≥n de `drozer`:

   ```
   drozer console connect
   ```

4. Una vez que est√©s en la consola de `drozer`, ejecuta el siguiente comando para listar las actividades exportadas de la aplicaci√≥n:

   ```
   run app.activity.info -a <nombre_del_paquete_de_la_aplicaci√≥n>
   ```

   Reemplaza `<nombre_del_paquete_de_la_aplicaci√≥n>` con el nombre del paquete de la aplicaci√≥n que deseas analizar.

5. `drozer` mostrar√° una lista de las actividades exportadas de la aplicaci√≥n, junto con otra informaci√≥n relevante, como el nombre de la actividad y el nombre del paquete.

Con esta lista de actividades exportadas, podr√°s identificar posibles puntos de entrada para realizar pruebas de penetraci√≥n en la aplicaci√≥n Android.
```bash
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```
**Iniciar actividad**:

Tal vez puedas iniciar una actividad y evadir alg√∫n tipo de autorizaci√≥n que deber√≠a impedirte lanzarla.

{% code overflow="wrap" %}
```bash
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
{% endcode %}

Tambi√©n puedes iniciar una actividad exportada desde **adb**:

* El nombre del paquete es com.example.demo
* El nombre de la actividad exportada es com.example.test.MainActivity
```bash
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### Proveedores de contenido

Este post era demasiado grande para estar aqu√≠, as√≠ que **puedes** [**acceder a √©l en su propia p√°gina aqu√≠**](exploiting-content-providers.md).

### Servicios

Un servicio exportado se declara dentro del Manifest.xml:

{% code overflow="wrap" %}
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
{% endcode %}

Dentro del c√≥digo **verifica** la funci√≥n \*\*`handleMessage`\*\* que **recibir√°** el **mensaje**:

![](<../../../.gitbook/assets/image (194).png>)

#### Listar servicios
```bash
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```
#### **Interactuar** con un servicio

To interact with a service, you can use the `run` command in drozer. This command allows you to execute various actions on the target service.

Para interactuar con un servicio, puedes utilizar el comando `run` en drozer. Este comando te permite ejecutar varias acciones en el servicio objetivo.

The basic syntax for the `run` command is as follows:

La sintaxis b√°sica para el comando `run` es la siguiente:

```
run <module> <action> [options]
```

Where:

Donde:

- `<module>` is the name of the module you want to run.

- `<module>` es el nombre del m√≥dulo que deseas ejecutar.

- `<action>` is the action you want to perform on the module.

- `<action>` es la acci√≥n que deseas realizar en el m√≥dulo.

- `[options]` are any additional options or parameters required by the module.

- `[options]` son cualquier opci√≥n o par√°metro adicional requerido por el m√≥dulo.

For example, to interact with the `activity` module and launch an activity, you can use the following command:

Por ejemplo, para interactuar con el m√≥dulo `activity` y lanzar una actividad, puedes utilizar el siguiente comando:

```
run app.activity.start --component <package_name>/<activity_name>
```

Replace `<package_name>` with the package name of the target app and `<activity_name>` with the name of the activity you want to launch.

Reemplaza `<package_name>` con el nombre del paquete de la aplicaci√≥n objetivo y `<activity_name>` con el nombre de la actividad que deseas lanzar.

You can also use the `run` command to perform other actions, such as sending intents, querying content providers, and executing shell commands.

Tambi√©n puedes utilizar el comando `run` para realizar otras acciones, como enviar intents, consultar proveedores de contenido y ejecutar comandos de shell.
```
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```
#### Ejemplo

Echa un vistazo a la ayuda de **drozer** para `app.service.send`:

![](<../../../.gitbook/assets/image (196) (1).png>)

Ten en cuenta que primero enviar√°s los datos dentro de "_msg.what_", luego "_msg.arg1_" y "_msg.arg2_", debes verificar dentro del c√≥digo **qu√© informaci√≥n se est√° utilizando** y d√≥nde.\
Usando la opci√≥n `--extra` puedes enviar algo interpretado por "_msg.replyTo"_, y usando `--bundle-as-obj` puedes crear un objeto con los detalles proporcionados.

En el siguiente ejemplo:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### Receptores de difusi√≥n

Las aplicaciones de Android pueden enviar o recibir mensajes de difusi√≥n del sistema Android y otras aplicaciones de Android, de manera similar al patr√≥n de dise√±o [publicar-suscribir](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern). Estas difusiones se env√≠an cuando ocurre un evento de inter√©s. Por ejemplo, el sistema Android env√≠a difusiones cuando ocurren varios eventos del sistema, como cuando el sistema se inicia o el dispositivo comienza a cargarse. Las aplicaciones tambi√©n pueden enviar difusiones personalizadas, por ejemplo, para notificar a otras aplicaciones algo en lo que podr√≠an estar interesadas (por ejemplo, se ha descargado nuevos datos).

Las aplicaciones pueden registrarse para recibir difusiones espec√≠ficas. Cuando se env√≠a una difusi√≥n, el sistema enruta autom√°ticamente las difusiones a las aplicaciones que se han suscrito para recibir ese tipo particular de difusi√≥n.

Esto podr√≠a aparecer dentro del archivo Manifest.xml:
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
<intent-filter>
<action android:name="android.intent.action.BOOT_COMPLETED"/>
<action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
</intent-filter>
</receiver>
```
Desde: [https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

Despu√©s de descubrir estos receptores de transmisi√≥n, debes **verificar el c√≥digo** de los mismos. Presta especial atenci√≥n a la funci√≥n **`onReceive`** ya que ser√° la encargada de manejar los mensajes recibidos.

#### **Detectar todos** los receptores de transmisi√≥n
```bash
run app.broadcast.info #Detects all
```
#### Verificar los receptores de difusi√≥n de una aplicaci√≥n

To check the broadcast receivers of an app, you can use the `drozer` tool. This tool allows you to interact with the Android operating system at the application layer, providing a convenient way to analyze and test the security of Android apps.

To begin, make sure you have `drozer` installed on your machine. You can find installation instructions in the [drozer GitHub repository](https://github.com/FSecureLABS/drozer).

Once `drozer` is installed, follow these steps to check the broadcast receivers of an app:

1. Connect your Android device to your machine via USB debugging mode.

2. Open a terminal and start the `drozer` console by running the following command:
   ```
   drozer console connect
   ```

3. Once connected, you can use the `run app.broadcast.info` command to retrieve information about the broadcast receivers of a specific app. For example, to check the broadcast receivers of an app with package name `com.example.app`, run the following command:
   ```
   run app.broadcast.info -a com.example.app
   ```

   This command will display a list of all the broadcast receivers registered by the app, along with their corresponding permissions and intent filters.

By checking the broadcast receivers of an app, you can identify potential security vulnerabilities or misconfigurations that could be exploited by attackers. It is an important step in the process of mobile app penetration testing.
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```
#### Interacciones de **Broadcast**

Las interacciones de broadcast son una parte fundamental del an√°lisis de seguridad de aplicaciones Android. Los mensajes de broadcast son eventos que se env√≠an a trav√©s del sistema operativo Android y pueden ser recibidos por m√∫ltiples componentes de la aplicaci√≥n. Estas interacciones pueden ser utilizadas por los atacantes para obtener informaci√≥n sensible o ejecutar acciones maliciosas en la aplicaci√≥n.

En el contexto de la pentesting de aplicaciones Android, es importante identificar las interacciones de broadcast y evaluar su seguridad. Esto implica buscar componentes de la aplicaci√≥n que registren receptores de broadcast y analizar c√≥mo se manejan los mensajes recibidos. Algunas vulnerabilidades comunes asociadas con las interacciones de broadcast incluyen la divulgaci√≥n de informaci√≥n confidencial, la ejecuci√≥n de c√≥digo no autorizado y la suplantaci√≥n de identidad.

Drozer es una herramienta popular utilizada para realizar pruebas de penetraci√≥n en aplicaciones Android. Proporciona una serie de comandos que permiten interactuar con las interacciones de broadcast de una aplicaci√≥n y evaluar su seguridad. Al utilizar Drozer, los pentesters pueden descubrir posibles vulnerabilidades y ayudar a los desarrolladores a corregirlas antes de que sean explotadas por atacantes malintencionados.

En resumen, las interacciones de broadcast son un aspecto cr√≠tico a considerar durante la pentesting de aplicaciones Android. Mediante el uso de herramientas como Drozer, los pentesters pueden identificar y evaluar la seguridad de estas interacciones, ayudando a garantizar que las aplicaciones sean seguras y protegidas contra posibles ataques.
```
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### Enviar un mensaje

En este ejemplo, abusando del proveedor de contenido de la aplicaci√≥n [FourGoats apk](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk), puedes **enviar un SMS arbitrario** a cualquier destino no premium **sin pedir** permiso al usuario.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Si lees el c√≥digo, los par√°metros "_phoneNumber_" y "_message_" deben ser enviados al proveedor de contenido.
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### Es depurable

Un APK de producci√≥n nunca deber√≠a ser depurable. Esto significa que no se puede **adjuntar un depurador de Java** a la aplicaci√≥n en ejecuci√≥n, inspeccionarla en tiempo de ejecuci√≥n, establecer puntos de interrupci√≥n, avanzar paso a paso, recopilar valores de variables e incluso cambiarlos. [InfoSec institute tiene un excelente art√≠culo](../exploiting-a-debuggeable-applciation.md) sobre c√≥mo profundizar cuando tu aplicaci√≥n es depurable e inyectar c√≥digo en tiempo de ejecuci√≥n.

Cuando una aplicaci√≥n es depurable, aparecer√° en el Manifiesto:
```html
<application theme="@2131296387" debuggable="true"
```
Puedes encontrar todas las aplicaciones depurables con **Drozer**:
```bash
run app.package.debuggable
```
## Tutoriales

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md](https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md)
* [https://www.hackingarticles.in/android-penetration-testing-drozer/](https://www.hackingarticles.in/android-penetration-testing-drozer/)
* [https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac](https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac)

## M√°s informaci√≥n

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Consejo de recompensa por errores**: **reg√≠strate** en **Intigriti**, una plataforma premium de **recompensas por errores creada por hackers, para hackers**. ¬°√önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
