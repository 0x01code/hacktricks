# Drozer教程

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**赏金猎人提示**：**注册**Intigriti，一个由黑客创建的高级**赏金猎人平台**！立即加入我们的[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)，开始赚取高达**$100,000**的赏金！

{% embed url="https://go.intigriti.com/hacktricks" %}

## 要测试的APK

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk)（来自mrwlabs）
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## 安装

在主机上安装Drozer客户端。从[最新版本](https://github.com/mwrlabs/drozer/releases)下载它。
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
从[最新版本](https://github.com/mwrlabs/drozer/releases)下载并安装drozer APK。目前的版本是[这个](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk)。
```
adb install drozer.apk
```
### 启动服务器

代理正在端口31415上运行，我们需要进行[端口转发](https://en.wikipedia.org/wiki/Port\_forwarding)以建立Drozer客户端和代理之间的通信，以下是执行此操作的命令：
```
adb forward tcp:31415 tcp:31415
```
最后，**启动**应用程序并按下底部的“**ON**”按钮。

![](<../../../.gitbook/assets/image (63).png>)

然后连接到它：
```
drozer console connect
```
## 有趣的命令

| **命令**        | **描述**                                                                                                                                                |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | 显示所选模块的帮助信息                                                                                                                                  |
| **list**        | 显示当前会话中可以执行的所有drozer模块的列表。此命令隐藏您没有适当权限运行的模块。                                                                       |
| **shell**       | 在设备上以Agent的上下文启动一个交互式Linux shell。                                                                                                       |
| **clean**       | 删除Android设备上drozer存储的临时文件。                                                                                                                 |
| **load**        | 加载包含drozer命令并按顺序执行它们的文件。                                                                                                             |
| **module**      | 从互联网上查找并安装额外的drozer模块。                                                                                                                  |
| **unset**       | 删除drozer传递给任何它生成的Linux shell的命名变量。                                                                                                       |
| **set**         | 将一个值存储在变量中，该变量将作为环境变量传递给drozer生成的任何Linux shell。                                                                               |
| **shell**       | 在设备上以Agent的上下文启动一个交互式Linux shell。                                                                                                       |
| **run MODULE**  | 执行一个drozer模块。                                                                                                                                    |
| **exploit**     | Drozer可以创建在设备上执行的利用程序。`drozer exploit list`                                                                                             |
| **payload**     | 利用程序需要一个有效载荷。`drozer payload list`                                                                                                         |

### 包

通过部分名称过滤，找到包的**名称**：
```
dz> run app.package.list -f sieve
com.mwr.example.sieve
```
**软件包的基本信息**：

- **Package Name**: com.example.app
- **Version Name**: 1.0
- **Version Code**: 1
- **Target SDK Version**: 28
- **Min SDK Version**: 21
- **Permissions**: android.permission.INTERNET, android.permission.ACCESS_NETWORK_STATE

---

**Installation**:

1. Download the APK file from the provided link.
2. Connect your Android device to your computer.
3. Open a terminal and navigate to the directory where the APK file is located.
4. Install the APK using the following command: `adb install app.apk`
5. Once the installation is complete, you can launch the app on your device.

---

**Usage**:

1. Launch the app on your Android device.
2. Explore the different features and functionalities of the app.
3. Take note of any suspicious behavior or vulnerabilities that you come across.
4. Use drozer to perform a security assessment of the app.
5. Analyze the results and identify any potential security issues.
6. Report your findings to the app developer or relevant stakeholders.

---

**Additional Resources**:

- [Drozer Documentation](https://github.com/FSecureLABS/drozer/wiki)
- [Android Developer Documentation](https://developer.android.com/docs)
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```
阅读**清单**：
```
run app.package.manifest jakhar.aseem.diva
```
**攻击面**的范围：
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```
* **活动**：也许你可以启动一个活动并绕过某种应该阻止你启动的授权。
* **内容提供者**：也许你可以访问私有数据或利用一些漏洞（SQL注入或路径遍历）。
* **服务**：
* **is debuggable**：[了解更多](./#is-debuggeable)

### 活动

在AndroidManifest.xml文件中，导出的活动组件的“android:exported”值被设置为**“true”**：
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**列出导出的活动**：

To list the exported activities of an Android application, you can use the `drozer` tool. The exported activities are components of an app that can be accessed by other apps or external entities. These activities can potentially be exploited by attackers if they are not properly secured.

To list the exported activities using `drozer`, follow these steps:

1. Install `drozer` on your machine and set up the environment.
2. Connect your Android device to your machine using a USB cable.
3. Open a terminal and run the command `adb devices` to ensure that your device is recognized.
4. Run the command `drozer console connect` to establish a connection between `drozer` and your device.
5. Once connected, run the command `run app.activity.info -a <package_name>` to list the exported activities of the specified package.
6. Replace `<package_name>` with the package name of the target application.

The output will display the exported activities along with their corresponding information, such as the activity name, package name, and intent filters. This information can be useful for identifying potential security vulnerabilities in the application.

It is important to note that listing exported activities alone does not indicate a security vulnerability. However, it can provide valuable insights for further analysis and testing during a penetration test.
```
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```
**启动活动**：

也许你可以启动一个活动并绕过某种应该阻止你启动它的授权。
```
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
您还可以通过**adb**启动导出的活动：

- 包名为 com.example.demo
- 导出的活动名为 com.example.test.MainActivity
```
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### 内容提供者

这篇文章太长了，所以**你可以**[**在这里访问它的独立页面**](exploiting-content-providers.md)。

### 服务

一个导出的服务在Manifest.xml中声明：
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
在代码中**检查**`handleMessage`函数，该函数将**接收**消息：

![](<../../../.gitbook/assets/image (194).png>)

#### 服务列表
```
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```
#### 与服务进行交互

To interact with a service, you can use the `run` command in drozer. This command allows you to execute various actions on the target service. 

要与服务进行交互，您可以使用drozer中的`run`命令。该命令允许您在目标服务上执行各种操作。

The basic syntax for the `run` command is as follows:

`run <module> <action> [options]`

`run`命令的基本语法如下：

`run <模块> <操作> [选项]`

- `<module>`: Specifies the module to be executed.
- `<module>`：指定要执行的模块。

- `<action>`: Specifies the action to be performed on the module.
- `<action>`：指定要在模块上执行的操作。

- `[options]`: Specifies any additional options or parameters required by the module.
- `[options]`：指定模块所需的任何其他选项或参数。

For example, to interact with the `activity` module and launch an activity on the target device, you can use the following command:

例如，要与`activity`模块进行交互并在目标设备上启动一个活动，可以使用以下命令：

```
run app.activity.start --component <package_name> <activity_name>
```

Replace `<package_name>` with the package name of the target app and `<activity_name>` with the name of the activity you want to launch.

将`<package_name>`替换为目标应用程序的包名，将`<activity_name>`替换为要启动的活动的名称。

By using the `run` command with different modules and actions, you can interact with various services and perform actions such as starting activities, sending intents, querying content providers, and more.

通过使用不同的模块和操作来运行`run`命令，您可以与各种服务进行交互，并执行启动活动、发送意图、查询内容提供程序等操作。
```
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```
#### 示例

查看`drozer`的`app.service.send`帮助文档：

![](<../../../.gitbook/assets/image (196) (1).png>)

请注意，您将首先发送"_msg.what_"中的数据，然后是"_msg.arg1_"和"_msg.arg2_"，您应该在代码中检查**正在使用的信息**以及其位置。\
使用`--extra`选项，您可以发送由"_msg.replyTo"解释的内容，并使用`--bundle-as-obj`创建一个带有提供的详细信息的对象。

在下面的示例中：

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### 广播接收器

Android应用程序可以从Android系统和其他Android应用程序发送或接收广播消息，类似于[发布-订阅](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern)设计模式。这些广播在感兴趣的事件发生时发送。例如，当系统启动或设备开始充电时，Android系统会发送广播。应用程序还可以发送自定义广播，例如，通知其他应用程序可能感兴趣的内容（例如，已下载一些新数据）。

应用程序可以注册接收特定的广播。当发送广播时，系统会自动将广播路由到已订阅接收该特定类型广播的应用程序。

这可能出现在Manifest.xml文件中：
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
<intent-filter>
<action android:name="android.intent.action.BOOT_COMPLETED"/>
<action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
</intent-filter>
</receiver>
```
从：[https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

在发现这些广播接收器之后，你应该**检查它们的代码**。特别注意\*\*`onReceive`\*\*函数，因为它将处理接收到的消息。

#### **检测所有**广播接收器
```bash
run app.broadcast.info #Detects all
```
#### 检查应用程序的广播接收器

To check the broadcast receivers of an Android app, you can use the `drozer` tool. This tool allows you to interact with the Android operating system at the application layer, providing a way to analyze and manipulate the app's components.

To begin, make sure you have `drozer` installed on your machine. Once installed, you can start the `drozer` console by running the command `drozer console`.

To check the broadcast receivers of an app, you can use the `run app.broadcast.info -a <package_name>` command. Replace `<package_name>` with the package name of the app you want to analyze.

This command will display a list of all the broadcast receivers registered by the app, along with their corresponding permissions and intent filters. By analyzing this information, you can identify potential security vulnerabilities or misconfigurations in the app's broadcast receivers.

It is important to note that this technique should only be used for legitimate purposes, such as penetration testing or security auditing. Unauthorized use of this technique is illegal and unethical. Always ensure you have proper authorization before performing any security assessments.
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```
#### 广播 **交互**

Broadcasts are a way for different components within an Android app to communicate with each other. They allow one component to send a message, called an intent, and other components can receive and respond to that message.

广播是Android应用程序中不同组件之间进行通信的一种方式。它们允许一个组件发送一条消息，称为意图（intent），其他组件可以接收并响应该消息。

Broadcasts can be sent within an app or even between different apps. This makes them a powerful tool for inter-app communication.

广播可以在应用程序内部发送，甚至可以在不同的应用程序之间发送。这使得它们成为应用程序间通信的强大工具。

There are two types of broadcasts: **normal broadcasts** and **ordered broadcasts**.

广播有两种类型：**普通广播**和**有序广播**。

**Normal broadcasts** are asynchronous and are sent to all registered receivers at the same time. The receivers cannot abort the broadcast or change the order in which they receive it.

**普通广播**是异步的，会同时发送给所有已注册的接收器。接收器无法中止广播或更改接收广播的顺序。

**Ordered broadcasts**, on the other hand, are synchronous and are sent to receivers one at a time, in a specific order. Each receiver has the option to abort the broadcast or change the order in which subsequent receivers receive it.

另一方面，**有序广播**是同步的，按照特定的顺序逐个发送给接收器。每个接收器都可以选择中止广播或更改后续接收器接收广播的顺序。

Broadcasts can be intercepted by malicious apps, allowing them to gain unauthorized access to sensitive information or perform malicious actions. Therefore, it is important to secure the broadcast interactions in your Android app to prevent potential security vulnerabilities.

恶意应用程序可以拦截广播，从而使它们能够未经授权地访问敏感信息或执行恶意操作。因此，保护Android应用程序中的广播交互以防止潜在的安全漏洞非常重要。
```
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### 发送消息

在这个例子中，通过滥用 [FourGoats apk](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk) 的内容提供者，你可以**发送任意短信**到任何非高级目的地，**无需**向用户请求权限。

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

如果你阅读代码，你会发现需要将参数 "_phoneNumber_" 和 "_message_" 发送给内容提供者。
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### 是否可调试

一个生产环境的 APK 应该永远不可调试。\
这意味着你可以**附加 Java 调试器**到正在运行的应用程序，实时检查它，设置断点，逐步执行，收集变量值甚至修改它们。[InfoSec 研究所有一篇很好的文章](../exploiting-a-debuggeable-applciation.md)关于在应用程序可调试时深入挖掘并注入运行时代码。

当一个应用程序可调试时，它会出现在清单文件中：
```
<application theme="@2131296387" debuggable="true"
```
您可以使用**Drozer**找到所有可调试的应用程序：
```
run app.package.debuggable
```
## 教程

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/](http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/)

## 更多信息

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)



<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Bug赏金提示**: **注册**Intigriti，一个由黑客创建的高级**Bug赏金平台**！立即加入我们的[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)，开始赚取高达**$100,000**的赏金！

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者你想要**获取最新版本的PEASS或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
