# Tutorial de Drozer

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Consejo para bug bounty**: **reg칤strate** en **Intigriti**, una plataforma premium de **bug bounty creada por hackers, para hackers**. 칔nete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo, y comienza a ganar recompensas de hasta **$100,000**.

{% embed url="https://go.intigriti.com/hacktricks" %}

## APKs para probar

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (de mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## Instalaci칩n

Instala el Cliente Drozer en tu host. Desc치rgalo de las [칰ltimas versiones](https://github.com/mwrlabs/drozer/releases).
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
Descargue e instale el APK de drozer desde los [칰ltimos lanzamientos](https://github.com/mwrlabs/drozer/releases). En este momento es [este](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).
```
adb install drozer.apk
```
### Iniciando el Servidor

El Agente se est치 ejecutando en el puerto 31415, necesitamos [redirigir el puerto](https://en.wikipedia.org/wiki/Port\_forwarding) para establecer la comunicaci칩n entre el Cliente Drozer y el Agente, aqu칤 est치 el comando para hacerlo:
```
adb forward tcp:31415 tcp:31415
```
Finalmente, **inicia** la **aplicaci칩n** y presiona el bot칩n "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

Y con칠ctate a ella:
```
drozer console connect
```
## Comandos Interesantes

| **Comandos**    | **Descripci칩n**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | Muestra ayuda del m칩dulo seleccionado                                                                                                                  |
| **list**        | Muestra una lista de todos los m칩dulos de drozer que se pueden ejecutar en la sesi칩n actual. Esto oculta m칩dulos para los que no tienes permisos adecuados. |
| **shell**       | Inicia una shell Linux interactiva en el dispositivo, en el contexto del Agente.                                                                       |
| **clean**       | Elimina archivos temporales almacenados por drozer en el dispositivo Android.                                                                          |
| **load**        | Carga un archivo que contiene comandos de drozer y los ejecuta en secuencia.                                                                           |
| **module**      | Encuentra e instala m칩dulos adicionales de drozer desde Internet.                                                                                      |
| **unset**       | Elimina una variable nombrada que drozer pasa a cualquier shell Linux que inicie.                                                                      |
| **set**         | Almacena un valor en una variable que se pasar치 como una variable de entorno a cualquier shell Linux iniciada por drozer.                              |
| **shell**       | Inicia una shell Linux interactiva en el dispositivo, en el contexto del Agente                                                                        |
| **run MODULE**  | Ejecuta un m칩dulo de drozer                                                                                                                            |
| **exploit**     | Drozer puede crear exploits para ejecutar en el dispositivo. `drozer exploit list`                                                                     |
| **payload**     | Los exploits necesitan un payload. `drozer payload list`                                                                                               |

### Paquete

Encuentra el **nombre** del paquete filtrando por parte del nombre:
```
dz> run app.package.list -f sieve
com.mwr.example.sieve
```
**Informaci칩n B치sica** del paquete:
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```
Leer **Manifest**:
```
run app.package.manifest jakhar.aseem.diva
```
**Superficie de ataque** del paquete:
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```
* **Activities**: Quiz치s puedas iniciar una actividad y eludir alg칰n tipo de autorizaci칩n que deber칤a impedirte lanzarla.
* **Content providers**: Quiz치s puedas acceder a datos privados o explotar alguna vulnerabilidad (SQL Injection o Path Traversal).
* **Services**:
* **is debuggable**: [Aprende m치s](./#is-debuggeable)

### Activities

El valor "android:exported" de un componente de actividad exportado est치 configurado en **"true"** en el archivo AndroidManifest.xml:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**Listar actividades exportadas**:
```bash
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```
**Iniciar actividad**:

Quiz치s puedas iniciar una actividad y eludir alg칰n tipo de autorizaci칩n que deber칤a impedirte lanzarla.

{% code overflow="wrap" %}
```bash
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
{% endcode %}

Tambi칠n puedes iniciar una actividad exportada desde **adb**:

* PackageName es com.example.demo
* Exported ActivityName es com.example.test.MainActivity
```bash
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### Proveedores de Contenido

Esta publicaci칩n era tan grande para estar aqu칤 que **puedes** [**accederla en su propia p치gina aqu칤**](exploiting-content-providers.md).

### Servicios

Un servicio exportado se declara dentro del Manifest.xml:

{% code overflow="wrap" %}
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
{% endcode %}

Dentro del c칩digo **busca** la funci칩n \*\*`handleMessage`\*\* que **recibir치** el **mensaje**:

![](<../../../.gitbook/assets/image (194).png>)

#### Listar servicio
```bash
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```
#### **Interactuar** con un servicio
```
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```
#### Ejemplo

Echa un vistazo a la ayuda de **drozer** para `app.service.send`:

![](<../../../.gitbook/assets/image (196) (1).png>)

Ten en cuenta que estar치s enviando primero los datos dentro de "_msg.what_", luego "_msg.arg1_" y "_msg.arg2_". Deber칤as verificar dentro del c칩digo **qu칠 informaci칩n se est치 utilizando** y d칩nde.\
Utilizando la opci칩n `--extra` puedes enviar algo interpretado por "_msg.replyTo"_, y usando `--bundle-as-obj` creas un objeto con los detalles proporcionados.

En el siguiente ejemplo:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
```markdown
### Receptores de Broadcast

Las aplicaciones de Android pueden enviar o recibir mensajes broadcast del sistema Android y otras aplicaciones Android, similar al patr칩n de dise침o [publish-subscribe](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe\_pattern). Estos broadcasts se env칤an cuando ocurre un evento de inter칠s. Por ejemplo, el sistema Android env칤a broadcasts cuando ocurren varios eventos del sistema, como cuando el sistema se inicia o el dispositivo comienza a cargarse. Las aplicaciones tambi칠n pueden enviar broadcasts personalizados, por ejemplo, para notificar a otras aplicaciones de algo que podr칤a interesarles (por ejemplo, se han descargado nuevos datos).

Las aplicaciones pueden registrarse para recibir broadcasts espec칤ficos. Cuando se env칤a un broadcast, el sistema autom치ticamente enruta los broadcasts a las aplicaciones que se han suscrito para recibir ese tipo particular de broadcast.

Esto podr칤a aparecer dentro del archivo Manifest.xml:
```
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
<intent-filter>
<action android:name="android.intent.action.BOOT_COMPLETED"/>
<action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
</intent-filter>
</receiver>
```
De: [https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

Despu칠s de descubrir estos Broadcast Receivers, debes **revisar el c칩digo** de los mismos. Presta especial atenci칩n a la funci칩n **`onReceive`**, ya que ser치 la encargada de manejar los mensajes recibidos.

#### **Detectar todos** los broadcast receivers
```bash
run app.broadcast.info #Detects all
```
#### Verificar los receptores de difusi칩n de una app
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```
#### Interacciones con **Broadcast**
```
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### Enviar un mensaje

En este ejemplo abusando del Content Provider de [FourGoats apk](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk) puedes **enviar un SMS arbitrario** a cualquier destino no premium **sin pedir** permiso al usuario.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Si lees el c칩digo, los par치metros "_phoneNumber_" y "_message_" deben ser enviados al Content Provider.
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### Es depurable

Un APK de producci칩n nunca debe ser depurable.\
Esto significa que puedes **adjuntar un depurador de Java** a la aplicaci칩n en ejecuci칩n, inspeccionarla en tiempo real, establecer puntos de interrupci칩n, avanzar paso a paso, recopilar valores de variables e incluso cambiarlos. [InfoSec Institute tiene un excelente art칤culo](../exploiting-a-debuggeable-applciation.md) sobre c칩mo profundizar cuando tu aplicaci칩n es depurable e inyectar c칩digo en tiempo de ejecuci칩n.

Cuando una aplicaci칩n es depurable, aparecer치 en el Manifiesto:
```html
<application theme="@2131296387" debuggable="true"
```
Puedes encontrar todas las aplicaciones depurables con **Drozer**:
```bash
run app.package.debuggable
```
## Tutoriales

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md](https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md)
* [https://www.hackingarticles.in/android-penetration-testing-drozer/](https://www.hackingarticles.in/android-penetration-testing-drozer/)
* [https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac](https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac)

## M치s informaci칩n

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Consejo para bug bounty**: **reg칤strate** en **Intigriti**, una plataforma premium de **bug bounty creada por hackers, para hackers**. 춰칔nete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
