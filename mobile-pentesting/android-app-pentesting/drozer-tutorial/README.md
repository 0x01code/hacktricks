# Tutoriel Drozer

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Astuce de prime de bug** : **inscrivez-vous** √† **Intigriti**, une plateforme de prime de bug premium cr√©√©e par des pirates, pour les pirates ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

## APKs √† tester

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (de mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## Installation

Installez le client Drozer sur votre h√¥te. T√©l√©chargez-le depuis les [derni√®res versions](https://github.com/mwrlabs/drozer/releases).
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
T√©l√©chargez et installez l'APK de drozer √† partir des [derni√®res versions](https://github.com/mwrlabs/drozer/releases). Pour le moment, il s'agit de [celle-ci](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).
```
adb install drozer.apk
```
### D√©marrage du serveur

L'agent fonctionne sur le port 31415, nous devons [rediriger le port](https://fr.wikipedia.org/wiki/Redirection_de_port) pour √©tablir la communication entre le client Drozer et l'agent. Voici la commande √† utiliser :
```
adb forward tcp:31415 tcp:31415
```
Enfin, **lancez** l'**application** et appuyez sur le bouton "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

Et connectez-vous √† l'application :
```
drozer console connect
```
## Commandes int√©ressantes

| **Commandes**    | **Description**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | Affiche l'aide du module s√©lectionn√©.                                                                                                                      |
| **list**        | Affiche une liste de tous les modules drozer qui peuvent √™tre ex√©cut√©s dans la session en cours. Cela masque les modules pour lesquels vous n'avez pas les autorisations appropri√©es pour les ex√©cuter. |
| **shell**       | D√©marre un shell Linux interactif sur l'appareil, dans le contexte de l'Agent.                                                                           |
| **clean**       | Supprime les fichiers temporaires stock√©s par drozer sur l'appareil Android.                                                                                         |
| **load**        | Charge un fichier contenant des commandes drozer et les ex√©cute en s√©quence.                                                                                   |
| **module**      | Trouve et installe des modules drozer suppl√©mentaires depuis Internet.                                                                                          |
| **unset**       | Supprime une variable nomm√©e que drozer passe √† tous les shells Linux qu'il g√©n√®re.                                                                         |
| **set**         | Stocke une valeur dans une variable qui sera transmise en tant que variable d'environnement √† tous les shells Linux g√©n√©r√©s par drozer.                                   |
| **shell**       | D√©marre un shell Linux interactif sur l'appareil, dans le contexte de l'Agent.                                                                            |
| **run MODULE**  | Ex√©cute un module drozer.                                                                                                                                |
| **exploit**     | Drozer peut cr√©er des exploits √† ex√©cuter sur l'appareil. `drozer exploit list`                                                                             |
| **payload**     | Les exploits ont besoin d'un payload. `drozer payload list`                                                                                                     |

### Package

Trouver le **nom** du package en filtrant par partie du nom :
```
dz> run app.package.list -f sieve  
com.mwr.example.sieve
```
**Informations de base** du package :
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
 - android.permission.READ_EXTERNAL_STORAGE
 - android.permission.WRITE_EXTERNAL_STORAGE
 - android.permission.INTERNET
Defines Permissions:
 - com.mwr.example.sieve.READ_KEYS
 - com.mwr.example.sieve.WRITE_KEYS
```
Lire **Manifeste** :
```
run app.package.manifest jakhar.aseem.diva
```
**Surface d'attaque** du package :
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
 3 activities exported
 0 broadcast receivers exported
 2 content providers exported
 2 services exported
 is debuggable
```
* **Activit√©s**: Il est possible que vous puissiez d√©marrer une activit√© et contourner une sorte d'autorisation qui devrait vous emp√™cher de la lancer.
* **Fournisseurs de contenu**: Il est possible que vous puissiez acc√©der √† des donn√©es priv√©es ou exploiter une vuln√©rabilit√© (Injection SQL ou Traversal de chemin).
* **Services**:
* **is debuggable**: [En savoir plus](./#is-debuggeable)

### Activit√©s

La valeur "android:exported" d'un composant d'activit√© export√© est d√©finie sur **"true"** dans le fichier AndroidManifest.xml:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**Liste des activit√©s export√©es**:
```
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
 com.mwr.example.sieve.FileSelectActivity
 com.mwr.example.sieve.MainLoginActivity
 com.mwr.example.sieve.PWList
```
**D√©marrer une activit√©**:

Il est possible de d√©marrer une activit√© et de contourner une sorte d'autorisation qui devrait vous emp√™cher de la lancer.
```
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
Vous pouvez √©galement d√©marrer une activit√© export√©e depuis **adb** :

* Le nom du package est com.example.demo
* Le nom de l'activit√© export√©e est com.example.test.MainActivity
```
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### Fournisseurs de contenu

Ce post √©tait trop grand pour √™tre ici, donc **vous pouvez** [**y acc√©der sur sa propre page ici**](exploiting-content-providers.md).

### Services

Un service export√© est d√©clar√© dans le Manifest.xml :
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
√Ä l'int√©rieur du code, **recherchez** la fonction **`handleMessage`** qui **recevra** le **message** :

![](<../../../.gitbook/assets/image (194).png>) 

#### Liste des services
```
dz> run app.service.info -a com.mwr.example.sieve 
Package: com.mwr.example.sieve
  com.mwr.example.sieve.AuthService
    Permission: null
  com.mwr.example.sieve.CryptoService
    Permission: null
```
#### **Interagir** avec un service
```
app.service.send            Send a Message to a service, and display the reply  
app.service.start           Start Service                                       
app.service.stop            Stop Service
```
#### Exemple

Jetez un coup d'≈ìil √† l'aide de **drozer** pour `app.service.send` :

![](<../../../.gitbook/assets/image (196) (1).png>)

Notez que vous enverrez d'abord les donn√©es √† l'int√©rieur de "_msg.what_", puis "_msg.arg1_" et "_msg.arg2_", vous devriez v√©rifier √† l'int√©rieur du code **quelles informations sont utilis√©es** et o√π.\
En utilisant l'option `--extra`, vous pouvez envoyer quelque chose interpr√©t√© par "_msg.replyTo"_, et en utilisant `--bundle-as-obj`, vous cr√©ez un objet avec les d√©tails fournis.

Dans l'exemple suivant :

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### R√©cepteurs de diffusion

Les applications Android peuvent envoyer ou recevoir des messages de diffusion du syst√®me Android et d'autres applications Android, similaire au mod√®le de conception [publish-subscribe](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe\_pattern). Ces diffusions sont envoy√©es lorsqu'un √©v√©nement d'int√©r√™t se produit. Par exemple, le syst√®me Android envoie des diffusions lorsque divers √©v√©nements syst√®me se produisent, tels que le d√©marrage du syst√®me ou le chargement de l'appareil. Les applications peuvent √©galement envoyer des diffusions personnalis√©es, par exemple, pour notifier d'autres applications de quelque chose qui pourrait les int√©resser (par exemple, de nouvelles donn√©es ont √©t√© t√©l√©charg√©es).

Les applications peuvent s'inscrire pour recevoir des diffusions sp√©cifiques. Lorsqu'une diffusion est envoy√©e, le syst√®me achemine automatiquement les diffusions vers les applications qui se sont abonn√©es pour recevoir ce type particulier de diffusion.

Cela pourrait appara√Ætre √† l'int√©rieur du fichier Manifest.xml :
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
    <intent-filter>
        <action android:name="android.intent.action.BOOT_COMPLETED"/>
        <action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
    </intent-filter>
</receiver>
```
Depuis: [https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

Apr√®s avoir d√©couvert ces r√©cepteurs de diffusion, vous devriez **v√©rifier le code** de chacun d'eux. Portez une attention particuli√®re √† la fonction \*\*`onReceive`\*\* car elle g√®re les messages re√ßus.

#### **D√©tecter tous** les r√©cepteurs de diffusion
```bash
run app.broadcast.info #Detects all
```
#### V√©rifier les r√©cepteurs de diffusion d'une application
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
  No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
  com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
    Permission: null
  com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
    Permission: com.google.android.c2dm.permission.SEND
  com.google.android.apps.youtube.app.PackageReplacedReceiver
    Permission: null
  com.google.android.libraries.youtube.account.AccountsChangedReceiver
    Permission: null
  com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
    Permission: null
```
#### Interactions de diffusion (Broadcast)
```
app.broadcast.info          Get information about broadcast receivers           
app.broadcast.send          Send broadcast using an intent                      
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### Envoyer un message

Dans cet exemple, en abusant du Content Provider de l'apk [FourGoats](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk), vous pouvez **envoyer un SMS arbitraire** √† n'importe quelle destination non-premium **sans demander** la permission de l'utilisateur.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Si vous lisez le code, les param√®tres "_phoneNumber_" et "_message_" doivent √™tre envoy√©s au Content Provider.
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### Est d√©bogable

Un APK de production ne devrait jamais √™tre d√©bogable. Cela signifie que vous pouvez **attacher un d√©bogueur Java** √† l'application en cours d'ex√©cution, l'inspecter en temps r√©el, d√©finir des points d'arr√™t, avancer pas √† pas, recueillir des valeurs de variables et m√™me les modifier. [InfoSec institute a un excellent article](../exploiting-a-debuggeable-applciation.md) sur comment creuser plus profond√©ment lorsque votre application est d√©bogable et injecter du code en temps d'ex√©cution.

Lorsqu'une application est d√©bogable, elle appara√Ætra dans le Manifeste :
```
<application theme="@2131296387" debuggable="true"
```
Vous pouvez trouver toutes les applications d√©boguables avec **Drozer**:
```
run app.package.debuggable
```
## Tutoriels

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/](http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/)

## Plus d'informations

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)



<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Astuce de prime de bug**: **inscrivez-vous** sur **Intigriti**, une plateforme de prime de bug premium cr√©√©e par des hackers, pour les hackers! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au repo [hacktricks](https://github.com/carlospolop/hacktricks) et [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
