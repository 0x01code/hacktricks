# Drozer 튜토리얼

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**버그 바운티 팁**: **해커들이 만든 프리미엄 버그 바운티 플랫폼인 Intigriti에 가입**하세요! 오늘 [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)에서 가입하고 최대 **$100,000**의 바운티를 받으세요!

{% embed url="https://go.intigriti.com/hacktricks" %}

## 테스트용 APKs

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (mrwlabs에서 제공)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)


**이 튜토리얼의 일부는 [Drozer 문서 pdf](https://labs.withsecure.com/content/dam/labs/docs/mwri-drozer-user-guide-2015-03-23.pdf)에서 추출되었습니다.**

## 설치

호스트에 Drozer 클라이언트를 설치하세요. [최신 릴리스](https://github.com/mwrlabs/drozer/releases)에서 다운로드하세요.
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
[최신 릴리스](https://github.com/mwrlabs/drozer/releases)에서 drozer APK를 다운로드하고 설치하세요. 현재 버전은 [여기](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk)입니다.
```bash
adb install drozer.apk
```
### 서버 시작하기

에이전트는 포트 31415에서 실행 중이며, Drozer 클라이언트와 에이전트 간의 통신을 수립하기 위해 [포트 포워딩](https://en.wikipedia.org/wiki/Port\_forwarding)이 필요합니다. 다음은 이를 수행하기 위한 명령어입니다:
```bash
adb forward tcp:31415 tcp:31415
```
마지막으로, **애플리케이션**을 **실행**하고 "**ON**" 버튼을 누르세요.

![](<../../../.gitbook/assets/image (63).png>)

그리고 이에 연결하세요:
```bash
drozer console connect
```
## 흥미로운 명령어

| **명령어**    | **설명**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | 선택한 모듈의 도움말을 표시합니다.                                                                                                                      |
| **list**        | 현재 세션에서 실행할 수 있는 모든 drozer 모듈의 목록을 표시합니다. 이 명령은 적절한 권한이 없는 모듈을 숨깁니다. |
| **shell**       | 에이전트의 컨텍스트에서 디바이스에서 대화형 Linux 쉘을 시작합니다.                                                                           |
| **clean**       | drozer가 안드로이드 장치에 저장한 임시 파일을 제거합니다.                                                                                         |
| **load**        | drozer 명령을 포함하는 파일을 로드하고 순차적으로 실행합니다.                                                                                   |
| **module**      | 인터넷에서 추가적인 drozer 모듈을 찾아 설치합니다.                                                                                          |
| **unset**       | drozer가 생성하는 모든 Linux 쉘에 전달되는 이름이 지정된 변수를 제거합니다.                                                                         |
| **set**         | drozer에 의해 생성된 모든 Linux 쉘에 환경 변수로 전달될 값을 변수에 저장합니다.                                   |
| **shell**       | 에이전트의 컨텍스트에서 디바이스에서 대화형 Linux 쉘을 시작합니다.                                                                            |
| **run MODULE**  | drozer 모듈을 실행합니다.                                                                                                                                |
| **exploit**     | drozer는 디바이스에서 실행할 exploits를 생성할 수 있습니다. `drozer exploit list`                                                                             |
| **payload**     | exploits는 페이로드가 필요합니다. `drozer payload list`                                                                                                     |

### 패키지

이름의 일부로 필터링하여 패키지의 **이름**을 찾습니다:
```bash
dz> run app.package.list -f sieve
com.mwr.example.sieve
```
**패키지의 기본 정보**:

- **Package Name**: com.example.app
- **Version Name**: 1.0
- **Version Code**: 1
- **Target SDK Version**: 28
- **Min SDK Version**: 21
- **Permissions**: INTERNET, ACCESS_NETWORK_STATE, READ_EXTERNAL_STORAGE, WRITE_EXTERNAL_STORAGE

**패키지의 기본 정보**:

- **패키지 이름**: com.example.app
- **버전 이름**: 1.0
- **버전 코드**: 1
- **대상 SDK 버전**: 28
- **최소 SDK 버전**: 21
- **허가 권한**: INTERNET, ACCESS_NETWORK_STATE, READ_EXTERNAL_STORAGE, WRITE_EXTERNAL_STORAGE
```bash
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```
**Manifest** 읽기:

Manifest 파일은 Android 애플리케이션의 핵심 구성 요소를 정의하는 XML 파일입니다. 이 파일은 앱의 패키지 이름, 액티비티, 서비스, 브로드캐스트 수신자 등과 같은 앱의 구성 요소에 대한 정보를 포함합니다. 또한 앱의 권한, 하드웨어 요구 사항, 앱 아이콘 및 라이브러리 종속성과 같은 다른 중요한 세부 정보도 포함할 수 있습니다.

앱을 해킹하거나 펜테스트를 수행할 때, Manifest 파일은 매우 중요한 정보를 제공합니다. 앱의 구성 요소와 권한을 분석하여 앱의 취약점을 식별하고 악용할 수 있습니다. 또한 앱의 기능과 동작을 이해하는 데 도움이 됩니다.

Manifest 파일은 앱의 APK 파일 내에 포함되어 있으며, 다양한 도구를 사용하여 열람할 수 있습니다. 예를 들어, `aapt` 도구를 사용하여 Manifest 파일을 추출하고 분석할 수 있습니다. 또는 `apktool`을 사용하여 APK 파일을 디컴파일하고 Manifest 파일을 확인할 수도 있습니다.

앱을 분석하거나 해킹할 때, Manifest 파일은 첫 번째로 살펴봐야 할 중요한 파일입니다. 앱의 구성 요소, 권한 및 기능을 이해하는 데 도움이 되며, 앱의 취약점을 식별하고 악용하는 데 도움이 됩니다.
```bash
run app.package.manifest jakhar.aseem.diva
```
**패키지의 공격 표면**:
```bash
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```
* **Activities**: 어떤 종류의 권한 제한을 우회하여 액티비티를 시작할 수 있습니다.
* **Content providers**: 개인 데이터에 접근하거나 취약점(SQL Injection 또는 Path Traversal)을 이용할 수 있습니다.
* **Services**:
* **is debuggable**: [자세히 알아보기](./#is-debuggeable)

### Activities

AndroidManifest.xml 파일에서 내보낸(activity) 구성 요소의 "android:exported" 값이 **"true"**로 설정되어 있습니다:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**내보낸 액티비티 목록**:

To list the exported activities of an Android application, you can use the `drozer` tool. 

안드로이드 애플리케이션의 내보낸 액티비티 목록을 확인하려면 `drozer` 도구를 사용할 수 있습니다.

First, start the `drozer` console by running the command `drozer console`. 

먼저, `drozer console` 명령을 실행하여 `drozer` 콘솔을 시작합니다.

Once you are in the `drozer` console, use the `run app.package.exported_activities -a <package_name>` command to list the exported activities of the specified package. 

`drozer` 콘솔에 들어가면, `run app.package.exported_activities -a <package_name>` 명령을 사용하여 지정된 패키지의 내보낸 액티비티 목록을 확인할 수 있습니다.

Replace `<package_name>` with the actual package name of the target application. 

`<package_name>`을 대상 애플리케이션의 실제 패키지 이름으로 대체하세요.

For example, to list the exported activities of an application with the package name `com.example.app`, use the command `run app.package.exported_activities -a com.example.app`. 

예를 들어, 패키지 이름이 `com.example.app`인 애플리케이션의 내보낸 액티비티 목록을 확인하려면 `run app.package.exported_activities -a com.example.app` 명령을 사용하세요.

The `drozer` tool will then display the list of exported activities, along with their corresponding package names. 

그러면 `drozer` 도구가 내보낸 액티비티 목록과 해당 패키지 이름을 표시합니다.
```bash
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```
**액티비티 시작**:

어떤 종류의 권한이 실행을 방지해야 할 수도 있는데, 액티비티를 시작하고 우회할 수 있습니다.

{% code overflow="wrap" %}
```bash
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
{% endcode %}

**adb**를 사용하여 내보낸 액티비티를 시작할 수도 있습니다:

* 패키지 이름은 com.example.demo입니다.
* 내보낸 액티비티 이름은 com.example.test.MainActivity입니다.
```bash
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### 콘텐츠 제공자

이 게시물은 여기에 있을만큼 크기가 커서 **[여기에서 별도의 페이지에서 액세스할 수 있습니다](exploiting-content-providers.md)**.

### 서비스

내보낸 서비스는 Manifest.xml 내에서 선언됩니다:

{% code overflow="wrap" %}
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
{% endcode %}

코드 내에서 **`handleMessage`** 함수를 **확인**하십시오. 이 함수는 **메시지를 수신**합니다:

![](<../../../.gitbook/assets/image (194).png>)

#### 서비스 목록
```bash
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```
#### **서비스와 상호 작용하기**

To interact with a service using drozer, you need to start a drozer session and then use the `run` command to execute various commands against the target service. 

drozer provides a set of built-in modules that can be used to interact with different types of services. These modules can be loaded using the `load` command.

Here is an example of how to interact with a service using drozer:

1. Start a drozer session by running the following command:

   ```
   drozer console connect
   ```

2. Once the session is started, you can use the `run` command to execute various commands against the target service. For example, to list the activities of an Android app, you can use the following command:

   ```
   run app.activity.info -a <package_name>
   ```

   Replace `<package_name>` with the package name of the target app.

3. You can also use the `load` command to load a specific module. For example, to load the `broadcast` module, you can use the following command:

   ```
   load broadcast
   ```

   Once the module is loaded, you can use the `run` command to execute commands specific to that module.

By using the `run` and `load` commands, you can interact with different services and perform various actions such as listing activities, sending broadcasts, and more.
```bash
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```
#### 예시

`app.service.send`에 대한 **drozer** 도움말을 살펴보세요:

![](<../../../.gitbook/assets/image (196) (1).png>)

"_msg.what_", "_msg.arg1_", "_msg.arg2_" 내부에 있는 데이터를 먼저 보내게 됩니다. 코드 내부에서 **어떤 정보가 사용되는지**와 그 위치를 확인해야 합니다.\
`--extra` 옵션을 사용하여 "_msg.replyTo"에서 해석될 수 있는 내용을 보낼 수 있으며, `--bundle-as-obj`를 사용하여 제공된 세부 정보로 객체를 생성할 수 있습니다.

다음 예시에서:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```bash
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### 브로드캐스트 리시버

**Android 기본 정보 섹션에서 브로드캐스트 리시버가 무엇인지 확인할 수 있습니다**.

브로드캐스트 리시버를 발견한 후에는 **그들의 코드를 확인**해야 합니다. 받은 메시지를 처리하는 **`onReceive`** 함수에 특별히 주의해야 합니다.

#### **모든** 브로드캐스트 리시버 감지
```bash
run app.broadcast.info #Detects all
```
#### 앱의 브로드캐스트 리시버 확인

To check the broadcast receivers of an Android app, you can use the `drozer` tool. Drozer is a comprehensive security assessment framework for Android devices. Follow the steps below to check the broadcast receivers of an app using drozer:

1. Install drozer on your machine by following the instructions provided in the [drozer GitHub repository](https://github.com/FSecureLABS/drozer).

2. Connect your Android device to your machine using a USB cable and enable USB debugging on the device.

3. Open a terminal and run the following command to start drozer:

   ```
   drozer console connect
   ```

4. Once the drozer console is open, run the following command to list all installed packages on the device:

   ```
   run app.package.list -f
   ```

   This command will display a list of all installed packages along with their package names.

5. Identify the package name of the app you want to check the broadcast receivers for.

6. Run the following command to list the broadcast receivers of the app:

   ```
   run app.broadcast.info -a <package_name>
   ```

   Replace `<package_name>` with the actual package name of the app.

7. Drozer will display information about the broadcast receivers of the app, including their names, permissions, and exported status.

By following these steps, you can easily check the broadcast receivers of an Android app using drozer. This information can be useful for identifying potential security vulnerabilities or analyzing the behavior of the app.
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```
#### 방송 **상호작용**

Broadcast 상호작용은 안드로이드 앱에서 발생하는 브로드캐스트 메시지를 감지하고 조작하는 기능을 제공합니다. 이를 통해 앱의 동작을 변경하거나 민감한 정보를 노출시킬 수 있습니다. drozer는 앱의 브로드캐스트 상호작용을 테스트하기 위한 다양한 도구와 명령어를 제공합니다.

##### Broadcast Interactions의 유형

- **Broadcast Intent를 감지하기**: 앱이 브로드캐스트 메시지를 수신하는지 확인하기 위해 앱의 브로드캐스트 수신자를 탐지합니다.
- **Broadcast Intent를 조작하기**: 앱의 동작을 변경하기 위해 브로드캐스트 메시지를 조작합니다.
- **Broadcast Intent를 주입하기**: 앱에 브로드캐스트 메시지를 주입하여 민감한 정보를 노출시킵니다.

##### drozer를 사용한 Broadcast Interactions

drozer는 다음과 같은 명령어를 사용하여 앱의 브로드캐스트 상호작용을 테스트할 수 있습니다.

- `run app.broadcast.send` 명령어를 사용하여 브로드캐스트 메시지를 보낼 수 있습니다.
- `run app.broadcast.info` 명령어를 사용하여 앱의 브로드캐스트 수신자 정보를 확인할 수 있습니다.
- `run app.broadcast.inject` 명령어를 사용하여 앱에 브로드캐스트 메시지를 주입할 수 있습니다.

drozer를 사용하여 앱의 브로드캐스트 상호작용을 테스트하면 앱의 취약점을 발견하고 악용할 수 있습니다. 따라서 앱 개발자는 브로드캐스트 수신자를 안전하게 구현하고, 브로드캐스트 메시지를 신뢰할 수 있는 소스에서만 처리해야 합니다.
```bash
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### 메시지 보내기

이 예제에서는 [FourGoats apk](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk) Content Provider를 남용하여 사용자의 허락을 요구하지 않고 임의의 SMS를 **비 프리미엄 대상**으로 **보낼 수 있습니다**.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

코드를 읽으면 "_phoneNumber_" 및 "_message_" 매개변수를 Content Provider로 보내야 합니다.
```bash
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### 디버깅 가능 여부

프로덕션 APK는 절대로 디버깅이 가능해서는 안됩니다.\
이는 실행 중인 애플리케이션에 **자바 디버거를 연결**하여 런타임에서 검사하고, 중단점을 설정하고, 단계별로 진행하며, 변수 값을 수집하고 심지어 변경할 수도 있다는 것을 의미합니다. [InfoSec institute에서는 디버깅 가능한 애플리케이션에서 더 깊이 파고들고 런타임 코드를 주입하는 데 대한 훌륭한 기사](../exploiting-a-debuggeable-applciation.md)를 제공하고 있습니다.

애플리케이션이 디버깅 가능한 경우, Manifest에 나타날 것입니다:
```xml
<application theme="@2131296387" debuggable="true"
```
**Drozer**를 사용하여 모든 디버깅 가능한 애플리케이션을 찾을 수 있습니다:
```bash
run app.package.debuggable
```
## 튜토리얼

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md](https://github.com/mgcfish/mobiletools/blob/master/_posts/2016-08-01-Using-Drozer-for-application-security-assessments.md)
* [https://www.hackingarticles.in/android-penetration-testing-drozer/](https://www.hackingarticles.in/android-penetration-testing-drozer/)
* [https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac](https://medium.com/@ashrafrizvi3006/how-to-test-android-application-security-using-drozer-edc002c5dcac)

## 추가 정보

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**버그 바운티 팁**: 해커들이 만든 프리미엄 버그 바운티 플랫폼인 **Intigriti에 가입**하세요! 오늘 [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)에서 가입하고 최대 **$100,000**의 바운티를 받으세요!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
