# Tutorial de Drozer

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Consejo de recompensa por errores**: ¬°**reg√≠strate** en **Intigriti**, una plataforma premium de **recompensas por errores creada por hackers, para hackers**! √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo y comienza a ganar recompensas de hasta **$100,000**.

{% embed url="https://go.intigriti.com/hacktricks" %}

## APKs para probar

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (de mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## Instalaci√≥n

Instala el cliente Drozer en tu host. Desc√°rgalo desde las [√∫ltimas versiones](https://github.com/mwrlabs/drozer/releases).
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
Descarga e instala el archivo APK de drozer desde las [√∫ltimas versiones](https://github.com/mwrlabs/drozer/releases). En este momento es [esta](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk).
```
adb install drozer.apk
```
### Iniciando el servidor

El agente se est√° ejecutando en el puerto 31415, necesitamos hacer [port forwarding](https://en.wikipedia.org/wiki/Port\_forwarding) para establecer la comunicaci√≥n entre el cliente Drozer y el agente. Aqu√≠ est√° el comando para hacerlo:
```
adb forward tcp:31415 tcp:31415
```
Finalmente, **lanza** la **aplicaci√≥n** y presiona el bot√≥n "**ON**"

![](<../../../.gitbook/assets/image (63).png>)

Y con√©ctate a ella:
```
drozer console connect
```
## Comandos Interesantes

| **Comandos**    | **Descripci√≥n**                                                                                                                                        |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | Muestra la ayuda del m√≥dulo seleccionado.                                                                                                                      |
| **list**        | Muestra una lista de todos los m√≥dulos de drozer que se pueden ejecutar en la sesi√≥n actual. Esto oculta los m√≥dulos que no tienes permisos apropiados para ejecutar. |
| **shell**       | Inicia una shell interactiva de Linux en el dispositivo, en el contexto del Agente.                                                                           |
| **clean**       | Elimina los archivos temporales almacenados por drozer en el dispositivo Android.                                                                                         |
| **load**        | Carga un archivo que contiene comandos de drozer y los ejecuta en secuencia.                                                                                   |
| **module**      | Encuentra e instala m√≥dulos adicionales de drozer desde Internet.                                                                                          |
| **unset**       | Elimina una variable nombrada que drozer pasa a cualquier shell de Linux que inicia.                                                                         |
| **set**         | Almacena un valor en una variable que se pasar√° como variable de entorno a cualquier shell de Linux iniciada por drozer.                                   |
| **shell**       | Inicia una shell interactiva de Linux en el dispositivo, en el contexto del Agente.                                                                            |
| **run MODULE**  | Ejecuta un m√≥dulo de drozer.                                                                                                                                |
| **exploit**     | Drozer puede crear exploits para ejecutar en el dispositivo. `drozer exploit list`                                                                             |
| **payload**     | Los exploits necesitan un payload. `drozer payload list`                                                                                                     |

### Paquete

Encuentra el **nombre** del paquete filtrando por parte del nombre:
```
dz> run app.package.list -f sieve  
com.mwr.example.sieve
```
**Informaci√≥n b√°sica** del paquete:
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
 - android.permission.READ_EXTERNAL_STORAGE
 - android.permission.WRITE_EXTERNAL_STORAGE
 - android.permission.INTERNET
Defines Permissions:
 - com.mwr.example.sieve.READ_KEYS
 - com.mwr.example.sieve.WRITE_KEYS
```
Leer **Manifest**:
```
run app.package.manifest jakhar.aseem.diva
```
**Superficie de ataque** del paquete:
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
 3 activities exported
 0 broadcast receivers exported
 2 content providers exported
 2 services exported
 is debuggable
```
* **Actividades**: Tal vez puedas iniciar una actividad y evitar alg√∫n tipo de autorizaci√≥n que deber√≠a impedirte lanzarla.
* **Proveedores de contenido**: Tal vez puedas acceder a datos privados o explotar alguna vulnerabilidad (Inyecci√≥n SQL o Traversal de Ruta).
* **Servicios**:
* **is debuggable**: [Aprende m√°s](./#is-debuggeable)

### Actividades

El valor "android:exported" de un componente de actividad exportado se establece en **"true"** en el archivo AndroidManifest.xml:
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**Listar actividades exportadas**:
```
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
 com.mwr.example.sieve.FileSelectActivity
 com.mwr.example.sieve.MainLoginActivity
 com.mwr.example.sieve.PWList
```
**Iniciar actividad**:

Tal vez puedas iniciar una actividad y evitar alg√∫n tipo de autorizaci√≥n que deber√≠a impedirte lanzarla.
```
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
Tambi√©n puedes iniciar una actividad exportada desde **adb**:

* El nombre del paquete es com.example.demo
* El nombre de la actividad exportada es com.example.test.MainActivity
```
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### Proveedores de contenido

Este post era demasiado grande para estar aqu√≠, as√≠ que **puedes** [**acceder a √©l en su propia p√°gina aqu√≠**](exploiting-content-providers.md).

### Servicios

Un servicio exportado se declara dentro del Manifest.xml:
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
Dentro del c√≥digo, **busca** la funci√≥n `handleMessage` que **recibir√°** el **mensaje**:

![](<../../../.gitbook/assets/image (194).png>)

#### Listar servicios
```
dz> run app.service.info -a com.mwr.example.sieve 
Package: com.mwr.example.sieve
  com.mwr.example.sieve.AuthService
    Permission: null
  com.mwr.example.sieve.CryptoService
    Permission: null
```
#### **Interactuar** con un servicio
```
app.service.send            Send a Message to a service, and display the reply  
app.service.start           Start Service                                       
app.service.stop            Stop Service
```
#### Ejemplo

Echa un vistazo a la ayuda de **drozer** para `app.service.send`:

![](<../../../.gitbook/assets/image (196) (1).png>)

Ten en cuenta que primero enviar√°s los datos dentro de "_msg.what_", luego "_msg.arg1_" y "_msg.arg2_", debes verificar dentro del c√≥digo **qu√© informaci√≥n se est√° utilizando** y d√≥nde.\
Usando la opci√≥n `--extra` puedes enviar algo interpretado por "_msg.replyTo"_, y usando `--bundle-as-obj` creas un objeto con los detalles proporcionados.

En el siguiente ejemplo:

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### Receptores de difusi√≥n

Las aplicaciones de Android pueden enviar o recibir mensajes de difusi√≥n del sistema Android y de otras aplicaciones de Android, similar al patr√≥n de dise√±o [publicar-suscribir](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe\_pattern). Estas difusiones se env√≠an cuando ocurre un evento de inter√©s. Por ejemplo, el sistema Android env√≠a difusiones cuando ocurren varios eventos del sistema, como cuando se inicia el sistema o el dispositivo comienza a cargarse. Las aplicaciones tambi√©n pueden enviar difusiones personalizadas, por ejemplo, para notificar a otras aplicaciones algo que podr√≠an estar interesadas (por ejemplo, se ha descargado alg√∫n dato nuevo).

Las aplicaciones pueden registrarse para recibir difusiones espec√≠ficas. Cuando se env√≠a una difusi√≥n, el sistema enruta autom√°ticamente las difusiones a las aplicaciones que se han suscrito para recibir ese tipo particular de difusi√≥n.

Esto podr√≠a aparecer dentro del archivo Manifest.xml:
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
    <intent-filter>
        <action android:name="android.intent.action.BOOT_COMPLETED"/>
        <action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
    </intent-filter>
</receiver>
```
Desde: [https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

Despu√©s de descubrir estos receptores de difusi√≥n, **debe verificar el c√≥digo** de los mismos. Preste especial atenci√≥n a la funci√≥n \*\*`onReceive`\*\* ya que ser√° la encargada de manejar los mensajes recibidos.

#### **Detectar todos** los receptores de difusi√≥n
```bash
run app.broadcast.info #Detects all
```
#### Verificar los receptores de difusi√≥n de una aplicaci√≥n
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
  No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
  com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
    Permission: null
  com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
    Permission: com.google.android.c2dm.permission.SEND
  com.google.android.apps.youtube.app.PackageReplacedReceiver
    Permission: null
  com.google.android.libraries.youtube.account.AccountsChangedReceiver
    Permission: null
  com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
    Permission: null
```
#### Interacciones de Difusi√≥n
```
app.broadcast.info          Get information about broadcast receivers           
app.broadcast.send          Send broadcast using an intent                      
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### Enviar un mensaje

En este ejemplo, abusando del Content Provider de la aplicaci√≥n [FourGoats apk](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk), puedes **enviar un SMS arbitrario** a cualquier destino no premium **sin pedirle permiso** al usuario.

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

Si lees el c√≥digo, los par√°metros "_phoneNumber_" y "_message_" deben ser enviados al Content Provider.
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### Es depurable

Un APK de producci√≥n nunca deber√≠a ser depurable. Esto significa que no se puede **adjuntar un depurador de Java** a la aplicaci√≥n en ejecuci√≥n, inspeccionarla en tiempo de ejecuci√≥n, establecer puntos de interrupci√≥n, avanzar paso a paso, recopilar valores de variables e incluso cambiarlos. [InfoSec institute tiene un excelente art√≠culo](../exploiting-a-debuggeable-applciation.md) sobre c√≥mo profundizar cuando su aplicaci√≥n es depurable e inyectar c√≥digo en tiempo de ejecuci√≥n.

Cuando una aplicaci√≥n es depurable, aparecer√° en el Manifiesto:
```
<application theme="@2131296387" debuggable="true"
```
Puedes encontrar todas las aplicaciones depurables con **Drozer**:
```
run app.package.debuggable
```
## Tutoriales

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/](http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/)

## M√°s informaci√≥n

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)



<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Consejo de recompensa por errores**: ¬°**reg√≠strese** en **Intigriti**, una plataforma premium de **recompensas por errores creada por hackers, para hackers**! ¬°√önase a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo y comience a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabaja en una **empresa de ciberseguridad**? ¬øQuiere ver su **empresa anunciada en HackTricks**? ¬øO quiere tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenga el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önase al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠game** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparta sus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
