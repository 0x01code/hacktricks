# Drozer 教程

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家 **网络安全公司** 工作吗？你想在 HackTricks 中看到你的 **公司广告**吗？或者你想获得 **PEASS 的最新版本或下载 HackTricks 的 PDF 版本**吗？请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我的 **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**赏金漏洞提示**：**注册** Intigriti，一个由黑客创建的高级 **赏金漏洞平台**！立即加入我们 [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)，开始赚取高达 **$100,000** 的赏金！

{% embed url="https://go.intigriti.com/hacktricks" %}

## 要测试的 APK

* [Sieve](https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk) (来自 mrwlabs)
* [DIVA](https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz)

## 安装

在主机上安装 Drozer 客户端。从 [最新版本](https://github.com/mwrlabs/drozer/releases) 下载它。
```bash
pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
```
从[最新版本](https://github.com/mwrlabs/drozer/releases)下载并安装drozer APK。目前的版本是[这个](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk)。
```
adb install drozer.apk
```
### 启动服务器

代理正在端口31415上运行，我们需要进行[端口转发](https://en.wikipedia.org/wiki/Port\_forwarding)以建立Drozer客户端和代理之间的通信，以下是执行此操作的命令：
```
adb forward tcp:31415 tcp:31415
```
最后，**启动**应用程序并点击底部的“**ON**”按钮。

![](<../../../.gitbook/assets/image (63).png>)

然后连接到它：
```
drozer console connect
```
## 有趣的命令

| **命令**        | **描述**                                                                                                                                                |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Help MODULE** | 显示所选模块的帮助信息                                                                                                                                  |
| **list**        | 显示当前会话中可以执行的所有drozer模块的列表。这将隐藏您没有适当权限运行的模块。                                                                         |
| **shell**       | 在设备上以Agent的上下文启动一个交互式Linux shell。                                                                                                       |
| **clean**       | 删除Android设备上drozer存储的临时文件。                                                                                                                 |
| **load**        | 加载包含drozer命令并按顺序执行它们的文件。                                                                                                             |
| **module**      | 从互联网上查找并安装额外的drozer模块。                                                                                                                  |
| **unset**       | 删除drozer传递给它生成的任何Linux shell的命名变量。                                                                                                      |
| **set**         | 将一个值存储在变量中，该变量将作为环境变量传递给drozer生成的任何Linux shell。                                                                              |
| **shell**       | 在设备上以Agent的上下文启动一个交互式Linux shell。                                                                                                       |
| **run MODULE**  | 执行一个drozer模块。                                                                                                                                    |
| **exploit**     | Drozer可以创建在设备上执行的利用程序。`drozer exploit list`                                                                                             |
| **payload**     | 利用程序需要一个有效载荷。`drozer payload list`                                                                                                         |

### 包

通过部分名称过滤，找到包的**名称**：
```
dz> run app.package.list -f sieve
com.mwr.example.sieve
```
**软件包的基本信息**：

- **Package Name**: com.example.app
- **Version**: 1.0
- **Target SDK Version**: 28
- **Min SDK Version**: 21
- **Permissions**: INTERNET, ACCESS_NETWORK_STATE, READ_EXTERNAL_STORAGE, WRITE_EXTERNAL_STORAGE

---

**Installation**:

1. Download the APK file from the [link](https://example.com/app.apk).
2. Connect your Android device to your computer.
3. Open a terminal and navigate to the directory where the APK file is located.
4. Install the APK using the following command: `adb install app.apk`

---

**Usage**:

1. Launch the app on your Android device.
2. Explore the app's features and functionalities.
3. Take note of any suspicious behavior or vulnerabilities.
4. Use drozer to perform dynamic analysis and penetration testing on the app.

---

**Drozer Commands**:

- **`drozer console connect`**: Connects to the drozer server running on the Android device.
- **`run app.package.info -a com.example.app`**: Retrieves information about the target app.
- **`run app.package.attacksurface -a com.example.app`**: Identifies the attack surface of the target app.
- **`run app.package.manifest -a com.example.app`**: Retrieves the app's manifest file.
- **`run app.package.permissions -a com.example.app`**: Lists the permissions requested by the app.
- **`run app.package.broadcasts -a com.example.app`**: Lists the broadcast receivers registered by the app.
- **`run app.package.activities -a com.example.app`**: Lists the activities defined by the app.
- **`run app.package.services -a com.example.app`**: Lists the services provided by the app.
- **`run app.package.providers -a com.example.app`**: Lists the content providers exposed by the app.
- **`run app.package.exported -a com.example.app`**: Lists the exported components of the app.
- **`run app.package.urlschemes -a com.example.app`**: Lists the URL schemes handled by the app.
- **`run app.package.broadcast.send -a com.example.app --extra string message "Hello, World!"`**: Sends a broadcast to the app with an extra string message.
- **`run app.activity.start --component com.example.app/.MainActivity`**: Starts the specified activity of the app.
- **`run app.provider.query -a com.example.app --uri content://com.example.app/data`**: Queries the specified content provider of the app.
- **`run app.provider.insert -a com.example.app --uri content://com.example.app/data --string name "John Doe" --string email "johndoe@example.com"`**: Inserts data into the specified content provider of the app.
- **`run app.provider.delete -a com.example.app --uri content://com.example.app/data/1`**: Deletes data from the specified content provider of the app.
- **`run app.provider.update -a com.example.app --uri content://com.example.app/data/1 --string name "Jane Doe"`**: Updates data in the specified content provider of the app.
- **`run app.service.start -a com.example.app --action com.example.app.ACTION_START_SERVICE`**: Starts the specified service of the app.
- **`run app.service.stop -a com.example.app --action com.example.app.ACTION_STOP_SERVICE`**: Stops the specified service of the app.

---

**References**:

- [Drozer Documentation](https://github.com/FSecureLABS/drozer/wiki)
- [Drozer GitHub Repository](https://github.com/FSecureLABS/drozer)
```
dz> run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
- android.permission.READ_EXTERNAL_STORAGE
- android.permission.WRITE_EXTERNAL_STORAGE
- android.permission.INTERNET
Defines Permissions:
- com.mwr.example.sieve.READ_KEYS
- com.mwr.example.sieve.WRITE_KEYS
```
阅读**清单**：
```
run app.package.manifest jakhar.aseem.diva
```
**攻击面**的范围：
```
dz> run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
3 activities exported
0 broadcast receivers exported
2 content providers exported
2 services exported
is debuggable
```
* **活动**：也许你可以启动一个活动并绕过某种应该阻止你启动的授权。
* **内容提供者**：也许你可以访问私有数据或利用一些漏洞（SQL注入或路径遍历）。
* **服务**：
* **is debuggable**：[了解更多](./#is-debuggeable)

### 活动

在AndroidManifest.xml文件中，导出的活动组件的“android:exported”值被设置为**“true”**：
```markup
<activity android:name="com.my.app.Initial" android:exported="true">
</activity>
```
**列出导出的活动**：

To list the exported activities of an Android app, you can use the `drozer` tool. The exported activities are components of an app that can be accessed by other apps or external entities. These activities are declared in the app's manifest file with the `exported` attribute set to `true`.

To list the exported activities using `drozer`, follow these steps:

1. Install `drozer` on your computer and connect your Android device to it.
2. Open a terminal or command prompt and run the following command to start the `drozer` console:

   ```
   drozer console connect
   ```

3. Once the `drozer` console is open, run the following command to start the app's package:

   ```
   run app.package.list -f <package_name>
   ```

   Replace `<package_name>` with the package name of the app you want to analyze.

4. After running the above command, you will see a list of packages installed on the device. Find the package name of the app you want to analyze and note it down.

5. Run the following command to list the exported activities of the app:

   ```
   run app.activity.info -a <package_name>
   ```

   Replace `<package_name>` with the package name of the app you want to analyze.

6. The `drozer` tool will display a list of exported activities along with their corresponding details, such as the activity name, exported status, and intent filters.

By listing the exported activities of an Android app, you can identify potential security vulnerabilities and assess the app's security posture.
```bash
dz> run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.FileSelectActivity
com.mwr.example.sieve.MainLoginActivity
com.mwr.example.sieve.PWList
```
**启动活动**：

也许你可以启动一个活动并绕过某种应该阻止你启动它的授权。 

{% code overflow="wrap" %}
```bash
dz> run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
```
{% endcode %}

您还可以通过**adb**启动导出的活动：

* 包名为com.example.demo
* 导出的活动名为com.example.test.MainActivity
```bash
adb shell am start -n com.example.demo/com.example.test.MainActivity
```
### 内容提供者

这篇文章太长了，所以**你可以**[**在这里访问它的独立页面**](exploiting-content-providers.md)。

### 服务

一个导出的服务在 Manifest.xml 中声明：

{% code overflow="wrap" %}
```markup
<service android:name=".AuthService" android:exported="true" android:process=":remote"/>
```
{% endcode %}

在代码中查找`handleMessage`函数，该函数将接收消息：

![](<../../../.gitbook/assets/image (194).png>)

#### 列出服务
```bash
dz> run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
com.mwr.example.sieve.AuthService
Permission: null
com.mwr.example.sieve.CryptoService
Permission: null
```
#### 与服务进行交互

To interact with a service, you can use the `run` command in drozer. This command allows you to execute various actions on the target service. The syntax for the `run` command is as follows:

```
run <module> <action> [options]
```

Here, `<module>` refers to the module you want to use, `<action>` refers to the action you want to perform, and `[options]` refers to any additional options or parameters required by the action.

For example, to interact with the `activity` module and launch an activity, you can use the following command:

```
run app.activity.start --component <component_name>
```

Replace `<component_name>` with the name of the component you want to launch.

You can also use the `run` command to perform other actions, such as sending intents, querying content providers, and executing shell commands. Each module has its own set of actions and options, so make sure to refer to the module's documentation for more information.

Remember to always exercise caution when interacting with a service, as certain actions may have unintended consequences or security implications.
```
app.service.send            Send a Message to a service, and display the reply
app.service.start           Start Service
app.service.stop            Stop Service
```
#### 示例

查看`drozer`中`app.service.send`的帮助文档：

![](<../../../.gitbook/assets/image (196) (1).png>)

请注意，您将首先发送位于"_msg.what_"、"_msg.arg1_"和"_msg.arg2_"中的数据，您应该在代码中检查**正在使用的信息**以及其位置。\
使用`--extra`选项，您可以发送由"_msg.replyTo"解释的内容，并使用`--bundle-as-obj`创建一个包含提供的详细信息的对象。

在以下示例中：

* `what == 2354`
* `arg1 == 9234`
* `arg2 == 1`
* `replyTo == object(string com.mwr.example.sieve.PIN 1337)`
```
run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
```
![](<../../../.gitbook/assets/image (195).png>)

### 广播接收器

Android应用程序可以从Android系统和其他Android应用程序发送或接收广播消息，类似于[发布-订阅](https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern)设计模式。这些广播在感兴趣的事件发生时发送。例如，当系统启动或设备开始充电时，Android系统会发送广播。应用程序还可以发送自定义广播，例如，通知其他应用程序可能感兴趣的内容（例如，已下载了一些新数据）。

应用程序可以注册接收特定的广播。当发送广播时，系统会自动将广播路由到已订阅接收该特定类型广播的应用程序。

这可能会出现在Manifest.xml文件中：
```markup
<receiver android:name=".MyBroadcastReceiver"  android:exported="true">
<intent-filter>
<action android:name="android.intent.action.BOOT_COMPLETED"/>
<action android:name="android.intent.action.INPUT_METHOD_CHANGED" />
</intent-filter>
</receiver>
```
从：[https://developer.android.com/guide/components/broadcasts](https://developer.android.com/guide/components/broadcasts)

在发现这些广播接收器之后，您应该**检查它们的代码**。特别注意**`onReceive`**函数，因为它将处理接收到的消息。

#### **检测所有**广播接收器
```bash
run app.broadcast.info #Detects all
```
#### 检查应用程序的广播接收器

To check the broadcast receivers of an app, you can use the `drozer` tool. This tool allows you to interact with the Android operating system at the application layer and perform various security assessments.

要检查应用程序的广播接收器，您可以使用 `drozer` 工具。该工具允许您在应用程序层与 Android 操作系统进行交互，并执行各种安全评估。

To begin, you need to install `drozer` on your machine and connect your Android device to it. Once connected, you can start the `drozer` console by running the command `drozer console`.

首先，您需要在计算机上安装 `drozer` 并将 Android 设备连接到计算机。连接成功后，您可以通过运行命令 `drozer console` 来启动 `drozer` 控制台。

In the `drozer` console, you can use the `app.package.list` command to list all the installed packages on the device. Find the package name of the app you want to assess.

在 `drozer` 控制台中，您可以使用 `app.package.list` 命令列出设备上安装的所有包。找到您想要评估的应用程序的包名。

Next, use the `app.broadcast.info` command followed by the package name to retrieve information about the broadcast receivers in the app. This command will display details such as the receiver's name, exported status, and the intent filters it listens for.

接下来，使用 `app.broadcast.info` 命令，后跟包名，以检索有关应用程序中广播接收器的信息。此命令将显示接收器的名称、导出状态以及它监听的意图过滤器等详细信息。

For example, to check the broadcast receivers of an app with the package name `com.example.app`, you would run the command `app.broadcast.info com.example.app`.

例如，要检查包名为 `com.example.app` 的应用程序的广播接收器，您可以运行命令 `app.broadcast.info com.example.app`。

By examining the output of this command, you can identify any potential security vulnerabilities related to the app's broadcast receivers, such as exported receivers that may be susceptible to unauthorized access.

通过检查此命令的输出，您可以确定与应用程序的广播接收器相关的任何潜在安全漏洞，例如可能容易受到未经授权访问的导出接收器。

It is important to assess the security of an app's broadcast receivers as they can be potential entry points for attackers to exploit and gain unauthorized access to sensitive information.

评估应用程序的广播接收器的安全性非常重要，因为它们可能成为攻击者利用的潜在入口点，并获得对敏感信息的未经授权访问。
```bash
#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
Permission: null
com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
Permission: com.google.android.c2dm.permission.SEND
com.google.android.apps.youtube.app.PackageReplacedReceiver
Permission: null
com.google.android.libraries.youtube.account.AccountsChangedReceiver
Permission: null
com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
Permission: null
```
#### 广播 **交互**

Broadcasts are a way for different components within an Android app to communicate with each other. They allow one component to send a message, called an intent, and other components can receive and respond to that message.

广播是Android应用程序中不同组件之间进行通信的一种方式。它们允许一个组件发送一条消息，称为意图（intent），其他组件可以接收并响应该消息。

Broadcasts can be sent within an app or even between different apps. This makes them a powerful tool for inter-app communication.

广播可以在应用程序内部发送，甚至可以在不同的应用程序之间发送。这使得它们成为应用程序间通信的强大工具。

In the context of mobile app pentesting, understanding how broadcasts work is important because they can be used to exploit vulnerabilities in an app. For example, an attacker could send a malicious broadcast to an app and trigger unintended behavior or gain unauthorized access to sensitive information.

在移动应用程序渗透测试的背景下，了解广播的工作原理非常重要，因为它们可以用于利用应用程序中的漏洞。例如，攻击者可以向应用程序发送恶意广播，触发意外行为或未经授权访问敏感信息。

In this tutorial, we will explore how to use the drozer tool to interact with broadcasts in Android apps. Drozer is a powerful security testing framework for Android that allows us to analyze and manipulate Android apps.

在本教程中，我们将探讨如何使用drozer工具与Android应用程序中的广播进行交互。Drozer是一个强大的用于Android的安全测试框架，它允许我们分析和操作Android应用程序。
```
app.broadcast.info          Get information about broadcast receivers
app.broadcast.send          Send broadcast using an intent
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
```
#### 发送消息

在这个例子中，通过滥用 [FourGoats apk](https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk) 的内容提供者，你可以向任何非高级目的地**发送任意短信**，而无需请求用户的权限。

![](<../../../.gitbook/assets/image (199).png>)

![](<../../../.gitbook/assets/image (197) (1).png>)

如果你阅读代码，你会发现需要将参数 "_phoneNumber_" 和 "_message_" 发送给内容提供者。
```
run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message "Hello mate!"
```
### 是否可调试

一个生产环境的 APK 应该永远不可调试。\
这意味着你可以**附加 Java 调试器**到正在运行的应用程序，实时检查它，设置断点，逐步执行，收集变量值甚至修改它们。[InfoSec 研究所有一篇很好的文章](../exploiting-a-debuggeable-applciation.md)介绍了当你的应用程序可调试时如何深入挖掘并注入运行时代码。

当一个应用程序可调试时，它会出现在清单文件中：
```html
<application theme="@2131296387" debuggable="true"
```
您可以使用**Drozer**找到所有可调试的应用程序：
```bash
run app.package.debuggable
```
## 教程

* [https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref](https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref)
* [http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/](http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/)

## 更多信息

* [https://blog.dixitaditya.com/android-pentesting-cheatsheet/](https://blog.dixitaditya.com/android-pentesting-cheatsheet/)

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">

**Bug赏金提示**: **注册**Intigriti，一个由黑客创建的高级**Bug赏金平台**！立即加入我们的[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)，开始赚取高达**$100,000**的赏金！

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者你想要**获取PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>
