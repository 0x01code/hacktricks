# Ataques ao WebView

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Guia Simplificado sobre Configura√ß√µes e Seguran√ßa do WebView

### Vis√£o Geral das Vulnerabilidades do WebView

Um aspecto cr√≠tico do desenvolvimento Android envolve o manuseio correto dos WebViews. Este guia destaca configura√ß√µes-chave e pr√°ticas de seguran√ßa para mitigar os riscos associados ao uso do WebView.

![Exemplo de WebView](../../.gitbook/assets/image%20(718).png)

### **Acesso a Arquivos em WebViews**

Por padr√£o, os WebViews permitem o acesso a arquivos. Essa funcionalidade √© controlada pelo m√©todo `setAllowFileAccess()`, dispon√≠vel desde o n√≠vel de API do Android 3 (Cupcake 1.5). Aplicativos com a permiss√£o **android.permission.READ_EXTERNAL_STORAGE** podem ler arquivos do armazenamento externo usando um esquema de URL de arquivo (`file://caminho/para/arquivo`).

#### **Recursos Obsoletos: Acesso Universal e Acesso a Arquivos a partir de URLs**

- **Acesso Universal a partir de URLs de Arquivo**: Este recurso obsoleto permitia solicita√ß√µes entre origens a partir de URLs de arquivo, representando um risco significativo de seguran√ßa devido a poss√≠veis ataques XSS. A configura√ß√£o padr√£o √© desativada (`false`) para aplicativos direcionados ao Android Jelly Bean e mais recentes.
- Para verificar essa configura√ß√£o, use `getAllowUniversalAccessFromFileURLs()`.
- Para modificar essa configura√ß√£o, use `setAllowUniversalAccessFromFileURLs(boolean)`.

- **Acesso a Arquivos a partir de URLs de Arquivo**: Este recurso, tamb√©m obsoleto, controlava o acesso a conte√∫do de outros URLs de esquema de arquivo. Assim como o acesso universal, sua configura√ß√£o padr√£o √© desativada para maior seguran√ßa.
- Use `getAllowFileAccessFromFileURLs()` para verificar e `setAllowFileAccessFromFileURLs(boolean)` para definir.

#### **Carregamento Seguro de Arquivos**

Para desativar o acesso ao sistema de arquivos enquanto ainda acessa ativos e recursos, √© utilizado o m√©todo `setAllowFileAccess()`. Com o Android R e superior, a configura√ß√£o padr√£o √© `false`.
- Verifique com `getAllowFileAccess()`.
- Ative ou desative com `setAllowFileAccess(boolean)`.

#### **WebViewAssetLoader**

A classe **WebViewAssetLoader** √© a abordagem moderna para carregar arquivos locais. Ela usa URLs http(s) para acessar ativos e recursos locais, alinhando-se com a pol√≠tica de Mesma Origem, facilitando assim a gest√£o de CORS.

### **JavaScript e Manipula√ß√£o de Esquema de Intent**

- **JavaScript**: Desativado por padr√£o em WebViews, pode ser ativado via `setJavaScriptEnabled()`. √â aconselh√°vel cautela, pois habilitar JavaScript sem salvaguardas adequadas pode introduzir vulnerabilidades de seguran√ßa.

- **Esquema de Intent**: WebViews podem lidar com o esquema `intent`, potencialmente levando a exploits se n√£o forem cuidadosamente gerenciados. Um exemplo de vulnerabilidade envolveu um par√¢metro exposto do WebView "support_url" que poderia ser explorado para executar ataques de script entre sites (XSS).

![WebView Vulner√°vel](../../.gitbook/assets/image%20(719).png)

Exemplo de explora√ß√£o usando adb:
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://example.com/xss.html"
```
### Ponte JavaScript

O Android fornece um recurso que permite que o **JavaScript** em um WebView invoque **fun√ß√µes do aplicativo nativo do Android**. Isso √© alcan√ßado utilizando o m√©todo `addJavascriptInterface`, que integra o JavaScript com funcionalidades nativas do Android, denominado como uma _ponte JavaScript do WebView_. √â aconselh√°vel ter cautela, pois esse m√©todo permite que todas as p√°ginas dentro do WebView acessem o objeto de Interface JavaScript registrado, representando um risco de seguran√ßa se informa√ß√µes sens√≠veis forem expostas por meio dessas interfaces.

### Considera√ß√µes Importantes

- **Extrema cautela √© necess√°ria** para aplicativos direcionados a vers√µes do Android abaixo de 4.2 devido a uma vulnerabilidade que permite a execu√ß√£o de c√≥digo remoto por meio de JavaScript malicioso, explorando reflex√£o.

#### Implementando uma Ponte JavaScript

- **Interfaces JavaScript** podem interagir com o c√≥digo nativo, conforme mostrado nos exemplos em que um m√©todo de classe √© exposto ao JavaScript:
```javascript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
```
- A ponte JavaScript √© habilitada adicionando uma interface ao WebView:
```javascript
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```
- Potencial explora√ß√£o atrav√©s de JavaScript, por exemplo, via um ataque XSS, permite a chamada de m√©todos Java expostos:
```html
<script>alert(javascriptBridge.getSecret());</script>
```
- Para mitigar riscos, **restrinja o uso da ponte JavaScript** ao c√≥digo enviado com o APK e evite carregar JavaScript de fontes remotas. Para dispositivos mais antigos, defina o n√≠vel m√≠nimo da API como 17.

### Execu√ß√£o de C√≥digo Remoto (RCE) Baseada em Reflex√£o

- Um m√©todo documentado permite alcan√ßar RCE por meio de reflex√£o ao executar um payload espec√≠fico. No entanto, a anota√ß√£o `@JavascriptInterface` impede o acesso n√£o autorizado aos m√©todos, limitando a superf√≠cie de ataque.

### Depura√ß√£o Remota

- A **depura√ß√£o remota** √© poss√≠vel com as **Ferramentas de Desenvolvedor do Chrome**, permitindo intera√ß√£o e execu√ß√£o arbitr√°ria de JavaScript dentro do conte√∫do do WebView.

#### Habilitando a Depura√ß√£o Remota

- A depura√ß√£o remota pode ser habilitada para todos os WebViews dentro de um aplicativo por meio de:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
- Para habilitar condicionalmente a depura√ß√£o com base no estado de depura√ß√£o do aplicativo:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Exfiltrar arquivos arbitr√°rios

- Demonstra a exfiltra√ß√£o de arquivos arbitr√°rios usando um XMLHttpRequest:
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Refer√™ncias
* [https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html](https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html)
* [https://github.com/authenticationfailure/WheresMyBrowser.Android](https://github.com/authenticationfailure/WheresMyBrowser.Android)
* [https://developer.android.com/reference/android/webkit/WebView](https://developer.android.com/reference/android/webkit/WebView)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
