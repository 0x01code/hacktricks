# Bases des Applications Android

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

- Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
- D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
- **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de les corriger plus rapidement. Intruder suit votre surface d'attaque, lance des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Mod√®le de S√©curit√© Android

**Il y a deux couches :**

- Le **syst√®me d'exploitation (OS)**, qui maintient les applications install√©es isol√©es les unes des autres.
- L'**application elle-m√™me**, qui permet aux d√©veloppeurs de **exposer certaines fonctionnalit√©s** et de configurer les capacit√©s de l'application.

### S√©paration des UID

**Chaque application se voit attribuer un ID utilisateur sp√©cifique**. Cela se fait lors de l'installation de l'application afin que **l'application puisse interagir uniquement avec les fichiers poss√©d√©s par son ID utilisateur ou les fichiers partag√©s**. Par cons√©quent, seule l'application elle-m√™me, certains composants du syst√®me d'exploitation et l'utilisateur root peuvent acc√©der aux donn√©es des applications.

### Partage des UID

**Deux applications peuvent √™tre configur√©es pour utiliser le m√™me UID**. Cela peut √™tre utile pour partager des informations, mais si l'une d'elles est compromise, les donn√©es des deux applications seront compromises. C'est pourquoi ce comportement est **d√©conseill√©**.\
**Pour partager le m√™me UID, les applications doivent d√©finir la m√™me valeur `android:sharedUserId`** dans leurs manifestes.

### Isolation

Le **bac √† sable des applications Android** permet d'ex√©cuter **chaque application** en tant que **processus s√©par√© sous un ID utilisateur distinct**. Chaque processus a sa propre machine virtuelle, de sorte que le code d'une application s'ex√©cute de mani√®re isol√©e par rapport aux autres applications.\
√Ä partir d'Android 5.0 (L), **SELinux** est appliqu√©. Fondamentalement, SELinux a refus√© toutes les interactions entre les processus, puis a cr√©√© des politiques pour **autoriser uniquement les interactions attendues entre eux**.

### Autorisations

Lorsque vous installez une **application et qu'elle demande des autorisations**, l'application demande les autorisations configur√©es dans les √©l√©ments **`uses-permission`** dans le fichier **AndroidManifest.xml**. L'√©l√©ment **uses-permission** indique le nom de l'autorisation demand√©e dans l'attribut **name**. Il a √©galement l'attribut **maxSdkVersion** qui arr√™te de demander des autorisations sur des versions sup√©rieures √† celle sp√©cifi√©e.\
Notez que les applications Android n'ont pas besoin de demander toutes les autorisations au d√©but, elles peuvent √©galement **demander des autorisations dynamiquement** mais toutes les autorisations doivent √™tre **d√©clar√©es** dans le **manifeste**.

Lorsqu'une application expose des fonctionnalit√©s, elle peut limiter **l'acc√®s uniquement aux applications ayant une autorisation sp√©cifi√©e**.\
Un √©l√©ment d'autorisation a trois attributs :

- Le **nom** de l'autorisation
- L'attribut **permission-group**, qui permet de regrouper les autorisations connexes.
- Le **niveau de protection** qui indique comment les autorisations sont accord√©es. Il existe quatre types :
  - **Normal** : Utilis√© lorsqu'il n'y a **aucune menace connue** pour l'application. L'utilisateur n'est **pas tenu d'approuver**.
  - **Dangereux** : Indique que l'autorisation accorde √† l'application demandeur un **acc√®s √©lev√©**. **Les utilisateurs sont invit√©s √† les approuver**.
  - **Signature** : Seules les **applications sign√©es par le m√™me certificat que celui** exportant le composant peuvent se voir accorder l'autorisation. Il s'agit du type de protection le plus fort.
  - **SignatureOrSystem** : Seules les **applications sign√©es par le m√™me certificat que celui** exportant le composant ou les **applications s'ex√©cutant avec un acc√®s de niveau syst√®me** peuvent se voir accorder des autorisations.

## Applications Pr√©-Install√©es

Ces applications se trouvent g√©n√©ralement dans les r√©pertoires **`/system/app`** ou **`/system/priv-app`** et certaines d'entre elles sont **optimis√©es** (vous ne trouverez peut-√™tre m√™me pas le fichier `classes.dex`). Ces applications valent la peine d'√™tre v√©rifi√©es car parfois elles **fonctionnent avec trop de permissions** (en tant que root).

- Celles livr√©es avec le **ROM AOSP** (Android OpenSource Project)
- Ajout√©es par le **fabricant de l'appareil**
- Ajout√©es par le **fournisseur de t√©l√©phonie mobile** (si achet√© chez eux)

## Rootage

Pour obtenir un acc√®s root sur un appareil Android physique, vous devez g√©n√©ralement **exploiter** 1 ou 2 **vuln√©rabilit√©s** qui √©taient **sp√©cifiques** √† l'**appareil** et √† la **version**.\
Une fois l'exploit r√©ussi, g√©n√©ralement le binaire Linux `su` est copi√© dans un emplacement sp√©cifi√© dans la variable d'environnement PATH de l'utilisateur comme `/system/xbin`.

Une fois le binaire su configur√©, une autre application Android est utilis√©e pour interagir avec le binaire `su` et **traiter les demandes d'acc√®s root** comme **Superuser** et **SuperSU** (disponibles sur Google Play Store).

{% hint style="danger" %}
Notez que le processus de rootage est tr√®s dangereux et peut endommager gravement l'appareil
{% endhint %}

### ROMs

Il est possible de **remplacer le syst√®me d'exploitation en installant un firmware personnalis√©**. En faisant cela, il est possible d'√©tendre l'utilit√© d'un ancien appareil, contourner les restrictions logicielles ou acc√©der au dernier code Android.\
**OmniROM** et **LineageOS** sont deux des firmwares les plus populaires √† utiliser.

Notez que **il n'est pas toujours n√©cessaire de rooter l'appareil** pour installer un firmware personnalis√©. **Certains fabricants permettent** le d√©verrouillage de leurs chargeurs d'amor√ßage de mani√®re bien document√©e et s√©curis√©e.

### Implications

Une fois qu'un appareil est root√©, toute application pourrait demander un acc√®s en tant que root. Si une application malveillante l'obtient, elle pourra acc√©der √† presque tout et endommager le t√©l√©phone.

## Fondamentaux des Applications Android <a href="#2-android-application-fundamentals" id="2-android-application-fundamentals"></a>

- Le format des applications Android est appel√© le _format de fichier APK_. Il s'agit essentiellement d'un **fichier ZIP** (en renommant l'extension de fichier en .zip, le contenu peut √™tre extrait et visualis√©).
- Contenu de l'APK (non exhaustif)
  - **AndroidManifest.xml**
  - resources.arsc/strings.xml
  - resources.arsc : contient des ressources pr√©compil√©es, comme du XML binaire.
  - res/xml/files\_paths.xml
  - META-INF/
    - C'est l√† que se trouve le Certificat !
  - **classes.dex**
    - Contient le bytecode Dalvik, repr√©sentant le code Java (ou Kotlin) compil√© que l'application ex√©cute par d√©faut.
  - lib/
    - Contient des biblioth√®ques natives, s√©par√©es par architecture CPU dans des sous-r√©pertoires.
    - `armeabi` : code pour les processeurs bas√©s sur ARM
    - `armeabi-v7a` : code pour les processeurs bas√©s sur ARMv7 et sup√©rieurs
    - `x86` : code pour les processeurs X86
    - `mips` : code pour les processeurs MIPS uniquement
  - assets/
    - Stocke des fichiers divers n√©cessaires √† l'application, potentiellement y compris des biblioth√®ques natives suppl√©mentaires ou des fichiers DEX, parfois utilis√©s par les auteurs de logiciels malveillants pour dissimuler du code suppl√©mentaire.
  - res/
    - Contient des ressources qui ne sont pas compil√©es dans resources.arsc

### **Dalvik & Smali**

- La plupart des applications Android sont d√©velopp√©es en Java ou Kotlin (interchangeables dans ce contexte lorsqu'ils sont appel√©s "Java").
- **Au lieu d'ex√©cuter du code Java dans la machine virtuelle Java** (JVM) comme les applications de bureau, Android compile le Java en **bytecode ex√©cutable Dalvik (DEX)**.
- La traduction du bytecode √©tait historiquement g√©r√©e par la machine virtuelle Dalvik, tandis que les versions Android plus r√©centes utilisent l'Android Runtime (ART).
- Le processus d'ing√©nierie inverse implique de d√©compiler le bytecode DEX dans un format lisible par l'homme.

**Smali est la forme lisible par l'homme du bytecode Dalvik**. Bien que "Smali" et "baksmali" se r√©f√®rent techniquement aux outils d'assemblage et de d√©sassemblage, dans le contexte Android, "Smali" d√©signe souvent les instructions elles-m√™mes. **SMALI est similaire au langage d'assemblage, servant d'interm√©diaire entre le code source et le bytecode**.
```java
Intent email = new Intent(Intent.ACTION_SEND, Uri.parse("mailto:"));
```
L'**Action** de l'intent pr√©c√©demment d√©clar√© est **ACTION\_SEND** et l'**Extra** est un **Uri** mailto (l'Extra est l'information suppl√©mentaire que l'intent attend).

Cet intent doit √™tre d√©clar√© dans le manifeste comme dans l'exemple suivant:
```markup
<activity android:name="ShareActivity">
<intent-filter>
<action android:name="android.intent.action.SEND" />
<category android:name="android.intent.category.DEFAULT" />
</intent-filter>
</activity>
```
Un intent-filter doit correspondre √† l'**action**, aux **donn√©es** et √† la **cat√©gorie** pour recevoir un message.

Le processus de "r√©solution de l'intent" d√©termine quelle application doit recevoir chaque message. Ce processus prend en compte l'attribut de **priorit√©**, qui peut √™tre d√©fini dans la d√©claration de l'**intent-filter**, et **celui avec la priorit√© la plus √©lev√©e sera s√©lectionn√©**. Cette priorit√© peut √™tre d√©finie entre -1000 et 1000 et les applications peuvent utiliser la valeur `SYSTEM_HIGH_PRIORITY`. En cas de **conflit**, une fen√™tre "choisir" appara√Æt pour que l'**utilisateur puisse d√©cider**.

### Intents explicites

Un intent explicite sp√©cifie le nom de la classe qu'il cible:
```java
Intent downloadIntent = new (this, DownloadService.class):
```
Dans d'autres applications, pour acc√©der √† l'intention pr√©c√©demment d√©clar√©e, vous pouvez utiliser :
```java
Intent intent = new Intent();
intent.setClassName("com.other.app", "com.other.app.ServiceName");
context.startService(intent);
```
### Intentions en attente

Ces intentions permettent √† d'autres applications de **prendre des actions au nom de votre application**, en utilisant l'identit√© et les autorisations de votre application. Pour construire une intention en attente, il faut **sp√©cifier une intention et l'action √† effectuer**. Si l'intention **d√©clar√©e n'est pas explicite** (ne d√©clare pas quelle intention peut l'appeler), une **application malveillante pourrait effectuer l'action d√©clar√©e** au nom de l'application victime. De plus, **si une action n'est pas sp√©cifi√©e**, l'application malveillante pourra effectuer **n'importe quelle action au nom de la victime**.

### Intentions de diffusion

Contrairement aux intentions pr√©c√©dentes, qui ne sont re√ßues que par une seule application, les intentions de diffusion **peuvent √™tre re√ßues par plusieurs applications**. Cependant, √† partir de la version API 14, il est **possible de sp√©cifier l'application qui doit recevoir** le message en utilisant Intent.setPackage.

Il est √©galement possible de **sp√©cifier une autorisation lors de l'envoi de la diffusion**. L'application r√©ceptrice devra avoir cette autorisation.

Il existe **deux types** de diffusions : **Normale** (asynchrone) et **Ordonn√©e** (synchrone). L'**ordre** est bas√© sur la **priorit√© configur√©e dans l'√©l√©ment r√©cepteur**. **Chaque application peut traiter, relayer ou abandonner la diffusion**.

Il est possible d'**envoyer** une **diffusion** en utilisant la fonction \*\*`sendBroadcast(intent, receiverPermission)` \*\* de la classe `Context`.\
Vous pourriez √©galement utiliser la fonction **`sendBroadcast`** du **`LocalBroadCastManager`** pour garantir que le **message ne quitte jamais l'application**. En utilisant cela, vous n'aurez m√™me pas besoin d'exporter un composant r√©cepteur.

### Diffusions persistantes

Ce type de diffusions **peut √™tre acc√©d√© longtemps apr√®s leur envoi**.\
Ils ont √©t√© obsol√®tes au niveau de l'API 21 et il est recommand√© de **ne pas les utiliser**.\
**Ils permettent √† n'importe quelle application de renifler les donn√©es, mais aussi de les modifier**.

Si vous trouvez des fonctions contenant le mot "persistant" comme **`sendStickyBroadcast`** ou **`sendStickyBroadcastAsUser`**, **v√©rifiez l'impact et essayez de les supprimer**.

## Liens profonds / Sch√©mas d'URL

**Les liens profonds permettent de d√©clencher une intention via une URL**. Une application peut d√©clarer un **sch√©ma d'URL** √† l'int√©rieur d'une activit√© afin que chaque fois que l'appareil Android tente d'**acc√©der √† une adresse en utilisant ce sch√©ma**, l'activit√© de l'application sera appel√©e :

![](<../../.gitbook/assets/image (214).png>)

Dans ce cas, le sch√©ma est `myapp://` (notez √©galement la **`cat√©gorie BROWSABLE`**)

Si vous trouvez quelque chose comme ceci dans le `intent-filter` :

![](<../../.gitbook/assets/image (263).png>)

Alors, il attend quelque chose comme `http://www.example.com/gizmos`

Si vous trouvez quelque chose comme ceci :

![](<../../.gitbook/assets/image (262).png>)

Cela signifiera qu'il attend une URL commen√ßant par `example://gizmos`\
Dans ce cas, vous pourriez essayer d'abuser de la fonctionnalit√© en cr√©ant un site web avec les charges utiles suivantes. Il tentera de naviguer vers des pages arbitraires et d'ex√©cuter du JS:
```markup
<a href="example://gizmos/https://google.com">click here</a>
<a href="example://gizmos/javascript://%250dalert(1)">click here</a>
```
Pour trouver le **code qui sera ex√©cut√© dans l'application**, allez √† l'activit√© appel√©e par le lien profond et recherchez la fonction **`onNewIntent`**.

![](<../../.gitbook/assets/image (436) (1) (1) (1).png>)

Apprenez comment [appeler des liens profonds sans utiliser de pages HTML](./#exploiting-schemes-deep-links).

## AIDL - Langage de d√©finition d'interface Android

Le **Langage de D√©finition d'Interface Android** (AIDL) vous permet de d√©finir l'interface de programmation sur laquelle le client et le service conviennent afin de **communiquer entre eux en utilisant une communication interprocessus** (IPC). Sur Android, **un processus ne peut normalement pas acc√©der √† la m√©moire d'un autre processus**. Pour communiquer, ils doivent d√©composer leurs objets en primitives que le **syst√®me d'exploitation** peut comprendre, et marshall les objets de part et d'autre de cette fronti√®re pour vous. Le code pour effectuer ce marshalling est fastidieux √† √©crire, c'est pourquoi Android le g√®re pour vous avec AIDL.

Les services utilisant AIDL sont appel√©s **Services li√©s**. Dans la classe du Service, vous trouverez la m√©thode **`onBind`**. C'est **l√† que commence l'interaction**, c'est donc la partie initiale du code √† examiner √† la recherche de vuln√©rabilit√©s potentielles.

Un service li√© est le serveur dans une interface client-serveur. **Il permet aux composants (comme les activit√©s) de se lier au service, d'envoyer des requ√™tes, de recevoir des r√©ponses et d'effectuer une communication interprocessus** (IPC). Un service li√© vit g√©n√©ralement uniquement tant qu'il sert un autre composant d'application et ne s'ex√©cute pas ind√©finiment en arri√®re-plan.

### Messenger

Un Messenger est un autre type de m√©canisme IPC. Comme le **Messenger est √©galement un "Service li√©"**, les donn√©es transmises depuis l'application cliente sont √©galement trait√©es via la m√©thode `onBind`. Ainsi, l'examen du code devrait commencer par cette m√©thode et vous devriez rechercher l'invocation de fonctionnalit√©s sensibles ou une manipulation non s√©curis√©e des donn√©es.

### Binder

Il est rare de trouver une classe Binder invoqu√©e directement car il est beaucoup plus facile d'utiliser AIDL (qui abstrait la classe Binder). Cependant, il est bon de savoir que **Binder est un pilote au niveau du noyau qui d√©place les donn√©es de la m√©moire d'un processus √† celle d'un autre** ([https://www.youtube.com/watch?v=O-UHvFjxwZ8](https://www.youtube.com/watch?v=O-UHvFjxwZ8)).

## Composants

Ces composants comprennent : **Activit√©s, Services, R√©cepteurs de diffusion et Fournisseurs.**

### Activit√© de lancement et autres activit√©s

Une **activit√© Android** est un √©cran de l'interface utilisateur de l'application **Android**. De cette mani√®re, une **activit√© Android** est tr√®s similaire aux fen√™tres d'une application de bureau. Une application **Android** peut contenir une ou plusieurs activit√©s, ce qui signifie une ou plusieurs √©crans.

L'**activit√© de lancement** est ce √† quoi la plupart des gens pensent comme au **point d'entr√©e** d'une application Android. L'activit√© de lancement est l'activit√© qui d√©marre lorsque l'utilisateur clique sur l'ic√¥ne d'une application. Vous pouvez d√©terminer l'activit√© de lancement en regardant le manifeste de l'application. L'activit√© de lancement aura les intentions MAIN et LAUNCHER r√©pertori√©es.

Gardez √† l'esprit que toutes les applications n'auront pas une activit√© de lancement, en particulier les applications sans interface utilisateur. Des exemples d'applications sans interface utilisateur (et donc sans activit√© de lancement) sont les applications pr√©install√©es qui fournissent des services en arri√®re-plan, comme la messagerie vocale.
```markup
<activity android:name=".LauncherActivity">
<intent-filter>
<action android:name="android.intent.action.MAIN" />
<category android:name="android.intent.category.LAUNCHER" />
</intent-filter>
</activity>
```
Les activit√©s peuvent √™tre export√©es, permettant √† d'autres processus sur l'appareil de lancer l'activit√©. Par d√©faut, elles ne sont pas export√©es mais vous pouvez les exporter en d√©finissant :
```markup
<service android:name=".ExampleExportedService" android:exported="true"/>
```
Notez que la capacit√© de **contourner les protections d'activit√© n'est pas toujours une vuln√©rabilit√©**, vous devez v√©rifier √† quelles donn√©es vous avez acc√©d√©.  
De plus, **certaines activit√©s renvoient des donn√©es √† un appelant**. Dans ces sc√©narios, vous devez rechercher la m√©thode **`setResult`** et v√©rifier les donn√©es transmises dans le param√®tre Intent. **S'il s'agit de donn√©es sensibles, vous pourriez avoir une vuln√©rabilit√© de fuite d'informations** et elle est exploitable avec des applications capables de communiquer avec l'activit√©.

**Le code d'une activit√© commence par la m√©thode `onCreate`.**

### Sous-classe d'application

Les applications Android peuvent d√©finir une **sous-classe** de [Application](https://developer.android.com/reference/android/app/Application). Les applications peuvent, mais ne sont pas oblig√©es de d√©finir une sous-classe personnalis√©e d'Application. Si une application Android d√©finit une sous-classe d'Application, **cette classe est instanci√©e avant toute autre classe de l'application**.

Si la m√©thode **`attachBaseContext`** est d√©finie dans la sous-classe d'Application, elle est appel√©e en premier, avant la m√©thode **`onCreate`**.

### Services

[Les services](https://developer.android.com/guide/components/services) **s'ex√©cutent en arri√®re-plan sans interface utilisateur.** Ils sont utilis√©s pour effectuer des **processus longs, m√™me si l'utilisateur commence √† utiliser une application diff√©rente**.

Il existe une myriade de fa√ßons de les d√©marrer et sont donc un point d'entr√©e pour les applications. La fa√ßon par d√©faut qu'un service peut √™tre d√©marr√© en tant que point d'entr√©e vers une application est via **Intents**.

Lorsque la m√©thode **`startService`** est appel√©e pour d√©marrer un Service, la m√©thode **`onStart`** dans le Service est ex√©cut√©e. Il s'ex√©cutera ind√©finiment jusqu'√† ce que la m√©thode **`stopService`** soit appel√©e. Si le service n'est n√©cessaire que tant que le client est connect√©, le client devrait s'y "lier" en utilisant la m√©thode **`bindService`**.

Pour un **service li√©** (voir section pr√©c√©dente), les donn√©es seront transmises √† la m√©thode **`onBind`**.

Par exemple, un service pourrait jouer de la musique en arri√®re-plan pendant que l'utilisateur est dans une application diff√©rente, ou il pourrait r√©cup√©rer des donn√©es sur le r√©seau sans bloquer l'interaction de l'utilisateur avec une activit√©.

Un **service peut √™tre export√©, ce qui permet √† d'autres processus sur l'appareil de d√©marrer le service**. Par d√©faut, les services ne sont pas export√©s mais cela peut √™tre configur√© dans le Manifeste:
```markup
<service android:name=".ExampleExportedService" android:exported="true"/>
```
### R√©cepteurs de diffusion

Les diffusions peuvent √™tre consid√©r√©es comme un syst√®me de messagerie et **les r√©cepteurs de diffusion sont les auditeurs**. Si une application a enregistr√© un r√©cepteur pour une diffusion sp√©cifique, le code de ce r√©cepteur est ex√©cut√© lorsque le syst√®me envoie la diffusion. Notez que dans ce cas, **plusieurs applications peuvent recevoir le m√™me message**.

Il existe **2 fa√ßons** pour une application de **enregistrer un r√©cepteur** : dans le **Manifest de l'application ou enregistr√© dynamiquement** dans le code de l'application en utilisant l'appel API **`registerReceiver`**. Dans le manifeste, vous pouvez limiter les diffusions que vous acceptez gr√¢ce √† l'**utilisation des autorisations dans l'√©l√©ment du r√©cepteur**. Lorsqu'il est **d√©fini dynamiquement**, vous pouvez **transmettre l'autorisation √† la m√©thode `registerReceiver`**.

Dans les deux cas, pour enregistrer le r√©cepteur, les **filtres d'intention pour le r√©cepteur sont d√©finis**. Ces filtres d'intention sont les diffusions qui devraient d√©clencher le r√©cepteur.

Lorsque les diffusions sp√©cifiques pour lesquelles le r√©cepteur est enregistr√© sont envoy√©es, **`onReceive`** dans la classe BroadcastReceiver est **ex√©cut√©**.

Une application peut enregistrer un r√©cepteur pour le message de batterie faible par exemple, et modifier son comportement en fonction de cette information.

Une diffusion peut √™tre **asynchrone** (chaque r√©cepteur la re√ßoit) ou **synchrone** (la diffusion est re√ßue de mani√®re ordonn√©e en fonction de la priorit√© d√©finie pour la recevoir).

{% hint style="danger" %}
**Notez que toute application peut se d√©finir comme prioritaire pour recevoir une diffusion.**
{% endhint %}

Pour **examiner** le **code** impl√©ment√© dans un R√©cepteur de diffusion, vous devez rechercher la m√©thode **`onReceive`** de la classe du r√©cepteur.\
Notez que les **Diffusions ordonn√©es peuvent supprimer l'Intent re√ßu ou m√™me le modifier** en utilisant l'une des m√©thodes setter. Par cons√©quent, les **r√©cepteurs doivent valider les donn√©es**.

### Fournisseur de contenu

Les Fournisseurs de contenu sont la fa√ßon dont les **applications partagent des donn√©es structur√©es**, telles que des bases de donn√©es relationnelles. Il est donc tr√®s important d'utiliser des **autorisations** et de d√©finir le niveau de protection appropri√© pour les prot√©ger.\
Les Fournisseurs de contenu peuvent utiliser les attributs **`readPermission`** et **`writePermission`** pour sp√©cifier les autorisations qu'une application doit avoir. **Ces autorisations ont la priorit√© sur l'attribut de permission**.\
De plus, ils peuvent √©galement **autoriser des exceptions temporaires** en d√©finissant le **`grantUriPermission`** sur true, puis en configurant les param√®tres appropri√©s dans l'√©l√©ment **`grant-uri-permission`** √† l'int√©rieur de l'√©l√©ment du fournisseur dans le fichier manifeste.

Le **`grant-uri-permission`** a trois attributs : path, pathPrefix et pathPattern :

* **path** : Permet de sp√©cifier le chemin complet √† exclure
* **pathPrefix** : Permet de sp√©cifier le d√©but du chemin
* **pathPattern** : Permet l'utilisation de jokers et de remplacements symboliques pour obtenir un contr√¥le plus granulaire.

Il est **important de valider et de nettoyer les entr√©es re√ßues** pour √©viter les vuln√©rabilit√©s potentielles telles que les injections SQL.

**Fonctionnalit√©s du Fournisseur de contenu :**

* Le composant Fournisseur de contenu fournit des donn√©es d'une application √† d'autres sur demande.
* Vous pouvez stocker les donn√©es dans le syst√®me de fichiers, une base de donn√©es SQLite, sur le web, ou tout autre emplacement de stockage persistant auquel votre application peut acc√©der.
* √Ä travers le fournisseur de contenu, d'autres applications peuvent interroger ou m√™me modifier les donn√©es (si le fournisseur de contenu le permet).
* Le Fournisseur de contenu est utile dans les cas o√π une application souhaite partager des donn√©es avec une autre application.
* Il est tr√®s similaire aux bases de donn√©es et comporte quatre m√©thodes.
  * insert()
  * update()
  * delete()
  * query()

**FileProvider**

Il s'agit d'un type de Fournisseur de contenu qui **partage des fichiers** √† partir d'un dossier. Vous pouvez d√©clarer un fournisseur de fichiers de cette mani√®re :
```markup
<provider android:name="androidx.core.content.FileProvider"
android:authorities="com.example.myapp.fileprovider"
android:grantUriPermissions="true" android:exported="false">
<meta-data
android:name="android.support.FILE_PROVIDER_PATHS"
android:resource="@xml/filepaths" />
</provider>
```
Notez l'attribut **`android:exported`** car s'il est **`true`**, les applications externes pourront acc√©der aux dossiers partag√©s.\
Remarquez que la configuration `android:resource="@xml/filepaths"` indique que le fichier _res/xml/filepaths.xml_ contient la configuration des **dossiers** que ce **FileProvider** va **partager**. Voici un exemple de comment indiquer le partage d'un dossier dans ce fichier :
```markup
<paths>
<files-path path="images/" name="myimages" />
</paths>
```
Partager quelque chose comme **`path="."`** pourrait √™tre **dangereux** m√™me si le fournisseur n'est pas export√© s'il existe une autre vuln√©rabilit√© dans une partie du code qui tente d'acc√©der √† ce fournisseur.\
Vous pourriez **acc√©der** √† une **image** √† l'int√©rieur de ce dossier avec `content://com.example.myapp.fileprovider/myimages/default_image.jpg`

L'√©l√©ment `<paths>` peut avoir plusieurs enfants, chacun sp√©cifiant un r√©pertoire diff√©rent √† partager. En plus de l'√©l√©ment **`<files-path>`**, vous pouvez utiliser l'√©l√©ment **`<external-path>`** pour partager des r√©pertoires dans le **stockage externe**, et l'√©l√©ment **`<cache-path>`** pour partager des r√©pertoires dans votre **r√©pertoire cache interne**.\
[Pour plus d'informations sur les attributs sp√©cifiques des fournisseurs de fichiers, consultez ce lien.](https://developer.android.com/reference/androidx/core/content/FileProvider)

[Plus d'informations sur les FileProviders ici](https://developer.android.com/training/secure-file-sharing/setup-sharing).

## WebViews

Les WebViews sont en fait des **navigateurs Web** int√©gr√©s aux applications Android.\
Le contenu des WebViews peut √™tre extrait de sites distants ou peut √™tre des fichiers inclus dans l'application.\
Les WebViews sont **vuln√©rables aux m√™mes vuln√©rabilit√©s affectant tous les navigateurs Web**. Cependant, il existe certaines **configurations** qui peuvent √™tre utiles pour **limiter** la **surface d'attaque**.

Il existe deux types de WebViews sur Android :

* Le **WebViewClient**, le mieux adapt√© pour un rendu HTML simple. Cela n'ex√©cutera pas la fonction d'alerte JS. Ainsi, les tests XSS utilisant cette fonction seront invalides.
* Le **client WebChrome**, est un navigateur Chrome.

Notez que les **navigateurs WebView n'ont pas acc√®s aux cookies du navigateur natif**.

Pour charger une URL ou un fichier, il est possible d'utiliser les fonctions **`loadUrl`**, **`loadData`** ou **`loadDataWithBaseURL`**. **Il est important d'acc√©der uniquement √† des URL s√©curis√©es.**\
La s√©curit√© des WebViews peut √™tre configur√©e via l'objet **`WebSettings`**.\
Par exemple, l'ex√©cution du code JS peut √™tre d√©sactiv√©e en utilisant la m√©thode **`setJavaScriptEnabled`** avec la valeur **`false`**. Cela **√©liminera** la possibilit√© d'une **XSS** et d'autres vuln√©rabilit√©s li√©es √† JS.

La fonctionnalit√© de JavaScript "**Bridge**" **injecte des objets Java dans un WebView les rendant accessibles √† JS**. √Ä partir d'Android 4.2, les m√©thodes doivent √™tre annot√©es avec **`@JavascriptInterface`** pour √™tre accessibles √† JavaScript.

Si **`true`** est pass√© √† **`setAllowContentAccess`**, les **WebViews pourront acc√©der aux fournisseurs de contenu** via le sch√©ma **`content://`**. Cela pose √©videmment un risque pour la s√©curit√©. Notez que si cet acc√®s est accord√©, il est tr√®s important de **s'assurer** que l'URL **`content://`** est **s√ªre**.

Par d√©faut, les fichiers locaux peuvent √™tre acc√©d√©s par les WebViews via des URL file://, mais il existe plusieurs fa√ßons d'emp√™cher ce comportement :

* En passant **`false`** √† **`setAllowFileAccess`**, on emp√™che l'acc√®s au syst√®me de fichiers √† l'exception des ressources via `file:///android_asset` _et_ `file:///android_res`. Ces chemins ne doivent √™tre utilis√©s que pour des donn√©es non sensibles (comme des images) donc cela devrait √™tre s√ªr.
* La m√©thode **`setAllowFileAccess`** indique si un chemin √† partir d'une URL `file://` doit pouvoir acc√©der au contenu √† partir d'autres URL de sch√©ma de fichier.
* La m√©thode **`setAllowUniversalAccessFromFileURLs`** indique si un chemin √† partir d'une URL `file://` doit pouvoir acc√©der au contenu de n'importe quelle origine.

## Autres composants de l'application

### **Signature de l'application**

* Android exige que **toutes les applications soient sign√©es num√©riquement avec un certificat** avant de pouvoir √™tre install√©es. Android utilise ce certificat pour identifier l'auteur d'une application.
* Pour ex√©cuter une application sur l'appareil, elle doit √™tre sign√©e. Lorsqu'une application est install√©e sur un appareil, le **gestionnaire de packages v√©rifie** si l'application a √©t√© correctement sign√©e avec le certificat dans le fichier apk ou non.
* Une application peut √™tre auto-sign√©e ou sign√©e par une autorit√© de certification.
* La signature de l'application garantit qu'une application ne peut pas acc√©der √† une autre application sauf par le biais d'IPC bien d√©finis et √©galement qu'elle est transmise non modifi√©e √† l'appareil.

### **V√©rification de l'application**

* Android 4.2 et ult√©rieur prennent en charge la v√©rification des applications. Les utilisateurs peuvent choisir d'activer "V√©rifier les applications" et faire √©valuer les applications par un v√©rificateur d'application avant l'installation.
* La v√©rification de l'application peut alerter l'utilisateur s'il essaie d'installer une application qui pourrait √™tre nuisible ; si une application est particuli√®rement mauvaise, elle peut bloquer l'installation.

## Gestion des appareils mobiles

MDM ou Mobile Device Management sont des suites logicielles utilis√©es pour **garantir un contr√¥le et des exigences de s√©curit√©** sur les appareils mobiles. Ces suites utilisent les fonctionnalit√©s appel√©es API d'administration de p√©riph√©riques et n√©cessitent l'installation d'une application Android.

G√©n√©ralement, les solutions MDM effectuent des fonctions telles que l'application de politiques de mot de passe, le chiffrement forc√© du stockage et la possibilit√© de supprimer √† distance les donn√©es de l'appareil.

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, lance des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications Web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm_source=referral\&utm_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***


<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
