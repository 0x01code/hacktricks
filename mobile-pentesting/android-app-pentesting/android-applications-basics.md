# Fondamentaux des applications Android

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menace proactives et trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Mod√®le de s√©curit√© Android

**Il y a deux couches :**

* Le **syst√®me d'exploitation**, qui isole les applications install√©es les unes des autres.
* L'**application elle-m√™me**, qui permet aux d√©veloppeurs de **exposer certaines fonctionnalit√©s** et de configurer les capacit√©s de l'application.

### S√©paration des UID

**Chaque application se voit attribuer un ID utilisateur sp√©cifique**. Cela est fait lors de l'installation de l'application afin que l'application ne puisse interagir qu'avec les fichiers appartenant √† son ID utilisateur ou les fichiers partag√©s. Par cons√©quent, seule l'application elle-m√™me, certains composants du syst√®me d'exploitation et l'utilisateur root peuvent acc√©der aux donn√©es des applications.

### Partage des UID

**Deux applications peuvent √™tre configur√©es pour utiliser le m√™me UID**. Cela peut √™tre utile pour partager des informations, mais si l'une d'entre elles est compromise, les donn√©es des deux applications seront compromises. C'est pourquoi ce comportement est **d√©conseill√©**.\
**Pour partager le m√™me UID, les applications doivent d√©finir la m√™me valeur `android:sharedUserId` dans leurs manifestes.**

### Isolation

Le **bac √† sable des applications Android** permet d'ex√©cuter **chaque application** en tant que **processus distinct sous un ID utilisateur distinct**. Chaque processus a sa propre machine virtuelle, de sorte que le code d'une application s'ex√©cute de mani√®re isol√©e par rapport aux autres applications.\
√Ä partir d'Android 5.0(L), **SELinux** est appliqu√©. Fondamentalement, SELinux refuse toutes les interactions entre les processus, puis cr√©e des politiques pour **autoriser uniquement les interactions attendues entre eux**.

### Autorisations

Lorsque vous installez une **application et qu'elle demande des autorisations**, l'application demande les autorisations configur√©es dans les √©l√©ments **`uses-permission`** du fichier **AndroidManifest.xml**. L'√©l√©ment **uses-permission** indique le nom de l'autorisation demand√©e dans l'attribut **name**. Il a √©galement l'attribut **maxSdkVersion** qui arr√™te de demander des autorisations sur les versions sup√©rieures √† celle sp√©cifi√©e.\
Notez que les applications Android n'ont pas besoin de demander toutes les autorisations au d√©but, elles peuvent √©galement **demander des autorisations dynamiquement**, mais toutes les autorisations doivent √™tre **d√©clar√©es** dans le **manifeste**.

Lorsqu'une application expose des fonctionnalit√©s, elle peut limiter **l'acc√®s uniquement aux applications qui ont une autorisation sp√©cifi√©e**.\
Un √©l√©ment d'autorisation a trois attributs :

* Le **nom** de l'autorisation
* L'attribut **permission-group**, qui permet de regrouper les autorisations connexes.
* Le **niveau de protection** qui indique comment les autorisations sont accord√©es. Il existe quatre types :
* **Normal** : Utilis√© lorsqu'il n'y a **aucune menace connue** pour l'application. L'utilisateur **n'est pas tenu d'approuver**.
* **Dangerous** : Indique que l'autorisation accorde √† l'application demandant un **acc√®s accru**. **Les utilisateurs sont invit√©s √† les approuver**.
* **Signature** : Seules les **applications sign√©es par le m√™me certificat que celui** exportant le composant peuvent se voir accorder l'autorisation. Il s'agit du type de protection le plus fort.
* **SignatureOrSystem** : Seules les **applications sign√©es par le m√™me certificat que celui** exportant le composant ou les **applications s'ex√©cutant avec un acc√®s de niveau syst√®me** peuvent se voir accorder des autorisations.

## Applications pr√©install√©es

Ces applications se trouvent g√©n√©ralement dans les r√©pertoires **`/system/app`** ou **`/system/priv-app`** et certaines d'entre elles sont **optimis√©es** (vous ne trouverez peut-√™tre m√™me pas le fichier `classes.dex`). Il vaut la peine de v√©rifier ces applications car parfois elles s'ex√©cutent avec **trop de permissions** (en tant que root).

* Celles livr√©es avec le **ROM** de l'AOSP (Android OpenSource Project)
* Ajout√©es par le **fabricant** de l'appareil
* Ajout√©es par le **fournisseur** de t√©l√©phonie mobile (si achet√© chez eux)

## Rootage

Pour obtenir un acc√®s root sur un appareil Android physique, vous avez g√©n√©ralement besoin d'**exploiter** 1 ou 2 **vuln√©rabilit√©s** qui sont g√©n√©ralement **sp√©cifiques** √† l'appareil et √† la version.\
Une fois que l'exploit a fonctionn√©, g√©n√©ralement le binaire Linux `su` est copi√© dans un emplacement sp√©cifi√© dans la variable d'environnement PATH de l'utilisateur comme `/system/xbin`.

Une fois que le binaire su est configur√©, une autre application Android est utilis√©e pour interagir avec le binaire `su` et **traiter les demandes d'acc√®s root** comme **Superuser** et **SuperSU** (disponibles dans le Google Play Store).

{% hint style="danger" %}
Notez que le processus de rootage est tr√®s dangereux et peut endommager gravement l'appareil.
{% endhint %}
### ROMs

Il est possible de **remplacer le syst√®me d'exploitation en installant un firmware personnalis√©**. En faisant cela, il est possible d'√©tendre l'utilit√© d'un ancien appareil, contourner les restrictions logicielles ou acc√©der au code Android le plus r√©cent.\
**OmniROM** et **LineageOS** sont deux des firmwares les plus populaires √† utiliser.

Notez que **ce n'est pas toujours n√©cessaire de rooter l'appareil** pour installer un firmware personnalis√©. **Certains fabricants permettent** le d√©verrouillage de leurs chargeurs d'amor√ßage de mani√®re bien document√©e et s√©curis√©e.

### Implications

Une fois qu'un appareil est root√©, n'importe quelle application peut demander l'acc√®s en tant que root. Si une application malveillante l'obtient, elle pourra avoir acc√®s √† presque tout et pourra endommager le t√©l√©phone.

## Fondamentaux des applications Android <a href="#2-android-application-fundamentals" id="2-android-application-fundamentals"></a>

Cette introduction est tir√©e de [https://maddiestone.github.io/AndroidAppRE/app\_fundamentals.html](https://maddiestone.github.io/AndroidAppRE/app\_fundamentals.html)

### R√©vision des fondamentaux <a href="#fundamentals-review" id="fundamentals-review"></a>

* Les applications Android sont au format de fichier _APK_. **APK est essentiellement un fichier ZIP**. (Vous pouvez renommer l'extension du fichier en .zip et utiliser unzip pour l'ouvrir et voir son contenu.)
* Contenu de l'APK (non exhaustif)
* **AndroidManifest.xml**
* resources.arsc/strings.xml
* resources.arsc : un fichier contenant des ressources pr√©compil√©es, telles que du XML binaire par exemple.
* res/xml/files\_paths.xml
* META-INF/
* Le certificat se trouve ici !
* **classes.dex**
* Le bytecode Dalvik pour l'application au format de fichier DEX. **C'est le code Java (ou Kotlin)** compil√© que l'application ex√©cutera par d√©faut.
* lib/
* Les biblioth√®ques natives de l'application se trouvent ici par d√©faut ! Sous le r√©pertoire lib/, il y a les r√©pertoires sp√©cifiques au processeur.
* `armeabi` : code compil√© pour tous les processeurs ARM uniquement
* `armeabi-v7a` : code compil√© pour tous les processeurs ARMv7 et sup√©rieurs uniquement
* `x86` : code compil√© pour X86
* `mips` : code compil√© pour les processeurs MIPS uniquement
* assets/
* Tout autre fichier pouvant √™tre n√©cessaire √† l'application.
* Des biblioth√®ques natives suppl√©mentaires ou des fichiers DEX peuvent √™tre inclus ici. Cela peut se produire notamment lorsque les auteurs de logiciels malveillants veulent essayer de "cacher" du code suppl√©mentaire, natif ou Dalvik, en ne l'incluant pas aux emplacements par d√©faut.
* res/
* Le r√©pertoire contenant les ressources non compil√©es dans resources.arsc

### **Dalvik & Smali**

La plupart des applications Android sont √©crites en Java. Kotlin est √©galement pris en charge et interop√©rable avec Java. Pour simplifier, pour le reste de cet atelier, lorsque je parle de "Java", vous pouvez supposer que je veux dire "Java ou Kotlin". **Au lieu que le code Java s'ex√©cute dans une machine virtuelle Java** (JVM) comme les applications de bureau, dans Android, le **Java est compil√© en bytecode \_Dalvik Executable (DEX)**\_\* format\*\*. Pour les versions ant√©rieures d'Android, le bytecode √©tait traduit par la machine virtuelle Dalvik. Pour les versions plus r√©centes d'Android, l'Android Runtime (ART) est utilis√©.\
Si les d√©veloppeurs √©crivent en Java et que le code est compil√© en bytecode DEX, pour effectuer une r√©tro-ing√©nierie, nous travaillons dans la direction oppos√©e.\
\\

![Organigramme du processus du d√©veloppeur. Java vers bytecode DEX](https://maddiestone.github.io/AndroidAppRE/images/DevelopersFlow.jpg)

![Organigramme du processus de l'ing√©nieur inverse. Bytecode DEX vers SMALI vers Java d√©compil√©](https://maddiestone.github.io/AndroidAppRE/images/ReversersFlow.jpg)

**Smali est la version lisible par l'homme du bytecode Dalvik**. Techniquement, Smali et baksmali sont les noms des outils (assembleur et d√©sassembleur, respectivement), mais en Android, nous utilisons souvent le terme "Smali" pour d√©signer les instructions. Si vous avez d√©j√† fait de la r√©tro-ing√©nierie ou de l'architecture informatique sur du code C/C++ compil√©. **SMALI est comme le langage d'assemblage : entre le code source de plus haut niveau et le bytecode**.

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menace proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Intents

Les Intents sont le principal moyen par lequel les applications Android communiquent entre leurs composants ou avec d'autres applications. Ces objets de message peuvent √©galement transporter des donn√©es entre les applications ou les composants, de mani√®re similaire √† la fa√ßon dont les requ√™tes GET/POST sont utilis√©es dans les communications HTTP.

Ainsi, un Intent est essentiellement un **message qui est transmis entre les composants**. Les Intents **peuvent √™tre dirig√©s** vers des composants ou des applications sp√©cifiques, **ou peuvent √™tre envoy√©s sans destinataire sp√©cifique**.\
Pour simplifier, un Intent peut √™tre utilis√© :

* Pour d√©marrer une activit√©, ouvrir une interface utilisateur pour une application
* Comme des diffusions pour informer le syst√®me et les applications des changements
* Pour d√©marrer, arr√™ter et communiquer avec un service en arri√®re-plan
* Pour acc√©der aux donn√©es via des ContentProviders
* Comme des rappels pour g√©rer des √©v√©nements

Une impl√©mentation incorrecte peut entra√Æner une fuite de donn√©es, l'appel de fonctions restreintes et la manipulation du flux de programme.

### Filtre d'Intent

Un filtre d'Intent sp√©cifie les **types d'Intent auxquels une activit√©, un service ou un r√©cepteur de diffusion peut r√©pondre**. Il sp√©cifie ce qu'une activit√© ou un service peut faire et quels types de diffusions un r√©cepteur peut g√©rer. Il permet au composant correspondant de recevoir des Intents du type d√©clar√©. Les filtres d'Intent sont g√©n√©ralement **d√©finis via le fichier AndroidManifest.xml**. Pour un **r√©cepteur de diffusion**, il est √©galement possible de les d√©finir dans **le code**. Un filtre d'Intent est d√©fini par sa cat√©gorie, ses actions et ses filtres de donn√©es. Il peut √©galement contenir des m√©tadonn√©es suppl√©mentaires.

Dans Android, une activit√©/service/fournisseur de contenu/r√©cepteur de diffusion est **public** lorsque **`exported`** est d√©fini sur **`true`**, mais un composant est **√©galement public** si le **manifeste sp√©cifie un filtre d'Intent** pour celui-ci. Cependant,\
les d√©veloppeurs peuvent **rendre explicitement les composants priv√©s** (ind√©pendamment de tout filtre d'Intent)\
en d√©finissant l'attribut \*\* `exported` sur `false`\*\* pour chaque composant dans le fichier manifeste.\
Les d√©veloppeurs peuvent √©galement d√©finir l'attribut **`permission`** pour **exiger une certaine permission d'acc√®s** au composant, limitant ainsi l'acc√®s √† celui-ci.
### Intentions implicites

Les intentions sont cr√©√©es de mani√®re programmatique √† l'aide d'un constructeur Intent :
```java
Intent email = new Intent(Intent.ACTION_SEND, Uri.parse("mailto:"));
```
L'**Action** de l'intent pr√©c√©demment d√©clar√© est **ACTION\_SEND** et l'**Extra** est un **Uri** mailto (l'Extra est l'information suppl√©mentaire que l'intent attend).

Cet intent doit √™tre d√©clar√© dans le manifeste comme dans l'exemple suivant:
```markup
<activity android:name="ShareActivity">
<intent-filter>
<action android:name="android.intent.action.SEND" />
<category android:name="android.intent.category.DEFAULT" />
</intent-filter>
</activity>
```
Un intent-filter doit correspondre √† l'**action**, aux **donn√©es** et √† la **cat√©gorie** pour recevoir un message.

Le processus de "r√©solution de l'intention" d√©termine quelle application doit recevoir chaque message. Ce processus prend en compte l'attribut de **priorit√©**, qui peut √™tre d√©fini dans la **d√©claration de l'intent-filter**, et **celui avec la priorit√© la plus √©lev√©e sera s√©lectionn√©**. Cette priorit√© peut √™tre d√©finie entre -1000 et 1000 et les applications peuvent utiliser la valeur `SYSTEM_HIGH_PRIORITY`. En cas de **conflit**, une fen√™tre "choisir" appara√Æt pour que **l'utilisateur puisse d√©cider**.

### Intents explicites

Un intent explicite sp√©cifie le nom de la classe qu'il vise :
```java
Intent downloadIntent = new (this, DownloadService.class):
```
Dans d'autres applications, pour acc√©der √† l'intention pr√©c√©demment d√©clar√©e, vous pouvez utiliser :
```java
Intent intent = new Intent();
intent.setClassName("com.other.app", "com.other.app.ServiceName");
context.startService(intent);
```
### Intentions en attente

Celles-ci permettent √† d'autres applications de **prendre des actions au nom de votre application**, en utilisant l'identit√© et les permissions de votre application. Pour construire une intention en attente, il faut **sp√©cifier une intention et l'action √† effectuer**. Si l'intention **d√©clar√©e n'est pas explicite** (ne d√©clare pas quelle intention peut l'appeler), une **application malveillante pourrait effectuer l'action d√©clar√©e** au nom de l'application victime. De plus, **si aucune action n'est sp√©cifi√©e**, l'application malveillante pourra effectuer **n'importe quelle action au nom de la victime**.

### Intentions de diffusion

Contrairement aux intentions pr√©c√©dentes, qui ne sont re√ßues que par une seule application, les intentions de diffusion **peuvent √™tre re√ßues par plusieurs applications**. Cependant, √† partir de la version API 14, il est **possible de sp√©cifier l'application qui doit recevoir** le message en utilisant Intent.setPackage.

Il est √©galement possible de **sp√©cifier une permission lors de l'envoi de la diffusion**. L'application r√©ceptrice devra avoir cette permission.

Il existe **deux types** de diffusions : **normales** (asynchrones) et **ordonn√©es** (synchrones). L'**ordre** est bas√© sur la **priorit√© configur√©e dans l'√©l√©ment r√©cepteur**. **Chaque application peut traiter, relayer ou supprimer la diffusion**.

Il est possible d'**envoyer** une **diffusion** en utilisant la fonction \*\*`sendBroadcast(intent, receiverPermission)` \*\* de la classe `Context`.\
Vous pouvez √©galement utiliser la fonction **`sendBroadcast`** de **`LocalBroadCastManager`** qui garantit que le **message ne quitte jamais l'application**. En utilisant cela, vous n'aurez m√™me pas besoin d'exporter un composant r√©cepteur.

### Diffusions persistantes

Ce type de diffusions **peut √™tre acc√©d√© longtemps apr√®s leur envoi**.\
Celles-ci ont √©t√© d√©pr√©ci√©es √† partir du niveau API 21 et il est recommand√© de **ne pas les utiliser**.\
**Elles permettent √† n'importe quelle application de renifler les donn√©es, mais aussi de les modifier**.

Si vous trouvez des fonctions contenant le mot "persistant" comme **`sendStickyBroadcast`** ou **`sendStickyBroadcastAsUser`**, **v√©rifiez l'impact et essayez de les supprimer**.

## Liens profonds / sch√©mas d'URL

**Les liens profonds permettent de d√©clencher une intention via une URL**. Une application peut d√©clarer un **sch√©ma d'URL** √† l'int√©rieur d'une activit√©, de sorte que chaque fois que l'appareil Android essaie d'**acc√©der √† une adresse en utilisant ce sch√©ma**, l'activit√© de l'application sera appel√©e :

![](<../../.gitbook/assets/image (214).png>)

Dans ce cas, le sch√©ma est `myapp://` (notez √©galement la **`cat√©gorie BROWSABLE`**)

Si vous trouvez quelque chose comme ceci dans le `intent-filter` :

![](<../../.gitbook/assets/image (263).png>)

Alors, il attend quelque chose comme `http://www.example.com/gizmos`

Si vous trouvez quelque chose comme ceci :

![](<../../.gitbook/assets/image (262).png>)

Cela signifiera qu'il attend une URL commen√ßant par `example://gizmos`\
Dans ce cas, vous pouvez essayer d'exploiter la fonctionnalit√© en cr√©ant un site web avec les charges utiles suivantes. Cela essaiera de naviguer vers des pages arbitraires et d'ex√©cuter du code JS :
```markup
<a href="example://gizmos/https://google.com">click here</a>
<a href="example://gizmos/javascript://%250dalert(1)">click here</a>
```
Pour trouver le **code qui sera ex√©cut√© dans l'application**, allez √† l'activit√© appel√©e par le deeplink et recherchez la fonction **`onNewIntent`**.

![](<../../.gitbook/assets/image (436) (1) (1) (1).png>)

Apprenez comment [appeler des deeplinks sans utiliser de pages HTML](./#exploiting-schemes-deep-links).

## AIDL - Android Interface Definition Language

Le **langage de d√©finition d'interface Android** (AIDL) vous permet de d√©finir l'interface de programmation sur laquelle le client et le service s'accordent pour **communiquer entre eux en utilisant une communication interprocessus** (IPC). Sur Android, **un processus ne peut normalement pas acc√©der √† la m√©moire d'un autre processus**. Ainsi, pour communiquer, ils doivent d√©composer leurs objets en primitives que le **syst√®me d'exploitation** peut comprendre, et marquer les objets de part et d'autre de cette fronti√®re pour vous. Le code pour effectuer cette marquage est fastidieux √† √©crire, c'est pourquoi Android le g√®re pour vous avec AIDL.

Les services utilisant AIDL sont appel√©s **services li√©s**. Dans la classe du service, vous trouverez la m√©thode **`onBind`**. C'est **ici que commence l'interaction**, c'est donc la premi√®re partie du code √† examiner √† la recherche de vuln√©rabilit√©s potentielles.

Un service li√© est le serveur dans une interface client-serveur. **Il permet aux composants (comme les activit√©s) de se lier au service, d'envoyer des requ√™tes, de recevoir des r√©ponses et d'effectuer une communication interprocessus** (IPC). Un service li√© vit g√©n√©ralement seulement tant qu'il sert un autre composant d'application et ne s'ex√©cute pas ind√©finiment en arri√®re-plan.

### Messenger

Un Messenger est un autre type de m√©canisme IPC. √âtant donn√© que le **Messenger est √©galement un "service li√©"**, les donn√©es transmises depuis l'application cliente sont √©galement trait√©es par la m√©thode `onBind`. Ainsi, l'examen du code devrait commencer par cette m√©thode et vous devriez rechercher l'invocation de fonctionnalit√©s sensibles ou une manipulation non s√©curis√©e des donn√©es.

### Binder

Il est rare de trouver une classe Binder invoqu√©e directement car il est beaucoup plus facile d'utiliser AIDL (qui abstrait la classe Binder). Cependant, il est bon de savoir que **Binder est un pilote de niveau noyau qui d√©place les donn√©es de la m√©moire d'un processus vers celle d'un autre** ([https://www.youtube.com/watch?v=O-UHvFjxwZ8](https://www.youtube.com/watch?v=O-UHvFjxwZ8)).

## Composants

Ces composants comprennent : **Activit√©s, Services, R√©cepteurs de diffusion et Fournisseurs**.

### Activit√© de lancement et autres activit√©s

Une **activit√© Android** est un √©cran de l'interface utilisateur de l'application Android. De cette mani√®re, une **activit√© Android** est tr√®s similaire aux fen√™tres d'une application de bureau. Une application Android peut contenir une ou plusieurs activit√©s, c'est-√†-dire une ou plusieurs √©crans.

L'**activit√© de lancement** est ce que la plupart des gens consid√®rent comme le **point d'entr√©e** d'une application Android. L'activit√© de lancement est l'activit√© qui est d√©marr√©e lorsque l'utilisateur clique sur l'ic√¥ne d'une application. Vous pouvez d√©terminer l'activit√© de lancement en regardant le manifeste de l'application. L'activit√© de lancement aura les intentions MAIN et LAUNCHER suivantes r√©pertori√©es.

Gardez √† l'esprit que toutes les applications n'auront pas une activit√© de lancement, en particulier les applications sans interface utilisateur. Des exemples d'applications sans interface utilisateur (et donc sans activit√© de lancement) sont les applications pr√©install√©es qui fournissent des services en arri√®re-plan, tels que la messagerie vocale.
```markup
<activity android:name=".LauncherActivity">
<intent-filter>
<action android:name="android.intent.action.MAIN" />
<category android:name="android.intent.category.LAUNCHER" />
</intent-filter>
</activity>
```
Les activit√©s peuvent √™tre export√©es, ce qui permet √† d'autres processus sur l'appareil de lancer l'activit√©. Par d√©faut, elles ne sont pas export√©es, mais vous pouvez les exporter en d√©finissant :
```markup
<service android:name=".ExampleExportedService" android:exported="true"/>
```
Notez que la capacit√© √† contourner les protections d'activit√© n'est pas toujours une vuln√©rabilit√©, vous devez v√©rifier √† quelles donn√©es vous avez acc√®s.
De plus, certaines activit√©s renvoient des donn√©es √† l'appelant. Dans ces sc√©narios, vous devez rechercher la m√©thode `setResult` et v√©rifier les donn√©es qui sont transmises en param√®tre de l'Intent. Si ce sont des donn√©es sensibles, vous pourriez avoir une vuln√©rabilit√© de fuite d'informations et elle peut √™tre exploit√©e avec des applications capables de communiquer avec l'activit√©.

Le code d'une activit√© commence par la m√©thode `onCreate`.

### Sous-classe d'application

Les applications Android peuvent d√©finir une sous-classe de [Application](https://developer.android.com/reference/android/app/Application). Les applications peuvent, mais n'ont pas besoin de d√©finir une sous-classe personnalis√©e de Application. Si une application Android d√©finit une sous-classe de Application, cette classe est instanci√©e avant toute autre classe de l'application.

Si la m√©thode `attachBaseContext` est d√©finie dans la sous-classe de Application, elle est appel√©e en premier, avant la m√©thode `onCreate`.

### Services

[Les services](https://developer.android.com/guide/components/services) s'ex√©cutent en arri√®re-plan sans interface utilisateur. Ils sont utilis√©s pour effectuer des processus longs, m√™me si l'utilisateur commence √† utiliser une autre application.

Il existe une multitude de fa√ßons de les d√©marrer et ils constituent donc un point d'entr√©e pour les applications. La fa√ßon par d√©faut de d√©marrer un service en tant que point d'entr√©e d'une application est par le biais d'Intents.

Lorsque la m√©thode `startService` est appel√©e pour d√©marrer un service, la m√©thode `onStart` dans le service est ex√©cut√©e. Elle s'ex√©cutera ind√©finiment jusqu'√† ce que la m√©thode `stopService` soit appel√©e. Si le service n'est n√©cessaire que tant que le client est connect√©, le client doit s'y "lier" en utilisant la m√©thode `bindService`.

Pour un service li√© (voir la section pr√©c√©dente), les donn√©es seront transmises √† la m√©thode `onBind`.

Par exemple, un service peut jouer de la musique en arri√®re-plan pendant que l'utilisateur se trouve dans une autre application, ou il peut r√©cup√©rer des donn√©es via le r√©seau sans bloquer l'interaction de l'utilisateur avec une activit√©.

Un service peut √™tre export√©, ce qui permet √† d'autres processus sur l'appareil de d√©marrer le service. Par d√©faut, les services ne sont pas export√©s, mais cela peut √™tre configur√© dans le Manifeste :
```markup
<service android:name=".ExampleExportedService" android:exported="true"/>
```
### R√©cepteurs de diffusion

Les diffusions peuvent √™tre consid√©r√©es comme un syst√®me de messagerie et les r√©cepteurs de diffusion sont les auditeurs. Si une application a enregistr√© un r√©cepteur pour une diffusion sp√©cifique, le code de ce r√©cepteur est ex√©cut√© lorsque le syst√®me envoie la diffusion. Notez que dans ce cas, plusieurs applications peuvent recevoir le m√™me message.

Il existe 2 fa√ßons pour une application de s'enregistrer en tant que r√©cepteur : dans le manifeste de l'application ou enregistr√© dynamiquement dans le code de l'application en utilisant l'appel d'API `registerReceiver`. Dans le manifeste, vous pouvez limiter les diffusions que vous acceptez en utilisant des autorisations dans l'√©l√©ment r√©cepteur. Lorsqu'il est d√©fini dynamiquement, vous pouvez transmettre l'autorisation √† la m√©thode `registerReceiver`.

Dans les deux cas, pour enregistrer le r√©cepteur, les filtres d'intention pour le r√©cepteur sont d√©finis. Ces filtres d'intention sont les diffusions qui doivent d√©clencher le r√©cepteur.

Lorsque les diffusions sp√©cifiques pour lesquelles le r√©cepteur est enregistr√© sont envoy√©es, la m√©thode `onReceive` de la classe BroadcastReceiver est ex√©cut√©e.

Une application peut par exemple s'enregistrer en tant que r√©cepteur pour le message de batterie faible et modifier son comportement en fonction de cette information.

La diffusion peut √™tre asynchrone (chaque r√©cepteur la re√ßoit) ou synchrone (la diffusion est re√ßue de mani√®re ordonn√©e en fonction de la priorit√© d√©finie pour la recevoir).

{% hint style="danger" %}
Notez que n'importe quelle application peut se d√©finir comme prioritaire pour recevoir une diffusion.
{% endhint %}

Pour examiner le code impl√©ment√© dans un r√©cepteur de diffusion, vous devez rechercher la m√©thode `onReceive` de la classe du r√©cepteur. Notez que les diffusions ordonn√©es peuvent supprimer l'intention re√ßue ou m√™me la modifier en utilisant l'une des m√©thodes setter. Par cons√©quent, les r√©cepteurs doivent valider les donn√©es.

### Fournisseur de contenu

Les fournisseurs de contenu sont la fa√ßon dont les applications partagent des donn√©es structur√©es, telles que des bases de donn√©es relationnelles. Il est donc tr√®s important d'utiliser des autorisations et de d√©finir le niveau de protection appropri√© pour les prot√©ger. Les fournisseurs de contenu peuvent utiliser les attributs `readPermission` et `writePermission` pour sp√©cifier les autorisations qu'une application doit avoir. Ces autorisations ont la priorit√© sur l'attribut d'autorisation. De plus, ils peuvent √©galement autoriser des exceptions temporaires en d√©finissant `grantUriPermission` sur true, puis en configurant les param√®tres appropri√©s dans l'√©l√©ment `grant-uri-permission` √† l'int√©rieur de l'√©l√©ment fournisseur du fichier manifeste.

`grant-uri-permission` a trois attributs : path, pathPrefix et pathPattern :

- path : permet de sp√©cifier le chemin complet √† exclure
- pathPrefix : permet de sp√©cifier le d√©but du chemin
- pathPattern : permet d'utiliser des caract√®res g√©n√©riques et des remplacements symboliques pour un contr√¥le plus granulaire.

Il est important de valider et de nettoyer les entr√©es re√ßues pour √©viter les vuln√©rabilit√©s potentielles telles que les injections SQL.

Caract√©ristiques du fournisseur de contenu :

- Le composant fournisseur de contenu fournit des donn√©es d'une application √† d'autres sur demande.
- Vous pouvez stocker les donn√©es dans le syst√®me de fichiers, une base de donn√©es SQLite, sur le web ou tout autre emplacement de stockage persistant accessible par votre application.
- Gr√¢ce au fournisseur de contenu, d'autres applications peuvent interroger ou m√™me modifier les donn√©es (si le fournisseur de contenu le permet).
- Le fournisseur de contenu est utile dans les cas o√π une application souhaite partager des donn√©es avec une autre application.
- Il est tr√®s similaire aux bases de donn√©es et dispose de quatre m√©thodes :
  - insert()
  - update()
  - delete()
  - query()

**FileProvider**

Il s'agit d'un type de fournisseur de contenu qui permet de partager des fichiers √† partir d'un dossier. Vous pouvez d√©clarer un fournisseur de fichiers de la mani√®re suivante :
```markup
<provider android:name="androidx.core.content.FileProvider"
android:authorities="com.example.myapp.fileprovider"
android:grantUriPermissions="true" android:exported="false">
<meta-data
android:name="android.support.FILE_PROVIDER_PATHS"
android:resource="@xml/filepaths" />
</provider>
```
Notez l'attribut **`android:exported`** car s'il est **`true`**, les applications externes pourront acc√©der aux dossiers partag√©s.\
Notez que la configuration `android:resource="@xml/filepaths"` indique que le fichier _res/xml/filepaths.xml_ contient la configuration des **dossiers** que ce **FileProvider** va **partager**. Voici un exemple de comment indiquer le partage d'un dossier dans ce fichier :
```markup
<paths>
<files-path path="images/" name="myimages" />
</paths>
```
Partager quelque chose comme **`path="."`** pourrait √™tre **dangereux** m√™me si le fournisseur n'est pas export√© s'il existe une autre vuln√©rabilit√© dans une partie du code qui tente d'acc√©der √† ce fournisseur.\
Vous pouvez **acc√©der** √† une **image** √† l'int√©rieur de ce dossier avec `content://com.example.myapp.fileprovider/myimages/default_image.jpg`

L'√©l√©ment `<paths>` peut avoir plusieurs enfants, chacun sp√©cifiant un r√©pertoire diff√©rent √† partager. En plus de l'√©l√©ment **`<files-path>`**, vous pouvez utiliser l'√©l√©ment **`<external-path>`** pour partager des r√©pertoires dans le **stockage externe**, et l'√©l√©ment **`<cache-path>`** pour partager des r√©pertoires dans votre **r√©pertoire de cache interne**.\
[Pour plus d'informations sur les attributs sp√©cifiques des fournisseurs de fichiers, consultez ici.](https://developer.android.com/reference/androidx/core/content/FileProvider)

[Plus d'informations sur les FileProviders ici](https://developer.android.com/training/secure-file-sharing/setup-sharing).

## WebViews

Les WebViews sont en fait des **navigateurs Web** int√©gr√©s aux applications Android.\
Le contenu des WebViews peut √™tre extrait de sites distants ou peut √™tre des fichiers inclus dans l'application.\
Les WebViews sont **vuln√©rables aux m√™mes vuln√©rabilit√©s affectant tous les navigateurs Web**. Cependant, il existe certaines **configurations** qui peuvent √™tre utiles pour **limiter** la **surface d'attaque**.

Il existe deux types de WebViews sur Android :

* Le **WebViewClient**, le mieux adapt√© pour le rendu simple du HTML. Cela n'ex√©cutera pas la fonction d'alerte JS. Ainsi, les tests XSS utilisant cette fonction seront invalides.
* Le **client WebChrome**, est un navigateur Chrome.

Notez que les navigateurs **WebView n'ont pas acc√®s aux cookies du navigateur natif**.

Pour charger une URL ou un fichier, il est possible d'utiliser les fonctions **`loadUrl`**, **`loadData`** ou **`loadDataWithBaseURL`**. **Il est important d'acc√©der uniquement aux URL sanitaires.**\
La s√©curit√© des WebView peut √™tre configur√©e via l'objet **`WebSettings`**.\
Par exemple, l'ex√©cution du code JS peut √™tre d√©sactiv√©e en utilisant la m√©thode **`setJavaScriptEnabled`** avec la valeur **`false`**. Cela **supprimera** la possibilit√© d'une **XSS** et d'autres vuln√©rabilit√©s li√©es √† JS.

La fonctionnalit√© JavaScript "**Bridge**" **injecte des objets Java dans un WebView les rendant accessibles √† JS**. √Ä partir d'Android 4.2, les m√©thodes doivent √™tre annot√©es avec **`@JavascriptInterface`** pour √™tre accessibles √† JavaScript.

Si **`true`** est pass√© √† **`setAllowContentAccess`**, les WebViews pourront acc√©der aux fournisseurs de contenu via le sch√©ma **`content://`**. Cela pose √©videmment un risque pour la s√©curit√©. Notez que si cet acc√®s est accord√©, il est tr√®s important de **s'assurer** que l'URL **`content://`** est **s√ªre**.

Par d√©faut, les fichiers locaux peuvent √™tre accessibles par les WebViews via les URL file://, mais il existe plusieurs fa√ßons d'emp√™cher ce comportement :

* Passer **`false`** √† **`setAllowFileAccess`**, emp√™che l'acc√®s au syst√®me de fichiers √† l'exception des ressources via `file:///android_asset` _et_ `file:///android_res`. Ces chemins ne doivent √™tre utilis√©s que pour des donn√©es non sensibles (comme des images), donc cela devrait √™tre s√ªr.
* La m√©thode **`setAllowFileAccess`** indique si un chemin √† partir d'une URL `file://` doit pouvoir acc√©der au contenu d'autres URL de sch√©ma de fichier.
* La m√©thode **`setAllowUniversalAccessFromFileURLs`** indique si un chemin √† partir d'une URL `file://` doit pouvoir acc√©der au contenu de n'importe quelle origine.

## Autres composants d'application

### **Signature d'application**

* Android exige que **toutes les applications soient sign√©es num√©riquement avec un certificat** avant de pouvoir √™tre install√©es. Android utilise ce certificat pour identifier l'auteur d'une application.
* Pour ex√©cuter une application sur l'appareil, elle doit √™tre sign√©e. Lorsqu'une application est install√©e sur un appareil, le **gestionnaire de packages v√©rifie** si l'application a √©t√© correctement sign√©e avec le certificat du fichier APK ou non.
* L'application peut √™tre auto-sign√©e ou sign√©e par une autorit√© de certification.
* La signature de l'application garantit qu'une application ne peut pas acc√©der √† une autre application sauf par le biais d'IPC bien d√©finis et qu'elle est transmise sans modification √† l'appareil.

### **V√©rification d'application**

* Android 4.2 et versions ult√©rieures prennent en charge la v√©rification d'application. Les utilisateurs peuvent choisir d'activer la fonctionnalit√© "V√©rifier les applications" et faire √©valuer les applications par un v√©rificateur d'applications avant l'installation.
* La v√©rification de l'application peut avertir l'utilisateur s'il essaie d'installer une application potentiellement dangereuse ; si une application est particuli√®rement mauvaise, elle peut bloquer l'installation.

## Gestion des appareils mobiles

MDM ou Mobile Device Management sont des suites logicielles utilis√©es pour **assurer un contr√¥le et des exigences de s√©curit√©** sur les appareils mobiles. Ces suites utilisent les fonctionnalit√©s appel√©es API d'administration de p√©riph√©rique et n√©cessitent l'installation d'une application Android.

G√©n√©ralement, les solutions MDM effectuent des fonctions telles que l'application de politiques de mot de passe, le chiffrement forc√© du stockage et la possibilit√© d'effacer √† distance les donn√©es de l'appareil.

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menaces proactives, trouve des probl√®mes dans toute votre pile technologique, des API aux applications Web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous voulez voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
