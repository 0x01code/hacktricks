# Xamarin アプリ

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？**HackTricks で会社を宣伝**したいですか？または、**最新の PEASS のバージョンにアクセス**したり、**HackTricks を PDF でダウンロード**したいですか？[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを手に入れましょう。
* [**公式の PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手しましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord グループ**](https://discord.gg/hRep4RUj7f)や [**telegram グループ**](https://t.me/peass)に**参加するか**、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**にフォローしてください。**
* **ハッキングのコツを共有するために、** [**hacktricks リポジトリ**](https://github.com/carlospolop/hacktricks) と [**hacktricks-cloud リポジトリ**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出してください。**

</details>

## **基本情報**

Xamarin はオープンソースプラットフォームで、開発者が **.NET と C# フレームワークを使用して iOS、Android、Windows 向けのモダンなアプリを作成するための** ツールとアドオンの包括的な選択肢を提供します。

### Xamarin Android アーキテクチャ

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Xamarin は Android.\* と Java.\* の名前空間に .NET バインディングを提供します。Xamarin.

Android アプリケーションは Mono 実行環境の下で動作し、Android Runtime (ART) 仮想マシンが並行して実行されます。

Mono 実行環境はこれらの名前空間を Managed Callable Wrappers (MCW) を通じて呼び出し、ART に Android Callable Wrappers (ACW) を提供します。

これらの環境は Linux カーネルの上で実行され、ユーザーコードに様々な API を呼び出します。この配置により、開発者は基盤となるシステムにアクセスできます。

### Xamarin iOS プロジェクト

Xamarin.iOS アプリケーションは Mono 実行環境の下で動作し、C# .NET コードを ARM アセンブリ言語にコンパイルするために完全な Ahead of Time (AOT) コンパイルを使用します。

Objective-C Runtime と共に実行されます。実行環境は UNIX 風のカーネルの上で実行され、ユーザーコードにいくつかの API を呼び出し、開発者が管理されたシステムまたはネイティブシステムにアクセスできるようにします。

以下の図はこのアーキテクチャを示しています：

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### .Net Runtime と Mono フレームワークとは？

**.Net フレームワークは、開発者がアプリケーションを作成するために使用できるアセンブリ、クラス、および名前空間のセットです**。.Net Runtime はコンパイルされたコードを実行し、このプロセスは管理されたコード実行と呼ばれます。.NET Runtime は、プラットフォームの独立性を保証し、古いフレームワークバージョンとの互換性を持ついくつかの機能を提供します。

**Mono フレームワーク**は、2005年に Linux 向けの .NET フレームワークの実装として開始されました（Ximian/SuSe/Novell）。Microsoft の支援と Xamarin のリードの下で、Mono は ECMA 標準の Common Language Runtime と C# に基づいている .NET フレームワークのオープンソース実装です。

## Xamarin アプリのリバースエンジニアリング技術

### Xamarin アセンブリの逆コンパイル

逆コンパイルは、コンパイルされたコードからソースコードを生成するために使用されるプロセスです。現在メモリにあるアセンブリと実行可能ファイルに関する情報を取得するには、Windows が最適な場所です。

モジュールウィンドウを開くには、デバッグ > ウィンドウ > モジュールを選択します。逆コンパイルが必要なモジュールを検出したら、右クリックして「Decompile Source to Symbol File」を選択します。このアクションは、**ソースコードから直接サードパーティのコードに入ることを可能にする、逆コンパイルされたソースを含むシンボルファイルを作成します**。

**Visual Studio**は、シンボルがなくても管理されたコードを逆コンパイルし、コードを見たり、変数を検査したり、ブレークポイントを設定したりすることができます。ディスクにソースコードを抽出するには、埋め込まれたソースを持つモジュールを右クリックし、「Extract Embedded Source」をクリックします。これにより、ソースファイルがさらなる分析のために雑多なファイルフォルダにエクスポートされます。

### Xamarin アプリケーションの JIT と AOT コンパイル

これらは、C# ベースの Xamarin コードをアプリケーションにコンパイルするための二つのオプション、つまり **Just in time コンパイルと ahead of time コンパイルです**。コンパイルの方法は、アプリケーションコードが apk または ipa ファイル内でどのように配布されるかに影響します。以下で簡単に見てみましょう：

\- **Android**: Xamarin では、**android 用の JIT と AOT フラグの両方を使用してコンパイルすることができます**。実行速度を最大限に引き出すために、Hybrid AOT モードを使用する方法もあります。Full AOT モードはエンタープライズライセンスのみで利用可能です。

\- **iOS**: iOS の場合は、**ahead-of-time コンパイル**のみがオプションです。これは、デバイス上で動的に生成されたコードの実行を禁止する Apple のポリシーによるものです。

{% hint style="info" %}
Full AOT コンパイルされたアプリケーションに遭遇し、開発者がビルドサイズを削減するために IL アセンブリファイルを削除した場合、リバースには lib フォルダから .dll.so ファイルを抽出するか、`libmonodroid_bundle_app.so` ファイルから dll ファイルを抽出するという追加のステップが必要です。Hybrid AOT コンパイルされたアプリで、IL ファイルがアプリバンドルにまだ残っている場合、それを使用してアプリケーションをリバースエンジニアリングすることができます。
{% endhint %}

## APK/IPA から dll ファイルを取得する

単に apk/ipa ファイルを **解凍し**、assemblies ディレクトリの下にあるすべてのファイルをコピーします：

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Android **APK の場合、これらの dll ファイルは圧縮されているため**、直接逆コンパイルには使用できません。幸いなことに、[XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) や [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress) など、**これらの dll ファイルを解凍するために使用できるツールがあります**。
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Xamarin AssemblyStoreとは、Androidアプリケーション内でdllをパックするために現在推奨されている方法であり、dllファイルの代わりに`assemblies.blob`と`assemblies.manifest`がアセンブリディレクトリに存在することがあります。`assemblies.manifest`はバイナリファイル`assemblies.blob`の内容を記述したテキストファイルです。これらをアンパックするには[pyxamstore](https://github.com/jakev/pyxamstore)を使用する必要があります。
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
iOSの場合、**IPAファイル内のdllファイルは直接デコンパイラにロードできます**（何も解凍する必要はありません）。

**アプリケーションコードの大部分はdllファイルをデコンパイルすると見つかります。** また、Xamarin Frameworkベースのアプリは、iOSやAndroidなどのすべてのプラットフォームのビルドで共通コードが90%含まれていることに注意してください。

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

上記のスクリーンショットから、apkに存在していたdllファイルをリストしており、これがXamarinアプリであることを確認できます。これには、`Xamarin.Essentails.dll` や `Mono.Security.dll` など、アプリの実行に必要なライブラリファイルと共に、アプリ固有のdllファイルが含まれています。

{% hint style="success" %}
最終的に、[**これらの推奨ツール**](../reversing/reversing-tools-basic-methods/#net-decompiler)を使用して、DLLから**C#コード**にアクセスできます。
{% endhint %}

## 動的分析

アプリケーションにSSLピンニングがあるかどうかを確認してください。なければ、BurpをシステムCAとして使用してリクエストを傍受することができるはずです。**FridaはJavaやObjCランタイムでは機能しません**が、幸いなことに、メソッドにフックするために使用できるツールがあります。

[**Fridax**](https://github.com/NorthwaveSecurity/fridax)を使用すると、Xamarinアプリケーション内の.NETバイナリを**ランタイムで簡単に変更**できます。静的分析は、アプリケーション内の異なるメソッドを特定するのに役立ち、後でFridaxを使用して動的分析のためにフックできます。以下は、ルート検出のバイパスやSSLピンニングのバイパスに役立ついくつかのFridaスクリプトです：

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## 参考文献

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksにあなたの会社を広告したいですか？** または、**最新版のPEASSを入手**したり、**HackTricksをPDFでダウンロード**したいですか？ [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。これは私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**に**フォローしてください。
* **ハッキングのトリックを共有するために、** [**hacktricksリポジトリ**](https://github.com/carlospolop/hacktricks) と [**hacktricks-cloudリポジトリ**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。

</details>
