# Aplica√ß√µes Xamarin

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informa√ß√µes B√°sicas**

Xamarin √© uma plataforma de c√≥digo aberto que oferece aos desenvolvedores acesso a uma sele√ß√£o abrangente de ferramentas e complementos, permitindo-lhes **criar aplicativos modernos para iOS, Android e Windows usando os frameworks .NET e C#.**

### Arquitetura Xamarin Android

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Xamarin oferece vincula√ß√µes .NET para os namespaces Android.\* e Java.\*. Aplica√ß√µes Xamarin.

Android operam sob o ambiente de execu√ß√£o Mono, com a m√°quina virtual Android Runtime (ART) funcionando lado a lado.

O ambiente de execu√ß√£o Mono chama esses namespaces atrav√©s de Managed Callable Wrappers (MCW) e fornece Android Callable Wrappers (ACW) para a ART.

Ambos os ambientes funcionam em cima do kernel Linux e invocam v√°rias APIs para o c√≥digo do usu√°rio. O arranjo permite que os desenvolvedores acessem o sistema subjacente.

### Projeto Xamarin iOS

Aplica√ß√µes Xamarin.iOS rodam sob o ambiente de execu√ß√£o Mono e usam compila√ß√£o completa Ahead of Time (AOT) para compilar c√≥digos C# .NET para a linguagem de montagem ARM.

Funciona junto com o Objective-C Runtime. Os ambientes de execu√ß√£o funcionam em cima de um kernel semelhante ao UNIX e invocam v√°rias APIs para o c√≥digo do usu√°rio, o que permite que os desenvolvedores acessem o sistema gerenciado ou nativo subjacente.

O diagrama abaixo ilustra esta arquitetura:

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### O que √© .Net Runtime e Mono Framework?

**.Net framework √© um conjunto de assemblies, classes e namespaces** que os desenvolvedores podem usar para criar aplica√ß√µes; .Net Runtime executa o c√≥digo compilado, e o processo √© chamado de execu√ß√£o de c√≥digo gerenciado. .NET Runtime oferece v√°rias funcionalidades que garantem independ√™ncia de plataforma e s√£o compat√≠veis com vers√µes anteriores do framework.

**Mono Framework** foi iniciado em 2005 como uma implementa√ß√£o do .NET Framework para Linux (Ximian/SuSe/Novell). Patrocinado pela Microsoft e liderado pela Xamarin, Mono √© a implementa√ß√£o de c√≥digo aberto do framework .NET baseada nos padr√µes ECMA para Common Language Runtime e C#.

## T√©cnicas de Engenharia Reversa para Aplica√ß√µes Xamarin

### Decompila√ß√£o de Assemblies Xamarin

Decompila√ß√£o √© o processo usado para produzir c√≥digo-fonte a partir de c√≥digo compilado. Para obter informa√ß√µes sobre os assemblies e execut√°veis atualmente na mem√≥ria, Windows √© um √≥timo lugar.

Para abrir a janela de M√≥dulos, selecione Debug > Windows > Modules. Uma vez que voc√™ detecte o m√≥dulo que requer decompila√ß√£o, clique com o bot√£o direito e selecione "Decompile Source to Symbol File". Esta a√ß√£o **cria um arquivo de s√≠mbolos que cont√©m uma fonte decompilada que**, por sua vez, permite que voc√™ entre diretamente no c√≥digo de terceiros a partir do seu c√≥digo-fonte.

**Visual Studio** decompila o c√≥digo gerenciado, mesmo na aus√™ncia de s√≠mbolos, permitindo que voc√™ olhe para o c√≥digo, inspecione as vari√°veis e defina pontos de interrup√ß√£o. Para extrair o c√≥digo-fonte para o disco, clique com o bot√£o direito no m√≥dulo com fonte embutida e clique em "Extract Embedded Source ."Isso exportar√° os arquivos de fonte para uma pasta de Arquivos Diversos para an√°lise posterior.

### JIT vs AOT Compila√ß√£o de Aplica√ß√µes Xamarin

Estas s√£o duas op√ß√µes para compilar c√≥digo Xamarin baseado em C# em uma aplica√ß√£o, ou seja, **compila√ß√£o Just in time e compila√ß√£o ahead of time**. A forma de compila√ß√£o afeta como o c√≥digo da aplica√ß√£o √© enviado dentro do arquivo apk ou ipa. Vamos dar uma olhada r√°pida abaixo:

\- **Android**: Xamarin permite que voc√™ compile usando **ambas as flags JIT e AOT para android**. H√° tamb√©m uma maneira de ficar no meio termo para obter a maior velocidade de execu√ß√£o usando o modo Hybrid AOT. Note que o modo Full AOT est√° dispon√≠vel apenas para a licen√ßa Enterprise.

\- **iOS**: H√° apenas uma op√ß√£o no caso do iOS, **compila√ß√£o ahead-of-time**. Isso se deve √†s pol√≠ticas da Apple que pro√≠bem a execu√ß√£o de c√≥digo gerado dinamicamente em um dispositivo.

{% hint style="info" %}
Se voc√™ encontrar uma aplica√ß√£o compilada Full AOT, e se os arquivos IL Assembly forem removidos para reduzir o tamanho da compila√ß√£o pelo desenvolvedor, ent√£o a revers√£o requer um passo extra de extra√ß√£o de arquivos dll de arquivos .dll.so da pasta lib ou do arquivo `libmonodroid_bundle_app.so`. Se for uma aplica√ß√£o compilada Hybrid AOT, e os arquivos IL ainda estiverem no pacote da aplica√ß√£o, podemos usar isso para fazer engenharia reversa da aplica√ß√£o.
{% endhint %}

## Obtendo os arquivos dll do APK/IPA

Apenas **descompacte o arquivo apk/ipa** e copie todos os arquivos presentes no diret√≥rio assemblies:

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

No caso dos **APKs Android, esses arquivos dll s√£o comprimidos** e n√£o podem ser usados diretamente para decompila√ß√£o. Felizmente, existem ferramentas que podemos usar para **descomprimir esses arquivos dll** como [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) e [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress).
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
√â poss√≠vel que, em vez de arquivos dll, voc√™ veja `assemblies.blob` e `assemblies.manifest` no diret√≥rio de assemblies. Isso √© um Xamarin AssemblyStore e a maneira atualmente recomendada de empacotar dlls em uma aplica√ß√£o Android. O `assemblies.manifest` √© um arquivo de texto que descreve o conte√∫do do arquivo bin√°rio `assemblies.blob`. Para descompactar esses arquivos, ser√° necess√°rio usar [pyxamstore](https://github.com/jakev/pyxamstore).
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
No caso do iOS, **arquivos dll dentro dos arquivos IPA podem ser carregados diretamente** em um descompilador (n√£o √© necess√°rio descomprimir nada).

**A maior parte do c√≥digo da aplica√ß√£o pode ser encontrada quando descompilamos os arquivos dll.** Note tamb√©m que aplicativos baseados no Xamarin Framework cont√™m 90% de c√≥digo comum nas compila√ß√µes de todas as plataformas, como iOS e Android etc.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

A partir da captura de tela acima, listando os arquivos dll que estavam presentes no apk, podemos confirmar que √© um aplicativo Xamarin. Ele cont√©m arquivos dll espec√≠ficos do aplicativo, juntamente com os arquivos de biblioteca necess√°rios para a execu√ß√£o do aplicativo, como `Xamarin.Essentails.dll` ou `Mono.Security.dll`.

{% hint style="success" %}
Finalmente, voc√™ pode usar [**estas ferramentas recomendadas**](../reversing/reversing-tools-basic-methods/#net-decompiler) para acessar o **c√≥digo C#** dos DLLs.
{% endhint %}

## An√°lise Din√¢mica

Tente verificar se o aplicativo possui algum tipo de SSL pinning implementado. Se n√£o, usar o Burp como um CA do sistema deve funcionar para interceptar solicita√ß√µes. **Frida com runtime Java ou ObjC n√£o funcionar√°** aqui, mas, felizmente, h√° uma ferramenta que pode ser usada para se conectar a m√©todos.

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) permite que voc√™ **modifique o bin√°rio .NET dentro de um aplicativo Xamarin em tempo de execu√ß√£o**. A an√°lise est√°tica ajudar√° voc√™ a identificar diferentes m√©todos presentes dentro do aplicativo, que podem ser conectados posteriormente para an√°lise din√¢mica usando Fridax. Abaixo est√£o alguns scripts do Frida que podem nos ajudar a contornar a detec√ß√£o de root ou SSL-pinning:

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## Refer√™ncias

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
