# Xamarin アプリ

<details>

<summary><strong>AWS ハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に **参加する** か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** の [**GitHub リポジトリ**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを共有する。

</details>

## **基本情報**

Xamarin はオープンソースのプラットフォームで、開発者が **.NET と C# フレームワークを使用して iOS、Android、Windows 向けのモダンなアプリを作成するための** 広範なツールとアドオンへのアクセスを提供します。

### Xamarin Android アーキテクチャ

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Xamarin は Android.\* と Java.\* の名前空間に .NET バインディングを提供します。Xamarin.

Android アプリケーションは Mono 実行環境の下で動作し、Android Runtime (ART) 仮想マシンが並行して実行されます。

Mono 実行環境はこれらの名前空間を Managed Callable Wrappers (MCW) を介して呼び出し、ART に Android Callable Wrappers (ACW) を提供します。

これらの環境は Linux カーネルの上で実行され、ユーザーコードに様々な API を呼び出します。この配置により、開発者は基盤となるシステムにアクセスできます。

### Xamarin iOS プロジェクト

Xamarin.iOS アプリケーションは Mono 実行環境の下で実行され、C# .NET コードを ARM アセンブリ言語にコンパイルするために完全な Ahead of Time (AOT) コンパイルを使用します。

それは Objective-C Runtime と共に実行されます。ランタイム環境は UNIX 風のカーネルの上で実行され、ユーザーコードにいくつかの API を呼び出し、開発者が管理されたシステムまたはネイティブシステムにアクセスできるようにします。

以下の図はこのアーキテクチャを示しています：

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### .Net Runtime と Mono フレームワークとは何か？

**.Net フレームワークは、開発者がアプリケーションを作成するために使用できるアセンブリ、クラス、および名前空間のセットです**。.Net Runtime はコンパイルされたコードを実行し、このプロセスは管理されたコード実行と呼ばれます。.NET Runtime は、プラットフォームの独立性を保証し、古いフレームワークバージョンとの互換性を持ついくつかの機能を提供します。

**Mono フレームワーク** は、2005年に Linux 向けの .NET フレームワークの実装として開始されました（Ximian/SuSe/Novell）。Microsoft の支援と Xamarin のリードの下で、Mono は Common Language Runtime と C# に関する ECMA 標準に基づいた .NET フレームワークのオープンソース実装です。

## Xamarin アプリのリバースエンジニアリング技術

### Xamarin アセンブリの逆コンパイル

逆コンパイルは、コンパイルされたコードからソースコードを生成するために使用されるプロセスです。現在メモリにあるアセンブリと実行可能ファイルに関する情報を取得するには、Windows が最適な場所です。

モジュールウィンドウを開くには、デバッグ > ウィンドウ > モジュールを選択します。逆コンパイルが必要なモジュールを検出したら、右クリックして「逆コンパイルソースをシンボルファイルに」を選択します。このアクションは、**逆コンパイルされたソースを含むシンボルファイルを作成し**、それによってソースコードから直接サードパーティのコードに入ることができます。

**Visual Studio** は、シンボルがなくても管理されたコードを逆コンパイルし、コードを見たり、変数を検査したり、ブレークポイントを設定したりすることができます。ディスクにソースコードを抽出するには、埋め込まれたソースを持つモジュールを右クリックし、「埋め込まれたソースを抽出する」をクリックします。これにより、ソースファイルがその他のファイルフォルダにエクスポートされ、さらなる分析が可能になります。

### Xamarin アプリケーションの JIT 対 AOT コンパイル

これらは、C# ベースの Xamarin コードをアプリケーションにコンパイルするための二つのオプションです。つまり、**Just in time コンパイルと ahead of time コンパイル**です。コンパイルの方法は、アプリケーションコードが apk または ipa ファイル内でどのように出荷されるかに影響します。以下でそれを簡単に見てみましょう：

\- **Android**: Xamarin では、**android 用の JIT と AOT フラグの両方を使用してコンパイルすることができます**。実行速度を最大限に高めるために、Hybrid AOT モードを使用する方法もあります。Full AOT モードはエンタープライズライセンスでのみ利用可能です。

\- **iOS**: iOS の場合は、**ahead-of-time コンパイル**のみがオプションです。これは、デバイス上で動的に生成されたコードの実行を禁止する Apple のポリシーによるものです。

{% hint style="info" %}
Full AOT コンパイルされたアプリケーションに遭遇し、開発者がビルドサイズを削減するために IL アセンブリファイルを削除した場合、リバースには lib フォルダから .dll.so ファイルを抽出するか、`libmonodroid_bundle_app.so` ファイルから dll ファイルを抽出するという追加のステップが必要です。Hybrid AOT コンパイルされたアプリで、IL ファイルがアプリバンドルにまだ残っている場合、それを使用してアプリケーションをリバースエンジニアリングすることができます。
{% endhint %}

## APK/IPA から dll ファイルを取得する

単に apk/ipa ファイルを **解凍し**、assemblies ディレクトリの下にあるすべてのファイルをコピーします：

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Android **APK の場合、これらの dll ファイルは圧縮されている**ため、直接逆コンパイルには使用できません。幸いなことに、[XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) や [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress) など、これらの dll ファイルを **解凍するために使用できるツールがあります**。
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Xamarin AssemblyStoreとは、Androidアプリケーション内でdllをパックする現在推奨されている方法であり、dllファイルの代わりに`assemblies.blob`と`assemblies.manifest`がアセンブリディレクトリに存在することがあります。`assemblies.manifest`はバイナリファイル`assemblies.blob`の内容を記述したテキストファイルです。これらをアンパックするには[pyxamstore](https://github.com/jakev/pyxamstore)を使用する必要があります。
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
iOSの場合、**IPAファイル内のdllファイルは、何も解凍する必要なく直接デコンパイラにロードできます**。

**アプリケーションコードの大部分はdllファイルをデコンパイルすると見つかります。** また、Xamarin Frameworkベースのアプリは、iOSやAndroidなどのすべてのプラットフォームのビルドで共通コードが90%含まれていることに注意してください。

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

上のスクリーンショットから、apkに存在していたdllファイルをリストして、それがXamarinアプリであることを確認できます。アプリ固有のdllファイルと、`Xamarin.Essentails.dll` や `Mono.Security.dll` など、アプリの実行に必要なライブラリファイルが含まれています。

{% hint style="success" %}
最終的に、これらの推奨ツールを使用して、DLLから **C# コード** にアクセスできます。
{% endhint %}

## 動的分析

アプリケーションにSSLピンニングがあるかどうかを確認してください。なければ、BurpをシステムCAとして使用してリクエストを傍受することができるはずです。**FridaはJavaまたはObjCランタイムでは機能しません**が、幸いなことに、メソッドにフックするために使用できるツールがあります。

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) を使用すると、Xamarinアプリケーション内の .NETバイナリを実行時に簡単に **変更できます**。静的分析は、アプリケーション内の異なるメソッドを特定するのに役立ち、後でFridaxを使用して動的分析のためにフックできます。以下は、ルート検出をバイパスしたり、SSLピンニングをバイパスするのに役立ついくつかのFridaスクリプトです：

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## 参考文献

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには、</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTコレクション**](https://opensea.io/collection/the-peass-family)です。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
