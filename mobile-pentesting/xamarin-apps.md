# Aplicativos Xamarin

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informa√ß√µes b√°sicas**

Xamarin √© uma plataforma de c√≥digo aberto que oferece aos desenvolvedores acesso a uma ampla sele√ß√£o de ferramentas e complementos, permitindo-lhes **criar aplicativos modernos para iOS, Android e Windows usando .NET e C#**.

### Arquitetura do Xamarin Android

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

O Xamarin oferece liga√ß√µes .NET para os namespaces Android.\* e Java.\*. As aplica√ß√µes Xamarin Android operam sob o ambiente de execu√ß√£o Mono, com a m√°quina virtual Android Runtime (ART) em execu√ß√£o lado a lado.

O ambiente de execu√ß√£o Mono chama esses namespaces por meio de Inv√≥lucros Cham√°veis Gerenciados (MCW) e fornece Inv√≥lucros Cham√°veis Android (ACW) para o ART.

Ambos esses ambientes s√£o executados em cima do kernel Linux e invocam v√°rias APIs para o c√≥digo do usu√°rio. Essa estrutura permite que os desenvolvedores acessem o sistema subjacente.

### Projeto Xamarin iOS

As aplica√ß√µes Xamarin.iOS s√£o executadas sob o ambiente de execu√ß√£o Mono e usam a compila√ß√£o completa Ahead of Time (AOT) para compilar c√≥digos C# .NET para a linguagem de montagem ARM.

Ele √© executado junto com o Objective-C Runtime. Os ambientes de execu√ß√£o s√£o executados em cima de um kernel semelhante ao UNIX e invocam v√°rias APIs para o c√≥digo do usu√°rio, o que permite que os desenvolvedores acessem o sistema gerenciado ou nativo subjacente.

O diagrama abaixo representa essa arquitetura:

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### O que √© .Net Runtime e Mono Framework?

**.Net framework √© um conjunto de assemblies, classes e namespaces** que os desenvolvedores podem usar para criar aplicativos; o .Net Runtime executa o c√≥digo compilado, e o processo √© chamado de execu√ß√£o de c√≥digo gerenciado. O .NET Runtime oferece v√°rias funcionalidades que garantem a independ√™ncia de plataforma e s√£o compat√≠veis com vers√µes mais antigas do framework.

**Mono Framework** foi iniciado em 2005 como uma implementa√ß√£o do .NET Framework para Linux (Ximian/SuSe/Novell). Patrocinado pela Microsoft e liderado pela Xamarin, o Mono √© a implementa√ß√£o de c√≥digo aberto do framework .NET com base nos padr√µes ECMA para Common Language Runtime e C#.

## T√©cnicas de Engenharia Reversa para Aplicativos Xamarin

### Descompila√ß√£o de Assemblies Xamarin

A descompila√ß√£o √© o processo usado para produzir c√≥digo-fonte a partir de c√≥digo compilado. Para obter informa√ß√µes sobre os assemblies e execut√°veis atualmente na mem√≥ria, o Windows √© um √≥timo lugar.

Para abrir a janela M√≥dulos, selecione Depurar > Janelas > M√≥dulos. Assim que voc√™ detectar o m√≥dulo que requer descompila√ß√£o, clique com o bot√£o direito e selecione "Decompile Source to Symbol File". Essa a√ß√£o **cria um arquivo de s√≠mbolo que cont√©m um c√≥digo-fonte descompilado que**, por sua vez, permite que voc√™ entre no c√≥digo de terceiros diretamente do seu c√≥digo-fonte.

O **Visual Studio** descompila o c√≥digo gerenciado, mesmo na aus√™ncia de s√≠mbolos, permitindo que voc√™ visualize o c√≥digo, inspecione as vari√°veis e defina pontos de interrup√ß√£o. Para extrair o c√≥digo-fonte para o disco, clique com o bot√£o direito no m√≥dulo com o c√≥digo-fonte incorporado e clique em "Extract Embedded Source". Isso exportar√° os arquivos de origem para uma pasta de arquivos diversos para an√°lise posterior.

### Compila√ß√£o JIT vs AOT de Aplicativos Xamarin

Existem duas op√ß√µes para compilar c√≥digo Xamarin baseado em C# em um aplicativo, ou seja, **compila√ß√£o just-in-time e compila√ß√£o ahead-of-time**. A forma de compila√ß√£o afeta como o c√≥digo do aplicativo √© enviado dentro do arquivo apk ou ipa. Vamos dar uma olhada r√°pida nisso abaixo:

\- **Android**: O Xamarin permite que voc√™ compile usando **as op√ß√µes JIT e AOT para Android**. Tamb√©m h√° uma maneira de obter a maior velocidade de execu√ß√£o usando o modo h√≠brido AOT. Observe que o modo AOT completo est√° dispon√≠vel apenas para a licen√ßa Enterprise.

\- **iOS**: Existe apenas uma op√ß√£o no caso do iOS, **compila√ß√£o ahead-of-time**. Isso ocorre devido √†s pol√≠ticas da Apple, que pro√≠bem a execu√ß√£o de c√≥digo gerado dinamicamente em um dispositivo.

{% hint style="info" %}
Se voc√™ encontrar um aplicativo compilado com AOT completo e se os arquivos de assembly IL forem removidos para reduzir o tamanho da compila√ß√£o pelo desenvolvedor, a revers√£o exigir√° uma etapa adicional de extra√ß√£o dos arquivos dll dos arquivos .dll.so da pasta lib ou do arquivo `libmonodroid_bundle_app.so`. Se for um aplicativo compilado com AOT h√≠brido e os arquivos IL ainda estiverem presentes no pacote do aplicativo, podemos us√°-los para engenharia reversa do aplicativo.
{% endhint %}
## Obtendo os arquivos dll do APK/IPA

Basta **descompactar o arquivo apk/ipa** e copiar todos os arquivos presentes no diret√≥rio assemblies:

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

No caso dos APKs do Android, **esses arquivos dll est√£o comprimidos** e n√£o podem ser diretamente usados para descompila√ß√£o. Felizmente, existem ferramentas dispon√≠veis que podemos usar para **descomprimir esses arquivos dll** como [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) e [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress).
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
√â poss√≠vel que, em vez de arquivos DLL, voc√™ veja `assemblies.blob` e `assemblies.manifest` no diret√≥rio de assemblies. Isso √© um Xamarin AssemblyStore e a forma atualmente recomendada de empacotar DLLs em um aplicativo Android. O `assemblies.manifest` √© um arquivo de texto que descreve o conte√∫do do arquivo bin√°rio `assemblies.blob`. Para desempacot√°-los, voc√™ precisar√° usar o [pyxamstore](https://github.com/jakev/pyxamstore).
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
No caso do iOS, **os arquivos DLL dentro dos arquivos IPA podem ser carregados diretamente** em um descompilador (n√£o √© necess√°rio descompactar nada).

**A maioria do c√≥digo do aplicativo pode ser encontrado ao descompilar os arquivos DLL**. Al√©m disso, observe que os aplicativos baseados no Xamarin Framework cont√™m 90% do c√≥digo comum nas compila√ß√µes de todas as plataformas, como iOS e Android, etc.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

A partir da captura de tela acima, listando os arquivos DLL que estavam presentes no APK, podemos confirmar que √© um aplicativo Xamarin. Ele cont√©m arquivos DLL espec√≠ficos do aplicativo, juntamente com os arquivos de biblioteca necess√°rios para a execu√ß√£o do aplicativo, como `Xamarin.Essentails.dll` ou `Mono.Security.dll`.

{% hint style="success" %}
Finalmente, voc√™ pode usar [**essas ferramentas recomendadas**](../reversing/reversing-tools-basic-methods/#net-decompiler) para acessar o **c√≥digo C#** dos DLLs.
{% endhint %}

## An√°lise Din√¢mica

Tente verificar se o aplicativo possui algum tipo de SSL pinning. Se n√£o tiver, usando o Burp como um sistema, o CA deve funcionar para interceptar as solicita√ß√µes. **O Frida com tempo de execu√ß√£o Java ou ObjC n√£o funcionar√°** aqui, mas felizmente existe uma ferramenta que pode ser usada para fazer hook em m√©todos.

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) permite que voc√™ **modifique o bin√°rio .NET dentro de um aplicativo Xamarin em tempo de execu√ß√£o**. A an√°lise est√°tica ajudar√° a identificar diferentes m√©todos presentes no aplicativo, que podem ser conectados posteriormente para an√°lise din√¢mica usando o Fridax. Abaixo est√£o alguns scripts do Frida que podem nos ajudar a contornar a detec√ß√£o de root ou SSL pinning:

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## Refer√™ncias

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
