# Aplicaciones Xamarin

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informaci√≥n b√°sica**

Xamarin es una plataforma de c√≥digo abierto que brinda a los desarrolladores acceso a una amplia selecci√≥n de herramientas y complementos, lo que les permite **crear aplicaciones modernas para iOS, Android y Windows utilizando los marcos .NET y C#**.

### Arquitectura de Xamarin Android&#x20;

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Xamarin ofrece enlaces .NET a los espacios de nombres Android.\* y Java.\*. Las aplicaciones de Xamarin Android funcionan bajo el entorno de ejecuci√≥n Mono, con la m√°quina virtual Android Runtime (ART) ejecut√°ndose junto a √©l.

El entorno de ejecuci√≥n Mono llama a estos espacios de nombres a trav√©s de los Envoltorios Llamables Administrados (MCW) y proporciona Envoltorios Llamables de Android (ACW) al ART.

Ambos entornos se ejecutan sobre el kernel de Linux e invocan varias API para el c√≥digo de usuario. Esta disposici√≥n permite a los desarrolladores acceder al sistema subyacente.

### Proyecto Xamarin iOS

Las aplicaciones de Xamarin.iOS se ejecutan bajo el entorno de ejecuci√≥n Mono y utilizan la compilaci√≥n completa de Ahead of Time (AOT) para compilar los c√≥digos .NET de C# a lenguaje ensamblador ARM.

Se ejecuta junto con el tiempo de ejecuci√≥n Objective-C. Los entornos de tiempo de ejecuci√≥n se ejecutan sobre un kernel similar a UNIX e invocan varias API para el c√≥digo de usuario, lo que permite a los desarrolladores acceder al sistema administrado o nativo subyacente.&#x20;

El diagrama que se muestra a continuaci√≥n representa esta arquitectura:

<figure><img src="../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ¬øQu√© es .Net Runtime y Mono Framework?

**.Net framework es un conjunto de ensamblados, clases y espacios de nombres** que los desarrolladores pueden utilizar para crear aplicaciones; .Net Runtime ejecuta el c√≥digo compilado, y el proceso se llama ejecuci√≥n de c√≥digo administrado. .NET Runtime proporciona varias caracter√≠sticas que garantizan la independencia de la plataforma y son compatibles con versiones anteriores del framework.

**Mono Framework** se inici√≥ en 2005 como una implementaci√≥n del .NET Framework para Linux (Ximian/SuSe/Novell). Patrocinado por Microsoft y liderado por Xamarin, Mono es la implementaci√≥n de c√≥digo abierto del framework .NET basada en los est√°ndares ECMA para Common Language Runtime y C#.&#x20;



## T√©cnicas de ingenier√≠a inversa para aplicaciones Xamarin

### Descompilaci√≥n de ensamblados Xamarin

La descompilaci√≥n es el proceso utilizado para producir c√≥digo fuente a partir de c√≥digo compilado. Para obtener informaci√≥n sobre los ensamblados y ejecutables que se encuentran actualmente en memoria, Windows es un buen lugar.

Para abrir la ventana M√≥dulos, selecciona Depurar > Ventanas > M√≥dulos. Una vez que detectes el m√≥dulo que requiere descompilaci√≥n, haz clic derecho y selecciona "Descompilar fuente a archivo de s√≠mbolos". Esta acci√≥n **genera un archivo de s√≠mbolos que contiene un c√≥digo fuente descompilado que**, a su vez, te permite ingresar al c√≥digo de terceros directamente desde tu c√≥digo fuente.

**Visual Studio** descompila el c√≥digo administrado, incluso en ausencia de s√≠mbolos, lo que te permite ver el c√≥digo, inspeccionar las variables y establecer puntos de interrupci√≥n. Para extraer el c√≥digo fuente al disco, haz clic derecho en el m√≥dulo con el origen incrustado y haz clic en "Extraer origen incrustado". Esto exportar√° los archivos fuente a una carpeta de archivos varios para su posterior an√°lisis.

### Compilaci√≥n JIT vs AOT de aplicaciones Xamarin

Estas dos opciones para compilar c√≥digo Xamarin basado en C# en una aplicaci√≥n, es decir, **compilaci√≥n Just in Time y compilaci√≥n Ahead of Time**. La forma de compilaci√≥n afecta c√≥mo se env√≠a el c√≥digo de la aplicaci√≥n dentro del archivo apk o ipa. Echemos un vistazo r√°pido a continuaci√≥n:

\- **Android**: Xamarin te permite compilar utilizando **tanto las banderas JIT como las banderas AOT para Android**. Tambi√©n hay una forma de ir entre ambos para obtener la mayor velocidad de ejecuci√≥n utilizando el modo h√≠brido AOT. Ten en cuenta que el modo AOT completo solo est√° disponible para la licencia Enterprise.

\- **iOS**: Solo hay una opci√≥n en el caso de iOS, **compilaci√≥n ahead-of-time**. Esto se debe a las pol√≠ticas de Apple que proh√≠ben la ejecuci√≥n de c√≥digo generado din√°micamente en un dispositivo.

{% hint style="info" %}
Si te encuentras con una aplicaci√≥n compilada con AOT completo y si los archivos de ensamblado IL se eliminan para reducir el tama√±o de compilaci√≥n por parte del desarrollador, entonces el proceso de reversi√≥n requiere un paso adicional de extraer archivos dll de los archivos .dll.so de la carpeta lib o del archivo `libmonodroid_bundle_app.so`. Si es una aplicaci√≥n compilada con AOT h√≠brido y los archivos IL a√∫n se mantienen en el paquete de la aplicaci√≥n, podemos utilizar eso para ingenier√≠a inversa de la aplicaci√≥n.
{% endhint %}
## Obtenci√≥n de los archivos dll desde el APK/IPA

Simplemente **descomprime el archivo apk/ipa** y copia todos los archivos presentes en el directorio de ensamblados:

<figure><img src="../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

En el caso de los APK de Android, **estos archivos dll est√°n comprimidos** y no se pueden utilizar directamente para la descompilaci√≥n. Afortunadamente, existen herramientas que podemos utilizar para **descomprimir estos archivos dll** como [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) y [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress).
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
En el caso de iOS, **los archivos DLL dentro de los archivos IPA se pueden cargar directamente** en un descompilador (no es necesario descomprimir nada).

**La mayor√≠a del c√≥digo de la aplicaci√≥n se puede encontrar al descompilar los archivos DLL**. Tambi√©n hay que tener en cuenta que las aplicaciones basadas en el marco de trabajo Xamarin contienen un 90% de c√≥digo com√∫n en las compilaciones de todas las plataformas como iOS y Android, etc.&#x20;

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

A partir de la captura de pantalla anterior que muestra la lista de archivos DLL presentes en el APK, podemos confirmar que se trata de una aplicaci√≥n Xamarin. Contiene archivos DLL espec√≠ficos de la aplicaci√≥n junto con los archivos de biblioteca necesarios para que la aplicaci√≥n se ejecute, como `Xamarin.Essentails.dll` o `Mono.Security.dll`.

{% hint style="success" %}
Finalmente, puedes utilizar [**estas herramientas recomendadas**](../reversing/reversing-tools-basic-methods/#net-decompiler) para acceder al **c√≥digo C#** de los DLL.
{% endhint %}

## An√°lisis Din√°mico

Intenta verificar si la aplicaci√≥n tiene alg√∫n tipo de SSL pinning implementado. Si no es as√≠, utilizando Burp como un sistema, CA deber√≠a funcionar para interceptar las solicitudes. **Frida con tiempo de ejecuci√≥n de Java u ObjC no funcionar√°** aqu√≠, pero afortunadamente hay una herramienta disponible que se puede utilizar para engancharse a los m√©todos.

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) te permite **modificar f√°cilmente el binario .NET dentro de una aplicaci√≥n Xamarin en tiempo de ejecuci√≥n**. El an√°lisis est√°tico te ayudar√° a identificar los diferentes m√©todos presentes en la aplicaci√≥n, que luego se pueden enganchar para el an√°lisis din√°mico utilizando Fridax. A continuaci√≥n se muestran algunos scripts de Frida que pueden ayudarnos a eludir la detecci√≥n de root o SSL pinning:

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## Referencias

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
