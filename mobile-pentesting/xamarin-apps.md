# Applications Xamarin

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informations de base**

Xamarin est une plateforme open-source qui donne aux d√©veloppeurs acc√®s √† une s√©lection compl√®te d'outils et d'add-ons, leur permettant de **cr√©er des applications modernes pour iOS, Android et Windows en utilisant les frameworks .NET et C#**.

### Architecture Xamarin Android

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Xamarin offre des liaisons .NET vers les espaces de noms Android.\* et Java.\*. Les applications Xamarin Android fonctionnent sous l'environnement d'ex√©cution Mono, avec la machine virtuelle Android Runtime (ART) qui s'ex√©cute c√¥te √† c√¥te.

L'environnement d'ex√©cution Mono appelle ces espaces de noms via des wrappers d'appel manag√©s (MCW) et fournit des wrappers d'appel Android (ACW) √† l'ART.

Ces deux environnements s'ex√©cutent sur le noyau Linux et invoquent diverses API vers le code utilisateur. Cette configuration permet aux d√©veloppeurs d'acc√©der au syst√®me sous-jacent.

### Projet Xamarin iOS

Les applications Xamarin.iOS s'ex√©cutent sous l'environnement d'ex√©cution Mono et utilisent une compilation compl√®te en temps r√©el (AOT) pour compiler les codes C# .NET en langage d'assemblage ARM.

Il s'ex√©cute avec le runtime Objective-C. Les environnements d'ex√©cution s'ex√©cutent sur un noyau de type UNIX et invoquent plusieurs API vers le code utilisateur, ce qui permet aux d√©veloppeurs d'acc√©der au syst√®me g√©r√© ou natif sous-jacent.

Le diagramme ci-dessous illustre cette architecture :

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Qu'est-ce que le .Net Runtime et le Mono Framework ?

**Le framework .Net est un ensemble d'assemblages, de classes et d'espaces de noms** que les d√©veloppeurs peuvent utiliser pour cr√©er des applications ; le .Net Runtime ex√©cute le code compil√©, et le processus s'appelle l'ex√©cution de code g√©r√©. Le .NET Runtime offre plusieurs fonctionnalit√©s qui garantissent l'ind√©pendance de la plateforme et sont compatibles avec les anciennes versions du framework.

**Le framework Mono** a √©t√© lanc√© en 2005 en tant qu'impl√©mentation du framework .NET pour Linux (Ximian/SuSe/Novell). Sponsoris√© par Microsoft et dirig√© par Xamarin, Mono est l'impl√©mentation open-source du framework .NET bas√©e sur les normes ECMA pour Common Language Runtime et C#.

## Techniques de r√©tro-ing√©nierie pour les applications Xamarin

### D√©compilation des assemblages Xamarin

La d√©compilation est le processus utilis√© pour produire du code source √† partir de code compil√©. Pour obtenir des informations sur les assemblages et les ex√©cutables actuellement en m√©moire, Windows est un excellent endroit.

Pour ouvrir la fen√™tre Modules, s√©lectionnez D√©boguer > Fen√™tres > Modules. Une fois que vous avez d√©tect√© le module qui n√©cessite une d√©compilation, faites un clic droit et s√©lectionnez "D√©compiler la source vers un fichier de symboles". Cette action **cr√©e un fichier de symboles contenant une source d√©compil√©e qui**, √† son tour, vous permet d'acc√©der directement au code tiers √† partir de votre code source.

**Visual Studio** d√©compile le code manag√©, m√™me en l'absence de symboles, ce qui vous permet de consulter le code, d'inspecter les variables et de d√©finir des points d'arr√™t. Pour extraire le code source sur le disque, faites un clic droit sur le module avec la source int√©gr√©e et cliquez sur "Extraire la source int√©gr√©e". Cela exportera les fichiers source dans un dossier de fichiers divers pour une analyse ult√©rieure.

### Compilation JIT vs AOT des applications Xamarin

Ces deux options permettent de compiler le code Xamarin bas√© sur C# en une application, c'est-√†-dire **la compilation juste √† temps et la compilation en avance**. La m√©thode de compilation affecte la fa√ßon dont le code de l'application est distribu√© dans le fichier apk ou ipa. Jetons-y rapidement un coup d'≈ìil ci-dessous :

\- **Android** : Xamarin vous permet de compiler en utilisant **les indicateurs JIT et AOT pour Android**. Il existe √©galement un moyen d'obtenir le maximum de vitesse d'ex√©cution en utilisant le mode hybride AOT. Notez que le mode AOT complet est disponible uniquement pour la licence Enterprise.

\- **iOS** : Il n'y a qu'une seule option dans le cas d'iOS, **la compilation en avance**. Cela est d√ª aux politiques d'Apple qui interdisent l'ex√©cution de code g√©n√©r√© dynamiquement sur un appareil.

{% hint style="info" %}
Si vous rencontrez une application compil√©e en AOT complet, et si les fichiers d'assembly IL sont supprim√©s pour r√©duire la taille de la construction par le d√©veloppeur, la r√©tro-ing√©nierie n√©cessite une √©tape suppl√©mentaire d'extraction des fichiers dll √† partir des fichiers .dll.so du dossier lib ou du fichier `libmonodroid_bundle_app.so`. S'il s'agit d'une application compil√©e en AOT hybride, et que les fichiers IL sont toujours conserv√©s dans le bundle de l'application, nous pouvons les utiliser pour r√©tro-ing√©nier l'application.
{% endhint %}
## Obtenir les fichiers dll √† partir de l'APK/IPA

Il suffit de **d√©compresser le fichier apk/ipa** et de copier tous les fichiers pr√©sents dans le r√©pertoire assemblies :

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Dans le cas des **APK Android, ces fichiers dll sont compress√©s** et ne peuvent pas √™tre directement utilis√©s pour la d√©compilation. Heureusement, il existe des outils que nous pouvons utiliser pour **d√©compresser ces fichiers dll** comme [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) et [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress).
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Il est possible que, au lieu de fichiers dll, vous trouviez des fichiers `assemblies.blob` et `assemblies.manifest` dans le r√©pertoire des assemblies. Il s'agit d'un AssemblyStore Xamarin et de la m√©thode actuellement recommand√©e pour empaqueter des dll dans une application Android. Le fichier `assemblies.manifest` est un fichier texte d√©crivant le contenu du fichier binaire `assemblies.blob`. Pour les d√©compresser, vous devrez utiliser [pyxamstore](https://github.com/jakev/pyxamstore).
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
Dans le cas d'iOS, les fichiers DLL √† l'int√©rieur des fichiers IPA peuvent √™tre directement charg√©s dans un d√©compilateur (pas besoin de d√©compresser quoi que ce soit).

La plupart du code de l'application peut √™tre trouv√© lorsque nous d√©compilons les fichiers DLL. Notez √©galement que les applications bas√©es sur le framework Xamarin contiennent 90% de code commun dans les versions de toutes les plateformes telles que iOS et Android, etc.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

√Ä partir de la capture d'√©cran ci-dessus de la liste des fichiers DLL pr√©sents dans l'APK, nous pouvons confirmer qu'il s'agit d'une application Xamarin. Elle contient des fichiers DLL sp√©cifiques √† l'application ainsi que des fichiers de biblioth√®que n√©cessaires au fonctionnement de l'application, tels que `Xamarin.Essentails.dll` ou `Mono.Security.dll`.

{% hint style="success" %}
Enfin, vous pouvez utiliser [**ces outils recommand√©s**](../reversing/reversing-tools-basic-methods/#net-decompiler) pour acc√©der au **code C#** des DLL.
{% endhint %}

## Analyse dynamique

Essayez de v√©rifier si l'application a mis en place un quelconque SSL pinning. Si ce n'est pas le cas, en utilisant Burp en tant que syst√®me, CA devrait fonctionner pour intercepter les requ√™tes. **Frida avec Java ou ObjC runtime ne fonctionnera pas** ici, mais heureusement, il existe un outil qui peut √™tre utilis√© pour se connecter aux m√©thodes.

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) vous permet de **modifier facilement le binaire .NET √† l'int√©rieur d'une application Xamarin en temps d'ex√©cution**. L'analyse statique vous aidera √† identifier les diff√©rentes m√©thodes pr√©sentes dans l'application, qui peuvent √™tre accroch√©es ult√©rieurement pour une analyse dynamique √† l'aide de Fridax. Voici quelques scripts Frida qui peuvent nous aider √† contourner la d√©tection de root ou le SSL pinning :

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## R√©f√©rences

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous voulez voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
