# Aplicaciones Xamarin

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver a tu **empresa anunciada en HackTricks**? o ¬øquieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informaci√≥n B√°sica**

Xamarin es una plataforma de c√≥digo abierto que proporciona a los desarrolladores acceso a una amplia selecci√≥n de herramientas y complementos, permiti√©ndoles **crear aplicaciones modernas para iOS, Android y Windows utilizando los frameworks .NET y C#**.

### Arquitectura de Xamarin Android

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Xamarin ofrece enlaces .NET a los espacios de nombres Android.\* y Java.\*. Xamarin.

Las aplicaciones Android funcionan bajo el entorno de ejecuci√≥n Mono, con la m√°quina virtual Android Runtime (ART) ejecut√°ndose al lado.

El entorno de ejecuci√≥n Mono llama a estos espacios de nombres a trav√©s de Managed Callable Wrappers (MCW) y proporciona Android Callable Wrappers (ACW) al ART.

Ambos entornos se ejecutan sobre el kernel de Linux e invocan varias APIs al c√≥digo del usuario. La disposici√≥n permite a los desarrolladores acceder al sistema subyacente.

### Proyecto Xamarin iOS

Las aplicaciones Xamarin.iOS se ejecutan bajo el entorno de ejecuci√≥n Mono y utilizan la compilaci√≥n completa Ahead of Time (AOT) para compilar c√≥digos C# .NET a lenguaje ensamblador ARM.

Se ejecuta junto con el Runtime de Objective-C. Los entornos de ejecuci√≥n se ejecutan sobre un kernel tipo UNIX e invocan varias APIs al c√≥digo del usuario, lo que permite a los desarrolladores acceder al sistema gestionado o nativo subyacente.

El siguiente diagrama muestra esta arquitectura:

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ¬øQu√© son el .Net Runtime y el Mono Framework?

**.Net framework es un conjunto de ensamblados, clases y espacios de nombres** que los desarrolladores pueden utilizar para crear aplicaciones; .Net Runtime ejecuta el c√≥digo compilado, y el proceso se llama ejecuci√≥n de c√≥digo gestionado. .NET Runtime ofrece varias caracter√≠sticas que aseguran la independencia de la plataforma y son compatibles con versiones anteriores del framework.

**Mono Framework** comenz√≥ en 2005 como una implementaci√≥n del .NET Framework para Linux (Ximian/SuSe/Novell). Patrocinado por Microsoft y liderado por Xamarin, Mono es la implementaci√≥n de c√≥digo abierto del .NET framework basada en los est√°ndares ECMA para Common Language Runtime y C#.

## T√©cnicas de Ingenier√≠a Inversa para Aplicaciones Xamarin

### Decompilaci√≥n de Ensamblados Xamarin

La decompilaci√≥n es el proceso utilizado para producir c√≥digo fuente a partir de c√≥digo compilado. Para obtener informaci√≥n sobre los ensamblados y ejecutables actualmente en memoria, Windows es un gran lugar.

Para abrir la ventana de M√≥dulos, selecciona Debug > Windows > Modules. Una vez que detectes el m√≥dulo que requiere decompilaci√≥n, haz clic derecho y selecciona "Decompile Source to Symbol File". Esta acci√≥n **crea un archivo de s√≠mbolos que contiene una fuente decompilada que**, a su vez, te permite entrar directamente en el c√≥digo de terceros desde tu c√≥digo fuente.

**Visual Studio** decompila el c√≥digo gestionado, incluso en ausencia de s√≠mbolos, permiti√©ndote mirar el c√≥digo, inspeccionar las variables y establecer puntos de interrupci√≥n. Para extraer el c√≥digo fuente al disco, haz clic derecho en el m√≥dulo con fuente incrustada y haz clic en "Extract Embedded Source ." Esto exportar√° los archivos fuente a una carpeta de archivos varios para un an√°lisis posterior.

### Compilaci√≥n JIT vs AOT de Aplicaciones Xamarin

Estas dos opciones para compilar c√≥digo Xamarin basado en C# en una aplicaci√≥n, es decir, **compilaci√≥n Just in time y compilaci√≥n ahead of time**. La forma de compilaci√≥n afecta c√≥mo se env√≠a el c√≥digo de la aplicaci√≥n dentro del archivo apk o ipa. Echemos un vistazo r√°pido a continuaci√≥n:

\- **Android**: Xamarin te permite compilar utilizando **tanto las banderas JIT como AOT para android**. Tambi√©n hay una forma de quedarse en medio para obtener la mayor velocidad de ejecuci√≥n utilizando el modo Hybrid AOT. Ten en cuenta que el modo Full AOT solo est√° disponible para la licencia Enterprise.

\- **iOS**: Solo hay una opci√≥n en el caso de iOS, **compilaci√≥n ahead-of-time**. Esto se debe a las pol√≠ticas de Apple que proh√≠ben la ejecuci√≥n de c√≥digo generado din√°micamente en un dispositivo.

{% hint style="info" %}
Si te encuentras con una aplicaci√≥n compilada Full AOT, y si los archivos IL Assembly son eliminados para reducir el tama√±o de la compilaci√≥n por el desarrollador, entonces la ingenier√≠a inversa requiere un paso extra de extracci√≥n de archivos dll de los archivos .dll.so de la carpeta lib o del archivo `libmonodroid_bundle_app.so`. Si es una aplicaci√≥n compilada Hybrid AOT, y los archivos IL todav√≠a se mantienen en el paquete de la aplicaci√≥n, podemos usar eso para hacer ingenier√≠a inversa de la aplicaci√≥n.
{% endhint %}

## Obtenci√≥n de los archivos dll del APK/IPA

Simplemente **descomprime el archivo apk/ipa** y copia todos los archivos presentes en el directorio de ensamblados:

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

En el caso de los **APKs de Android, estos archivos dll est√°n comprimidos** y no se pueden utilizar directamente para la decompilaci√≥n. Afortunadamente, hay herramientas que podemos utilizar para **descomprimir estos archivos dll** como [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) y [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress).
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Es posible que en lugar de archivos dll veas `assemblies.blob` y `assemblies.manifest` en el directorio de ensamblados. Esto es un Xamarin AssemblyStore y la forma actualmente recomendada de empaquetar dlls en una aplicaci√≥n Android. El `assemblies.manifest` es un archivo de texto que describe los contenidos del archivo binario `assemblies.blob`. Para desempaquetar estos necesitar√°s usar [pyxamstore](https://github.com/jakev/pyxamstore).
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
En el caso de iOS, **los archivos dll dentro de los archivos IPA pueden cargarse directamente** en un descompilador (no es necesario descomprimir nada).

**La mayor√≠a del c√≥digo de la aplicaci√≥n se puede encontrar cuando descompilamos los archivos dll.** Tambi√©n tenga en cuenta que las aplicaciones basadas en el Framework de Xamarin contienen un 90% de c√≥digo com√∫n en las compilaciones de todas las plataformas como iOS, Android, etc.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

A partir de la captura de pantalla anterior que muestra los archivos dll presentes en el apk, podemos confirmar que es una aplicaci√≥n Xamarin. Contiene archivos dll espec√≠ficos de la aplicaci√≥n junto con los archivos de biblioteca que son necesarios para que la aplicaci√≥n funcione, como `Xamarin.Essentails.dll` o `Mono.Security.dll`.

{% hint style="success" %}
Finalmente, puede usar [**estas herramientas recomendadas**](../reversing/reversing-tools-basic-methods/#net-decompiler) para acceder al **c√≥digo C#** de los DLLs.
{% endhint %}

## An√°lisis Din√°mico

Intente verificar si la aplicaci√≥n tiene alg√∫n tipo de SSL pinning implementado. Si no, usar Burp como un CA del sistema deber√≠a funcionar para interceptar solicitudes. **Frida con Java o el entorno de ejecuci√≥n de ObjC no funcionar√°** aqu√≠, pero afortunadamente hay una herramienta que se puede usar para engancharse en los m√©todos.

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) le permite **modificar el binario .NET dentro de una aplicaci√≥n Xamarin en tiempo de ejecuci√≥n**. El an√°lisis est√°tico le ayudar√° a identificar diferentes m√©todos presentes dentro de la aplicaci√≥n, que luego pueden ser enganchados para el an√°lisis din√°mico usando Fridax. A continuaci√≥n, se presentan algunos scripts de Frida que pueden ayudarnos a eludir la detecci√≥n de root o el SSL-pinning:

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## Referencias

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabaja en una **empresa de ciberseguridad**? ¬øQuiere ver su **empresa anunciada en HackTricks**? o ¬øquiere tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* Obtenga el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önase al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠game** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparta sus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
