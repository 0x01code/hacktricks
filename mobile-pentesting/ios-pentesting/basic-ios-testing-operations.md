# Op√©rations de base de test iOS

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## **R√©sum√© de l'identification et de l'acc√®s aux appareils iOS**

### **Identification de l'UDID d'un appareil iOS**

Pour identifier de mani√®re unique un appareil iOS, une s√©quence de 40 chiffres appel√©e UDID est utilis√©e. Sur macOS Catalina ou ult√©rieur, cela peut √™tre trouv√© dans l'application **Finder**, car iTunes n'est plus pr√©sent. L'appareil, une fois connect√© via USB et s√©lectionn√© dans Finder, r√©v√®le son UDID parmi d'autres informations lorsque les d√©tails sous son nom sont cliqu√©s.

Pour les versions de macOS ant√©rieures √† Catalina, iTunes facilite la d√©couverte de l'UDID. Des instructions d√©taill√©es peuvent √™tre trouv√©es [ici](http://www.iclarified.com/52179/how-to-find-your-iphones-udid).

Les outils en ligne de commande offrent des m√©thodes alternatives pour r√©cup√©rer l'UDID :

* **En utilisant l'outil I/O Registry Explorer `ioreg` :**
```bash
$ ioreg -p IOUSB -l | grep "USB Serial"
```
* **Utilisation de `ideviceinstaller` pour macOS (et Linux) :**
```bash
$ brew install ideviceinstaller
$ idevice_id -l
```
* **Utilisation de `system_profiler` :**
```bash
$ system_profiler SPUSBDataType | sed -n -e '/iPad/,/Serial/p;/iPhone/,/Serial/p;/iPod/,/Serial/p' | grep "Serial Number:"
```
* **Utilisation de `instruments` pour r√©pertorier les appareils :**
```bash
$ instruments -s devices
```
### **Acc√®s au Shell du Dispositif**

L'acc√®s SSH est activ√© en installant le paquet **OpenSSH** apr√®s le jailbreak, permettant des connexions via `ssh root@<adresse_ip_du_dispositif>`. Il est crucial de changer les mots de passe par d√©faut (`alpine`) pour les utilisateurs `root` et `mobile` afin de s√©curiser le dispositif.

**SSH via USB** devient n√©cessaire en l'absence de Wi-Fi, en utilisant `iproxy` pour mapper les ports du dispositif pour les connexions SSH. Cette configuration permet l'acc√®s SSH via USB en ex√©cutant :
```bash
$ iproxy 2222 22
$ ssh -p 2222 root@localhost
```
**Applications de shell sur l'appareil**, comme NewTerm 2, facilitent l'interaction directe avec l'appareil, particuli√®rement utile pour le d√©pannage. Les **coquilles SSH invers√©es** peuvent √©galement √™tre √©tablies pour un acc√®s √† distance depuis l'ordinateur h√¥te.

### **R√©initialisation des mots de passe oubli√©s**

Pour r√©initialiser un mot de passe oubli√© au mot de passe par d√©faut (`alpine`), il est n√©cessaire de modifier le fichier `/private/etc/master.passwd`. Cela implique de remplacer le hachage existant par le hachage pour `alpine` √† c√¥t√© des entr√©es des utilisateurs `root` et `mobile`.

## **Techniques de transfert de donn√©es**

### **Transfert de fichiers de donn√©es d'application**

**Archivage et R√©cup√©ration via SSH et SCP:** Il est simple d'archiver le r√©pertoire de donn√©es de l'application en utilisant `tar` puis de le transf√©rer en utilisant `scp`. La commande ci-dessous archive le r√©pertoire de donn√©es dans un fichier .tgz, qui est ensuite extrait de l'appareil:
```bash
tar czvf /tmp/data.tgz /private/var/mobile/Containers/Data/Application/8C8E7EB0-BC9B-435B-8EF8-8F5560EB0693
exit
scp -P 2222 root@localhost:/tmp/data.tgz .
```
### **Outils d'Interface Utilisateur Graphique**

**Utilisation de iFunbox et iExplorer:** Ces outils GUI sont utiles pour g√©rer les fichiers sur les appareils iOS. Cependant, √† partir d'iOS 8.4, Apple a restreint l'acc√®s de ces outils au bac √† sable de l'application sauf si le p√©riph√©rique est jailbreak√©.

### **Utilisation d'Objection pour la Gestion de Fichiers**

**Shell Interactif avec Objection:** Le lancement d'objection fournit un acc√®s au r√©pertoire Bundle d'une application. √Ä partir de l√†, vous pouvez naviguer jusqu'au r√©pertoire Documents de l'application et g√©rer les fichiers, y compris les t√©l√©charger et les t√©l√©verser vers et depuis l'appareil iOS.
```bash
objection --gadget com.apple.mobilesafari explorer
cd /var/mobile/Containers/Data/Application/72C7AAFB-1D75-4FBA-9D83-D8B4A2D44133/Documents
file download <filename>
```
## **Obtention et Extraction des Applications**

### **Acquisition du Fichier IPA**

**Lien de Distribution Over-The-Air (OTA) :** Les applications distribu√©es pour les tests via OTA peuvent √™tre t√©l√©charg√©es en utilisant l'outil de t√©l√©chargement d'actifs des services ITMS, qui est install√© via npm et utilis√© pour sauvegarder le fichier IPA localement.
```bash
npm install -g itms-services
itms-services -u "itms-services://?action=download-manifest&url=https://s3-ap-southeast-1.amazonaws.com/test-uat/manifest.plist" -o - > out.ipa
```
### **Extraction du binaire de l'application**

1. **√Ä partir d'un IPA :** D√©compressez l'IPA pour acc√©der au binaire de l'application d√©chiffr√©.
2. **√Ä partir d'un appareil jailbreak√© :** Installez l'application et extrayez le binaire d√©chiffr√© de la m√©moire.

### **Processus de d√©chiffrement**

**Aper√ßu du d√©chiffrement manuel :** Les binaires des applications iOS sont chiffr√©s par Apple en utilisant FairPlay. Pour les r√©troconcevoir, il est n√©cessaire de r√©cup√©rer le binaire d√©chiffr√© de la m√©moire. Le processus de d√©chiffrement implique de v√©rifier le drapeau PIE, d'ajuster les drapeaux de m√©moire, d'identifier la section chiffr√©e, puis de la r√©cup√©rer et de la remplacer par sa forme d√©chiffr√©e.

**V√©rification et modification du drapeau PIE :**
```bash
otool -Vh Original_App
python change_macho_flags.py --no-pie Original_App
otool -Vh Hello_World
```
**Identifier la section chiffr√©e et le vidage de m√©moire :**

D√©terminez les adresses de d√©but et de fin de la section chiffr√©e en utilisant `otool` et effectuez le vidage de m√©moire depuis l'appareil jailbreak√© en utilisant gdb.
```bash
otool -l Original_App | grep -A 4 LC_ENCRYPTION_INFO
dump memory dump.bin 0x8000 0x10a4000
```
**Remplacement de la section chiffr√©e :**

Remplacez la section chiffr√©e dans le binaire de l'application d'origine par le dump d√©chiffr√©.
```bash
dd bs=1 seek=<starting_address> conv=notrunc if=dump.bin of=Original_App
```
**Finalisation du D√©chiffrement :** Modifier les m√©tadonn√©es du binaire pour indiquer l'absence de chiffrement en utilisant des outils comme **MachOView**, en d√©finissant `cryptid` sur 0.

### **D√©chiffrement (Automatique)**

#### **frida-ios-dump**
L'outil [**frida-ios-dump**](https://github.com/AloneMonkey/frida-ios-dump) est utilis√© pour **d√©chiffrer et extraire automatiquement des applications** des appareils iOS. Initialement, il faut configurer `dump.py` pour se connecter √† l'appareil iOS, ce qui peut √™tre fait via localhost sur le port 2222 via **iproxy** ou directement via l'adresse IP et le port de l'appareil.

Les applications install√©es sur l'appareil peuvent √™tre r√©pertori√©es avec la commande :
```bash
$ python dump.py -l
```
Pour extraire une application sp√©cifique, telle que Telegram, la commande suivante est utilis√©e :
```bash
$ python3 dump.py -u "root" -p "<PASSWORD>" ph.telegra.Telegraph
```
Ce commandement initie le vidage de l'application, ce qui entra√Æne la cr√©ation d'un fichier `Telegram.ipa` dans le r√©pertoire actuel. Ce processus est adapt√© aux appareils jailbreak√©s, car les applications non sign√©es ou faussement sign√©es peuvent √™tre r√©install√©es √† l'aide d'outils tels que [**ios-deploy**](https://github.com/ios-control/ios-deploy).

#### **flexdecrypt**
L'outil [**flexdecrypt**](https://github.com/JohnCoates/flexdecrypt), avec son wrapper [**flexdump**](https://gist.github.com/defparam/71d67ee738341559c35c684d659d40ac), permet l'extraction de fichiers IPA √† partir d'applications install√©es. Les commandes d'installation pour **flexdecrypt** sur l'appareil comprennent le t√©l√©chargement et l'installation du package `.deb`. **flexdump** peut √™tre utilis√© pour r√©pertorier et vider les applications, comme indiqu√© dans les commandes ci-dessous:
```bash
apt install zip unzip
wget https://gist.githubusercontent.com/defparam/71d67ee738341559c35c684d659d40ac/raw/30c7612262f1faf7871ba8e32fbe29c0f3ef9e27/flexdump -P /usr/local/bin; chmod +x /usr/local/bin/flexdump
flexdump list
flexdump dump Twitter.app
```
#### **bagbak**
[**bagbak**](https://github.com/ChiChou/bagbak), un autre outil bas√© sur Frida, n√©cessite un appareil jailbreak√© pour le d√©cryptage de l'application:
```bash
bagbak --raw Chrome
```
#### **r2flutch**
**r2flutch**, utilisant √† la fois radare et frida, sert √† la d√©cryption et au dumping d'applications. Plus d'informations peuvent √™tre trouv√©es sur sa [**page GitHub**](https://github.com/as0ler/r2flutch).

### **Installation des Applications**

**Sideloading** fait r√©f√©rence √† l'installation d'applications en dehors de l'App Store officiel. Ce processus est g√©r√© par le **d√©mon installd** et n√©cessite que les applications soient sign√©es avec un certificat d√©livr√© par Apple. Les appareils jailbreak√©s peuvent contourner cela gr√¢ce √† **AppSync**, permettant l'installation de packages IPA sign√©s de mani√®re frauduleuse.

#### **Outils de Sideloading**

- **Cydia Impactor** : Un outil pour signer et installer des fichiers IPA sur iOS et des fichiers APK sur Android. Des guides et des solutions de d√©pannage peuvent √™tre trouv√©s sur [yalujailbreak.net](https://yalujailbreak.net/how-to-use-cydia-impactor/).

- **libimobiledevice** : Une biblioth√®que pour Linux et macOS pour communiquer avec les appareils iOS. Des commandes d'installation et des exemples d'utilisation pour ideviceinstaller sont fournis pour installer des applications via USB.

- **ipainstaller** : Cet outil en ligne de commande permet l'installation directe d'applications sur des appareils iOS.

- **ios-deploy** : Pour les utilisateurs de macOS, ios-deploy installe des applications iOS depuis la ligne de commande. Le d√©zippage de l'IPA et l'utilisation du drapeau `-m` pour le lancement direct de l'application font partie du processus.

- **Xcode** : Utilisez Xcode pour installer des applications en naviguant vers **Window/Devices and Simulators** et en ajoutant l'application √† **Installed Apps**.

#### **Autoriser l'Installation d'Applications sur des Appareils Non-iPad**
Pour installer des applications sp√©cifiques √† l'iPad sur des appareils iPhone ou iPod touch, la valeur **UIDeviceFamily** dans le fichier **Info.plist** doit √™tre modifi√©e en **1**. Cette modification n√©cessite cependant de resigner le fichier IPA en raison des v√©rifications de validation de signature.

**Remarque** : Cette m√©thode peut √©chouer si l'application exige des fonctionnalit√©s exclusives aux nouveaux mod√®les d'iPad tout en utilisant un ancien iPhone ou iPod touch.



## R√©f√©rences
* [https://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/](ttps://mas.owasp.org/MASTG/iOS/0x06b-iOS-Security-Testing/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0052/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0053/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0054/)
* [https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/](https://mas.owasp.org/MASTG/techniques/ios/MASTG-TECH-0056/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
