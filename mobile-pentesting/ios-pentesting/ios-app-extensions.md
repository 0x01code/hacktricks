# Extensions d'application iOS

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Contenu copi√© de** [**https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#app-extensions**](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#app-extensions)

Les extensions d'application permettent aux applications d'offrir des fonctionnalit√©s et contenus personnalis√©s aux utilisateurs pendant qu'ils interagissent avec d'autres applications ou le syst√®me. Parmi les plus notables, on trouve :

* **Clavier personnalis√©** : remplace le clavier syst√®me iOS par un clavier personnalis√© utilisable dans toutes les applications.
* **Partage** : publier sur un site de partage ou partager du contenu avec d'autres.
* **Aujourd'hui** : √©galement appel√©s **widgets**, ils offrent du contenu ou effectuent des t√¢ches rapides dans la vue Aujourd'hui du Centre de notifications.

Par exemple, l'utilisateur s√©lectionne du texte dans l'_application h√¥te_, clique sur le bouton "Partager" et s√©lectionne une "application" ou une action dans la liste. Cela d√©clenche l'_extension d'application_ de l'_application conteneur_. L'extension d'application affiche sa vue dans le contexte de l'application h√¥te et utilise les √©l√©ments fournis par l'application h√¥te, le texte s√©lectionn√© dans ce cas, pour effectuer une t√¢che sp√©cifique (le publier sur un r√©seau social, par exemple). Voir cette image du [Guide de programmation des extensions d'application Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple_ref/doc/uid/TP40014214-CH2-SW13) qui r√©sume assez bien cela :

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc_%2F-Lf1AQx9khfTwUwYuMti%2Fapp_extensions_communication.png?alt=media)

### **Consid√©rations de s√©curit√©**

Du point de vue de la s√©curit√©, il est important de noter que :

* Une **extension d'application ne communique jamais directement avec son application conteneur** (g√©n√©ralement, elle n'est m√™me pas en cours d'ex√©cution pendant que l'extension d'application contenue est active).
* Une **extension d'application** et l'**application h√¥te** **communiquent** via une communication **inter-processus**.
* L'**application conteneur** d'une **extension d'application** et l'**application h√¥te ne communiquent** pas du tout.
* Un **widget Aujourd'hui** (et aucun autre type d'extension d'application) peut demander au syst√®me d'ouvrir son application conteneur en appelant la m√©thode `openURL:completionHandler:` de la classe `NSExtensionContext`.
* Toute **extension d'application** et son **application conteneur** peuvent **acc√©der √† des donn√©es partag√©es dans un conteneur partag√© priv√©**.
* Les extensions d'application **ne peuvent pas acc√©der √† certaines API**, par exemple, HealthKit.
* Elles **ne peuvent pas recevoir de donn√©es via AirDrop** mais peuvent envoyer des donn√©es.
* **Aucune t√¢che d'arri√®re-plan de longue dur√©e** n'est autoris√©e, mais il est possible d'initier des t√©l√©chargements ou des t√©l√©versements.
* Les extensions d'application **ne peuvent pas acc√©der √† la cam√©ra ou au microphone d'un appareil iOS** (√† l'exception des extensions d'application iMessage).

### Analyse statique

#### **V√©rifier si l'application contient des extensions d'application**

Si vous avez le code source original, vous pouvez rechercher toutes les occurrences de `NSExtensionPointIdentifier` avec Xcode (cmd+shift+f) ou jeter un ≈ìil dans "Build Phases / Embed App extensions" :

![](<../../.gitbook/assets/image (496).png>)

L√†, vous pouvez trouver les noms de toutes les extensions d'application int√©gr√©es suivies de `.appex`, maintenant vous pouvez naviguer vers les extensions d'application individuelles dans le projet.

Si vous n'avez pas le code source original :

Cherchez `NSExtensionPointIdentifier` parmi tous les fichiers √† l'int√©rieur du paquet de l'application (IPA ou application install√©e) :
```bash
$ grep -nr NSExtensionPointIdentifier Payload/Telegram\ X.app/
Binary file Payload/Telegram X.app//PlugIns/SiriIntents.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Share.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/NotificationContent.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Widget.appex/Info.plist matches
Binary file Payload/Telegram X.app//Watch/Watch.app/PlugIns/Watch Extension.appex/Info.plist matches
```
Vous pouvez √©galement acc√©der via SSH, trouver le bundle de l'application et lister tous les PlugIns √† l'int√©rieur (ils sont plac√©s l√† par d√©faut) ou le faire avec objection :
```bash
ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # cd PlugIns
/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/
Telegram X.app/PlugIns

ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    Read    Write     Name
------------  -------  ------------------  ------  -------   -------------------------
Directory         493  None                True    False     NotificationContent.appex
Directory         493  None                True    False     Widget.appex
Directory         493  None                True    False     Share.appex
Directory         493  None                True    False     SiriIntents.appex
```
Nous pouvons maintenant voir les quatre m√™mes extensions d'application que nous avons vues dans Xcode auparavant.

#### **D√©termination des types de donn√©es pris en charge**

Ceci est important pour les donn√©es partag√©es avec les applications h√¥tes (par exemple via les extensions de partage ou d'action). Lorsque l'utilisateur s√©lectionne un type de donn√©es dans une application h√¥te et qu'il correspond aux types de donn√©es d√©finis ici, l'application h√¥te proposera l'extension. Il est important de noter la diff√©rence entre cela et le partage de donn√©es via `UIActivity` o√π nous devions d√©finir les types de documents, √©galement en utilisant des UTIs. Une application n'a pas besoin d'avoir une extension pour cela. Il est possible de partager des donn√©es en utilisant uniquement `UIActivity`.

Inspectez le fichier `Info.plist` de l'extension d'application et recherchez `NSExtensionActivationRule`. Cette cl√© sp√©cifie les donn√©es prises en charge ainsi que, par exemple, le nombre maximum d'√©l√©ments pris en charge. Par exemple :
```markup
<key>NSExtensionAttributes</key>
<dict>
<key>NSExtensionActivationRule</key>
<dict>
<key>NSExtensionActivationSupportsImageWithMaxCount</key>
<integer>10</integer>
<key>NSExtensionActivationSupportsMovieWithMaxCount</key>
<integer>1</integer>
<key>NSExtensionActivationSupportsWebURLWithMaxCount</key>
<integer>1</integer>
</dict>
</dict>
```
Seuls les types de donn√©es pr√©sents ici et n'ayant pas `0` comme `MaxCount` seront pris en charge. Cependant, un filtrage plus complexe est possible en utilisant une cha√Æne de pr√©dicat qui √©valuera les UTIs donn√©s. Veuillez consulter le [Guide de Programmation des Extensions d'Application Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW8) pour plus d'informations d√©taill√©es √† ce sujet.

**V√©rification du Partage de Donn√©es avec l'Application Conteneur**

Rappelez-vous que les extensions d'application et leurs applications conteneurs n'ont pas d'acc√®s direct aux conteneurs des autres. Cependant, le partage de donn√©es peut √™tre activ√©. Cela se fait via les ["App Groups"](https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19) et l'API [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults). Voir cette figure du [Guide de Programmation des Extensions d'Application Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW11) :

![](../../mobile-apps-pentesting/ios-pentesting/broken-reference)

Comme mentionn√© √©galement dans le guide, l'application doit configurer un conteneur partag√© si l'extension d'application utilise la classe `NSURLSession` pour effectuer un t√©l√©chargement ou un t√©l√©versement en arri√®re-plan, afin que l'extension et son application conteneur puissent acc√©der aux donn√©es transf√©r√©es.

**V√©rification si l'Application Restreint l'Utilisation des Extensions d'Application**

Il est possible de rejeter un type sp√©cifique d'extension d'application en utilisant la m√©thode suivante :

* [`application:shouldAllowExtensionPointIdentifier:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623122-application?language=objc)

Cependant, cela n'est actuellement possible que pour les extensions d'application de "clavier personnalis√©" (et devrait √™tre v√©rifi√© lors du test d'applications manipulant des donn√©es sensibles via le clavier comme par exemple les applications bancaires).

### Analyse Dynamique

Pour l'analyse dynamique, nous pouvons faire ce qui suit pour acqu√©rir des connaissances sans avoir le code source :

* Inspecter les √©l√©ments partag√©s
* Identifier les extensions d'application impliqu√©es

**Inspecter les √âl√©ments Partag√©s**

Pour cela, nous devrions intercepter `NSExtensionContext - inputItems` dans l'application d'origine des donn√©es.

En suivant l'exemple pr√©c√©dent de Telegram, nous utiliserons maintenant le bouton "Partager" sur un fichier texte (qui a √©t√© re√ßu d'une discussion) pour cr√©er une note dans l'application Notes avec :

![](<../../.gitbook/assets/image (497).png>)

Si nous ex√©cutons une trace, nous verrions la sortie suivante :
```bash
(0x1c06bb420) NSExtensionContext - inputItems
0x18284355c Foundation!-[NSExtension _itemProviderForPayload:extensionContext:]
0x1828447a4 Foundation!-[NSExtension _loadItemForPayload:contextIdentifier:completionHandler:]
0x182973224 Foundation!__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S3__
0x182971968 Foundation!-[NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:]
0x182748830 Foundation!message_handler
0x181ac27d0 libxpc.dylib!_xpc_connection_call_event_handler
0x181ac0168 libxpc.dylib!_xpc_connection_mach_event
...
RET: (
"<NSExtensionItem: 0x1c420a540> - userInfo:
{
NSExtensionItemAttachmentsKey =     (
"<NSItemProvider: 0x1c46b30e0> {types = (\n \"public.plain-text\",\n \"public.file-url\"\n)}"
);
}"
)
```
Nous pouvons observer que :

* Cela s'est produit en arri√®re-plan via XPC, concr√®tement, cela est impl√©ment√© via une `NSXPCConnection` qui utilise le Framework `libxpc.dylib`.
* Les UTIs inclus dans le `NSItemProvider` sont `public.plain-text` et `public.file-url`, ce dernier √©tant inclus dans `NSExtensionActivationRule` du [`Info.plist` de l'"Extension de partage" de Telegram](https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Share/Info.plist).

**Identifier les Extensions d'Application Impliqu√©es**

Vous pouvez √©galement d√©couvrir quelle extension d'application prend en charge vos requ√™tes et r√©ponses en accrochant `NSExtension - _plugIn` :

Nous ex√©cutons le m√™me exemple √† nouveau :
```bash
(0x1c0370200) NSExtension - _plugIn
RET: <PKPlugin: 0x1163637f0 ph.telegra.Telegraph.Share(5.3) 5B6DE177-F09B-47DA-90CD-34D73121C785
1(2) /private/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35
/Telegram X.app/PlugIns/Share.appex>

(0x1c0372300)  -[NSExtension _plugIn]
RET: <PKPlugin: 0x10bff7910 com.apple.mobilenotes.SharingExtension(1.5) 73E4F137-5184-4459-A70A-83
F90A1414DC 1(2) /private/var/containers/Bundle/Application/5E267B56-F104-41D0-835B-F1DAB9AE076D
/MobileNotes.app/PlugIns/com.apple.mobilenotes.SharingExtension.appex>
```
Comme vous pouvez le voir, il y a deux extensions d'application impliqu√©es :

* `Share.appex` envoie le fichier texte (`public.plain-text` et `public.file-url`).
* `com.apple.mobilenotes.SharingExtension.appex` qui re√ßoit et traitera le fichier texte.

Si vous souhaitez en savoir plus sur ce qui se passe en arri√®re-plan en termes de XPC, nous vous recommandons de jeter un ≈ìil aux appels internes de "libxpc.dylib". Par exemple, vous pouvez utiliser [`frida-trace`](https://www.frida.re/docs/frida-trace/) puis approfondir les m√©thodes qui vous semblent les plus int√©ressantes en √©tendant les stubs g√©n√©r√©s automatiquement.

###

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
