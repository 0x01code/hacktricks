# Extensiones de aplicaciones iOS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

Las extensiones de aplicaciones permiten a las aplicaciones ofrecer funcionalidades y contenido personalizados a los usuarios mientras interact√∫an con otras aplicaciones o el sistema. Algunas de las m√°s notables son:

* **Teclado personalizado**: reemplaza el teclado del sistema iOS con un teclado personalizado para su uso en todas las aplicaciones.
* **Compartir**: publica en un sitio web de intercambio o comparte contenido con otros.
* **Hoy**: tambi√©n llamados **widgets**, ofrecen contenido o realizan tareas r√°pidas en la vista Hoy del Centro de Notificaciones.

Por ejemplo, el usuario selecciona texto en la _aplicaci√≥n anfitriona_, hace clic en el bot√≥n "Compartir" y selecciona una "aplicaci√≥n" o acci√≥n de la lista. Esto activa la _extensi√≥n de la aplicaci√≥n_ de la _aplicaci√≥n contenedora_. La extensi√≥n de la aplicaci√≥n muestra su vista dentro del contexto de la aplicaci√≥n anfitriona y utiliza los elementos proporcionados por la aplicaci√≥n anfitriona, el texto seleccionado en este caso, para realizar una tarea espec√≠fica (publicarlo en una red social, por ejemplo). Vea esta imagen de la [Gu√≠a de programaci√≥n de extensiones de aplicaciones de Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple\_ref/doc/uid/TP40014214-CH2-SW13) que resume bastante bien esto:

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc\_%2F-Lf1AQx9khfTwUwYuMti%2Fapp\_extensions\_communication.png?alt=media)

### **Consideraciones de seguridad**

Desde el punto de vista de la seguridad, es importante tener en cuenta que:

* Una **extensi√≥n de aplicaci√≥n nunca se comunica directamente con su aplicaci√≥n contenedora** (por lo general, ni siquiera se est√° ejecutando mientras se ejecuta la extensi√≥n de la aplicaci√≥n contenida).
* Una **extensi√≥n de aplicaci√≥n** y la **aplicaci√≥n anfitriona se comunican** a trav√©s de la **comunicaci√≥n entre procesos**.
* La **aplicaci√≥n contenedora de una extensi√≥n** y la **aplicaci√≥n anfitriona no se comunican** en absoluto.
* Un **widget de Hoy** (y ning√∫n otro tipo de extensi√≥n de aplicaci√≥n) puede pedir al sistema que abra su aplicaci√≥n contenedora llamando al m√©todo `openURL:completionHandler:` de la clase `NSExtensionContext`.
* Cualquier **extensi√≥n de aplicaci√≥n** y su **aplicaci√≥n contenedora** pueden **acceder a datos compartidos en un contenedor compartido definido de forma privada**.
* Las extensiones de aplicaciones **no pueden acceder a algunas API**, por ejemplo, HealthKit.
* No pueden recibir datos usando AirDrop, pero s√≠ pueden enviar datos.
* **No se permiten tareas en segundo plano de larga duraci√≥n**, pero se pueden iniciar cargas o descargas.
* Las extensiones de aplicaciones **no pueden acceder a la c√°mara o al micr√≥fono en un dispositivo iOS** (excepto las extensiones de aplicaciones de iMessage).

### An√°lisis est√°tico

#### **Verificaci√≥n de si la aplicaci√≥n contiene extensiones de aplicaciones**

Si tiene el c√≥digo fuente original, puede buscar todas las ocurrencias de `NSExtensionPointIdentifier` con Xcode (cmd+shift+f) o echar un vistazo a "Build Phases / Embed App extensions":

![](<../../.gitbook/assets/image (496).png>)

All√≠ puede encontrar los nombres de todas las extensiones de aplicaciones incrustadas seguidas de `.appex`, ahora puede navegar a las extensiones de aplicaciones individuales en el proyecto.

Si no tiene el c√≥digo fuente original:

Busque `NSExtensionPointIdentifier` entre todos los archivos dentro del paquete de la aplicaci√≥n (IPA o aplicaci√≥n instalada):
```bash
$ grep -nr NSExtensionPointIdentifier Payload/Telegram\ X.app/
Binary file Payload/Telegram X.app//PlugIns/SiriIntents.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Share.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/NotificationContent.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Widget.appex/Info.plist matches
Binary file Payload/Telegram X.app//Watch/Watch.app/PlugIns/Watch Extension.appex/Info.plist matches
```
Tambi√©n puedes acceder por SSH, encontrar el paquete de la aplicaci√≥n y listar todos los PlugIns internos (que se colocan all√≠ por defecto) o hacerlo con objection:
```bash
ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # cd PlugIns
    /var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/
    Telegram X.app/PlugIns

ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    Read    Write     Name
------------  -------  ------------------  ------  -------   -------------------------
Directory         493  None                True    False     NotificationContent.appex
Directory         493  None                True    False     Widget.appex
Directory         493  None                True    False     Share.appex
Directory         493  None                True    False     SiriIntents.appex
```
Ahora podemos ver las mismas cuatro extensiones de aplicaciones que vimos en Xcode antes.

#### **Determinando los tipos de datos soportados**

Esto es importante para los datos que se comparten con aplicaciones anfitrionas (por ejemplo, a trav√©s de extensiones de Compartir o Acci√≥n). Cuando el usuario selecciona alg√∫n tipo de dato en una aplicaci√≥n anfitriona y coincide con los tipos de datos definidos aqu√≠, la aplicaci√≥n anfitriona ofrecer√° la extensi√≥n. Vale la pena notar la diferencia entre esto y el intercambio de datos a trav√©s de `UIActivity`, donde ten√≠amos que definir los tipos de documentos, tambi√©n usando UTIs. Una aplicaci√≥n no necesita tener una extensi√≥n para eso. Es posible compartir datos usando solo `UIActivity`.

Inspeccione el archivo `Info.plist` de la extensi√≥n de la aplicaci√≥n y busque `NSExtensionActivationRule`. Esa clave especifica los datos que se admiten, as√≠ como, por ejemplo, el m√°ximo de elementos admitidos. Por ejemplo:
```markup
<key>NSExtensionAttributes</key>
    <dict>
        <key>NSExtensionActivationRule</key>
        <dict>
            <key>NSExtensionActivationSupportsImageWithMaxCount</key>
            <integer>10</integer>
            <key>NSExtensionActivationSupportsMovieWithMaxCount</key>
            <integer>1</integer>
            <key>NSExtensionActivationSupportsWebURLWithMaxCount</key>
            <integer>1</integer>
        </dict>
    </dict>
```
Solo se admitir√°n los tipos de datos presentes aqu√≠ y que no tengan `0` como `MaxCount`. Sin embargo, es posible realizar filtrados m√°s complejos utilizando una cadena de predicado llamada "predicate string" que evaluar√° los UTI proporcionados. Consulte la [Gu√≠a de programaci√≥n de extensiones de aplicaciones de Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW8) para obtener informaci√≥n m√°s detallada sobre esto.

**Comprobaci√≥n del intercambio de datos con la aplicaci√≥n contenedora**

Recuerde que las extensiones de aplicaciones y sus aplicaciones contenedoras no tienen acceso directo a los contenedores del otro. Sin embargo, se puede habilitar el intercambio de datos. Esto se hace a trav√©s de los "Grupos de aplicaciones" y la API [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults). Consulte esta figura de la [Gu√≠a de programaci√≥n de extensiones de aplicaciones de Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW11):

![](../../mobile-apps-pentesting/ios-pentesting/broken-reference)

Como tambi√©n se menciona en la gu√≠a, la aplicaci√≥n debe configurar un contenedor compartido si la extensi√≥n de la aplicaci√≥n utiliza la clase `NSURLSession` para realizar una carga o descarga en segundo plano, para que tanto la extensi√≥n como su aplicaci√≥n contenedora puedan acceder a los datos transferidos.

**Verificaci√≥n de si la aplicaci√≥n restringe el uso de extensiones de aplicaciones**

Es posible rechazar un tipo espec√≠fico de extensi√≥n de aplicaci√≥n utilizando el siguiente m√©todo:

* [`application:shouldAllowExtensionPointIdentifier:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623122-application?language=objc)

Sin embargo, actualmente solo es posible para las extensiones de aplicaciones de "teclado personalizado" (y debe verificarse al probar aplicaciones que manejen datos sensibles a trav√©s del teclado, como aplicaciones bancarias, por ejemplo).

### An√°lisis din√°mico

Para el an√°lisis din√°mico, podemos hacer lo siguiente para obtener conocimiento sin tener el c√≥digo fuente:

* Inspeccionar los elementos que se comparten
* Identificar las extensiones de aplicaciones involucradas

**Inspeccionar los elementos que se comparten**

Para esto, debemos enganchar `NSExtensionContext - inputItems` en la aplicaci√≥n de origen de los datos.

Siguiendo el ejemplo anterior de Telegram, ahora usaremos el bot√≥n "Compartir" en un archivo de texto (que se recibi√≥ de un chat) para crear una nota en la aplicaci√≥n Notas con √©l:

![](<../../.gitbook/assets/image (497).png>)

Si ejecutamos un rastreo, veremos la siguiente salida:
```bash
(0x1c06bb420) NSExtensionContext - inputItems
0x18284355c Foundation!-[NSExtension _itemProviderForPayload:extensionContext:]
0x1828447a4 Foundation!-[NSExtension _loadItemForPayload:contextIdentifier:completionHandler:]
0x182973224 Foundation!__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S3__
0x182971968 Foundation!-[NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:]
0x182748830 Foundation!message_handler
0x181ac27d0 libxpc.dylib!_xpc_connection_call_event_handler
0x181ac0168 libxpc.dylib!_xpc_connection_mach_event
...
RET: (
"<NSExtensionItem: 0x1c420a540> - userInfo:
{
    NSExtensionItemAttachmentsKey =     (
    "<NSItemProvider: 0x1c46b30e0> {types = (\n \"public.plain-text\",\n \"public.file-url\"\n)}"
    );
}"
)
```
Aqu√≠ podemos observar que:

* Esto ocurri√≥ bajo el cap√≥ a trav√©s de XPC, concretamente se implementa a trav√©s de una `NSXPCConnection` que utiliza el marco `libxpc.dylib`.
* Los UTI incluidos en `NSItemProvider` son `public.plain-text` y `public.file-url`, este √∫ltimo se incluye en `NSExtensionActivationRule` del [`Info.plist` de la "Extensi√≥n de Compartir" de Telegram](https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Share/Info.plist).

**Identificaci√≥n de las Extensiones de Aplicaciones Involucradas**

Tambi√©n puede descubrir qu√© extensi√≥n de aplicaci√≥n se encarga de sus solicitudes y respuestas enganchando `NSExtension - _plugIn`:

Ejecutamos el mismo ejemplo de nuevo:
```bash
(0x1c0370200) NSExtension - _plugIn
RET: <PKPlugin: 0x1163637f0 ph.telegra.Telegraph.Share(5.3) 5B6DE177-F09B-47DA-90CD-34D73121C785
1(2) /private/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35
/Telegram X.app/PlugIns/Share.appex>

(0x1c0372300)  -[NSExtension _plugIn]
RET: <PKPlugin: 0x10bff7910 com.apple.mobilenotes.SharingExtension(1.5) 73E4F137-5184-4459-A70A-83
F90A1414DC 1(2) /private/var/containers/Bundle/Application/5E267B56-F104-41D0-835B-F1DAB9AE076D
/MobileNotes.app/PlugIns/com.apple.mobilenotes.SharingExtension.appex>
```
Como se puede ver, hay dos extensiones de aplicaciones involucradas:

* `Share.appex` est√° enviando el archivo de texto (`public.plain-text` y `public.file-url`).
* `com.apple.mobilenotes.SharingExtension.appex` que est√° recibiendo y procesar√° el archivo de texto.

Si desea aprender m√°s sobre lo que est√° sucediendo bajo el cap√≥ en t√©rminos de XPC, recomendamos echar un vistazo a las llamadas internas de "libxpc.dylib". Por ejemplo, puede usar [`frida-trace`](https://www.frida.re/docs/frida-trace/) y luego profundizar en los m√©todos que encuentre m√°s interesantes mediante la extensi√≥n de los stubs generados autom√°ticamente. 

### 

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabaja en una **empresa de ciberseguridad**? ¬øQuiere ver su **empresa anunciada en HackTricks**? ¬øO quiere tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenga el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önase al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠game** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparta sus trucos de hacking enviando PR al repositorio [hacktricks](https://github.com/carlospolop/hacktricks) y [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
