# Extensions d'application iOS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

Les extensions d'application permettent aux applications d'offrir des fonctionnalit√©s et du contenu personnalis√©s aux utilisateurs lorsqu'ils interagissent avec d'autres applications ou le syst√®me. Voici quelques exemples notables :

* **Clavier personnalis√©** : remplace le clavier syst√®me iOS par un clavier personnalis√© pour une utilisation dans toutes les applications.
* **Partager** : publier sur un site de partage ou partager du contenu avec d'autres.
* **Aujourd'hui** : √©galement appel√©s **widgets**, ils offrent du contenu ou effectuent des t√¢ches rapides dans la vue Aujourd'hui du Centre de notification.

Par exemple, l'utilisateur s√©lectionne du texte dans l'_application h√¥te_, clique sur le bouton "Partager" et s√©lectionne une "application" ou une action dans la liste. Cela d√©clenche l'_extension d'application_ de l'_application conteneur_. L'extension d'application affiche sa vue dans le contexte de l'application h√¥te et utilise les √©l√©ments fournis par l'application h√¥te, le texte s√©lectionn√© dans ce cas, pour effectuer une t√¢che sp√©cifique (le publier sur un r√©seau social, par exemple). Cette image du [Guide de programmation des extensions d'application Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple\_ref/doc/uid/TP40014214-CH2-SW13) r√©sume assez bien cela :

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc\_%2F-Lf1AQx9khfTwUwYuMti%2Fapp\_extensions\_communication.png?alt=media)

### **Consid√©rations de s√©curit√©**

Du point de vue de la s√©curit√©, il est important de noter que :

* Une **extension d'application ne communique jamais directement avec son application conteneur** (g√©n√©ralement, elle ne fonctionne m√™me pas pendant que l'extension d'application contenue est en cours d'ex√©cution).
* Une **extension d'application** et l'**application h√¥te communiquent** via une **communication inter-processus**.
* L'**application conteneur de l'extension** et l'**application h√¥te ne communiquent pas** du tout.
* Un **widget Aujourd'hui** (et aucun autre type d'extension d'application) peut demander au syst√®me d'ouvrir son application conteneur en appelant la m√©thode `openURL:completionHandler:` de la classe `NSExtensionContext`.
* Toute **extension d'application** et son **application conteneur** peuvent **acc√©der √† des donn√©es partag√©es dans un conteneur partag√© d√©fini de mani√®re priv√©e**.
* Les extensions d'application **ne peuvent pas acc√©der √† certaines API**, par exemple, HealthKit.
* Elles **ne peuvent pas recevoir de donn√©es via AirDrop**, mais peuvent envoyer des donn√©es.
* **Aucune t√¢che de fond de longue dur√©e** n'est autoris√©e, mais des t√©l√©chargements ou des t√©l√©versements peuvent √™tre initi√©s.
* Les extensions d'application **ne peuvent pas acc√©der √† la cam√©ra ou au microphone d'un appareil iOS** (sauf pour les extensions d'application iMessage).

### Analyse statique

#### **V√©rification si l'application contient des extensions d'application**

Si vous avez le code source original, vous pouvez rechercher toutes les occurrences de `NSExtensionPointIdentifier` avec Xcode (cmd+shift+f) ou jeter un coup d'≈ìil dans "Build Phases / Embed App extensions" :

![](<../../.gitbook/assets/image (496).png>)

Vous pouvez y trouver les noms de toutes les extensions d'application int√©gr√©es suivies de `.appex`, vous pouvez maintenant acc√©der aux extensions d'application individuelles dans le projet.

Si vous n'avez pas le code source original :

Recherchez `NSExtensionPointIdentifier` parmi tous les fichiers √† l'int√©rieur du bundle de l'application (IPA ou application install√©e) :
```bash
$ grep -nr NSExtensionPointIdentifier Payload/Telegram\ X.app/
Binary file Payload/Telegram X.app//PlugIns/SiriIntents.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Share.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/NotificationContent.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Widget.appex/Info.plist matches
Binary file Payload/Telegram X.app//Watch/Watch.app/PlugIns/Watch Extension.appex/Info.plist matches
```
Vous pouvez √©galement y acc√©der via SSH, trouver le bundle de l'application et lister tous les PlugIns √† l'int√©rieur (ils y sont plac√©s par d√©faut) ou le faire avec objection:
```bash
ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # cd PlugIns
    /var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/
    Telegram X.app/PlugIns

ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    Read    Write     Name
------------  -------  ------------------  ------  -------   -------------------------
Directory         493  None                True    False     NotificationContent.appex
Directory         493  None                True    False     Widget.appex
Directory         493  None                True    False     Share.appex
Directory         493  None                True    False     SiriIntents.appex
```
Nous pouvons maintenant voir les m√™mes quatre extensions d'application que nous avons vues dans Xcode auparavant.

#### **D√©termination des types de donn√©es pris en charge**

Ceci est important pour les donn√©es partag√©es avec des applications h√¥tes (par exemple via des extensions de partage ou d'action). Lorsque l'utilisateur s√©lectionne un type de donn√©es dans une application h√¥te et qu'il correspond aux types de donn√©es d√©finis ici, l'application h√¥te proposera l'extension. Il convient de noter la diff√©rence entre cela et le partage de donn√©es via `UIActivity` o√π nous devions d√©finir les types de documents, √©galement en utilisant des UTI. Une application n'a pas besoin d'avoir une extension pour cela. Il est possible de partager des donn√©es en utilisant uniquement `UIActivity`.

Inspectez le fichier `Info.plist` de l'extension d'application et recherchez `NSExtensionActivationRule`. Cette cl√© sp√©cifie les donn√©es prises en charge ainsi que, par exemple, le nombre maximal d'√©l√©ments pris en charge. Par exemple:
```markup
<key>NSExtensionAttributes</key>
    <dict>
        <key>NSExtensionActivationRule</key>
        <dict>
            <key>NSExtensionActivationSupportsImageWithMaxCount</key>
            <integer>10</integer>
            <key>NSExtensionActivationSupportsMovieWithMaxCount</key>
            <integer>1</integer>
            <key>NSExtensionActivationSupportsWebURLWithMaxCount</key>
            <integer>1</integer>
        </dict>
    </dict>
```
Seuls les types de donn√©es pr√©sents ici et n'ayant pas `0` comme `MaxCount` seront pris en charge. Cependant, un filtrage plus complexe est possible en utilisant une cha√Æne de pr√©dicats appel√©e qui √©valuera les UTI donn√©s. Veuillez vous r√©f√©rer au [Guide de programmation des extensions d'application Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple\_ref/doc/uid/TP40014214-CH21-SW8) pour plus d'informations d√©taill√©es √† ce sujet.

**V√©rification du partage de donn√©es avec l'application conteneur**

Rappelez-vous que les extensions d'application et leurs applications conteneurs n'ont pas un acc√®s direct aux conteneurs de l'autre. Cependant, le partage de donn√©es peut √™tre activ√©. Cela se fait via les ["Groupes d'applications"](https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple\_ref/doc/uid/TP40011195-CH4-SW19) et l'API [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults). Voir cette figure du [Guide de programmation des extensions d'application Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple\_ref/doc/uid/TP40014214-CH21-SW11):

![](../../mobile-apps-pentesting/ios-pentesting/broken-reference)

Comme mentionn√© dans le guide, l'application doit configurer un conteneur partag√© si l'extension d'application utilise la classe `NSURLSession` pour effectuer un t√©l√©chargement ou un t√©l√©versement en arri√®re-plan, afin que l'extension et son application conteneur puissent acc√©der aux donn√©es transf√©r√©es.

**V√©rification si l'application restreint l'utilisation des extensions d'application**

Il est possible de rejeter un type sp√©cifique d'extension d'application en utilisant la m√©thode suivante:

* [`application:shouldAllowExtensionPointIdentifier:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623122-application?language=objc)

Cependant, il est actuellement possible uniquement pour les extensions d'application "clavier personnalis√©" (et doit √™tre v√©rifi√© lors des tests d'applications manipulant des donn√©es sensibles via le clavier comme les applications bancaires, par exemple).

### Analyse dynamique

Pour l'analyse dynamique, nous pouvons faire ce qui suit pour acqu√©rir des connaissances sans avoir le code source:

* Inspection des √©l√©ments partag√©s
* Identification des extensions d'application impliqu√©es

**Inspection des √©l√©ments partag√©s**

Pour cela, nous devons accrocher `NSExtensionContext - inputItems` dans l'application d'origine des donn√©es.

En suivant l'exemple pr√©c√©dent de Telegram, nous allons maintenant utiliser le bouton "Partager" sur un fichier texte (qui a √©t√© re√ßu d'un chat) pour cr√©er une note dans l'application Notes avec celui-ci:

![](<../../.gitbook/assets/image (497).png>)

Si nous ex√©cutons une trace, nous verrons la sortie suivante:
```bash
(0x1c06bb420) NSExtensionContext - inputItems
0x18284355c Foundation!-[NSExtension _itemProviderForPayload:extensionContext:]
0x1828447a4 Foundation!-[NSExtension _loadItemForPayload:contextIdentifier:completionHandler:]
0x182973224 Foundation!__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S3__
0x182971968 Foundation!-[NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:]
0x182748830 Foundation!message_handler
0x181ac27d0 libxpc.dylib!_xpc_connection_call_event_handler
0x181ac0168 libxpc.dylib!_xpc_connection_mach_event
...
RET: (
"<NSExtensionItem: 0x1c420a540> - userInfo:
{
    NSExtensionItemAttachmentsKey =     (
    "<NSItemProvider: 0x1c46b30e0> {types = (\n \"public.plain-text\",\n \"public.file-url\"\n)}"
    );
}"
)
```
Ici, nous pouvons observer que :

* Cela s'est produit sous le capot via XPC, concr√®tement, il est impl√©ment√© via une `NSXPCConnection` qui utilise le framework `libxpc.dylib`.
* Les UTI inclus dans le `NSItemProvider` sont `public.plain-text` et `public.file-url`, ce dernier √©tant inclus dans `NSExtensionActivationRule` du [`Info.plist` de l'extension "Share" de Telegram](https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Share/Info.plist).

**Identification des extensions d'application impliqu√©es**

Vous pouvez √©galement d√©couvrir quelle extension d'application s'occupe de vos demandes et r√©ponses en accrochant `NSExtension - _plugIn` :

Nous ex√©cutons √† nouveau le m√™me exemple :
```bash
(0x1c0370200) NSExtension - _plugIn
RET: <PKPlugin: 0x1163637f0 ph.telegra.Telegraph.Share(5.3) 5B6DE177-F09B-47DA-90CD-34D73121C785
1(2) /private/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35
/Telegram X.app/PlugIns/Share.appex>

(0x1c0372300)  -[NSExtension _plugIn]
RET: <PKPlugin: 0x10bff7910 com.apple.mobilenotes.SharingExtension(1.5) 73E4F137-5184-4459-A70A-83
F90A1414DC 1(2) /private/var/containers/Bundle/Application/5E267B56-F104-41D0-835B-F1DAB9AE076D
/MobileNotes.app/PlugIns/com.apple.mobilenotes.SharingExtension.appex>
```
Comme vous pouvez le voir, il y a deux extensions d'application impliqu√©es :

* `Share.appex` envoie le fichier texte (`public.plain-text` et `public.file-url`).
* `com.apple.mobilenotes.SharingExtension.appex` qui re√ßoit et traitera le fichier texte.

Si vous voulez en savoir plus sur ce qui se passe sous le capot en termes de XPC, nous vous recommandons de jeter un coup d'≈ìil aux appels internes de "libxpc.dylib". Par exemple, vous pouvez utiliser [`frida-trace`](https://www.frida.re/docs/frida-trace/) et approfondir les m√©thodes qui vous semblent les plus int√©ressantes en √©tendant les stubs g√©n√©r√©s automatiquement.

###

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au repo [hacktricks](https://github.com/carlospolop/hacktricks) et [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
