# Extens√µes de aplicativos iOS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

As extens√µes de aplicativos permitem que os aplicativos ofere√ßam funcionalidades e conte√∫do personalizados aos usu√°rios enquanto eles est√£o interagindo com outros aplicativos ou com o sistema. Algumas not√°veis s√£o:

* **Teclado personalizado**: substitui o teclado do sistema iOS por um teclado personalizado para uso em todos os aplicativos.
* **Compartilhar**: postar em um site de compartilhamento ou compartilhar conte√∫do com outras pessoas.
* **Hoje**: tamb√©m chamados de **widgets**, eles oferecem conte√∫do ou realizam tarefas r√°pidas na visualiza√ß√£o Hoje do Centro de Notifica√ß√µes.

Por exemplo, o usu√°rio seleciona texto no _aplicativo hospedeiro_, clica no bot√£o "Compartilhar" e seleciona um "aplicativo" ou a√ß√£o da lista. Isso aciona a _extens√£o de aplicativo_ do _aplicativo contido_. A extens√£o do aplicativo exibe sua visualiza√ß√£o dentro do contexto do aplicativo hospedeiro e usa os itens fornecidos pelo aplicativo hospedeiro, o texto selecionado neste caso, para realizar uma tarefa espec√≠fica (post√°-lo em uma rede social, por exemplo). Veja esta imagem do [Guia de Programa√ß√£o de Extens√µes de Aplicativos da Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple\_ref/doc/uid/TP40014214-CH2-SW13) que resume muito bem isso:

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc\_%2F-Lf1AQx9khfTwUwYuMti%2Fapp\_extensions\_communication.png?alt=media)

### **Considera√ß√µes de seguran√ßa**

Do ponto de vista de seguran√ßa, √© importante observar que:

* Uma **extens√£o de aplicativo nunca se comunica diretamente com seu aplicativo contido** (geralmente, nem mesmo est√° em execu√ß√£o enquanto a extens√£o de aplicativo contida est√° em execu√ß√£o).
* Uma **extens√£o de aplicativo** e o **aplicativo hospedeiro se comunicam** por meio de **comunica√ß√£o interprocessual**.
* O aplicativo contido da **extens√£o de aplicativo** e o **aplicativo hospedeiro n√£o se comunicam** de forma alguma.
* Um **widget Hoje** (e nenhum outro tipo de extens√£o de aplicativo) pode solicitar ao sistema que abra seu aplicativo contido chamando o m√©todo `openURL:completionHandler:` da classe `NSExtensionContext`.
* Qualquer **extens√£o de aplicativo** e seu **aplicativo contido** podem **acessar dados compartilhados em um cont√™iner compartilhado definido privadamente**.
* As extens√µes de aplicativos **n√£o podem acessar algumas APIs**, por exemplo, HealthKit.
* Eles **n√£o podem receber dados usando o AirDrop**, mas podem enviar dados.
* **Nenhuma tarefa de segundo plano de longa dura√ß√£o** √© permitida, mas uploads ou downloads podem ser iniciados.
* As extens√µes de aplicativos **n√£o podem acessar a c√¢mera ou o microfone em um dispositivo iOS** (exceto as extens√µes de aplicativos do iMessage).

### An√°lise est√°tica

#### **Verificando se o aplicativo cont√©m extens√µes de aplicativos**

Se voc√™ tiver o c√≥digo-fonte original, poder√° pesquisar todas as ocorr√™ncias de `NSExtensionPointIdentifier` com o Xcode (cmd+shift+f) ou dar uma olhada em "Build Phases / Embed App extensions":

![](<../../.gitbook/assets/image (496).png>)

L√° voc√™ pode encontrar os nomes de todas as extens√µes de aplicativos incorporadas seguidas por `.appex`, agora voc√™ pode navegar at√© as extens√µes de aplicativos individuais no projeto.

Se n√£o tiver o c√≥digo-fonte original:

Procure por `NSExtensionPointIdentifier` entre todos os arquivos dentro do pacote do aplicativo (IPA ou aplicativo instalado):
```bash
$ grep -nr NSExtensionPointIdentifier Payload/Telegram\ X.app/
Binary file Payload/Telegram X.app//PlugIns/SiriIntents.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Share.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/NotificationContent.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Widget.appex/Info.plist matches
Binary file Payload/Telegram X.app//Watch/Watch.app/PlugIns/Watch Extension.appex/Info.plist matches
```
Voc√™ tamb√©m pode acessar via SSH, encontrar o pacote do aplicativo e listar todos os PlugIns internos (que s√£o colocados l√° por padr√£o) ou fazer isso com o Objection:
```bash
ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # cd PlugIns
    /var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/
    Telegram X.app/PlugIns

ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    Read    Write     Name
------------  -------  ------------------  ------  -------   -------------------------
Directory         493  None                True    False     NotificationContent.appex
Directory         493  None                True    False     Widget.appex
Directory         493  None                True    False     Share.appex
Directory         493  None                True    False     SiriIntents.appex
```
Agora podemos ver as mesmas quatro extens√µes de aplicativos que vimos no Xcode antes.

#### **Determinando os tipos de dados suportados**

Isso √© importante para os dados que s√£o compartilhados com aplicativos hospedeiros (por exemplo, por meio de extens√µes de compartilhamento ou de a√ß√£o). Quando o usu√°rio seleciona algum tipo de dado em um aplicativo hospedeiro e ele corresponde aos tipos de dados definidos aqui, o aplicativo hospedeiro oferecer√° a extens√£o. Vale ressaltar a diferen√ßa entre isso e o compartilhamento de dados via `UIActivity`, onde tivemos que definir os tipos de documentos, tamb√©m usando UTIs. Um aplicativo n√£o precisa ter uma extens√£o para isso. √â poss√≠vel compartilhar dados usando apenas `UIActivity`.

Inspecione o arquivo `Info.plist` da extens√£o do aplicativo e procure por `NSExtensionActivationRule`. Essa chave especifica os dados que s√£o suportados, bem como o m√°ximo de itens suportados, por exemplo:
```markup
<key>NSExtensionAttributes</key>
    <dict>
        <key>NSExtensionActivationRule</key>
        <dict>
            <key>NSExtensionActivationSupportsImageWithMaxCount</key>
            <integer>10</integer>
            <key>NSExtensionActivationSupportsMovieWithMaxCount</key>
            <integer>1</integer>
            <key>NSExtensionActivationSupportsWebURLWithMaxCount</key>
            <integer>1</integer>
        </dict>
    </dict>
```
Apenas os tipos de dados presentes aqui e que n√£o t√™m `0` como `MaxCount` ser√£o suportados. No entanto, √© poss√≠vel fazer filtragens mais complexas usando uma string de predicado, que avaliar√° os UTIs fornecidos. Consulte o [Guia de Programa√ß√£o de Extens√µes de Aplicativos da Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW8) para obter informa√ß√µes mais detalhadas sobre isso.

**Verificando o Compartilhamento de Dados com o Aplicativo Contenedor**

Lembre-se de que as extens√µes de aplicativos e seus aplicativos contenedores n√£o t√™m acesso direto aos cont√™ineres um do outro. No entanto, o compartilhamento de dados pode ser habilitado. Isso √© feito por meio de ["Grupos de Aplicativos"](https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19) e da API [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults). Veja esta figura do [Guia de Programa√ß√£o de Extens√µes de Aplicativos da Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW11):

![](../../mobile-apps-pentesting/ios-pentesting/broken-reference)

Como tamb√©m mencionado no guia, o aplicativo deve configurar um cont√™iner compartilhado se a extens√£o do aplicativo usar a classe `NSURLSession` para realizar um upload ou download em segundo plano, para que tanto a extens√£o quanto o aplicativo contenedor possam acessar os dados transferidos.

**Verificando se o Aplicativo Restringe o Uso de Extens√µes de Aplicativos**

√â poss√≠vel rejeitar um tipo espec√≠fico de extens√£o de aplicativo usando o seguinte m√©todo:

* [`application:shouldAllowExtensionPointIdentifier:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623122-application?language=objc)

No entanto, atualmente, isso s√≥ √© poss√≠vel para extens√µes de aplicativos de "teclado personalizado" (e deve ser verificado ao testar aplicativos que lidam com dados sens√≠veis por meio do teclado, como aplicativos banc√°rios, por exemplo).

### An√°lise Din√¢mica

Para a an√°lise din√¢mica, podemos fazer o seguinte para obter conhecimento sem ter o c√≥digo-fonte:

* Inspe√ß√£o dos itens sendo compartilhados
* Identifica√ß√£o das extens√µes de aplicativos envolvidas

**Inspe√ß√£o dos Itens Sendo Compartilhados**

Para isso, devemos fazer hook em `NSExtensionContext - inputItems` no aplicativo de origem dos dados.

Seguindo o exemplo anterior do Telegram, agora usaremos o bot√£o "Compartilhar" em um arquivo de texto (que foi recebido de um chat) para criar uma nota no aplicativo Notas com ele:

![](<../../.gitbook/assets/image (497).png>)

Se executarmos um trace, veremos a seguinte sa√≠da:
```bash
(0x1c06bb420) NSExtensionContext - inputItems
0x18284355c Foundation!-[NSExtension _itemProviderForPayload:extensionContext:]
0x1828447a4 Foundation!-[NSExtension _loadItemForPayload:contextIdentifier:completionHandler:]
0x182973224 Foundation!__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S3__
0x182971968 Foundation!-[NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:]
0x182748830 Foundation!message_handler
0x181ac27d0 libxpc.dylib!_xpc_connection_call_event_handler
0x181ac0168 libxpc.dylib!_xpc_connection_mach_event
...
RET: (
"<NSExtensionItem: 0x1c420a540> - userInfo:
{
    NSExtensionItemAttachmentsKey =     (
    "<NSItemProvider: 0x1c46b30e0> {types = (\n \"public.plain-text\",\n \"public.file-url\"\n)}"
    );
}"
)
```
Aqui podemos observar que:

* Isso ocorreu nos bastidores via XPC, concretamente √© implementado via `NSXPCConnection` que usa o Framework `libxpc.dylib`.
* Os UTIs inclu√≠dos no `NSItemProvider` s√£o `public.plain-text` e `public.file-url`, sendo este √∫ltimo inclu√≠do em `NSExtensionActivationRule` do [`Info.plist` da "Extens√£o de Compartilhamento" do Telegram](https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Share/Info.plist).

**Identificando as Extens√µes de Aplicativos Envolvidas**

Voc√™ tamb√©m pode descobrir qual extens√£o de aplicativo est√° cuidando de suas solicita√ß√µes e respostas conectando `NSExtension - _plugIn`:

Executamos novamente o mesmo exemplo:
```bash
(0x1c0370200) NSExtension - _plugIn
RET: <PKPlugin: 0x1163637f0 ph.telegra.Telegraph.Share(5.3) 5B6DE177-F09B-47DA-90CD-34D73121C785
1(2) /private/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35
/Telegram X.app/PlugIns/Share.appex>

(0x1c0372300)  -[NSExtension _plugIn]
RET: <PKPlugin: 0x10bff7910 com.apple.mobilenotes.SharingExtension(1.5) 73E4F137-5184-4459-A70A-83
F90A1414DC 1(2) /private/var/containers/Bundle/Application/5E267B56-F104-41D0-835B-F1DAB9AE076D
/MobileNotes.app/PlugIns/com.apple.mobilenotes.SharingExtension.appex>
```
Como voc√™ pode ver, existem duas extens√µes de aplicativos envolvidas:

* `Share.appex` est√° enviando o arquivo de texto (`public.plain-text` e `public.file-url`).
* `com.apple.mobilenotes.SharingExtension.appex` que est√° recebendo e processar√° o arquivo de texto.

Se voc√™ quiser aprender mais sobre o que est√° acontecendo nos bastidores em termos de XPC, recomendamos dar uma olhada nas chamadas internas de "libxpc.dylib". Por exemplo, voc√™ pode usar [`frida-trace`](https://www.frida.re/docs/frida-trace/) e, em seguida, aprofundar-se nos m√©todos que voc√™ achar mais interessantes, estendendo os stubs gerados automaticamente.

###

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
