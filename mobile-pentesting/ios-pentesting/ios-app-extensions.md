# Extens√µes de Aplicativos iOS

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

**Conte√∫do copiado de** [**https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#app-extensions**](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#app-extensions)

As extens√µes de aplicativos permitem que os apps ofere√ßam funcionalidades e conte√∫dos personalizados aos usu√°rios enquanto eles interagem com outros aplicativos ou o sistema. Algumas not√°veis incluem:

* **Teclado Personalizado**: substitui o teclado do sistema iOS por um teclado personalizado para uso em todos os aplicativos.
* **Compartilhar**: publicar em um site de compartilhamento ou compartilhar conte√∫do com outros.
* **Hoje**: tamb√©m chamados de **widgets**, oferecem conte√∫do ou realizam tarefas r√°pidas na visualiza√ß√£o de Hoje do Centro de Notifica√ß√µes.

Por exemplo, o usu√°rio seleciona texto no _aplicativo hospedeiro_, clica no bot√£o "Compartilhar" e seleciona um "aplicativo" ou a√ß√£o da lista. Isso aciona a _extens√£o do aplicativo_ do _aplicativo contenedor_. A extens√£o do aplicativo exibe sua visualiza√ß√£o dentro do contexto do aplicativo hospedeiro e usa os itens fornecidos pelo aplicativo hospedeiro, o texto selecionado neste caso, para realizar uma tarefa espec√≠fica (post√°-lo em uma rede social, por exemplo). Veja esta imagem do [Guia de Programa√ß√£o de Extens√µes de Aplicativos da Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple_ref/doc/uid/TP40014214-CH2-SW13) que resume muito bem isso:

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc_%2F-Lf1AQx9khfTwUwYuMti%2Fapp_extensions_communication.png?alt=media)

### **Considera√ß√µes de Seguran√ßa**

Do ponto de vista da seguran√ßa, √© importante notar que:

* Uma **extens√£o de aplicativo nunca se comunica diretamente com seu aplicativo contenedor** (tipicamente, nem est√° em execu√ß√£o enquanto a extens√£o do aplicativo contida est√° em execu√ß√£o).
* Uma **extens√£o de aplicativo** e o **aplicativo hospedeiro** **comunicam-se** via **comunica√ß√£o entre processos**.
* Um **aplicativo contenedor** de uma **extens√£o de aplicativo** e o **aplicativo hospedeiro n√£o se comunicam** de forma alguma.
* Um **widget Hoje** (e nenhum outro tipo de extens√£o de aplicativo) pode pedir ao sistema para abrir seu aplicativo contenedor chamando o m√©todo `openURL:completionHandler:` da classe `NSExtensionContext`.
* Qualquer **extens√£o de aplicativo** e seu **aplicativo contenedor** podem **acessar dados compartilhados em um cont√™iner compartilhado privadamente** definido.
* Extens√µes de aplicativos **n√£o podem acessar algumas APIs**, por exemplo, HealthKit.
* Elas **n√£o podem receber dados usando AirDrop**, mas podem enviar dados.
* **N√£o s√£o permitidas tarefas de fundo de longa dura√ß√£o**, mas podem ser iniciados uploads ou downloads.
* Extens√µes de aplicativos **n√£o podem acessar a c√¢mera ou o microfone em um dispositivo iOS** (exceto para extens√µes de aplicativos iMessage).

### An√°lise Est√°tica

#### **Verificando se o Aplicativo Cont√©m Extens√µes de Aplicativos**

Se voc√™ tem o c√≥digo-fonte original, pode procurar por todas as ocorr√™ncias de `NSExtensionPointIdentifier` com o Xcode (cmd+shift+f) ou dar uma olhada em "Build Phases / Embed App extensions":

![](<../../.gitbook/assets/image (496).png>)

L√° voc√™ pode encontrar os nomes de todas as extens√µes de aplicativos embutidas seguidas por `.appex`, agora voc√™ pode navegar at√© as extens√µes de aplicativos individuais no projeto.

Se n√£o tiver o c√≥digo-fonte original:

Grep por `NSExtensionPointIdentifier` entre todos os arquivos dentro do pacote do aplicativo (IPA ou aplicativo instalado):
```bash
$ grep -nr NSExtensionPointIdentifier Payload/Telegram\ X.app/
Binary file Payload/Telegram X.app//PlugIns/SiriIntents.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Share.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/NotificationContent.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Widget.appex/Info.plist matches
Binary file Payload/Telegram X.app//Watch/Watch.app/PlugIns/Watch Extension.appex/Info.plist matches
```
Voc√™ tamb√©m pode acessar via SSH, encontrar o pacote do aplicativo e listar todos os PlugIns internos (eles s√£o colocados l√° por padr√£o) ou fazer isso com objection:
```bash
ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # cd PlugIns
/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/
Telegram X.app/PlugIns

ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    Read    Write     Name
------------  -------  ------------------  ------  -------   -------------------------
Directory         493  None                True    False     NotificationContent.appex
Directory         493  None                True    False     Widget.appex
Directory         493  None                True    False     Share.appex
Directory         493  None                True    False     SiriIntents.appex
```
#### **Determinando os Tipos de Dados Suportados**

Isso √© importante para dados sendo compartilhados com aplicativos hospedeiros (por exemplo, via Extens√µes de Compartilhamento ou A√ß√£o). Quando o usu√°rio seleciona algum tipo de dado em um aplicativo hospedeiro e ele corresponde aos tipos de dados definidos aqui, o aplicativo hospedeiro oferecer√° a extens√£o. Vale a pena notar a diferen√ßa entre isso e o compartilhamento de dados via `UIActivity`, onde tivemos que definir os tipos de documentos, tamb√©m usando UTIs. Um aplicativo n√£o precisa ter uma extens√£o para isso. √â poss√≠vel compartilhar dados usando apenas `UIActivity`.

Inspecione o arquivo `Info.plist` da extens√£o do aplicativo e procure por `NSExtensionActivationRule`. Essa chave especifica os dados sendo suportados, bem como, por exemplo, o m√°ximo de itens suportados. Por exemplo:
```markup
<key>NSExtensionAttributes</key>
<dict>
<key>NSExtensionActivationRule</key>
<dict>
<key>NSExtensionActivationSupportsImageWithMaxCount</key>
<integer>10</integer>
<key>NSExtensionActivationSupportsMovieWithMaxCount</key>
<integer>1</integer>
<key>NSExtensionActivationSupportsWebURLWithMaxCount</key>
<integer>1</integer>
</dict>
</dict>
```
Apenas os tipos de dados presentes aqui e que n√£o t√™m `0` como `MaxCount` ser√£o suportados. No entanto, √© poss√≠vel um filtro mais complexo usando uma chamada string de predicado que avaliar√° os UTIs dados. Por favor, consulte o [Guia de Programa√ß√£o de Extens√µes de Aplicativos da Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW8) para mais informa√ß√µes detalhadas sobre isso.

**Verificando o Compartilhamento de Dados com o Aplicativo Contenedor**

Lembre-se de que as extens√µes de aplicativos e seus aplicativos contenedores n√£o t√™m acesso direto aos cont√™ineres um do outro. No entanto, o compartilhamento de dados pode ser habilitado. Isso √© feito por meio de ["Grupos de Aplicativos"](https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19) e a API [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults). Veja esta figura do [Guia de Programa√ß√£o de Extens√µes de Aplicativos da Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW11):

![](../../mobile-apps-pentesting/ios-pentesting/broken-reference)

Como tamb√©m mencionado no guia, o aplicativo deve configurar um cont√™iner compartilhado se a extens√£o do aplicativo usar a classe `NSURLSession` para realizar um upload ou download em segundo plano, para que tanto a extens√£o quanto seu aplicativo contenedor possam acessar os dados transferidos.

**Verificando se o Aplicativo Restringe o Uso de Extens√µes de Aplicativos**

√â poss√≠vel rejeitar um tipo espec√≠fico de extens√£o de aplicativo usando o seguinte m√©todo:

* [`application:shouldAllowExtensionPointIdentifier:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623122-application?language=objc)

No entanto, atualmente isso √© poss√≠vel apenas para extens√µes de aplicativos de "teclado personalizado" (e deve ser verificado ao testar aplicativos que lidam com dados sens√≠veis pelo teclado, como por exemplo, aplicativos banc√°rios).

### An√°lise Din√¢mica

Para a an√°lise din√¢mica, podemos fazer o seguinte para obter conhecimento sem ter o c√≥digo-fonte:

* Inspecionando os itens sendo compartilhados
* Identificando as extens√µes de aplicativos envolvidas

**Inspecionando os Itens Sendo Compartilhados**

Para isso, devemos interceptar `NSExtensionContext - inputItems` no aplicativo de origem dos dados.

Seguindo o exemplo anterior do Telegram, agora usaremos o bot√£o "Compartilhar" em um arquivo de texto (que foi recebido de um chat) para criar uma nota no aplicativo Notas com ele:

![](<../../.gitbook/assets/image (497).png>)

Se executarmos um rastreamento, ver√≠amos a seguinte sa√≠da:
```bash
(0x1c06bb420) NSExtensionContext - inputItems
0x18284355c Foundation!-[NSExtension _itemProviderForPayload:extensionContext:]
0x1828447a4 Foundation!-[NSExtension _loadItemForPayload:contextIdentifier:completionHandler:]
0x182973224 Foundation!__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S3__
0x182971968 Foundation!-[NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:]
0x182748830 Foundation!message_handler
0x181ac27d0 libxpc.dylib!_xpc_connection_call_event_handler
0x181ac0168 libxpc.dylib!_xpc_connection_mach_event
...
RET: (
"<NSExtensionItem: 0x1c420a540> - userInfo:
{
NSExtensionItemAttachmentsKey =     (
"<NSItemProvider: 0x1c46b30e0> {types = (\n \"public.plain-text\",\n \"public.file-url\"\n)}"
);
}"
)
```
Aqui podemos observar que:

* Isso ocorreu sob o cap√¥ via XPC, concretamente √© implementado atrav√©s de uma `NSXPCConnection` que usa o Framework `libxpc.dylib`.
* Os UTIs inclu√≠dos no `NSItemProvider` s√£o `public.plain-text` e `public.file-url`, sendo este √∫ltimo inclu√≠do na `NSExtensionActivationRule` do [`Info.plist` da "Share Extension" do Telegram](https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Share/Info.plist).

**Identificando as App Extensions Envolvidas**

Voc√™ tamb√©m pode descobrir qual app extension est√° cuidando das suas solicita√ß√µes e respostas ao interceptar `NSExtension - _plugIn`:

Executamos o mesmo exemplo novamente:
```bash
(0x1c0370200) NSExtension - _plugIn
RET: <PKPlugin: 0x1163637f0 ph.telegra.Telegraph.Share(5.3) 5B6DE177-F09B-47DA-90CD-34D73121C785
1(2) /private/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35
/Telegram X.app/PlugIns/Share.appex>

(0x1c0372300)  -[NSExtension _plugIn]
RET: <PKPlugin: 0x10bff7910 com.apple.mobilenotes.SharingExtension(1.5) 73E4F137-5184-4459-A70A-83
F90A1414DC 1(2) /private/var/containers/Bundle/Application/5E267B56-F104-41D0-835B-F1DAB9AE076D
/MobileNotes.app/PlugIns/com.apple.mobilenotes.SharingExtension.appex>
```
Como voc√™ pode ver, h√° duas extens√µes de aplicativo envolvidas:

* `Share.appex` est√° enviando o arquivo de texto (`public.plain-text` e `public.file-url`).
* `com.apple.mobilenotes.SharingExtension.appex` que est√° recebendo e processar√° o arquivo de texto.

Se voc√™ quiser aprender mais sobre o que est√° acontecendo nos bastidores em termos de XPC, recomendamos dar uma olhada nas chamadas internas de "libxpc.dylib". Por exemplo, voc√™ pode usar [`frida-trace`](https://www.frida.re/docs/frida-trace/) e depois investigar mais a fundo os m√©todos que achar mais interessantes, estendendo os stubs gerados automaticamente.

###

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
