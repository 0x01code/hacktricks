<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


Les sch√©mas d'URL personnalis√©s [permettent aux applications de communiquer via un protocole personnalis√©](https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple\_ref/doc/uid/TP40007072-CH6-SW1). Une application doit d√©clarer la prise en charge des sch√©mas et g√©rer les URL entrantes qui utilisent ces sch√©mas.

> Les sch√©mas d'URL offrent un vecteur d'attaque potentiel dans votre application, alors assurez-vous de **valider tous les param√®tres d'URL** et de **rejeter tout URL malform√©**. De plus, limitez les **actions** disponibles √† celles qui ne risquent pas les donn√©es de l'utilisateur.

Par exemple, l'URI : `myapp://hostname?data=123876123` **d√©clenchera** l'**application** mydata (celle qui a **enregistr√©** le sch√©ma `mydata`) pour l'**action** li√©e √† l'**hostname** `hostname` en envoyant le **param√®tre** `data` avec la valeur `123876123`.

Un exemple vuln√©rable est le [bug dans l'application mobile Skype](http://www.dhanjani.com/blog/2010/11/insecure-handling-of-url-schemes-in-apples-ios.html), d√©couvert en 2010 : l'application Skype a enregistr√© le gestionnaire de protocole `skype://`, ce qui a **permis √† d'autres applications de d√©clencher des appels vers d'autres utilisateurs Skype et des num√©ros de t√©l√©phone**. Malheureusement, Skype n'a pas demand√© la permission des utilisateurs avant de passer les appels, de sorte que n'importe quelle application pouvait appeler des num√©ros arbitraires sans la connaissance de l'utilisateur. Les attaquants ont exploit√© cette vuln√©rabilit√© en mettant en place un `<iframe src="skype://xxx?call"></iframe>` invisible (o√π `xxx` √©tait remplac√© par un num√©ro premium), de sorte que tout utilisateur Skype qui a visit√© involontairement un site Web malveillant a appel√© le num√©ro premium.

Vous pouvez trouver les **sch√©mas enregistr√©s par une application** dans le fichier **`Info.plist`** de l'application en recherchant **`CFBundleURLTypes`** (exemple de [iGoat-Swift](https://github.com/OWASP/iGoat-Swift)) :
```markup
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLName</key>
        <string>com.iGoat.myCompany</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>iGoat</string>
        </array>
    </dict>
</array>
```
Cependant, notez que les applications malveillantes peuvent r√©enregistrer des URI d√©j√† enregistr√©es par d'autres applications. Ainsi, si vous envoyez des informations sensibles via des URI (myapp://hostname?password=123456), une application malveillante peut intercepter l'URI avec les informations sensibles.

De plus, l'entr√©e de ces URI doit √™tre v√©rifi√©e et nettoy√©e, car elle peut provenir d'origines malveillantes cherchant √† exploiter des failles telles que les injections SQL, XSS, CSRF, les travers√©es de chemin ou d'autres vuln√©rabilit√©s possibles.

## Enregistrement des sch√©mas de requ√™te d'application

Les applications peuvent appeler [`canOpenURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc) pour v√©rifier que l'application cible est disponible. Cependant, comme cette m√©thode √©tait utilis√©e par des applications malveillantes pour √©num√©rer les applications install√©es, [√† partir d'iOS 9.0, les sch√©mas d'URL pass√©s doivent √©galement √™tre d√©clar√©s](https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc#discussion) en ajoutant la cl√© `LSApplicationQueriesSchemes` au fichier `Info.plist` de l'application et un tableau d'**au plus 50 sch√©mas d'URL**.
```markup
<key>LSApplicationQueriesSchemes</key>
    <array>
        <string>url_scheme1</string>
        <string>url_scheme2</string>
    </array>
```
`canOpenURL` renverra toujours `NO` pour les sch√©mas non d√©clar√©s, que l'application appropri√©e soit install√©e ou non. Cependant, cette restriction ne s'applique qu'√† `canOpenURL`.

## Test de la gestion et de la validation des URL

Afin de d√©terminer comment un chemin d'URL est construit et valid√©, si vous avez le code source original, vous pouvez **rechercher les m√©thodes suivantes** :

* M√©thode `application:didFinishLaunchingWithOptions:` ou `application:will-FinishLaunchingWithOptions:` : v√©rifiez comment la d√©cision est prise et comment les informations sur l'URL sont r√©cup√©r√©es.
* [`application:openURL:options:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623112-application?language=objc) : v√©rifiez comment la ressource est ouverte, c'est-√†-dire comment les donn√©es sont analys√©es, v√©rifiez les [options](https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey), en particulier si l'acc√®s par l'application appelante ([`sourceApplication`](https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey/1623128-sourceapplication)) doit √™tre autoris√© ou refus√©. L'application peut √©galement avoir besoin de l'autorisation de l'utilisateur lors de l'utilisation du sch√©ma d'URL personnalis√©.

Dans Telegram, vous trouverez [quatre m√©thodes diff√©rentes utilis√©es](https://github.com/peter-iakovlev/Telegram-iOS/blob/87e0a33ac438c1d702f2a0b75bf21f26866e346f/Telegram-iOS/AppDelegate.swift#L1250) :
```swift
func application(_ application: UIApplication, open url: URL, sourceApplication: String?) -> Bool {
    self.openUrl(url: url)
    return true
}

func application(_ application: UIApplication, open url: URL, sourceApplication: String?,
annotation: Any) -> Bool {
    self.openUrl(url: url)
    return true
}

func application(_ app: UIApplication, open url: URL,
options: [UIApplicationOpenURLOptionsKey : Any] = [:]) -> Bool {
    self.openUrl(url: url)
    return true
}

func application(_ application: UIApplication, handleOpen url: URL) -> Bool {
    self.openUrl(url: url)
    return true
}
```
## Tester les requ√™tes d'URL vers d'autres applications

La m√©thode [`openURL:options:completionHandler:`](https://developer.apple.com/documentation/uikit/uiapplication/1648685-openurl?language=objc) et la m√©thode [`openURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc) de `UIApplication` (d√©pr√©ci√©e) sont responsables de l'**ouverture d'URLs** (c'est-√†-dire pour envoyer des requ√™tes / faire des requ√™tes √† d'autres applications) qui peuvent √™tre locales √† l'application actuelle ou qui doivent √™tre fournies par une autre application. Si vous avez le code source original, vous pouvez rechercher directement les utilisations de ces m√©thodes.

De plus, si vous √™tes int√©ress√© √† savoir si l'application interroge des services ou des applications sp√©cifiques, et si l'application est bien connue, vous pouvez √©galement rechercher des sch√©mas d'URL courants en ligne et les inclure dans vos **greps (liste des sch√©mas d'applications iOS)**.
```bash
egrep -nr "open.*options.*completionHandler" ./Telegram-iOS/
egrep -nr "openURL\(" ./Telegram-iOS/
egrep -nr "mt-encrypted-file://" ./Telegram-iOS/
egrep -nr "://" ./Telegram-iOS/
```
## Test de m√©thodes obsol√®tes

Recherchez des m√©thodes obsol√®tes telles que :

* [`application:handleOpenURL:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622964-application?language=objc)
* [`openURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc)
* [`application:openURL:sourceApplication:annotation:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623073-application)

Par exemple, nous trouvons ces trois m√©thodes :
```bash
$ rabin2 -zzq Telegram\ X.app/Telegram\ X | grep -i "openurl"

0x1000d9e90 31 30 UIApplicationOpenURLOptionsKey
0x1000dee3f 50 49 application:openURL:sourceApplication:annotation:
0x1000dee71 29 28 application:openURL:options:
0x1000dee8e 27 26 application:handleOpenURL:
0x1000df2c9 9 8 openURL:
0x1000df766 12 11 canOpenURL:
0x1000df772 35 34 openURL:options:completionHandler:
...
```
## Appel d'URL arbitraires

* **Safari**: Pour tester rapidement un sch√©ma d'URL, vous pouvez ouvrir les URL sur Safari et observer le comportement de l'application. Par exemple, si vous √©crivez `tel://123456789`, Safari essaiera de commencer l'appel du num√©ro.
* **Notes App**: Appuyez longuement sur les liens que vous avez √©crits pour tester les sch√©mas d'URL personnalis√©s. N'oubliez pas de quitter le mode d'√©dition pour pouvoir les ouvrir. Notez que vous pouvez cliquer ou appuyer longuement sur des liens incluant des sch√©mas d'URL personnalis√©s uniquement si l'application est install√©e, sinon ils ne seront pas mis en √©vidence en tant que _liens cliquables_.
* [**IDB**](https://github.com/facebook/idb):
  * D√©marrez IDB, connectez-vous √† votre appareil et s√©lectionnez l'application cible. Vous pouvez trouver des d√©tails dans la [documentation IDB](https://www.idbtool.com/documentation/setup.html).
  * Allez √† la section **URL Handlers**. Dans les **URL schemes**, cliquez sur **Refresh**, et sur la gauche, vous trouverez une liste de tous les sch√©mas personnalis√©s d√©finis dans l'application test√©e. Vous pouvez charger ces sch√©mas en cliquant sur **Open**, sur le c√¥t√© droit. En ouvrant simplement un sch√©ma d'URI vide (par exemple, en ouvrant `myURLscheme://`), vous pouvez d√©couvrir des fonctionnalit√©s cach√©es (par exemple, une fen√™tre de d√©bogage) et contourner l'authentification locale.
*   **Frida**:

    Si vous voulez simplement ouvrir le sch√©ma d'URL, vous pouvez le faire en utilisant Frida :

    ```javascript
    $ frida -U iGoat-Swift

    [iPhone::iGoat-Swift]-> function openURL(url) {
                                var UIApplication = ObjC.classes.UIApplication.sharedApplication();
                                var toOpen = ObjC.classes.NSURL.URLWithString_(url);
                                return UIApplication.openURL_(toOpen);
                            }
    [iPhone::iGoat-Swift]-> openURL("tel://234234234")
    true
    ```

    Dans cet exemple de [Frida CodeShare](https://codeshare.frida.re/@dki/ios-url-scheme-fuzzing/), l'auteur utilise l'API non publique `LSApplicationWorkspace.openSensitiveURL:withOptions:` pour ouvrir les URL (√† partir de l'application SpringBoard) :

    ```javascript
    function openURL(url) {
        var w = ObjC.classes.LSApplicationWorkspace.defaultWorkspace();
        var toOpen = ObjC.classes.NSURL.URLWithString_(url);
        return w.openSensitiveURL_withOptions_(toOpen, null);
    }
    ```

    > Notez que l'utilisation d'API non publiques n'est pas autoris√©e sur l'App Store, c'est pourquoi nous ne les testons m√™me pas, mais nous sommes autoris√©s √† les utiliser pour notre analyse dynamique.

## Fuzzing des sch√©mas d'URL

Si l'application analyse des parties de l'URL, vous pouvez √©galement effectuer un fuzzing d'entr√©e pour d√©tecter des bugs de corruption de m√©moire.

Ce que nous avons appris ci-dessus peut maintenant √™tre utilis√© pour construire votre propre fuzzer dans le langage de votre choix, par exemple en Python, et appeler `openURL` en utilisant [RPC de Frida](https://www.frida.re/docs/javascript-api/#rpc). Ce fuzzer doit faire ce qui suit :

* G√©n√©rer des charges utiles.
* Pour chacun d'eux, appeler `openURL`.
* V√©rifier si l'application g√©n√®re un rapport de plantage (`.ips`) dans `/private/var/mobile/Library/Logs/CrashReporter`.

Le projet [FuzzDB](https://github.com/fuzzdb-project/fuzzdb) propose des dictionnaires de fuzzing que vous pouvez utiliser comme charges utiles.

## **Fuzzing avec Frida**

Faire cela avec Frida est assez facile, vous pouvez vous r√©f√©rer √† ce [blog post](https://grepharder.github.io/blog/0x03\_learning\_about\_universal\_links\_and\_fuzzing\_url\_schemes\_on\_ios\_with\_frida.html) pour voir un exemple qui fuzzes l'application iGoat-Swift (fonctionnant sur iOS 11.1.2).

Avant d'ex√©cuter le fuzzer, nous avons besoin des sch√©mas d'URL en tant qu'entr√©es. √Ä partir de l'analyse statique, nous savons que l'application iGoat-Swift prend en charge le sch√©ma d'URL et les param√®tres suivants : `iGoat://?contactNumber={0}&message={0}`.
```bash
$ frida -U SpringBoard -l ios-url-scheme-fuzzing.js
[iPhone::SpringBoard]-> fuzz("iGoat", "iGoat://?contactNumber={0}&message={0}")
Watching for crashes from iGoat...
No logs were moved.
Opened URL: iGoat://?contactNumber=0&message=0
```
# R√©f√©rences

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
