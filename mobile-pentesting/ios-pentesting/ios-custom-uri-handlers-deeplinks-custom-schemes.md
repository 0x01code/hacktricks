<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


Les sch√©mas d'URL personnalis√©s [permettent aux applications de communiquer via un protocole personnalis√©](https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple_ref/doc/uid/TP40007072-CH6-SW1). Une application doit d√©clarer la prise en charge des sch√©mas et g√©rer les URL entrantes qui utilisent ces sch√©mas.

> Les sch√©mas d'URL offrent un vecteur d'attaque potentiel dans votre application, alors assurez-vous de **valider tous les param√®tres d'URL** et de **rejeter toutes les URL malform√©es**. De plus, limitez les **actions** disponibles √† celles qui **ne risquent pas les donn√©es de l'utilisateur**.

Par exemple, l'URI : `myapp://hostname?data=123876123` va **invoquer** l'**application** mydata (celle qui a **enregistr√©** le sch√©ma `mydata`) pour l'**action** li√©e au **hostname** `hostname` en envoyant le **param√®tre** `data` avec la valeur `123876123`

Un exemple vuln√©rable est le suivant [bug dans l'application mobile Skype](http://www.dhanjani.com/blog/2010/11/insecure-handling-of-url-schemes-in-apples-ios.html), d√©couvert en 2010 : L'application Skype avait enregistr√© le gestionnaire de protocole `skype://`, qui **permettait √† d'autres applications de d√©clencher des appels vers d'autres utilisateurs de Skype et des num√©ros de t√©l√©phone**. Malheureusement, Skype ne demandait pas la permission aux utilisateurs avant de passer les appels, donc n'importe quelle application pouvait appeler des num√©ros arbitraires sans la connaissance de l'utilisateur. Les attaquants ont exploit√© cette vuln√©rabilit√© en pla√ßant un `<iframe src="skype://xxx?call"></iframe>` invisible (o√π `xxx` √©tait remplac√© par un num√©ro surtax√©), donc tout utilisateur de Skype qui visitait par inadvertance un site malveillant appelait le num√©ro surtax√©.

Vous pouvez trouver les **sch√©mas enregistr√©s par une application** dans le fichier **`Info.plist`** de l'application en cherchant **`CFBundleURLTypes`** (exemple de [iGoat-Swift](https://github.com/OWASP/iGoat-Swift)) :
```markup
<key>CFBundleURLTypes</key>
<array>
<dict>
<key>CFBundleURLName</key>
<string>com.iGoat.myCompany</string>
<key>CFBundleURLSchemes</key>
<array>
<string>iGoat</string>
</array>
</dict>
</array>
```
Cependant, notez que **les applications malveillantes peuvent r√©enregistrer des URI** d√©j√† enregistr√©es par des applications. Donc, si vous envoyez des **informations sensibles via des URI** (myapp://hostname?password=123456), une application **malveillante** peut **intercepter** l'URI avec les **informations** **sensibles**.

De plus, l'entr√©e de ces URI **doit √™tre v√©rifi√©e et assainie**, car elle peut provenir de **sources malveillantes** essayant d'exploiter des SQLInjections, XSS, CSRF, Path Traversals, ou d'autres vuln√©rabilit√©s possibles.

## Enregistrement des Sch√©mas de Requ√™te d'Application

Les applications peuvent appeler [`canOpenURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc) pour v√©rifier que **l'application cible est disponible**. Cependant, comme cette m√©thode √©tait utilis√©e par des applications malveillantes comme moyen de **recenser les applications install√©es**, [√† partir d'iOS 9.0, les sch√©mas d'URL pass√©s doivent √©galement √™tre d√©clar√©s](https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc#discussion) en ajoutant la cl√© `LSApplicationQueriesSchemes` au fichier `Info.plist` de l'application et un tableau de **jusqu'√† 50 sch√©mas d'URL**.
```markup
<key>LSApplicationQueriesSchemes</key>
<array>
<string>url_scheme1</string>
<string>url_scheme2</string>
</array>
```
## Test de la gestion et de la validation des URL

Pour d√©terminer comment un chemin d'URL est construit et valid√©, si vous avez le code source original, vous pouvez **rechercher les m√©thodes suivantes** :

* m√©thode `application:didFinishLaunchingWithOptions:` ou `application:willFinishLaunchingWithOptions:` : v√©rifiez comment la d√©cision est prise et comment les informations sur l'URL sont r√©cup√©r√©es.
* [`application:openURL:options:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623112-application?language=objc) : v√©rifiez comment la ressource est ouverte, c'est-√†-dire comment les donn√©es sont analys√©es, v√©rifiez les [options](https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey), surtout si l'acc√®s par l'application appelante ([`sourceApplication`](https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey/1623128-sourceapplication)) doit √™tre autoris√© ou refus√©. L'application peut √©galement n√©cessiter une permission de l'utilisateur lors de l'utilisation du sch√©ma d'URL personnalis√©.

Dans Telegram, vous [trouverez quatre m√©thodes diff√©rentes utilis√©es](https://github.com/peter-iakovlev/Telegram-iOS/blob/87e0a33ac438c1d702f2a0b75bf21f26866e346f/Telegram-iOS/AppDelegate.swift#L1250) :
```swift
func application(_ application: UIApplication, open url: URL, sourceApplication: String?) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ application: UIApplication, open url: URL, sourceApplication: String?,
annotation: Any) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ app: UIApplication, open url: URL,
options: [UIApplicationOpenURLOptionsKey : Any] = [:]) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ application: UIApplication, handleOpen url: URL) -> Bool {
self.openUrl(url: url)
return true
}
```
## Test des requ√™tes URL vers d'autres applications

La m√©thode [`openURL:options:completionHandler:`](https://developer.apple.com/documentation/uikit/uiapplication/1648685-openurl?language=objc) et la m√©thode [obsol√®te `openURL:` de `UIApplication`](https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc) sont responsables de **l'ouverture d'URLs** (c'est-√†-dire pour envoyer des requ√™tes / faire des interrogations vers d'autres applications) qui peuvent √™tre locales √† l'application courante ou qui doivent √™tre fournies par une application diff√©rente. Si vous avez le code source original, vous pouvez chercher directement les utilisations de ces m√©thodes.

De plus, si vous souhaitez savoir si l'application interroge des services ou des applications sp√©cifiques, et si l'application est bien connue, vous pouvez √©galement rechercher en ligne les sch√©mas d'URL courants et les inclure dans vos **greps ([**liste des sch√©mas d'applications iOS**](https://ios.gadgethacks.com/how-to/always-updated-list-ios-app-url-scheme-names-paths-for-shortcuts-0184033/)**)**.
```bash
egrep -nr "open.*options.*completionHandler" ./Telegram-iOS/
egrep -nr "openURL\(" ./Telegram-iOS/
egrep -nr "mt-encrypted-file://" ./Telegram-iOS/
egrep -nr "://" ./Telegram-iOS/
```
## Test des m√©thodes obsol√®tes

Recherchez des m√©thodes obsol√®tes telles que :

* [`application:handleOpenURL:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622964-application?language=objc)
* [`openURL:`](https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc)
* [`application:openURL:sourceApplication:annotation:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623073-application)

Par exemple, ici nous trouvons ces trois :
```bash
$ rabin2 -zzq Telegram\ X.app/Telegram\ X | grep -i "openurl"

0x1000d9e90 31 30 UIApplicationOpenURLOptionsKey
0x1000dee3f 50 49 application:openURL:sourceApplication:annotation:
0x1000dee71 29 28 application:openURL:options:
0x1000dee8e 27 26 application:handleOpenURL:
0x1000df2c9 9 8 openURL:
0x1000df766 12 11 canOpenURL:
0x1000df772 35 34 openURL:options:completionHandler:
...
```
## Appel d'URL arbitraires

* **Safari** : Pour tester rapidement un sch√©ma d'URL, vous pouvez ouvrir les URL dans Safari et observer le comportement de l'application. Par exemple, si vous √©crivez `tel://123456789`, Safari essaiera de commencer √† appeler le num√©ro.
* **Notes App** : Appuyez longuement sur les liens que vous avez √©crits pour tester des sch√©mas d'URL personnalis√©s. N'oubliez pas de quitter le mode d'√©dition pour pouvoir les ouvrir. Notez que vous pouvez cliquer ou appuyer longuement sur des liens incluant des sch√©mas d'URL personnalis√©s uniquement si l'application est install√©e, sinon ils ne seront pas mis en √©vidence comme _liens cliquables_.
* [**IDB**](https://github.com/facebook/idb) :
* Lancez IDB, connectez-vous √† votre appareil et s√©lectionnez l'application cible. Vous pouvez trouver des d√©tails dans la [documentation IDB](https://www.idbtool.com/documentation/setup.html).
* Allez dans la section **Gestionnaires d'URL**. Dans **Sch√©mas d'URL**, cliquez sur **Actualiser**, et sur la gauche vous trouverez une liste de tous les sch√©mas personnalis√©s d√©finis dans l'application test√©e. Vous pouvez charger ces sch√©mas en cliquant sur **Ouvrir**, sur le c√¥t√© droit. En ouvrant simplement un sch√©ma d'URI vide (par exemple, ouvrir `myURLscheme://`), vous pouvez d√©couvrir des fonctionnalit√©s cach√©es (par exemple, une fen√™tre de d√©bogage) et contourner l'authentification locale.
*   **Frida** :

Si vous souhaitez simplement ouvrir le sch√©ma d'URL, vous pouvez le faire en utilisant Frida :

```javascript
$ frida -U iGoat-Swift

[iPhone::iGoat-Swift]-> function openURL(url) {
var UIApplication = ObjC.classes.UIApplication.sharedApplication();
var toOpen = ObjC.classes.NSURL.URLWithString_(url);
return UIApplication.openURL_(toOpen);
}
[iPhone::iGoat-Swift]-> openURL("tel://234234234")
true
```

Dans cet exemple de [Frida CodeShare](https://codeshare.frida.re/@dki/ios-url-scheme-fuzzing/) l'auteur utilise l'API non publique `LSApplicationWorkspace.openSensitiveURL:withOptions:` pour ouvrir les URL (de l'application SpringBoard) :

```javascript
function openURL(url) {
var w = ObjC.classes.LSApplicationWorkspace.defaultWorkspace();
var toOpen = ObjC.classes.NSURL.URLWithString_(url);
return w.openSensitiveURL_withOptions_(toOpen, null);
}
```

> Notez que l'utilisation d'API non publiques n'est pas autoris√©e sur l'App Store, c'est pourquoi nous ne les testons m√™me pas mais nous sommes autoris√©s √† les utiliser pour notre analyse dynamique.

## Fuzzing de sch√©mas d'URL

Si l'application analyse des parties de l'URL, vous pouvez √©galement effectuer du fuzzing d'entr√©e pour d√©tecter des bugs de corruption de m√©moire.

Ce que nous avons appris ci-dessus peut maintenant √™tre utilis√© pour construire votre propre fuzzer dans le langage de votre choix, par exemple en Python, et appeler `openURL` en utilisant [RPC de Frida](https://www.frida.re/docs/javascript-api/#rpc). Ce fuzzer devrait faire ce qui suit :

* G√©n√©rer des charges utiles.
* Pour chacune d'elles, appeler `openURL`.
* V√©rifier si l'application g√©n√®re un rapport de plantage (`.ips`) dans `/private/var/mobile/Library/Logs/CrashReporter`.

Le projet [FuzzDB](https://github.com/fuzzdb-project/fuzzdb) propose des dictionnaires de fuzzing que vous pouvez utiliser comme charges utiles.

## **Fuzzing avec Frida**

Faire cela avec Frida est assez simple, vous pouvez vous r√©f√©rer √† ce [billet de blog](https://grepharder.github.io/blog/0x03\_learning\_about\_universal\_links\_and\_fuzzing\_url\_schemes\_on\_ios\_with\_frida.html) pour voir un exemple qui fuzz l'application iGoat-Swift (fonctionnant sur iOS 11.1.2).

Avant d'ex√©cuter le fuzzer, nous avons besoin des sch√©mas d'URL comme entr√©es. √Ä partir de l'analyse statique, nous savons que l'application iGoat-Swift prend en charge le sch√©ma d'URL et les param√®tres suivants : `iGoat://?contactNumber={0}&message={0}`.
```bash
$ frida -U SpringBoard -l ios-url-scheme-fuzzing.js
[iPhone::SpringBoard]-> fuzz("iGoat", "iGoat://?contactNumber={0}&message={0}")
Watching for crashes from iGoat...
No logs were moved.
Opened URL: iGoat://?contactNumber=0&message=0
```
# R√©f√©rences

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
