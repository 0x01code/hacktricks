<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する。

</details>


ユニバーサルリンクは、リダイレクトのためにSafariを経由せずに、**ユーザーを直接アプリにリダイレクト**することができます。\
ユニバーサルリンクは**ユニーク**であり、**他のアプリによって主張されることはありません**。なぜなら、ウェブサイトとアプリが関連していることを確認するためにファイルをアップロードしたウェブサイトへの標準的なHTTP(S)リンクを使用するからです。\
これらのリンクはHTTP(S)スキームを使用しているため、**アプリがインストールされていない場合は、Safariがリンクを開き**、ユーザーをページにリダイレクトします。これにより、**アプリがインストールされていなくてもアプリと通信することができます**。

ユニバーサルリンクを作成するには、詳細を含む`apple-app-site-association`というJSONファイルを**作成する必要があります**。その後、このファイルをウェブサーバーのルートディレクトリに**ホストする必要があります**（例：[https://google.com/apple-app-site-association](https://google.com/apple-app-site-association)）。\
ペネトレーションテスターにとって、このファイルはパスを**開示する**ため非常に興味深いものです。まだ公開されていないリリースのパスを開示している可能性もあります。

## ​**関連ドメインのエンタイトルメントをチェックする**

Xcodeで、**Capabilities**タブに移動し、**Associated Domains**を探します。または、`com.apple.developer.associated-domains`を探して`.entitlements`ファイルを調べることもできます。各ドメインは`applinks:`でプレフィックスを付ける必要があります。例えば`applinks:www.mywebsite.com`のように。

以下はTelegramの`.entitlements`ファイルからの例です：
```markup
<key>com.apple.developer.associated-domains</key>
<array>
<string>applinks:telegram.me</string>
<string>applinks:t.me</string>
</array>
```
詳細な情報は、[アーカイブされたApple Developer Documentation](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW2)で見つけることができます。

コンパイル済みのアプリケーションしかない場合は、以下のガイドに従ってentitlementsを抽出できます：

{% content-ref url="extracting-entitlements-from-compiled-application.md" %}
[extracting-entitlements-from-compiled-application.md](extracting-entitlements-from-compiled-application.md)
{% endcontent-ref %}

## **Apple App Site Associationファイルの取得**

前のステップで取得した関連ドメインを使用して、サーバーから`apple-app-site-association`ファイルを取得してください。このファイルは、`https://<domain>/apple-app-site-association` または `https://<domain>/.well-known/apple-app-site-association` でHTTPS経由でアクセス可能であり、リダイレクトがない必要があります。

ブラウザを使用して自分で取得するか、[Apple App Site Association (AASA) Validator](https://branch.io/resources/aasa-validator/)を使用できます。

## **リンク受信メソッドのチェック**

アプリがリンクを受け取り、適切に処理するためには、アプリデリゲートが[`application:continueUserActivity:restorationHandler:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623072-application)を実装する必要があります。元のプロジェクトを持っている場合は、このメソッドを探してみてください。

アプリが[`openURL:options:completionHandler:`](https://developer.apple.com/documentation/uikit/uiapplication/1648685-openurl?language=objc)を使用してアプリのウェブサイトへのユニバーサルリンクを開く場合、リンクはアプリ内で開かれません。呼び出しがアプリから発生するため、ユニバーサルリンクとして処理されません。

* `webpageURL`のスキームはHTTPまたはHTTPSでなければなりません（他のスキームは例外を投げるべきです）。`URLComponents` / `NSURLComponents`の[`scheme`インスタンスプロパティ](https://developer.apple.com/documentation/foundation/urlcomponents/1779624-scheme)を使用してこれを確認できます。

## **データハンドラーメソッドのチェック**

iOSがユニバーサルリンクの結果としてアプリを開くとき、アプリは`NSUserActivityTypeBrowsingWeb`の`activityType`値を持つ`NSUserActivity`オブジェクトを受け取ります。アクティビティオブジェクトの`webpageURL`プロパティには、ユーザーがアクセスするHTTPまたはHTTPS URLが含まれています。以下のSwiftの例は、URLを開く前にこれを正確に検証します：
```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity,
restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
// ...
if userActivity.activityType == NSUserActivityTypeBrowsingWeb, let url = userActivity.webpageURL {
application.open(url, options: [:], completionHandler: nil)
}

return true
}
```
さらに、URLにパラメータが含まれている場合、それらは信頼されたドメインから来たとしても、慎重にサニタイズされ、検証されるまでは信用してはいけません。例えば、攻撃者によって偽装されていたり、不正なデータを含んでいる可能性があります。そのような場合、URL全体、そしてその結果としてのユニバーサルリンクリクエストは破棄されなければなりません。

`NSURLComponents` APIは、URLのコンポーネントを解析し、操作するために使用できます。これは、`application:continueUserActivity:restorationHandler:` メソッド自体の一部としても、またはそれから呼び出される別のメソッドで行われることもあります。以下の[例](https://developer.apple.com/documentation/uikit/core\_app/allowing\_apps\_and\_websites\_to\_link\_to\_your\_content/handling\_universal\_links#3001935)がこれを示しています：
```swift
func application(_ application: UIApplication,
continue userActivity: NSUserActivity,
restorationHandler: @escaping ([Any]?) -> Void) -> Bool {
guard userActivity.activityType == NSUserActivityTypeBrowsingWeb,
let incomingURL = userActivity.webpageURL,
let components = NSURLComponents(url: incomingURL, resolvingAgainstBaseURL: true),
let path = components.path,
let params = components.queryItems else {
return false
}

if let albumName = params.first(where: { $0.name == "albumname" })?.value,
let photoIndex = params.first(where: { $0.name == "index" })?.value {
// Interact with album name and photo index

return true

} else {
// Handle when album and/or album name or photo index missing

return false
}
}
```
# 参考文献

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
