```markdown
<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


El [`UIPasteboard`](https://developer.apple.com/documentation/uikit/uipasteboard) permite compartir datos dentro de una aplicaci√≥n y de una aplicaci√≥n a otras aplicaciones. Hay dos tipos de portapapeles:

* **portapapeles general del sistema**: para compartir datos con **cualquier aplicaci√≥n**. Persistente por defecto tras reinicios del dispositivo y desinstalaciones de aplicaciones (desde iOS 10).
* **portapapeles personalizados / con nombre**: para compartir datos **con otra aplicaci√≥n** (que tenga el mismo ID de equipo que la aplicaci√≥n desde la que se comparte) o con la **misma aplicaci√≥n** (solo est√°n disponibles en el proceso que los crea). No persistentes por defecto (desde iOS 10), es decir, existen solo hasta que la aplicaci√≥n propietaria (creadora) se cierra.

Algunas consideraciones de seguridad:

* Los usuarios **no pueden otorgar o denegar permiso** para que las aplicaciones lean el **portapapeles**.
* Desde iOS 9, las aplicaciones [no pueden acceder al portapapeles en segundo plano](https://forums.developer.apple.com/thread/13760), esto mitiga la monitorizaci√≥n del portapapeles en segundo plano.
* [Apple advierte sobre los portapapeles con nombre persistentes](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc) y **desaconseja su uso**. En su lugar, se deben utilizar contenedores compartidos.
* A partir de iOS 10 hay una nueva caracter√≠stica de Handoff llamada **Portapapeles Universal** que est√° habilitada por defecto. Permite que el **contenido del portapapeles general se transfiera autom√°ticamente entre dispositivos**. Esta caracter√≠stica puede ser deshabilitada si el desarrollador as√≠ lo decide y tambi√©n es posible establecer un tiempo y fecha de expiraci√≥n para los datos copiados.

Entonces, es importante **verificar que la informaci√≥n sensible no se est√© guardando dentro del portapapeles global**.\
Tambi√©n es importante comprobar que una **aplicaci√≥n no est√© utilizando los datos del portapapeles global para realizar acciones**, ya que una aplicaci√≥n maliciosa podr√≠a manipular estos datos.

Una **aplicaci√≥n tambi√©n puede evitar que sus usuarios copien datos sensibles al portapapeles** (lo cual es recomendable).

## An√°lisis Est√°tico

El **portapapeles general del sistema** se puede obtener utilizando [`generalPasteboard`](https://developer.apple.com/documentation/uikit/uipasteboard/1622106-generalpasteboard?language=objc), busca en el c√≥digo fuente o en el binario compilado este m√©todo. Se debe evitar el uso del portapapeles general del sistema al tratar con datos sensibles.

**Portapapeles personalizados** se pueden crear con [`pasteboardWithName:create:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622074-pasteboardwithname?language=objc) o [`pasteboardWithUniqueName`](https://developer.apple.com/documentation/uikit/uipasteboard/1622087-pasteboardwithuniquename?language=objc). Verifica si los portapapeles personalizados est√°n configurados para ser persistentes ya que esto est√° obsoleto desde iOS 10. En su lugar, se debe utilizar un contenedor compartido.

## An√°lisis Din√°mico

Engancha o rastrea lo siguiente:

* `generalPasteboard` para el portapapeles general del sistema.
* `pasteboardWithName:create:` y `pasteboardWithUniqueName` para portapapeles personalizados.

Tambi√©n puedes enganchar o rastrear el m√©todo obsoleto [`setPersistent:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622096-setpersistent?language=objc) y verificar si se est√° llamando.

Cuando **monitorees** los **portapapeles**, hay varios **detalles** que pueden ser **recuperados** din√°micamente:

* Obt√©n el **nombre del portapapeles** enganchando `pasteboardWithName:create:` e inspeccionando sus par√°metros de entrada o `pasteboardWithUniqueName` e inspeccionando su valor de retorno.
* Consigue el **primer elemento disponible en el portapapeles**: por ejemplo, para cadenas usa el m√©todo `string`. O utiliza cualquiera de los otros m√©todos para los [tipos de datos est√°ndar](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#1654275).
* Obt√©n el **n√∫mero de elementos** con `numberOfItems`.
* Verifica la **existencia de tipos de datos est√°ndar** con los [m√©todos de conveniencia](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#2107142), por ejemplo, `hasImages`, `hasStrings`, `hasURLs` (a partir de iOS 10).
* Verifica **otros tipos de datos** (t√≠picamente UTIs) con [`containsPasteboardTypes:inItemSet:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622100-containspasteboardtypes?language=objc). Puedes inspeccionar tipos de datos m√°s concretos como, por ejemplo, una imagen como public.png y public.tiff ([UTIs](http://web.archive.org/web/20190616231857/https://developer.apple.com/documentation/mobilecoreservices/uttype)) o para datos personalizados como com.mycompany.myapp.mytype. Recuerda que, en este caso, solo aquellas aplicaciones que _declaren conocimiento_ del tipo son capaces de entender los datos escritos en el portapapeles. Recup√©ralos utilizando [`itemSetWithPasteboardTypes:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622071-itemsetwithpasteboardtypes?language=objc) y estableciendo los UTIs correspondientes.
* Verifica elementos excluidos o que expiran enganchando `setItems:options:` e inspeccionando sus opciones para `UIPasteboardOptionLocalOnly` o `UIPasteboardOptionExpirationDate`.

Si solo buscas cadenas, quiz√°s quieras usar el comando de **objection** `ios pasteboard monitor`:

> Se engancha a la clase UIPasteboard de iOS y sondea el generalPasteboard cada 5 segundos en busca de datos. Si se encuentran datos nuevos, diferentes de la sondeo anterior, esos datos se volcar√°n en pantalla.

Tambi√©n puedes construir tu propio monitor de portapapeles que monitoree informaci√≥n espec√≠fica como se ha visto anteriormente.

Por ejemplo, este script (inspirado en el script detr√°s del [monitor de portapapeles de objection](https://github.com/sensepost/objection/blob/b39ee53b5ba2e9a271797d2f3931d79c46dccfdb/agent/src/ios/pasteboard.ts)) lee los elementos del portapapeles cada 5 segundos, si hay algo nuevo lo imprimir√°:
```
```javascript
const UIPasteboard = ObjC.classes.UIPasteboard;
const Pasteboard = UIPasteboard.generalPasteboard();
var items = "";
var count = Pasteboard.changeCount().toString();

setInterval(function () {
const currentCount = Pasteboard.changeCount().toString();
const currentItems = Pasteboard.items().toString();

if (currentCount === count) { return; }

items = currentItems;
count = currentCount;

console.log('[* Pasteboard changed] count: ' + count +
' hasStrings: ' + Pasteboard.hasStrings().toString() +
' hasURLs: ' + Pasteboard.hasURLs().toString() +
' hasImages: ' + Pasteboard.hasImages().toString());
console.log(items);

}, 1000 * 5);
```
# Referencias

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
