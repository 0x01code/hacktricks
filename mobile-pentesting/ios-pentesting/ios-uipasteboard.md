<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在 HackTricks 中看到你的**公司广告**吗？或者你想获得**PEASS 的最新版本或下载 HackTricks 的 PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 上**关注**我 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向 [hacktricks 仓库](https://github.com/carlospolop/hacktricks) 和 [hacktricks-cloud 仓库](https://github.com/carlospolop/hacktricks-cloud) 提交 PR 来分享你的黑客技巧**。

</details>


[`UIPasteboard`](https://developer.apple.com/documentation/uikit/uipasteboard) 可以在应用程序内部和应用程序之间共享数据。有两种类型的剪贴板：

* **系统范围的通用剪贴板**：用于与**任何应用程序**共享数据。默认情况下，设备重新启动和应用程序卸载后仍然保留（自 iOS 10 起）。
* **自定义/命名的剪贴板**：用于与**另一个应用程序**（与要共享的应用程序具有相同的团队 ID）或**应用程序本身**共享数据（它们仅在创建它们的进程中可用）。默认情况下，非持久性（自 iOS 10 起），即它们仅在拥有（创建）应用程序退出之前存在。

一些安全注意事项：

* 用户**无法授予或拒绝**应用程序读取**剪贴板**的权限。
* 自 iOS 9 起，应用程序[无法在后台访问剪贴板](https://forums.developer.apple.com/thread/13760)，这可以减轻后台剪贴板监控的风险。
* [Apple 警告关于持久命名的剪贴板](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc)并**不鼓励使用**。应该使用共享容器。
* 从 iOS 10 开始，有一个名为**通用剪贴板**的新的 Handoff 功能，默认情况下启用。它允许**通用剪贴板内容在设备之间自动传输**。如果开发人员选择这样做，可以禁用此功能，并且还可以为复制的数据设置过期时间和日期。

因此，重要的是**检查敏感信息是否保存在全局剪贴板中**。\
还要检查应用程序是否使用全局剪贴板数据执行操作，因为恶意应用程序可能篡改这些数据。

一个应用程序还可以阻止其用户将敏感数据复制到剪贴板中（这是推荐的做法）。

## 静态分析

可以使用 [`generalPasteboard`](https://developer.apple.com/documentation/uikit/uipasteboard/1622106-generalpasteboard?language=objc) 获取**系统范围的通用剪贴板**，搜索源代码或编译后的二进制文件以查找此方法。在处理敏感数据时，应避免使用系统范围的通用剪贴板。

可以使用 [`pasteboardWithName:create:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622074-pasteboardwithname?language=objc) 或 [`pasteboardWithUniqueName`](https://developer.apple.com/documentation/uikit/uipasteboard/1622087-pasteboardwithuniquename?language=objc) 创建**自定义剪贴板**。验证自定义剪贴板是否设置为持久性，因为自 iOS 10 起已弃用此功能。应改用共享容器。

## 动态分析

Hook 或跟踪以下内容：

* 对于系统范围的通用剪贴板，使用 `generalPasteboard`。
* 对于自定义剪贴板，使用 `pasteboardWithName:create:` 和 `pasteboardWithUniqueName`。

还可以 Hook 或跟踪已弃用的 [`setPersistent:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622096-setpersistent?language=objc) 方法，并验证是否调用了该方法。

在**监视**剪贴板时，可以动态检索以下**详细信息**：

* 通过 Hook `pasteboardWithName:create:` 并检查其输入参数或 `pasteboardWithUniqueName` 并检查其返回值，获取**剪贴板名称**。
* 获取**第一个可用的剪贴板项**：例如，对于字符串，使用 `string` 方法。或使用其他方法获取[标准数据类型](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#1654275)的数据。
* 使用 `numberOfItems` 获取**项目数量**。
* 使用[便捷方法](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#2107142)（自 iOS 10 起）检查**标准数据类型**的存在，例如 `hasImages`、`hasStrings`、`hasURLs`。
* 使用 [`containsPasteboardTypes:inItemSet:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622100-containspasteboardtypes?language=objc) 检查**其他数据类型**（通常是 UTI）。可以检查更具体的数据类型，例如公共.png 和公共.tiff（[UTI](http://web.archive.org/web/20190616231857/https://developer.apple.com/documentation/mobilecoreservices/uttype)），或自定义数据类型，例如 com.mycompany.myapp.mytype。请记住，只有那些“声明了了解”该类型的应用程序才能理解写入剪贴板的数据。使用 [`itemSetWithPasteboardTypes:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622071-itemsetwithpasteboardtypes?language=objc) 并设置相应的 UTI 来检索它们。
* 通过 Hook `setItems:options:` 并检查其选项中的 `UIPasteboardOptionLocalOnly` 或 `UIPasteboardOptionExpirationDate`，检查排除或过期的项目。

如果只想查找字符串，可以使用 **objection** 的 `ios pasteboard monitor` 命令：

> 钩入 iOS UIPasteboard 类并每 5 秒轮询 generalPasteboard 以获取数据。如果找到与上一次轮询不同的新数据，将将其输出到屏幕上。

您还可以构建自己的剪贴板监视器，监视上述特定信息。
例如，这个脚本（灵感来自于[objection的剪贴板监视器](https://github.com/sensepost/objection/blob/b39ee53b5ba2e9a271797d2f3931d79c46dccfdb/agent/src/ios/pasteboard.ts)的脚本）每5秒读取一次剪贴板项目，如果有新内容，将打印出来：
```javascript
const UIPasteboard = ObjC.classes.UIPasteboard;
const Pasteboard = UIPasteboard.generalPasteboard();
var items = "";
var count = Pasteboard.changeCount().toString();

setInterval(function () {
const currentCount = Pasteboard.changeCount().toString();
const currentItems = Pasteboard.items().toString();

if (currentCount === count) { return; }

items = currentItems;
count = currentCount;

console.log('[* Pasteboard changed] count: ' + count +
' hasStrings: ' + Pasteboard.hasStrings().toString() +
' hasURLs: ' + Pasteboard.hasURLs().toString() +
' hasImages: ' + Pasteboard.hasImages().toString());
console.log(items);

}, 1000 * 5);
```
# 参考资料

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？想要在 HackTricks 中**宣传你的公司**吗？或者想要**获取 PEASS 的最新版本或下载 HackTricks 的 PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者**关注**我在**推特**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks 仓库](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud 仓库](https://github.com/carlospolop/hacktricks-cloud)提交 PR 来分享你的黑客技巧**。

</details>
