```markdown
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) を使って AWS ハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告掲載したい場合**や **HackTricks を PDF でダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) コレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)や [**telegram グループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** の [**GitHub リポジトリ**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングテクニックを共有する。

</details>


[`UIPasteboard`](https://developer.apple.com/documentation/uikit/uipasteboard) は、アプリ内でのデータ共有、およびアプリから他のアプリへのデータ共有を可能にします。ペーストボードには2種類あります：

* **システム全体の一般ペーストボード**：**任意のアプリ**とデータを共有するためのもの。デフォルトでデバイスの再起動やアプリのアンインストールを越えて永続化されます（iOS 10以降）。
* **カスタム/名前付きペーストボード**：**別のアプリ**（共有元のアプリと同じチームIDを持つ）や**アプリ自体**とデータを共有するためのもの（それらは作成したプロセス内でのみ利用可能）。デフォルトでは非永続化（iOS 10以降）、つまり所有（作成）アプリが終了するまでのみ存在します。

セキュリティ上の考慮事項：

* ユーザーはアプリが**ペーストボード**を読むための**許可を与えたり拒否したりすることはできません**。
* iOS 9以降、アプリは[バックグラウンドでペーストボードにアクセスできなくなりました](https://forums.developer.apple.com/thread/13760)。これにより、バックグラウンドでのペーストボード監視が緩和されます。
* [Apple は永続的な名前付きペーストボードについて警告しており](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc)、その使用を**推奨していません**。代わりに共有コンテナを使用するべきです。
* iOS 10からは、デフォルトで有効になっている新しいHandoff機能である**Universal Clipboard**が導入されました。これにより、**一般ペーストボードの内容がデバイス間で自動的に転送される**ようになります。開発者が選択した場合、この機能は無効にすることができ、コピーされたデータに対して有効期限と日付を設定することも可能です。

したがって、**機密情報がグローバルペーストボード内に保存されていないことを確認することが重要です**。\
また、**アプリケーションがグローバルペーストボードのデータを使用してアクションを実行していないことを確認することも重要です**。悪意のあるアプリケーションがこのデータを改ざんする可能性があります。

**アプリケーションは、ユーザーがクリップボードに機密データをコピーすることを防ぐこともできます**（推奨されます）。

## 静的分析

**システム全体の一般ペーストボード**は、[`generalPasteboard`](https://developer.apple.com/documentation/uikit/uipasteboard/1622106-generalpasteboard?language=objc)を使用して取得できます。ソースコードまたはコンパイル済みバイナリでこのメソッドを検索します。機密データを扱う際には、システム全体の一般ペーストボードの使用は避けるべきです。

**カスタムペーストボード**は、[`pasteboardWithName:create:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622074-pasteboardwithname?language=objc)または[`pasteboardWithUniqueName`](https://developer.apple.com/documentation/uikit/uipasteboard/1622087-pasteboardwithuniquename?language=objc)で作成できます。iOS 10以降非推奨とされているため、カスタムペーストボードが永続化されるように設定されているかを確認してください。代わりに共有コンテナを使用すべきです。

## 動的分析

以下をフックまたはトレースします：

* システム全体の一般ペーストボードに対しては `generalPasteboard`。
* カスタムペーストボードに対しては `pasteboardWithName:create:` と `pasteboardWithUniqueName`。

非推奨の [`setPersistent:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622096-setpersistent?language=objc) メソッドもフックまたはトレースし、呼び出されているかを確認することができます。

**ペーストボードを監視**する際には、以下のような**詳細**を動的に**取得**することができます：

* `pasteboardWithName:create:` をフックして入力パラメータを検査するか、`pasteboardWithUniqueName` をフックしてその戻り値を検査することで、**ペーストボード名を取得**します。
* **最初に利用可能なペーストボードアイテムを取得**します：例えば文字列の場合は `string` メソッドを使用します。または、[標準データタイプ](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#1654275)の他のメソッドを使用します。
* `numberOfItems` で**アイテム数を取得**します。
* [便利なメソッド](https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#2107142)を使用して、**標準データタイプの存在を確認**します。例えば `hasImages`、`hasStrings`、`hasURLs` など（iOS 10から開始）。
* [`containsPasteboardTypes:inItemSet:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622100-containspasteboardtypes?language=objc) を使用して、**他のデータタイプ**（通常はUTI）を確認します。例えば、public.png や public.tiff（[UTI](http://web.archive.org/web/20190616231857/https://developer.apple.com/documentation/mobilecoreservices/uttype)）のような具体的なデータタイプや、com.mycompany.myapp.mytype のようなカスタムデータを検査します。この場合、ペーストボードに書き込まれたデータを理解できるのは、そのタイプを_宣言している_アプリのみです。[`itemSetWithPasteboardTypes:`](https://developer.apple.com/documentation/uikit/uipasteboard/1622071-itemsetwithpasteboardtypes?language=objc) を使用して対応するUTIを設定して取得します。
* `setItems:options:` をフックして、`UIPasteboardOptionLocalOnly` や `UIPasteboardOptionExpirationDate` などのオプションを検査することで、除外されたアイテムや有効期限のあるアイテムを確認します。

文字列のみを探している場合は、**objection** のコマンド `ios pasteboard monitor` を使用すると良いでしょう：

> iOS UIPasteboard クラスにフックし、5秒ごとに generalPasteboard のデータをポーリングします。新しいデータが見つかり、前回のポーリングと異なる場合、そのデータが画面に表示されます。

また、上記で見たような特定の情報を監視する独自のペーストボードモニターを構築することもできます。

例えば、このスクリプト（[objectionのペーストボードモニター](https://github.com/sensepost/objection/blob/b39ee53b5ba2e9a271797d2f3931d79c46dccfdb/agent/src/ios/pasteboard.ts)の背後にあるスクリプトから着想を得て）は、5秒ごとにペーストボードアイテムを読み取り、新しいものがあればそれを印刷します：
```
```javascript
const UIPasteboard = ObjC.classes.UIPasteboard;
const Pasteboard = UIPasteboard.generalPasteboard();
var items = "";
var count = Pasteboard.changeCount().toString();

setInterval(function () {
const currentCount = Pasteboard.changeCount().toString();
const currentItems = Pasteboard.items().toString();

if (currentCount === count) { return; }

items = currentItems;
count = currentCount;

console.log('[* Pasteboard changed] count: ' + count +
' hasStrings: ' + Pasteboard.hasStrings().toString() +
' hasURLs: ' + Pasteboard.hasURLs().toString() +
' hasImages: ' + Pasteboard.hasImages().toString());
console.log(items);

}, 1000 * 5);
```
# 参考文献

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキング</strong>をゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
