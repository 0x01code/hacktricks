<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>

# Privilegentrennung und Sandbox

In iOS besteht ein Unterschied in den Privilegien zwischen den f√ºr Benutzer zug√§nglichen Anwendungen und den Kernprozessen des Systems. Anwendungen werden unter der Benutzeridentit√§t **`mobile`** ausgef√ºhrt, w√§hrend die wichtigen Systemprozesse als **`root`** arbeiten. Diese Trennung wird durch einen Sandbox-Mechanismus verst√§rkt, der strenge Einschr√§nkungen f√ºr die Aktionen auferlegt, die Anwendungen durchf√ºhren k√∂nnen. Zum Beispiel ist es Anwendungen, auch wenn sie dieselbe Benutzeridentit√§t teilen, untersagt, auf die Daten anderer Anwendungen zuzugreifen oder diese zu √§ndern.

Anwendungen werden in einem bestimmten Verzeichnis (`private/var/mobile/Applications/{zuf√§llige ID}`) installiert und haben eingeschr√§nkten Lesezugriff auf bestimmte Systembereiche und -funktionen, wie SMS und Telefonanrufe. Der Zugriff auf gesch√ºtzte Bereiche l√∂st eine Popup-Anfrage zur Benutzerberechtigung aus.

# Datenschutz

iOS bietet Entwicklern die **Data Protection APIs**, die auf dem Secure Enclave Processor (SEP) aufbauen - einem dedizierten Coprozessor f√ºr kryptografische Operationen und Schl√ºsselverwaltung. Der SEP gew√§hrleistet die Integrit√§t des Datenschutzes durch einen eindeutigen ger√§tespezifischen Schl√ºssel, die Ger√§te-UID, die darin eingebettet ist.

Bei der Erstellung einer Datei wird ein eindeutiger 256-Bit-AES-Verschl√ºsselungsschl√ºssel generiert, der den Inhalt der Datei verschl√ºsselt. Dieser Verschl√ºsselungsschl√ºssel wird zusammen mit einer Klassen-ID mit einem Klassenschl√ºssel verschl√ºsselt und in den Metadaten der Datei gespeichert. Das Entschl√ºsseln einer Datei beinhaltet die Verwendung des Systemschl√ºssels zum Zugriff auf die Metadaten, das Abrufen des Klassenschl√ºssels mit der Klassen-ID und anschlie√üend das Entschl√ºsseln des eindeutigen Verschl√ºsselungsschl√ºssels der Datei.

iOS definiert **vier Schutzklassen** f√ºr die Datensicherheit, die bestimmen, wann und wie auf Daten zugegriffen werden kann:

- **Vollst√§ndiger Schutz (NSFileProtectionComplete)**: Daten sind nicht zug√§nglich, bis das Ger√§t mit dem Passcode des Benutzers entsperrt wird.
- **Gesch√ºtzt, es sei denn, ge√∂ffnet (NSFileProtectionCompleteUnlessOpen)**: Erm√∂glicht den Dateizugriff auch nach dem Sperren des Ger√§ts, sofern die Datei ge√∂ffnet wurde, als das Ger√§t entsperrt war.
- **Gesch√ºtzt bis zur ersten Benutzerauthentifizierung (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Daten sind nach der ersten Benutzerentsperrung nach dem Booten zug√§nglich und bleiben auch dann zug√§nglich, wenn das Ger√§t erneut gesperrt wird.
- **Kein Schutz (NSFileProtectionNone)**: Daten sind nur durch die Ger√§te-UID gesch√ºtzt und erm√∂glichen schnelles L√∂schen von Remote-Daten.

Die Verschl√ºsselung aller Klassen, au√üer `NSFileProtectionNone`, erfolgt mit einem Schl√ºssel, der sowohl aus der Ger√§te-UID als auch aus dem Passcode des Benutzers abgeleitet wird, um sicherzustellen, dass die Entschl√ºsselung nur auf dem Ger√§t mit dem richtigen Passcode m√∂glich ist. Ab iOS 7 ist die Standard-Schutzklasse "Gesch√ºtzt bis zur ersten Benutzerauthentifizierung".

Entwickler k√∂nnen [**FileDP**](https://github.com/abjurato/FileDp-Source) verwenden, ein Tool zum √úberpr√ºfen der Datenschutzklasse von Dateien auf einem iPhone.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Der Schl√ºsselbund**

In iOS dient ein **Schl√ºsselbund** als sicherer **verschl√ºsselter Container** zum Speichern von **sensiblen Informationen**, der nur von der Anwendung, die sie gespeichert hat, oder von explizit autorisierten Anwendungen zug√§nglich ist. Diese Verschl√ºsselung wird durch ein einzigartiges **von iOS generiertes Passwort** verst√§rkt, das selbst mit **AES** verschl√ºsselt ist. Dieser Verschl√ºsselungsprozess nutzt eine **PBKDF2-Funktion**, die den Passcode des Benutzers mit einem aus der **UID** des Ger√§ts abgeleiteten Salt kombiniert, auf den nur der **sichere Enklaven-Chipsatz** zugreifen kann. Selbst wenn der Passcode des Benutzers bekannt ist, bleiben die Inhalte des Schl√ºsselbunds auf jedem anderen Ger√§t als demjenigen, auf dem sie urspr√ºnglich verschl√ºsselt wurden, unzug√§nglich.

**Die Verwaltung und der Zugriff** auf die Daten des Schl√ºsselbunds werden vom **`securityd`-Daemon** √ºber spezifische App-Berechtigungen wie `Keychain-access-groups` und `application-identifier` gehandhabt.

### **Keychain-API-Operationen**

Die Keychain-API, die in der [Dokumentation von Apple zu Keychain Services](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html) detailliert beschrieben ist, bietet wesentliche Funktionen f√ºr das Management der sicheren Speicherung:

- **`SecItemAdd`**: F√ºgt dem Schl√ºsselbund einen neuen Eintrag hinzu.
- **`SecItemUpdate`**: Aktualisiert einen vorhandenen Eintrag im Schl√ºsselbund.
- **`SecItemCopyMatching`**: Ruft einen Eintrag aus dem Schl√ºsselbund ab.
- **`SecItemDelete`**: Entfernt einen Eintrag aus dem Schl√ºsselbund.

Das Brute-Forcing des Schl√ºsselbund-Passworts beinhaltet entweder den direkten Angriff auf den verschl√ºsselten Schl√ºssel oder den Versuch, den Passcode auf dem Ger√§t selbst zu erraten, wobei die Durchsetzung einer Verz√∂gerung zwischen fehlgeschlagenen Versuchen durch den sicheren Enklaven-Chipsatz erheblich behindert wird.

### **Konfiguration des Schutzes von Schl√ºsselbunddaten**

Die Schutzstufen f√ºr Schl√ºsselbundeintr√§ge werden mithilfe des Attributs `kSecAttrAccessible` w√§hrend der Erstellung oder Aktualisierung des Eintrags festgelegt. Diese Stufen, [wie von Apple angegeben](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), bestimmen, wann und wie Schl√ºsselbundeintr√§ge zug√§nglich sind:

- **`kSecAttrAccessibleAlways`**: Jederzeit zug√§nglich, unabh√§ngig vom Sperrstatus des Ger√§ts.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Immer zug√§nglich, aber nicht in Backups enthalten.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Nach dem ersten Entsperren nach dem Neustart zug√§nglich.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Wie oben, aber nicht auf neue Ger√§te √ºbertragbar.
- **`kSecAttrAccessibleWhenUnlocked`**: Nur zug√§nglich, wenn das Ger√§t entsperrt ist.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Zug√§nglich, wenn entsperrt, nicht in Backups enthalten.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Erfordert Ger√§te-Passcode, nicht in Backups enthalten.

**`AccessControlFlags`** verfeinern den Zugriff weiter und erm√∂glichen die biometrische Authentifizierung oder die Verwendung des Passcodes.

### **Warnung bei gejailbreakten Ger√§ten**

{% hint style="warning" %}
Auf **gejailbreakten Ger√§ten** sind die Schutzma√ünahmen des Schl√ºsselbunds beeintr√§chtigt und stellen ein erhebliches Sicherheitsrisiko dar.
{% endhint %}

### **Persistenz von Schl√ºsselbunddaten**

Im Gegensatz zu app-spezifischen Daten, die beim Deinstallieren der App gel√∂scht werden, bleiben **Schl√ºsselbunddaten** auf dem Ger√§t erhalten. Diese Eigenschaft k√∂nnte es neuen Besitzern eines gebrauchten Ger√§ts erm√∂glichen, einfach durch erneutes Installieren von Apps auf die Anwendungsdaten des vorherigen Besitzers zuzugreifen. Entwickler werden empfohlen, proaktiv Schl√ºsselbunddaten beim Installieren der App oder beim Abmelden zu l√∂schen, um dieses Risiko zu mindern. Hier ist ein Swift-Code-Beispiel, das zeigt, wie man Schl√ºsselbunddaten beim ersten Start der App l√∂scht:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **App-F√§higkeiten**

Im Bereich der App-Entwicklung spielt **Sandboxing** eine entscheidende Rolle bei der Verbesserung der Sicherheit. Dieser Prozess stellt sicher, dass jede App in ihrem eigenen eindeutigen Home-Verzeichnis arbeitet und somit keinen Zugriff auf Systemdateien oder Daten anderer Apps hat. Die Durchsetzung dieser Einschr√§nkungen erfolgt durch Sandbox-Richtlinien, die Teil des **Trusted BSD (MAC) Mandatory Access Control Frameworks** sind.

Entwickler haben die M√∂glichkeit, bestimmte **F√§higkeiten oder Berechtigungen** f√ºr ihre Apps zu konfigurieren, wie z.B. **Datenschutz** oder **Keychain Sharing**. Diese Berechtigungen werden unmittelbar nach der Installation der App angewendet. Um jedoch auf bestimmte gesch√ºtzte Ressourcen zugreifen zu k√∂nnen, muss die App die explizite Zustimmung des Benutzers zum Zeitpunkt des ersten Versuchs einholen. Dies wird durch die Verwendung von _Zweck-Strings_ oder _Verwendungszweck-Beschreibungs-Strings_ erreicht, die Benutzern in einer Berechtigungsanfrage angezeigt werden.

F√ºr diejenigen, die Zugriff auf den Quellcode haben, kann die √úberpr√ºfung der Berechtigungen, die in der `Info.plist`-Datei enthalten sind, wie folgt erfolgen:

1. Das Projekt in Xcode √∂ffnen.
2. Die `Info.plist`-Datei suchen und √∂ffnen.
3. Nach Schl√ºsseln suchen, die mit `"Privacy -"` beginnen, mit der Option, Rohschl√ºssel/Werte zur besseren √úbersicht anzuzeigen.

Bei der Arbeit mit einer IPA-Datei k√∂nnen die folgenden Schritte befolgt werden:

1. Die IPA-Datei entpacken.
2. Die `Info.plist`-Datei innerhalb von `Payload/<appname>.app/` suchen.
3. Die Datei bei Bedarf in das XML-Format konvertieren, um sie einfacher zu √ºberpr√ºfen.

Beispielhaft k√∂nnten die Zweck-Strings in der `Info.plist`-Datei wie folgt aussehen:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Ger√§tef√§higkeiten
Die `Info.plist`-Datei einer App gibt die **Ger√§tef√§higkeiten** an, die dem App Store helfen, Apps nach Ger√§tekompatibilit√§t zu filtern. Diese werden unter dem Schl√ºssel **`UIRequiredDeviceCapabilities`** definiert. Zum Beispiel:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Dieses Beispiel zeigt, dass die App mit dem Befehlssatz armv7 kompatibel ist. Entwickler k√∂nnen auch F√§higkeiten wie NFC angeben, um sicherzustellen, dass ihre App nur auf Ger√§ten verf√ºgbar ist, die NFC unterst√ºtzen.

## Berechtigungen

**Berechtigungen** sind ein weiterer wichtiger Aspekt der iOS-App-Entwicklung und dienen als Schl√ºssel-Wert-Paare, die Apps die Erlaubnis geben, bestimmte Operationen √ºber Laufzeitpr√ºfungen hinaus durchzuf√ºhren. Zum Beispiel erfordert das Aktivieren des **Daten¬≠schutzes** in einer App das Hinzuf√ºgen einer spezifischen Berechtigung im Xcode-Projekt, die sich dann in der Berechtigungsdatei der App oder der eingebetteten mobilen Bereitstellungsdatei f√ºr IPAs widerspiegelt.


# Referenzen
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
