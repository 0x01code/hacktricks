<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

# S√©paration des privil√®ges et bac √† sable

Sur iOS, une distinction de privil√®ges existe entre les applications accessibles par l'utilisateur et les processus principaux du syst√®me. Les applications s'ex√©cutent sous l'identit√© de l'utilisateur **`mobile`**, tandis que les processus syst√®me cruciaux fonctionnent en tant que **`root`**. Cette s√©paration est renforc√©e par un m√©canisme de bac √† sable, qui impose des limitations strictes sur les actions que les applications peuvent entreprendre. Par exemple, m√™me si les applications partagent la m√™me identit√© d'utilisateur, elles sont interdites d'acc√©der ou de modifier les donn√©es des autres.

Les applications sont install√©es dans un r√©pertoire sp√©cifique (`private/var/mobile/Applications/{ID al√©atoire}`) et ont un acc√®s en lecture restreint √† certaines zones et fonctionnalit√©s syst√®me, telles que les SMS et les appels t√©l√©phoniques. L'acc√®s aux zones prot√©g√©es d√©clenche une demande d'autorisation de l'utilisateur.

# Protection des donn√©es

iOS propose aux d√©veloppeurs les **API de protection des donn√©es**, construites sur le processeur Secure Enclave Processor (SEP) - un coprocesseur d√©di√© aux op√©rations cryptographiques et √† la gestion des cl√©s. Le SEP garantit l'int√©grit√© de la protection des donn√©es via une cl√© unique sp√©cifique √† l'appareil, l'UID de l'appareil, int√©gr√© en son sein.

Lors de la cr√©ation d'un fichier, une cl√© de chiffrement AES unique de 256 bits est g√©n√©r√©e, chiffrant le contenu du fichier. Cette cl√© de chiffrement, accompagn√©e d'un ID de classe, est ensuite chiffr√©e √† l'aide d'une cl√© de classe et stock√©e dans les m√©tadonn√©es du fichier. Le d√©chiffrement d'un fichier implique l'utilisation de la cl√© du syst√®me pour acc√©der aux m√©tadonn√©es, r√©cup√©rer la cl√© de classe avec l'ID de classe, puis d√©chiffrer la cl√© de chiffrement unique du fichier.

iOS d√©finit **quatre classes de protection** pour la s√©curit√© des donn√©es, qui d√©terminent quand et comment les donn√©es peuvent √™tre acc√©d√©es :

- **Protection compl√®te (NSFileProtectionComplete)** : Les donn√©es sont inaccessibles jusqu'√† ce que l'appareil soit d√©verrouill√© √† l'aide du code d'acc√®s de l'utilisateur.
- **Prot√©g√© sauf ouvert (NSFileProtectionCompleteUnlessOpen)** : Permet l'acc√®s au fichier m√™me apr√®s le verrouillage de l'appareil, √† condition que le fichier ait √©t√© ouvert lorsque l'appareil √©tait d√©verrouill√©.
- **Prot√©g√© jusqu'√† la premi√®re authentification de l'utilisateur (NSFileProtectionCompleteUntilFirstUserAuthentication)** : Les donn√©es sont accessibles apr√®s le premier d√©verrouillage de l'utilisateur apr√®s le d√©marrage, restant accessibles m√™me si l'appareil est √† nouveau verrouill√©.
- **Aucune protection (NSFileProtectionNone)** : Les donn√©es ne sont prot√©g√©es que par l'UID de l'appareil, facilitant l'effacement rapide des donn√©es √† distance.

Le chiffrement de toutes les classes, sauf `NSFileProtectionNone`, implique une cl√© d√©riv√©e √† la fois de l'UID de l'appareil et du code d'acc√®s de l'utilisateur, garantissant que le d√©chiffrement n'est possible que sur l'appareil avec le bon code d'acc√®s. √Ä partir d'iOS 7, la classe de protection par d√©faut est "Prot√©g√© jusqu'√† la premi√®re authentification de l'utilisateur".

Les d√©veloppeurs peuvent utiliser [**FileDP**](https://github.com/abjurato/FileDp-Source), un outil pour inspecter la classe de protection des donn√©es des fichiers sur un iPhone.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Le trousseau**

En iOS, un **trousseau** sert de **conteneur s√©curis√©** pour stocker des **informations sensibles**, accessible uniquement par l'application qui l'a stock√© ou par des utilisateurs explicitement autoris√©s. Cette encryption est renforc√©e par un **mot de passe unique g√©n√©r√© par iOS**, lui-m√™me encrypt√© avec **AES**. Ce processus d'encryption utilise une fonction **PBKDF2**, combinant le code d'acc√®s de l'utilisateur avec un sel d√©riv√© de l'**UID** du dispositif, un composant auquel seul le **chipset de l'enclave s√©curis√©e** peut acc√©der. Par cons√©quent, m√™me si le code d'acc√®s de l'utilisateur est connu, le contenu du trousseau reste inaccessible sur tout dispositif autre que celui o√π il a √©t√© initialement encrypt√©.

La **gestion et l'acc√®s** aux donn√©es du trousseau sont g√©r√©s par le **d√©mon `securityd`**, en fonction des autorisations sp√©cifiques de l'application telles que `Keychain-access-groups` et `application-identifier`.

### **Op√©rations de l'API du trousseau**

L'API du trousseau, d√©taill√©e dans la [documentation des services de trousseau d'Apple](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), fournit des fonctions essentielles pour la gestion du stockage s√©curis√© :

- **`SecItemAdd`** : Ajoute un nouvel √©l√©ment au trousseau.
- **`SecItemUpdate`** : Met √† jour un √©l√©ment existant dans le trousseau.
- **`SecItemCopyMatching`** : R√©cup√®re un √©l√©ment du trousseau.
- **`SecItemDelete`** : Supprime un √©l√©ment du trousseau.

Le for√ßage du mot de passe du trousseau implique soit d'attaquer directement la cl√© encrypt√©e, soit de tenter de deviner le code d'acc√®s sur le dispositif lui-m√™me, ce qui est consid√©rablement entrav√© par l'application de l'enclave s√©curis√©e d'un d√©lai entre les tentatives infructueuses.

### **Configuration de la protection des donn√©es des √©l√©ments du trousseau**

Les niveaux de protection des donn√©es des √©l√©ments du trousseau sont d√©finis en utilisant l'attribut `kSecAttrAccessible` lors de la cr√©ation ou de la mise √† jour de l'√©l√©ment. Ces niveaux, [comme sp√©cifi√© par Apple](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), d√©terminent quand et comment les √©l√©ments du trousseau sont accessibles :

- **`kSecAttrAccessibleAlways`** : Accessible √† tout moment, ind√©pendamment de l'√©tat de verrouillage du dispositif.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`** : Toujours accessible, mais non inclus dans les sauvegardes.
- **`kSecAttrAccessibleAfterFirstUnlock`** : Accessible apr√®s le premier d√©verrouillage post-red√©marrage.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`** : Identique au pr√©c√©dent, mais non transf√©rable vers de nouveaux dispositifs.
- **`kSecAttrAccessibleWhenUnlocked`** : Accessible uniquement lorsque le dispositif est d√©verrouill√©.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`** : Accessible lorsqu'il est d√©verrouill√©, non inclus dans les sauvegardes.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`** : N√©cessite le code d'acc√®s du dispositif, non inclus dans les sauvegardes.

Les **`AccessControlFlags`** affinent davantage les m√©thodes d'acc√®s, permettant l'authentification biom√©trique ou l'utilisation du code d'acc√®s.

### **Avertissement concernant les dispositifs jailbreak√©s**

{% hint style="warning" %}
Sur les **dispositifs jailbreak√©s**, les protections du trousseau sont compromises, repr√©sentant un risque de s√©curit√© significatif.
{% endhint %}

### **Persistance des donn√©es du trousseau**

Contrairement aux donn√©es sp√©cifiques √† une application supprim√©es lors de la d√©sinstallation de l'application, les **donn√©es du trousseau persistent** sur le dispositif. Cette caract√©ristique pourrait permettre aux nouveaux propri√©taires d'un dispositif d'occasion d'acc√©der aux donn√©es d'application de l'ancien propri√©taire simplement en r√©installant les applications. Il est recommand√© aux d√©veloppeurs de supprimer proactivement les donn√©es du trousseau lors de l'installation de l'application ou lors de la d√©connexion pour att√©nuer ce risque. Voici un exemple de code Swift d√©montrant comment effacer les donn√©es du trousseau lors du premier lancement de l'application :
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **Fonctionnalit√©s de l'application**

Dans le domaine du d√©veloppement d'applications, le **sandboxing** joue un r√¥le crucial dans l'am√©lioration de la s√©curit√©. Ce processus garantit que chaque application fonctionne dans son propre r√©pertoire principal unique, l'emp√™chant ainsi d'acc√©der aux fichiers syst√®me ou aux donn√©es appartenant √† d'autres applications. L'application de ces restrictions est effectu√©e √† travers des politiques de sandbox, qui font partie du **Cadre de contr√¥le d'acc√®s obligatoire Trusted BSD (MAC)**.

Les d√©veloppeurs ont la possibilit√© de configurer certaines **fonctionnalit√©s ou autorisations** pour leurs applications, telles que **Protection des donn√©es** ou **Partage du trousseau**. Ces autorisations sont appliqu√©es imm√©diatement apr√®s l'installation de l'application. Cependant, pour acc√©der √† certaines ressources prot√©g√©es, l'application doit obtenir le consentement explicite de l'utilisateur lors de la premi√®re tentative. Cela est r√©alis√© gr√¢ce √† l'utilisation de _cha√Ænes de but_ ou _cha√Ænes de description d'utilisation_, qui sont pr√©sent√©es aux utilisateurs dans une alerte de demande d'autorisation.

Pour ceux ayant acc√®s au code source, la v√©rification des autorisations incluses dans le fichier `Info.plist` peut √™tre effectu√©e en :

1. Ouvrant le projet dans Xcode.
2. Localisant et ouvrant le fichier `Info.plist`.
3. Recherchant les cl√©s pr√©fix√©es par `"Privacy -"`, avec l'option de visualiser les cl√©s/valeurs bruts pour plus de clart√©.

Lorsqu'il s'agit d'un fichier IPA, les √©tapes suivantes peuvent √™tre suivies :

1. D√©zipper le fichier IPA.
2. Localiser le fichier `Info.plist` dans `Payload/<nomdelapp>.app/`.
3. Convertir le fichier au format XML si n√©cessaire, pour une inspection plus facile.

Par exemple, les cha√Ænes de but dans le fichier `Info.plist` pourraient ressembler √† ceci :
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Capacit√©s de l'appareil
Le fichier `Info.plist` d'une application sp√©cifie les **capacit√©s de l'appareil** qui aident l'App Store √† filtrer les applications en fonction de la compatibilit√© de l'appareil. Celles-ci sont d√©finies sous la cl√© **`UIRequiredDeviceCapabilities`**. Par exemple :
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
## Autorisations

Les **autorisations** sont un autre aspect critique du d√©veloppement d'applications iOS, servant de paires cl√©-valeur qui accordent aux applications la permission d'effectuer certaines op√©rations au-del√† des v√©rifications d'ex√©cution. Par exemple, activer la **Protection des donn√©es** dans une application implique d'ajouter une autorisation sp√©cifique dans le projet Xcode, qui est ensuite refl√©t√©e dans le fichier d'autorisations de l'application ou le fichier de provisionnement mobile int√©gr√© pour les fichiers IPA.


# R√©f√©rences
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
