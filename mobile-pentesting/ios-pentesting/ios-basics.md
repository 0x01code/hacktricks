<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

# Separaci√≥n de Privilegios y Sandbox

En iOS, existe una distinci√≥n de privilegios entre las aplicaciones accesibles para el usuario y los procesos fundamentales del sistema. Las aplicaciones se ejecutan bajo la identidad de usuario **`mobile`**, mientras que los procesos esenciales del sistema operan como **`root`**. Esta separaci√≥n se ve reforzada por un mecanismo de sandbox, que impone estrictas limitaciones sobre las acciones que las aplicaciones pueden realizar. Por ejemplo, aunque las aplicaciones compartan la misma identidad de usuario, se les proh√≠be acceder o modificar los datos de otras aplicaciones.

Las aplicaciones se instalan en un directorio espec√≠fico (`private/var/mobile/Applications/{ID aleatorio}`) y tienen acceso de lectura restringido a ciertas √°reas y funcionalidades del sistema, como los SMS y las llamadas telef√≥nicas. El acceso a √°reas protegidas desencadena una solicitud emergente de permiso del usuario.

# Protecci√≥n de Datos

iOS ofrece a los desarrolladores las **API de Protecci√≥n de Datos**, construidas sobre el Procesador de Recinto Seguro (SEP) ‚Äî un coprocesador dedicado para operaciones criptogr√°ficas y gesti√≥n de claves. El SEP garantiza la integridad de la protecci√≥n de datos mediante una clave √∫nica espec√≠fica del dispositivo, el UID del dispositivo, incrustado en √©l.

Al crear un archivo, se genera una clave de cifrado AES √∫nica de 256 bits, que cifra el contenido del archivo. Esta clave de cifrado, junto con un ID de clase, se cifra luego usando una clave de clase y se almacena dentro de los metadatos del archivo. Descifrar un archivo implica usar la clave del sistema para acceder a los metadatos, recuperar la clave de clase con el ID de clase y luego descifrar la clave de cifrado √∫nica del archivo.

iOS define **cuatro clases de protecci√≥n** para la seguridad de datos, que determinan cu√°ndo y c√≥mo se puede acceder a los datos:

- **Protecci√≥n Completa (NSFileProtectionComplete)**: Los datos son inaccesibles hasta que el dispositivo se desbloquee usando el c√≥digo de acceso del usuario.
- **Protegido a menos que se abra (NSFileProtectionCompleteUnlessOpen)**: Permite el acceso al archivo incluso despu√©s de que el dispositivo est√© bloqueado, siempre que el archivo se haya abierto cuando el dispositivo estaba desbloqueado.
- **Protegido hasta la primera autenticaci√≥n del usuario (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Los datos son accesibles despu√©s del primer desbloqueo del usuario despu√©s del arranque, y siguen siendo accesibles incluso si el dispositivo se bloquea nuevamente.
- **Sin Protecci√≥n (NSFileProtectionNone)**: Los datos solo est√°n protegidos por el UID del dispositivo, facilitando un borrado r√°pido de datos remoto.

El cifrado de todas las clases, excepto `NSFileProtectionNone`, implica una clave derivada tanto del UID del dispositivo como del c√≥digo de acceso del usuario, asegurando que el descifrado solo sea posible en el dispositivo con el c√≥digo de acceso correcto. Desde iOS 7 en adelante, la clase de protecci√≥n predeterminada es "Protegido hasta la primera autenticaci√≥n del usuario".

Los desarrolladores pueden utilizar [**FileDP**](https://github.com/abjurato/FileDp-Source), una herramienta para inspeccionar la clase de protecci√≥n de datos de archivos en un iPhone.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **El Portafolio de Claves**

En iOS, un **Portafolio de Claves** sirve como un **contenedor seguro encriptado** para almacenar **informaci√≥n sensible**, accesible solo por la aplicaci√≥n que la almacen√≥ o por aquellas autorizadas expl√≠citamente. Esta encriptaci√≥n est√° fortalecida por una **contrase√±a √∫nica generada por iOS**, la cual est√° encriptada con **AES**. Este proceso de encriptaci√≥n aprovecha una funci√≥n **PBKDF2**, combinando el c√≥digo de acceso del usuario con una sal derivada del **UID** del dispositivo, un componente al que solo puede acceder el **chipset del enclave seguro**. En consecuencia, incluso si se conoce el c√≥digo de acceso del usuario, el contenido del Portafolio de Claves permanece inaccesible en cualquier dispositivo que no sea aquel donde se encriptaron originalmente.

El **manejo y acceso** a los datos del Portafolio de Claves son gestionados por el demonio **`securityd`**, basado en permisos espec√≠ficos de la aplicaci√≥n como `Keychain-access-groups` y `application-identifier`.

### **Operaciones de la API del Portafolio de Claves**

La API del Portafolio de Claves, detallada en la [documentaci√≥n de Servicios de Portafolio de Claves de Apple](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html), proporciona funciones esenciales para la gesti√≥n segura del almacenamiento:

- **`SecItemAdd`**: Agrega un nuevo elemento al Portafolio de Claves.
- **`SecItemUpdate`**: Actualiza un elemento existente en el Portafolio de Claves.
- **`SecItemCopyMatching`**: Recupera un elemento del Portafolio de Claves.
- **`SecItemDelete`**: Elimina un elemento del Portafolio de Claves.

Forzar la contrase√±a del Portafolio de Claves implica atacar directamente la clave encriptada o intentar adivinar el c√≥digo de acceso en el propio dispositivo, dificultado significativamente por la imposici√≥n de un retraso entre intentos fallidos por parte del enclave seguro.

### **Configuraci√≥n de la Protecci√≥n de Datos del Elemento del Portafolio de Claves**

Los niveles de protecci√≥n de datos para los elementos del Portafolio de Claves se establecen utilizando el atributo `kSecAttrAccessible` durante la creaci√≥n o actualizaci√≥n del elemento. Estos niveles, [como se especifica por Apple](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100), determinan cu√°ndo y c√≥mo los elementos del Portafolio de Claves son accesibles:

- **`kSecAttrAccessibleAlways`**: Accesible en todo momento, independientemente del estado de bloqueo del dispositivo.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Siempre accesible, pero no incluido en copias de seguridad.
- **`kSecAttrAccessibleAfterFirstUnlock`**: Accesible despu√©s del primer desbloqueo posterior al reinicio.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Igual que el anterior, pero no transferible a nuevos dispositivos.
- **`kSecAttrAccessibleWhenUnlocked`**: Solo accesible cuando el dispositivo est√° desbloqueado.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Accesible cuando est√° desbloqueado, no incluido en copias de seguridad.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Requiere c√≥digo de acceso del dispositivo, no incluido en copias de seguridad.

**`AccessControlFlags`** refinan a√∫n m√°s los m√©todos de acceso, permitiendo la autenticaci√≥n biom√©trica o el uso de un c√≥digo de acceso.

### **Advertencia sobre Dispositivos con Jailbreak**

{% hint style="warning" %}
En los **dispositivos con jailbreak**, las protecciones del Portafolio de Claves se ven comprometidas, representando un riesgo de seguridad significativo.
{% endhint %}

### **Persistencia de los Datos del Portafolio de Claves**

A diferencia de los datos espec√≠ficos de la aplicaci√≥n eliminados al desinstalar la aplicaci√≥n, los **datos del Portafolio de Claves persisten** en el dispositivo. Esta caracter√≠stica podr√≠a permitir a los nuevos propietarios de un dispositivo de segunda mano acceder a los datos de la aplicaci√≥n del propietario anterior simplemente reinstalando aplicaciones. Se recomienda a los desarrolladores borrar proactivamente los datos del Portafolio de Claves al instalar la aplicaci√≥n o durante el cierre de sesi√≥n para mitigar este riesgo. Aqu√≠ tienes un ejemplo de c√≥digo Swift que muestra c√≥mo borrar los datos del Portafolio de Claves al iniciar la aplicaci√≥n por primera vez:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **Capacidades de la aplicaci√≥n**

En el √°mbito del desarrollo de aplicaciones, el **sandboxing** juega un papel crucial en mejorar la seguridad. Este proceso asegura que cada aplicaci√≥n opere dentro de su propio directorio √∫nico, evitando as√≠ el acceso a archivos del sistema o datos pertenecientes a otras aplicaciones. La aplicaci√≥n de estas restricciones se lleva a cabo a trav√©s de pol√≠ticas de sandbox, que forman parte del **Trusted BSD (MAC) Mandatory Access Control Framework**.

Los desarrolladores tienen la capacidad de configurar ciertas **capacidades o permisos** para sus aplicaciones, como **Protecci√≥n de Datos** o **Compartir Llaveros**. Estos permisos se aplican inmediatamente despu√©s de la instalaci√≥n de la aplicaci√≥n. Sin embargo, para acceder a ciertos recursos protegidos, la aplicaci√≥n debe obtener el consentimiento expl√≠cito del usuario en el momento del primer intento. Esto se logra mediante el uso de _cadenas de prop√≥sito_ o _cadenas de descripci√≥n de uso_, que se presentan a los usuarios en una alerta de solicitud de permiso.

Para aquellos con acceso al c√≥digo fuente, la verificaci√≥n de los permisos incluidos en el archivo `Info.plist` se puede hacer mediante:

1. Abrir el proyecto en Xcode.
2. Localizar y abrir el archivo `Info.plist`.
3. Buscar claves con prefijo `"Privacy -"`, con la opci√≥n de ver claves/valores en bruto para mayor claridad.

Al tratar con un archivo IPA, se pueden seguir los siguientes pasos:

1. Descomprimir el IPA.
2. Localizar el archivo `Info.plist` dentro de `Payload/<nombreapp>.app/`.
3. Convertir el archivo a formato XML si es necesario, para una inspecci√≥n m√°s f√°cil.

Por ejemplo, las cadenas de prop√≥sito en el archivo `Info.plist` podr√≠an verse as√≠:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Capacidades del Dispositivo
El archivo `Info.plist` de una aplicaci√≥n especifica las **capacidades del dispositivo** que ayudan a la App Store a filtrar aplicaciones seg√∫n la compatibilidad del dispositivo. Estas se definen bajo la clave **`UIRequiredDeviceCapabilities`**. Por ejemplo:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Este ejemplo indica que la aplicaci√≥n es compatible con el conjunto de instrucciones armv7. Los desarrolladores tambi√©n pueden especificar capacidades como nfc para asegurarse de que su aplicaci√≥n solo est√© disponible en dispositivos que admitan NFC.

## Entitlements

**Entitlements** son otro aspecto cr√≠tico del desarrollo de aplicaciones iOS, sirviendo como pares clave-valor que otorgan a las aplicaciones permiso para realizar ciertas operaciones m√°s all√° de las verificaciones en tiempo de ejecuci√≥n. Por ejemplo, habilitar **Protecci√≥n de Datos** en una aplicaci√≥n implica agregar un entitlement espec√≠fico en el proyecto Xcode, que luego se refleja en el archivo de entitlements de la aplicaci√≥n o en el archivo de provisi√≥n m√≥vil incrustado para IPAs.


# Referencias
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
