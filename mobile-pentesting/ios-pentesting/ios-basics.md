<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Separaci√≥n de privilegios y sandbox

Las aplicaciones a las que el usuario puede acceder se ejecutan como el usuario **mobile**, mientras que los procesos cr√≠ticos del sistema se ejecutan como **root**.\
Sin embargo, el sandbox permite un mejor control sobre las acciones que los procesos y aplicaciones pueden realizar.

Por ejemplo, incluso si dos procesos se ejecutan como el mismo usuario (mobile), **no se les permite acceder o modificar los datos del otro**.

Cada aplicaci√≥n se instala en **`private/var/mobile/Applications/{ID aleatorio}`**\
Una vez instaladas, las aplicaciones tienen acceso de lectura limitado a algunas √°reas y funciones del sistema (SMS, llamadas telef√≥nicas...). Si una aplicaci√≥n quiere acceder a un **√°rea protegida**, aparece una **ventana emergente que solicita permiso**.

# Protecci√≥n de datos

Los desarrolladores de aplicaciones pueden aprovechar las API de _Data Protection_ de iOS para implementar un **control de acceso detallado** para los datos del usuario almacenados en la memoria flash. Las API se basan en el **procesador Secure Enclave** (SEP). El SEP es un coprocesador que proporciona **operaciones criptogr√°ficas para la protecci√≥n de datos y la gesti√≥n de claves**. Una clave de hardware espec√≠fica del dispositivo, el **UID del dispositivo** (ID √∫nico), est√° **incrustada en el enclave seguro**, asegurando la integridad de la protecci√≥n de datos incluso cuando el kernel del sistema operativo est√° comprometido.

Cuando se crea un **archivo** en el disco, se genera una nueva **clave AES de 256 bits** con la ayuda del generador de n√∫meros aleatorios basado en hardware del enclave seguro. El **contenido del archivo se cifra con la clave generada**. Y luego, esta **clave se guarda cifrada con una clave de clase** junto con **el ID de clase**, con **ambos datos cifrados por la clave del sistema**, dentro de los **metadatos** del archivo.

![](<../../.gitbook/assets/image (473).png>)

Para descifrar el archivo, se **descifran los metadatos usando la clave del sistema**. Luego, utilizando el **ID de clase**, se **recupera la clave de clase** **para descifrar la clave por archivo y descifrar el archivo.**

Los archivos se pueden asignar a una de **cuatro** **clases de protecci√≥n** diferentes, que se explican con m√°s detalle en la [Gu√≠a de seguridad de la plataforma Apple](https://help.apple.com/pdf/security/en_US/apple-platform-security-guide.pdf):

* **Protecci√≥n completa (NSFileProtectionComplete)**: Una clave derivada del c√≥digo de acceso del usuario y el UID del dispositivo protege esta clave de clase. La clave derivada se borra de la memoria poco despu√©s de que el dispositivo se bloquee, lo que hace que los datos sean inaccesibles hasta que el usuario desbloquee el dispositivo.
* **Protegido a menos que se abra (NSFileProtectionCompleteUnlessOpen)**: Esta clase de protecci√≥n es similar a la protecci√≥n completa, pero, si el archivo se abre cuando est√° desbloqueado, la aplicaci√≥n puede seguir accediendo al archivo incluso si el usuario bloquea el dispositivo. Esta clase de protecci√≥n se utiliza cuando, por ejemplo, se est√° descargando un archivo adjunto de correo electr√≥nico en segundo plano.
* **Protegido hasta la primera autenticaci√≥n del usuario (
```objectivec
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
    // Remove Keychain items here

    // Update the flag indicator
    userDefaults.set(true, forKey: "hasRunBefore")
    userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
* Al desarrollar la funcionalidad de cierre de sesi√≥n para una aplicaci√≥n iOS, aseg√∫rese de que los datos de Keychain se borren como parte del cierre de sesi√≥n de la cuenta. Esto permitir√° a los usuarios eliminar sus cuentas antes de desinstalar una aplicaci√≥n.

# **Capacidades de la aplicaci√≥n**

**Cada aplicaci√≥n tiene un directorio de inicio √∫nico y est√° aislada**, por lo que no pueden acceder a recursos del sistema protegidos o archivos almacenados por el sistema o por otras aplicaciones. Estas restricciones se implementan mediante pol√≠ticas de aislamiento (tambi√©n conocidas como _perfiles_), que son aplicadas por el [Marco de Control de Acceso Obligatorio de BSD de Confianza (MAC)](http://www.trustedbsd.org/mac.html) a trav√©s de una extensi√≥n del kernel.

Algunas [**capacidades/permisos**](https://help.apple.com/developer-account/#/dev21218dfd6) pueden ser configuradas por los desarrolladores de la aplicaci√≥n (por ejemplo, Protecci√≥n de Datos o Compartir Keychain) y tendr√°n efecto directo despu√©s de la instalaci√≥n. Sin embargo, para otros, **se le pedir√° expl√≠citamente al usuario la primera vez que la aplicaci√≥n intente acceder a un recurso protegido**.

Las [_cadenas de prop√≥sito_](https://developer.apple.com/documentation/uikit/core\_app/protecting\_the\_user\_s\_privacy/accessing\_protected\_resources?language=objc#3037322) o _cadenas de descripci√≥n de uso_ son textos personalizados que se ofrecen a los usuarios en la alerta de solicitud de permiso del sistema al solicitar permiso para acceder a datos o recursos protegidos.

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc\_%2F-Lf1AQw8W2q7BB5-il7r%2Fpermission\_request\_alert.png?alt=media)

Si se tiene el c√≥digo fuente original, se pueden verificar los permisos incluidos en el archivo `Info.plist`:

* Abra el proyecto con Xcode.
* Encuentre y abra el archivo `Info.plist` en el editor predeterminado y busque las claves que comienzan con `"Privacidad -"`.

Puede cambiar la vista para mostrar los valores en bruto haciendo clic con el bot√≥n derecho y seleccionando "Mostrar claves/valores en bruto" (de esta manera, por ejemplo, `"Privacidad - Descripci√≥n de uso de ubicaci√≥n cuando se usa"` se convertir√° en `NSLocationWhenInUseUsageDescription`).

Si solo se tiene el IPA:

* Descomprima el IPA.
* El archivo `Info.plist` se encuentra en `Payload/<nombre de la aplicaci√≥n>.app/Info.plist`.
* Convi√©rtalo si es necesario (por ejemplo, `plutil -convert xml1 Info.plist`) como se explica en el cap√≠tulo "Pruebas b√°sicas de seguridad de iOS", secci√≥n "El archivo Info.plist".
* Inspeccione todas las claves de _cadenas de prop√≥sito en el archivo Info.plist_, que generalmente terminan con `UsageDescription`:

    ```markup
      <plist version="1.0">
      <dict>
          <key>NSLocationWhenInUseUsageDescription</key>
          <string>Se utiliza su ubicaci√≥n para proporcionar indicaciones de giro a su destino.</string>
    ```

## Capacidades del dispositivo

Las capacidades del dispositivo se utilizan por la App Store para garantizar que solo se enumeren dispositivos compatibles y, por lo tanto, se les permita descargar la aplicaci√≥n. Se especifican en el archivo `Info.plist` de la aplicaci√≥n bajo la clave [`UIRequiredDeviceCapabilities`](https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html#//apple\_ref/doc/plist/info/UIRequiredDeviceCapabilities).
```markup
<key>UIRequiredDeviceCapabilities</key>
<array>
    <string>armv7</string>
</array>
```
> Por lo general, encontrar√° la capacidad `armv7`, lo que significa que la aplicaci√≥n est√° compilada solo para el conjunto de instrucciones armv7, o si es una aplicaci√≥n universal de 32/64 bits.

Por ejemplo, una aplicaci√≥n puede depender completamente de NFC para funcionar (por ejemplo, una aplicaci√≥n "Lector de etiquetas NFC"). Seg√∫n la [Referencia de compatibilidad de dispositivos iOS archivada](https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/DeviceCompatibilityMatrix/DeviceCompatibilityMatrix.html), NFC solo est√° disponible a partir del iPhone 7 (y iOS 11). Un desarrollador podr√≠a querer excluir todos los dispositivos incompatibles estableciendo la capacidad del dispositivo `nfc`.

## Derechos

> Los derechos son pares de clave-valor que se firman en una aplicaci√≥n y permiten la autenticaci√≥n m√°s all√° de los factores de tiempo de ejecuci√≥n, como el ID de usuario de UNIX. Dado que los derechos est√°n firmados digitalmente, no se pueden cambiar. Los derechos se utilizan ampliamente por las aplicaciones y demonios del sistema para **realizar operaciones privilegiadas espec√≠ficas que de lo contrario requerir√≠an que el proceso se ejecutara como root**. Esto reduce en gran medida el potencial de escalada de privilegios por parte de una aplicaci√≥n o demonio del sistema comprometido.

Por ejemplo, si desea establecer la capacidad "Protecci√≥n de datos predeterminada", deber√° ir a la pesta√±a **Capacidades** en Xcode y habilitar **Protecci√≥n de datos**. Esto se escribe directamente por Xcode en el archivo `<nombre de la aplicaci√≥n>.entitlements` como el derecho `com.apple.developer.default-data-protection` con el valor predeterminado `NSFileProtectionComplete`. En el IPA, podemos encontrar esto en `embedded.mobileprovision` como:
```markup
<key>Entitlements</key>
<dict>
    ...
    <key>com.apple.developer.default-data-protection</key>
    <string>NSFileProtectionComplete</string>
</dict>
```
Para otras capacidades como HealthKit, se debe pedir permiso al usuario, por lo tanto, no es suficiente agregar los entitlements, se deben agregar claves y cadenas especiales al archivo `Info.plist` de la aplicaci√≥n.

# Conceptos b√°sicos de Objective-C y Swift

**Objective-C** tiene un **tiempo de ejecuci√≥n din√°mico**, por lo que cuando se ejecuta un programa Objective-C en iOS, llama a bibliotecas cuyas **direcciones se resuelven en tiempo de ejecuci√≥n** comparando el nombre de la funci√≥n enviada en el mensaje con una lista de todos los nombres de funci√≥n disponibles.

Al principio, solo las aplicaciones creadas por Apple se ejecutaban en los iPhones, por lo que ten√≠an **acceso a todo** ya que eran **confiables**. Sin embargo, cuando Apple **permiti√≥** **aplicaciones de terceros**, Apple simplemente elimin√≥ los archivos de encabezado de las funciones poderosas para "ocultarlas" a los desarrolladores. Sin embargo, los desarrolladores descubrieron que las funciones "seguras" necesitaban algunas de estas funciones no documentadas y simplemente creando un **archivo de encabezado personalizado con los nombres de las funciones no documentadas, era posible invocar estas poderosas funciones ocultas**. En realidad, Apple, antes de permitir que una aplicaci√≥n se publique, verifica si la aplicaci√≥n llama a alguna de estas funciones prohibidas.

Luego apareci√≥ Swift. Como **Swift est√° vinculado est√°ticamente** (no resuelve la direcci√≥n de las funciones en tiempo de ejecuci√≥n como Objective-C), se pueden verificar m√°s f√°cilmente las llamadas que un programa Swift va a hacer mediante an√°lisis de c√≥digo est√°tico.

# Gesti√≥n de dispositivos

A partir de la versi√≥n 6 de iOS, hay **soporte incorporado para la capacidad de gesti√≥n de dispositivos** con controles de granularidad fina que permiten a una organizaci√≥n controlar los dispositivos corporativos de Apple.\
La inscripci√≥n puede ser **iniciada por el usuario instalando un agente** para acceder a las aplicaciones corporativas. En este caso, el dispositivo generalmente pertenece al usuario.\
O la **empresa puede indicar los n√∫meros de serie** de los dispositivos comprados o el ID del pedido de compra y especificar el perfil MDM para instalar en esos dispositivos. Tenga en cuenta que Apple **no permite inscribir un dispositivo en particular de esta manera dos veces**. Una vez que se elimina el primer perfil, el usuario debe dar su consentimiento para instalar otro.

El usuario puede ver las pol√≠ticas instaladas en _**Configuraci√≥n**_ --> _**General**_ --> _**Perfiles y gesti√≥n de dispositivos**_

Como estas pol√≠ticas MDM est√°n verificando y limitando otras aplicaciones, se est√°n **ejecutando con m√°s privilegios**.\
Una pol√≠tica MDM puede **obligar** a los **usuarios** a tener un **c√≥digo de acceso** establecido con una **complejidad de contrase√±a m√≠nima**.\
Los perfiles est√°n vinculados al ID de dispositivo, **firmados** y **encriptados** por el servidor MDM y **a prueba de manipulaciones**. No se pueden eliminar sin **perder** todos los **datos corporativos**.\
Los perfiles MDM permiten **borrar** todos los **datos** si hay X **intentos fallidos** de **contrase√±a**. Adem√°s, el **administrador** puede **borrar** el iPhone de forma remota en cualquier momento a trav√©s de la interfaz MDM.

Los agentes MDM tambi√©n **verificar√°n** posibles **jailbreaks del dispositivo**, ya que este es un estado muy peligroso para un iPhone.
