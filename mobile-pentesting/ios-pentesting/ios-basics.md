<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>öğrenin!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

# Ayrıcalık Ayrımı ve Kum Sandığı

iOS'ta, kullanıcı erişilebilir uygulamalar ile sistem çekirdeğinin temel işlemleri arasında bir ayrıcalık ayrımı bulunur. Uygulamalar **`mobile`** kullanıcı kimliği altında çalışırken, önemli sistem işlemleri **`root`** olarak çalışır. Bu ayrım, uygulamaların hangi eylemleri gerçekleştirebileceği konusunda sıkı kısıtlamalar getiren bir kum sandığı mekanizması tarafından güçlendirilir. Örneğin, uygulamalar aynı kullanıcı kimliğini paylaşsalar bile, birbirlerinin verilerine erişmeleri veya değiştirmeleri yasaktır.

Uygulamalar belirli bir dizine (`private/var/mobile/Applications/{rastgele ID}`) kurulur ve SMS ve telefon görüşmeleri gibi belirli sistem alanlarına ve işlevlere sınırlı okuma erişimi vardır. Korunan alanlara erişim, kullanıcı izni için bir açılır pencere isteği tetikler.

# Veri Koruma

iOS, veri koruma bütünlüğünü sağlamak için Secure Enclave Processor (SEP) üzerine inşa edilen **Veri Koruma API'leri** sunar - şifreleme işlemleri ve anahtar yönetimi için ayrılmış bir yardımcı işlemci. SEP, içine gömülü olan cihaza özgü bir anahtar olan cihaz UID'si aracılığıyla veri koruması bütünlüğünü sağlar.

Bir dosya oluşturulduğunda, dosyanın içeriğini şifreleyen benzersiz bir 256-bit AES şifreleme anahtarı oluşturulur. Bu şifreleme anahtarı, bir sınıf anahtarıyla şifrelenir ve dosyanın meta verilerine depolanır. Bir dosyanın şifresini çözmek için, sistemin anahtarını kullanarak meta verilere erişilir, sınıf kimliğiyle sınıf anahtarını alınır ve ardından dosyanın benzersiz şifreleme anahtarı çözülür.

iOS, veri güvenliği için **dört koruma sınıfı** tanımlar, verinin ne zaman ve nasıl erişilebileceğini belirler:

- **Tam Koruma (NSFileProtectionComplete)**: Veri, kullanıcının şifresini kullanarak cihazın kilidini açana kadar erişilemez.
- **Açık Olmadıkça Korunan (NSFileProtectionCompleteUnlessOpen)**: Dosya, cihaz kilitlendiğinde bile erişilebilir, ancak dosya cihaz kilidini açıldığında açıldıysa.
- **İlk Kullanıcı Kimlik Doğrulamasına Kadar Korunan (NSFileProtectionCompleteUntilFirstUserAuthentication)**: Veri, ilk kullanıcı açılışından sonra yapılan ilk kullanıcı kimlik doğrulamasından sonra erişilebilir hale gelir ve cihaz tekrar kilitlense bile erişilebilir kalır.
- **Koruma Yok (NSFileProtectionNone)**: Veri, cihaz UID'si tarafından korunur ve hızlı uzaktan veri silmeyi kolaylaştırır.

`NSFileProtectionNone` hariç tüm sınıfların şifrelemesi, cihaz UID'si ve kullanıcının şifresinden türetilen bir anahtarla yapılır, böylece doğru şifreyle sadece cihazda çözme mümkün olur. iOS 7'den itibaren, varsayılan koruma sınıfı "İlk Kullanıcı Kimlik Doğrulamasına Kadar Korunan" olarak belirlenmiştir.

Geliştiriciler, bir iPhone'daki dosyaların veri koruma sınıfını incelemek için [**FileDP**](https://github.com/abjurato/FileDp-Source) adlı bir araç kullanabilirler.
```python
# Example code to use FileDP for checking file protection class
# Note: Ensure your device is jailbroken and has Python installed to use FileDP.
# Installation and usage of FileDP:
git clone https://github.com/abjurato/FileDp-Source
cd FileDp-Source
python filedp.py /path/to/check
```
## **Anahtar Zinciri**

iOS'ta, bir **Anahtar Zinciri**, yalnızca onu depolayan uygulama veya açıkça yetkilendirilenler tarafından erişilebilen **hassas bilgilerin** güvenli bir **şifrelenmiş konteyner** olarak hizmet eder. Bu şifreleme, iOS tarafından oluşturulan benzersiz bir **şifre** tarafından güçlendirilir ve kendisi **AES** ile şifrelenir. Bu şifreleme işlemi, kullanıcının parolasını cihazın **UID**'den türetilen bir tuzla birleştiren bir **PBKDF2 işlevi** kullanır ve yalnızca **güvenli kripto birimi yongası**'nın erişebileceği bir bileşendir. Sonuç olarak, kullanıcının parolası bilinse bile, Anahtar Zinciri içeriği yalnızca orijinal olarak şifrelendiği cihaz dışında hiçbir cihazda erişilemez kalır.

Anahtar Zinciri verilerinin **yönetimi ve erişimi**, `Keychain-access-groups` ve `application-identifier` gibi belirli uygulama yetkilendirmelerine dayalı olarak **`securityd` hizmeti** tarafından ele alınır.

### **Anahtar Zinciri API İşlemleri**

Anahtar Zinciri API'si, [Apple'ın Anahtar Zinciri Hizmetleri belgelerinde](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html) ayrıntılı olarak açıklanan güvenli depolama yönetimi için temel işlevleri sağlar:

- **`SecItemAdd`**: Anahtar Zinciri'ne yeni bir öğe ekler.
- **`SecItemUpdate`**: Anahtar Zinciri'ndeki mevcut bir öğeyi günceller.
- **`SecItemCopyMatching`**: Anahtar Zinciri'nden bir öğe alır.
- **`SecItemDelete`**: Anahtar Zinciri'nden bir öğeyi kaldırır.

Anahtar Zinciri parolasını kaba kuvvet saldırısıyla çözmek, şifrelenmiş anahtara doğrudan saldırmak veya cihazdaki parolayı tahmin etmeye çalışmak anlamına gelir, ancak güvenli kripto birimi yongasının başarısız denemeler arasında bir gecikme uygulaması nedeniyle önemli ölçüde zorlaşır.

### **Anahtar Zinciri Öğe Veri Korumasını Yapılandırma**

Anahtar Zinciri öğelerinin veri koruma seviyeleri, öğe oluşturma veya güncelleme sırasında `kSecAttrAccessible` özniteliği kullanılarak ayarlanır. Bu seviyeler, [Apple tarafından belirtilen](https://developer.apple.com/documentation/security/keychain_services/keychain_items/item_attribute_keys_and_values#1679100) şekilde, Anahtar Zinciri öğelerinin ne zaman ve nasıl erişilebilir olduğunu belirler:

- **`kSecAttrAccessibleAlways`**: Her zaman erişilebilir, cihaz kilidi durumundan bağımsız olarak.
- **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: Her zaman erişilebilir, ancak yedeklemelere dahil edilmez.
- **`kSecAttrAccessibleAfterFirstUnlock`**: İlk yeniden başlatmadan sonra erişilebilir.
- **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: Yukarıdakiyle aynı, ancak yeni cihazlara aktarılamaz.
- **`kSecAttrAccessibleWhenUnlocked`**: Yalnızca cihaz kilidinin açık olduğu durumlarda erişilebilir.
- **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: Kilidi açık olduğunda erişilebilir, yedeklemelere dahil edilmez.
- **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: Cihaz parolası gerektirir, yedeklemelere dahil edilmez.

**`AccessControlFlags`**, biyometrik kimlik doğrulama veya parola kullanımına izin vererek erişim yöntemlerini daha da geliştirir.

### **Jailbreakli Cihaz Uyarısı**

{% hint style="warning" %}
**Jailbreakli cihazlarda**, Anahtar Zinciri'nin korumaları tehlikeye girer ve önemli bir güvenlik riski oluşturur.
{% endhint %}

### **Anahtar Zinciri Verilerinin Kalıcılığı**

Uygulama kaldırıldığında uygulama özel verilerinin silinmesinin aksine, **Anahtar Zinciri verileri** cihazda kalıcıdır. Bu özellik, ikinci el bir cihazın yeni sahiplerinin uygulama verilerine önceki sahibin sadece uygulamaları yeniden yükleyerek erişmesine olanak tanıyabilir. Geliştiricilere, bu riski azaltmak için uygulama yükleme sırasında veya oturumu kapatma sırasında proaktif olarak Anahtar Zinciri verilerini temizlemeleri önerilir. İşte Anahtar Zinciri verilerini ilk uygulama başlatmasında nasıl temizleyeceğinizi gösteren bir Swift kodu örneği:
```swift
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
# **Uygulama Yetenekleri**

Uygulama geliştirme alanında, **sandboxing** güvenliği artırmada önemli bir rol oynar. Bu süreç, her uygulamanın kendi benzersiz ana dizininde çalışmasını sağlayarak, sistem dosyalarına veya diğer uygulamalara ait verilere erişmesini engeller. Bu kısıtlamaların uygulanması, **Trusted BSD (MAC) Mandatory Access Control Framework**'ün bir parçası olan sandbox politikaları aracılığıyla gerçekleştirilir.

Geliştiriciler, uygulamaları için **Veri Koruma** veya **Anahtar Zinciri Paylaşımı** gibi belirli **yetenekler veya izinler** yapılandırma yeteneğine sahiptir. Bu izinler, uygulama yüklendikten hemen sonra uygulanır. Bununla birlikte, belirli korumalı kaynaklara erişmek için uygulamanın ilk denemede kullanıcıdan açık onay alması gerekmektedir. Bu, kullanıcılara izin isteği uyarısında sunulan _amaç dizeleri_ veya _kullanım açıklama dizeleri_ kullanılarak gerçekleştirilir.

Kaynak koduna erişimi olanlar için, `Info.plist` dosyasında bulunan izinlerin doğrulanması şu adımlarla yapılabilir:

1. Xcode'da projeyi açma.
2. `Info.plist` dosyasını bulma ve açma.
3. Netlik için, `"Privacy -"` ile başlayan anahtarları/değerleri görüntüleme seçeneğiyle arama.

IPA dosyasıyla uğraşırken, aşağıdaki adımlar izlenebilir:

1. IPA dosyasını açma.
2. `Payload/<uygulamaadı>.app/` içindeki `Info.plist` dosyasını bulma.
3. İncelemeyi kolaylaştırmak için dosyayı XML formatına dönüştürme gerekiyorsa dönüştürme.

Örneğin, `Info.plist` dosyasındaki amaç dizeleri şu şekilde olabilir:
```xml
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```
## Cihaz Yetenekleri
Bir uygulamanın `Info.plist` dosyası, App Store'un cihaz uyumluluğuna göre uygulamaları filtrelemesine yardımcı olan **cihaz yeteneklerini** belirtir. Bunlar **`UIRequiredDeviceCapabilities`** anahtarı altında tanımlanır. Örneğin:
```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
Bu örnek, uygulamanın armv7 komut kümesiyle uyumlu olduğunu göstermektedir. Geliştiriciler, NFC'yi destekleyen cihazlara sadece uygulamanın erişilebilir olmasını sağlamak için nfc gibi yetenekleri de belirtebilirler.

## Yetkilendirmeler

**Yetkilendirmeler**, iOS uygulama geliştirmede başka bir önemli unsurdur ve çalışma zamanı denetimlerinin ötesinde uygulamalara belirli işlemleri gerçekleştirme izni veren anahtar-değer çiftleri olarak hizmet eder. Örneğin, bir uygulamada **Veri Koruma**'yı etkinleştirmek, Xcode projesine belirli bir yetkilendirme eklemeyi gerektirir ve bu daha sonra uygulamanın yetkilendirme dosyasında veya IPAlar için gömülü mobil sağlama dosyasında yansıtılır.


# Referanslar
* [https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage](https://mas.owasp.org/MASTG/iOS/0x06d-Testing-Data-Storage)
* [https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md](https://github.com/OWASP/owasp-mastg/blob/master/Document/0x06h-Testing-Platform-Interaction.md)
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0069/)
* [https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/](https://mas.owasp.org/MASTG/iOS/0x06h-Testing-Platform-Interaction/)



<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki özel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek paylaşın.

</details>
