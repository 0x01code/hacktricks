<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Separa√ß√£o de privil√©gios e sandbox

Os aplicativos aos quais o usu√°rio pode acessar s√£o executados como usu√°rio **mobile**, enquanto os processos cr√≠ticos do sistema s√£o executados como **root**.\
No entanto, o sandbox permite um melhor controle sobre as a√ß√µes que os processos e aplicativos podem executar.

Por exemplo, mesmo que dois processos sejam executados como o mesmo usu√°rio (mobile), eles **n√£o t√™m permiss√£o para acessar ou modificar os dados um do outro**.

Cada aplicativo √© instalado em **`private/var/mobile/Applications/{ID aleat√≥rio}`**\
Uma vez instalados, os aplicativos t√™m acesso limitado de leitura a algumas √°reas e fun√ß√µes do sistema (SMS, chamada telef√¥nica...). Se um aplicativo quiser acessar uma **√°rea protegida**, aparecer√° uma **janela pop-up solicitando permiss√£o**.

# Prote√ß√£o de dados

Os desenvolvedores de aplicativos podem aproveitar as APIs de _Prote√ß√£o de Dados_ do iOS para implementar **controle de acesso refinado** para os dados do usu√°rio armazenados na mem√≥ria flash. As APIs s√£o constru√≠das em cima do **Processador de Enclave Seguro** (SEP). O SEP √© um coprocessador que fornece **opera√ß√µes criptogr√°ficas para prote√ß√£o de dados e gerenciamento de chaves**. Uma chave de hardware espec√≠fica do dispositivo - o **UID do dispositivo** (ID exclusivo) - √© **incorporada no enclave seguro**, garantindo a integridade da prote√ß√£o de dados mesmo quando o kernel do sistema operacional √© comprometido.

Quando um **arquivo √© criado** no disco, uma nova **chave AES de 256 bits √© gerada** com a ajuda do gerador de n√∫meros aleat√≥rios baseado em hardware do enclave seguro. O **conte√∫do do arquivo √© ent√£o criptografado com a chave gerada**. E ent√£o, esta **chave √© salva criptografada com uma chave de classe** juntamente com **o ID da classe**, com **ambos os dados criptografados pela chave do sistema**, dentro dos **metadados** do arquivo.

![](<../../.gitbook/assets/image (473).png>)

Para descriptografar o arquivo, os **metadados s√£o descriptografados usando a chave do sistema**. Em seguida, usando o **ID da classe**, a **chave da classe √© recuperada** **para descriptografar a chave por arquivo e descriptografar o arquivo.**

Os arquivos podem ser atribu√≠dos a uma das **quatro** **classes de prote√ß√£o** diferentes, que s√£o explicadas com mais detalhes no [Guia de Seguran√ßa da Plataforma Apple](https://help.apple.com/pdf/security/en_US/apple-platform-security-guide.pdf):

* **Prote√ß√£o Completa (NSFileProtectionComplete)**: Uma chave derivada do c√≥digo de acesso do usu√°rio e do UID do dispositivo protege esta chave de classe. A chave derivada √© apagada da mem√≥ria pouco depois que o dispositivo √© bloqueado, tornando os dados inacess√≠veis at√© que o usu√°rio desbloqueie o dispositivo.
* **Protegido a menos que aberto (NSFileProtectionCompleteUnlessOpen)**: Esta classe de prote√ß√£o √© semelhante √† Prote√ß√£o Completa, mas, se o arquivo for aberto quando desbloqueado, o aplicativo pode continuar a acessar o arquivo mesmo se o usu√°rio bloquear o dispositivo
```objectivec
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
    // Remove Keychain items here

    // Update the flag indicator
    userDefaults.set(true, forKey: "hasRunBefore")
    userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
* Ao desenvolver a funcionalidade de logout para um aplicativo iOS, certifique-se de que os dados do Keychain sejam apagados como parte do logout da conta. Isso permitir√° que os usu√°rios limpem suas contas antes de desinstalar um aplicativo.

# **Capacidades do aplicativo**

**Cada aplicativo tem um diret√≥rio inicial exclusivo e √© isolado**, de modo que n√£o pode acessar recursos do sistema protegidos ou arquivos armazenados pelo sistema ou por outros aplicativos. Essas restri√ß√µes s√£o implementadas por meio de pol√≠ticas de sandbox (tamb√©m conhecidas como _perfis_), que s√£o aplicadas pelo [Trusted BSD (MAC) Mandatory Access Control Framework](http://www.trustedbsd.org/mac.html) por meio de uma extens√£o do kernel.

Algumas [**capacidades/ permiss√µes**](https://help.apple.com/developer-account/#/dev21218dfd6) podem ser configuradas pelos desenvolvedores do aplicativo (por exemplo, Prote√ß√£o de Dados ou Compartilhamento de Keychain) e ter√£o efeito direto ap√≥s a instala√ß√£o. No entanto, para outras, **o usu√°rio ser√° explicitamente solicitado na primeira vez que o aplicativo tentar acessar um recurso protegido**.

As [_strings de prop√≥sito_](https://developer.apple.com/documentation/uikit/core\_app/protecting\_the\_user\_s\_privacy/accessing\_protected\_resources?language=objc#3037322) ou _strings de descri√ß√£o de uso_ s√£o textos personalizados que s√£o oferecidos aos usu√°rios no alerta de solicita√ß√£o de permiss√£o do sistema ao solicitar permiss√£o para acessar dados ou recursos protegidos.

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc\_%2F-Lf1AQw8W2q7BB5-il7r%2Fpermission\_request\_alert.png?alt=media)

Se tiver o c√≥digo-fonte original, voc√™ pode verificar as permiss√µes inclu√≠das no arquivo `Info.plist`:

* Abra o projeto com o Xcode.
* Encontre e abra o arquivo `Info.plist` no editor padr√£o e procure as chaves que come√ßam com `"Privacy -"`.

Voc√™ pode alternar a exibi√ß√£o para exibir os valores brutos clicando com o bot√£o direito e selecionando "Mostrar chaves/valores brutos" (desta forma, por exemplo, `"Privacy - Location When In Use Usage Description"` se transformar√° em `NSLocationWhenInUseUsageDescription`).

Se tiver apenas o IPA:

* Descompacte o IPA.
* O arquivo `Info.plist` est√° localizado em `Payload/<nome_do_aplicativo>.app/Info.plist`.
* Converta-o, se necess√°rio (por exemplo, `plutil -convert xml1 Info.plist`) conforme explicado no cap√≠tulo "Teste de seguran√ßa b√°sico do iOS", se√ß√£o "O arquivo Info.plist".
* Inspeccione todas as chaves _strings de prop√≥sito Info.plist_, geralmente terminando com `UsageDescription`:

    ```markup
      <plist version="1.0">
      <dict>
          <key>NSLocationWhenInUseUsageDescription</key>
          <string>Sua localiza√ß√£o √© usada para fornecer instru√ß√µes de navega√ß√£o para o seu destino.</string>
    ```

## Capacidades do dispositivo

As capacidades do dispositivo s√£o usadas pela App Store para garantir que apenas dispositivos compat√≠veis sejam listados e, portanto, possam baixar o aplicativo. Elas s√£o especificadas no arquivo `Info.plist` do aplicativo sob a chave [`UIRequiredDeviceCapabilities`](https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html#//apple\_ref/doc/plist/info/UIRequiredDeviceCapabilities).
```markup
<key>UIRequiredDeviceCapabilities</key>
<array>
    <string>armv7</string>
</array>
```
Normalmente, voc√™ encontrar√° a capacidade `armv7`, o que significa que o aplicativo √© compilado apenas para o conjunto de instru√ß√µes armv7, ou se for um aplicativo universal de 32/64 bits.

Por exemplo, um aplicativo pode depender completamente do NFC para funcionar (por exemplo, um aplicativo "Leitor de Tag NFC"). De acordo com a [Refer√™ncia de Compatibilidade de Dispositivos iOS arquivada](https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/DeviceCompatibilityMatrix/DeviceCompatibilityMatrix.html), o NFC s√≥ est√° dispon√≠vel a partir do iPhone 7 (e iOS 11). Um desenvolvedor pode querer excluir todos os dispositivos incompat√≠veis definindo a capacidade do dispositivo `nfc`.

## Direitos

> Os direitos s√£o pares de chave-valor que s√£o assinados em um aplicativo e permitem autentica√ß√£o al√©m de fatores de tempo de execu√ß√£o, como o ID de usu√°rio UNIX. Como os direitos s√£o assinados digitalmente, eles n√£o podem ser alterados. Os direitos s√£o usados extensivamente por aplicativos e daemons do sistema para **realizar opera√ß√µes privilegiadas espec√≠ficas que, de outra forma, exigiriam que o processo fosse executado como root**. Isso reduz enormemente o potencial de escalonamento de privil√©gios por um aplicativo ou daemon do sistema comprometido.

Por exemplo, se voc√™ deseja definir a capacidade "Prote√ß√£o de Dados Padr√£o", precisar√° ir para a guia **Capacidades** no Xcode e habilitar **Prote√ß√£o de Dados**. Isso √© escrito diretamente pelo Xcode no arquivo `<nomedoaplicativo>.entitlements` como o direito `com.apple.developer.default-data-protection` com o valor padr√£o `NSFileProtectionComplete`. No IPA, podemos encontrar isso em `embedded.mobileprovision` como:
```markup
<key>Entitlements</key>
<dict>
    ...
    <key>com.apple.developer.default-data-protection</key>
    <string>NSFileProtectionComplete</string>
</dict>
```
Para outras capacidades, como HealthKit, o usu√°rio deve ser solicitado a permiss√£o, portanto, n√£o √© suficiente adicionar as permiss√µes, chaves especiais e strings devem ser adicionadas ao arquivo `Info.plist` do aplicativo.

# Conceitos B√°sicos de Objective-C e Swift

O **Objective-C** possui um **tempo de execu√ß√£o din√¢mico**, portanto, quando um programa Objective-C √© executado no iOS, ele chama bibliotecas cujos **endere√ßos s√£o resolvidos em tempo de execu√ß√£o** comparando o nome da fun√ß√£o enviada na mensagem com uma lista de todos os nomes de fun√ß√£o dispon√≠veis.

No in√≠cio, apenas os aplicativos criados pela Apple eram executados nos iPhones, ent√£o eles tinham **acesso a tudo** porque eram **confi√°veis**. No entanto, quando a Apple **permitiu** **aplicativos de terceiros**, a Apple simplesmente removeu os arquivos de cabe√ßalho das fun√ß√µes poderosas para "escond√™-las" dos desenvolvedores. No entanto, os desenvolvedores descobriram que as fun√ß√µes "seguras" precisavam de algumas dessas fun√ß√µes n√£o documentadas e, criando um **arquivo de cabe√ßalho personalizado com os nomes das fun√ß√µes n√£o documentadas, era poss√≠vel invocar essas fun√ß√µes ocultas poderosas**. Na verdade, a Apple, antes de permitir que um aplicativo seja publicado, verifica se o aplicativo chama alguma dessas fun√ß√µes proibidas.

Ent√£o, surgiu o Swift. Como o **Swift √© vinculado estaticamente** (n√£o resolve o endere√ßo das fun√ß√µes em tempo de execu√ß√£o como o Objective-C), √© poss√≠vel verificar mais facilmente as chamadas que um programa Swift far√° por meio da an√°lise de c√≥digo est√°tico.

# Gerenciamento de Dispositivos

A partir da vers√£o 6 do iOS, h√° **suporte integrado para gerenciamento de dispositivos** com controles de granularidade fina que permitem que uma organiza√ß√£o controle os dispositivos Apple corporativos.\
A inscri√ß√£o pode ser **iniciada pelo usu√°rio instalando um agente** para acessar os aplicativos corporativos. Nesse caso, o dispositivo geralmente pertence ao usu√°rio.\
Ou a **empresa pode indicar os n√∫meros de s√©rie** dos dispositivos comprados ou o ID do pedido de compra e especificar o perfil MDM a ser instalado nesses dispositivos. Observe que a Apple **n√£o permite inscrever um dispositivo espec√≠fico dessa maneira duas vezes**. Depois que o primeiro perfil √© exclu√≠do, o usu√°rio precisa dar consentimento para instalar outro.

O usu√°rio pode ver as pol√≠ticas instaladas em _**Configura√ß√µes**_ --> _**Geral**_ --> _**Perfil e Gerenciamento de Dispositivos**_

Como essas pol√≠ticas MDM est√£o verificando e limitando outras aplica√ß√µes, elas est√£o **executando com mais privil√©gios**.\
Uma pol√≠tica MDM pode **for√ßar** **usu√°rios** a ter um **c√≥digo de acesso** definido com uma **complexidade** de senha **m√≠nima**.\
Os perfis est√£o vinculados ao ID do dispositivo, **assinados** e **criptografados** pelo servidor MDM e **√† prova de viola√ß√£o**. Eles **n√£o podem** ser **removidos** sem **perder** todos os **dados corporativos**.\
Os perfis MDM permitem **apagar** todos os **dados** se houver X **tentativas** de **senha** **falhadas**. Al√©m disso, o **administrador** pode **apagar** o iPhone remotamente sempre que quiser via interface MDM.

Os agentes MDM tamb√©m **verificar√£o** poss√≠veis jailbreaks do dispositivo, pois esse √© um estado muito perigoso para um iPhone.


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
