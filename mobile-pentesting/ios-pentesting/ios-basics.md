<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>


# 特権分離とサンドボックス

ユーザーがアクセスできるアプリケーションは**mobile**ユーザーとして実行され、重要なシステムプロセスは**root**として実行されます。\
ただし、サンドボックスを使用すると、プロセスやアプリケーションが実行できるアクションをより制御できます。

たとえば、2つのプロセスが同じユーザー（mobile）として実行されていても、**お互いのデータにアクセスしたり変更したりすることはできません**。

各アプリケーションは**`private/var/mobile/Applications/{ランダムなID}`**の下にインストールされます。\
インストールされると、アプリケーションは一部のシステム領域や機能（SMS、電話など）に対して制限付きの読み取りアクセスを持ちます。アプリケーションが**保護された領域**にアクセスしようとする場合、**許可を要求するポップアップ**が表示されます。

# データ保護

アプリ開発者は、iOSの**データ保護**APIを活用して、フラッシュメモリに保存されたユーザーデータの**細かいアクセス制御**を実装することができます。これらのAPIは、**Secure Enclave Processor**（SEP）の上に構築されています。SEPは、データ保護とキー管理のための**暗号操作**を提供するコプロセッサです。デバイス固有のハードウェアキーである**デバイスUID**（一意のID）は、**セキュアエンクレーブに埋め込まれており**、オペレーティングシステムカーネルが侵害された場合でもデータ保護の完全性を保証します。

**ファイルがディスク上に作成**されると、**256ビットのAESキーが生成**されます。このキーは、セキュアエンクレーブのハードウェアベースの乱数生成器の助けを借りて生成されます。**ファイルの内容は生成されたキーで暗号化**されます。そして、このキーは、**クラスキーとクラスIDと共に暗号化された状態でシステムのキーによって暗号化されたデータ**とともに、ファイルの**メタデータ**に保存されます。

![](<../../.gitbook/assets/image (473).png>)

ファイルを復号するためには、**メタデータをシステムのキーで復号**する必要があります。次に、**クラスID**を使用して**クラスキーを取得**し、**ファイルのキーを復号**してファイルを復号します。

ファイルは、[Apple Platform Security Guide](https://help.apple.com/pdf/security/en_US/apple-platform-security-guide.pdf)で詳しく説明されている**4つの異なる保護クラス**のいずれかに割り当てることができます。

* **Complete Protection (NSFileProtectionComplete)**: ユーザーのパスコードとデバイスUIDから派生したキーがこのクラスキーを保護します。デバイスがロックされるとすぐに、派生キーはメモリから削除されるため、ユーザーがデバイスをアンロックするまでデータにアクセスできません。
* **Protected Unless Open (NSFileProtectionCompleteUnlessOpen)**: この保護クラスはComplete Protectionと似ていますが、ファイルがアンロックされた状態で開かれている場合、ユーザーがデバイスをロックしてもアプリはファイルにアクセスし続けることができます。この保護クラスは、たとえばメールの添付ファイルがバックグラウンドでダウンロードされている場合に使用されます。
* **Protected Until First User Authentication (NSFileProtectionCompleteUntilFirstUserAuthentication)**: ユーザーがデバイスを起動後、初めてデバイスをアンロックするとすぐにファイルにアクセスできます。ユーザーがその後デバイスをロックしても、クラスキーはメモリから削除されずにアクセスできます。
* **No Protection (NSFileProtectionNone)**: この保護クラスのキーはUIDのみで保護されます。クラスキーは「Effaceable Storage」と呼ばれる領域に格納されます。Effaceable Storageは、iOSデバイスのフラッシュメモリの一部であり、小量のデータを保存することができます。この保護クラスは、データをすぐにリモートで削除するために存在します。

`NSFileProtectionNone`以外のすべてのクラスキーは、デバイスUIDとユーザーのパスコードから派生したキーで暗号化されます。そのため、復号はデバイス自体でのみ行われ、正しいパスコードが必要です。

iOS 7以降、デフォルトのデータ保護クラスは「Protected Until First User Authentication」です。

[**FileDP**](https://github.com/abjurato/FileDp-Source)は、各ファイルの
* **`kSecAttrAccessibleAlways`**: キーチェーンアイテムのデータは、デバイスがロックされているかどうかに関係なく、常にアクセスできます。
* **`kSecAttrAccessibleAlwaysThisDeviceOnly`**: キーチェーンアイテムのデータは、デバイスがロックされているかどうかに関係なく、常にアクセスできます。データはiCloudやローカルバックアップに含まれません。
* **`kSecAttrAccessibleAfterFirstUnlock`**: ユーザーによってデバイスが一度ロック解除されるまで、キーチェーンアイテムのデータにはアクセスできません。
* **`kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly`**: ユーザーによってデバイスが一度ロック解除されるまで、キーチェーンアイテムのデータにはアクセスできません。この属性を持つアイテムは新しいデバイスに移行しません。したがって、異なるデバイスのバックアップから復元した後、これらのアイテムは存在しません。
* **`kSecAttrAccessibleWhenUnlocked`**: ユーザーによってデバイスがロック解除されている間のみ、キーチェーンアイテムのデータにアクセスできます。
* **`kSecAttrAccessibleWhenUnlockedThisDeviceOnly`**: ユーザーによってデバイスがロック解除されている間のみ、キーチェーンアイテムのデータにアクセスできます。データはiCloudやローカルバックアップに含まれません。
* **`kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly`**: デバイスがロック解除されている場合にのみ、キーチェーンのデータにアクセスできます。この保護クラスは、デバイスにパスコードが設定されている場合にのみ使用できます。データはiCloudやローカルバックアップに含まれません。

**`AccessControlFlags`**は、ユーザーがキーに対して認証できるメカニズムを定義します（`SecAccessControlCreateFlags`）：

* **`kSecAccessControlDevicePasscode`**: パスコードを使用してアイテムにアクセスします。
* **`kSecAccessControlBiometryAny`**: 登録されたTouch IDの指紋のいずれかを使用してアイテムにアクセスします。指紋の追加や削除はアイテムを無効にしません。
* **`kSecAccessControlBiometryCurrentSet`**: 登録されたTouch IDの指紋のいずれかを使用してアイテムにアクセスします。指紋の追加や削除はアイテムを無効にします。
* **`kSecAccessControlUserPresence`**: 登録された指紋（Touch IDを使用）のいずれかを使用してアイテムにアクセスするか、パスコードをデフォルトとします。

Touch IDによって保護されたキー（`kSecAccessControlBiometryAny`または`kSecAccessControlBiometryCurrentSet`を使用）は、セキュアエンクレーブによって保護されています。キーチェーンにはトークンのみが保持され、実際のキーはセキュアエンクレーブに存在します。

iPhoneは、デバイスのロックを解除するためにユーザーが導入したパスコードを使用してキーチェーンの秘密を復号化します。

iOSは、_**AppIdentifierPrefix**_（チームID）と_**BundleIdentifier**_（開発者が提供する）を使用して、キーチェーンアイテムへのアクセス制御を強制します。その後、同じチームは2つのアプリをキーチェーンアイテムを共有するように設定できます。

バックアッププロセスが開始されると、キーチェーンのデータは暗号化されたままバックアップされ、キーチェーンのパスワードはバックアップに含まれません。

{% hint style="warning" %}
**脱獄されたデバイスでは、キーチェーンは保護されません。**
{% endhint %}

### **キーチェーンデータの永続性**

iOSでは、アプリケーションがアンインストールされると、アプリケーションによって使用されるキーチェーンデータはデバイスに保持されますが、アプリケーションのサンドボックスに保存されるデータは削除されます。デバイスのユーザーが工場出荷時のリセットを行わずにデバイスを販売する場合、前のユーザーが使用していた同じアプリケーションを再インストールすることで、デバイスの購入者は前のユーザーのアプリケーションアカウントとデータにアクセスできる場合があります。これには技術的な能力は必要ありません。

アプリケーションがアンインストールされる際にデータを強制的に削除するために、開発者が使用できるiOSのAPIはありません。代わりに、開発者は次の手順を実行して、アプリケーションのインストール間にキーチェーンデータが永続化されないようにする必要があります：

* インストール後、アプリケーションが初めて起動されると、アプリケーションに関連するすべてのキーチェーンデータを削除します。これにより、デバイスの2番目のユーザーが前のユーザーのアカウントに誤ってアクセスすることが防止されます。以下のSwiftの例は、この削除手順の基本的なデモンストレーションです：
```objectivec
let userDefaults = UserDefaults.standard

if userDefaults.bool(forKey: "hasRunBefore") == false {
// Remove Keychain items here

// Update the flag indicator
userDefaults.set(true, forKey: "hasRunBefore")
userDefaults.synchronize() // Forces the app to update UserDefaults
}
```
* iOSアプリケーションのログアウト機能を開発する際には、アカウントのログアウトの一環としてKeychainのデータが削除されることを確認してください。これにより、ユーザーはアプリケーションをアンインストールする前にアカウントをクリアすることができます。

# **アプリケーションの機能**

**各アプリには固有のホームディレクトリがあり、サンドボックス化されています**。これにより、保護されたシステムリソースやシステムまたは他のアプリによって保存されたファイルにアクセスすることはできません。これらの制限は、[Trusted BSD (MAC) Mandatory Access Control Framework](http://www.trustedbsd.org/mac.html)によってカーネル拡張を介して実施されるサンドボックスポリシー（またはプロファイル）によって実装されています。

一部の[**機能/許可**](https://help.apple.com/developer-account/#/dev21218dfd6)は、アプリの開発者によって設定できます（例：データ保護またはKeychain共有）し、インストール後に直接効果が現れます。ただし、他の機能については、**アプリが保護されたリソースにアクセスしようとする最初の時にユーザーに明示的に尋ねられます**。

[_目的の文字列_](https://developer.apple.com/documentation/uikit/core\_app/protecting\_the\_user\_s\_privacy/accessing\_protected\_resources?language=objc#3037322)または_使用目的の文字列_は、保護されたデータやリソースへのアクセスの許可を要求する際に、システムの許可リクエストアラートでユーザーに提供されるカスタムテキストです。

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc\_%2F-Lf1AQw8W2q7BB5-il7r%2Fpermission\_request\_alert.png?alt=media)

元のソースコードがある場合は、`Info.plist`ファイルに含まれる許可を確認できます：

* Xcodeでプロジェクトを開きます。
* デフォルトのエディタで`Info.plist`ファイルを見つけて開き、`"Privacy -"`で始まるキーを検索します。

右クリックして「Show Raw Keys/Values」を選択することで、ビューを生の値に切り替えることができます（これにより、たとえば`"Privacy - Location When In Use Usage Description"`が`NSLocationWhenInUseUsageDescription`に変わります）。

IPAのみがある場合：

* IPAを解凍します。
* `Info.plist`は`Payload/<appname>.app/Info.plist`にあります。
* 必要に応じて変換します（例：`plutil -convert xml1 Info.plist`）。「iOS Basic Security Testing」の章、「The Info.plist File」のセクションで説明されているように。
* 通常、すべての目的の文字列Info.plistキーを調べます。これらは通常、`UsageDescription`で終わります：

```markup
<plist version="1.0">
<dict>
<key>NSLocationWhenInUseUsageDescription</key>
<string>Your location is used to provide turn-by-turn directions to your destination.</string>
```

## デバイスの機能

デバイスの機能は、App Storeが互換性のあるデバイスのみをリストアップし、アプリのダウンロードを許可するために使用されます。これらは、アプリの`Info.plist`ファイルの[`UIRequiredDeviceCapabilities`](https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html#//apple\_ref/doc/plist/info/UIRequiredDeviceCapabilities)キーの下に指定されます。
```markup
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
</array>
```
> 通常、`armv7`の能力が見つかります。これは、アプリがarmv7命令セットのみにコンパイルされていることを意味します。または、32/64ビットのユニバーサルアプリの場合です。

たとえば、アプリが完全にNFCに依存している場合（例：["NFC Tag Reader"](https://itunes.apple.com/us/app/nfc-taginfo-by-nxp/id1246143596)アプリ）、[iOSデバイス互換性リファレンス（アーカイブ版）](https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/DeviceCompatibilityMatrix/DeviceCompatibilityMatrix.html)によると、NFCはiPhone 7（およびiOS 11）から利用可能です。開発者は、`nfc`デバイスの能力を設定することで、すべての非互換デバイスを除外することができます。

## エンタイトルメント

> エンタイトルメントは、ランタイム要因のようなものを超えた認証を可能にする、アプリに署名されたキーバリューペアです。エンタイトルメントはデジタルに署名されているため、変更することはできません。エンタイトルメントは、システムアプリやデーモンが特定の特権操作を実行するために広範に使用されます。これにより、侵害されたシステムアプリやデーモンによる特権エスカレーションの可能性が大幅に低下します。

たとえば、「デフォルトのデータ保護」機能を設定したい場合、Xcodeの**Capabilities**タブに移動し、**Data Protection**を有効にする必要があります。これは、Xcodeによって`<appname>.entitlements`ファイルに直接書き込まれ、デフォルト値`NSFileProtectionComplete`を持つ`com.apple.developer.default-data-protection`エンタイトルメントとして記述されます。IPA内では、これを`embedded.mobileprovision`内に見つけることができます。
```markup
<key>Entitlements</key>
<dict>
...
<key>com.apple.developer.default-data-protection</key>
<string>NSFileProtectionComplete</string>
</dict>
```
他の機能（例：HealthKit）については、ユーザーに許可を求める必要があります。そのため、エンタイトルメントを追加するだけでは十分ではありません。アプリの`Info.plist`ファイルに特別なキーと文字列を追加する必要があります。

# Objective-CとSwiftの基礎

**Objective-C**は**動的なランタイム**を持っているため、iOSでObjective-Cプログラムが実行されると、メッセージで送信された関数の名前を使用して、利用可能なすべての関数名のリストと比較して、ランタイムで関数のアドレスを解決します。

最初は、Appleが作成したアプリのみがiPhoneで実行され、信頼されていたため、彼らは**すべてにアクセスできました**。しかし、Appleが**サードパーティのアプリケーションを許可**すると、Appleは強力な関数のヘッダーファイルを削除して、開発者にそれらを「隠しました」。しかし、開発者は「安全な」関数にはこれらの未公開の関数が必要であることに気付き、未公開の関数の名前を含む**カスタムヘッダーファイルを作成するだけで、この強力な隠し関数を呼び出すことができました**。実際、Appleはアプリを公開する前に、そのアプリがこれらの禁止された関数のいずれかを呼び出しているかどうかをチェックします。

そして、Swiftが登場しました。**Swiftは静的にバインド**されているため（Objective-Cのようにランタイムで関数のアドレスを解決しない）、Swiftプログラムが行う呼び出しを静的なコード解析でより簡単にチェックできます。

# デバイス管理

iOSバージョン6以降、デバイス管理機能の**組み込みサポート**があり、組織が企業のAppleデバイスを制御できる細かい制御が可能です。\
登録は、ユーザーがエージェントをインストールして企業のアプリにアクセスすることで開始できます。この場合、デバイスは通常、ユーザーの所有です。\
または、企業は購入したデバイスのシリアル番号や注文IDを指定し、それらのデバイスにインストールするMDMプロファイルを指定することができます。ただし、Appleはこの方法で特定のデバイスを2回登録することを許可していません。最初のプロファイルが削除されると、別のプロファイルをインストールするためにユーザーの同意が必要です。

ユーザーは、_**設定**_ --> _**一般**_ --> _**プロファイルとデバイス管理**_でインストールされたポリシーを確認できます。

これらのMDMポリシーは他のアプリケーションをチェックおよび制限するため、**より高い特権で実行**されます。\
MDMポリシーは、ユーザーに**パスコード**の設定を強制することができます。パスワードの**複雑さ**には**最小**の要件があります。\
プロファイルはデバイスIDに紐づけられ、MDMサーバーによって**署名**され、**暗号化**され、**改ざん**できないようになっています。これらは**削除**することができず、削除するとすべての企業データが失われます。\
MDMプロファイルにより、X回の**パスワード誤り**がある場合にはすべてのデータを**消去**することができます。また、管理者はMDMインターフェースを介していつでもiPhoneを**リモートワイプ**することができます。

MDMエージェントは、デバイスの**脱獄**の可能性も**チェック**します。なぜなら、これはiPhoneにとって非常に危険な状態だからです。


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、PEASSの最新バージョンやHackTricksのPDFをダウンロードしたいですか？ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！**

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください**。

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください**。

</details>
