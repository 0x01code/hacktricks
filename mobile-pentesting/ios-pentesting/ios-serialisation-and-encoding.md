<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de cybers√©curit√© ? Voulez-vous voir votre entreprise annonc√©e dans HackTricks ? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) **groupe Discord** ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>




### NSCoding et NSSecureCoding

iOS est livr√© avec deux protocoles pour la **s√©rialisation** d'objets pour Objective-C ou les `NSObject`s : **`NSCoding`** et **`NSSecureCoding`**. Lorsqu'une **classe est conforme** √† l'un ou l'autre des protocoles, les donn√©es sont s√©rialis√©es en **`NSData`** : un wrapper pour les **tampons de bytes**. Notez que `Data` en Swift est identique √† `NSData` ou √† son homologue mutable : `NSMutableData`. Le protocole `NSCoding` d√©clare les deux m√©thodes qui doivent √™tre impl√©ment√©es pour coder/d√©coder ses variables d'instance. **Une classe utilisant `NSCoding` doit impl√©menter `NSObject` ou √™tre annot√©e comme une classe @objc**. Le protocole `NSCoding` n√©cessite de mettre en ≈ìuvre l'encodage et l'initialisation comme indiqu√© ci-dessous.
```swift
class CustomPoint: NSObject, NSCoding {

    //required by NSCoding:
    func encode(with aCoder: NSCoder) {
        aCoder.encode(x, forKey: "x")
        aCoder.encode(name, forKey: "name")
    }

    var x: Double = 0.0
    var name: String = ""

    init(x: Double, name: String) {
            self.x = x
            self.name = name
    }

    // required by NSCoding: initialize members using a decoder.
    required convenience init?(coder aDecoder: NSCoder) {
            guard let name = aDecoder.decodeObject(forKey: "name") as? String
                    else {return nil}
            self.init(x:aDecoder.decodeDouble(forKey:"x"),
                                name:name)
    }

    //getters/setters/etc.
}
```
Le probl√®me avec `NSCoding` est que l'objet est souvent d√©j√† construit et ins√©r√© avant que vous puissiez √©valuer le type de classe. Cela permet √† un attaquant d'injecter facilement toutes sortes de donn√©es. Par cons√©quent, le protocole `NSSecureCoding` a √©t√© introduit. Lorsque vous vous conformez √† [`NSSecureCoding`](https://developer.apple.com/documentation/foundation/NSSecureCoding), vous devez inclure:
```swift
static var supportsSecureCoding: Bool {
        return true
}
```
lorsque `init(coder:)` fait partie de la classe. Ensuite, lors du d√©codage de l'objet, une v√©rification doit √™tre effectu√©e, par exemple :
```swift
let obj = decoder.decodeObject(of:MyClass.self, forKey: "myKey")
```
La conformit√© √† `NSSecureCoding` garantit que les objets instanci√©s sont bien ceux qui √©taient attendus. Cependant, **aucune v√©rification d'int√©grit√© suppl√©mentaire** n'est effectu√©e sur les donn√©es et les donn√©es ne sont pas chiffr√©es. Par cons√©quent, toute donn√©e secr√®te n√©cessite un **chiffrement** suppl√©mentaire et les donn√©es dont l'int√©grit√© doit √™tre prot√©g√©e doivent recevoir un HMAC suppl√©mentaire.

### Archivage d'objets avec NSKeyedArchiver

`NSKeyedArchiver` est une sous-classe concr√®te de `NSCoder` et permet de coder des objets et de les stocker dans un fichier. `NSKeyedUnarchiver` d√©code les donn√©es et recr√©e les donn√©es d'origine. Prenons l'exemple de la section `NSCoding` et archivons-les maintenant pour les d√©sarchiver ensuite :
```swift
// archiving:
NSKeyedArchiver.archiveRootObject(customPoint, toFile: "/path/to/archive")

// unarchiving:
guard let customPoint = NSKeyedUnarchiver.unarchiveObjectWithFile("/path/to/archive") as?
    CustomPoint else { return nil }
```
Vous pouvez √©galement enregistrer les informations dans le plist principal `NSUserDefaults`:
```swift
// archiving:
let data = NSKeyedArchiver.archivedDataWithRootObject(customPoint)
NSUserDefaults.standardUserDefaults().setObject(data, forKey: "customPoint")

// unarchiving:
if let data = NSUserDefaults.standardUserDefaults().objectForKey("customPoint") as? NSData {
    let customPoint = NSKeyedUnarchiver.unarchiveObjectWithData(data)
}
```
### Codable

Il s'agit d'une combinaison des protocoles `Decodable` et `Encodable`. Une `String`, `Int`, `Double`, `Date`, `Data` et `URL` sont `Codable` par nature: cela signifie qu'elles peuvent facilement √™tre encod√©es et d√©cod√©es sans aucun travail suppl√©mentaire. Prenons l'exemple suivant:
```swift
struct CustomPointStruct:Codable {
    var x: Double
    var name: String
}
```
En ajoutant `Codable` √† la liste d'h√©ritage pour `CustomPointStruct` dans l'exemple, les m√©thodes `init(from:)` et `encode(to:)` sont automatiquement prises en charge. Pour plus de d√©tails sur le fonctionnement de `Codable`, consultez [la documentation du d√©veloppeur Apple](https://developer.apple.com/documentation/foundation/archives\_and\_serialization/encoding\_and\_decoding\_custom\_types).

Vous pouvez √©galement utiliser `Codable` pour enregistrer les donn√©es dans la liste de propri√©t√©s primaires `NSUserDefaults`:
```swift
struct CustomPointStruct: Codable {
        var point: Double
        var name: String
    }

    var points: [CustomPointStruct] = [
        CustomPointStruct(point: 1, name: "test"),
        CustomPointStruct(point: 2, name: "test"),
        CustomPointStruct(point: 3, name: "test"),
    ]

    UserDefaults.standard.set(try? PropertyListEncoder().encode(points), forKey: "points")
    if let data = UserDefaults.standard.value(forKey: "points") as? Data {
        let points2 = try? PropertyListDecoder().decode([CustomPointStruct].self, from: data)
    }
```
### Encodage JSON

Il existe de nombreuses biblioth√®ques tierces pour encoder des donn√©es en JSON (comme expos√© [ici](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#json-and-codable)). Cependant, Apple prend en charge l'encodage/d√©codage JSON directement en combinant `Codable` avec un `JSONEncoder` et un `JSONDecoder`:
```swift
struct CustomPointStruct: Codable {
    var point: Double
    var name: String
}

let encoder = JSONEncoder()
encoder.outputFormatting = .prettyPrinted

let test = CustomPointStruct(point: 10, name: "test")
let data = try encoder.encode(test)
let stringData = String(data: data, encoding: .utf8)

// stringData = Optional ({
// "point" : 10,
// "name" : "test"
// })
```
### XML

Il existe plusieurs fa√ßons de faire de l'encodage XML. Tout comme l'analyse JSON, il existe diverses biblioth√®ques tierces, telles que: [Fuzi](https://github.com/cezheng/Fuzi), [Ono](https://github.com/mattt/Ono), [AEXML](https://github.com/tadija/AEXML), [RaptureXML](https://github.com/ZaBlanc/RaptureXML), [SwiftyXMLParser](https://github.com/yahoojapan/SwiftyXMLParser), [SWXMLHash](https://github.com/drmohundro/SWXMLHash)

Ils varient en termes de vitesse, d'utilisation de la m√©moire, de persistance des objets et plus important encore: diff√®rent dans la fa√ßon dont ils g√®rent les entit√©s externes XML. Voir [XXE dans le visualiseur de bureau Apple iOS](https://nvd.nist.gov/vuln/detail/CVE-2015-3784) comme exemple. Par cons√©quent, il est essentiel de d√©sactiver l'analyse des entit√©s externes si possible. Voir la [feuille de triche de pr√©vention XXE OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XML\_External\_Entity\_Prevention\_Cheat\_Sheet.html) pour plus de d√©tails. En plus des biblioth√®ques, vous pouvez utiliser la classe [`XMLParser` d'Apple](https://developer.apple.com/documentation/foundation/xmlparser)

Lorsque vous n'utilisez pas de biblioth√®ques tierces, mais la `XMLParser` d'Apple, assurez-vous de laisser `shouldResolveExternalEntities` renvoyer `false`.

{% hint style="danger" %}
Toutes ces fa√ßons de s√©rialiser/encoder des donn√©es peuvent √™tre **utilis√©es pour stocker des donn√©es dans le syst√®me de fichiers**. Dans ces sc√©narios, v√©rifiez si les donn√©es stock√©es contiennent des informations sensibles.\
De plus, dans certains cas, vous pouvez **abuser de certaines donn√©es s√©rialis√©es** (en les capturant via MitM ou en les modifiant √† l'int√©rieur du syst√®me de fichiers) en d√©s√©rialisant des donn√©es arbitraires et **en faisant ex√©cuter des actions inattendues √† l'application** (voir la page de d√©s√©rialisation). Dans ces cas, il est recommand√© d'envoyer/enregistrer les donn√©es s√©rialis√©es chiffr√©es et sign√©es.
{% endhint %}

## R√©f√©rences

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au repo [hacktricks](https://github.com/carlospolop/hacktricks) et [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
