<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション

- [**公式のPEASS＆HackTricksのスワッグ**](https://peass.creator-spring.com)を手に入れましょう

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>




### NSCodingとNSSecureCoding

iOSには、Objective-Cまたは`NSObject`のためのオブジェクト**シリアライゼーション**のための2つのプロトコルがあります：**`NSCoding`**と**`NSSecureCoding`**。クラスがいずれかのプロトコルに準拠すると、データは**`NSData`**にシリアライズされます：バイトバッファのラッパーです。Swiftの`Data`は`NSData`またはその可変対応である`NSMutableData`と同じです。`NSCoding`プロトコルは、インスタンス変数をエンコード/デコードするために実装する必要がある2つのメソッドを宣言します。**`NSCoding`を使用するクラスは、`NSObject`を実装するか、@objcクラスとして注釈を付ける必要があります**。以下に示すように、`NSCoding`プロトコルではエンコードとイニシャライズの実装が必要です。
```swift
class CustomPoint: NSObject, NSCoding {

//required by NSCoding:
func encode(with aCoder: NSCoder) {
aCoder.encode(x, forKey: "x")
aCoder.encode(name, forKey: "name")
}

var x: Double = 0.0
var name: String = ""

init(x: Double, name: String) {
self.x = x
self.name = name
}

// required by NSCoding: initialize members using a decoder.
required convenience init?(coder aDecoder: NSCoder) {
guard let name = aDecoder.decodeObject(forKey: "name") as? String
else {return nil}
self.init(x:aDecoder.decodeDouble(forKey:"x"),
name:name)
}

//getters/setters/etc.
}
```
`NSCoding`に関する問題は、オブジェクトがしばしば**クラスタイプを評価する前に既に構築および挿入されている**ことです。これにより、攻撃者は簡単にさまざまなデータを注入することができます。そのため、**`NSSecureCoding`**プロトコルが導入されました。[`NSSecureCoding`](https://developer.apple.com/documentation/foundation/NSSecureCoding)に準拠する場合、以下を含める必要があります：
```swift
static var supportsSecureCoding: Bool {
return true
}
```
`init(coder:)`がクラスの一部である場合、オブジェクトをデコードする際には、次のようなチェックを行う必要があります。
```swift
let obj = decoder.decodeObject(of:MyClass.self, forKey: "myKey")
```
`NSSecureCoding`への適合は、インスタンス化されるオブジェクトが予想されているものであることを保証します。ただし、データに対しては**追加の整合性チェックは行われず**、データは暗号化されません。したがって、秘密データは追加の**暗号化**が必要であり、整合性を保護する必要があるデータは追加のHMACを取得する必要があります。

### NSKeyedArchiverを使用したオブジェクトのアーカイブ

`NSKeyedArchiver`は、オブジェクトをエンコードしてファイルに保存するための`NSCoder`の具象サブクラスです。`NSKeyedUnarchiver`はデータをデコードし、元のデータを再作成します。`NSCoding`セクションの例を取り上げて、これらをアーカイブしてアンアーカイブしましょう。
```swift
// archiving:
NSKeyedArchiver.archiveRootObject(customPoint, toFile: "/path/to/archive")

// unarchiving:
guard let customPoint = NSKeyedUnarchiver.unarchiveObjectWithFile("/path/to/archive") as?
CustomPoint else { return nil }
```
主要なplist `NSUserDefaults`に情報を保存することもできます。
```swift
// archiving:
let data = NSKeyedArchiver.archivedDataWithRootObject(customPoint)
NSUserDefaults.standardUserDefaults().setObject(data, forKey: "customPoint")

// unarchiving:
if let data = NSUserDefaults.standardUserDefaults().objectForKey("customPoint") as? NSData {
let customPoint = NSKeyedUnarchiver.unarchiveObjectWithData(data)
}
```
### Codable

`Codable`は`Decodable`と`Encodable`プロトコルの組み合わせです。`String`、`Int`、`Double`、`Date`、`Data`、`URL`は自然に`Codable`であり、追加の作業なしで簡単にエンコードおよびデコードすることができます。以下に例を示します：
```swift
struct CustomPointStruct:Codable {
var x: Double
var name: String
}
```
`Codable`を`CustomPointStruct`の継承リストに追加することで、例の`init(from:)`と`encode(to:)`メソッドが自動的にサポートされます。`Codable`の動作の詳細については、[Apple Developer Documentation](https://developer.apple.com/documentation/foundation/archives\_and\_serialization/encoding\_and\_decoding\_custom\_types)を参照してください。

また、`Codable`を使用してデータをプライマリプロパティリスト`NSUserDefaults`に保存することもできます。
```swift
struct CustomPointStruct: Codable {
var point: Double
var name: String
}

var points: [CustomPointStruct] = [
CustomPointStruct(point: 1, name: "test"),
CustomPointStruct(point: 2, name: "test"),
CustomPointStruct(point: 3, name: "test"),
]

UserDefaults.standard.set(try? PropertyListEncoder().encode(points), forKey: "points")
if let data = UserDefaults.standard.value(forKey: "points") as? Data {
let points2 = try? PropertyListDecoder().decode([CustomPointStruct].self, from: data)
}
```
### JSONエンコーディング

JSONデータをエンコードするためのサードパーティのライブラリ（[ここ](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#json-and-codable)で紹介されています）はたくさんあります。しかし、Appleは`Codable`を`JSONEncoder`と`JSONDecoder`と組み合わせることで、JSONのエンコードとデコードを直接サポートしています。
```swift
struct CustomPointStruct: Codable {
var point: Double
var name: String
}

let encoder = JSONEncoder()
encoder.outputFormatting = .prettyPrinted

let test = CustomPointStruct(point: 10, name: "test")
let data = try encoder.encode(test)
let stringData = String(data: data, encoding: .utf8)

// stringData = Optional ({
// "point" : 10,
// "name" : "test"
// })
```
### XML

XMLエンコーディングには複数の方法があります。JSONパースと同様に、[Fuzi](https://github.com/cezheng/Fuzi)、[Ono](https://github.com/mattt/Ono)、[AEXML](https://github.com/tadija/AEXML)、[RaptureXML](https://github.com/ZaBlanc/RaptureXML)、[SwiftyXMLParser](https://github.com/yahoojapan/SwiftyXMLParser)、[SWXMLHash](https://github.com/drmohundro/SWXMLHash)などのさまざまなサードパーティライブラリがあります。

これらのライブラリは、速度、メモリ使用量、オブジェクトの永続性などの点で異なりますが、より重要なのは、XML外部エンティティの処理方法が異なることです。例として、[Apple iOSオフィスビューアのXXE](https://nvd.nist.gov/vuln/detail/CVE-2015-3784)を参照してください。したがって、可能な限り外部エンティティのパースを無効にすることが重要です。詳細については、[OWASP XXE防止チートシート](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)を参照してください。これらのライブラリの他に、Appleの[`XMLParser`クラス](https://developer.apple.com/documentation/foundation/xmlparser)を使用することもできます。

サードパーティライブラリではなく、Appleの`XMLParser`を使用する場合は、`shouldResolveExternalEntities`が`false`を返すようにしてください。

{% hint style="danger" %}
これらのデータのシリアル化/エンコード方法は、データをファイルシステムに保存するために使用できます。このようなシナリオでは、保存されたデータに**機密情報**が含まれていないかどうかを確認してください。さらに、一部の場合では、シリアル化されたデータを悪用することができます（MitM経由でキャプチャしたり、ファイルシステム内で変更したりして任意のデータをデシリアライズし、アプリケーションに予期しない動作をさせることができます）（詳細は[デシリアライゼーションページ](../../pentesting-web/deserialization/)を参照）。このような場合は、シリアル化されたデータを暗号化して署名付きで送信/保存することを推奨します。
{% endhint %}

## 参考文献

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロードしたりしたいですか？ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！**

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)をご覧ください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>
