<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>




### NSCoding et NSSecureCoding

iOS est √©quip√© de deux protocoles pour la **s√©rialisation** d'objets pour Objective-C ou `NSObject`s : **`NSCoding`** et **`NSSecureCoding`**. Lorsqu'une **classe se conforme** √† l'un de ces protocoles, les donn√©es sont s√©rialis√©es en **`NSData`** : un wrapper pour les **buffers d'octets**. Notez que `Data` en Swift est identique √† `NSData` ou √† son √©quivalent modifiable : `NSMutableData`. Le protocole `NSCoding` d√©clare les deux m√©thodes qui doivent √™tre impl√©ment√©es pour encoder/d√©coder ses variables d'instance. **Une classe utilisant `NSCoding` doit impl√©menter `NSObject` ou √™tre annot√©e comme une classe @objc**. Le protocole `NSCoding` exige de mettre en ≈ìuvre encode et init comme indiqu√© ci-dessous.
```swift
class CustomPoint: NSObject, NSCoding {

//required by NSCoding:
func encode(with aCoder: NSCoder) {
aCoder.encode(x, forKey: "x")
aCoder.encode(name, forKey: "name")
}

var x: Double = 0.0
var name: String = ""

init(x: Double, name: String) {
self.x = x
self.name = name
}

// required by NSCoding: initialize members using a decoder.
required convenience init?(coder aDecoder: NSCoder) {
guard let name = aDecoder.decodeObject(forKey: "name") as? String
else {return nil}
self.init(x:aDecoder.decodeDouble(forKey:"x"),
name:name)
}

//getters/setters/etc.
}
```
Le probl√®me avec `NSCoding` est que l'objet est souvent d√©j√† **construit et ins√©r√© avant que vous puissiez √©valuer** le type de classe. Cela **permet √† un attaquant d'injecter facilement toutes sortes de donn√©es**. Par cons√©quent, le protocole **`NSSecureCoding`** a √©t√© introduit. Lorsque vous vous conformez √† [`NSSecureCoding`](https://developer.apple.com/documentation/foundation/NSSecureCoding), vous devez inclure :
```swift
static var supportsSecureCoding: Bool {
return true
}
```
```markdown
lorsque `init(coder:)` fait partie de la classe. Ensuite, lors du d√©codage de l'objet, une v√©rification doit √™tre effectu√©e, par exemple :
```
```swift
let obj = decoder.decodeObject(of:MyClass.self, forKey: "myKey")
```
La conformit√© √† `NSSecureCoding` garantit que les objets instanci√©s sont bien ceux qui √©taient attendus. Cependant, **aucun contr√¥le d'int√©grit√© suppl√©mentaire n'est effectu√©** sur les donn√©es et celles-ci ne sont pas chiffr√©es. Par cons√©quent, toute donn√©e secr√®te n√©cessite un **chiffrement** suppl√©mentaire et les donn√©es dont l'int√©grit√© doit √™tre prot√©g√©e doivent recevoir un HMAC additionnel.

### Archivage d'objets avec NSKeyedArchiver

`NSKeyedArchiver` est une sous-classe concr√®te de `NSCoder` et offre un moyen de coder des objets et de les stocker dans un fichier. `NSKeyedUnarchiver` d√©code les donn√©es et recr√©e les donn√©es originales. Prenons l'exemple de la section `NSCoding` et archivons puis d√©sarchivons-les :
```swift
// archiving:
NSKeyedArchiver.archiveRootObject(customPoint, toFile: "/path/to/archive")

// unarchiving:
guard let customPoint = NSKeyedUnarchiver.unarchiveObjectWithFile("/path/to/archive") as?
CustomPoint else { return nil }
```
Vous pouvez √©galement enregistrer les informations dans le plist principal `NSUserDefaults` :
```swift
// archiving:
let data = NSKeyedArchiver.archivedDataWithRootObject(customPoint)
NSUserDefaults.standardUserDefaults().setObject(data, forKey: "customPoint")

// unarchiving:
if let data = NSUserDefaults.standardUserDefaults().objectForKey("customPoint") as? NSData {
let customPoint = NSKeyedUnarchiver.unarchiveObjectWithData(data)
}
```
### Codable

C'est une combinaison des protocoles `Decodable` et `Encodable`. Un `String`, `Int`, `Double`, `Date`, `Data` et `URL` sont naturellement `Codable` : cela signifie qu'ils peuvent √™tre facilement encod√©s et d√©cod√©s sans travail suppl√©mentaire. Prenons l'exemple suivant :
```swift
struct CustomPointStruct:Codable {
var x: Double
var name: String
}
```
En ajoutant `Codable` √† la liste d'h√©ritage pour le `CustomPointStruct` dans l'exemple, les m√©thodes `init(from:)` et `encode(to:)` sont automatiquement prises en charge. Pour plus de d√©tails sur le fonctionnement de `Codable`, consultez [la documentation pour d√©veloppeurs d'Apple](https://developer.apple.com/documentation/foundation/archives_and_serialization/encoding_and_decoding_custom_types).

Vous pouvez √©galement utiliser codable pour enregistrer les donn√©es dans la liste de propri√©t√©s principale `NSUserDefaults` :
```swift
struct CustomPointStruct: Codable {
var point: Double
var name: String
}

var points: [CustomPointStruct] = [
CustomPointStruct(point: 1, name: "test"),
CustomPointStruct(point: 2, name: "test"),
CustomPointStruct(point: 3, name: "test"),
]

UserDefaults.standard.set(try? PropertyListEncoder().encode(points), forKey: "points")
if let data = UserDefaults.standard.value(forKey: "points") as? Data {
let points2 = try? PropertyListDecoder().decode([CustomPointStruct].self, from: data)
}
```
### Encodage JSON

Il existe de nombreuses biblioth√®ques tierces pour encoder des donn√©es en JSON (comme expos√© [ici](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#json-and-codable)). Cependant, Apple offre un support pour l'encodage/d√©codage JSON directement en combinant `Codable` avec un `JSONEncoder` et un `JSONDecoder` :
```swift
struct CustomPointStruct: Codable {
var point: Double
var name: String
}

let encoder = JSONEncoder()
encoder.outputFormatting = .prettyPrinted

let test = CustomPointStruct(point: 10, name: "test")
let data = try encoder.encode(test)
let stringData = String(data: data, encoding: .utf8)

// stringData = Optional ({
// "point" : 10,
// "name" : "test"
// })
```
### XML

Il existe plusieurs fa√ßons de r√©aliser l'encodage XML. De mani√®re similaire √† l'analyse JSON, il existe diverses biblioth√®ques tierces, telles que : [Fuzi](https://github.com/cezheng/Fuzi), [Ono](https://github.com/mattt/Ono), [AEXML](https://github.com/tadija/AEXML), [RaptureXML](https://github.com/ZaBlanc/RaptureXML), [SwiftyXMLParser](https://github.com/yahoojapan/SwiftyXMLParser), [SWXMLHash](https://github.com/drmohundro/SWXMLHash)

Elles varient en termes de vitesse, d'utilisation de la m√©moire, de persistance des objets et plus important : elles diff√®rent dans la mani√®re dont elles g√®rent les entit√©s externes XML. Voir [XXE dans le visualiseur de documents Office iOS d'Apple](https://nvd.nist.gov/vuln/detail/CVE-2015-3784) comme exemple. Par cons√©quent, il est essentiel de d√©sactiver l'analyse des entit√©s externes si possible. Voir la [feuille de triche de pr√©vention XXE de l'OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html) pour plus de d√©tails. √Ä c√¥t√© des biblioth√®ques, vous pouvez utiliser la classe [`XMLParser` d'Apple](https://developer.apple.com/documentation/foundation/xmlparser)

Lorsque vous n'utilisez pas de biblioth√®ques tierces, mais `XMLParser` d'Apple, assurez-vous que `shouldResolveExternalEntities` retourne `false`.

{% hint style="danger" %}
Toutes ces m√©thodes de s√©rialisation/encodage peuvent √™tre **utilis√©es pour stocker des donn√©es dans le syst√®me de fichiers**. Dans ces sc√©narios, v√©rifiez si les donn√©es stock√©es contiennent des **informations sensibles**.\
De plus, dans certains cas, vous pourriez √™tre en mesure d'**abuser de certaines donn√©es s√©rialis√©es** (les capturant via MitM ou les modifiant dans le syst√®me de fichiers) en d√©s√©rialisant des donn√©es arbitraires et **en faisant ex√©cuter √† l'application des actions inattendues** (voir [page de D√©s√©rialisation](../../pentesting-web/deserialization/)). Dans ces cas, il est recommand√© d'envoyer/de sauvegarder les donn√©es s√©rialis√©es chiffr√©es et sign√©es.
{% endhint %}

## R√©f√©rences

{% embed url="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8" %}



<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
