# iOS Frida Configuration

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Kuweka Frida

**Hatua za kuweka Frida kwenye kifaa kilichovunjwa:**

1. Fungua programu ya Cydia/Sileo.
2. Nenda kwa Manage -> Sources -> Edit -> Add.
3. Ingiza "https://build.frida.re" kama URL.
4. Nenda kwenye chanzo cha Frida kilichoongezwa hivi karibuni.
5. Weka pakiti ya Frida.

Ikiwa unatumia **Corellium** utahitaji kupakua toleo la Frida kutoka [https://github.com/frida/frida/releases](https://github.com/frida/frida/releases) (`frida-gadget-[yourversion]-ios-universal.dylib.gz`) na kufungua na kuhamisha kwenye eneo la dylib ambalo Frida inauliza, kwa mfano: `/Users/[youruser]/.cache/frida/gadget-ios.dylib`

Baada ya kuweka, unaweza kutumia amri **`frida-ls-devices`** kwenye PC yako na kuhakikisha kuwa kifaa kinaonekana (PC yako inahitaji kuweza kufikia kifaa hicho).\
Pia tekeleza **`frida-ps -Uia`** kuangalia michakato inayofanya kazi kwenye simu.

## Frida bila kifaa kilichovunjwa & bila kusahihisha programu

Angalia chapisho hili la blogu kuhusu jinsi ya kutumia Frida kwenye vifaa visivyovunjwa bila kusahihisha programu: [https://mrbypass.medium.com/unlocking-potential-exploring-frida-objection-on-non-jailbroken-devices-without-application-ed0367a84f07](https://mrbypass.medium.com/unlocking-potential-exploring-frida-objection-on-non-jailbroken-devices-without-application-ed0367a84f07)

## Kuweka Mteja wa Frida

Weka **zana za frida**:

```bash
pip install frida-tools
pip install frida
```

Baada ya kusakinisha seva ya Frida na kifaa kikiwa kinaendeshwa na kimeunganishwa, **angalia** ikiwa mteja anafanya **kazi**:

```bash
frida-ls-devices  # List devices
frida-ps -Uia     # Get running processes
```

## Kufuatilia kwa Frida

Frida is a dynamic instrumentation toolkit for developers, reverse-engineers, and security researchers. It allows you to inject JavaScript code into native apps on Windows, macOS, Linux, iOS, Android, and QNX.

Frida ni seti ya zana za kufuatilia za kudhibiti mazingira kwa ajili ya watengenezaji, watafiti wa usalama, na watafiti wa kurudisha nyuma. Inaruhusu kuingiza nambari ya JavaScript katika programu za asili kwenye Windows, macOS, Linux, iOS, Android, na QNX.

### Configuration

### Usanidi

To configure Frida for iOS pentesting, follow these steps:

Ili kusanidi Frida kwa ajili ya pentesting ya iOS, fuata hatua zifuatazo:

1.  Install Frida on your machine by running the following command:

    1. Sakinisha Frida kwenye kompyuta yako kwa kukimbia amri ifuatayo:

    ```bash
    pip install frida-tools
    ```
2. Connect your iOS device to your machine using a USB cable.
   2. Unganisha kifaa chako cha iOS kwenye kompyuta yako kwa kutumia kebo ya USB.
3.  Install Frida on your iOS device by running the following command:

    3. Sakinisha Frida kwenye kifaa chako cha iOS kwa kukimbia amri ifuatayo:

    ```bash
    pip install frida
    ```
4.  Verify that Frida is installed correctly by running the following command:

    4. Hakikisha kuwa Frida imesakinishwa kwa usahihi kwa kukimbia amri ifuatayo:

    ```bash
    frida-ps -U
    ```

    You should see a list of running processes on your iOS device.

    Unapaswa kuona orodha ya michakato inayofanya kazi kwenye kifaa chako cha iOS.

### Usage

### Matumizi

To trace function calls in an iOS app using Frida, follow these steps:

Ili kufuatilia wito wa kazi katika programu ya iOS kwa kutumia Frida, fuata hatua zifuatazo:

1. Identify the target app's bundle identifier. You can find this information in the app's `Info.plist` file or by using tools like `frida-ps -U`.
   1. Tambua kitambulisho cha mfuko cha programu ya lengo. Unaweza kupata habari hii katika faili ya `Info.plist` ya programu au kwa kutumia zana kama `frida-ps -U`.
2.  Create a JavaScript file with the following code:

    2. Unda faili ya JavaScript na nambari ifuatayo:

    ```javascript
    // Trace function calls
    // Futa wito wa kazi
    function traceFunctionCalls() {
      var targetApp = "com.example.app"; // Replace with the target app's bundle identifier
      var targetMethod = "-[TargetClass targetMethod:]"; // Replace with the target class and method name

      var target = ObjC.classes[targetApp];
      var hook = ObjC.classes[targetMethod];

      Interceptor.attach(hook.implementation, {
        onEnter: function (args) {
          console.log("Called " + targetMethod);
        },
      });
    }

    // Call the traceFunctionCalls() function
    // Piga kazi ya traceFunctionCalls()
    traceFunctionCalls();
    ```
3. Replace `com.example.app` with the target app's bundle identifier and `-[TargetClass targetMethod:]` with the target class and method name you want to trace.
   3. Badilisha `com.example.app` na kitambulisho cha mfuko cha programu ya lengo na `-[TargetClass targetMethod:]` na jina la darasa na kazi ya lengo unayotaka kufuatilia.
4. Save the JavaScript file with a `.js` extension.
   4. Hifadhi faili ya JavaScript na kipengee cha `.js`.
5.  Run the following command to start tracing function calls in the target app:

    5. Kukimbia amri ifuatayo ili kuanza kufuatilia wito wa kazi katika programu ya lengo:

    ```bash
    frida -U -l path/to/your/javascript/file.js -f com.example.app
    ```

    Replace `path/to/your/javascript/file.js` with the path to your JavaScript file and `com.example.app` with the target app's bundle identifier.

    Badilisha `path/to/your/javascript/file.js` na njia ya faili yako ya JavaScript na `com.example.app` na kitambulisho cha mfuko cha programu ya lengo.
6. Launch the target app on your iOS device.
   6. Zindua programu ya lengo kwenye kifaa chako cha iOS.
7. You should see the function calls being traced in the Frida console.
   7. Unapaswa kuona wito wa kazi unafuatiliwa kwenye konsoli ya Frida.

```bash
# Functions
## Trace all functions with the word "log" in their name
frida-trace -U <program> -i "*log*"
frida-trace -U <program> -i "*log*" | swift demangle # Demangle names

# Objective-C
## Trace all methods of all classes
frida-trace -U <program> -m "*[* *]"

## Trace all methods with the word "authentication" from classes that start with "NE"
frida-trace -U <program> -m "*[NE* *authentication*]"

# Plug-In
## To hook a plugin that is momentarely executed prepare Frida indicating the ID of the Plugin binary
frida-trace -U -W <if-plugin-bin> -m '*[* *]'
```

### Pata darasa zote na njia

* Kukamilisha moja kwa moja: Tekeleza tu `frida -U <programu>`

<figure><img src="../../.gitbook/assets/image (687).png" alt=""><figcaption></figcaption></figure>

* Pata **darasa zote** zilizopo (chuja kwa kutumia herufi)

{% code title="/tmp/script.js" %}
```javascript
// frida -U <program> -l /tmp/script.js

var filterClass = "filterstring";

if (ObjC.available) {
for (var className in ObjC.classes) {
if (ObjC.classes.hasOwnProperty(className)) {
if (!filterClass || className.includes(filterClass)) {
console.log(className);
}
}
}
} else {
console.log("Objective-C runtime is not available.");
}
```
{% endcode %}

* Pata **njia zote** za **darasa** (chuja kwa kutumia herufi)

{% code title="/tmp/script.js" %}
```javascript
// frida -U <program> -l /tmp/script.js

var specificClass = "YourClassName";
var filterMethod = "filtermethod";

if (ObjC.available) {
if (ObjC.classes.hasOwnProperty(specificClass)) {
var methods = ObjC.classes[specificClass].$ownMethods;
for (var i = 0; i < methods.length; i++) {
if (!filterMethod || methods[i].includes(filterClass)) {
console.log(specificClass + ': ' + methods[i]);
}
}
} else {
console.log("Class not found.");
}
} else {
console.log("Objective-C runtime is not available.");
}
```
{% endcode %}

* **Piga simu kwa kazi**

```javascript
// Find the address of the function to call
const func_addr = Module.findExportByName("<Prog Name>", "<Func Name>");
// Declare the function to call
const func = new NativeFunction(
func_addr,
"void", ["pointer", "pointer", "pointer"], {
});

var arg0 = null;

// In this case to call this function we need to intercept a call to it to copy arg0
Interceptor.attach(wg_log_addr, {
onEnter: function(args) {
arg0 = new NativePointer(args[0]);
}
});

// Wait untill a call to the func occurs
while (! arg0) {
Thread.sleep(1);
console.log("waiting for ptr");
}


var arg1 = Memory.allocUtf8String('arg1');
var txt = Memory.allocUtf8String('Some text for arg2');
wg_log(arg0, arg1, txt);

console.log("loaded");
```

## Frida Fuzzing

### Frida Stalker

[Kutoka kwa nyaraka](https://frida.re/docs/stalker/): Stalker ni injini ya kufuatilia ya Frida. Inaruhusu nyuzi kufuatwa, kuchukua kila kazi, kila kizuizi, hata kila amri inayotekelezwa.

Una mfano wa kutekeleza Frida Stalker katika [https://github.com/poxyran/misc/blob/master/frida-stalker-example.py](https://github.com/poxyran/misc/blob/master/frida-stalker-example.py)

Hii ni mfano mwingine wa kuambatisha Frida Stalker kila wakati kazi inaitwa:

```javascript
console.log("loading");
const wg_log_addr = Module.findExportByName("<Program>", "<function_name>");
const wg_log = new NativeFunction(
wg_log_addr,
"void", ["pointer", "pointer", "pointer"], {
});

Interceptor.attach(wg_log_addr, {
onEnter: function(args) {
console.log(`logging the following message: ${args[2].readCString()}`);

Stalker.follow({
events: {
// only collect coverage for newly encountered blocks
compile: true,
},
onReceive: function (events) {
const bbs = Stalker.parse(events, {
stringify: false,
annotate: false
});
console.log("Stalker trace of write_msg_to_log: \n" + bbs.flat().map(DebugSymbol.fromAddress).join('\n'));
}
});
},
onLeave: function(retval) {
Stalker.unfollow();
Stalker.flush();  // this is important to get all events
}
});
```

{% hint style="danger" %}
Hii ni ya kuvutia kwa madhumuni ya kurekebisha makosa lakini kwa ajili ya kufanya fuzzing, kuwa kila wakati **`.follow()`** na **`.unfollow()`** ni ya ufanisi mdogo.
{% endhint %}

## [Fpicker](https://github.com/ttdennis/fpicker)

[**fpicker**](https://github.com/ttdennis/fpicker) ni seti ya kufanya fuzzing iliyotegemea Frida ambayo inatoa aina mbalimbali za modes za kufanya fuzzing ndani ya mchakato, kama vile mode ya AFL++ au mode ya kufuatilia pasipoti. Inapaswa kuendesha kwenye majukwaa yote yanayoungwa mkono na Frida.

* [**Sakinisha fpicker**](https://github.com/ttdennis/fpicker#requirements-and-installation) **& radamsa**

```bash
# Get fpicker
git clone https://github.com/ttdennis/fpicker
cd fpicker

# Get Frida core devkit and prepare fpicker
wget https://github.com/frida/frida/releases/download/16.1.4/frida-core-devkit-16.1.4-[yourOS]-[yourarchitecture].tar.xz
# e.g. https://github.com/frida/frida/releases/download/16.1.4/frida-core-devkit-16.1.4-macos-arm64.tar.xz
tar -xf ./*tar.xz
cp libfrida-core.a libfrida-core-[yourOS].a #libfrida-core-macos.a

# Install fpicker
make fpicker-[yourOS] # fpicker-macos
# This generates ./fpicker

# Install radamsa (fuzzer generator)
brew install radamsa
```

* **Andaa FS:**

```bash
# From inside fpicker clone
mkdir -p examples/wg-log # Where the fuzzing script will be
mkdir -p examples/wg-log/out # For code coverage and crashes
mkdir -p examples/wg-log/in # For starting inputs

# Create at least 1 input for the fuzzer
echo Hello World > examples/wg-log/in/0
```

* **Fuzzer script** (`examples/wg-log/myfuzzer.js`):

{% code title="examples/wg-log/myfuzzer.js" %}
```javascript
// Import the fuzzer base class
import { Fuzzer } from "../../harness/fuzzer.js";

class WGLogFuzzer extends Fuzzer {

constructor() {
console.log("WGLogFuzzer constructor called")

// Get and declare the function we are going to fuzz
var wg_log_addr = Module.findExportByName("<Program name>", "<func name to fuzz>");
var wg_log_func = new NativeFunction(
wg_log_addr,
"void", ["pointer", "pointer", "pointer"], {
});

// Initialize the object
super("<Program nane>", wg_log_addr, wg_log_func);
this.wg_log_addr = wg_log_addr; // We cannot use "this" before calling "super"

console.log("WGLogFuzzer in the middle");

// Prepare the second argument to pass to the fuzz function
this.tag = Memory.allocUtf8String("arg2");

// Get the first argument we need to pass from a call to the functino we want to fuzz
var wg_log_global_ptr = null;
console.log(this.wg_log_addr);
Interceptor.attach(this.wg_log_addr, {
onEnter: function(args) {
console.log("Entering in the function to get the first argument");
wg_log_global_ptr = new NativePointer(args[0]);
}
});

while (! wg_log_global_ptr) {
Thread.sleep(1)
}
this.wg_log_global_ptr = wg_log_global_ptr;
console.log("WGLogFuzzer prepare ended")
}


// This function is called by the fuzzer with the first argument being a pointer into memory
// where the payload is stored and the second the length of the input.
fuzz(payload, len) {
// Get a pointer to payload being a valid C string (with a null byte at the end)
var payload_cstring = payload.readCString(len);
this.payload = Memory.allocUtf8String(payload_cstring);

// Debug and fuzz
this.debug_log(this.payload, len);
// Pass the 2 first arguments we know the function needs and finally the payload to fuzz
this.target_function(this.wg_log_global_ptr, this.tag, this.payload);
}
}

const f = new WGLogFuzzer();
rpc.exports.fuzzer = f;
```
{% endcode %}

* **Kompili** fuzzer:

```bash
# From inside fpicker clone
## Compile from "myfuzzer.js" to "harness.js"
frida-compile examples/wg-log/myfuzzer.js -o harness.js
```

* Piga fuzzer **`fpicker`** kwa kutumia **`radamsa`**:

{% code overflow="wrap" %}
```bash
# Indicate fpicker to fuzz a program with the harness.js script and which folders to use
fpicker -v --fuzzer-mode active -e attach -p <Program to fuzz> -D usb -o examples/wg-log/out/ -i examples/wg-log/in/ -f harness.js --standalone-mutator cmd --mutator-command "radamsa"
# You can find code coverage and crashes in examples/wg-log/out/
```
{% endcode %}

{% hint style="danger" %}
Katika kesi hii hatuendeshi tena programu au kurejesha hali baada ya kila mzigo. Kwa hivyo, ikiwa Frida inapata ajali, kuingia ijayo baada ya mzigo huo inaweza pia kusababisha programu kugonga (kwa sababu programu iko katika hali isiyotabirika) hata ikiwa kuingia haipaswi kusababisha programu kugonga.

Zaidi ya hayo, Frida itaunganisha ishara za kipekee za iOS, kwa hivyo wakati Frida inapata ajali, labda ripoti ya ajali ya iOS haitazalishwa.

Ili kuzuia hii, kwa mfano, tunaweza kuanzisha tena programu baada ya kila ajali ya Frida.
{% endhint %}

### Kumbukumbu na Ajali

Unaweza kuangalia **console ya macOS** au **cli ya `log`** kuangalia kumbukumbu za macOS.\
Unaweza pia kuangalia kumbukumbu kutoka kwa iOS kwa kutumia **`idevicesyslog`**.\
Baadhi ya kumbukumbu zitakosa habari kwa kuongeza **`<private>`**. Ili kuonyesha habari zote unahitaji kusakinisha wasifu fulani kutoka [https://developer.apple.com/bug-reporting/profiles-and-logs/](https://developer.apple.com/bug-reporting/profiles-and-logs/) kuwezesha habari hiyo ya faragha.

Ikiwa hujui cha kufanya:

```sh
vim /Library/Preferences/Logging/com.apple.system.logging.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>Enable-Private-Data</key>
<true/>
</dict>
</plist>

killall -9 logd
```

Unaweza kuangalia ajali katika:

* **iOS**
* Mipangilio ‚Üí Faragha ‚Üí Takwimu za Uchambuzi na Kuboresha ‚Üí Takwimu za Uchambuzi
* `/private/var/mobile/Library/Logs/CrashReporter/`
* **macOS**:
* `/Library/Logs/DiagnosticReports/`
* `~/Library/Logs/DiagnosticReports`

{% hint style="warning" %}
iOS inahifadhi ajali 25 za programu ile ile, kwa hivyo unahitaji kusafisha hiyo au iOS itasita kuunda ajali.
{% endhint %}

## Frida Android Mafunzo

{% content-ref url="../android-app-pentesting/frida-tutorial/" %}
[frida-tutorial](../android-app-pentesting/frida-tutorial/)
{% endcontent-ref %}

## Marejeo

* [https://www.briskinfosec.com/blogs/blogsdetail/Getting-Started-with-Frida](https://www.briskinfosec.com/blogs/blogsdetail/Getting-Started-with-Frida)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
