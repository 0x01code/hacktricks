# iOS Frida Yapılandırması

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramanlık seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklam vermek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## Frida Kurulumu

**Jailbreak yapılmış bir cihaza Frida kurulumu adımları:**

1. Cydia/Sileo uygulamasını açın.
2. Yönet -> Kaynaklar -> Düzenle -> Ekle bölümüne gidin.
3. URL olarak "https://build.frida.re" adresini girin.
4. Yeni eklenen Frida kaynağına gidin.
5. Frida paketini kurun.

Eğer **Corellium** kullanıyorsanız, Frida'yı [https://github.com/frida/frida/releases](https://github.com/frida/frida/releases) adresinden indirmeniz gerekecek (`frida-gadget-[sürümünüz]-ios-universal.dylib.gz`) ve Frida'nın istediği dylib konumuna açıp kopyalamanız gerekecek, örneğin: `/Users/[kullanıcıadınız]/.cache/frida/gadget-ios.dylib`

Kurulum tamamlandıktan sonra, PC'nizde **`frida-ls-devices`** komutunu kullanarak cihazın görünüp görünmediğini kontrol edebilirsiniz (PC'nizin buna erişebilmesi gerekmektedir).\
Ayrıca **`frida-ps -Uia`** komutunu da çalıştırarak telefonun çalışan işlemlerini kontrol edebilirsiniz.

## Jailbreak yapılmamış cihazlarda ve uygulama yaması yapmadan Frida kullanımı

Frida'yı jailbreak yapılmamış cihazlarda ve uygulama yaması yapmadan nasıl kullanacağınız hakkında bu blog yazısına göz atın: [https://mrbypass.medium.com/unlocking-potential-exploring-frida-objection-on-non-jailbroken-devices-without-application-ed0367a84f07](https://mrbypass.medium.com/unlocking-potential-exploring-frida-objection-on-non-jailbroken-devices-without-application-ed0367a84f07)

## Frida İstemci Kurulumu

**frida araçlarını** kurun:
```bash
pip install frida-tools
pip install frida
```
Frida sunucusu yüklendikten ve cihaz çalışır durumdayken ve bağlıyken, istemcinin çalışıp çalışmadığını **kontrol edin**:
```bash
frida-ls-devices  # List devices
frida-ps -Uia     # Get running processes
```
## Frida İzleme

Frida is a dynamic instrumentation toolkit that allows you to inject JavaScript code into running processes. With Frida, you can trace and manipulate the behavior of iOS applications at runtime.

Frida bir dinamik enstrümantasyon aracıdır ve çalışan işlemlere JavaScript kodu enjekte etmenizi sağlar. Frida ile iOS uygulamalarının çalışma zamanında davranışlarını izleyebilir ve manipüle edebilirsiniz.

To configure Frida for iOS pentesting, follow these steps:

iOS pentesting için Frida'yı yapılandırmak için aşağıdaki adımları izleyin:

1. Install Frida on your machine by running the following command:

   Makinenize Frida'yı aşağıdaki komutu çalıştırarak yükleyin:

   ```
   $ pip install frida-tools
   ```

2. Connect your iOS device to your machine using a USB cable.

   USB kablosu kullanarak iOS cihazınızı makinenize bağlayın.

3. Install Frida on your iOS device by running the following command:

   Aşağıdaki komutu çalıştırarak iOS cihazınıza Frida'yı yükleyin:

   ```
   $ frida-ps -U
   ```

4. Verify that Frida is installed on your iOS device by running the following command:

   Aşağıdaki komutu çalıştırarak Frida'nın iOS cihazınıza yüklendiğini doğrulayın:

   ```
   $ frida-ps -U
   ```

5. Start the Frida server on your iOS device by running the following command:

   Aşağıdaki komutu çalıştırarak iOS cihazınızda Frida sunucusunu başlatın:

   ```
   $ frida-server -D
   ```

6. Verify that the Frida server is running on your iOS device by running the following command:

   Aşağıdaki komutu çalıştırarak Frida sunucusunun iOS cihazınızda çalıştığını doğrulayın:

   ```
   $ frida-ps -U
   ```

Once Frida is configured, you can start using it to trace and analyze iOS applications for security vulnerabilities and weaknesses.

Frida yapılandırıldıktan sonra, iOS uygulamalarını güvenlik açıkları ve zayıflıklar için izlemek ve analiz etmek için kullanmaya başlayabilirsiniz.
```bash
# Functions
## Trace all functions with the word "log" in their name
frida-trace -U <program> -i "*log*"
frida-trace -U <program> -i "*log*" | swift demangle # Demangle names

# Objective-C
## Trace all methods of all classes
frida-trace -U <program> -m "*[* *]"

## Trace all methods with the word "authentication" from classes that start with "NE"
frida-trace -U <program> -m "*[NE* *authentication*]"

# Plug-In
## To hook a plugin that is momentarely executed prepare Frida indicating the ID of the Plugin binary
frida-trace -U -W <if-plugin-bin> -m '*[* *]'
```
### Tüm sınıfları ve yöntemleri alın

* Otomatik tamamlama: Sadece `frida -U <program>` komutunu çalıştırın

<figure><img src="../../.gitbook/assets/image (687).png" alt=""><figcaption></figcaption></figure>

* Mevcut **tüm** **sınıfları** alın (dizeye göre filtreleme)

{% code title="/tmp/script.js" %}
```javascript
// frida -U <program> -l /tmp/script.js

var filterClass = "filterstring";

if (ObjC.available) {
for (var className in ObjC.classes) {
if (ObjC.classes.hasOwnProperty(className)) {
if (!filterClass || className.includes(filterClass)) {
console.log(className);
}
}
}
} else {
console.log("Objective-C runtime is not available.");
}
```
{% endcode %}

* Bir **sınıfın** **tüm** **metotlarını** (dize ile filtrele) alın

{% code title="/tmp/script.js" %}
```javascript
// frida -U <program> -l /tmp/script.js

var specificClass = "YourClassName";
var filterMethod = "filtermethod";

if (ObjC.available) {
if (ObjC.classes.hasOwnProperty(specificClass)) {
var methods = ObjC.classes[specificClass].$ownMethods;
for (var i = 0; i < methods.length; i++) {
if (!filterMethod || methods[i].includes(filterClass)) {
console.log(specificClass + ': ' + methods[i]);
}
}
} else {
console.log("Class not found.");
}
} else {
console.log("Objective-C runtime is not available.");
}
```
{% endcode %}

* **Bir fonksiyonu çağırın**
```javascript
// Find the address of the function to call
const func_addr = Module.findExportByName("<Prog Name>", "<Func Name>");
// Declare the function to call
const func = new NativeFunction(
func_addr,
"void", ["pointer", "pointer", "pointer"], {
});

var arg0 = null;

// In this case to call this function we need to intercept a call to it to copy arg0
Interceptor.attach(wg_log_addr, {
onEnter: function(args) {
arg0 = new NativePointer(args[0]);
}
});

// Wait untill a call to the func occurs
while (! arg0) {
Thread.sleep(1);
console.log("waiting for ptr");
}


var arg1 = Memory.allocUtf8String('arg1');
var txt = Memory.allocUtf8String('Some text for arg2');
wg_log(arg0, arg1, txt);

console.log("loaded");
```
## Frida Fuzzing

### Frida Stalker

[Dökümantasyondan](https://frida.re/docs/stalker/#:~:text=Stalker%20is%20Frida's%20code%20tracing,every%20instruction%20which%20is%20executed.) alıntı: Stalker, Frida'nın kod **izleme motoru**dur. İşlenen her işlevi, her bloğu ve hatta her talimatı **takip ederek** **yakalar**.

Frida Stalker'ı uygulayan bir örnek [https://github.com/poxyran/misc/blob/master/frida-stalker-example.py](https://github.com/poxyran/misc/blob/master/frida-stalker-example.py) adresinde bulunmaktadır.

Aşağıdaki örnek, bir işlev çağrıldığında Frida Stalker'ı eklemek için kullanılabilir:
```javascript
console.log("loading");
const wg_log_addr = Module.findExportByName("<Program>", "<function_name>");
const wg_log = new NativeFunction(
wg_log_addr,
"void", ["pointer", "pointer", "pointer"], {
});

Interceptor.attach(wg_log_addr, {
onEnter: function(args) {
console.log(`logging the following message: ${args[2].readCString()}`);

Stalker.follow({
events: {
// only collect coverage for newly encountered blocks
compile: true,
},
onReceive: function (events) {
const bbs = Stalker.parse(events, {
stringify: false,
annotate: false
});
console.log("Stalker trace of write_msg_to_log: \n" + bbs.flat().map(DebugSymbol.fromAddress).join('\n'));
}
});
},
onLeave: function(retval) {
Stalker.unfollow();
Stalker.flush();  // this is important to get all events
}
});
```
{% hint style="danger" %}
Bu, hata ayıklama amaçları için ilginç olsa da, sürekli olarak **`.follow()`** ve **`.unfollow()`** yapmak çok verimsizdir.
{% endhint %}

## [Fpicker](https://github.com/ttdennis/fpicker)

[**fpicker**](https://github.com/ttdennis/fpicker), in-process fuzzing için çeşitli fuzzing modları sunan bir **Frida tabanlı fuzzing paketi**dir. AFL++ modu veya pasif izleme modu gibi modları destekleyen bu paket, Frida tarafından desteklenen tüm platformlarda çalışmalıdır.

* [**fpicker**'ı yükleyin](https://github.com/ttdennis/fpicker#requirements-and-installation) **& radamsa**
```bash
# Get fpicker
git clone https://github.com/ttdennis/fpicker
cd fpicker

# Get Frida core devkit and prepare fpicker
wget https://github.com/frida/frida/releases/download/16.1.4/frida-core-devkit-16.1.4-[yourOS]-[yourarchitecture].tar.xz
# e.g. https://github.com/frida/frida/releases/download/16.1.4/frida-core-devkit-16.1.4-macos-arm64.tar.xz
tar -xf ./*tar.xz
cp libfrida-core.a libfrida-core-[yourOS].a #libfrida-core-macos.a

# Install fpicker
make fpicker-[yourOS] # fpicker-macos
# This generates ./fpicker

# Install radamsa (fuzzer generator)
brew install radamsa
```
* **Dosya Sistemi Hazırlığı:**
```bash
# From inside fpicker clone
mkdir -p examples/wg-log # Where the fuzzing script will be
mkdir -p examples/wg-log/out # For code coverage and crashes
mkdir -p examples/wg-log/in # For starting inputs

# Create at least 1 input for the fuzzer
echo Hello World > examples/wg-log/in/0
```
* **Fuzzer script** (`examples/wg-log/myfuzzer.js`):

{% code title="examples/wg-log/myfuzzer.js" %}
```javascript
// Import the fuzzer base class
import { Fuzzer } from "../../harness/fuzzer.js";

class WGLogFuzzer extends Fuzzer {

constructor() {
console.log("WGLogFuzzer constructor called")

// Get and declare the function we are going to fuzz
var wg_log_addr = Module.findExportByName("<Program name>", "<func name to fuzz>");
var wg_log_func = new NativeFunction(
wg_log_addr,
"void", ["pointer", "pointer", "pointer"], {
});

// Initialize the object
super("<Program nane>", wg_log_addr, wg_log_func);
this.wg_log_addr = wg_log_addr; // We cannot use "this" before calling "super"

console.log("WGLogFuzzer in the middle");

// Prepare the second argument to pass to the fuzz function
this.tag = Memory.allocUtf8String("arg2");

// Get the first argument we need to pass from a call to the functino we want to fuzz
var wg_log_global_ptr = null;
console.log(this.wg_log_addr);
Interceptor.attach(this.wg_log_addr, {
onEnter: function(args) {
console.log("Entering in the function to get the first argument");
wg_log_global_ptr = new NativePointer(args[0]);
}
});

while (! wg_log_global_ptr) {
Thread.sleep(1)
}
this.wg_log_global_ptr = wg_log_global_ptr;
console.log("WGLogFuzzer prepare ended")
}


// This function is called by the fuzzer with the first argument being a pointer into memory
// where the payload is stored and the second the length of the input.
fuzz(payload, len) {
// Get a pointer to payload being a valid C string (with a null byte at the end)
var payload_cstring = payload.readCString(len);
this.payload = Memory.allocUtf8String(payload_cstring);

// Debug and fuzz
this.debug_log(this.payload, len);
// Pass the 2 first arguments we know the function needs and finally the payload to fuzz
this.target_function(this.wg_log_global_ptr, this.tag, this.payload);
}
}

const f = new WGLogFuzzer();
rpc.exports.fuzzer = f;
```
{% endcode %}

* **Fuzzer'ı derleyin**:
```bash
# From inside fpicker clone
## Compile from "myfuzzer.js" to "harness.js"
frida-compile examples/wg-log/myfuzzer.js -o harness.js
```
* **`radamsa`** kullanarak **`fpicker`** fuzzer'ını çağırın:

{% code overflow="wrap" %}
```bash
# Indicate fpicker to fuzz a program with the harness.js script and which folders to use
fpicker -v --fuzzer-mode active -e attach -p <Program to fuzz> -D usb -o examples/wg-log/out/ -i examples/wg-log/in/ -f harness.js --standalone-mutator cmd --mutator-command "radamsa"
# You can find code coverage and crashes in examples/wg-log/out/
```
{% endcode %}

{% hint style="danger" %}
Bu durumda her bir payload'dan sonra uygulamayı yeniden başlatmıyor veya durumu geri yüklemediğimizi belirtmek önemlidir. Bu nedenle, Frida bir **çökme** bulursa, o payload'dan sonra gelen **sonraki girişler** uygulamayı çökertecek olabilir (çünkü uygulama kararsız bir durumdadır), hatta **giriş uygulamayı çökertmemesi gerekiyor**.

Ayrıca, Frida iOS'un istisna sinyallerine bağlanacak, bu nedenle **Frida bir çökme bulduğunda**, muhtemelen bir **iOS çökme raporu oluşturulmayacak**.

Bunu önlemek için örneğin, her Frida çökmesinden sonra uygulamayı yeniden başlatabiliriz.
{% endhint %}

### Günlükler ve Çökmeler

macOS günlüklerini kontrol etmek için **macOS konsolunu** veya **`log`** komut satırını kullanabilirsiniz.\
iOS'tan gelen günlükleri kontrol etmek için **`idevicesyslog`** kullanabilirsiniz.\
Bazı günlükler, özel bilgileri ekleyerek **`<private>`** olarak gösterilebilir. Tüm bilgileri göstermek için [https://developer.apple.com/bug-reporting/profiles-and-logs/](https://developer.apple.com/bug-reporting/profiles-and-logs/) adresinden bazı profilleri yüklemeniz gerekmektedir.

Ne yapmanız gerektiğini bilmiyorsanız:
```sh
vim /Library/Preferences/Logging/com.apple.system.logging.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>Enable-Private-Data</key>
<true/>
</dict>
</plist>

killall -9 logd
```
Çökmeleri aşağıdaki yerlerde kontrol edebilirsiniz: 

- **iOS**
- Ayarlar → Gizlilik → Analitik ve İyileştirmeler → Analitik Veriler
- `/private/var/mobile/Library/Logs/CrashReporter/`
- **macOS**:
- `/Library/Logs/DiagnosticReports/`
- `~/Library/Logs/DiagnosticReports`

{% hint style="warning" %}
iOS yalnızca aynı uygulamanın 25 çökmesini saklar, bu yüzden bunu temizlemeniz gerekiyor aksi takdirde iOS çökme oluşturmayı durdurur.
{% endhint %}

## Frida Android Öğreticileri

{% content-ref url="../android-app-pentesting/frida-tutorial/" %}
[frida-tutorial](../android-app-pentesting/frida-tutorial/)
{% endcontent-ref %}

## Referanslar
* [https://www.briskinfosec.com/blogs/blogsdetail/Getting-Started-with-Frida](https://www.briskinfosec.com/blogs/blogsdetail/Getting-Started-with-Frida)

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramanla öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>
