# WWW2Exec - .dtors & .fini\_array

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **ハッキングテクニックを共有するためにPRを送信して** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリに貢献する。

</details>

## .dtors

{% hint style="danger" %}
現在、**.dtors セクションを持つバイナリを見つけるのは非常に珍しいです！**
{% endhint %}

デストラクタは、**プログラムが終了する前に実行される関数**です（`main` 関数が返された後）。\
これらの関数のアドレスは、バイナリの **`.dtors`** セクション内に格納されており、したがって、**`__DTOR_END__`** に **シェルコード** の **アドレス** を **書き込む**ことができれば、それはプログラムが終了する前に **実行** されます。

このセクションのアドレスを取得するには：
```bash
objdump -s -j .dtors /exec
rabin -s /exec | grep “__DTOR”
```
通常、**DTOR** マーカーは値 `ffffffff` と `00000000` の間にあります。したがって、これらの値だけを見ると、**登録された関数がない**ことを意味します。そのため、**`00000000`** を **シェルコードのアドレス** で上書きして、それを実行します。

{% hint style="warning" %}
もちろん、後でそれを呼び出すために、まず **シェルコードを保存する場所を見つける** 必要があります。
{% endhint %}

## **.fini\_array**

基本的に、これはプログラムが終了する前に呼び出される**関数のセット**です。これは、**`.dtors`** のようなものです。これは、**アドレスにジャンプしてシェルコードを呼び出す**ことができる場合や、**脆弱性を2回目に悪用するために再び `main` に戻る**必要がある場合に興味深いです。
```bash
objdump -s -j .fini_array ./greeting

./greeting:     file format elf32-i386

Contents of section .fini_array:
8049934 a0850408

#Put your address in 0x8049934
```
#### 無限ループ

**`.fini_array`** から関数を悪用して無限ループを作成するには、[**ここで行われたことを確認してください**](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)**:** **`.fini_array`** に少なくとも2つのエントリがある場合、次の手順を実行できます:

- 最初の書き込みを使用して、再び **脆弱な任意の書き込み関数** を呼び出します
- 次に、**`__libc_csu_fini`** によって保存されたスタック内の戻りアドレスを計算し、**`__libc_csu_fini`** のアドレスをそこに配置します
- これにより、**`__libc_csu_fini`** が自身を再度呼び出し、**`.fini_array`** 関数が再度実行され、脆弱なWWW関数が2回呼び出されます: 1回は **任意の書き込み** 用、もう1回は再び **`__libc_csu_fini`** のスタック上の戻りアドレスを上書きして自身を再度呼び出すためです。

{% hint style="danger" %}
[**Full RELRO**](../common-binary-protections-and-bypasses/relro.md)**** が適用されている場合、**`.fini_array`** セクションは **読み取り専用** になります。
{% endhint %}
