# WWW2Exec - .dtors рдФрд░ .fini\_array

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## .dtors

{% hint style="danger" %}
рдЖрдЬрдХрд▓ рдХрд┐рд╕реА рднреА рдмрд╛рдЗрдирд░реА рдореЗрдВ .dtors рд╕реЗрдХреНрд╢рди рдХреЗ рд╕рд╛рде рдПрдХ рдмрд╣реБрдд **рдЕрдЬреАрдм рдЪреАрдЬ рд╣реИ!**
{% endhint %}

рдбрд┐рд╕реНрдЯреНрд░рдХреНрдЯрд░реНрд╕ рд╡реЗ рдлрд╝рдВрдХреНрд╢рди рд╣реИрдВ рдЬреЛ **рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ** (рдЬрдм `main` рдлрд╝рдВрдХреНрд╢рди рд╡рд╛рдкрд╕ рд▓реМрдЯрддрд╛ рд╣реИ) **рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд** рд╣реЛрддреЗ рд╣реИрдВред\
рдЗрди рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЗ рдмрд╛рдЗрдирд░реА рдХреЗ **`.dtors`** рд╕реЗрдХреНрд╢рди рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдк **`__DTOR_END__`** рдореЗрдВ рдПрдХ **рд╢реИрд▓рдХреЛрдб** рдХреЗ **рдкрддреЗ** рдХреЛ **рд▓рд┐рдЦрдиреЗ** рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рд╡рд╣ **рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ** **рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред

рдЗрд╕ рд╕реЗрдХреНрд╢рди рдХрд╛ рдкрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```bash
objdump -s -j .dtors /exec
rabin -s /exec | grep тАЬ__DTORтАЭ
```
## **.fini_array**

рдореМрд▓рд┐рдХ рд░реВрдк рд╕реЗ рдпрд╣ рдПрдХ рд╕рдВрд░рдЪрдирд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдлрд╝рдВрдХреНрд╢рди рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рдХрд╛рд░реНрдпрдХреНрд░рдо рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХреЙрд▓ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗ**, рдЬреИрд╕реЗ **`.dtors`**ред рдпрд╣ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреЗ **рд╢реИрд▓рдХреЛрдб рдХреЛ рдПрдХ рдкрддреЗ рдкрд░ рдЬрд╛рдХрд░ рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдпрд╛ рдЙрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ **рджреЛрдмрд╛рд░рд╛ `main` рдкрд░ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ** рддрд╛рдХрд┐ рдЖрдк **рд╕реБрд░рдХреНрд╖рд╛ рджреЛрд╖ рдХрд╛ рджреВрд╕рд░реА рдмрд╛рд░ рд╢рд╛рд░реНрдЯ рдХрд░ рд╕рдХреЗрдВ**ред
```bash
objdump -s -j .fini_array ./greeting

./greeting:     file format elf32-i386

Contents of section .fini_array:
8049934 a0850408

#Put your address in 0x8049934
```
**рдзреНрдпрд╛рди рджреЗрдВ** рдХрд┐ рдЬрдм **`.fini_array`** рд╕реЗ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЕрдЧрд▓реЗ рдлрд╝рдВрдХреНрд╢рди рдкрд░ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдХрдИ рдмрд╛рд░ рдирд╣реАрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧрд╛ (рдЕрдирдВрдд рд▓реВрдк рдХреЛ рд░реЛрдХрдирд╛), рд▓реЗрдХрд┐рди рдпрд╣ рдЖрдкрдХреЛ рдпрд╣рд╛рдБ рдПрдХ **рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди** рдХрд╛ рдХреЗрд╡рд▓ 1 рдмрд╛рд░ рджреЗрдЧрд╛ред

**`.fini_array`** рдореЗрдВ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЛ **рдЙрд▓реНрдЯреЗ** рдХреНрд░рдо рдореЗрдВ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдЖрдЦрд┐рд░реА рд╕реЗ рд▓рд┐рдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред

#### рдЕрдирдВрдд рд▓реВрдк

**рдЕрдирдВрдд рд▓реВрдк** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`.fini_array`** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк [**рдпрд╣рд╛рдБ рдХреНрдпрд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рджреЗрдЦреЗрдВ**](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)**:** рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрдо рд╕реЗ рдХрдо 2 рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпрд╛рдБ **`.fini_array`** рдореЗрдВ рд╣реИрдВ, рддреЛ рдЖрдк:

* рдЕрдкрдиреА рдкрд╣рд▓реА рд▓реЗрдЦрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ **рд╡рд┐рдХрд▓реНрдкреА рд▓реЗрдЦрди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдмреБрд▓рд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдлрд┐рд░ рд╕реЗ
* рдлрд┐рд░, **`__libc_csu_fini`** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣рд┐рдд рд╕реНрдЯреИрдХ рдореЗрдВ рд╡рд╛рдкрд╕реА рдкрддрд╛ рдХрд░реЗрдВ (рдЬреЛ рд╕рднреА `.fini_array` рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ рдмреБрд▓рд╛рдиреЗ рд╡рд╛рд▓рд╛ рдлрд╝рдВрдХреНрд╢рди рд╣реИ) рдФрд░ рд╡рд╣рд╛рдБ **`__libc_csu_fini`** рдХрд╛ рдкрддрд╛ рдбрд╛рд▓реЗрдВ
* рдпрд╣ **`__libc_csu_fini`** рдХреЛ рдлрд┐рд░ рд╕реЗ рдмреБрд▓рд╛рдПрдЧрд╛ рдФрд░ **`.fini_array`** рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ рдлрд┐рд░ рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ рдЬреЛ рд╡рд┐рдХрд▓реНрдкреА WWW рдлрд╝рдВрдХреНрд╢рди рдХреЛ 2 рдмрд╛рд░ рдмреБрд▓рд╛рдПрдЧрд╛: рдПрдХ рдмрд╛рд░ рдХреЗ рд▓рд┐рдП **рд╡рд┐рдХрд▓реНрдкреА рд▓реЗрдЦрди** рдФрд░ рдПрдХ рдФрд░ рдмрд╛рд░ **`__libc_csu_fini`** рдХреЗ рд╡рд╛рдкрд╕реА рдкрддреЗ рдХреЛ рдлрд┐рд░ рд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдЯреИрдХ рдкрд░ рдЕрдкрдиреЗ рдЖрдк рдХреЛ рдмреБрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдПред

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ [**рдкреВрд░реНрдг RELRO**](../common-binary-protections-and-bypasses/relro.md)** рдХреЗ рд╕рд╛рде, рдЦрдВрдб **`.fini_array`** рдХреЛ **рдХреЗрд╡рд▓ рдкрдврд╝рдиреЗ рдпреЛрдЧреНрдп** рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
{% endhint %}

## link\_map

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure) рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдХрд╛рд░реНрдпрдХреНрд░рдо `return` рдпрд╛ `exit()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ `__run_exit_handlers()` рдХреЛ рдЪрд▓рд╛рдПрдЧрд╛ рдЬреЛ рдкрдВрдЬреАрдХреГрдд рдирд╛рд╢рдХреЛрдВ рдХреЛ рдмреБрд▓рд╛рдПрдЧрд╛ред

{% hint style="danger" %}
рдпрджрд┐ рдХрд╛рд░реНрдпрдХреНрд░рдо **`_exit()`** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`exit` рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓** рдХреЛ рдмреБрд▓рд╛рдПрдЧрд╛ рдФрд░ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВрдбрд▓рд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдирд╣реАрдВ рд╣реЛрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП, `__run_exit_handlers()` рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдЙрд╕ рдкрд░ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

рдорд╣рддреНрд╡рдкреВрд░реНрдг рдХреЛрдб рд╣реИ ([рд╕реНрд░реЛрдд](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ `map -> l_addr + fini_array -> d_un.d_ptr` рдХрд╛ рдЙрдкрдпреЛрдЧ **рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдПрд░реЗ** рдХреА **рд╕реНрдерд┐рддрд┐ рдХреА рдЧрдгрдирд╛** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдХреБрдЫ **рд╡рд┐рдХрд▓реНрдк** рд╣реИрдВ:

* `map->l_addr` рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдпрд╣ рдПрдХ **рдирдХрд▓реА `fini_array`** рдХреА рдУрд░ рдкрд╣реБрдВрдЪреЗ рдЬрд┐рд╕рдореЗрдВ рдЕрдирд┐рдпрдВрддреНрд░рд┐рдд рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рдирд┐рд░реНрджреЗрд╢ рд╣реЛрдВред
* `l_info[DT_FINI_ARRAY]` рдФрд░ `l_info[DT_FINI_ARRAYSZ]` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ (рдЬреЛ рд╕реНрдореГрддрд┐ рдореЗрдВ рдЕрдзрд┐рдХрд╛рдВрд╢рдд: рд╕рдВрдпреБрдХреНрдд рд╣реИрдВ), рддрд╛рдХрд┐ рд╡реЗ рдлрд┐рд░ рд╕реЗ рдПрдХ рдЬрд╛рд▓реА `Elf64_Dyn` рд╕рдВрд░рдЪрдирд╛ рдХреА рдУрд░ рдкрд╣реБрдВрдЪреЗрдВ рдЬреЛ рдлрд┐рд░ рд╕реЗ **`array` рдХреЛ рдПрдХ рд╕реНрдореГрддрд┐ рдХреНрд╖реЗрддреНрд░** рдХреА рдУрд░ рджрд┐рдЦрд╛рдП рдЬрд┐рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред
* [**рдЗрд╕ рд▓реЗрдЦ**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) рдореЗрдВ `l_info[DT_FINI_ARRAY]` рдХреЛ `.bss` рдореЗрдВ рдПрдХ рдирдХрд▓реА `fini_array` рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдореЗрдореЛрд░реА рдХреЗ рдкрддреЗ рдХреЗ рд╕рд╛рде рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдирдХрд▓реА рдПрд░реЗ рдкрд╣рд▓реЗ рдПрдХ [**рд╡рди рдЧреИрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) рдХрд╛ рдкрддрд╛ рдмрддрд╛рддрд╛ рд╣реИ рдЬреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдлрд┐рд░ рдЗрд╕ **рдирдХрд▓реА рдПрд░реЗ** рдХреЗ рдкрддреЗ рдФрд░ `map->l_addr` рдХреЗ рдорд╛рди рдХреЗ рдмреАрдЪ **рдЕрдВрддрд░** рд╣реИ рддрд╛рдХрд┐ `*array` рдирдХрд▓реА рдПрд░реЗ рдХреА рдУрд░ рдкрд╣реБрдВрдЪреЗред
* рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдореБрдЦреНрдп рдкреЛрд╕реНрдЯ рдФрд░ [**рдЗрд╕ рд▓реЗрдЦ**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet) рдХреЗ рдЕрдиреБрд╕рд╛рд░ ld.so рд╕реНрдЯреИрдХ рдкрд░ рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдЫреЛрдбрд╝рддрд╛ рд╣реИ рдЬреЛ ld.so рдореЗрдВ рдмрд╛рдЗрдирд░реА `link_map` рдХреА рдУрд░ рдкрд╣реБрдВрдЪрддрд╛ рд╣реИред рдПрдХ рдЕрдирд┐рдпрдВрддреНрд░рд┐рдд рд▓реЗрдЦрди рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдЗрд╕реЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирдХрд▓реА `fini_array` рдХреА рдУрд░ рдкрд╣реБрдВрдЪрд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬрд┐рд╕рдореЗрдВ [**рд╡рди рдЧреИрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) рдХреЗ рд▓рд┐рдП рдПрдХ рдкрддрд╛ рд╣реЛред

рдкрд┐рдЫрд▓реЗ рдХреЛрдб рдХреЗ рдЕрдиреБрд╕рд░рди рдЖрдкрдХреЛ рдПрдХ рдФрд░ рджрд┐рд▓рдЪрд╕реНрдк рдЦрдВрдб рдорд┐рд▓реЗрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рдХреЛрдб рд╣реИ:
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ `map->l_info[DT_FINI]` рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдЬреЛ рдПрдХ рдЬрд╛рд▓реА `ElfW(Dyn)` рд╕рдВрд░рдЪрдирд╛ рдХреЛ рджрд┐рдЦрд╛ рд░рд╣рд╛ рд╣реИред [**рдпрд╣рд╛рдБ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure).

## **`__run_exit_handlers`** рдореЗрдВ TLS-рд╕реНрдЯреЛрд░реЗрдЬ dtor\_list рдУрд╡рд░рд░рд╛рдЗрдЯ

рдЬреИрд╕рд╛ [**рдпрд╣рд╛рдБ рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite), рдЕрдЧрд░ рдХреЛрдИ рдкреНрд░реЛрдЧреНрд░рд╛рдо `return` рдпрд╛ `exit()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрдВрдж рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`__run_exit_handlers()`** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ рдЬреЛ рдХрд┐рд╕реА рднреА рдирд╖реНрдЯрдХрд░реНрддрд╛ рдХрд╛рд░реНрдп рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ рдЬреЛ рдкрдВрдЬреАрдХреГрдд рд╣реИред

рдХреЛрдб `_run_exit_handlers()` рд╕реЗ:
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
рдХреЛрдб рд╕реЗ **`__call_tls_dtors()`**:
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
рд╣рд░ рдкрдВрдЬреАрдХреГрдд рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП **`tls_dtor_list`** рдореЗрдВ, рдпрд╣ **`cur->func`** рд╕реЗ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдбреАрдореИрдВрдЧрд▓ рдХрд░реЗрдЧрд╛ рдФрд░ рдЗрд╕реЗ **`cur->obj`** рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред

рдЗрд╕ [**GEF рдХреЗ fork**](https://github.com/bata24/gef) рд╕реЗ **`tls`** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **`dtor_list`** рдмрд╣реБрдд **рдХреНрд▓реЛрдЬ** рд╣реИ **stack canary** рдФрд░ **PTR\_MANGLE cookie** рдХреЗ рдкрд╛рд╕ред рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рдкрд░ рдУрд╡рд░рдлрд╝реНрд▓реЛ рд╣реЛрдиреЗ рдкрд░ **cookie** рдФрд░ **stack canary** рдХреЛ **рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред\
PTR\_MANGLE рдХреБрдХреА рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рд╕реЗ, **`PTR_DEMANLE` рдлрд╝рдВрдХреНрд╢рди** рдХреЛ **рдмрд╛рдИрдкрд╛рд╕** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ 0x00 рдкрд░ рд╕реЗрдЯ рдХрд░рдиреЗ рд╕реЗ рдпрд╣ рдЕрд░реНрде рд╣реЛрдЧрд╛ рдХрд┐ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ **`xor`** рдХреЗрд╡рд▓ рдкрддрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдлрд┐рд░, **`dtor_list`** рдкрд░ рд▓рд┐рдЦрдиреЗ рд╕реЗ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдлрд╝рдВрдХреНрд╢рди **рдкрддрд╛** рдФрд░ рдЗрд╕рдХреЗ **рд╡рд┐рд╡рд╛рдж** рдХреЗ рд╕рд╛рде рдХрдИ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ **рдЪреЗрди** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЕрдВрдд рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкреЙрдЗрдВрдЯрд░ рдХреЗрд╡рд▓ рдХреБрдХреА рдХреЗ рд╕рд╛рде **xored** рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рд╣реИ рдмрд▓реНрдХрд┐ 17 рдмрд┐рдЯ рдШреБрдорд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
So you need to take this into account before adding a new address.

Find an example in the [**original post**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite).

## рдЕрдиреНрдп рдореИрдВрдЧрд▓реНрдб рдкреЙрдЗрдВрдЯрд░ **`__run_exit_handlers`** рдореЗрдВ

рдпрд╣ рддрдХрдиреАрдХ [**рдпрд╣рд╛рдБ рд╕рдордЭрд╛рдИ рдЧрдИ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite) рдФрд░ рдлрд┐рд░ рд╕реЗ рдХрд╛рд░реНрдпрдХреНрд░рдо **`return` рдпрд╛ `exit()` рдХреЛ рдмреБрд▓рд╛рдХрд░ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реИ** рддрд╛рдХрд┐ **`__run_exit_handlers()`** рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПред

рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдФрд░ рдЕрдзрд┐рдХ рдХреЛрдб рджреЗрдЦрддреЗ рд╣реИрдВ:
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
рдЪрд░ `f` **`initial`** рд╕рдВрд░рдЪрдирд╛ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдФрд░ `f->flavor` рдХреЗ рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╡рд┐рднрд┐рдиреНрди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ рдПрдХ рд╡рд┐рднрд┐рдиреНрди рд╕реНрдерд╛рди рдкрд░ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдпрд╣ рд╣рдореЗрд╢рд╛ **demangled** рд╣реЛрдЧрд╛ред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рд╡рд┐рдХрд▓реНрдк **`ef_on`** рдФрд░ **`ef_cxa`** рдореЗрдВ рдПрдХ **рдЖрд░реНрдЧреНрдпреВрдореЗрдВрдЯ** рдХреЛ рднреА рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдбреАрдмрдЧрд┐рдВрдЧ рд╕рддреНрд░ рдореЗрдВ **GEF** рдЪрд▓рд╛рддреЗ рд╕рдордп **`gef> p initial`** рдХреЗ рд╕рд╛рде **`initial` рд╕рдВрд░рдЪрдирд╛** рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

рдЗрд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдпрд╛ рддреЛ **`PTR_MANGLE` рдХреБрдХреА рдХреЛ рд▓реАрдХ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдпрд╛ рдорд┐рдЯрд╛рдирд╛ рд╣реЛрдЧрд╛** рдФрд░ рдлрд┐рд░ `system('/bin/sh')` рдХреЗ рд╕рд╛рде `cxa` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред\
рдЖрдк рдЗрд╕рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг [**рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореВрд▓ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure) рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
