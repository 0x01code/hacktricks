# WWW2Exec - atexit(), TLS Storage рдФрд░ рдЕрдиреНрдп рдореИрдВрдЧрд▓реНрдб рдкреЙрдЗрдВрдЯрд░реНрд╕

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдкрд░ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## **\_\_atexit рд╕рдВрд░рдЪрдирд╛рдПрдБ**

{% hint style="danger" %}
рдЖрдЬрдХрд▓ рдЗрд╕реЗ **рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд░рдирд╛ рдмрд╣реБрдд рдЕрдЬреАрдм рд╣реИ!**
{% endhint %}

**`atexit()`** рдПрдХ рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдЕрдиреНрдп рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред** рдпреЗ **рдлрд╝рдВрдХреНрд╢рди** рдПрдХ **`exit()`** рдпрд╛ **рдореБрдЦреНрдп** рдХреЗ **рд░рд┐рдЯрд░реНрди** рдХреЛ **рдПрдХреНрд╕реАрдХреНрдпреВрдЯ** рдХрд░рдиреЗ рдкрд░ **рдПрдХреНрд╕реАрдХреНрдпреВрдЯ** рд╣реЛрдВрдЧреЗред\
рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рднреА рдЗрди **рдлрд╝рдВрдХреНрд╢рдиреЛрдВ** рдХреЗ **рдкрддреЗ** рдХреЛ рдПрдХ рд╢реИрд▓рдХреЛрдб рдкрд░ рдкреЙрдЗрдВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдХрд╛ **рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд** рдХрд░реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдпрд╣ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИред\
рд╡рд░реНрддрдорд╛рди рдореЗрдВ **рдПрдХреНрд╕реАрдХреНрдпреВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЗ** рдХрдИ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рдкреАрдЫреЗ **рдЫрд┐рдкреЗ рд╣реБрдП рд╣реИрдВ** рдФрд░ рдЕрдВрдд рдореЗрдВ рдЬрд┐рди рдкрддреЛрдВ рдкрд░ рдпрд╣ рдкреЙрдЗрдВрдЯ рдХрд░рддрд╛ рд╣реИ, рд╡реЗ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЛрдВ рдирд╣реАрдВ рд╣реИрдВ, рдмрд▓реНрдХрд┐ **XOR** рдФрд░ **рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб** рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдпрд╣ рд╣рдорд▓рд╛ рд╡реЗрдХреНрдЯрд░ **рдХрдо рдЙрдкрдпреЛрдЧреА рд╣реИ рдХрдо рд╕реЗ рдХрдо x86** рдФрд░ **x64\_86** рдкрд░ред\
**рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдлрд╝рдВрдХреНрд╢рди** рд╣реИ **`PTR_MANGLE`**ред **рдЕрдиреНрдп рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░** рдЬреИрд╕реЗ m68k, mips32, mips64, aarch64, arm, hppa... **рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЛ рд▓рд╛рдЧреВ рдирд╣реАрдВ рдХрд░рддреЗ** рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рдЙрд╕реА рдХреЛ рд╡рд╛рдкрд╕ рд▓реМрдЯрд╛рддрд╛ рд╣реИ** рдЬреИрд╕рд╛ рдХрд┐ рдЗрд╕реЗ рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ред рдЗрд╕рд▓рд┐рдП рдЗрди рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░реНрд╕ рдкрд░ рдЗрд╕ рд╡реЗрдХреНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рд╣рдорд▓рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЖрдк рдЗрд╕рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд╡рд┐рд╕реНрддреГрдд рд╡рд┐рд╡рд░рдг рдХреЛ [https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## link\_map

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure) рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдХрд╛рд░реНрдпрдХреНрд░рдо `return` рдпрд╛ `exit()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ `__run_exit_handlers()` рдХреЛ рдЪрд▓рд╛рдПрдЧрд╛ рдЬреЛ рдкрдВрдЬреАрдХреГрдд рдирд╛рд╢рдХреЛрдВ рдХреЛ рдмреБрд▓рд╛рдПрдЧрд╛ред

{% hint style="danger" %}
рдпрджрд┐ рдХрд╛рд░реНрдпрдХреНрд░рдо **`_exit()`** рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`exit` рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓** рдХреЛ рдмреБрд▓рд╛рдПрдЧрд╛ рдФрд░ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВрдбрд▓рд░ рдирд╣реАрдВ рдЪрд▓рд╛рдПрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП, `__run_exit_handlers()` рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдЗрд╕ рдкрд░ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

рдорд╣рддреНрд╡рдкреВрд░реНрдг рдХреЛрдб рд╣реИ ([рд╕реНрд░реЛрдд](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ `map -> l_addr + fini_array -> d_un.d_ptr` рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЧрдгрдирд╛ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ **рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдПрд░реЗ** рдХреА рд╕реНрдерд┐рддрд┐ред

рдХреБрдЫ **рд╡рд┐рдХрд▓реНрдк** рд╣реИрдВ:

* `map->l_addr` рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдпрд╣ рдПрдХ **рдирдХрд▓реА `fini_array`** рдХреА рдУрд░ рдкрд╣реБрдВрдЪреЗ рдЬрд┐рд╕рдореЗрдВ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП
* `l_info[DT_FINI_ARRAY]` рдФрд░ `l_info[DT_FINI_ARRAYSZ]` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ (рдЬреЛ рд╕реНрдореГрддрд┐ рдореЗрдВ рдЕрдзрд┐рдХрд╛рдВрд╢рдд: рдПрдХ рд╕рд╛рде рд╣реЛрддреЗ рд╣реИрдВ), рддрд╛рдХрд┐ рд╡реЗ рдлрд┐рд░ рд╕реЗ рдПрдХ рдЬрд╛рд▓реА `Elf64_Dyn` рд╕рдВрд░рдЪрдирд╛ рдХреА рдУрд░ рдкрд╣реБрдВрдЪреЗрдВ рдЬреЛ рдлрд┐рд░ рд╕реЗ **`array` рдХреЛ рдПрдХ рд╕реНрдореГрддрд┐ рдХреНрд╖реЗрддреНрд░** рдХреА рдУрд░ рджрд┐рдЦрд╛рдП рдЬрд┐рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред
* [**рдпрд╣ рд▓реЗрдЦ**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) `l_info[DT_FINI_ARRAY]` рдХреЛ `.bss` рдореЗрдВ рдПрдХ рдирдХрд▓реА `fini_array` рд╡рд╛рд▓реА рдирд┐рдпрдВрддреНрд░рд┐рдд рд╕реНрдореГрддрд┐ рдХрд╛ рдкрддрд╛ рджреЗрдиреЗ рд╡рд╛рд▓реЗ рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЗ рд╕рд╛рде рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдирдХрд▓реА рдЕрд░реНрд░рд╛рдп рдореЗрдВ **рдкрд╣рд▓реЗ рдПрдХ** [**рд╡рди рдЧреИрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) **рдкрддрд╛** рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдлрд┐рд░ **рдЗрд╕ рдирдХрд▓реА рдЕрд░реНрд░рд╛рдп** рдФрд░ **`map->l_addr`** рдХреЗ рдорд╛рди рдХреЗ рдмреАрдЪ рдХрд╛ **рдЕрдВрддрд░** рдЬреЛ `*array` рдХреЛ рдирдХрд▓реА рдЕрд░реНрд░рд╛рдп рдХреА рдУрд░ рдкрд╣реБрдВрдЪрд╛рдПрдЧрд╛ред
* рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдореБрдЦреНрдп рдкреЛрд╕реНрдЯ рдФрд░ [**рдпрд╣ рд▓реЗрдЦ**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet) рдХреЗ рдЕрдиреБрд╕рд╛рд░ ld.so рдПрд▓рдбреА.рдПрд╕.рдУ. рдореЗрдВ рдмрд╛рдЗрдирд░реА `link_map` рдкрд░ рдкреЙрдЗрдВрдЯрд░ рдЫреЛрдбрд╝рддрд╛ рд╣реИред рдПрдХ рдЕрд░реНрдмрд┐рдЯреНрд░реЗрд░реА рд░рд╛рдЗрдЯ рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдЗрд╕реЗ рдПрдХ рдирдХрд▓реА `fini_array` рдХреА рдУрд░ рдкрд╣реБрдВрдЪрд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдПрдХ [**рд╡рди рдЧреИрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) рдХреЗ рдкрддреЗ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИред
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ `map->l_info[DT_FINI]` рдХреЗ рдорд╛рди рдХреЛ рдЕрдзрд┐рдХреГрдд `ElfW(Dyn)` рд╕рдВрд░рдЪрдирд╛ рдХреА рдУрд░ рджрд┐рдЦрд╛рдирд╛ рдЕрд╡рд╢реНрдп рд╣реЛ рд╕рдХрддрд╛ рд╣реИред [**рдпрд╣рд╛рдБ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкрд╛рдПрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure)ред

## TLS-Storage dtor\_list overwrite in **`__run_exit_handlers`**

рдЬреИрд╕рд╛ [**рдпрд╣рд╛рдБ рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite), рдЕрдЧрд░ рдХреЛрдИ рдкреНрд░реЛрдЧреНрд░рд╛рдо `return` рдпрд╛ `exit()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрдВрдж рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`__run_exit_handlers()`** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ рдЬреЛ рдХрд┐рд╕реА рднреА рдирд╖реНрдЯрдХрд░реНрддрд╛ рд╕рдорд╛рд░рдХ рдХрд╛рд░реНрдп рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред

рдХреЛрдб `_run_exit_handlers()` рд╕реЗ:
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
рдХреЛрдб рд╕реЗ **`__call_tls_dtors()`**:
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
рд╣рд░ **`tls_dtor_list`** рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП, рдпрд╣ **`cur->obj`** рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред

рдЗрд╕ [**GEF рдХреЗ fork**](https://github.com/bata24/gef) рд╕реЗ **`tls`** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдпрд╣ рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **`dtor_list`** рдмрд╣реБрдд **рдХрд░реАрдм** рд╣реИ **stack canary** рдФрд░ **PTR\_MANGLE cookie** рдХреЗред рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рдкрд░ рдУрд╡рд░рдлрд╝реНрд▓реЛ рд╣реЛрдиреЗ рдкрд░ **cookie** рдФрд░ **stack canary** рдХреЛ **рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред\
PTR\_MANGLE рдХреБрдХреА рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рд╕реЗ, рдЗрд╕реЗ 0x00 рдкрд░ рд╕реЗрдЯ рдХрд░рдХреЗ **`PTR_DEMANLE` рдлрд╝рдВрдХреНрд╢рди** рдХреЛ **рдмрд╛рдИрдкрд╛рд╕** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрд┐ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ **`xor`** рдХреЗрд╡рд▓ рдкрддрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛред рдлрд┐рд░, **`dtor_list`** рдкрд░ рд▓рд┐рдЦрдХрд░ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдлрд╝рдВрдХреНрд╢рди **рдкрддрд╛** рдФрд░ рдЗрд╕рдХрд╛ **рд╡рд┐рд╡рд╛рдж** рдХрд░реЗрдВред

рдЕрдВрдд рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкреЙрдЗрдВрдЯрд░ рдХреЗрд╡рд▓ рдХреБрдХреА рдХреЗ рд╕рд╛рде xored рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рд╣реИ рдмрд▓реНрдХрд┐ 17 рдмрд┐рдЯ рдШреБрдорд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
So you need to take this into account before adding a new address.

Find an example in the [**original post**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite).

## **`__run_exit_handlers`** рдореЗрдВ рдЕрдиреНрдп рдореИрдВрдЧрд▓реНрдб рдкреЙрдЗрдВрдЯрд░

рдпрд╣ рддрдХрдиреАрдХ [**рдпрд╣рд╛рдБ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреА рдЧрдИ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite) рдФрд░ рдлрд┐рд░ рд╕реЗ рдХрд╛рд░реНрдпрдХреНрд░рдо **`return` рдпрд╛ `exit()` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ** рдкрд░ рдирд┐рд░реНрднрд░ рд╣реИ рддрд╛рдХрд┐ **`__run_exit_handlers()`** рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПред

рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдФрд░ рднреА рдЕрдзрд┐рдХ рдХреЛрдб рдЬрд╛рдВрдЪрддреЗ рд╣реИрдВ:
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
рдЪрд░ `f` **`initial`** рд╕рдВрд░рдЪрдирд╛ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдФрд░ `f->flavor` рдХреЗ рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╡рд┐рднрд┐рдиреНрди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ рдПрдХ рд╡рд┐рднрд┐рдиреНрди рд╕реНрдерд╛рди рдкрд░ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдпрд╣ рд╣рдореЗрд╢рд╛ **demangled** рд╣реЛрдЧрд╛ред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рд╡рд┐рдХрд▓реНрдк **`ef_on`** рдФрд░ **`ef_cxa`** рдореЗрдВ рдПрдХ **рдЖрд░реНрдЧреНрдпреВрдореЗрдВрдЯ** рдХреЛ рднреА рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдбреАрдмрдЧрд┐рдВрдЧ рд╕рддреНрд░ рдореЗрдВ **GEF** рдЪрд▓рд╛рддреЗ рд╕рдордп **`gef> p initial`** рдХреЗ рд╕рд╛рде **`initial` рд╕рдВрд░рдЪрдирд╛** рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

рдЗрд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдпрд╛ рддреЛ **`PTR_MANGLE` рдХреБрдХреА рд▓реАрдХ рдпрд╛ рдорд┐рдЯрд╛рдирд╛** рд╣реЛрдЧрд╛ рдФрд░ рдлрд┐рд░ `initial` рдореЗрдВ `cxa` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ `system('/bin/sh')` рд╕реЗ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред\
рдЖрдк рдЗрд╕рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг [**рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореВрд▓ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure) рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
