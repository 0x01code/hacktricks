# ヒープ関数のセキュリティチェック

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使って、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**@hacktricks\_live**をフォローする
- **HackTricks**および**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

## unlink

この関数は、ダブルリンクリストからチャンクを削除します。一般的なチェックにより、チャンクをアンリンクする際にリンクリスト構造が一貫していることが確認されます。

- **整合性チェック**：
  - `P->fd->bk == P` および `P->bk->fd == P` をチェックします。
- エラーメッセージ：`corrupted double-linked list`

## \_int\_malloc

この関数はヒープからメモリを割り当てる責任があります。ここでのチェックにより、割り当て中にメモリが破損しないようにします。

- **Fastbinサイズチェック**：
  - ファストビンからチャンクを削除する際、チャンクのサイズがファストビンの範囲内にあることを確認します。
- エラーメッセージ：`malloc(): memory corruption (fast)`
- **Smallbin整合性チェック**：
  - スモールビンからチャンクを削除する際、ダブルリンクリスト内の前後のリンクが一貫していることを確認します。
- エラーメッセージ：`malloc(): smallbin double linked list corrupted`
- **Unsorted Binメモリ範囲チェック**：
  - アンソートビン内のチャンクのサイズが最小値と最大値の範囲内にあることを確認します。
- エラーメッセージ：`malloc(): memory corruption`
- **Unsorted Bin整合性チェック（第1シナリオ）**：
  - アンソートビンに残りのチャンクを挿入する際、`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)` をチェックします。
- エラーメッセージ：`malloc(): corrupted unsorted chunks`
- **Unsorted Bin整合性チェック（第2シナリオ）**：
  - 前のチェックと同様ですが、ファストまたはスモールチャンクを分割して挿入した場合にトリガーされます。
- エラーメッセージ：`malloc(): corrupted unsorted chunks 2`

## \_int\_free

この関数は以前に割り当てられたメモリを解放します。ここでのチェックは、適切なメモリ解放を確認し、メモリの破損を防ぎます。

- **ポインタ境界チェック**：
  - 解放されるポインタがメモリを周回していないことを確認します。
- エラーメッセージ：`free(): invalid pointer`
- **サイズチェック**：
  - 解放されるチャンクのサイズが少なくとも`MINSIZE`または`MALLOC_ALIGNMENT`の倍数であることを確認します。
- エラーメッセージ：`free(): invalid size`
- **Fastbinサイズチェック**：
  - ファストビンのチャンクの場合、次のチャンクのサイズが最小値と最大値の範囲内にあることを確認します。
- エラーメッセージ：`free(): invalid next size (fast)`
- **Fastbinダブルフリーチェック**：
  - ファストビンにチャンクを挿入する際、ヘッドのチャンクが挿入されるチャンクと同じでないことを確認します。
- エラーメッセージ：`double free or corruption (fasttop)`
- **Fastbin整合性チェック**：
  - ファストビンに挿入する際、ヘッドチャンクと挿入されるチャンクのサイズが同じであることを確認します。
- エラーメッセージ：`invalid fastbin entry (free)`
- **Top Chunk整合性チェック**：
  - ファストビンのチャンク以外の場合、チャンクがトップチャンクと同じでないことを確認します。
- エラーメッセージ：`double free or corruption (top)`
- **メモリ境界チェック**：
  - メモリの次のチャンクがアリーナの境界内にあることを確認します。
- エラーメッセージ：`double free or corruption (out)`
- **Prev\_inuseビットチェック**：
  - 次のチャンクの前の使用ビットがマークされていることを確認します。
- エラーメッセージ：`double free or corruption (!prev)`
- **通常のサイズチェック**：
  - 次のチャンクのサイズが有効な範囲内にあることを確認します。
- エラーメッセージ：`free(): invalid next size (normal)`
- **Unsorted Bin整合性チェック**：
  - アンソートビンに連結されたチャンクを挿入する際、`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)` をチェックします。
- エラーメッセージ：`free(): corrupted unsorted chunks`

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使って、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**@hacktricks\_live**をフォローする
- **HackTricks**および**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>
