# 힙 오버플로우

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로부터 영웅까지 AWS 해킹 배우기**!</summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나 HackTricks를 PDF로 다운로드**하고 싶다면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구입하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f)에 가입하거나 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나** 트위터에서 **@hacktricks\_live**를 팔로우하세요 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.
* **해킹 트릭을 공유하려면 PR을 제출하여** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 제출하세요.

</details>

## 기본 정보

힙 오버플로우는 [**스택 오버플로우**](../stack-overflow/)와 비슷하지만 힙에서 발생합니다. 기본적으로 힙에 데이터를 저장할 공간이 예약되었고 **저장된 데이터가 예약된 공간보다 큰 경우**를 의미합니다.

스택 오버플로우에서는 몇 가지 레지스터(명령 포인터 또는 스택 프레임과 같은)가 스택에서 복원될 것이며 이를 악용할 수 있다는 것을 알 수 있습니다. 힙 오버플로우의 경우, **기본적으로 힙 청크에 민감한 정보가 저장되어 있지 않습니다**. 그러나 민감한 정보나 포인터가 될 수 있으므로 이 취약점의 **중요성은 무엇이 덮어씌워질 수 있는지** 및 공격자가 이를 어떻게 악용할 수 있는지에 따라 달라집니다.

{% hint style="success" %}
오버플로우 오프셋을 찾기 위해 [**스택 오버플로우**](../stack-overflow/#finding-stack-overflows-offsets)에서와 같은 패턴을 사용할 수 있습니다.
{% endhint %}

### 스택 오버플로우 vs 힙 오버플로우

스택 오버플로우에서 취약점이 트리거될 때 스택에 존재할 데이터 및 배열은 상당히 신뢰할 수 있습니다. 이는 스택이 선형이며 충돌 메모리에서 항상 증가하며 **프로그램 실행 중 스택 메모리의 특정 위치에는 일반적으로 유사한 종류의 데이터**가 저장되며 각 함수에서 사용되는 스택 부분 끝에 일부 포인터가 있는 특정 구조를 가지고 있기 때문입니다.

그러나 힙 오버플로우의 경우, 사용된 메모리가 선형이 아니라 **일반적으로 메모리의 분리된 위치에 할당된 청크**들이 있기 때문에(서로 옆에 위치하지 않음) **크기에 따라 할당을 분리하는 바이너리 및 존**으로 인해 이전에 해제된 메모리가 새로운 청크를 할당하기 전에 사용됩니다. **어떤 객체가 오버플로우될 객체와 충돌할 것인지 알아내는 것이 복잡**합니다. 따라서 힙 오버플로우가 발견되면 원하는 객체가 오버플로우될 수 있도록 메모리에서 다음에 위치하도록 하는 **신뢰할 수 있는 방법을 찾아야** 합니다.

이를 위해 사용되는 기술 중 하나는 **Heap Grooming**입니다. 이 기술은 예를 들어 [**이 게시물**](https://azeria-labs.com/grooming-the-ios-kernel-heap/)에서 사용됩니다. 이 게시물에서는 iOS 커널에서 메모리 청크를 저장할 메모리가 부족해지면 커널 페이지로 확장되고, 이 페이지는 예상 크기의 청크로 분할되어 사용됩니다(9.2 버전 이전까지는 이러한 청크가 이러한 공격의 어려움을 위해 무작위로 사용됩니다).

따라서 힙 오버플로우가 발생하는 이전 게시물에서, 오버플로우된 객체가 희생자 순서와 충돌하도록 강제하기 위해 여러 **`kallocs`가 여러 스레드에 의해 강제로 실행**되어 모든 빈 청크가 채워지고 새 페이지가 생성되도록 시도합니다.

특정 크기의 객체로 이 채움을 강제하기 위해 **iOS mach port와 관련된 out-of-line 할당**이 이상적인 후보입니다. 메시지 크기를 조작함으로써 `kalloc` 할당의 크기를 정확히 지정할 수 있으며 해당 mach port가 파괴되면 해당 할당이 즉시 `kfree`로 반환됩니다.

그런 다음 이러한 플레이스홀더 중 일부를 **해제**할 수 있습니다. **`kalloc.4096` 자유 목록은 후입선출 순서로 요소를 해제**하므로 일부 플레이스홀더가 해제되고 악용이 시도되는 동안 여러 희생자 객체를 할당하려고 할 때 오버플로우될 객체가 희생자 객체 뒤에 따를 가능성이 높습니다.

## ARM64 예제

[https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) 페이지에서 명령어가 오버플로우된 청크에서 실행될 예제 힙 오버플로우를 찾을 수 있습니다. 따라서 쉬운 악용을 통해 실행되는 명령을 덮어쓰기하여 실행 명령을 수정할 수 있습니다.
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
<details>

<summary><strong>제로부터 영웅이 될 때까지 AWS 해킹 배우기</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나 HackTricks를 PDF로 다운로드하고 싶다면** [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 굿즈**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f)에 가입하거나 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **해킹 트릭을 공유하려면 PR을** [**HackTricks**](https://github.com/carlospolop/hacktricks) **및** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **깃허브 저장소에 제출하세요.**

</details>
