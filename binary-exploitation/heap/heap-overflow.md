# ヒープオーバーフロー

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を使って、ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする**
* **ハッキングテクニックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する

</details>

## 基本情報

ヒープオーバーフローは、ヒープ内での[**スタックオーバーフロー**](../stack-overflow/)のようなものです。基本的には、ヒープにデータを格納するためのスペースが予約されており、**格納されたデータが予約されたスペースよりも大きかった**ことを意味します。

スタックオーバーフローでは、スタックから命令ポインタやスタックフレームなどのレジスタがスタックから復元されることがわかっており、これを悪用する可能性があります。ヒープオーバーフローの場合、ヒープチャンクには**デフォルトで機密情報は格納されていない**ことがわかります。ただし、機密情報やポインタが含まれる可能性があるため、この脆弱性の**重大性は、どのデータが上書きされるか**と攻撃者がこれをどのように悪用できるかに依存します。

{% hint style="success" %}
オーバーフローオフセットを見つけるためには、[**スタックオーバーフロー**](../stack-overflow/#finding-stack-overflows-offsets)と同じパターンを使用できます。
{% endhint %}

### スタックオーバーフロー vs ヒープオーバーフロー

スタックオーバーフローでは、脆弱性がトリガーされる時点でスタックに存在するデータや配置がかなり信頼できます。これは、スタックがリニアであり、常に増加しているため、**プログラムの実行中にスタックメモリの特定の場所には通常同様のデータが格納されており**、各関数が使用するスタック部分の末尾にいくつかのポインタがある特定の構造を持っているためです。

しかし、ヒープオーバーフローの場合、使用されるメモリはリニアではなく、**通常はメモリの別々の位置に割り当てられたチャンク**（隣接していない）にあります。これは、**サイズによって割り当てられたビンやゾーン**によって割り当てられたメモリが分離され、**新しいチャンクを割り当てる前に以前に解放されたメモリが使用される**ためです。ヒープオーバーフローに対して脆弱性が見つかった場合、**望ましいオブジェクトをメモリ内で次に配置する信頼性の高い方法を見つける必要があります**。

そのために使用されるテクニックの1つが**Heap Grooming**です。これは、たとえば[**この投稿**](https://azeria-labs.com/grooming-the-ios-kernel-heap/)で使用されています。この投稿では、iOSカーネルでメモリを格納するためのゾーンがメモリ不足になると、カーネルページが拡張され、このページが期待されるサイズのチャンクに分割され、これらのチャンクが順番に使用されます（iOSバージョン9.2まで、その後、これらのチャンクは攻撃の複雑化のためにランダムな方法で使用されます）。

したがって、ヒープオーバーフローが発生する前の投稿では、オーバーフローが発生するオブジェクトを被害者の順序と衝突させるために、複数のスレッドによって複数の**`kallocs`が強制され、すべての空きチャンクが埋められ、新しいページが作成されるようにする必要があります**。

特定のサイズのオブジェクトでこの埋め込みを強制するために、**iOS mach port に関連付けられたアウトオブラインの割り当て**が理想的な候補です。メッセージのサイズを作成することで、`kalloc`の割り当てサイズを正確に指定し、対応するmach port が破棄されると、対応する割り当てがすぐに`kfree`に戻されます。

その後、これらのプレースホルダーのいくつかを**解放**することができます。**`kalloc.4096`のフリーリストは、後入れ先出しの順序で要素を解放**するため、いくつかのプレースホルダーが解放され、エクスプロイトがオーバーフローの脆弱なオブジェクトを割り当てようとする間に複数の被害者オブジェクトを割り当てようとする場合、このオブジェクトが被害者オブジェクトに続く可能性が高いです。

## ARM64の例

[https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) では、実行されるコマンドがオーバーフローしたチャンクから次のチャンクに格納されるヒープオーバーフローの例が示されています。そのため、簡単なエクスプロイトでそれを上書きして実行されるコマンドを変更することが可能です。
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手してください
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、当社の独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを発見してください
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
