# Shambulio la Bin isiyo na Mpangilio

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Taarifa Msingi

Kwa habari zaidi kuhusu ni nini bin isiyo na mpangilio angalia ukurasa huu:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Orodha zisizo na mpangilio zinaweza kuandika anwani kwa `unsorted_chunks (av)` katika anwani ya `bk` ya kipande. Kwa hivyo, ikiwa mshambuliaji anaweza **kurekebisha anwani ya kidole cha bk** katika kipande ndani ya benki isiyo na mpangilio, anaweza kuwa na uwezo wa **kuandika anwani hiyo katika anwani ya kupendelea** ambayo inaweza kusaidia kuvuja anwani za libc au kuepuka ulinzi fulani.

Kwa hivyo, kimsingi, shambulio hili liliruhusu **kubadilisha anwani isiyo ya kawaida na nambari kubwa** (anwani ambayo inaweza kuwa anwani ya rundo au anwani ya libc) kama anwani ya rundo ambayo inaweza kuvuja au kizuizi kama kipengele cha kawaida cha **`global_max_fast`** kuruhusu kuunda benki za haraka na saizi kubwa (na kupita kutoka kwa shambulio la benki isiyo na mpangilio hadi shambulio la benki ya haraka).

{% hint style="success" %}
Kwa kuangalia mfano uliotolewa katika [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) na kutumia 0x4000 na 0x5000 badala ya 0x400 na 0x500 kama saizi za kipande (kuepuka tcaches) inawezekana kuona kwamba **siku hizi** kosa **`malloc(): unsorted double linked list corrupted`** linasababishwa.

Kwa hivyo, shambulio la benki isiyo na mpangilio sasa (pamoja na ukaguzi mwingine) pia inahitaji kuweza kurekebisha orodha iliyodoubli ili hii ipuuzwe `victim->bck->fd == victim` au sivyo `victim->fd == av (arena)`. Hii inamaanisha kwamba anwani ambapo tunataka kuandika lazima iwe na anwani ya kipande bandia katika nafasi yake ya `fd` na kwamba kipande bandia `fd` inaelekeza kwenye uwanja.
{% endhint %}

{% hint style="danger" %}
Tafadhali kumbuka kuwa shambulio hili linaharibu benki isiyo na mpangilio (hivyo ndogo na kubwa pia). Kwa hivyo tunaweza **kutumia mgawo kutoka kwa benki ya haraka sasa** (programu yenye utata zaidi inaweza kufanya mgawo mwingine na kugonga), na kuzindua hii lazima **tugawe saizi ile ile au programu itaanguka.**

Tafadhali kumbuka kwamba kufanya **`global_max_fast`** inaweza kusaidia katika kesi hii kwa kuamini kwamba benki ya haraka itaweza kushughulikia mgawo wote mwingine hadi udanganyifu ukamilike.
{% endhint %}

Msimbo kutoka [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) unaelezea vizuri, ingawa ikiwa utabadilisha mallocs kuweka kumbukumbu kubwa ya kutosha ili isimalize kwenye tcache unaweza kuona kosa lililotajwa hapo awali linalozuia mbinu hii: **`malloc(): unsorted double linked list corrupted`**

## Shambulio la Unsorted Bin Infoleak

Hii ni dhana ya msingi sana. Vipande katika benki isiyo na mpangilio vitakuwa na vidole vya vidole mara mbili ili kuunda benki. Kipande cha kwanza katika benki isiyo na mpangilio kwa kweli kitakuwa na **FD** na **BK** viungo **vinavyoelekeza sehemu ya uwanja kuu (libc)**. Kwa hivyo, ikiwa unaweza **kuweka kipande ndani ya benki isiyo na mpangilio na kusoma** (tumia baada ya bure) au **kuweka tena bila kubadilisha angalau 1 ya vidole** kisha **kusoma** hiyo, unaweza kupata **vuja kwa libc**.

## Marejeo & Mifano Mingine

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* Lengo ni kubadilisha kipengele cha kawaida na thamani kubwa kuliko 4869 ili iwezekane kupata bendera na PIE haijashughulikiwa.
* Inawezekana kuzalisha vipande vya saizi za kiholela na kuna kipindupindu cha rundo na saizi inayotakiwa.
* Shambulio linaanza kwa kuunda vipande 3: kipande0 kutumia kipindupindu, kipande1 kufanyiwa kipindupindu na kipande2 ili kipande cha juu kisifanye konsolidate ya vipande vilivyopita.
* Kisha, kipande1 kinawekwa huru na kipande0 kinapinduliwa kwa kidole cha `bk` cha kipande1 kinachoelekeza: `bk = magic - 0x10`
* Kisha, kipande3 kinagawiwa na saizi ile ile kama kipande1, ambayo itasababisha shambulio la benki isiyo na mpangilio na kurekebisha thamani ya kipengele cha kawaida, ikifanya iwezekane kupata bendera.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* Kazi ya kufunga ni hatarini kwa sababu ikiwa viashiria vyote vilivyopitishwa ni sawa itarealloc juu yake na kisha kuifuta lakini kurudisha kidole kwa eneo hilo lililofutwa ambalo linaweza kutumika.
* Kwa hivyo, **vipande 2 vinavyoundwa**: **kipande0** ambacho kitafungwa na yenyewe na kipande1 kuzuia kufungwa na kipande cha juu. Kisha, **kazi ya kufunga inaitwa na kipande0** mara mbili ambayo itasababisha matumizi baada ya bure.
* Kisha, kazi ya **`view`** inaitwa na index 2 (ambayo ni index ya kipande baada ya bure), ambayo ita **vujisha anwani ya libc**.
* Kwa kuwa binary ina ulinzi wa tu malloc saizi kubwa kuliko **`global_max_fast`** hivyo hakuna fastbin inayotumiwa, shambulio la benki isiyo na mpangilio litatumika kurekebisha kipengele cha kawaida cha ulimwengu `global_max_fast`.
* Kisha, inawezekana kuita kazi ya hariri na index 2 (kidole baada ya bure) na kubadilisha kidole cha `bk` kuashiria `p64(global_max_fast-0x10)`. Kisha, kuunda kipande kipya kutatumia anwani ya bure iliyoharibiwa hapo awali (0x20) itasababisha shambulio la benki isiyo na mpangilio kurekebisha `global_max_fast` na thamani kubwa sana, kuruhusu sasa kuunda vipande katika benki za haraka.
* Sasa shambulio la **benki ya haraka** linafanywa:
* Kwanza kabisa inagundulika kwamba inawezekana kufanya kazi na **vipande vya haraka vya saizi 200** kwenye eneo la **`__free_hook`**:
* <pre class="language-c"><code class="lang-c">gef‚û§  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gef‚û§  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* Ikiwa tutafanikiwa kupata kipande cha haraka cha saizi 0x200 katika eneo hili, itakuwa inawezekana kubadilisha pointer ya kazi ambayo itatekelezwa
* Kwa hili, kipande kipya cha saizi `0xfc` hujengwa na kazi iliyohaririwa huitwa mara mbili na pointer hiyo, njia hii tunapata pointer kwa kipande kilichofutwa cha saizi `0xfc*2 = 0x1f8` katika sanduku la haraka.
* Kisha, kazi ya hariri inaitwa katika kipande hiki kurekebisha anwani ya **`fd`** ya sanduku hili la haraka ili ielekee kwenye kazi ya awali ya **`__free_hook`**.
* Kisha, kipande cha saizi `0x1f8` hujengwa ili kupata kutoka kwa sanduku la haraka kipande cha awali ambacho hakina maana hivyo kipande kingine cha saizi `0x1f8` hujengwa ili kupata kipande cha haraka katika **`__free_hook`** ambacho kimebadilishwa na anwani ya kazi ya **`system`**.
* Na hatimaye kipande kinachohusisha herufi `/bin/sh\x00` hufutwa kwa kuita kazi ya kufuta, kuzindua kazi ya **`__free_hook`** ambayo inaelekeza kwa mfumo na `/bin/sh\x00` kama parameta.

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
