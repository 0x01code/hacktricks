# Unsorted Bin Attack

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使用して、**ゼロからヒーローまでAWSハッキングを学ぶ**</a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**@hacktricks\_live**をフォローする
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

## 基本情報

アンソートされたビンについての詳細情報は、このページを参照してください：

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

アンソートリストは、チャンクの`bk`アドレスに`unsorted_chunks (av)`へのアドレスを書き込むことができます。したがって、攻撃者がアンソートされたビン内のチャンクの`bk`ポインタのアドレスを**変更できる場合**、任意のアドレスにそのアドレスを書き込むことができ、これはlibcアドレスをリークしたり、いくつかの防御をバイパスするのに役立つ可能性があります。

したがって、基本的にこの攻撃は、**任意のアドレスを大きな数値**（ヒープアドレスまたはlibcアドレスである可能性があるアドレス）で上書きできるようにするものです。これにより、リークする可能性のあるスタックアドレスや、グローバル変数**`global_max_fast`**のような制限を回避して、大きなサイズの高速ビンビンを作成できるようにすることができます（アンソートビン攻撃から高速ビン攻撃に移行する）。

{% hint style="success" %}
[https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle)で提供された例を見て、0x400と0x500の代わりに0x4000と0x5000を使用して（tcachesを避けるため）、**現在**はエラー**`malloc(): unsorted double linked list corrupted`**がトリガーされることがわかります。

したがって、このアンソートされたビン攻撃は（他のチェックと共に）ダブルリンクリストを修正できる必要があるため、これがバイパスされるようにする必要があります `victim->bck->fd == victim`または `victim->fd == av (arena)`。つまり、書き込みたいアドレスは、その`fd`位置に偽のチャンクのアドレスを持ち、偽のチャンクの`fd`がアリーナを指している必要があります。
{% endhint %}

{% hint style="danger" %}
この攻撃はアンソートされたビンを破壊します（したがって、小さなビンと大きなビンも）。したがって、**現在は高速ビンからの割り当てのみを使用できます**（より複雑なプログラムは他の割り当てを行い、クラッシュする可能性があります）、これをトリガーするには**同じサイズを割り当てる必要があります。**

**`global_max_fast`**を作成すると、この場合に役立つ場合があります。高速ビンがすべての他の割り当てを処理できるようになるまで、攻撃が完了します。
{% endhint %}

[**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html)のコードは非常によく説明していますが、mallocを変更して、tcachesに終わらないようにメモリを割り当てると、先に述べたエラーが発生して、このテクニックが防がれることがわかります：**`malloc(): unsorted double linked list corrupted`**

## 参考文献とその他の例

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* グローバル変数を4869より大きな値で上書きしてフラグを取得し、PIEが有効になっていない場合
* 任意のサイズのチャンクを生成でき、望ましいサイズのヒープオーバーフローが発生します。
* 攻撃は、3つのチャンクを作成して開始します：オーバーフローを悪用するchunk0、オーバーフローされるchunk1、前のチャンクを統合しないようにするchunk2。
* 次に、chunk1を解放し、chunk0をオーバーフローさせて、chunk1の`bk`ポインタが`bk = magic - 0x10`を指すようにします。
* 次に、chunk1と同じサイズでchunk3が割り当てられ、アンソートされたビン攻撃がトリガーされ、グローバル変数の値が変更され、フラグを取得できるようになります。
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* マージ関数は脆弱であり、渡された両方のインデックスが同じ場合、それに対してreallocし、それを解放して、それを使用できる解放された領域へのポインタを返します。
* したがって、**2つのチャンクが作成**されます：**chunk0**は自分自身とマージされ、トップチャンクと統合されないようにするためにchunk1が作成されます。その後、**マージ関数がchunk0で2回呼び出され**、これにより、解放後の使用が発生します。
* 次に、**`view`**関数が使用され、インデックス2（使用後の解放チャンクのインデックス）が呼び出され、**libcアドレスが漏洩**します。
* バイナリは**`global_max_fast`**よりも大きなサイズのmallocのみを許可する保護を持っているため、fastbinは使用されず、アンソートされたビン攻撃が使用されて、グローバル変数`global_max_fast`を上書きします。
* 次に、インデックス2（解放後の使用ポインタ）で編集関数を呼び出し、`bk`ポインタを`p64(global_max_fast-0x10)`を指すように上書きします。その後、新しいチャンクを作成すると、以前に侵害された解放アドレス（0x20）が使用され、**アンソートされたビン攻撃がトリガー**され、`global_max_fast`が非常に大きな値で上書きされ、今後は高速ビンでチャンクを作成できるようになります。
* 今度は**高速ビン攻撃**が実行されます：
* まず、**`__free_hook`**の場所でサイズ200の高速**チャンクで作業できることがわかります**：
* <pre class="language-c"><code class="lang-c">gef➤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gef➤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* この場所にサイズ0x200の高速チャンクを取得できれば、実行される関数ポインタを上書きできます
* これには、サイズ`0xfc`の新しいチャンクが作成され、そのポインタでマージ関数が2回呼び出され、この方法でサイズ`0xfc*2 = 0x1f8`の解放されたチャンクへのポインタが高速ビンに取得されます。
* 次に、このチャンクで編集関数が呼び出され、この高速ビンの`fd`アドレスを以前の**`__free_hook`**関数を指すように変更します。
* 次に、サイズが`0x1f8`のチャンクが作成され、高速ビンから以前の無用なチャンクを取得するために、サイズが`0x1f8`の別のチャンクが作成され、**`__free_hook`**内の高速ビンチャンクを取得し、**`system`**関数のアドレスで上書きされます。
* 最後に、文字列`/bin/sh\x00`を含むチャンクが削除関数を呼び出して解放され、**`__free_hook`**関数がトリガーされ、`/bin/sh\x00`をパラメータとして持つsystemにポイントされます。

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を使って、ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>
