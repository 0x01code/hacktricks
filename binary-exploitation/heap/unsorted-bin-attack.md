# Shambulio la Bin isiyo na Mpangilio

<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Taarifa Msingi

Kwa habari zaidi kuhusu ni nini bin isiyo na mpangilio angalia ukurasa huu:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Orodha zisizo na mpangilio zinaweza kuandika anwani kwa `unsorted_chunks (av)` katika anwani ya `bk` ya kipande. Kwa hivyo, ikiwa mshambuliaji anaweza **kubadilisha anwani ya kidole cha bk** katika kipande ndani ya benki isiyo na mpangilio, anaweza **kuandika anwani hiyo katika anwani ya aina yoyote** ambayo inaweza kusaidia kuvuja anwani ya libc au kuepuka ulinzi fulani.

Kwa hivyo, kimsingi, shambulio hili liliruhusu **kubadilisha anwani fulani na nambari kubwa** (anwani ambayo inaweza kuwa anwani ya rundo au anwani ya libc) kama anwani ya rundo ambayo inaweza kuvuja au kizuizi kama **`global_max_fast`** kuruhusu kuunda benki za haraka na saizi kubwa (na kupita kutoka kwa shambulio la benki isiyo na mpangilio hadi shambulio la benki ya haraka).

{% hint style="success" %}
Kwa kuangalia mfano uliotolewa katika [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) na kutumia 0x4000 na 0x5000 badala ya 0x400 na 0x500 kama saizi za kipande (kuepuka tcaches) inawezekana kuona kwamba **siku hizi** kosa **`malloc(): unsorted double linked list corrupted`** linasababishwa.

Kwa hivyo, shambulio la benki isiyo na mpangilio sasa (pamoja na ukaguzi mwingine) pia inahitaji kuweza kurekebisha orodha iliyodoubli ili hii ipuuzwe `victim->bck->fd == victim` au sivyo `victim->fd == av (arena)`. Hii inamaanisha kwamba anwani ambapo tunataka kuandika lazima iwe na anwani ya kipande bandia katika nafasi yake ya `fd` na kwamba kipande bandia `fd` inaelekeza kwenye uwanja.
{% endhint %}

{% hint style="danger" %}
Tafadhali kumbuka kuwa shambulio hili linaharibu benki isiyo na mpangilio (hivyo ndogo na kubwa pia). Kwa hivyo tunaweza **kutumia vipande kutoka kwa benki ya haraka sasa tu** (programu yenye utata zaidi inaweza kufanya alokesheni zingine na kugonga), na kuzindua hii tunapaswa **kutenga saizi ile ile au programu itaanguka.**

Tafadhali kumbuka kwamba kufanya **`global_max_fast`** kunaweza kusaidia katika kesi hii kwa kuamini kwamba benki ya haraka itaweza kushughulikia alokesheni zingine zote hadi shambulio litakapokamilika.
{% endhint %}

Msimbo kutoka [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) unaelezea vizuri, ingawa ikiwa utabadilisha mallocs kuweka kumbukumbu kubwa ya kutosha ili isimalize katika tcache unaweza kuona kosa lililotajwa hapo awali linalozuia mbinu hii: **`malloc(): unsorted double linked list corrupted`**

## Marejeleo & Mifano Mingine

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* Lengo ni kubadilisha kipengele cha jumla na thamani kubwa kuliko 4869 ili iwezekane kupata bendera na PIE haijashughulikiwa.
* Inawezekana kuzalisha vipande vya saizi za kiholela na kuna kipindupindu cha rundo na saizi inayotakiwa.
* Shambulio linaanza kwa kuunda vipande 3: chunk0 kutumia kipindupindu, chunk1 ili kipindupinduwe na chunk2 ili kipande cha juu kisifanye konsolidate ya vipande vilivyotangulia.
* Kisha, chunk1 inaachiliwa na chunk0 inapindupinduwa kwa kidole cha `bk` cha chunk1 kinachoelekeza: `bk = magic - 0x10`
* Kisha, chunk3 ina alokesheni na saizi ile ile kama chunk1, ambayo itazindua shambulio la benki isiyo na mpangilio na kubadilisha thamani ya kipengele cha jumla, ikifanya iwezekane kupata bendera.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* Kazi ya kufunga ni hatarini kwa sababu ikiwa viashiria vyote viwili vilivyopitishwa ni sawa itarealloc juu yake na kisha kuifuta lakini kurudisha kidole cha kwenye eneo hilo lililofutwa ambalo linaweza kutumika.
* Kwa hivyo, **vipande 2 vinavyoundwa**: **chunk0** ambayo itaunganishwa na yenyewe na chunk1 kuzuia konsolidate na kipande cha juu. Kisha, **kazi ya kuunganisha inaitwa na chunk0** mara mbili ambayo itasababisha matumizi baada ya kuachiliwa.
* Kisha, **kazi ya kuona** inaitwa na kiashiria 2 (ambacho ni kiashiria cha kipande kilichotumika baada ya kuachiliwa), ambayo ita **kuvuja anwani ya libc**.
* Kwa kuwa binary ina ulinzi wa tu malloc saizi kubwa kuliko **`global_max_fast`** hivyo hakuna fastbin inayotumiwa, shambulio la benki isiyo na mpangilio litatumika kubadilisha kipengele cha jumla `global_max_fast`.
* Kisha, inawezekana kuita kazi ya hariri na kiashiria 2 (kidole cha baada ya kuachiliwa) na kubadilisha kidole cha `bk` kuashiria `p64(global_max_fast-0x10)`. Kisha, kuunda kipande kipya kutatumia anwani ya bure iliyoharibiwa hapo awali (0x20) itazindua **shambulio la benki isiyo na mpangilio** kubadilisha `global_max_fast` na thamani kubwa sana, kuruhusu sasa kuunda vipande katika benki za haraka.
* Sasa shambulio la **benki ya haraka** linafanywa:
* Kwanza kabisa inagundulika kwamba inawezekana kufanya kazi na **vipande vya haraka vya saizi 200** kwenye eneo la **`__free_hook`**:
* <pre class="language-c"><code class="lang-c">gef‚û§  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gef‚û§  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* Ikiwa tunaweza kupata kipande cha haraka cha saizi 0x200 kwenye eneo hili, itawezekana kubadilisha kidole cha kazi ambacho kitatekelezwa
* Kwa hili, kipande kipya cha saizi `0xfc` kinachoundwa na kazi iliyounganishwa inaitwa mara mbili na kidole hicho, njia hii tunapata kidole kwa kipande kilichofutwa cha saizi `0xfc*2 = 0x1f8` katika benki ya haraka.
* Kisha, kazi ya hariri inaitwa kwenye kipande hiki kubadilisha anwani ya **`fd`** ya benki hii ya haraka kuashiria kwenye kazi ya awali ya **`__free_hook`**.
* Kisha, kipande chenye ukubwa wa `0x1f8` kinatengenezwa ili kurejesha kipande kisichotumika kilichopita kutoka kwa sanduku la haraka ili kipande kingine cha ukubwa wa `0x1f8` kibuniwe ili kupata kipande cha sanduku la haraka katika **`__free_hook`** ambacho kimebadilishwa na anwani ya kazi ya **`system`**.
* Na hatimaye kipande kinachohifadhi string `/bin/sh\x00` kinawekwa huru kwa kuita kazi ya kufuta, ikichochea kazi ya **`__free_hook`** ambayo inaelekeza kwa mfumo na `/bin/sh\x00` kama parameta.
