# スタックキャナリー

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。

- **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## **StackGuardとStackShield**

**StackGuard**は、**EIP（Extended Instruction Pointer）**の前に特別な値である**キャナリー**を挿入します。具体的には、バッファオーバーフローから保護するために`0x000aff0d`（ヌル、改行、EOF、復帰）を挿入します。ただし、`recv()`、`memcpy()`、`read()`、`bcopy()`などの関数は脆弱のままであり、**EBP（ベースポインタ）**を保護しません。

**StackShield**は、**グローバルリターンスタック**を維持することで、StackGuardよりも洗練されたアプローチを取ります。このセットアップにより、オーバーフローが害を引き起こさないように、格納された実際のリターンアドレスと比較してオーバーフローの発生を検出できます。さらに、StackShieldはリターンアドレスを境界値と比較して、**EIP**が予想されるデータスペースの外を指しているかどうかを検出できます。ただし、この保護はReturn-to-libc、ROP（Return-Oriented Programming）、ret2retなどのテクニックによって回避できるため、StackShieldもローカル変数を保護しません。

## **スタックスマッシュプロテクタ（ProPolice）`-fstack-protector`:**

このメカニズムは、**EBP**の前に**キャナリー**を配置し、ローカル変数を再配置してバッファをより高いメモリアドレスに配置し、他の変数を上書きするのを防ぎます。また、スタック上に渡された引数を安全にコピーし、これらのコピーを引数として使用します。ただし、8つ未満の要素を持つ配列やユーザー構造体内のバッファを保護しません。

**キャナリー**は、`/dev/urandom`から派生したランダムな数値またはデフォルト値の`0xff0a0000`から取得されます。これは**TLS（スレッドローカルストレージ）**に保存され、スレッド間で共有されるメモリスペースを持つことができます。これらの変数は最初に親プロセスからコピーされ、子プロセスはデータを変更することなく自分のデータを変更できます。ただし、新しいキャナリーを作成せずに**`fork()`**を使用すると、すべてのプロセス（親プロセスと子プロセス）が同じキャナリーを共有するため、脆弱になります。**i386**アーキテクチャでは、キャナリーは`gs:0x14`に、**x86\_64**では`fs:0x28`に保存されます。

このローカル保護は、攻撃に脆弱なバッファを持つ関数を特定し、これらの関数の先頭にキャナリーを配置し、最後にその整合性を検証するためのコードを挿入します。

Webサーバーが`fork()`を使用すると、キャナリーバイトを1バイトずつ推測するブルートフォース攻撃を有効にします。ただし、`fork()`の後に`execve()`を使用すると、メモリスペースが上書きされ、攻撃が無効化されます。`vfork()`は、子プロセスが書き込みを試みるまで複製を作成せずに実行できるようにするため、プロセスの作成とメモリの処理に異なるアプローチを提供します。

### 長さ

`x64`バイナリでは、キャナリークッキーは**`0x8`**バイトのqwordです。**最初の7バイトはランダム**で、最後の1バイトは**ヌルバイト**です。

`x86`バイナリでは、キャナリークッキーは**`0x4`**バイトのdwordです。**最初の3バイトはランダム**で、最後の1バイトは**ヌルバイト**です。

{% hint style="danger" %}
両方のキャナリーの最下位バイトはヌルバイトです。これは、下位アドレスから来るスタックの最初のバイトであり、したがって**文字列を読み取る関数はそれを読み取る前に停止します**。
{% endhint %}

## バイパス

**キャナリーを漏洩**してから、それを上書き（例：バッファオーバーフロー）する。

- **子プロセスでフォークされた場合、1バイトずつ**ブルートフォースできる可能性がある：

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

- バイナリ内に**興味深い漏洩または任意の読み取り脆弱性**がある場合、漏洩する可能性があります：

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

- **スタックに格納されたポインタを上書き**

スタックがスタックオーバーフローに脆弱であり、スタックキャナリーに到達する必要がない場合、**文字列や関数へのアドレスが含まれている可能性があり、これらを上書き**して脆弱性を悪用できます。次を確認してください：

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

- **マスターキャナリーとスレッドキャナリーの両方を変更**

キャナリーで保護されたスレッド関数内のバッファ**オーバーフロー**を使用して、スレッドの**マスターキャナリーを変更**できます。その結果、チェックに使用される2つのキャナリーが同じであるため、対策は無効になります（変更されていても）。

この攻撃は、次の解説で実行されます：[http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)

- **`__stack_chk_fail`のGOTエントリを変更**

バイナリがPartial RELROを持っている場合、**`__stack_chk_fail`のGOTエントリを変更**して、キャナリーが変更されてもプログラムをブロックしないダミー関数にすることができます。

この攻撃は、次の解説で実行されます：[https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

## 参考文献

- [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
- [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
- [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)
<details>
<summary>**HackTricks**</summary>
* **HackTricks**および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信して、あなたのハッキングテクニックを共有してください。
