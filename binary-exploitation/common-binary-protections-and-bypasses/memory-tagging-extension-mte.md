# Upanuzi wa Alama ya Kumbukumbu (MTE)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

**Upanuzi wa Alama ya Kumbukumbu (MTE)** umebuniwa kuboresha uaminifu na usalama wa programu kwa **kugundua na kuzuia makosa yanayohusiana na kumbukumbu**, kama vile kujaza mipaka ya ujazo na udhaifu wa kutumia baada ya kufutwa. MTE, kama sehemu ya usanifu wa **ARM**, hutoa mbinu ya kuambatanisha **alama ndogo kwa kila ukadiriaji wa kumbukumbu** na **alama inayolingana kwa kila kielekezi** kinachotaja kumbukumbu hiyo. Mbinu hii inaruhusu ugunduzi wa ufikiaji haramu wa kumbukumbu wakati wa muda wa uendeshaji, ikipunguza hatari kubwa ya kutumia udhaifu huo kwa kutekeleza nambari ya aina yoyote.

### **Jinsi Upanuzi wa Alama ya Kumbukumbu Unavyofanya Kazi**

MTE inafanya kazi kwa **kugawanya kumbukumbu katika vitengo vidogo vya ukubwa uliowekwa, kila kitengo kikipewa alama,** kawaida ya baadhi ya biti.&#x20;

Wakati kielekezi kinapoundwa kuelekeza kwenye kumbukumbu hiyo, kinapata alama ile ile. Alama hii inahifadhiwa katika **biti zisizotumiwa za kielekezi cha kumbukumbu**, ikilinkisha kielekezi kwa kitengo chake cha kumbukumbu kinacholingana.

<figure><img src="../../.gitbook/assets/image (1199).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Wakati programu inapata ufikiaji wa kumbukumbu kupitia kielekezi, vifaa vya MTE huchunguza kwamba **alama ya kielekezi inalingana na alama ya kitengo cha kumbukumbu**. Ikiwa alama hizo **hazilingani**, inaashiria ufikiaji haramu wa kumbukumbu.

### Alama za Kielekezi za MTE

Alama ndani ya kielekezi zinahifadhiwa katika biti 4 ndani ya baiti ya juu:

<figure><img src="../../.gitbook/assets/image (1200).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Hivyo, hii inaruhusu hadi **alama 16 tofauti za kielekezi**.

### Alama za Kumbukumbu za MTE

Kila **16B ya kumbukumbu ya kimwili** ina alama ya **kumbukumbu inayolingana**.

Alama za kumbukumbu zinahifadhiwa katika **eneo maalum la RAM** (lisilopatikana kwa matumizi ya kawaida). Kwa kuwa kuna alama za biti 4 kwa kila alama ya kumbukumbu ya 16B, hadi 3% ya RAM.

ARM inaleta maagizo yafuatayo kushughulikia alama hizi katika kumbukumbu maalum ya RAM:
```
STG [<Xn/SP>], #<simm>    Store Allocation (memory) Tag
LDG <Xt>, [<Xn/SP>]       Load Allocatoin (memory) Tag
IRG <Xd/SP>, <Xn/SP>      Insert Random [pointer] Tag
...
```
## Kukagua Aina

### Sync

CPU hukagua vitambulisho **wakati wa kutekeleza maagizo**, ikiwa kuna kutofautiana, inasababisha kipeperushi.\
Hii ni polepole zaidi na salama zaidi.

### Async

CPU hukagua vitambulisho **kwa njia isiyo ya moja kwa moja**, na inapopata kutofautiana huanzisha biti ya kipeperushi katika moja ya rejista za mfumo. Ni **haraka** kuliko ile ya awali lakini **haiwezi kubainisha** maagizo sahihi yanayosababisha kutofautiana na haisababishi kipeperushi mara moja, ikimpa muda mshambuliaji kumaliza shambulio lake.

### Kuchanganyikiwa

???

## Mifano ya Utekelezaji na Uchunguzi

Inaitwa KASAN ya Vitambulisho vya Vifaa, KASAN ya MTE-msingi au MTE ndani ya kernel.\
Wagawa-kernel (kama vile `kmalloc`) **wataita moduli hii** ambayo itajiandaa na kutumia vitambulisho (kwa nasibu) kuvifunga kwenye nafasi ya kernel iliyotengwa na kwenye kiotero kilichorudishwa.

Tambua kwamba ita **kutambua vijipande vya kumbukumbu vya kutosha** (kila moja ikiwa na 16B) kwa ukubwa ulioombwa. Kwa hivyo, ikiwa ukubwa ulioombwa ulikuwa 35 na slabu ya 60B ilitolewa, ita vifunga vya kwanza 16\*3 = 48B na kivitambulisho hiki na **kingine** kitakuwa **kimefungwa** na kivitambulisho kinachoitwa **batili (0xE)**.

Kivitambulisho **0xF** ni **kufanana na kiotero**. Kumbukumbu yenye kiotero hiki inaruhusu **kivitambulisho chochote kutumika** kufikia kumbukumbu yake (hakuna kutofautiana). Hii inaweza kuzuia MET kugundua shambulio ikiwa kivitambulisho hiki kinatumika kwenye kumbukumbu inayoshambuliwa.

Kwa hivyo kuna **thamani 14 tu** zinazoweza kutumika kuzalisha vitambulisho kwani 0xE na 0xF zimehifadhiwa, ikitoa uwezekano wa **kutumia tena vitambulisho** kwa 1/17 -> karibu **7%**.

Ikiwa kernel ina ufikivu wa **kipande cha kumbukumbu cha batili**, **kutofautiana** kutagunduliwa. Ikiwa inafikia eneo lingine la kumbukumbu, ikiwa **kumbukumbu ina kiotero tofauti** (au kiotero batili) kutofautiana kutagunduliwa. Ikiwa mshambuliaji ana bahati na kumbukumbu inatumia kiotero sawa, haitagunduliwa. Nafasi ni karibu 7%.

Kosa lingine hutokea katika **kipande cha mwisho** cha kumbukumbu iliyotengwa. Ikiwa programu iliomba 35B, ilipewa kiotero kutoka 32 hadi 48. Kwa hivyo, **baiti kutoka 36 hadi 47 zinatumia kiotero sawa** lakini hazikuombwa. Ikiwa mshambuliaji anafikia **baiti hizi ziada, hii haitagunduliwa**.

Wakati wa **`kfree()`** kutekelezwa, kumbukumbu inapewa tena kiotero cha kumbukumbu batili, kwa hivyo katika **matumizi-baada-ya-kuachiliwa**, wakati kumbukumbu inafikiwa tena, **kutofautiana kutagunduliwa**.

Hata hivyo, katika matumizi-baada-ya-kuachiliwa, ikiwa **kipande kile kile kinafanyiwa upya tena na KIOTERO SAWA** kama awali, mshambuliaji ataweza kutumia ufikivu huu na hii haitagunduliwa (nafasi ya karibu 7%).

Zaidi ya hayo, **`slab` na `page_alloc`** pekee hutumia kumbukumbu zenye vitambulisho lakini baadaye hii pia itatumika katika `vmalloc`, `stack` na `globals` (wakati wa video hizi bado zinaweza kutumiwa vibaya).

Wakati **kutofautiana inagunduliwa** kernel ita **paniki** ili kuzuia shambulio zaidi na majaribio ya shambulio (MTE haina makosa ya uwongo).

## Marejeo

* [https://www.youtube.com/watch?v=UwMt0e\_dC\_Q](https://www.youtube.com/watch?v=UwMt0e\_dC\_Q)
