# Bellek Etiketleme Uzantısı (MTE)

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong> ile!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [Discord grubuna](https://discord.gg/hRep4RUj7f) veya [telegram grubuna](https://t.me/peass) katılın veya bizi Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Temel Bilgiler

**Bellek Etiketleme Uzantısı (MTE)**, **önbellek taşmaları ve kullanımdan sonra serbest bırakma güvenlik açıklarını tespit edip önleyerek**, yazılım güvenilirliğini ve güvenliğini artırmak amacıyla tasarlanmıştır. MTE, **ARM** mimarisinin bir parçası olarak, her bellek tahsisine **küçük bir etiket eklemek** ve o belleği işaretleyen her işaretçiye **ilgili etiketi eklemek** için bir mekanizma sağlar. Bu yaklaşım, yasadışı bellek erişimlerini çalışma zamanında tespit etmeyi sağlar ve bu tür güvenlik açıklarını kötü amaçlı kod yürütmek için kullanma riskini önemli ölçüde azaltır.

### **Bellek Etiketleme Uzantısının Çalışma Şekli**

MTE, belleği **küçük, sabit boyutlu bloklara böler ve her bloğa bir etiket atar**, genellikle birkaç bit boyutunda.

Bir işaretçi o belleği işaret etmek üzere oluşturulduğunda, aynı etiketi alır. Bu etiket, işaretçinin **kullanılmayan bitlerinde** saklanır ve etkili bir şekilde işaretçiyi ilgili bellek bloğuna bağlar.

<figure><img src="../../.gitbook/assets/image (1199).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bir program bir işaretçi aracılığıyla belleğe eriştiğinde, MTE donanımı **işaretçinin etiketinin bellek bloğunun etiketiyle eşleşip eşleşmediğini** kontrol eder. Etiketler **eşleşmiyorsa**, yasadışı bellek erişimini gösterir.

### MTE İşaretçi Etiketleri

İşaretçi içindeki etiketler, en üst baytın içindeki 4 bitte saklanır:

<figure><img src="../../.gitbook/assets/image (1200).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bu nedenle, bu, **16 farklı etiket değerine** kadar olanak tanır.

### MTE Bellek Etiketleri

Her **16B fiziksel belleğin** karşılık gelen bir **bellek etiketi** vardır.

Bellek etiketleri, **özel bir RAM bölgesinde** saklanır (normal kullanım için erişilemez). 16B bellek etiketleri için 4 bit etiketlere kadar RAM'ın %3'üne kadar.

ARM, bu etiketleri özel RAM bellekte işlemek için aşağıdaki talimatları tanıtır:
```
STG [<Xn/SP>], #<simm>    Store Allocation (memory) Tag
LDG <Xt>, [<Xn/SP>]       Load Allocatoin (memory) Tag
IRG <Xd/SP>, <Xn/SP>      Insert Random [pointer] Tag
...
```
## Kontrol Modları

### Senkron

CPU, etiketleri **komut yürütülürken** kontrol eder, eşleşme olursa istisna oluşturur.\
Bu en yavaş ve en güvenlidir.

### Asenkron

CPU etiketleri **asenkron olarak** kontrol eder, eşleşme bulunduğunda bir istisna bitini bir sistem kaydında ayarlar. Öncekine göre **daha hızlı**dır ancak eşleşmeye neden olan tam komutu belirleyemez ve istisnayı hemen oluşturmaz, saldırganın saldırısını tamamlaması için zaman verir.

### Karışık

???

## Uygulama ve Tespit Örnekleri

Donanım Etiket Tabanlı KASAN olarak adlandırılan, MTE tabanlı KASAN veya çekirdek MTE.\
Çekirdek tahsis edicileri (`kmalloc` gibi) **bu modülü çağıracak** ve kullanılacak etiketi (rastgele) hazırlayacak ve ayrılan çekirdek alanına ekleyecek ve döndürülen işaretçiye ekleyecektir.

Talep edilen boyut için yeterli bellek granülünü (her biri 16B) **yalnızca işaretleyeceğini** unutmayın. Bu nedenle, talep edilen boyut 35 ise ve 60B'lik bir yonga verildiyse, ilk 16\*3 = 48B'yi bu etiketle işaretleyecek ve **geri kalanı** sözde **geçersiz etiketle (0xE)** işaretleyecektir.

Etiket **0xF**, **tüm işaretçileri eşleştirir**. Bu işaretçiye sahip bir bellek, belleğine erişmek için **herhangi bir etiketi kullanmaya izin verir** (eşleşmeler yok). Bu, saldırıyı algılamasını önleyebilir.

Bu nedenle, 0xE ve 0xF'nin ayrılmış olduğu **14 değer** kullanılabilir, etiketlerin **yeniden kullanılma olasılığı** 1/17 -> yaklaşık **%7**.

Çekirdek **geçersiz etiket granülüne** erişirse, **uyumsuzluk algılanır**. Başka bir bellek konumuna erişirse, belleğin **farklı bir etikete** (veya geçersiz etikete) sahip olması durumunda uyumsuzluk algılanır. Saldırgan şanslıysa ve bellek aynı etiketi kullanıyorsa, algılanmaz. Şanslar yaklaşık %7'dir.

Başka bir hata, ayrılan belleğin **son granülünde** meydana gelir. Uygulama 35B istediğinde, 32 ile 48 arasından granül verildi. Bu nedenle, 36 ile 47 arasındaki baytlar aynı etiketi kullanıyor ancak istenmedi. Saldırgan bu ekstra baytlara erişirse, bu algılanmaz.

**`kfree()`** çalıştırıldığında, bellek geçersiz bellek etiketiyle tekrar etiketlenir, bu nedenle bir **kullanımdan sonra serbest bırakma** durumunda, belleğe tekrar erişildiğinde **uyumsuzluk algılanır**.

Ancak, bir kullanımdan sonra serbest bırakma durumunda, aynı **yonga öncekiyle AYNI etiketle** tekrar tahsis edilirse, saldırgan bu erişimi kullanabilir ve bu algılanmaz (%7'lik bir şans).

Ayrıca, yalnızca **`slab` ve `page_alloc`** etiketli bellek kullanır, ancak gelecekte bu, `vmalloc`, `stack` ve `globals`da da kullanılacaktır (videonun çekildiği sırada bunlar hala kötüye kullanılabilir).

Bir **uyumsuzluk algılandığında**, çekirdek **panik yapar** ve daha fazla kötüye kullanım ve saldırı denemesini önlemek için (MTE yanlış pozitiflere sahip değildir).

## Referanslar

* [https://www.youtube.com/watch?v=UwMt0e\_dC\_Q](https://www.youtube.com/watch?v=UwMt0e\_dC\_Q)
