# Casa de Einherjar

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

### C√≥digo

* Verifique o exemplo em [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Ou o de [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (voc√™ pode precisar preencher o tcache)

### Objetivo

* O objetivo √© alocar mem√≥ria em quase qualquer endere√ßo espec√≠fico.

### Requisitos

* Criar um chunk falso quando queremos alocar um chunk:
* Definir ponteiros para apontar para si mesmo para contornar verifica√ß√µes de integridade
* Estouro de um byte com um byte nulo de um chunk para o pr√≥ximo para modificar a flag `PREV_INUSE`.
* Indicar no `prev_size` do chunk abusado por off-by-null a diferen√ßa entre ele mesmo e o chunk falso
* O tamanho do chunk falso tamb√©m deve ter sido definido com o mesmo tamanho para contornar verifica√ß√µes de integridade
* Para construir esses chunks, voc√™ precisar√° de um vazamento de heap.

### Ataque

* Um chunk falso √© criado dentro de um chunk controlado pelo atacante apontando com `fd` e `bk` para o chunk original para contornar prote√ß√µes
* 2 outros chunks (`B` e `C`) s√£o alocados
* Abusando do off-by-one no `B`, o bit `prev in use` √© limpo e os dados `prev_size` s√£o sobrescritos com a diferen√ßa entre o local onde o chunk `C` √© alocado e o chunk falso `A` gerado anteriormente
* Este `prev_size` e o tamanho no chunk falso `A` devem ser os mesmos para contornar verifica√ß√µes.
* Em seguida, o tcache √© preenchido
* Em seguida, `C` √© liberado para que ele se consolide com o chunk falso `A`
* Em seguida, um novo chunk `D` √© criado que come√ßar√° no chunk falso `A` e cobrir√° o chunk `B`
* A casa de Einherjar termina aqui
* Isso pode ser continuado com um ataque de fast bin ou envenenamento de Tcache:
* Libere `B` para adicion√°-lo ao fast bin / Tcache
* O `fd` de `B` √© sobrescrito fazendo-o apontar para o endere√ßo alvo abusando do chunk `D` (pois ele cont√©m `B` dentro)&#x20;
* Em seguida, s√£o feitos 2 mallocs e o segundo vai **alocar o endere√ßo alvo**

## Refer√™ncias e outros exemplos

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Depois de liberar ponteiros, eles n√£o s√£o anulados, ent√£o ainda √© poss√≠vel acessar seus dados. Portanto, um chunk √© colocado no bin n√£o ordenado e vazados os ponteiros que ele cont√©m (vazamento de libc) e ent√£o um novo heap √© colocado no bin n√£o ordenado e vazado um endere√ßo de heap do ponteiro que ele recebe.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Bug de estouro de byte nulo em `strtok`.
* Use a Casa de Einherjar para obter uma situa√ß√£o de chunks sobrepostos e termine com envenenamento de Tcache para obter um primitivo de escrita arbitr√°rio.
