# Haus von Einherjar

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks in PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys einreichen.

</details>

## Grundlegende Informationen

### Code

* √úberpr√ºfen Sie das Beispiel unter [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Oder das unter [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (m√∂glicherweise m√ºssen Sie den tcache f√ºllen)

### Ziel

* Das Ziel ist es, Speicher fast an einer bestimmten Adresse zuzuweisen.

### Anforderungen

* Erstellen Sie einen gef√§lschten Chunk, wenn Sie einen Chunk zuweisen m√∂chten:
* Setzen Sie Zeiger so, dass sie auf sich selbst zeigen, um die Integrit√§tspr√ºfungen zu umgehen
* Off-by-one von einem Chunk zum anderen, um das vorherige in Benutzung zu √§ndern
* Geben Sie im `prev_size` des missbrauchten Off-by-One-Chunks den Unterschied zwischen sich selbst und dem gef√§lschten Chunk an
* Die Gr√∂√üe des gef√§lschten Chunks muss ebenfalls auf die gleiche Gr√∂√üe gesetzt worden sein, um die Integrit√§tspr√ºfungen zu umgehen
* F√ºr die Konstruktion dieser Chunks ben√∂tigen Sie ein Heap-Leak.

### Angriff

* Es wird ein gef√§lschter Chunk innerhalb eines vom Angreifer kontrollierten Chunks erstellt, der mit `fd` und `bk` auf den urspr√ºnglichen Chunk zeigt, um Schutzmechanismen zu umgehen
* 2 weitere Chunks (`B` und `C`) werden allokiert
* Durch Ausnutzen des Off-by-One im `B` wird das `prev in use`-Bit gel√∂scht und die `prev_size`-Daten mit dem Unterschied zwischen dem Ort, an dem der `C`-Chunk allokiert ist, und dem zuvor generierten gef√§lschten `A`-Chunk √ºberschrieben
* Diese `prev_size` und die Gr√∂√üe im gef√§lschten Chunk `A` m√ºssen gleich sein, um die Pr√ºfungen zu umgehen.
* Dann wird der tcache gef√ºllt
* Dann wird `C` freigegeben, damit es sich mit dem gef√§lschten Chunk `A` konsolidiert
* Dann wird ein neuer Chunk `D` erstellt, der im gef√§lschten `A`-Chunk beginnt und den `B`-Chunk abdeckt
* Das Haus von Einherjar endet hier
* Dies kann mit einem Fast-Bin-Angriff fortgesetzt werden:
* Geben Sie `B` frei, um es dem Fast-Bin hinzuzuf√ºgen
* Das `fd` von `B` wird √ºberschrieben, sodass es auf die Zieladresse zeigt und den `D`-Chunk missbraucht (da er `B` enth√§lt)&#x20;
* Dann werden 2 mallocs durchgef√ºhrt und der zweite wird die **Zieladresse zuweisen**

## Referenzen und weitere Beispiele

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Nachdem Zeiger freigegeben wurden, werden sie nicht nullifiziert, sodass es immer noch m√∂glich ist, auf ihre Daten zuzugreifen. Daher wird ein Chunk in den unsortierten Bin platziert und die darin enthaltenen Zeiger geleakt (libc leak) und dann wird ein neuer Heap im unsortierten Bin platziert und eine Heap-Adresse aus dem Zeiger geleakt, den er erh√§lt.
