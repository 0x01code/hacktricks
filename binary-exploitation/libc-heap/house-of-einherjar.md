# House of Einherjar

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で私たちをフォローする [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## 基本情報

### コード

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)から例を確認してください
* または[https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation)から（tcacheを埋める必要があるかもしれません）

### ゴール

* ほぼ任意の特定のアドレスにメモリを割り当てることです。

### 必要条件

* チャンクを割り当てるときに偽のチャンクを作成します：
* サニティチェックをバイパスするためにポインタを自分自身を指すように設定します
* 1バイトのオーバーフローを使用して、1つのチャンクから次のチャンクにヌルバイトを流し込み、`PREV_INUSE`フラグを変更します。
* オフバイヌルを悪用したチャンクの`prev_size`に、自身と偽のチャンクとの間の差を示します
* 偽のチャンクのサイズもサニティチェックをバイパスするために同じサイズに設定されている必要があります
* これらのチャンクを構築するには、ヒープリークが必要です。

### 攻撃

* 攻撃者が制御するチャンク内に偽のチャンクが作成され、`fd`と`bk`が元のチャンクを指すようにして保護をバイパスします
* 他の2つのチャンク（`B`と`C`）が割り当てられます
* `B`のオフバイワンを悪用して、`prev in use`ビットがクリアされ、`prev_size`データが`C`チャンクが割り当てられる場所から前に生成された偽の`A`チャンクまでの差で上書きされます
* この`prev_size`と偽のチャンク`A`のサイズは、チェックをバイパスするために同じである必要があります。
* 次に、tcacheを埋めます
* 次に、`C`を解放して、偽のチャンク`A`と統合します
* 次に、偽の`A`チャンクで始まり、`B`チャンクをカバーする新しいチャンク`D`が作成されます
* Einherjarのハウスはここで終わります
* これは、ファストビンアタックまたはTcacheポイズニングで続けることができます：
* `B`を解放して、それをファストビン/ Tcacheに追加します
* `B`の`fd`を上書きして、`D`チャンクを悪用してターゲットアドレスを指すようにします（`B`が内部に含まれているため）
* 次に、2つのmallocを行い、2番目のmallocが**ターゲットアドレスを割り当てる**ことになります

## 参考文献と他の例

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* ポインタを解放した後、それらがヌル化されないため、データにアクセスできる可能性があります。したがって、未整列ビンにチャンクを配置し、それが含むポインタをリークします（libcリーク）、次に新しいヒープを未整列ビンに配置し、それが取得するポインタからヒープアドレスをリークします。
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* `strtok`でのヌルバイトオーバーフローバグ。
* House of Einherjarを使用してオーバーラップするチャンクの状況を取得し、Tcacheポイズニングで任意の書き込み原始を取得します。
