# Dubbele Vrylating

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Controleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Basiese Inligting

As jy 'n blok geheue meer as een keer vrylating, kan dit die toewysers se data deurmekaar maak en die deur oopmaak vir aanvalle. Hier is hoe dit gebeur: wanneer jy 'n blok geheue vrylaat, gaan dit terug na 'n lys van vry blokkies (bv. die "vinnige bin"). As jy dieselfde blok twee keer agtermekaar vrylaat, detecteer die toewyser dit en gooi 'n fout. Maar as jy **'n ander blokkie vrylaat tussenin, word die dubbele-vrylating toets omseil**, wat korrupsie veroorsaak.

Nou, wanneer jy nuwe geheue vra (deur `malloc` te gebruik), kan die toewyser jou 'n **blok gee wat twee keer vrygelaat is**. Dit kan lei tot twee verskillende aanwysers wat na dieselfde geheueplek wys. As 'n aanvaller een van daardie aanwysers beheer, kan hulle die inhoud van daardie geheue verander, wat sekuriteitsprobleme kan veroorsaak of selfs hulle in staat stel om kode uit te voer.

Voorbeeld:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i1);

return 0;
}
```
In hierdie voorbeeld, nadat die tcache met verskeie vrygemaakte blokke (7) gevul is, **vry die kode blok `h`, dan blok `i`, en dan weer `h`, wat 'n dubbele vrygawe veroorsaak** (ook bekend as 'n Fast Bin dup). Dit maak die moontlikheid oop om oorvleulende geheue-adresse te ontvang wanneer herverdeling plaasvind, wat beteken dat twee of meer aanwysers na dieselfde geheue-plek kan wys. Die manipulasie van data deur een aanwyser kan dan die ander be√Ønvloed, wat 'n kritieke veiligheidsrisiko en potensiaal vir uitbuiting skep.

By die uitvoering daarvan, let op hoe **`i1` en `i2` dieselfde adres gekry het**:

<pre><code>Aanvanklike toekenning:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
Na herverdelings:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## Voorbeelde

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* Ons kan slegs Fast-Bin-grootte blokke toeken behalwe vir grootte `0x70`, wat die gewone `__malloc_hook` oorskrywing voorkom.
* In plaas daarvan gebruik ons PIE-adresse wat met `0x56` begin as 'n teiken vir Fast Bin dup (1/2 kans).
* Een plek waar PIE-adresse gestoor word, is in `main_arena`, wat binne Glibc is en naby `__malloc_hook` is.
* Ons teiken 'n spesifieke offset van `main_arena` om 'n blok daar toe te ken en voort te gaan om blokke toe te ken totdat ons `__malloc_hook` bereik om kode-uitvoering te kry.
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Deur gebruik te maak van Tcache-blokke en 'n nul-byte oorvloei, kan ons 'n dubbele-vry situasie bereik:
* Ons ken drie blokke van grootte `0x110` toe (`A`, `B`, `C`)
* Ons vry `B`
* Ons vry `A` en ken weer toe om die nul-byte oorvloei te gebruik
* Nou is `B` se grootteveld `0x100`, in plaas van `0x111`, sodat ons dit weer kan vrymaak
* Ons het een Tcache-blok van grootte `0x110` en een van grootte `0x100` wat na dieselfde adres wys. Dus het ons 'n dubbele vrygawe.
* Ons maak gebruik van die dubbele vrygawe deur [Tcache-vergiftiging](tcache-bin-attack.md) te gebruik

## Verwysings

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hack-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}
