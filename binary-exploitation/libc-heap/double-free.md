# рдбрдмрд▓ рдлреНрд░реА

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ **@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ.

</details>
{% endhint %}

## рдореМрд▓рд┐рдХ рдЬрд╛рдирдХрд╛рд░реА

рдЕрдЧрд░ рдЖрдк рдХрд┐рд╕реА рдмреНрд▓реЙрдХ рдХреА рдпрд╛рджрд╛рд╕реНрдд рдЕрдзрд┐рдХ рдмрд╛рд░ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдЖрд▓реЛрдХрдХрд╛рд░ рдХреЗ рдбреЗрдЯрд╛ рдХреЛ рдЧрдбрд╝рдмрдбрд╝ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╣рдорд▓реЛрдВ рдХреЗ рджрд░рд╡рд╛рдЬреЗ рдЦреЛрд▓ рд╕рдХрддрд╛ рд╣реИред рдпрд╣рд╛рдБ рдпрд╣ рдХреИрд╕реЗ рд╣реЛрддрд╛ рд╣реИ: рдЬрдм рдЖрдк рдХрд┐рд╕реА рдмреНрд▓реЙрдХ рдХреА рдпрд╛рджрд╛рд╕реНрдд рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдореБрдХреНрдд рдЯреБрдХрдбрд╝реЛрдВ рдХреА рд╕реВрдЪреА рдореЗрдВ рдЬрд╛рддрд╛ рд╣реИ (рдЬреИрд╕реЗ "рдлрд╛рд╕реНрдЯ рдмрд┐рди")ред рдЕрдЧрд░ рдЖрдк рдПрдХ рд╣реА рдмреНрд▓реЙрдХ рдХреЛ рджреЛ рдмрд╛рд░ рд▓рдЧрд╛рддрд╛рд░ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрд▓реЛрдХрдХрд╛рд░ рдЗрд╕реЗ рдкрд╣рдЪрд╛рдирддрд╛ рд╣реИ рдФрд░ рддреНрд░реБрдЯрд┐ рдлреЗрдВрдХ рджреЗрддрд╛ рд╣реИред рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЖрдк **рджреЛрдиреЛрдВ рдХреЗ рдмреАрдЪ рдПрдХ рдФрд░ рдЯреБрдХрдбрд╝рд╛ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдбрдмрд▓-рдлреНрд░реА рдЬрд╛рдВрдЪ рдХреЛ рдЫрд▓рдирд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдЬрд┐рд╕рд╕реЗ рдХреНрд╖рддрд┐ рд╣реЛ рд╕рдХрддреА рд╣реИред

рдЕрдм, рдЬрдм рдЖрдк рдирдИ рдпрд╛рджрд╛рд╕реНрдд рдХреЗ рд▓рд┐рдП рдорд╛рдВрдЧ рдХрд░рддреЗ рд╣реИрдВ (`malloc` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ), рддреЛ рдЖрд▓реЛрдХрдХрд╛рд░ рдЖрдкрдХреЛ рдПрдХ **рдмреНрд▓реЙрдХ рджреЗ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рджреЛ рдмрд╛рд░ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред рдпрд╣ рджреЛ рд╡рд┐рднрд┐рдиреНрди рдкреНрд╡рд╛рдЗрдВрдЯрд░реНрд╕ рдХреЛ рдПрдХ рд╣реА рдпрд╛рджрд╛рд╕реНрдд рд╕реНрдерд╛рди рдкрд░ рдкреНрд╡рд╛рдЗрдВрдЯ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИред рдпрджрд┐ рдХреЛрдИ рд╣рдорд▓рд╛рд╡рд░ рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рдкреНрд╡рд╛рдЗрдВрдЯрд░ рдХрдВрдЯреНрд░реЛрд▓ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡реЗ рдЙрд╕ рдпрд╛рджрд╛рд╕реНрдд рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд╕реНрдпрд╛рдПрдБ рдЙрддреНрдкрдиреНрди рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдпрд╛ рдЙрдиреНрд╣реЗрдВ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓ рд╕рдХрддреА рд╣реИред

рдЙрджрд╛рд╣рд░рдг:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i1);

return 0;
}
```
рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдЯреАрдХреЗрд╢ рдХреЛ рдХрдИ рдореБрдХреНрдд рдЪрдВрдХреЛрдВ рд╕реЗ рднрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдХреЛрдб **рдЪрдВрдХ `h` рдХреЛ рдореБрдХреНрдд рдХрд░рддрд╛ рд╣реИ, рдлрд┐рд░ рдЪрдВрдХ `i` рдХреЛ рдФрд░ рдлрд┐рд░ `h` рдХреЛ рдлрд┐рд░ рд╕реЗ, рдЬрд┐рд╕рд╕реЗ рдбрдмрд▓ рдореБрдХреНрддрд┐ рд╣реЛрддреА рд╣реИ** (рдЬрд┐рд╕реЗ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдбреБрдк рднреА рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ)ред рдпрд╣ рдкреБрдирд░реНрдирд┐рд░реНрдзрд╛рд░рдг рдХрд░рддреЗ рд╕рдордп рдУрд╡рд░рд▓реИрдкрд┐рдВрдЧ рдореЗрдореЛрд░реА рдкрддреЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдЦреЛрд▓рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рджреЛ рдпрд╛ рджреЛ рд╕реЗ рдЕрдзрд┐рдХ рдкреЙрдЗрдВрдЯрд░ рдПрдХ рд╣реА рдореЗрдореЛрд░реА рд╕реНрдерд╛рди рдХреЛ рд╕реВрдЪрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЗрдЯрд╛ рдХреЛ рдореЛрдбрд╝рдирд╛ рдлрд┐рд░ рджреВрд╕рд░реЗ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдо рдФрд░ рдЙрддреНрдкреАрдбрд╝рди рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдмрдирд╛рддрд╛ рд╣реИред

рдЗрд╕реЗ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░рддреЗ рд╕рдордп, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`i1` рдФрд░ `i2` рдХреЛ рдПрдХ рд╣реА рдкрддрд╛ рдорд┐рд▓рд╛**:

<pre><code>рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЖрд╡рдВрдЯрди:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
рдкреБрдирд░реНрдирд┐рд░реНрдзрд╛рд░рдг рдХреЗ рдмрд╛рдж:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## рдЙрджрд╛рд╣рд░рдг

* [**рдбреНрд░реИрдЧрди рдЖрд░реНрдореА. рд╣реИрдХ рдж рдмреЙрдХреНрд╕**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* рд╣рдо рдХреЗрд╡рд▓ рдлрд╛рд╕реНрдЯ-рдмрд┐рди-рдЖрдХрд╛рд░ рдХреЗ рдЪрдВрдХреНрд╕ рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рд╕рд╛рдЗрдЬ `0x70` рдХреЛ рдЫреЛрдбрд╝рдХрд░, рдЬреЛ рд╕рд╛рдорд╛рдиреНрдп `__malloc_hook` рдУрд╡рд░рд░рд╛рдЗрдЯ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИред
* рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рд╣рдо PIE рдкрддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ `0x56` рд╕реЗ рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдбреБрдк рдХреЗ рд▓рд┐рдП рд▓рдХреНрд╖реНрдп рд╣реЛрддреЗ рд╣реИрдВ (1/2 рдЕрд╡рд╕рд░)ред
* PIE рдкрддреЛрдВ рдХрд╛ рдПрдХ рд╕реНрдерд╛рди рд╣реИ `main_arena`, рдЬреЛ Glibc рдХреЗ рдЕрдВрджрд░ рд╣реИ рдФрд░ `__malloc_hook` рдХреЗ рдкрд╛рд╕ рд╣реИ
* рд╣рдо `main_arena` рдХреЗ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдСрдлрд╕реЗрдЯ рдХреЛ рд▓рдХреНрд╖реНрдп рдмрдирд╛рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡рд╣рд╛рдВ рдПрдХ рдЪрдВрдХ рдЖрд╡рдВрдЯрд┐рдд рдХрд░ рд╕рдХреЗрдВ рдФрд░ `__malloc_hook` рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рддрдХ рдЪрдВрдХ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддреЗ рд░рд╣реЗрдВ рддрд╛рдХрд┐ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛ рд╕рдХреЗред
* [**рдЬреАрд░реЛ_рдЯреВ_рд╣реАрд░реЛ. рдкрд┐рдХреЛрд╕реАрдЯреАрдПрдл**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Tcache рдмрд┐рдиреНрд╕ рдФрд░ рдирд▓-рдмрд╛рдЗрдЯ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдо рдПрдХ рдбрдмрд▓-рдореБрдХреНрддрд┐ рд╕реНрдерд┐рддрд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
* рд╣рдо рд╕рд╛рдЗрдЬ `0x110` рдХреЗ рддреАрди рдЪрдВрдХреНрд╕ рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддреЗ рд╣реИрдВ (`A`, `B`, `C`)
* рд╣рдо `B` рдХреЛ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ
* рд╣рдо `A` рдХреЛ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд▓-рдмрд╛рдЗрдЯ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ
* рдЕрдм `B` рдХрд╛ рд╕рд╛рдЗрдЬ рдлрд╝реАрд▓реНрдб `0x100` рд╣реИ, рдмрдЬрд╛рдп `0x111`, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЗрд╕реЗ рдлрд┐рд░ рд╕реЗ рдореБрдХреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
* рд╣рдореЗрдВ рдПрдХ Tcache-рдмрд┐рди рд╣реИ рд╕рд╛рдЗрдЬ `0x110` рдХрд╛ рдФрд░ рдПрдХ рд╕рд╛рдЗрдЬ `0x100` рдХрд╛ рдЬреЛ рдПрдХ рд╣реА рдкрддреЗ рдкрд░ рдкреЙрдЗрдВрдЯ рдХрд░рддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдПрдХ рдбрдмрд▓ рдореБрдХреНрддрд┐ рд╣реИред
* рд╣рдо [Tcache poisoning](tcache-bin-attack.md) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрдмрд▓ рдореБрдХреНрддрд┐ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддреЗ рд╣реИрдВ

## рд╕рдВрджрд░реНрдн

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕** рдФрд░ [**рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб**](https://github.com/carlospolop/hacktricks) рдФрд░ [**рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}
