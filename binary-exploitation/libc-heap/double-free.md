# Doppelfreigabe

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

Wenn Sie einen Speicherblock mehr als einmal freigeben, kann dies die Daten des Zuweisers durcheinanderbringen und Angriffsm√∂glichkeiten er√∂ffnen. So passiert es: Wenn Sie einen Speicherblock freigeben, wird er wieder in eine Liste freier Chunks (z. B. den "schnellen Bin") aufgenommen. Wenn Sie denselben Block zweimal hintereinander freigeben, erkennt der Zuweiser dies und wirft einen Fehler. Wenn Sie jedoch **einen anderen Chunk dazwischen freigeben, wird die Doppelfreigabepr√ºfung umgangen**, was zu Korruption f√ºhren kann.

Nun, wenn Sie neuen Speicher anfordern (mit `malloc`), k√∂nnte der Zuweiser Ihnen einen **Block geben, der zweimal freigegeben wurde**. Dies kann dazu f√ºhren, dass zwei verschiedene Zeiger auf denselben Speicherort zeigen. Wenn ein Angreifer einen dieser Zeiger kontrolliert, kann er den Inhalt dieses Speichers √§ndern, was Sicherheitsprobleme verursachen oder ihnen sogar erm√∂glichen kann, Code auszuf√ºhren.

Beispiel:
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
// Allocate memory for three chunks
char *a = (char *)malloc(10);
char *b = (char *)malloc(10);
char *c = (char *)malloc(10);
char *d = (char *)malloc(10);
char *e = (char *)malloc(10);
char *f = (char *)malloc(10);
char *g = (char *)malloc(10);
char *h = (char *)malloc(10);
char *i = (char *)malloc(10);

// Print initial memory addresses
printf("Initial allocations:\n");
printf("a: %p\n", (void *)a);
printf("b: %p\n", (void *)b);
printf("c: %p\n", (void *)c);
printf("d: %p\n", (void *)d);
printf("e: %p\n", (void *)e);
printf("f: %p\n", (void *)f);
printf("g: %p\n", (void *)g);
printf("h: %p\n", (void *)h);
printf("i: %p\n", (void *)i);

// Fill tcache
free(a);
free(b);
free(c);
free(d);
free(e);
free(f);
free(g);

// Introduce double-free vulnerability in fast bin
free(h);
free(i);
free(h);


// Reallocate memory and print the addresses
char *a1 = (char *)malloc(10);
char *b1 = (char *)malloc(10);
char *c1 = (char *)malloc(10);
char *d1 = (char *)malloc(10);
char *e1 = (char *)malloc(10);
char *f1 = (char *)malloc(10);
char *g1 = (char *)malloc(10);
char *h1 = (char *)malloc(10);
char *i1 = (char *)malloc(10);
char *i2 = (char *)malloc(10);

// Print initial memory addresses
printf("After reallocations:\n");
printf("a1: %p\n", (void *)a1);
printf("b1: %p\n", (void *)b1);
printf("c1: %p\n", (void *)c1);
printf("d1: %p\n", (void *)d1);
printf("e1: %p\n", (void *)e1);
printf("f1: %p\n", (void *)f1);
printf("g1: %p\n", (void *)g1);
printf("h1: %p\n", (void *)h1);
printf("i1: %p\n", (void *)i1);
printf("i2: %p\n", (void *)i1);

return 0;
}
```
In diesem Beispiel, nachdem der tcache mit mehreren freigegebenen Chunks (7) gef√ºllt wurde, **gibt der Code den Chunk `h` frei, dann den Chunk `i` und dann erneut `h`, was zu einem doppelten Freigabefehler f√ºhrt** (auch bekannt als Fast Bin dup). Dies er√∂ffnet die M√∂glichkeit, √ºberlappende Speicheradressen zu erhalten, wenn neu zugewiesen wird, was bedeutet, dass zwei oder mehr Zeiger auf denselben Speicherort zeigen k√∂nnen. Durch die Manipulation von Daten √ºber einen Zeiger kann dann der andere beeinflusst werden, was ein kritisches Sicherheitsrisiko und ein Potenzial f√ºr Ausnutzung darstellt.

Bei der Ausf√ºhrung f√§llt auf, wie **`i1` und `i2` dieselbe Adresse erhalten**:

<pre><code>Urspr√ºngliche Zuweisungen:
a: 0xaaab0f0c22a0
b: 0xaaab0f0c22c0
c: 0xaaab0f0c22e0
d: 0xaaab0f0c2300
e: 0xaaab0f0c2320
f: 0xaaab0f0c2340
g: 0xaaab0f0c2360
h: 0xaaab0f0c2380
i: 0xaaab0f0c23a0
Nach der Neuzuweisung:
a1: 0xaaab0f0c2360
b1: 0xaaab0f0c2340
c1: 0xaaab0f0c2320
d1: 0xaaab0f0c2300
e1: 0xaaab0f0c22e0
f1: 0xaaab0f0c22c0
g1: 0xaaab0f0c22a0
h1: 0xaaab0f0c2380
<strong>i1: 0xaaab0f0c23a0
</strong><strong>i2: 0xaaab0f0c23a0
</strong></code></pre>

## Beispiele

* [**Dragon Army. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/dragon-army/)
* Wir k√∂nnen nur Fast-Bin-gro√üe Chunks zuweisen, au√üer f√ºr die Gr√∂√üe `0x70`, was das √ºbliche √úberschreiben von `__malloc_hook` verhindert.
* Stattdessen verwenden wir PIE-Adressen, die mit `0x56` beginnen, als Ziel f√ºr Fast Bin dup (1/2 Chance).
* Ein Ort, an dem PIE-Adressen gespeichert sind, ist `main_arena`, die sich in Glibc befindet und in der N√§he von `__malloc_hook` liegt.
* Wir zielen auf einen bestimmten Offset von `main_arena` ab, um dort einen Chunk zuzuweisen, und setzen das Zuteilen von Chunks fort, bis wir `__malloc_hook` erreichen, um Codeausf√ºhrung zu erhalten.
* [**zero_to_hero. PicoCTF**](https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/zero_to_hero/)
* Durch die Verwendung von Tcache-Bins und einem Null-Byte-√úberlauf k√∂nnen wir eine Situation mit doppelter Freigabe erreichen:
* Wir weisen drei Chunks der Gr√∂√üe `0x110` zu (`A`, `B`, `C`)
* Wir geben `B` frei
* Wir geben `A` frei und weisen erneut zu, um den Null-Byte-√úberlauf zu verwenden
* Jetzt hat `B` ein Gr√∂√üenfeld von `0x100` anstelle von `0x111`, sodass wir es erneut freigeben k√∂nnen
* Wir haben einen Tcache-Bin der Gr√∂√üe `0x110` und einen der Gr√∂√üe `0x100`, die auf dieselbe Adresse zeigen. Daher haben wir eine doppelte Freigabe.
* Wir nutzen die doppelte Freigabe mit [Tcache-Vergiftung](tcache-bin-attack.md)

## Referenzen

* [https://heap-exploitation.dhavalkapil.com/attacks/double\_free](https://heap-exploitation.dhavalkapil.com/attacks/double\_free)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
