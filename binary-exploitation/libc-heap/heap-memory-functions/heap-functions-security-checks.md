# Ukaguzi wa Usalama wa Kazi za Heap

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## unlink

Kwa maelezo zaidi angalia:

{% content-ref url="unlink.md" %}
[unlink.md](unlink.md)
{% endcontent-ref %}

Hii ni muhtasari wa ukaguzi uliofanywa:

* Angalia ikiwa ukubwa ulioonyeshwa wa kipande ni sawa na `prev_size` iliyoorodheshwa kwenye kipande kifuatacho
* Ujumbe wa kosa: `corrupted size vs. prev_size`
* Angalia pia kwamba `P->fd->bk == P` na `P->bk->fw == P`
* Ujumbe wa kosa: `corrupted double-linked list`
* Ikiwa kipande si kidogo, angalia kwamba `P->fd_nextsize->bk_nextsize == P` na `P->bk_nextsize->fd_nextsize == P`
* Ujumbe wa kosa: `corrupted double-linked list (siyo kidogo)`

## \_int\_malloc

Kwa maelezo zaidi angalia:

{% content-ref url="malloc-and-sysmalloc.md" %}
[malloc-and-sysmalloc.md](malloc-and-sysmalloc.md)
{% endcontent-ref %}

* **Ukaguzi wakati wa utafutaji wa bakuli la haraka:**
* Ikiwa kipande hakiko sawa:
* Ujumbe wa kosa: `malloc(): unaligned fastbin chunk detected 2`
* Ikiwa kipande kinachofuata hakiko sawa:
* Ujumbe wa kosa: `malloc(): unaligned fastbin chunk detected`
* Ikiwa kipande kilichorudishwa kina ukubwa usio sahihi kwa sababu ya indeksi yake kwenye fast bin:
* Ujumbe wa kosa: `malloc(): memory corruption (fast)`
* Ikiwa kipande chochote kilichotumika kujaza tcache hakiko sawa:
* Ujumbe wa kosa: `malloc(): unaligned fastbin chunk detected 3`
* **Ukaguzi wakati wa utafutaji wa bakuli dogo:**
* Ikiwa `victim->bk->fd != victim`:
* Ujumbe wa kosa: `malloc(): smallbin double linked list corrupted`
* **Ukaguzi wakati wa kujumuisha** uliofanywa kwa kila kipande cha bakuli la haraka:&#x20;
* Ikiwa kipande hakiko sawa:
* Ujumbe wa kosa: `malloc_consolidate(): unaligned fastbin chunk detected`
* Ikiwa kipande kina ukubwa tofauti na ile inavyopaswa kuwa kwa sababu ya indeksi yake:
* Ujumbe wa kosa: `malloc_consolidate(): invalid chunk size`
* Ikiwa kipande kilichotangulia hakitumiwi na kipande kilichotangulia kina ukubwa tofauti na ile iliyoorodheshwa na prev\_chunk:
* Ujumbe wa kosa: `corrupted size vs. prev_size in fastbins`
* **Ukaguzi wakati wa utafutaji wa bakuli lisilojumuishwa**:
* Ikiwa ukubwa wa kipande ni wa ajabu (mdogo sana au mkubwa sana):&#x20;
* Ujumbe wa kosa: `malloc(): invalid size (unsorted)`
* Ikiwa ukubwa wa kipande kinachofuata ni wa ajabu (mdogo sana au mkubwa sana):
* Ujumbe wa kosa: `malloc(): invalid next size (unsorted)`
* Ikiwa ukubwa uliotangulia ulioonyeshwa na kipande kinachofuata unatofautiana na ukubwa wa kipande:
* Ujumbe wa kosa: `malloc(): mismatching next->prev_size (unsorted)`
* Ikiwa si `victim->bck->fd == victim` au si `victim->fd == av (arena)`:
* Ujumbe wa kosa: `malloc(): unsorted double linked list corrupted`
* Kwa kuwa tunachunguza daima ya mwisho, fd yake inapaswa kuwa ikielekeza daima kwa muundo wa uwanja.
* Ikiwa kipande kinachofuata hakionyeshi kuwa kilichotangulia kina matumizi:
* Ujumbe wa kosa: `malloc(): invalid next->prev_inuse (unsorted)`
* Ikiwa `fwd->bk_nextsize->fd_nextsize != fwd`:
* Ujumbe wa kosa: `malloc(): largebin double linked list corrupted (nextsize)`
* Ikiwa `fwd->bk->fd != fwd`:
* Ujumbe wa kosa: `malloc(): largebin double linked list corrupted (bk)`
* **Ukaguzi wakati wa utafutaji wa bakuli kubwa (kwa indeksi)**:
* `bck->fd-> bk != bck`:
* Ujumbe wa kosa: `malloc(): corrupted unsorted chunks`
* **Ukaguzi wakati wa utafutaji wa bakuli kubwa (kwa ukubwa unaofuata)**:
* `bck->fd-> bk != bck`:
* Ujumbe wa kosa: `malloc(): corrupted unsorted chunks2`
* **Ukaguzi wakati wa Matumizi ya Kipande cha Juu:**
* `chunksize(av->top) > av->system_mem`:
* Ujumbe wa kosa: `malloc(): corrupted top size`

## `tcache_get_n`

* **Ukaguzi katika `tcache_get_n`:**
* Ikiwa kipande hakiko sawa:
* Ujumbe wa kosa: `malloc(): unaligned tcache chunk detected`

## `tcache_thread_shutdown`

* **Ukaguzi katika `tcache_thread_shutdown`:**
* Ikiwa kipande hakiko sawa:
* Ujumbe wa kosa: `tcache_thread_shutdown(): unaligned tcache chunk detected`

## `__libc_realloc`

* **Ukaguzi katika `__libc_realloc`:**
* Ikiwa kidole cha zamani hakiko sawa au ukubwa ulikuwa usio sahihi:
* Ujumbe wa kosa: `realloc(): invalid pointer`

## `_int_free`

Kwa maelezo zaidi angalia:

{% content-ref url="free.md" %}
[free.md](free.md)
{% endcontent-ref %}

* **Ukaguzi mwanzoni mwa `_int_free`:**
* Kidole kinafaa:
* Ujumbe wa kosa: `free(): invalid pointer`
* Ukubwa mkubwa kuliko `MINSIZE` na ukubwa pia umefaa:
* Ujumbe wa kosa: `free(): invalid size`
* **Ukaguzi katika `_int_free` tcache:**
* Ikiwa kuna vitu zaidi kuliko `mp_.tcache_count`:
* Ujumbe wa kosa: `free(): too many chunks detected in tcache`
* Ikiwa kuingia hakiko sawa:
* Ujumbe wa kosa: `free(): unaligned chunk detected in tcache 2`
* Ikiwa kipande kilichofutwa tayari kilifutwa na kipo kama kipande katika tcache:
* Ujumbe wa kosa: `free(): double free detected in tcache 2`
* **Ukaguzi katika `_int_free` fast bin:**
* Ikiwa ukubwa wa kipande ni batili (mkubwa sana au mdogo sana):
* Ujumbe wa kosa: `free(): invalid next size (fast)`
* Ikiwa kipande kilichoongezwa kilikuwa tayari juu ya fast bin:
* Ujumbe wa kosa: `double free or corruption (fasttop)`
* Ikiwa ukubwa wa kipande kilicho juu una ukubwa tofauti na kipande tunachoongeza:
* Ujumbe wa kosa: `invalid fastbin entry (free)`
## **`_int_free_merge_chunk`**

* **Uchunguzi katika `_int_free_merge_chunk`:**
* Ikiwa kipande ni kipande cha juu:
* Ujumbe wa kosa: `double free or corruption (top)`
* Ikiwa kipande kinachofuata kipo nje ya mipaka ya uwanja:
* Ujumbe wa kosa: `double free or corruption (out)`
* Ikiwa kipande hakijatajwa kama kimeitwa (katika prev\_inuse kutoka kipande kinachofuata):
* Ujumbe wa kosa: `double free or corruption (!prev)`
* Ikiwa kipande kinachofuata kina ukubwa mdogo sana au mkubwa sana:
* Ujumbe wa kosa: `free(): invalid next size (normal)`
* Ikiwa kipande kilichopita hakijatumika, itajaribu kuunganisha. Lakini, ikiwa `prev_size` inatofautiana na ukubwa ulioonyeshwa katika kipande kilichopita:
* Ujumbe wa kosa: `corrupted size vs. prev_size while consolidating`

## **`_int_free_create_chunk`**

* **Uchunguzi katika `_int_free_create_chunk`:**
* Kuongeza kipande katika benki isiyopangwa, angalia ikiwa `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`:
* Ujumbe wa kosa: `free(): corrupted unsorted chunks`

## `do_check_malloc_state`

* **Uchunguzi katika `do_check_malloc_state`:**
* Ikiwa kipande cha benki ya haraka kilichopangwa vibaya:
* Ujumbe wa kosa: `do_check_malloc_state(): unaligned fastbin chunk detected`

## `malloc_consolidate`

* **Uchunguzi katika `malloc_consolidate`:**
* Ikiwa kipande cha benki ya haraka kilichopangwa vibaya:
* Ujumbe wa kosa: `malloc_consolidate(): unaligned fastbin chunk detected`
* Ikiwa ukubwa wa kipande cha benki ya haraka sio sahihi:
* Ujumbe wa kosa: `malloc_consolidate(): invalid chunk size`

## `_int_realloc`

* **Uchunguzi katika `_int_realloc`:**
* Ukubwa ni mkubwa sana au mdogo sana:
* Ujumbe wa kosa: `realloc(): invalid old size`
* Ukubwa wa kipande kinachofuata ni mkubwa sana au mdogo sana:
* Ujumbe wa kosa: `realloc(): invalid next size`
