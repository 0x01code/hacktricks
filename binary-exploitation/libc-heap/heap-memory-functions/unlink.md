# unlink

{% hint style="success" %}
рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рдЬреАрд╕реАрдкреА рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдЬреАрд╕реАрдкреА рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}

### рдХреЛрдб
```c
// From https://github.com/bminor/glibc/blob/master/malloc/malloc.c

/* Take a chunk off a bin list.  */
static void
unlink_chunk (mstate av, mchunkptr p)
{
if (chunksize (p) != prev_size (next_chunk (p)))
malloc_printerr ("corrupted size vs. prev_size");

mchunkptr fd = p->fd;
mchunkptr bk = p->bk;

if (__builtin_expect (fd->bk != p || bk->fd != p, 0))
malloc_printerr ("corrupted double-linked list");

fd->bk = bk;
bk->fd = fd;
if (!in_smallbin_range (chunksize_nomask (p)) && p->fd_nextsize != NULL)
{
if (p->fd_nextsize->bk_nextsize != p
|| p->bk_nextsize->fd_nextsize != p)
malloc_printerr ("corrupted double-linked list (not small)");

// Added: If the FD is not in the nextsize list
if (fd->fd_nextsize == NULL)
{

if (p->fd_nextsize == p)
fd->fd_nextsize = fd->bk_nextsize = fd;
else
// Link the nexsize list in when removing the new chunk
{
fd->fd_nextsize = p->fd_nextsize;
fd->bk_nextsize = p->bk_nextsize;
p->fd_nextsize->bk_nextsize = fd;
p->bk_nextsize->fd_nextsize = fd;
}
}
else
{
p->fd_nextsize->bk_nextsize = p->bk_nextsize;
p->bk_nextsize->fd_nextsize = p->fd_nextsize;
}
}
}
```
### рдЪрд┐рддреНрд░рд┐рдд рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдЬрд╛рдВрдЪреЗрдВ рдЗрд╕ unlink рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╢рд╛рдирджрд╛рд░ рдЪрд┐рддреНрд░рд┐рдд рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рдХреЛ:

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption><p><a href="https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/implementation/figure/unlink_smallbin_intro.png">https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/implementation/figure/unlink_smallbin_intro.png</a></p></figcaption></figure>

### рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ

* рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдЯреБрдХрдбрд╝реЗ рдХрд╛ рд╕рдВрдХреЗрддрд┐рдд рдЖрдХрд╛рд░ рдЕрдЧрд▓реЗ рдЯреБрдХрдбрд╝реЗ рдореЗрдВ рд╕рдВрдХреЗрддрд┐рдд рдкрд┐рдЫрд▓реЗ рдЖрдХрд╛рд░ рдХреЗ рд╕рдорд╛рди рд╣реИ
* рдпрд╣ рднреА рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ `P->fd->bk == P` рдФрд░ `P->bk->fw == P`
* рдЕрдЧрд░ рдЯреБрдХрдбрд╝рд╛ рдЫреЛрдЯрд╛ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ `P->fd_nextsize->bk_nextsize == P` рдФрд░ `P->bk_nextsize->fd_nextsize == P`

### рд▓реАрдХреНрд╕

рдПрдХ рдЕрдирд▓рд┐рдВрдХ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЯреБрдХрдбрд╝рд╛ рдЖрд╡рдВрдЯрд┐рдд рдкрддреЛрдВ рдХреЛ рд╕рд╛рдл рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдкрд╣реБрдВрдЪ рд╣реЛрдиреЗ рдкрд░ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдкрддреЛрдВ рдХреЛ рд▓реАрдХ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:

Libc рд▓реАрдХ:

* рдпрджрд┐ P рдбрдмрд▓реА рд▓рд┐рдВрдХреНрдб рд╕реВрдЪреА рдХреЗ рд╢реАрд░реНрд╖ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рддреЛ `bk` `libc` рдореЗрдВ `malloc_state` рдХреЛ рдкреЙрдЗрдВрдЯ рдХрд░реЗрдЧрд╛
* рдпрджрд┐ P рдбрдмрд▓реА рд▓рд┐рдВрдХреНрдб рд╕реВрдЪреА рдХреЗ рдЕрдВрдд рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рддреЛ `fd` `libc` рдореЗрдВ `malloc_state` рдХреЛ рдкреЙрдЗрдВрдЯ рдХрд░реЗрдЧрд╛
* рдЬрдм рдбрдмрд▓реА рд▓рд┐рдВрдХреНрдб рд╕реВрдЪреА рдореЗрдВ рдХреЗрд╡рд▓ рдПрдХ рдлреНрд░реА рдЯреБрдХрдбрд╝рд╛ рд╣реЛрддрд╛ рд╣реИ, P рдбрдмрд▓реА рд▓рд┐рдВрдХреНрдб рд╕реВрдЪреА рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рджреЛрдиреЛрдВ `fd` рдФрд░ `bk` `malloc_state` рдХреЗ рдЕрдВрджрд░ рдкрддреЗ рдХреЛ рд▓реАрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд╣реАрдк рд▓реАрдХ:

* рдпрджрд┐ P рдбрдмрд▓реА рд▓рд┐рдВрдХреНрдб рд╕реВрдЪреА рдХреЗ рд╢реАрд░реНрд╖ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рддреЛ `fd` рд╣реАрдк рдореЗрдВ рдПрдХ рдЙрдкрд▓рдмреНрдз рдЯреБрдХрдбрд╝реЗ рдХреЛ рдкреЙрдЗрдВрдЯ рдХрд░реЗрдЧрд╛
* рдпрджрд┐ P рдбрдмрд▓реА рд▓рд┐рдВрдХреНрдб рд╕реВрдЪреА рдХреЗ рдЕрдВрдд рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рддреЛ `bk` рд╣реАрдк рдореЗрдВ рдПрдХ рдЙрдкрд▓рдмреНрдз рдЯреБрдХрдбрд╝реЗ рдХреЛ рдкреЙрдЗрдВрдЯ рдХрд░реЗрдЧрд╛
* рдпрджрд┐ P рдбрдмрд▓реА рд▓рд┐рдВрдХреНрдб рд╕реВрдЪреА рдореЗрдВ рд╣реИ, рддреЛ рджреЛрдиреЛрдВ `fd` рдФрд░ `bk` рд╣реАрдк рдореЗрдВ рдПрдХ рдЙрдкрд▓рдмреНрдз рдЯреБрдХрдбрд╝реЗ рдХреЛ рдкреЙрдЗрдВрдЯ рдХрд░реЗрдВрдЧреЗ
