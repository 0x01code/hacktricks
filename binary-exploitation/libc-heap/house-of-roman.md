# House of Roman

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>

## Grundlegende Informationen

Dies war eine sehr interessante Technik, die RCE ohne Leaks √ºber gef√§lschte Fastbins, den unsorted\_bin-Angriff und relative √úberschreibungen erm√∂glichte. Es wurde jedoch [**gepatcht**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Code

* Ein Beispiel finden Sie unter [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)

### Ziel

* RCE durch Ausnutzung relativer Zeiger

### Anforderungen

* Bearbeiten von Fastbin- und Unsorted-Bin-Zeigern
* 12 Bits Zuf√§lligkeit m√ºssen erraten werden (0,02% Erfolgschance)

## Angriffsschritte

### Teil 1: Fastbin-Chunk zeigt auf \_\_malloc\_hook

Erstellen mehrerer Chunks:

* `fastbin_victim` (0x60, Offset 0): UAF-Chunk, der sp√§ter bearbeitet wird, um den Heap-Zeiger auf den LibC-Wert zu zeigen.
* `chunk2` (0x80, Offset 0x70): F√ºr gute Ausrichtung
* `main_arena_use` (0x80, Offset 0x100)
* `relative_offset_heap` (0x60, Offset 0x190): Relativer Offset auf dem 'main\_arena\_use'-Chunk

Dann `free(main_arena_use)`, was diesen Chunk in die unsortierte Liste platziert und einen Zeiger auf `main_arena + 0x68` sowohl in den `fd`- als auch in den `bk`-Zeigern erh√§lt.

Nun wird ein neuer Chunk `fake_libc_chunk(0x60)` allokiert, da er die Zeiger auf `main_arena + 0x68` in `fd` und `bk` enthalten wird.

Dann werden `relative_offset_heap` und `fastbin_victim` freigegeben.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` hat ein `fd`, das auf `relative_offset_heap` zeigt
* &#x20;`relative_offset_heap` ist ein Offset der Entfernung von `fake_libc_chunk`, der einen Zeiger auf `main_arena + 0x68` enth√§lt
* Durch √Ñndern des letzten Bytes von `fastbin_victim.fd` ist es m√∂glich, dass `fastbin_victim` auf `main_arena + 0x68` zeigt

F√ºr die vorherigen Aktionen muss der Angreifer in der Lage sein, den fd-Zeiger von `fastbin_victim` zu modifizieren.

Dann ist `main_arena + 0x68` nicht so interessant, also √§ndern wir es so, dass der Zeiger auf **`__malloc_hook`** zeigt.

Beachten Sie, dass `__memalign_hook` normalerweise mit `0x7f` und Nullen davor beginnt, dann ist es m√∂glich, es als Wert im `0x70` Fastbin zu f√§lschen. Da die letzten 4 Bits der Adresse **zuf√§llig** sind, gibt es `2^4=16` M√∂glichkeiten f√ºr den Wert, um dorthin zu zeigen, wo wir interessiert sind. Daher wird hier ein BF-Angriff durchgef√ºhrt, damit der Chunk wie folgt endet: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(F√ºr weitere Informationen zu den restlichen Bytes siehe die Erkl√§rung im [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ Beispiel](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)). Wenn der BF nicht funktioniert, st√ºrzt das Programm einfach ab (also starten Sie erneut, bis es funktioniert).

Dann werden 2 mallocs durchgef√ºhrt, um die 2 anf√§nglichen Fastbin-Chunks zu entfernen, und ein dritter wird allokiert, um einen Chunk im **`__malloc_hook:`** zu erhalten.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Teil 2: Unsorted\_bin Angriff

F√ºr weitere Informationen kannst du √ºberpr√ºfen:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Aber im Grunde erlaubt es, `main_arena + 0x68` an jede Stelle zu schreiben, die in `chunk->bk` angegeben ist. Und f√ºr den Angriff w√§hlen wir `__malloc_hook`. Dann, nachdem wir es √ºberschrieben haben, werden wir eine relative √úberschreibung verwenden, um auf ein `one_gadget` zu zeigen.

Daf√ºr beginnen wir damit, einen Chunk zu erhalten und ihn in den **unsorted bin** zu platzieren:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Verwenden Sie einen UAF in diesem Abschnitt, um `unsorted_bin_ptr->bk` auf die Adresse von `__malloc_hook` zu zeigen (wir haben dies zuvor durch Brute-Force ermittelt).

{% hint style="danger" %}
Beachten Sie, dass dieser Angriff den unsortierten Bin besch√§digt (und somit auch den kleinen und gro√üen Bin). Daher k√∂nnen wir jetzt nur **Zuweisungen aus dem Fast Bin verwenden** (ein komplexeres Programm k√∂nnte andere Zuweisungen durchf√ºhren und abst√ºrzen), und um dies auszul√∂sen, m√ºssen wir **die gleiche Gr√∂√üe zuweisen, oder das Programm wird abst√ºrzen.**
{% endhint %}

Um also das Schreiben von `main_arena + 0x68` in `__malloc_hook` auszul√∂sen, f√ºhren wir nach dem Setzen von `__malloc_hook` in `unsorted_bin_ptr->bk` einfach aus: **`malloc(0x80)`**

### Schritt 3: Setzen von \_\_malloc\_hook auf system

Im ersten Schritt kontrollierten wir einen Chunk, der `__malloc_hook` enthielt (in der Variablen `malloc_hook_chunk`) und im zweiten Schritt gelang es uns, `main_arena + 0x68` hier zu schreiben.

Nun nutzen wir eine teilweise √úberschreibung in `malloc_hook_chunk`, um die libc-Adresse, die wir dort geschrieben haben (`main_arena + 0x68`), zu verwenden, um auf eine `one_gadget`-Adresse zu zeigen.

Hier ist es erforderlich, **12 Bits Zuf√§lligkeit zu bruteforcen** (weitere Informationen im [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ Beispiel](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)).

Schlie√ülich, sobald die richtige Adresse √ºberschrieben ist, **rufen Sie `malloc` auf und l√∂sen Sie den `one_gadget` aus**.

## Referenzen

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
