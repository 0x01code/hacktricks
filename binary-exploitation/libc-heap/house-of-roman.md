# Casa de Romanos

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci√≥n B√°sica

Esta fue una t√©cnica muy interesante que permit√≠a la ejecuci√≥n remota de c√≥digo sin fugas a trav√©s de fastbins falsos, el ataque unsorted\_bin y sobrescrituras relativas. Sin embargo, ha sido [**parcheada**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### C√≥digo

* Puedes encontrar un ejemplo en [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)

### Objetivo

* Ejecuci√≥n remota de c√≥digo abusando de punteros relativos

### Requisitos

* Editar punteros fastbin y unsorted bin
* Se deben forzar 12 bits de aleatoriedad (0.02% de probabilidad) para que funcione

## Pasos del Ataque

### Parte 1: El Chunk Fastbin apunta a \_\_malloc\_hook

Crear varios chunks:

* `fastbin_victim` (0x60, offset 0): Chunk UAF para editar m√°s tarde el puntero del heap y que apunte al valor de LibC.
* `chunk2` (0x80, offset 0x70): Para una buena alineaci√≥n
* `main_arena_use` (0x80, offset 0x100)
* `relative_offset_heap` (0x60, offset 0x190): desplazamiento relativo en el chunk 'main\_arena\_use'

Luego `free(main_arena_use)` lo que colocar√° este chunk en la lista desordenada y obtendr√° un puntero a `main_arena + 0x68` en los punteros `fd` y `bk`.

Ahora se asigna un nuevo chunk `fake_libc_chunk(0x60)` porque contendr√° los punteros a `main_arena + 0x68` en `fd` y `bk`.

Luego se liberan `relative_offset_heap` y `fastbin_victim`.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` tiene un `fd` que apunta a `relative_offset_heap`
* &#x20;`relative_offset_heap` es un desplazamiento de distancia desde `fake_libc_chunk`, que contiene un puntero a `main_arena + 0x68`
* Simplemente cambiando el √∫ltimo byte de `fastbin_victim.fd` es posible hacer que `fastbin_victim apunte` a `main_arena + 0x68`

Para las acciones anteriores, el atacante necesita ser capaz de modificar el puntero fd de `fastbin_victim`.

Entonces, `main_arena + 0x68` no es tan interesante, as√≠ que modifiquemos para que el puntero apunte a **`__malloc_hook`**.

Tenga en cuenta que `__memalign_hook` generalmente comienza con `0x7f` y ceros antes de √©l, entonces es posible falsificarlo como un valor en el fast bin `0x70`. Debido a que los √∫ltimos 4 bits de la direcci√≥n son **aleatorios** hay `2^4=16` posibilidades para que el valor termine apuntando donde estamos interesados. Por lo tanto, se realiza un ataque de fuerza bruta aqu√≠ para que el chunk termine as√≠: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Para obtener m√°s informaci√≥n sobre el resto de los bytes, consulte la explicaci√≥n en el [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ejemplo](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)). Si la fuerza bruta no funciona, el programa simplemente se bloquea (as√≠ que comience de nuevo hasta que funcione).

Luego, se realizan 2 mallocs para eliminar los 2 chunks iniciales del fast bin y luego se asigna un tercero para obtener un chunk en el **`__malloc_hook:`**
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Parte 2: Ataque unsorted\_bin

Para obtener m√°s informaci√≥n, puedes consultar:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Pero b√°sicamente permite escribir `main_arena + 0x68` en cualquier ubicaci√≥n especificada en `chunk->bk`. Y para el ataque elegimos `__malloc_hook`. Luego, despu√©s de sobrescribirlo, utilizaremos una sobrescritura relativa para apuntar a un `one_gadget`.

Para esto comenzamos obteniendo un chunk y coloc√°ndolo en el **unsorted bin**:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Utiliza un UAF en este fragmento para apuntar `unsorted_bin_ptr->bk` a la direcci√≥n de `__malloc_hook` (lo hemos forzado previamente).

{% hint style="danger" %}
Ten en cuenta que este ataque corrompe el bin no ordenado (y tambi√©n el peque√±o y el grande). Por lo tanto, ahora solo podemos **utilizar asignaciones del bin r√°pido** (un programa m√°s complejo podr√≠a hacer otras asignaciones y fallar), y para desencadenar esto debemos **asignar el mismo tama√±o o el programa fallar√°.**
{% endhint %}

Entonces, para desencadenar la escritura de `main_arena + 0x68` en `__malloc_hook`, realizamos despu√©s de establecer `__malloc_hook` en `unsorted_bin_ptr->bk` solo necesitamos hacer: **`malloc(0x80)`**

### Paso 3: Establecer \_\_malloc\_hook a system

En el primer paso terminamos controlando un fragmento que contiene `__malloc_hook` (en la variable `malloc_hook_chunk`) y en el segundo paso logramos escribir `main_arena + 0x68` aqu√≠.

Ahora, abusamos de una sobrescritura parcial en `malloc_hook_chunk` para usar la direcci√≥n de libc que escribimos all√≠ (`main_arena + 0x68`) para **apuntar a una direcci√≥n de `one_gadget`**.

Aqu√≠ es donde es necesario **forzar 12 bits de aleatoriedad** (m√°s informaci√≥n en el [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ejemplo](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)).

Finalmente, una vez que se sobrescribe la direcci√≥n correcta, **llama a `malloc` y desencadena el `one_gadget`**.

## Referencias

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
