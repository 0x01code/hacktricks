# Nyumba ya Roman

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Hii ilikuwa mbinu ya kuvutia sana iliyoruhusu RCE bila kuvuja kupitia fastbins bandia, shambulio la unsorted\_bin na kuandika upya kwa kiasi kinachohusiana. Hata hivyo, imefanyiwa [**marekebisho**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Kanuni

* Unaweza kupata mfano katika [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)

### Lengo

* RCE kwa kudanganya pointers zinazohusiana

### Mahitaji

* Hariri pointers za fastbin na unsorted bin
* Lazima ujaribu kufanya nguvu bits 12 za nasibu (0.02% ya nafasi) ya kufanya kazi

## Hatua za Shambulio

### Sehemu 1: Fastbin Chunk inaelekeza kwa \_\_malloc\_hook

Unda vipande kadhaa:

* `fastbin_victim` (0x60, offset 0): Kipande cha UAF baadaye kuhariri pointer ya heap baadaye ili ielekee thamani ya LibC.
* `chunk2` (0x80, offset 0x70): Kwa usawa mzuri
* `main_arena_use` (0x80, offset 0x100)
* `relative_offset_heap` (0x60, offset 0x190): kiasi kinachohusiana kwenye kipande cha 'main\_arena\_use'

Kisha `free(main_arena_use)` ambayo itaweka kipande hiki kwenye orodha isiyopangwa na kupata pointer kwa `main_arena + 0x68` katika pointers za `fd` na `bk`.

Sasa inaundwa kipande kipya `fake_libc_chunk(0x60)` kwa sababu italeta pointers kwa `main_arena + 0x68` katika `fd` na `bk`.

Kisha `relative_offset_heap` na `fastbin_victim` zinaachiliwa.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` ina `fd` inayoelekeza `relative_offset_heap`
* &#x20;`relative_offset_heap` ni mbali na `fake_libc_chunk`, ambayo ina pointer kwa `main_arena + 0x68`
* Kwa kubadilisha herufi ya mwisho ya `fastbin_victim.fd` inawezekana kufanya `fastbin_victim ielekee` kwa `main_arena + 0x68`

Kwa hatua zilizotangulia, mshambuliaji anahitaji kuwa na uwezo wa kubadilisha kidude cha fd cha `fastbin_victim`.

Kisha, `main_arena + 0x68` sio ya kuvutia sana, hivyo turekebishe ili kidude kielekee **`__malloc_hook`**.

Tambua kwamba `__memalign_hook` kawaida huanza na `0x7f` na sifuri kabla yake, hivyo inawezekana kuidanganya kama thamani katika fast bin ya `0x70`. Kwa sababu biti 4 za mwisho za anwani ni **za kubahatisha** kuna `2^4=16` uwezekano wa thamani kuishia kuelekeza mahali tunapopendelea. Hivyo shambulio la BF linatekelezwa hapa ili kidude kiishie kama: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Kwa habari zaidi kuhusu baadhi ya biti zilizobaki tazama maelezo katika [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ mfano](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)). Ikiwa BF haifanyi kazi, programu itaanguka (hivyo anza tena hadi itakapofanya kazi).

Kisha, malloc 2 zinatekelezwa kuondoa vipande 2 vya awali vya fast bin na ya tatu inatengwa ili kupata kidude katika **`__malloc_hook:`**
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Sehemu 2: Shambulio la unsorted\_bin

Kwa maelezo zaidi unaweza kuangalia:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Lakini kimsingi inaruhusu kuandika `main_arena + 0x68` kwa eneo lolote lililowekwa katika `chunk->bk`. Na kwa shambulio tunachagua `__malloc_hook`. Kisha, baada ya kuibadilisha tutatumia ubadilishaji wa kihesabu) kuashiria kwa `one_gadget`.

Kwa hili tunaanza kupata kipande na kukitia katika **unsorted bin**:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Tumia UAF katika sehemu hii ili kuashiria `unsorted_bin_ptr->bk` kwa anwani ya `__malloc_hook` (tulilazimisha hii hapo awali).

{% hint style="danger" %}
Tafadhali kumbuka kuwa shambulio hili linaharibu sanduku lisilo na mpangilio (hivyo ndogo na kubwa pia). Kwa hivyo tunaweza **kutumia vipande kutoka kwa sanduku la haraka sasa** (programu yenye utata zaidi inaweza kufanya vipande vingine na kugonga), na ili kuzindua hii lazima **tufanye alokesheni ya saizi sawa au programu itaanguka.**
{% endhint %}

Kwa hivyo, ili kuzindua kuandika ya `main_arena + 0x68` katika `__malloc_hook` tunafanya baada ya kuweka `__malloc_hook` katika `unsorted_bin_ptr->bk` tunahitaji tu kufanya: **`malloc(0x80)`**

### Hatua 3: Weka \_\_malloc\_hook kuwa mfumo

Katika hatua ya kwanza tulimaliza kudhibiti kipande kinachohusisha `__malloc_hook` (katika kipengele cha `malloc_hook_chunk`) na katika hatua ya pili tulifanikiwa kuandika `main_arena + 0x68` hapa.

Sasa, tunatumia kuandika sehemu katika `malloc_hook_chunk` kutumia anwani ya libc tuliyoiandika hapo (`main_arena + 0x68`) ku **kuashiria anwani ya `one_gadget`**.

Hapa ndipo inapohitajika **kuvunja nguvu 12 bits za nasibu** (maelezo zaidi katika [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ mfano](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)).

Hatimaye, baada ya anwani sahihi kuandikwa, **ita `malloc` na kuzindua `one_gadget`**.

## Marejeo

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
