# House of Roman

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい場合**は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
* **ハッキングテクニックを共有するためにPRを送信して** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリに

</details>

## 基本情報

これは、偽のfastbins、unsorted_bin攻撃、および相対的な上書きを介してリークなしでRCEを可能にする非常に興味深いテクニックでした。ただし、これは[**パッチ済み**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)です。

### コード

* 例は[https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)にあります

### ゴール

* 相対ポインタを悪用してRCEを達成する

### 必要条件

* fastbinとunsorted binのポインタを編集する
* 作業するために12ビットのランダム性をブルートフォースする必要があります（0.02%の確率）

## 攻撃手順

### パート1: Fastbin Chunkが\_\_malloc\_hookを指す

複数のチャンクを作成します:

* `fastbin_victim`（0x60、オフセット0）: 後でヒープポインタを編集してLibCの値を指すようにするUAFチャンク
* `chunk2`（0x80、オフセット0x70）: 良いアライメントのため
* `main_arena_use`（0x80、オフセット0x100）
* `relative_offset_heap`（0x60、オフセット0x190）: 'main\_arena\_use'チャンク上の相対オフセット

次に、`free(main_arena_use)`を実行します。これにより、このチャンクがunsortedリストに配置され、`fd`および`bk`ポインタの両方で`main_arena + 0x68`へのポインタが取得されます。

次に、`fd`および`bk`に`main_arena + 0x68`へのポインタを含む新しいチャンク`fake_libc_chunk(0x60)`が割り当てられます。

その後、`relative_offset_heap`と`fastbin_victim`を解放します。
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim`は`relative_offset_heap`を指す`fd`を持っています。
* &#x20;`relative_offset_heap`は`fake_libc_chunk`からの距離オフセットであり、`main_arena + 0x68`を指すポインタを含んでいます。
* `fastbin_victim.fd`の最後のバイトを変更するだけで、`fastbin_victim`を`main_arena + 0x68`を指すようにすることが可能です。

前述のアクションを行うためには、攻撃者は`fastbin_victim`の`fd`ポインタを変更できる必要があります。

その後、`main_arena + 0x68`はあまり興味深くないので、ポインタが**`__malloc_hook`**を指すように変更します。

`__memalign_hook`は通常`0x7f`で始まり、その前にゼロが続くため、`0x70`のfast binの値として偽装することが可能です。アドレスの最後の4ビットは**ランダム**なので、アドレスの値が興味のある場所を指すようにするためには`2^4=16`の可能性があります。そのため、ここではBF攻撃が実行され、チャンクが次のようになるようにします：**`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`**。

(残りのバイトに関する詳細情報については、[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)の説明を参照してください。BFが機能しない場合、プログラムはクラッシュします（動作するまで繰り返します）。

その後、最初の2つのfast binチャンクを削除するために2つのmallocが実行され、3番目のmallocが実行されて、**`__malloc_hook:`**内のチャンクを取得します。
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### パート2: Unsorted\_bin attack

詳細については、以下をチェックしてください:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

基本的には、`chunk->bk` で指定された場所に `main_arena + 0x68` を書き込むことができます。そして、攻撃では `__malloc_hook` を選択します。それを上書きした後、相対的な上書きを使用して `one_gadget` を指すようにします。

これには、チャンクを取得してそれを **unsorted bin** に入れることから始めます:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
UAFを使用して、`unsorted_bin_ptr->bk`を`__malloc_hook`のアドレスにポイントするようにします（以前にこれをブルートフォースしました）。

{% hint style="danger" %}
この攻撃はunsorted binを破壊します（したがってsmallとlargeも）。そのため、今後は**fast binからの割り当てのみを使用できます**（より複雑なプログラムは他の割り当てを行い、クラッシュする可能性があります）、そしてこれをトリガーするには**同じサイズを割り当てる必要があります。さもないとプログラムはクラッシュします。**
{% endhint %}

したがって、`__malloc_hook`を`unsorted_bin_ptr->bk`に設定した後、`main_arena + 0x68`に書き込むトリガーを発生させるには、単に**`malloc(0x80)`**を実行する必要があります。

### ステップ3: \_\_malloc\_hookをsystemに設定する

ステップ1では、`__malloc_hook`を含むチャンクを制御することができ（変数`malloc_hook_chunk`）、ステップ2では、ここに`main_arena + 0x68`を書き込むことができました。

今、`malloc_hook_chunk`での部分的な上書きを悪用して、そこに書き込んだlibcアドレス（`main_arena + 0x68`）を使用して**`one_gadget`アドレスを指す**ことができます。

ここで、**12ビットのランダム性をブルートフォースする必要がある**（詳細は[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)の[例](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)にあります）。

最後に、正しいアドレスが上書きされたら、**`malloc`を呼び出して`one_gadget`をトリガー**します。

## 参考文献

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのスウォッグ**](https://peass.creator-spring.com)を手に入れる
* 独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションである[**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、自分のハッキングトリックを共有する

</details>
