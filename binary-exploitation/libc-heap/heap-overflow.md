# Prekoraƒçenje hipa

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Prekoraƒçenje hipa je poput [**prekoraƒçenja steka**](../stack-overflow/), ali u hipu. U osnovi to znaƒçi da je neki prostor rezervisan u hipu za ƒçuvanje podataka i **ƒçuvani podaci su bili veƒái od rezervisanog prostora.**

Kod prekoraƒçenja steka znamo da ƒáe neki registri poput pokazivaƒça instrukcija ili okvira steka biti obnovljeni sa steka i moguƒáe je zloupotrebiti to. U sluƒçaju prekoraƒçenja hipa, **nema podataka osetljivih po podrazumevanim postavkama** u hip delu koji mo≈æe biti prekoraƒçen. Meƒëutim, mogu biti osetljivi podaci ili pokazivaƒçi, pa **kritiƒçnost** ove ranjivosti **zavisi** o **kojim podacima mogu biti prepisani** i kako napadaƒç mo≈æe to zloupotrebiti.

{% hint style="success" %}
Da biste prona≈°li ofsete prekoraƒçenja, mo≈æete koristiti iste obrasce kao kod [**prekoraƒçenja steka**](../stack-overflow/#finding-stack-overflows-offsets).
{% endhint %}

### Prekoraƒçenje steka vs prekoraƒçenje hipa

Kod prekoraƒçenja steka, organizacija i podaci koji ƒáe biti prisutni na steku u trenutku kada se ranjivost mo≈æe aktivirati su priliƒçno pouzdani. To je zato ≈°to je stek linearan, uvek se poveƒáava u koliziji memorije, na **specifiƒçnim mestima izvr≈°avanja programa stek memorija obiƒçno ƒçuva sliƒçne vrste podataka** i ima odreƒëenu strukturu sa nekim pokazivaƒçima na kraju dela steka koji se koristi za svaku funkciju.

Meƒëutim, u sluƒçaju prekoraƒçenja hipa, kori≈°ƒáena memorija nije linearna veƒá **dodeljeni blokovi obiƒçno su na odvojenim pozicijama memorije** (ne jedan pored drugog) zbog **kanti i zona** koje razdvajaju alokacije po veliƒçini i zbog toga ≈°to se **prethodno osloboƒëena memorija koristi** pre nego ≈°to se dodeljuju novi blokovi. **Komplikovano je znati koji objekat ƒáe se sudariti sa onim koji je ranjiv** na prekoraƒçenje hipa. Dakle, kada se pronaƒëe prekoraƒçenje hipa, potrebno je pronaƒái **pouzdan naƒçin da se ≈æeljeni objekat naƒëe odmah u memoriji** pored onog koji mo≈æe biti prekoraƒçen.

Jedna od tehnika kori≈°ƒáenih za to je **Gajenje hipa** koje se koristi na primer [**u ovom postu**](https://azeria-labs.com/grooming-the-ios-kernel-heap/). U postu je obja≈°njeno kako kada u iOS kernelu zona ostane bez memorije za ƒçuvanje blokova memorije, pro≈°iruje se za jednu stranicu kernela, a ova stranica se deli na blokove oƒçekivanih veliƒçina koji ƒáe se koristiti redom (do verzije iOS 9.2, zatim se ovi blokovi koriste na nasumiƒçan naƒçin kako bi se ote≈æala eksploatacija ovih napada).

Stoga, u prethodnom postu gde se de≈°ava prekoraƒçenje hipa, kako bi se naterao prekoraƒçeni objekat da se sudari sa ≈ærtvom, nekoliko **`kallocs` je prisiljeno od strane nekoliko niti kako bi se osiguralo da su svi slobodni blokovi popunjeni i da je kreirana nova stranica**.

Da bi se nateralo ovo popunjavanje objektima odreƒëene veliƒçine, **alokacija van linije povezana sa iOS mach portom** je idealan kandidat. Oblikovanjem veliƒçine poruke, moguƒáe je taƒçno odrediti veliƒçinu alokacije `kalloc` i kada odgovarajuƒái mach port bude uni≈°ten, odgovarajuƒáa alokacija ƒáe odmah biti osloboƒëena natrag `kfree`.

Zatim, neki od ovih ƒçuvara mogu biti **osloboƒëeni**. Lista osloboƒëenih **`kalloc.4096`** elemenata oslobaƒëa elemente po principu poslednji unutra-prvi napolje, ≈°to u osnovi znaƒçi da ako su neki ƒçuvari osloboƒëeni i eksploatacija poku≈°a da alocira nekoliko objekata ≈ærtava dok poku≈°ava da alocira objekat ranjiv na prekoraƒçenje, verovatno je da ƒáe ovaj objekat biti praƒáen objektom ≈ærtve.

### Primer libc-a

[**Na ovoj stranici**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) moguƒáe je pronaƒái osnovnu emulaciju prekoraƒçenja hipa koja pokazuje kako prekoraƒçenjem prethodnog bita u upotrebi sledeƒáeg bloka i pozicije prethodne veliƒçine moguƒáe je **konsolidovati kori≈°ƒáeni blok** (praveƒái da misli da nije u upotrebi) i **zatim ga ponovo alocirati** kako bi se prepisali podaci koji se koriste u drugom pokazivaƒçu.

Jo≈° jedan primer [**protostar hip 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) pokazuje vrlo osnovan primer CTF-a gde se **prekoraƒçenje hipa** mo≈æe zloupotrebiti kako bi se pozvala funkcija pobednika i **dobila zastava**.

U [**protostar hip 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) primeru moguƒáe je videti kako zloupotrebom prekoraƒçenja bafera moguƒáe je **prepisati u blizak blok adresu** gde ƒáe **proizvoljni podaci od korisnika** biti upisani.

### Primer ARM64

Na stranici [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) mo≈æete pronaƒái primer prekoraƒçenja hipa gde je komanda koja ƒáe biti izvr≈°ena sme≈°tena u sledeƒáem bloku od prekoraƒçenog bloka. Dakle, moguƒáe je izmeniti izvr≈°enu komandu prekoraƒçenjem jednostavnim eksploatacijama kao ≈°to su:
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### Ostali primeri

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Koristimo ranjivost prelivanja celobrojnog tipa da bismo dobili prelivanje hipa.
* Korumpiramo pokazivaƒçe ka funkciji unutar `struct`-a prelivenog bloka da bismo postavili funkciju poput `system` i dobili izvr≈°enje koda.

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
