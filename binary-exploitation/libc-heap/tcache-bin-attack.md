# Attacco al Bin di Tcache

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Informazioni di Base

Per ulteriori informazioni su cosa sia un bin di Tcache, controlla questa pagina:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Innanzitutto, nota che il Tcache √® stato introdotto nella versione 2.26 di Glibc.

L'**attacco al Tcache** (noto anche come **Tcache poisoning**) proposto nella [**pagina guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) √® molto simile all'attacco al fast bin dove l'obiettivo √® sovrascrivere il puntatore al chunk successivo nel bin all'interno di un chunk liberato con un indirizzo arbitrario in modo da **allocare successivamente quell'indirizzo specifico e sovrascrivere potenzialmente i puntatori**.

Tuttavia, al giorno d'oggi, se esegui il codice menzionato, otterrai l'errore: **`malloc(): unaligned tcache chunk detected`**. Quindi, √® necessario scrivere come indirizzo nel nuovo puntatore un indirizzo allineato (o eseguire abbastanza volte il binario in modo che l'indirizzo scritto sia effettivamente allineato).

### Attacco agli indici di Tcache

Di solito √® possibile trovare all'inizio dell'heap un chunk contenente la **quantit√† di chunk per indice** all'interno del tcache e l'indirizzo al **chunk di testa di ciascun indice di tcache**. Se per qualche motivo √® possibile modificare queste informazioni, sarebbe possibile **far puntare il chunk di testa di alcuni indici a un indirizzo desiderato** (come `__malloc_hook`) per poi allocare un chunk della dimensione dell'indice e sovrascrivere i contenuti di `__malloc_hook` in questo caso.

## Esempi

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Leak di informazioni su Libc**: √à possibile riempire i tcache, aggiungere un chunk nella lista non ordinata, svuotare il tcache e **ri-allocare il chunk dalla lista non ordinata** sovrascrivendo solo i primi 8B, lasciando **intatto il secondo indirizzo a libc dal chunk in modo da poterlo leggere**.
* **Attacco al Tcache**: Il binario √® vulnerabile a un overflow di heap di 1B. Questo sar√† sfruttato per cambiare l'**intestazione di dimensione** di un chunk allocato rendendola pi√π grande. Quindi, questo chunk verr√† **liberato**, aggiungendolo al tcache dei chunk della dimensione falsa. Poi, verr√† allocato un chunk con la dimensione falsificata e il chunk precedente verr√† **restituito sapendo che questo chunk era effettivamente pi√π piccolo** e ci√≤ offre l'opportunit√† di **sovrascrivere il prossimo chunk in memoria**.\
Questo sar√† sfruttato per **sovrascrivere il puntatore FD del prossimo chunk** per puntare a **`malloc_hook`**, quindi sar√† possibile allocare 2 puntatori: prima il puntatore legittimo appena modificato e poi la seconda allocazione restituir√† un chunk in **`malloc_hook`** che √® possibile sfruttare per scrivere un **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Leak di informazioni su Libc**: C'√® un uso dopo la liberazione e una doppia liberazione. In questo writeup l'autore ha fatto trapelare un indirizzo di libc leggendo l'indirizzo di un chunk posizionato in un bin piccolo (come se lo stesse facendo trapelare dal bin non ordinato ma da quello piccolo)
* **Attacco al Tcache**: Viene eseguito un Tcache tramite una **doppia liberazione**. Lo stesso chunk viene liberato due volte, quindi all'interno del Tcache il chunk punter√† a se stesso. Quindi, viene allocato, il suo puntatore FD viene modificato per puntare al **free hook** e quindi viene allocato di nuovo in modo che il prossimo chunk nella lista sar√† nel free hook. Poi, anche questo viene allocato ed √® possibile scrivere l'indirizzo di `system` qui in modo che quando un malloc contenente `"/bin/sh"` viene liberato otteniamo una shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* La principale vulnerabilit√† qui √® la capacit√† di `liberare` qualsiasi indirizzo nell'heap indicandone l'offset
* **Attacco agli indici di Tcache**: √à possibile allocare e liberare un chunk di una dimensione tale che quando viene memorizzato all'interno del chunk tcache (il chunk con le informazioni dei bin di tcache) generer√† un **indirizzo con il valore 0x100**. Questo perch√© il tcache memorizza la quantit√† di chunk su ciascun bin in byte diversi, quindi un chunk in un indice specifico genera il valore 0x100.
* Quindi, questo valore sembra che ci sia un chunk di dimensione 0x100. Consentendo di sfruttarlo liberando questo indirizzo. Questo aggiunger√† quell'indirizzo all'indice dei chunk di dimensione 0x100 nel tcache.
* Quindi, **allocando** un chunk di dimensione **0x100**, l'indirizzo precedente verr√† restituito come un chunk, consentendo di sovrascrivere altri indici di tcache.\
Ad esempio mettendo l'indirizzo di malloc hook in uno di essi e allocando un chunk della dimensione di quell'indice permetter√† di ottenere un chunk in calloc hook, che consente di scrivere un one gadget per ottenere una shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Stessa vulnerabilit√† di prima con una restrizione aggiuntiva
* **Attacco agli indici di Tcache**: Attacco simile al precedente ma con meno passaggi liberando il chunk che contiene le informazioni del tcache in modo che il suo indirizzo venga aggiunto all'indice del tcache della sua dimensione in modo da poter allocare quella dimensione e ottenere le informazioni del chunk tcache come un chunk, consentendo di aggiungere free hook come l'indirizzo di un indice, allocarlo e scrivere un one gadget su di esso.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Write After Free** per aggiungere un numero al puntatore `fd`.
* √à necessario molto **heap feng-shui** in questa sfida. Il writeup mostra come **controllare la testa della lista libera di Tcache** sia molto utile.
* **Leak di Glibc** attraverso `stdout` (FSOP).
* **Tcache poisoning** per ottenere un primitivo di scrittura arbitrario.
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e a** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **su GitHub.**
