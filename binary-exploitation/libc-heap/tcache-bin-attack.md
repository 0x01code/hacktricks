# Tcache Bin Attack

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)を入手する
* **💬Discordグループ**に参加する](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で**フォロー**する 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>

## 基本情報

Tcache binとは何かについての詳細は、このページを参照してください：

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

まず第一に、TcacheはGlibcバージョン2.26で導入されました。

[**guyinatuxidoページ**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html)で提案されている**Tcache攻撃**（または**Tcacheポイズニング**）は、次のチャンク内のbin内の次のチャンクへのポインタを任意のアドレスに上書きして、後でその特定のアドレスを割り当ててポインタを上書きすることが可能になるようにすることを目的としています。

しかし、現在では、上記のコードを実行するとエラーが発生します：**`malloc(): unaligned tcache chunk detected`**。そのため、新しいポインタにアラインされたアドレスを書き込む必要があります（または、実際にアラインされたアドレスに書き込むためにバイナリを十分な回数実行する必要があります）。

### Tcacheインデックス攻撃

通常、ヒープの先頭には、Tcache内の**各インデックスごとのチャンクの数**を含むチャンクと、**各Tcacheインデックスのヘッドチャンクへのアドレス**が含まれています。何らかの理由でこの情報を変更できる場合、**特定のアドレス（例：`__malloc_hook`）を指すようにいくつかのインデックスのヘッドチャンクを作成**することが可能になります。その後、そのインデックスのサイズのチャンクを割り当て、この場合は`__malloc_hook`の内容を上書きすることが可能になります。

## 例

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc情報リーク**：Tcacheを埋め、チャンクをアンソートリストに追加し、Tcacheを空にし、**アンソートされたbinからチャンクを再割り当て**し、最初の8Bだけを上書きして、**チャンクからlibcの2番目のアドレスをそのまま読み取る**ことが可能です。
* **Tcache攻撃**：バイナリには1Bのヒープオーバーフローの脆弱性があります。これを悪用して、割り当てられたチャンクの**サイズヘッダー**を大きく変更します。その後、このチャンクを**解放**し、偽のサイズのチャンクのTcacheに追加します。その後、偽のサイズのチャンクを割り当て、前のチャンクが実際にはより小さいことを知っているため、**次のチャンクをメモリ上で上書きする機会が与えられます**。\
これを悪用して、次のチャンクのFDポインタを**`malloc_hook`**を指すように**上書き**し、その後、2つのポインタを割り当てることが可能になります：まず、変更した正当なポインタ、そして次に、`malloc_hook`にチャンクが返され、**ワンガジェット**を書き込むために悪用できる可能性があります。
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc情報リーク**：使用後に解放され、二重解放されます。この解説では、著者が小さなbinに配置されたチャンクのアドレスを読み取ることで、libcのアドレスを漏洩させました（アンソートされたbinからではなく、小さなbinから漏洩させる方法）。
* **Tcache攻撃**：**二重解放**を介してTcacheが実行されます。同じチャンクが2回解放されるため、Tcache内ではチャンクが自分自身を指すようになります。その後、割り当てられ、そのFDポインタが**free hook**を指すように変更され、再度割り当てられるため、リスト内の次のチャンクはfree hookになります。その後、これも割り当てられ、`system`のアドレスをここに書き込むことが可能になります。そのため、`"/bin/sh"`を含むmallocが解放されるとシェルが取得できます。
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* ここでの主な脆弱性は、オフセットを指定してヒープ内の任意のアドレスを`free`できる能力です。
* **Tcacheインデックス攻撃**：Tcacheチャンク（Tcacheビンの情報を含むチャンク）に格納されるサイズのチャンクを割り当てて解放すると、値が0x100のアドレスが生成されます。これは、Tcacheが各ビンのチャンクの数を異なるバイトで格納しているためです。したがって、特定のインデックスの1つのチャンクが値0x100を生成します。
* その後、この値はサイズ0x100のチャンクがあるかのように見えます。このアドレスを`free`することで、そのアドレスがTcache内のサイズ0x100のチャンクのインデックスに追加されます。
* その後、サイズが**0x100**のチャンクを**割り当て**すると、前のアドレスがチャンクとして返され、他のTcacheインデックスを上書きすることが可能になります。\
たとえば、その中のmallocフックのアドレスを入れ、そのインデックスのサイズのチャンクを割り当てると、callocフックのチャンクが得られ、ワンガジェットを書き込むための機会が得られます。
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* 以前と同じ脆弱性がありますが、1つの追加の制限があります。
* **Tcacheインデックス攻撃**：前の攻撃と似た攻撃ですが、Tcache情報を含むチャンクを**解放**して、そのアドレスがそのサイズのTcacheインデックスに追加されるようにすることで、より少ないステップで攻撃を行います。そのサイズを割り当てて、Tcacheチャンク情報をチャンクとして取得し、その情報を1つのインデックスのアドレスとしてfree hookに追加し、それを割り当てて、その上にワンガジェットを書き込むことが可能になります。
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* `fd`ポインタに数値を追加するための**Write After Free**。
* このチャレンジでは、多くの**heap feng-shui**が必要です。解説では、Tcacheのフリーリストのヘッドを制御することが非常に便利であることが示されています。
* `stdout`（FSOP）を介した**Glibcリーク**。
* **Tcacheポイズニング**を使用して、任意の書き込みプリミティブを取得します。
* **💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)**に参加するか、[**telegram グループ**](https://t.me/peass)**に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **あなたのハッキングテクニックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)**の GitHub リポジトリに PR を提出してください。**
