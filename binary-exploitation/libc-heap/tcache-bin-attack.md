# Attaque de la corbeille Tcache

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Pour plus d'informations sur ce qu'est un bac Tcache, consultez cette page :

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Tout d'abord, notez que le Tcache a √©t√© introduit dans la version 2.26 de Glibc.

L'**attaque Tcache** (√©galement connue sous le nom de **poisoning Tcache**) propos√©e dans la [**page guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) est tr√®s similaire √† l'attaque de bac rapide o√π le but est de remplacer le pointeur vers le prochain morceau dans le bac √† l'int√©rieur d'un morceau lib√©r√© par une adresse arbitraire afin de **allouer plus tard cette adresse sp√©cifique et potentiellement √©craser des pointeurs**.

Cependant, de nos jours, si vous ex√©cutez le code mentionn√©, vous obtiendrez l'erreur : **`malloc(): unaligned tcache chunk detected`**. Il est donc n√©cessaire d'√©crire une adresse align√©e dans le nouveau pointeur (ou d'ex√©cuter suffisamment de fois le binaire pour que l'adresse √©crite soit effectivement align√©e).

### Attaque des index Tcache

Il est g√©n√©ralement possible de trouver au d√©but du tas un morceau contenant la **quantit√© de morceaux par index** √† l'int√©rieur du tcache et l'adresse de la **t√™te du morceau de chaque index tcache**. Si, pour une raison quelconque, il est possible de modifier ces informations, il serait possible de **faire pointer la t√™te du morceau de certains index vers une adresse souhait√©e** (comme `__malloc_hook`) pour ensuite allouer un morceau de la taille de l'index et √©craser le contenu de `__malloc_hook` dans ce cas.

## Exemples

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Fuite d'informations sur Libc** : Il est possible de remplir les tcaches, d'ajouter un morceau dans la liste non tri√©e, de vider le tcache et de **r√©-allouer le morceau de la liste non tri√©e** en ne rempla√ßant que les 8 premiers octets, laissant le **deuxi√®me pointeur d'adresse vers Libc du morceau intact pour que nous puissions le lire**.
* **Attaque Tcache** : Le binaire est vuln√©rable √† un d√©bordement de tas de 1 octet. Cela sera exploit√© pour modifier l'en-t√™te de taille d'un morceau allou√© le rendant plus grand. Ensuite, ce morceau sera **lib√©r√©**, ajout√© au tcache des morceaux de taille falsifi√©e. Ensuite, nous allouerons un morceau avec la taille falsifi√©e, et le morceau pr√©c√©dent sera **retourn√© en sachant que ce morceau √©tait en r√©alit√© plus petit** et cela ouvre la possibilit√© de **√©craser le prochain morceau en m√©moire**.\
Nous allons exploiter cela pour **√©craser le pointeur FD du prochain morceau** pour pointer vers **`malloc_hook`**, puis il est possible d'allouer 2 pointeurs : d'abord le pointeur l√©gitime que nous venons de modifier, puis la deuxi√®me allocation renverra un morceau dans **`malloc_hook`** qu'il est possible d'exploiter pour √©crire un **gadget unique**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Fuite d'informations sur Libc** : Il y a une utilisation apr√®s lib√©ration et une double lib√©ration. Dans ce compte rendu, l'auteur a divulgu√© une adresse de Libc en lisant l'adresse d'un morceau plac√© dans un petit bac (comme en le fuyant du bac non tri√© mais du petit).
* **Attaque Tcache** : Un Tcache est effectu√© via une **double lib√©ration**. Le m√™me morceau est lib√©r√© deux fois, donc √† l'int√©rieur du Tcache, le morceau pointera vers lui-m√™me. Ensuite, il est allou√©, son pointeur FD est modifi√© pour pointer vers le **free hook** puis il est allou√© √† nouveau de sorte que le prochain morceau dans la liste sera dans le free hook. Ensuite, celui-ci est √©galement allou√© et il est possible d'√©crire l'adresse de `system` ici, donc lorsqu'un malloc contenant `"/bin/sh"` est lib√©r√©, nous obtenons un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* La principale vuln√©rabilit√© ici est la capacit√© √† `lib√©rer` n'importe quelle adresse dans le tas en indiquant son d√©calage
* **Attaque des index Tcache** : Il est possible d'allouer et de lib√©rer un morceau d'une taille qui, lorsqu'elle est stock√©e √† l'int√©rieur du morceau tcache (le morceau avec les informations des bacs tcache), g√©n√©rera une **adresse avec la valeur 0x100**. Cela est d√ª au fait que le tcache stocke la quantit√© de morceaux sur chaque bac dans des octets diff√©rents, donc un morceau dans un index sp√©cifique g√©n√®re la valeur 0x100.
* Ensuite, cette valeur ressemble √† un morceau de taille 0x100. Permettant de l'exploiter en le `lib√©rant`. Cela ajoutera cette adresse √† l'index des morceaux de taille 0x100 dans le tcache.
* Ensuite, en **allouant** un morceau de taille **0x100**, l'adresse pr√©c√©dente sera renvoy√©e en tant que morceau, permettant d'√©craser d'autres index tcache.\
Par exemple, en mettant l'adresse de crochet malloc dans l'un d'eux et en allouant un morceau de la taille de cet index, un morceau dans le crochet calloc sera accord√©, ce qui permet d'√©crire un gadget unique pour obtenir un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* M√™me vuln√©rabilit√© qu'auparavant avec une restriction suppl√©mentaire
* **Attaque des index Tcache** : Attaque similaire √† la pr√©c√©dente mais en utilisant moins d'√©tapes en **lib√©rant le morceau contenant les informations du tcache** afin que son adresse soit ajout√©e √† l'index tcache de sa taille, il est donc possible d'allouer cette taille et d'obtenir les informations du morceau tcache en tant que morceau, ce qui permet d'ajouter le crochet free en tant qu'adresse d'un index, de l'allouer et d'√©crire un gadget unique dessus.
* [**Porte math√©matique. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **√âcriture apr√®s lib√©ration** pour ajouter un nombre au pointeur `fd`.
* Beaucoup de **feng-shui de tas** est n√©cessaire dans ce d√©fi. Le compte rendu montre comment **contr√¥ler la t√™te de la liste libre du Tcache** est tr√®s pratique.
* **Fuite Glibc** via `stdout` (FSOP).
* **Empoisonnement Tcache** pour obtenir un primitive d'√©criture arbitraire.
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.
