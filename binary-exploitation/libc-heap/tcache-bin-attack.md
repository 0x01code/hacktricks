# Tcache Bin Aanval

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Basiese Inligting

Vir meer inligting oor wat 'n tcache bin is, sien hierdie bladsy:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Eerstens, let daarop dat die Tcache in glibc weergawe 2.26 ingevoer is.

Die **Tcache** aanval voorgestel in die [**guyinatuxido bladsy**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) is baie soortgelyk aan die vinnige bin aanval waar die doel is om die wyser na die volgende blokkie in die bin binne 'n vrygemaakte blokkie te oorskryf na 'n arbitr√™re adres sodat dit later moontlik is om **daardie spesifieke adres toe te ken en moontlik wysers te oorskryf**.

Tans, as jy die genoemde kode hardloop, sal jy die fout kry: **`malloc(): unaligned tcache chunk detected`**. Dus, dit is nodig om 'n uitgelyste adres in die nuwe wyser 'n uitgelyste adres te skryf (of voer die bin√™re genoeg kere uit sodat die geskrewe adres eintlik uitgelyst is).

### Tcache indeks aanval

Gewoonlik is dit moontlik om aan die begin van die heap 'n blokkie te vind wat die **hoeveelheid blokkies per indeks** binne die tcache bevat en die adres na die **kopblokkie van elke tcache indeks**. As dit om een of ander rede moontlik is om hierdie inligting te wysig, sou dit moontlik wees om **die kopblokkie van 'n sekere indeks na 'n gewenste adres te laat wys** (soos malloc hook) om dan 'n blokkie van die grootte van die indeks toe te ken en die inhoud van malloc hook in hierdie geval te oorskryf.

## Voorbeelde

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc inligting lek**: Dit is moontlik om die tcaches te vul, 'n blokkie by die ongesorteerde lys te voeg, die tcache leeg te maak en die blokkie van die ongesorteerde bin **her toe te ken** deur slegs die eerste 8B te oorskryf, en die **tweede adres na libc van die blokkie ongeskonde te laat sodat ons dit kan lees**.
* **Tcache aanval**: Die bin√™re is kwesbaar vir 'n 1B heap oorvloei. Dit sal misbruik word om die **grootte kop** van 'n toegeken blokkie te verander om dit groter te maak. Dan, sal hierdie blokkie **vrygemaak** word, dit by die tcache van blokkies van die valse grootte voeg. Dan, sal ons 'n blokkie met die vervalste grootte toeken, en die vorige blokkie sal **teruggegee word met die wete dat hierdie blokkie eintlik kleiner was** en dit bied die geleentheid om **die volgende blokkie in die geheue te oorskryf**.\
Ons sal dit misbruik om **die volgende blokkie se FD wyser te oorskryf** om te wys na **`malloc_hook`**, sodat dit dan moontlik is om 2 wysers toe te ken: eerste die regmatige wyser wat ons net gewysig het, en dan sal die tweede toekenning 'n blokkie in **`malloc_hook`** teruggee wat misbruik kan word om 'n **een gadget** te skryf.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc inligting lek**: Daar is 'n gebruik na vry en 'n dubbele vry. In hierdie verduideliking het die skrywer 'n adres van libc gelek deur die adres van 'n blokkie wat in 'n klein bin geplaas is te lees (soos om dit van die ongesorteerde bin te lek, maar van die klein een)
* **Tcache aanval**: 'n Tcache word uitgevoer deur 'n **dubbele vry**. Dieselfde blokkie word twee keer vrygemaak, sodat binne die Tcache die blokkie na homself sal wys. Dan, word dit toegeken, sy FD wyser word gewysig om te wys na die **vry hook** en dan word dit weer toegeken sodat die volgende blokkie in die lys in die vry hook sal wees. Dan, word dit ook toegeken en dit is moontlik om die adres van `system` hier te skryf sodat wanneer 'n malloc wat `"/bin/sh"` bevat vrygemaak word, kry ons 'n skul.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* Die hoof kwesbaarheid hier is die vermo√´ om enige adres in die heap te `vry` deur sy offset aan te dui
* **Tcache indeks aanval**: Dit is moontlik om 'n blokkie toe te ken en vry te stel van 'n grootte wat wanneer dit binne die tcache blokkie gestoor word (die blokkie met die inligting van die tcache bins) 'n adres met die waarde 0x100 sal genereer. Dit is omdat die tcache die hoeveelheid blokkies in elke bin in verskillende bytes stoor, daarom genereer een blokkie in een spesifieke indeks die waarde 0x100.
* Dan lyk hierdie waarde asof daar 'n blokkie van grootte 0x100 is. Dit maak dit moontlik om dit te misbruik deur hierdie adres te `vry`. Dit sal **daardie adres by die indeks van blokkies van grootte 0x100 in die tcache voeg**.
* Dan, deur 'n blokkie van grootte **0x100 toe te ken**, sal die vorige adres as 'n blokkie teruggegee word, wat dit moontlik maak om ander tcache indekse te oorskryf.\
Byvoorbeeld om die adres van malloc hook in een van hulle te plaas en 'n blokkie van die grootte van daardie indeks toe te ken, sal 'n blokkie in calloc hook gee, wat dit moontlik maak om 'n een gadget te skryf om 'n s skul te kry.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Dieselfde kwesbaarheid as voorheen met een ekstra beperking
* **Tcache indeks aanval**: Soortgelyke aanval as die vorige een maar met minder stappe deur **die blokkie wat die tcache inligting bevat vry te stel** sodat sy adres by die tcache indeks van sy grootte gevoeg word sodat dit moontlik is om daardie grootte toe te ken en die tcache blokkie inligting as 'n blokkie te kry, wat dit moontlik maak om die vry hook as die adres van een indeks toe te voeg, dit toe te ken, en 'n een gadget daarop te skryf.

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
