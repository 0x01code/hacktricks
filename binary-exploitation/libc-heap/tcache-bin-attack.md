# Shambulio la Tcache Bin

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Kwa habari zaidi kuhusu ni nini Tcache bin angalia ukurasa huu:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Kwanza kabisa, kumbuka kuwa Tcache ilitambulishwa katika toleo la Glibc 2.26.

**Shambulio la Tcache** (pia inajulikana kama **Tcache poisoning**) lililopendekezwa katika [**ukurasa wa guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) ni sawa sana na shambulio la fast bin ambapo lengo ni kubadilisha pointer kwa kipande kinachofuata kwenye bin ndani ya kipande kilichofutwa kwa anwani isiyojulikana ili baadaye iwezekane **kuweka anwani hiyo maalum na labda kubadilisha pointi**.

Hata hivyo, siku hizi, ukikimbia nambari iliyotajwa utapata kosa: **`malloc(): unaligned tcache chunk detected`**. Kwa hivyo, ni muhimu kuandika anwani iliyolingana katika pointer mpya (au kutekeleza mara za kutosha nambari ili anwani iliyoandikwa iwe kweli imeambatanishwa).

### Shambulio la vitambulisho vya Tcache

Kawaida inawezekana kupata mwanzoni mwa rundo kipande kinachohifadhi **idadi ya vipande kwa kila kitambulisho** ndani ya tcache na anwani ya **kipande cha kichwa cha kila kitambulisho cha tcache**. Ikiwa kwa sababu fulani inawezekana kubadilisha habari hii, ingewezekana **kuweka kipande cha kichwa cha kitambulisho fulani kiashiria anwani inayotakiwa** (kama vile `__malloc_hook`) kisha kuweka kipande cha ukubwa wa kitambulisho na kubadilisha maudhui ya `__malloc_hook` katika kesi hii.

## Mifano

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Uvuvi wa habari za Libc**: Inawezekana kujaza tcaches, kuongeza kipande kwenye orodha isiyopangwa, kufuta tcache na **kuweka upya kipande kutoka kwenye rundo lisilopangwa** ikibadilisha tu 8B za kwanza, ikiiacha **anwani ya pili ya libc kutoka kwa kipande ikiwa bado tunaweza kuisoma**.
* **Shambulio la Tcache**: Programu ina mapungufu ya 1B ya kumwaga rundo. Hii itatumika kubadilisha **kichwa cha ukubwa** wa kipande kilichoombwa kufanya iwe kubwa zaidi. Kisha, kipande hiki kitafutwa, kikiwekwa kwenye tcache ya vipande vya ukubwa wa bandia. Kisha, tutapata kipande na ukubwa wa bandia, na kipande kilichopita kitajulikana kuwa **kidogo kweli** na hii itatoa fursa ya **kubadilisha kipande kinachofuata kwenye kumbukumbu**.\
Tutatumia hii kudukua **kubadilisha pointer ya FD ya kipande kinachofuata** ili iashirie **`malloc_hook`**, kisha niwezekane kuweka alama 2: kwanza pointer halali tuliyobadilisha, na kisha alokesheni ya pili itarudisha kipande kwa **`malloc_hook`** ambayo inawezekana kudukua kuandika **gadget moja**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Uvuvi wa habari za Libc**: Kuna matumizi baada ya kufuta na kufuta mara mbili. Katika mwongozo huu mwandishi alifichua anwani ya libc kwa kusoma anwani ya kipande kilichowekwa kwenye rundo dogo (kama kuvuja kutoka kwa rundo lisilopangwa lakini kutoka kwa rundo dogo)
* **Shambulio la Tcache**: Tcache inafanywa kupitia **kufuta mara mbili**. Kipande kimoja kinafutwa mara mbili, kwa hivyo ndani ya Tcache kipande kitaiashiria yenyewe. Kisha, kinaombwa, pointer yake ya FD inabadilishwa ili iashirie **kukata kwa bure** na kisha kinaombwa tena ili kipande kinachofuata kwenye orodha iwe kwenye kukata kwa bure. Kisha, hii pia inaombwa na inawezekana kuandika anwani ya `system` hapa ili wakati malloc inayotia ndani `"/bin/sh"` inafutwa tunapata kabati.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* Udhaifu kuu hapa ni uwezo wa `kufuta` anwani yoyote kwenye rundo kwa kuonyesha kisanduku chake
* **Shambulio la vitambulisho vya Tcache**: Inawezekana kuomba na kufuta kipande cha ukubwa ambao unapohifadhiwa ndani ya kipande cha tcache (kipande chenye habari za vikasha vya tcache) itazalisha **anwani yenye thamani ya 0x100**. Hii ni kwa sababu tcache inahifadhi idadi ya vipande kwa kila kikasha katika baiti tofauti, kwa hivyo kipande kimoja katika kikasha maalum kinazalisha thamani ya 0x100.
* Kisha, thamani hii inaonekana kama kuna kipande cha ukubwa wa 0x100. Kuruhusu kudukua kwa `kufuta` anwani hii. Hii itaongeza anwani hiyo kwenye kikasha cha vipande vya ukubwa wa 0x100 katika tcache.
* Kisha, **kuomba** kipande cha ukubwa wa **0x100**, anwani ya awali itarudishwa kama kipande, kuruhusu kudukua vitambulisho vingine vya tcache.\
Kwa mfano kuweka anwani ya kitanzi cha malloc katika moja yao na kuomba kipande cha ukubwa wa kikasha hicho kutatoa kipande katika kitanzi cha calloc, ambacho kinaruhusu kuandika kifaa kimoja kupata kabati.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Udhaifu sawa na hapo awali na kizuizi kimoja zaidi
* **Shambulio la vitambulisho vya Tcache**: Shambulio sawa na lile lililopita lakini kwa kutumia hatua chache kwa **kufuta kipande kinachohifadhi habari za tcache** ili anwani yake iongezwe kwenye kikasha cha tcache cha ukubwa wake ili iwezekane kuomba ukubwa huo na kupata habari za kipande cha tcache kama kipande, ambacho kuruhusu kuongeza kitanzi cha bure kama anwani ya kikasha kimoja, kuialokesheni, na kuandika kifaa kimoja juu yake.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Andika Baada ya Kufuta** ili kuongeza nambari kwa pointer ya `fd`.
* Kuna **heap feng-shui** nyingi inahitajika katika changamoto hii. Mwongozo unaonyesha jinsi **kudhibiti kichwa cha orodha ya bure ya Tcache** ni muhimu sana.
* **Kuvuja kwa Glibc** kupitia `stdout` (FSOP).
* **Tcache poisoning** kupata msingi wa kuandika wa kiholela.
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.
