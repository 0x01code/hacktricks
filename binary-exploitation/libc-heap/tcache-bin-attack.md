# Tcache Bin Saldırısı

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahramana kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'ı takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'ler göndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Temel Bilgiler

Tcache bin nedir hakkında daha fazla bilgi için bu sayfaya bakın:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

İlk olarak, Tcache'in Glibc sürümü 2.26'da tanıtıldığını unutmayın.

**Tcache saldırısı** (aynı zamanda **Tcache zehirlenmesi** olarak da bilinir) [**guyinatuxido sayfasında**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) önerilen, hedefin bir serbest bölüm içindeki bir bindeki bir sonraki parça işaretçisini istenilen bir adrese üzerine yazmak olduğu hızlı bin saldırısına çok benzerdir, böylece daha sonra **belirli bir adrese bu işaretçiyi ayırmak ve potansiyel olarak işaretçileri üzerine yazmak mümkün olur**.

Ancak, günümüzde, bahsedilen kodu çalıştırırsanız hata alırsınız: **`malloc(): hizalanmamış tcache parçası tespit edildi`**. Bu nedenle, yeni işaretçiye hizalanmış bir adres yazmak gereklidir (veya yazılan adresin gerçekten hizalandığından emin olmak için yeterince kez ikili dosyayı çalıştırmak gereklidir).

### Tcache indeks saldırıları

Genellikle, heap'in başlangıcında, tcache içindeki **her indeksteki parça miktarını** ve **her tcache indeksinin baş parça adresini** içeren bir parça bulunabilir. Bu bilgiyi bir şekilde değiştirmek mümkün olursa, **bazı indekslerin baş parçasını istenilen bir adrese işaret edecek şekilde yapmak mümkün olur** (`__malloc_hook` gibi) ve daha sonra bu durumda `__malloc_hook` içeriğini üzerine yazmak mümkün olur.

## Örnekler

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc bilgi sızıntısı**: Tcache'leri doldurmak, bir parçayı sıralanmamış listeye eklemek, tcache'yi boşaltmak ve ardından sadece ilk 8B'yi üzerine yazarak sıralanmamış bölümden parçayı **yeniden tahsis etmek** mümkündür, **ikinci adresi parçadan libc'ye okuyabiliriz**.
* **Tcache saldırısı**: İkinci bir 1B heap taşması olan bir ikili dosya zafiyetlidir. Bu, ayrılmış bir parçanın **boyut başlığını** değiştirmek için kötüye kullanılacaktır. Daha sonra, bu parça **serbest bırakılacak**, sahte boyuttaki parçaların tcache'ine eklenir. Ardından, sahte boyutta bir parça tahsis edilecek ve önceki parça **gerçekte daha küçük olduğu bilinerek geri dönecektir ve bu, bellekteki bir sonraki parçayı üzerine yazma fırsatı verir**.\
Bu, **bir sonraki parçanın FD işaretçisini üzerine yazmak** için kötüye kullanılacaktır, böylece değiştirilen ilk meşru işaretçiyi ve ardından ikinci tahsisin **`malloc_hook`'a** döneceği bir parça alınacaktır ve bu, **bir gadget yazmak için kötüye kullanılabilir**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc bilgi sızıntısı**: Bir kullanım sonrası serbest bırakma ve çift serbest bırakma vardır. Bu yazıda yazar, küçük bir bine yerleştirilen bir parçanın adresini okuyarak libc'nin bir adresini sızdırdı.
* **Tcache saldırısı**: Bir **çift serbest bırakma** aracılığıyla bir Tcache gerçekleştirilir. Aynı parça iki kez serbest bırakılır, bu nedenle Tcache içinde parça kendisine işaret eder. Ardından, tahsis edilir, FD işaretçisi **free hook'a** işaret etmek üzere değiştirilir ve ardından tekrar tahsis edilir, böylece listedeki bir sonraki parça free hook'ta olacaktır. Ardından, bu da tahsis edilir ve `system` adresi buraya yazılabilir, böylece `"/bin/sh"` içeren bir malloc serbest bırakıldığında bir kabuk alınabilir.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* Buradaki ana zafiyet, heap'te herhangi bir adresi `free` etme kapasitesidir ve bunu belirtmek için ofsetini göstermektir.
* **Tcache indeks saldırıları**: Tcache parçasının içinde depolanan bir boyutta bir parça tahsis edip serbest bırakmak, farklı baytlarda her bir bindeki parça miktarını depoladığı için **değeri 0x100 olan bir adres oluşturacaktır**. Bu, tcache'nin her bir indeksindeki 0x100 boyutundaki parçaların bir parça oluşturmasına neden olur.
* Ardından, bu değer 0x100 boyutunda bir parça olduğu gibi görünür. Bu adresi `free` ile kötüye kullanmaya izin verecektir. Bu, o adresin tcache içindeki 0x100 boyutundaki parçaların indeksine **eklenecektir**.
* Ardından, boyutu **0x100** olan bir parça **tahsis edilir**, önceki adres bir parça olarak geri dönecek ve diğer tcache indekslerini üzerine yazmaya izin verecektir.\
Örneğin, malloc hook adresini birine koyarak ve o indeksin boyutunda bir parça tahsis ederek calloc hook'ta bir parça alınabilir, bu da bir gadget yazmak için bir fırsat sağlar.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Bir öncekiyle aynı zafiyet, bir ek kısıtlama ile
* **Tcache indeks saldırıları**: Önceki saldırıya benzer saldırı ancak **tcache bilgilerini içeren parçayı serbest bırakarak** daha az adımla gerçekleştirilir, bu nedenle adresi, boyutuna göre tcache indeksine eklenir ve bu nedenle o boyutta tahsis edilebilir ve tcache parça bilgilerini bir parça olarak almak mümkün olur, bu da bir indeksin adresini free hook olarak eklemeyi, tahsis etmeyi ve üzerine bir gadget yazmayı mümkün kılar.
* [**Matematik Kapısı. HTB Siber Kıyamet CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* `fd` işaretçisine bir sayı eklemek için **Serbest Bırakmadan Sonra Yazma**.
* Bu zorlukta birçok **heap feng-shui** gereklidir. Yazı, **Tcache serbest listesinin başını kontrol etmenin oldukça kullanışlı olduğunu** göstermektedir.
* `stdout` üzerinden **Glibc sızıntısı** (FSOP).
* **Tcache zehirlenmesi** ile keyfi yazma yetkisi elde etmek.
* **💬 [**Discord grubuna** katılın](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı göndererek PR'ler oluşturarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına paylaşın.**
