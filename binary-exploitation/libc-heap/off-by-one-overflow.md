# Kujaza kwa kosa la moja

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Kwa kupata ufikiaji tu wa kujaza 1B, mshambuliaji anaweza kuhariri biti ya `pre_in_use` kutoka kwa kipande kinachofuata na kwa kuwa kipande cha sasa hakitatumika, mwisho wa kipande unakuwa habari ya metadata ya ukubwa wa kipande kilichopita.\
Hii inaruhusu kuhariri ni vipande vipi vilivyofutwa kweli, ikisababisha uwezekano wa kuzalisha kipande kinachojumuisha kipande kingine halali.

Kuna aina 2 za udhaifu wa kujaza kwa kosa la moja:

* Bayti isiyo na kikomo: Aina hii inaruhusu kubadilisha bayti hiyo na thamani yoyote
* Null off by one: Aina hii inaruhusu kubadilisha bayti hiyo tu na 0x00
* Mfano wa kawaida wa udhaifu huu unaweza kuonekana katika nambari ifuatayo ambapo tabia ya strlen na strcpy ni tofauti, ambayo inaruhusu kuweka bayti ya 0x00 mwanzoni mwa kipande kinachofuata.

<details>

<summary>Null off by one</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

Miongoni mwa ukaguzi mwingine, sasa wakati kipande kinaachiliwa, ukubwa wa awali unalinganishwa na ukubwa ulioconfigure katika kipande cha metadata, hii inafanya shambulio hili kuwa ngumu kutoka kwa toleo la 2.28.

### Mfano wa Kanuni:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Shambulio hili halifanyi kazi tena kutokana na matumizi ya Tcaches.
* Zaidi ya hayo, ukijaribu kulitumia kwa kutumia vipande vikubwa (hivyo tcaches havihusiki), utapata kosa: `malloc(): invalid next size (unsorted)`

### Lengo

* Kufanya kipande kiwe kimejumuishwa ndani ya kipande kingine ili upatikanaji wa kuandika juu ya kipande cha pili kuruhusu kubadilisha kile kilichomo

### Mahitaji

* Kuvuja kwa kipande kimoja ili kurekebisha habari ya metadata ya ukubwa wa awali

### Shambulio

* Vipande 3 vya kumbukumbu (a, b, c) vinahifadhiwa mfululizo. Kisha kipande cha katikati kinachiliwa. Cha kwanza kina kasoro ya kuvuja kwa kipande kimoja na muhusika anaitumia na 0x00 (ikiwa byte ya awali ilikuwa 0x10 itafanya kipande cha katikati kiashiria kuwa ni kubwa kwa 0x10 kuliko ilivyo kweli).
* Kisha, vipande vidogo 2 zaidi vinatengwa katika kipande kilichotiwa huru katikati (b), hata hivyo, kwa sababu `b + b->size` kamwe haifanyi c chunk kwa sababu anwani iliyolengwa ni ndogo kuliko inavyopaswa.&#x20;
* Kisha, b1 na c vinatiwa huru. Kwa sababu `c - c->prev_size` bado inaelekeza kwa b (sasa b1), vyote viunganyishwa katika kipande kimoja. Hata hivyo, b2 bado iko ndani kati ya b1 na c.
* Hatimaye, malloc mpya inafanywa kurudisha eneo hili la kumbukumbu ambalo kimsingi litakuwa na b2, kuruhusu mmiliki wa malloc mpya kudhibiti maudhui ya b2.

Picha hii inaelezea shambulio kikamilifu:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## Mifano Mingine & Marejeo

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* Inawezekana kutumia kuvuja kwa kipande kimoja kuvuja anwani kutoka kwa kumbukumbu kwa sababu byte 0x00 mwishoni mwa string inaandikwa upya na uga ufuatao.
* Kuandika kiholela inapatikana kwa kutumia kuvuja kwa kipande kimoja ili kufanya pointer ielekee mahali pengine ambapo muundo bandia na pointa bandia zitajengwa. Kisha, ni rahisi kufuata pointer wa muundo huu ili kupata andika kiholela.
* Anwani ya libc inavuja kwa sababu ikiwa kumbukumbu inaongezwa kwa kutumia mmap, kumbukumbu iliyotengwa na mmap ina mbadala wa kudumu kutoka kwa libc.
* Hatimaye andika kiholela kinatumika kuandika kwenye anwani ya \_\_free\_hook na one gadget.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* Kuna kuvuja kwa kipande kimoja cha NULL katika kazi ya `getline` inayosoma mistari ya mwingiliano wa mtumiaji. Kazi hii hutumiwa kusoma "funguo" ya maudhui na sio maudhui.
* Katika mwongozo wa 5 wa awali vipande vinavyoanzishwa ni:
* kipande1 (0x200)
* kipande2  (0x50)
* kipande5 (0x68)
* kipande3 (0x1f8)
* kipande4 (0xf0)
* ulinzi wa kipande (0x400) ili kuepuka kuunganishwa na kipande cha juu
* Kisha kipande 1, 5 na 3 vinatiwa huru, hivyo:
* ```python
[ 0x200 Kipande 1 (huru) ] [ 0x50 Kipande 2 ] [ 0x68 Kipande 5 (huru) ] [ 0x1f8 Kipande 3 (huru) ] [ 0xf0 Kipande 4 ] [ 0x400 Kipande la ulinzi ]
```
* Kisha kwa kutumia kipande3 (0x1f8) kuvuja kwa kipande kimoja cha NULL kunatumika kuandika prev\_size kuwa `0x4e0`.
* Angalia jinsi vipande vilivyotengwa awali vya kipande1, 2, 5 na 3 pamoja na vichwa vya 4 vya vipande hivyo vinavyolingana na `0x4e0`:  `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* Kisha, kipande 4 kinatiwa huru, kuzalisha kipande kinachotumia vipande vyote hadi mwanzo:
* ```python
[ 0x4e0 Kipande 1-2-5-3 (huru) ] [ 0xf0 Kipande 4 (haribika) ] [ 0x400 Kipande la ulinzi ]
```
* ```python
[ 0x200 Kipande 1 (huru) ] [ 0x50 Kipande 2 ] [ 0x68 Kipande 5 (huru) ] [ 0x1f8 Kipande 3 (huru) ] [ 0xf0 Kipande 4 ] [ 0x400 Kipande la ulinzi ]
```
* Kisha, `0x200` byte zinatengwa kujaza kipande cha awali 1
* Na byte nyingine 0x200 zinatengwa na kipande2 kuharibiwa na hivyo hakuna kuvuja na hii haifanyi kazi? Labda hii haipaswi kufanywa
* Kisha, inatenga kipande kingine na "a" 0x58 (ikiandika juu ya kipande2 na kufikia kipande5) na kurekebisha `fd` ya kipande cha fast bin cha kipande5 ikielekeza kwa `__malloc_hook`
* Kisha, kipande cha 0x68 kinatengwa hivyo kipande bandia cha fast bin katika `__malloc_hook` ni kipande cha fast bin kinachofuata
* Hatimaye, kipande kipya cha fast bin cha 0x68 kinatengwa na `__malloc_hook` inaandikwa upya na anwani ya `one_gadget`

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
