# Nyumba ya Orange

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya HackTricks AWS)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Taarifa Msingi

### Kanuni

* Pata mfano katika [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Mbinu ya kudukua ilisahihishwa katika [patch hii](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) hivyo haitafanyi kazi tena (ilifanya kazi katika toleo la chini ya 2.26)
* Mfano sawa **na maoni zaidi** katika [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Lengo

* Tumia kazi ya `malloc_printerr`

### Mahitaji

* Badilisha ukubwa wa kipande cha juu
* Leaks za Libc na heap

### Msingi

Baadhi ya msingi muhimu kutoka kwa maoni kutoka [**mfano huu**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

Jambo ni kwamba, katika toleo za zamani za libc, wakati kazi ya `malloc_printerr` ilipoitwa inge **pitia orodha ya miundo ya `_IO_FILE` iliyohifadhiwa katika `_IO_list_all`**, na kimsingi **kutekeleza** kipande cha maagizo katika miundo hiyo.\
Shambulio hili litatengeneza **miundo bandia ya `_IO_FILE`** ambayo tutaiandika kwa **`_IO_list_all`**, na kusababisha `malloc_printerr` kufanya kazi.\
Kisha itatekeleza anwani yoyote ile tunayohifadhi katika miundo ya **`_IO_FILE`**, na tutapata utekelezaji wa nambari

### Shambulio

Shambulio linaanza kwa kufanikiwa kupata **kipande cha juu** ndani ya **bin isiyo taswira**. Hii inafanikiwa kwa kuita `malloc` na ukubwa mkubwa kuliko ukubwa wa kipande cha juu cha sasa lakini mdogo kuliko **`mmp_.mmap_threshold`** (kawaida ni 128K), ambayo vinginevyo ingesababisha kutengwa kwa `mmap`. Mara tu ukubwa wa kipande cha juu unapobadilishwa, ni muhimu kuhakikisha kwamba **kipande cha juu + ukubwa wake** kinafaa kwenye ukurasa na kwamba biti ya **prev\_inuse** ya kipande cha juu daima imewekwa.

Ili kupata kipande cha juu ndani ya bin isiyo taswira, tenganisha kipande ili kuunda kipande cha juu, badilisha ukubwa wa kipande cha juu (kwa kujaa katika kipande kilichotengwa) ili **kipande cha juu + ukubwa** uwe kwenye ukurasa na biti ya **prev\_inuse** iwe imewekwa. Kisha tengeneza kipande kikubwa kuliko ukubwa mpya wa kipande cha juu. Kumbuka kwamba `free` kamwe haiitwi ili kupata kipande cha juu ndani ya bin isiyo taswira.

Kipande cha juu cha zamani sasa iko katika bin isiyo taswira. Kukadiria tunaweza kusoma data ndani yake (labda kutokana na udhaifu uliosababisha pia kujaa), inawezekana kuvuja anwani za libc kutoka humo na kupata anwani ya **\_IO\_list\_all**.

Shambulio la bin isiyo taswira linafanywa kwa kudhuru kujaa ili kuandika `topChunk->bk->fwd = _IO_list_all - 0x10`. Wakati kipande kipya kinapojitengwa, kipande cha juu cha zamani kitagawanywa, na kidokezo kwenye bin isiyo taswira kitandikwa kwenye **`_IO_list_all`**.

Hatua inayofuata ni kupunguza ukubwa wa kipande cha juu cha zamani ili kufanana na kibanda kidogo, hasa kuweka ukubwa wake kuwa **0x61**. Hii inahudumia madhumuni mawili:

1. **Kuingizwa kwenye Bin Ndogo 4**: Wakati `malloc` inapitia bin isiyo taswira na kuona kipande hiki, itajaribu kuweka kwenye bin ndogo 4 kutokana na ukubwa wake mdogo. Hii inafanya kipande kumalizia kichwa cha orodha ya bin ndogo 4 ambayo ni mahali pa kidokezo cha FD ya kipande cha **`_IO_list_all`** kama tulivyoandika anwani karibu katika **`_IO_list_all`** kupitia shambulio la bin isiyo taswira.
2. **Kuzindua Ukaguzi wa Malloc**: Udhibiti wa ukubwa wa kipande hiki utasababisha `malloc` kufanya ukaguzi wa ndani. Wakati inakagua ukubwa wa kipande kinachofuata kwa uwongo, ambacho kitakuwa sifuri, inasababisha kosa na kuita `malloc_printerr`.

Udhibiti wa bin ndogo utakuruhusu kudhibiti kidokezo cha mbele cha kipande. Kufunika na **\_IO\_list\_all** hutumiwa kutengeneza miundo bandia ya **\_IO\_FILE**. Miundo hiyo imeundwa kwa uangalifu kujumuisha uga muhimu kama vile `_IO_write_base` na `_IO_write_ptr` zilizowekwa kwenye thamani ambazo zinapita ukaguzi wa ndani katika libc. Aidha, jedwali la kuruka linajengwa ndani ya miundo bandia, ambapo kidokezo cha maagizo kinawekwa kwenye anwani ambapo nambari za aina yoyote zinaweza kutekelezwa (k.m., kazi ya `system`).

Kufupisha sehemu iliyobaki ya mbinu:

* **Punguza Kipande cha Juu cha Zamani**: Badilisha ukubwa wa kipande cha juu cha zamani kuwa **0x61** ili kukifanya kifae kwenye bin ndogo.
* **Sanidi Miundo Bandia ya `_IO_FILE`**: Funika kipande cha juu cha zamani na miundo bandia ya **\_IO\_FILE** na weka uga kwa uangalifu kudhibiti mtiririko wa utekelezaji.

Hatua inayofuata ni kutengeneza miundo bandia ya **\_IO\_FILE** inayofunika na kipande cha juu cha zamani kilichopo sasa katika bin isiyo taswira. Baite za kwanza za miundo hii zimeundwa kwa uangalifu kujumuisha kidokezo kwa amri (k.m., "/bin/sh") ambayo itatekelezwa.

Uga muhimu katika miundo bandia ya **\_IO\_FILE**, kama vile `_IO_write_base` na `_IO_write_ptr`, zinawekwa kwenye thamani ambazo zinapita ukaguzi wa ndani katika libc. Aidha, jedwali la kuruka linajengwa ndani ya miundo bandia, ambapo kidokezo cha maagizo kinawekwa kwenye anwani ambapo nambari za aina yoyote zinaweza kutekelezwa. Kawaida, hii itakuwa anwani ya kazi ya `system` au kazi nyingine inayoweza kutekeleza amri za terminali.

Shambulio linakamilika wakati wito wa `malloc` unazindua utekelezaji wa nambari kupitia miundo iliyodanganywa ya **\_IO\_FILE**. Hii kimsingi inaruhusu utekelezaji wa nambari za aina yoyote, kawaida ikisababisha kuzaliwa kwa terminali au mzigo mwingine wenye nia mbaya kutekelezwa.

**Muhtasari wa Shambulio:**

1. **Sanidi kipande cha juu**: Tenga kipande na ubadilishe ukubwa wa kipande cha juu.
2. **Lazimisha kipande cha juu kuingia kwenye bin isiyo taswira**: Tenga kipande kikubwa.
3. **Vuja anwani za libc**: Tumia udhaifu kusoma kutoka kwenye bin isiyo taswira.
4. **Fanya shambulio la bin isiyo taswira**: Andika kwenye **\_IO\_list\_all** kwa kutumia kujaa.
5. **Punguza kipande cha juu cha zamani**: Badilisha ukubwa wake ili kifae kwenye bin ndogo.
6. **Sanidi miundo bandia ya \_IO\_FILE**: Tengeneza miundo bandia ya faili kudhibiti mtiririko wa utekelezaji.
7. **Zindua utekelezaji wa nambari**: Tenga kipande kutekeleza shambulio na kukimbia nambari za aina yoyote.

Mbinu hii inatumia mifumo ya usimamizi wa kibanda, uvujaji wa habari za libc, na kujaa kwa kibanda kufikia utekelezaji wa nambari bila kuita moja kwa moja `free`. Kwa kuzingatia kwa uangalifu miundo bandia ya **\_IO\_FILE** na kuweka mahali sahihi, shambulio linaweza kudhibiti mtiririko wakati wa operesheni za kawaida za kutengeneza kumbukumbu. Hii inawezesha utekelezaji wa nambari za aina yoyote, ikisababisha kuzaliwa kwa terminali au shughuli nyingine zenye nia mbaya.
## Marejeo

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
