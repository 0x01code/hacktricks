# House of Orange

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

### 代码

* 在[https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)中找到一个示例
* 此[补丁](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0)修复了利用技术，因此不再有效（在2.26之前有效）
* 同样的示例**带有更多注释**在[https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### 目标

* 滥用`malloc_printerr`函数

### 要求

* 覆盖顶部块大小
* Libc和堆泄漏

### 背景

从[**此示例**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)的评论中需要一些背景知识**：**

问题在于，在旧版本的libc中，当调用`malloc_printerr`函数时，它会**遍历存储在`_IO_list_all`中的`_IO_FILE`结构的列表**，并实际上在该结构中执行指令指针。\
这种攻击将伪造一个我们将写入**`_IO_list_all`**的假`_IO_FILE`结构，并导致`malloc_printerr`运行。\
然后它将**执行我们在`_IO_FILE`结构的跳转表中存储的任何地址**，我们将获得代码执行

### 攻击

攻击始于设法将**顶部块**置于**未排序的块**内。这是通过使用大于当前顶部块大小但小于**`mmp_.mmap_threshold`**（默认为128K）的大小调用`malloc`来实现的，否则将触发`mmap`分配。每当修改顶部块大小时，重要的是确保**顶部块+其大小**是页面对齐的，并且顶部块的**prev\_inuse**位始终设置。

要将顶部块放入未排序的块中，需要分配一个块以创建顶部块，更改顶部块大小（使用分配块中的溢出）以使**顶部块+大小**与页面对齐，并设置**prev\_inuse**位。然后分配一个大于新顶部块大小的块。请注意，永远不会调用`free`以将顶部块放入未排序的块中。

现在旧的顶部块位于未排序的块中。假设我们可以从中读取数据（可能是由于导致溢出的漏洞），则可以从中泄漏libc地址并获取**\_IO\_list\_all**的地址。

通过滥用溢出将`topChunk->bk->fwd = _IO_list_all - 0x10`写入，执行未排序的块攻击。当分配新块时，旧的顶部块将被拆分，并将指针写入**`_IO_list_all`**。

下一步涉及将旧顶部块的大小缩小以适应小块，特别是将其大小设置为**0x61**。这有两个目的：

1. **插入到Small Bin 4**：当`malloc`扫描未排序的块并看到此块时，由于其较小的大小，它将尝试将其插入到小块4中。这使得该块最终位于小块4列表的头部，这是我们通过未排序的块攻击在**`_IO_list_all`**的块的FD指针位置，因为我们在**`_IO_list_all`**中写入了一个接近地址。
2. **触发Malloc检查**：此块大小操作将导致`malloc`执行内部检查。当检查虚假前向块的大小时，该大小将为零，触发错误并调用`malloc_printerr`。

对小块的操作将允许您控制块的前向指针。与**\_IO\_list\_all**的重叠用于伪造一个假的**\_IO\_FILE**结构。该结构经过精心设计，包括将`_IO_write_base`和`_IO_write_ptr`等关键字段设置为在libc中通过内部检查的值。此外，在假结构内创建了一个跳转表，其中将指令指针设置为可以执行任意代码（例如`system`函数）的地址。

总结技术的其余部分：

* **缩小旧顶部块**：调整旧顶部块的大小为**0x61**以适应小块。
* **设置假`_IO_FILE`结构**：将旧顶部块与假的**\_IO\_FILE**结构重叠，并适当设置字段以劫持执行流。

下一步涉及伪造一个与当前位于未排序块中的旧顶部块重叠的假**\_IO\_FILE**结构。该结构的前几个字节经过精心设计，包括指向将执行的命令（例如“/bin/sh”）的指针。

在假**\_IO\_FILE**结构中的关键字段，如`_IO_write_base`和`_IO_write_ptr`，设置为在libc中通过内部检查的值。此外，在假结构内创建了一个跳转表，其中将指令指针设置为可以执行任意代码的地址。通常，这将是`system`函数的地址或其他可以执行shell命令的函数的地址。

当调用`malloc`触发通过操纵**\_IO\_FILE**结构执行代码时，攻击达到高潮。这有效地允许执行任意代码，通常导致生成shell或执行其他恶意载荷。

**攻击摘要：**

1. **设置顶部块**：分配一个块并修改顶部块大小。
2. **强制顶部块进入未排序的块**：分配一个更大的块。
3. **泄漏libc地址**：使用漏洞从未排序的块中读取数据。
4. **执行未排序的块攻击**：使用溢出写入**\_IO\_list\_all**。
5. **缩小旧顶部块**：调整其大小以适应小块。
6. **设置一个假的`_IO_FILE`结构**：伪造一个假文件结构以劫持控制流。
7. **触发代码执行**：分配一个块以执行攻击并运行任意代码。

这种方法利用堆管理机制、libc信息泄漏和堆溢出来实现代码执行，而无需直接调用`free`。通过精心设计假的**\_IO\_FILE**结构并将其放置在正确位置，攻击可以在标准内存分配操作期间劫持控制流。这使得执行任意代码成为可能，通常导致生成shell或其他恶意活动。
## 参考资料

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。 

</details>
