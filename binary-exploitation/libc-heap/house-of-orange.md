# House of Orange

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使用して、**ゼロからヒーローまでAWSハッキングを学びましょう**！</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[Telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
- **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

## 基本情報

### コード

- [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)に例があります
- この[パッチ](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0)でこの悪用技術が修正されました（2.26より前のバージョンで動作）
- より多くのコメントが付いた同じ例は[こちら](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)にあります

### ゴール

- `malloc_printerr` 関数を悪用する

### 必要条件

- トップチャンクのサイズを上書きする
- Libcとヒープのリーク

### 背景

[**この例**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)のコメントから必要な背景情報：

古いバージョンのlibcでは、`malloc_printerr` 関数が呼び出されると、`_IO_list_all` に格納されている `_IO_FILE` 構造体のリストを反復処理し、実際にその構造体内の命令ポインタを実行していました。\
この攻撃では、`_IO_list_all` に書き込む**偽の `_IO_FILE` 構造体**を作成し、`malloc_printerr` を実行させます。\
その後、**`_IO_FILE`** 構造体のジャンプテーブルに格納されているアドレスを実行し、コード実行を行います

### 攻撃

攻撃は、**アンソートされたビン**内の**トップチャンク**を取得することから始まります。これは、`malloc` を現在のトップチャンクサイズよりも大きいサイズで呼び出し、かつ **`mmp_.mmap_threshold`**（デフォルトは128K）より小さいサイズで呼び出すことで達成されます。トップチャンクサイズが変更されるたびに、**トップチャンク + サイズ** がページアラインされており、かつ **prev\_inuse** ビットが常に設定されていることが重要です。

アンソートされたビン内にトップチャンクを取得するには、トップチャンクを作成するためにチャンクを割り当て、割り当てられたチャンク内でオーバーフローを起こしてトップチャンクサイズを変更し、**トップチャンク + サイズ** がページアラインされ、かつ **prev\_inuse** ビットが設定されていることを確認する必要があります。その後、新しいトップチャンクサイズよりも大きいチャンクを割り当てます。トップチャンクをアンソートされたビンに入れるために `free` が呼び出されないことに注意してください。

古いトップチャンクは今やアンソートされたビンにあります。それを読み取ることができる場合（オーバーフローを引き起こす脆弱性による可能性があります）、そこからlibcアドレスをリークし、**\_IO\_list\_all** のアドレスを取得することができます。

アンソートされたビン攻撃は、オーバーフローを悪用して `topChunk->bk->fwd = _IO_list_all - 0x10` と書き込むことで実行されます。新しいチャンクが割り当てられると、古いトップチャンクが分割され、アンソートされたビンへのポインタが **`_IO_list_all`** に書き込まれます。

次のステップは、古いトップチャンクのサイズを小さなビンに収まるように縮小することです。具体的には、そのサイズを **0x61** に設定します。これには2つの目的があります：

1. **Small Bin 4への挿入**：`malloc` がアンソートされたビンをスキャンし、このチャンクを見つけると、その小さなサイズのためにそれをSmall Bin 4に挿入しようとします。これにより、チャンクはSmall Bin 4リストの先頭に配置され、これは **`_IO_list_all`** のチャンクのFDポインタの場所です。アンソートされたビン攻撃を介して **`_IO_list_all`** にクローズアドレスを書き込んだためです。
2. **Mallocチェックのトリガー**：このチャンクサイズの操作により、`malloc` が内部チェックを実行します。偽のフォワードチャンクのサイズをチェックすると、ゼロになり、エラーが発生して `malloc_printerr` が呼び出されます。

Small Binの操作により、チャンクのフォワードポインタを制御できます。 **\_IO\_list\_all** との重複を使用して、偽の **\_IO\_FILE** 構造体を作成します。この構造体は、`_IO_write_base` や `_IO_write_ptr` などの重要なフィールドが適切に設定され、libc内部のチェックをパスする値に設定されています。さらに、偽の構造体内にジャンプテーブルが作成され、命令ポインタが任意のコード（たとえば `system` 関数）を実行できるアドレスに設定されます。

技術の残りの部分を要約すると：

- **古いトップチャンクを縮小する**：古いトップチャンクのサイズを **0x61** に調整して、小さなビンに収めます。
- **偽の `_IO_FILE` 構造体を設定する**：古いトップチャンクと重なる偽の **\_IO\_FILE** 構造体を設定し、適切にフィールドを設定して実行フローを乗っ取ります。

次のステップは、現在アンソートされたビン内にある古いトップチャンクと重なる偽の **\_IO\_FILE** 構造体を作成することです。この構造体の最初のバイトは、実行されるコマンド（たとえば "/bin/sh"）へのポインタを慎重に作成されています。

偽の **\_IO\_FILE** 構造体内の重要なフィールド、例えば `_IO_write_base` や `_IO_write_ptr` は、libc内部のチェックをパスする値に設定されています。さらに、偽の構造体内にジャンプテーブルが作成され、命令ポインタが任意のコードを実行できるアドレスに設定されます。通常、これは `system` 関数のアドレスやシェルコマンドを実行できる他の関数のアドレスになります。

攻撃は、`malloc` の呼び出しが操作された **\_IO\_FILE** 構造体を介してコードの実行をトリガーするときに頂点に達します。これにより、任意のコードの実行が可能になり、通常はシェルが生成されるか、他の悪意のあるペイロードが実行されます。

**攻撃の要約：**

1. **トップチャンクを設定する**：チャンクを割り当ててトップチャンクのサイズを変更します。
2. **トップチャンクをアンソートされたビンに強制する**：より大きなチャンクを割り当てます。
3. **Libcアドレスをリークする**：アンソートされたビンから読み取るために脆弱性を使用します。
4. **アンソートされたビン攻撃を実行する**：オーバーフローを使用して **\_IO\_list\_all** に書き込みます。
5. **古いトップチャンクを縮小する**：そのサイズを小さなビンに収めます。
6. **偽の \_IO\_FILE 構造体を設定する**：制御フローを乗っ取るために偽のファイル構造体を作成します。
7. **コードの実行をトリガーする**：攻撃を実行して任意のコードを実行します。

この手法は、`free` を直接呼び出すことなく、ヒープ管理メカニズム、libc情報のリーク、ヒープオーバーフローを悪用してコードの実行を達成します。偽の **\_IO\_FILE** 構造体を注意深く作成し、適切な位置に配置することで、通常のメモリ割り当て操作中に制御フローを乗っ取ることができます。これにより、任意のコードの実行が可能になり、通常はシェルや他の悪意のある活動が実行されます。
## 参考

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>でAWSハッキングをゼロからヒーローまで学びましょう！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする**
* **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する**。**

</details>
