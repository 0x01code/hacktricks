# House of Orange

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

### Code

* Finden Sie ein Beispiel unter [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Die Ausnutzungstechnik wurde in diesem [Patch](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) behoben, daher funktioniert dies nicht mehr (funktionierte vor Version 2.26)
* Dasselbe Beispiel **mit mehr Kommentaren** unter [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Ziel

* Missbrauch der `malloc_printerr`-Funktion

### Anforderungen

* √úberschreiben der Gr√∂√üe des Top-Chunks
* Lecks von Libc und Heap

### Hintergrund

Einige ben√∂tigte Hintergrundinformationen aus den Kommentaren von [**diesem Beispiel**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

Das Ding ist, in √§lteren Versionen von Libc, als die `malloc_printerr`-Funktion aufgerufen wurde, w√ºrde sie **eine Liste von `_IO_FILE`-Strukturen durchlaufen, die in `_IO_list_all` gespeichert sind**, und tats√§chlich **einen Befehlszeiger in dieser Struktur ausf√ºhren**.\
Dieser Angriff wird eine **gef√§lschte `_IO_FILE`-Struktur** schmieden, die wir in **`_IO_list_all`** schreiben werden, und `malloc_printerr` dazu bringen, ausgef√ºhrt zu werden.\
Dann wird es **ausf√ºhren, was auch immer Adresse** wir in den **`_IO_FILE`**-Strukturen Sprungtabelle gespeichert haben, und wir werden Codeausf√ºhrung erhalten

### Angriff

Der Angriff beginnt damit, den **Top-Chunk** im **unsortierten Bin** zu verwalten. Dies wird erreicht, indem `malloc` mit einer Gr√∂√üe aufgerufen wird, die gr√∂√üer ist als die aktuelle Top-Chunk-Gr√∂√üe, aber kleiner als **`mmp_.mmap_threshold`** (Standardwert ist 128K), was andernfalls eine `mmap`-Zuweisung ausl√∂sen w√ºrde. Immer wenn die Top-Chunk-Gr√∂√üe ge√§ndert wird, ist es wichtig sicherzustellen, dass der **Top-Chunk + seine Gr√∂√üe** seitenaligniert ist und dass das **prev\_inuse**-Bit des Top-Chunks immer gesetzt ist.

Um den Top-Chunk im unsortierten Bin zu erhalten, wird ein Chunk allokiert, um den Top-Chunk zu erstellen, die Top-Chunk-Gr√∂√üe ge√§ndert (mit einem √úberlauf im allokierten Chunk), sodass **Top-Chunk + Gr√∂√üe** seitenaligniert ist und das **prev\_inuse**-Bit gesetzt ist. Dann wird ein Chunk allokiert, der gr√∂√üer ist als die neue Top-Chunk-Gr√∂√üe. Beachten Sie, dass `free` nie aufgerufen wird, um den Top-Chunk in den unsortierten Bin zu bringen.

Der alte Top-Chunk befindet sich nun im unsortierten Bin. Unter der Annahme, dass wir Daten darin lesen k√∂nnen (m√∂glicherweise aufgrund einer Schwachstelle, die auch den √úberlauf verursacht hat), ist es m√∂glich, Libc-Adressen daraus zu leaken und die Adresse von **\_IO\_list\_all** zu erhalten.

Ein Angriff auf den unsortierten Bin wird durch Missbrauch des √úberlaufs durchgef√ºhrt, um `topChunk->bk->fwd = _IO_list_all - 0x10` zu schreiben. Wenn ein neuer Chunk allokiert wird, wird der alte Top-Chunk aufgeteilt, und ein Zeiger auf den unsortierten Bin wird in **`_IO_list_all`** geschrieben.

Der n√§chste Schritt besteht darin, die Gr√∂√üe des alten Top-Chunks zu verkleinern, um in einen kleinen Bin zu passen, und zwar speziell seine Gr√∂√üe auf **0x61** zu setzen. Dies dient zwei Zwecken:

1. **Einf√ºgen in Small Bin 4**: Wenn `malloc` den unsortierten Bin durchsucht und diesen Chunk sieht, wird versucht, ihn in den Small Bin 4 einzuf√ºgen, aufgrund seiner geringen Gr√∂√üe. Dadurch landet der Chunk am Anfang der Liste des Small Bin 4, was der Speicherort des FD-Zeigers des Chunks von **`_IO_list_all`** ist, da wir eine nahe Adresse in **`_IO_list_all`** √ºber den Angriff auf den unsortierten Bin geschrieben haben.
2. **Ausl√∂sen einer Malloc-√úberpr√ºfung**: Diese Manipulation der Chunk-Gr√∂√üe f√ºhrt dazu, dass `malloc` interne √úberpr√ºfungen durchf√ºhrt. Wenn es die Gr√∂√üe des falschen Vorw√§rts-Chunks √ºberpr√ºft, die null sein wird, l√∂st es einen Fehler aus und ruft `malloc_printerr` auf.

Die Manipulation des Small Bins erm√∂glicht es Ihnen, den Vorw√§rtszeiger des Chunks zu steuern. Die √úberlappung mit **\_IO\_list\_all** wird verwendet, um eine gef√§lschte **\_IO\_FILE**-Struktur zu schmieden. Die Struktur wird sorgf√§ltig erstellt, um Schl√ºsselfelder wie `_IO_write_base` und `_IO_write_ptr` einzuschlie√üen, die auf Werte gesetzt sind, die interne √úberpr√ºfungen in Libc bestehen. Dar√ºber hinaus wird innerhalb der gef√§lschten Struktur eine Sprungtabelle erstellt, in der ein Befehlszeiger auf die Adresse gesetzt ist, an der beliebiger Code (z. B. die `system`-Funktion) ausgef√ºhrt werden kann.

Um den verbleibenden Teil der Technik zusammenzufassen:

* **Verkleinern des alten Top-Chunks**: Passen Sie die Gr√∂√üe des alten Top-Chunks auf **0x61** an, um ihn in einen kleinen Bin zu passen.
* **Einrichten der gef√§lschten `_IO_FILE`-Struktur**: √úberlappen Sie den alten Top-Chunk mit der gef√§lschten **\_IO_FILE**-Struktur und setzen Sie die Felder entsprechend, um den Ausf√ºhrungsfluss zu kapern.

Der n√§chste Schritt besteht darin, eine gef√§lschte **\_IO_FILE**-Struktur zu schmieden, die mit dem alten Top-Chunk im unsortierten Bin √ºberlappt. Die ersten Bytes dieser Struktur werden sorgf√§ltig erstellt, um einen Zeiger auf einen Befehl (z. B. "/bin/sh") zu enthalten, der ausgef√ºhrt wird.

Schl√ºsselfelder in der gef√§lschten **\_IO_FILE**-Struktur, wie `_IO_write_base` und `_IO_write_ptr`, werden auf Werte gesetzt, die interne √úberpr√ºfungen in Libc bestehen. Dar√ºber hinaus wird innerhalb der gef√§lschten Struktur eine Sprungtabelle erstellt, in der ein Befehlszeiger auf die Adresse gesetzt ist, an der beliebiger Code ausgef√ºhrt werden kann. Typischerweise handelt es sich dabei um die Adresse der `system`-Funktion oder einer anderen Funktion, die Shell-Befehle ausf√ºhren kann.

Der Angriff kulminiert, wenn ein Aufruf von `malloc` die Ausf√ºhrung des Codes durch die manipulierte **\_IO_FILE**-Struktur ausl√∂st. Dies erm√∂glicht effektiv die Ausf√ºhrung beliebigen Codes, was in der Regel dazu f√ºhrt, dass eine Shell gestartet oder eine andere b√∂sartige Nutzlast ausgef√ºhrt wird.

**Zusammenfassung des Angriffs:**

1. **Einrichten des Top-Chunks**: Einen Chunk allozieren und die Top-Chunk-Gr√∂√üe √§ndern.
2. **Erzwingen des Top-Chunks in den unsortierten Bin**: Einen gr√∂√üeren Chunk allozieren.
3. **Lecken von Libc-Adressen**: Verwenden der Schwachstelle, um aus dem unsortierten Bin zu lesen.
4. **Durchf√ºhren des Angriffs auf den unsortierten Bin**: Schreiben in **\_IO\_list\_all** unter Verwendung eines √úberlaufs.
5. **Verkleinern des alten Top-Chunks**: Passen Sie seine Gr√∂√üe an, um in einen kleinen Bin zu passen.
6. **Einrichten einer gef√§lschten \_IO\_FILE-Struktur**: Eine gef√§lschte Dateistruktur erstellen, um die Kontrollfluss zu kapern.
7. **Ausl√∂sen der Codeausf√ºhrung**: Einen Chunk allozieren, um den Angriff auszuf√ºhren und beliebigen Code auszuf√ºhren.

Diese Methode nutzt Heap-Verwaltungsmechanismen, Libc-Informationen-Leaks und Heap-√úberl√§ufe aus, um Codeausf√ºhrung zu erreichen, ohne `free` direkt aufzurufen. Durch sorgf√§ltiges Erstellen der gef√§lschten **\_IO_FILE**-Struktur und Platzieren an der richtigen Stelle kann der Angriff den Kontrollfluss w√§hrend standardm√§√üiger Speicherzuweisungsvorg√§nge kapern. Dies erm√∂glicht die Ausf√ºhrung beliebigen Codes, was m√∂glicherweise zu einer Shell oder anderen b√∂sartigen Aktivit√§ten f√ºhrt.
## Referenzen

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
