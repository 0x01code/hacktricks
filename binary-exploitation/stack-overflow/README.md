# Kujaa Kwa Stack

<details>

<summary><strong>Jifunze kuhusu kuhack AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Ni Nini Kujaa Kwa Stack

**Kujaa kwa stack** ni udhaifu unapotokea programu inapoandika data zaidi kwenye stack kuliko ilivyotengewa kuhifadhi. Data hii ya ziada ita**andika juu ya nafasi ya kumbukumbu inayopakana**, ikisababisha uharibifu wa data halali, kuvuruga mtiririko wa udhibiti, na kwa uwezekano wa kutekeleza msimbo wa kudhuru. Tatizo hili mara nyingi hutokea kutokana na matumizi ya kazi zisizo salama ambazo hazifanyi ukaguzi wa mipaka kwenye data zinazoingia.

Tatizo kuu la andishi hili ni kwamba viashiria vya **EIP** na **EBP** vya kurudi kwenye kazi iliyotangulia vime**hifadhiwa kwenye stack**. Hivyo, mshambuliaji ataweza kuandika juu ya hivyo na **kudhibiti mtiririko wa utekelezaji wa programu**.

Udhaifu huu kawaida hutokea kwa sababu kazi **inaiga ndani ya stack zaidi ya herufi zilizotengwa kwa ajili yake**, hivyo kuweza kuandika juu ya sehemu nyingine za stack.\
Baadhi ya kazi za kawaida zinazoweza kuwa na udhaifu huu ni: `strcpy`, `strcat`, `sprintf`, `gets`, `fgets`...

Kwa mfano, kazi zifuatazo zinaweza kuwa na udhaifu:
```c
void vulnerable() {
char buffer[128];
printf("Enter some text: ");
gets(buffer); // This is where the vulnerability lies
printf("You entered: %s\n", buffer);
}
```
### Kupata Vipande vya Kutosha vya Stack Overflows

Njia ya kawaida ya kupata vipande vya kutosha vya stack ni kutoa kuingiza kubwa sana ya `A`s (k.m. `python3 -c 'print("A"*1000)'`) na kutarajia `Segmentation Fault` inayoashiria kwamba **anwani `0x41414141` ilijaribu kufikiwa**.

Zaidi ya hayo, mara baada ya kugundua kuwa kuna udhaifu wa Stack Overflow utahitaji kupata vipande vya kutosha hadi iwezekane **kubadilisha kidude cha EIP**, kwa hili kawaida hutumika **De Bruijn sequence.** Ambayo kwa alfabeti iliyopewa ya ukubwa _k_ na vipande vya urefu _n_ ni **mfululizo wa mzunguko ambapo kila kipande kinachowezekana cha urefu **_**n**_** kinatokea mara moja tu** kama kipande kinachofuatana.

Kwa njia hii, badala ya kuhitaji kufahamu ni vipi kipande kinachobadilisha EIP kwa mkono, ni rahisi kutumia mojawapo ya vipande hivi kama kujaza na kisha kupata vipande vya herufi vilivyomaliza kubadilisha.

Inawezekana kutumia **pwntools** kwa hili:
```python
from pwn import *

# Generate a De Bruijn sequence of length 1000 with an alphabet size of 256 (byte values)
pattern = cyclic(1000)

# This is an example value that you'd have found in the EIP/IP register upon crash
eip_value = p32(0x6161616c)
offset = cyclic_find(eip_value)  # Finds the offset of the sequence in the De Bruijn pattern
print(f"The offset is: {offset}")
```
au **GEF**:
```bash
#Patterns
pattern create 200 #Generate length 200 pattern
pattern search "avaaawaa" #Search for the offset of that substring
pattern search $rsp #Search the offset given the content of $rsp
```
## Kudukua Mabaki ya Stack

Wakati wa kudukua (ukiwa na ukubwa wa kutosha wa kudukua) utaweza kubadilisha thamani za mabaki mengine ndani ya stack hadi kufikia EBP na EIP (au hata zaidi).\
Njia ya kawaida ya kutumia udhaifu huu ni kwa **kubadilisha kiongozi cha EIP** ili wakati wa kumaliza kazi **mtiririko wa udhibiti utaelekezwa mahali ambapo mtumiaji alipendekeza** kwenye kiongozi huu.

Hata hivyo, katika mazingira mengine labda **kubadilisha thamani za baadhi ya mabaki katika stack** inaweza kuwa ya kutosha kwa udanganyifu (kama katika changamoto rahisi za CTF).

### Ret2win

Katika aina hii ya changamoto za CTF, kuna **kazi** **ndani** ya binary ambayo **haiitwi kamwe** na **unahitaji kuipiga ili ushinde**. Kwa changamoto hizi unahitaji tu kupata **kielelezo cha kubadilisha EIP** na **kupata anwani ya kazi** ya kupiga simu (kawaida [**ASLR**](../common-binary-protections-and-bypasses/aslr/) itakuwa imelemazwa) ili wakati kazi yenye udhaifu inaporudi, kazi iliyofichwa itaitwa:

{% content-ref url="ret2win.md" %}
[ret2win.md](ret2win.md)
{% endcontent-ref %}

### Shellcode ya Stack

Katika hali hii, mkaidi anaweza kuweka shellcode katika stack na kutumia EIP iliyodhibitiwa kwenda kwenye shellcode na kutekeleza msimbo wa mkaidi:

{% content-ref url="stack-shellcode.md" %}
[stack-shellcode.md](stack-shellcode.md)
{% endcontent-ref %}

### ROP & Mbinu za Ret2...

Mbinu hii ni mfumo msingi wa kukiuka kinga kuu kwa mbinu iliyotangulia: **Hakuna stack inayoweza kutekelezwa**. Na inaruhusu kutekeleza mbinu kadhaa zingine (ret2lib, ret2syscall...) ambazo mwishowe zitakayotekeleza amri za aina yoyote kwa kudanganya maagizo yaliyopo katika binary:

{% content-ref url="../rop-return-oriented-programing/" %}
[rop-return-oriented-programing](../rop-return-oriented-programing/)
{% endcontent-ref %}

## Aina za kinga

Kuna kinga kadhaa zinajaribu kuzuia udanganyifu wa udhaifu, zitazame hapa:

{% content-ref url="../common-binary-protections-and-bypasses/" %}
[common-binary-protections-and-bypasses](../common-binary-protections-and-bypasses/)
{% endcontent-ref %}
