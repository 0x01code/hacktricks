# マルウェア分析

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## フォレンジックチートシート

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## オンラインサービス

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## オフラインアンチウイルスおよび検出ツール

### Yara

#### インストール
```bash
sudo apt-get install -y yara
```
#### ルールの準備

このスクリプトを使用して、githubからすべてのyaraマルウェアルールをダウンロードし、マージします： [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
_**rules**_ ディレクトリを作成し、スクリプトを実行してください。これにより、マルウェアのためのすべてのyaraルールを含む _**malware\_rules.yar**_ というファイルが作成されます。
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### スキャン
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: マルウェアのチェックとルールの作成

バイナリからyaraルールを生成するために、ツール[**YaraGen**](https://github.com/Neo23x0/yarGen)を使用できます。これらのチュートリアルをチェックしてください: [**パート1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**パート2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**パート3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### インストール
```
sudo apt-get install -y clamav
```
#### スキャン
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa**は実行可能ファイル（PE、ELF、.NET）における潜在的に悪意のある**機能**を検出します。例えば、Att&ck戦術や以下のような疑わしい機能を見つけます：

* OutputDebugStringエラーのチェック
* サービスとして実行
* プロセスの作成

[**Githubリポジトリ**](https://github.com/mandiant/capa)で入手してください。

### IOCs

IOCはCompromiseの指標を意味します。IOCは、望ましくないソフトウェアや確認された**マルウェア**を特定する**条件のセット**です。Blue Teamsはこの種の定義を使用して、自分たちの**システム**や**ネットワーク**内でこの種の悪意のあるファイルを**検索します**。\
これらの定義を共有することは非常に有用です。なぜなら、コンピュータにマルウェアが特定され、そのマルウェアのIOCが作成されると、他のBlue Teamsがマルウェアをより速く特定するために使用できるからです。

IOCを作成または変更するツールは[**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**です。**\
デバイス内で定義されたIOCを**検索する**ために、[**Redline**](https://www.fireeye.com/services/freeware/redline.html)などのツールを使用できます。

### Loki

[**Loki**](https://github.com/Neo23x0/Loki)は、簡易的なCompromiseの指標をスキャンするツールです。\
検出は4つの検出方法に基づいています：
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) は、GNU GPLv2 ライセンスの下でリリースされた Linux 用マルウェアスキャナーで、共有ホスティング環境で直面する脅威を中心に設計されています。ネットワークエッジ侵入検知システムからの脅威データを使用して、攻撃で実際に使用されているマルウェアを抽出し、検出のためのシグネチャを生成します。さらに、脅威データは LMD チェックアウト機能とマルウェアコミュニティリソースからのユーザー提出からも導出されます。

### rkhunter

[**rkhunter**](http://rkhunter.sourceforge.net) のようなツールは、ファイルシステムを **rootkits** やマルウェアの可能性についてチェックするために使用できます。
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) は、さまざまな技術を使用して実行可能ファイル内の難読化された文字列を見つけようとするツールです。

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) は実行可能ファイル内の基本的な情報（バイナリデータ、エントロピー、URLとIP、いくつかのyaraルール）をチェックします。

### PEstudio

[PEstudio](https://www.winitor.com/download) はWindows実行可能ファイルの情報を取得するツールで、インポート、エクスポート、ヘッダーを調べるだけでなく、virus totalをチェックし、潜在的なAtt&ck技術を見つけます。

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) はファイルが**暗号化**されているかどうかを検出し、**パッカー**を見つけるツールです。

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) は、テキスト/スクリプトファイル内の**難読化**された**暗号化**されたコンテンツを検出するために、さまざまな**統計的方法**を使用するPythonスクリプトです。NeoPIの目的は、隠されたウェブシェルコードの**検出**に役立てることです。

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) は、**難読化**された/**怪しいコード**、および**PHP**関数を使用するファイルを検出するために最善を尽くします。これらの関数は、**マルウェア**/ウェブシェルでよく使用されます。

### Apple Binary Signatures

**マルウェアサンプル**をチェックする際には、バイナリの**署名**を常に**確認**するべきです。署名した**開発者**が既に**マルウェア**と**関連**している可能性があります。
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app’s contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## 検出技術

### ファイルスタッキング

あるフォルダに含まれる**ファイル**が**最終更新日**に更新されたことが分かっている場合。**ウェブサーバーの全ファイルの作成日と変更日を確認**し、**怪しい日付**があれば、そのファイルをチェックします。

### ベースライン

フォルダのファイルが**変更されていないはず**の場合、フォルダの**オリジナルファイル**の**ハッシュ**を計算し、**現在の**ものと**比較**します。変更されたものは**怪しい**とされます。

### 統計分析

ログに情報が保存されている場合、ウェブサーバーの各ファイルがアクセスされた回数などの統計を**確認**できます。ウェブシェルは最も多くアクセスされる可能性があります。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**する。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングトリックを**共有**する。

</details>
