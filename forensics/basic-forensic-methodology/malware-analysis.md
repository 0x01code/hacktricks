# An√°lise de Malware

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## CheatSheets de Forensics

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Servi√ßos Online

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Ferramentas Offline de Antiv√≠rus e Detec√ß√£o

### Yara

#### Instala√ß√£o
```bash
sudo apt-get install -y yara
```
#### Preparar regras

Use este script para baixar e mesclar todas as regras de malware yara do GitHub: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Crie o diret√≥rio _**rules**_ e execute-o. Isso criar√° um arquivo chamado _**malware\_rules.yar**_ que cont√©m todas as regras yara para malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Verifica√ß√£o

A primeira etapa na an√°lise de malware √© realizar uma verifica√ß√£o completa do sistema em busca de qualquer sinal de atividade maliciosa. Isso pode ser feito usando ferramentas de seguran√ßa, como antiv√≠rus e antimalware, para identificar arquivos suspeitos ou comportamentos anormais.

Durante a verifica√ß√£o, √© importante garantir que as defini√ß√µes de seguran√ßa estejam atualizadas para detectar as amea√ßas mais recentes. Al√©m disso, √© recomend√°vel executar a verifica√ß√£o em modo de seguran√ßa para evitar que o malware se espalhe ou se esconda.

Ap√≥s a verifica√ß√£o, √© necess√°rio revisar os resultados em busca de qualquer indica√ß√£o de malware. Isso pode incluir arquivos infectados, processos suspeitos em execu√ß√£o ou altera√ß√µes n√£o autorizadas no sistema.

#### Analysis

A pr√≥xima etapa na an√°lise de malware √© a an√°lise detalhada do arquivo suspeito. Isso envolve examinar o c√≥digo do malware, identificar suas funcionalidades e entender como ele se comporta.

Existem v√°rias t√©cnicas de an√°lise que podem ser usadas, como an√°lise est√°tica e an√°lise din√¢mica. A an√°lise est√°tica envolve examinar o c√≥digo-fonte do malware sem execut√°-lo, enquanto a an√°lise din√¢mica envolve executar o malware em um ambiente controlado para observar seu comportamento.

Durante a an√°lise, √© importante observar as caracter√≠sticas do malware, como sua capacidade de se espalhar, se comunicar com servidores remotos ou roubar informa√ß√µes confidenciais. Tamb√©m √© importante identificar qualquer t√©cnica de evas√£o que o malware possa estar usando para evitar a detec√ß√£o.

#### Report

Ap√≥s concluir a an√°lise do malware, √© importante documentar todas as descobertas em um relat√≥rio detalhado. Isso inclui informa√ß√µes sobre o malware, como seu nome, tipo, funcionalidades e comportamento.

O relat√≥rio tamb√©m deve incluir informa√ß√µes sobre as medidas de mitiga√ß√£o recomendadas para proteger o sistema contra o malware. Isso pode incluir a remo√ß√£o do malware, a atualiza√ß√£o de software, a aplica√ß√£o de patches de seguran√ßa ou a implementa√ß√£o de medidas de seguran√ßa adicionais.

Al√©m disso, o relat√≥rio deve ser claro e conciso, fornecendo informa√ß√µes relevantes de forma organizada e compreens√≠vel. Isso ajudar√° os usu√°rios a entenderem a natureza do malware e tomar as medidas necess√°rias para proteger seus sistemas.
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Verificar malware e criar regras

Voc√™ pode usar a ferramenta [**YaraGen**](https://github.com/Neo23x0/yarGen) para gerar regras yara a partir de um bin√°rio. Confira estes tutoriais: [**Parte 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Parte 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Parte 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instala√ß√£o

Para instalar o ClamAV, siga as etapas abaixo:

1. Abra o terminal e execute o seguinte comando para atualizar a lista de pacotes:
```
sudo apt update
```

2. Em seguida, execute o comando abaixo para instalar o ClamAV:
```
sudo apt install clamav
```

3. Ap√≥s a instala√ß√£o, atualize as defini√ß√µes de v√≠rus executando o seguinte comando:
```
sudo freshclam
```

4. Agora voc√™ pode verificar arquivos em busca de malware usando o comando abaixo:
```
clamscan <caminho_do_arquivo_ou_diret√≥rio>
```

Certifique-se de substituir `<caminho_do_arquivo_ou_diret√≥rio>` pelo caminho real do arquivo ou diret√≥rio que deseja verificar.

5. Para remover o ClamAV, execute o seguinte comando:
```
sudo apt remove clamav
```

Agora voc√™ tem o ClamAV instalado e pronto para ser usado em sua an√°lise de malware.
```
sudo apt-get install -y clamav
```
#### Verifica√ß√£o

A primeira etapa na an√°lise de malware √© realizar uma verifica√ß√£o completa do arquivo suspeito. Isso pode ser feito usando v√°rias ferramentas de seguran√ßa, como antiv√≠rus e scanners de malware. Essas ferramentas procuram por assinaturas conhecidas de malware e comportamentos suspeitos no arquivo.

#### An√°lise est√°tica

Ap√≥s a verifica√ß√£o inicial, √© importante realizar uma an√°lise est√°tica do arquivo. Isso envolve examinar o c√≥digo do malware sem execut√°-lo. Durante essa an√°lise, √© poss√≠vel identificar strings suspeitas, fun√ß√µes maliciosas e t√©cnicas de ofusca√ß√£o usadas pelo malware.

#### An√°lise din√¢mica

A an√°lise din√¢mica envolve a execu√ß√£o do malware em um ambiente controlado para observar seu comportamento. Isso pode ser feito em uma m√°quina virtual isolada ou em um ambiente de sandbox. Durante essa an√°lise, √© poss√≠vel observar as a√ß√µes do malware, como a cria√ß√£o de arquivos, a comunica√ß√£o com servidores remotos e a modifica√ß√£o do sistema.

#### Engenharia reversa

A engenharia reversa √© uma etapa avan√ßada na an√°lise de malware, que envolve a desmontagem do c√≥digo do malware para entender sua l√≥gica interna. Isso pode revelar informa√ß√µes valiosas sobre as t√©cnicas de ataque usadas pelo malware e ajudar a desenvolver contramedidas eficazes.

#### An√°lise de tr√°fego de rede

Al√©m da an√°lise do arquivo em si, tamb√©m √© importante analisar o tr√°fego de rede gerado pelo malware. Isso pode revelar informa√ß√µes sobre os servidores de comando e controle usados pelo malware, bem como as comunica√ß√µes entre o malware e outros sistemas na rede.

#### An√°lise de artefatos

Por fim, √© importante analisar os artefatos deixados pelo malware no sistema infectado. Isso pode incluir arquivos de log, entradas de registro e altera√ß√µes no sistema de arquivos. Esses artefatos podem fornecer pistas adicionais sobre as atividades do malware e ajudar na remo√ß√£o completa do mesmo.

Ao seguir essa metodologia b√°sica de an√°lise forense de malware, √© poss√≠vel obter uma compreens√£o mais profunda do funcionamento do malware e desenvolver estrat√©gias eficazes para mitigar seus efeitos.
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** detecta potencialmente **capacidades maliciosas** em execut√°veis: PE, ELF, .NET. Portanto, ele encontrar√° coisas como t√°ticas de Att\&ck ou capacidades suspeitas, como:

* verificar erros de OutputDebugString
* executar como um servi√ßo
* criar processo

Obtenha-o no [**reposit√≥rio do Github**](https://github.com/mandiant/capa).

### IOCs

IOC significa Indicator Of Compromise. Um IOC √© um conjunto de **condi√ß√µes que identificam** algum software potencialmente indesejado ou malware confirmado. As equipes de seguran√ßa usam esse tipo de defini√ß√£o para **procurar por esse tipo de arquivos maliciosos** em seus **sistemas** e **redes**.\
Compartilhar essas defini√ß√µes √© muito √∫til, pois quando um malware √© identificado em um computador e um IOC para esse malware √© criado, outras equipes de seguran√ßa podem us√°-lo para identificar o malware mais rapidamente.

Uma ferramenta para criar ou modificar IOCs √© o [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Voc√™ pode usar ferramentas como o [**Redline**](https://www.fireeye.com/services/freeware/redline.html) para **procurar por IOCs definidos em um dispositivo**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) √© um scanner para Indicadores Simples de Comprometimento.\
A detec√ß√£o √© baseada em quatro m√©todos de detec√ß√£o:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) √© um scanner de malware para Linux lan√ßado sob a licen√ßa GNU GPLv2, projetado para enfrentar amea√ßas em ambientes de hospedagem compartilhada. Ele utiliza dados de amea√ßas de sistemas de detec√ß√£o de intrus√£o na borda da rede para extrair malware que est√° sendo usado ativamente em ataques e gera assinaturas para detec√ß√£o. Al√©m disso, os dados de amea√ßas tamb√©m s√£o derivados de envios de usu√°rios com o recurso de verifica√ß√£o do LMD e de recursos da comunidade de malware.

### rkhunter

Ferramentas como [**rkhunter**](http://rkhunter.sourceforge.net) podem ser usadas para verificar o sistema de arquivos em busca de poss√≠veis **rootkits** e malware.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) √© uma ferramenta que tentar√° encontrar strings ofuscadas dentro de execut√°veis usando diferentes t√©cnicas.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) verifica algumas informa√ß√µes b√°sicas dentro do execut√°vel (dados bin√°rios, entropia, URLs e IPs, algumas regras yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) √© uma ferramenta que permite obter informa√ß√µes de execut√°veis do Windows, como imports, exports, headers, mas tamb√©m verifica o virus total e encontra poss√≠veis t√©cnicas de Att\&ck.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) √© uma ferramenta para detectar se um arquivo est√° **criptografado** e tamb√©m encontrar **empacotadores**.

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) √© um script Python que usa uma variedade de **m√©todos estat√≠sticos** para detectar conte√∫do **ofuscado** e **criptografado** em arquivos de texto/script. O objetivo do NeoPI √© auxiliar na **detec√ß√£o de c√≥digo de shell web oculto**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) faz o seu melhor para detectar c√≥digo **ofuscado**/**suspeito** e tamb√©m arquivos que usam fun√ß√µes **PHP** frequentemente usadas em **malwares**/shell web.

### Assinaturas Bin√°rias da Apple

Ao verificar alguma **amostra de malware**, voc√™ sempre deve **verificar a assinatura** do bin√°rio, pois o **desenvolvedor** que o assinou pode estar **relacionado** a **malwares**.
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## T√©cnicas de Detec√ß√£o

### Empilhamento de Arquivos

Se voc√™ sabe que uma pasta contendo os **arquivos** de um servidor web foi **atualizada pela √∫ltima vez em uma determinada data**. **Verifique** a **data** em que todos os **arquivos** do servidor web foram criados e modificados e, se alguma data for **suspeita**, verifique esse arquivo.

### Baselines

Se os arquivos de uma pasta **n√£o deveriam ter sido modificados**, voc√™ pode calcular o **hash** dos **arquivos originais** da pasta e **compar√°-los** com os **atuais**. Qualquer modifica√ß√£o ser√° **suspeita**.

### An√°lise Estat√≠stica

Quando as informa√ß√µes s√£o salvas em logs, voc√™ pode **verificar estat√≠sticas como quantas vezes cada arquivo de um servidor web foi acessado, pois um web shell pode ser um dos mais**.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
