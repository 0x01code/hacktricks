# Analyse de logiciels malveillants

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Feuilles de triche en forensique

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Services en ligne

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Outils antivirus et de d√©tection hors ligne

### Yara

#### Installation
```bash
sudo apt-get install -y yara
```
#### Pr√©parer les r√®gles

Utilisez ce script pour t√©l√©charger et fusionner toutes les r√®gles de d√©tection de logiciels malveillants yara depuis GitHub : [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Cr√©ez le r√©pertoire _**rules**_ et ex√©cutez-le. Cela cr√©era un fichier appel√© _**malware\_rules.yar**_ qui contient toutes les r√®gles yara pour les logiciels malveillants.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Analyse

L'√©tape initiale de l'analyse des logiciels malveillants consiste √† effectuer une analyse de scan approfondie du fichier suspect. Cette analyse permet de d√©tecter les signatures connues de logiciels malveillants et de d√©terminer si le fichier est potentiellement dangereux.

Il existe plusieurs outils d'analyse de scan disponibles, tels que les antivirus et les outils d'analyse de logiciels malveillants. Ces outils utilisent des bases de donn√©es de signatures pour comparer le fichier suspect √† des mod√®les connus de logiciels malveillants.

Lors de l'analyse de scan, il est important de prendre en compte les r√©sultats obtenus, mais aussi de les interpr√©ter correctement. Certains fichiers peuvent √™tre signal√©s comme suspects en raison de leur comportement ou de leur structure, m√™me s'ils ne sont pas r√©ellement malveillants.

Il est √©galement important de noter que les logiciels malveillants peuvent utiliser des techniques d'obfuscation pour masquer leur v√©ritable nature. Par cons√©quent, il est possible que certains fichiers malveillants ne soient pas d√©tect√©s par les outils d'analyse de scan traditionnels.

En r√©sum√©, l'analyse de scan est une √©tape cruciale dans la m√©thodologie d'analyse des logiciels malveillants. Elle permet de d√©tecter les signatures connues de logiciels malveillants et de d√©terminer si un fichier est potentiellement dangereux. Cependant, il est important de prendre en compte les r√©sultats obtenus et de les interpr√©ter correctement, en tenant compte des techniques d'obfuscation utilis√©es par les logiciels malveillants.
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: V√©rification des logiciels malveillants et cr√©ation de r√®gles

Vous pouvez utiliser l'outil [**YaraGen**](https://github.com/Neo23x0/yarGen) pour g√©n√©rer des r√®gles yara √† partir d'un binaire. Consultez ces tutoriels : [**Partie 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Partie 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Partie 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Installation

To install ClamAV, follow these steps:

1. Update your package manager:
```shell
sudo apt update
```

2. Install ClamAV:
```shell
sudo apt install clamav
```

3. Update the virus database:
```shell
sudo freshclam
```

4. Scan a file or directory for malware:
```shell
clamscan <file or directory>
```

5. Remove infected files:
```shell
clamscan --remove <file or directory>
```

6. Schedule regular scans:
```shell
sudo crontab -e
```
Add the following line to the crontab file to run a daily scan at 2 AM:
```shell
0 2 * * * clamscan -r /path/to/scan
```

7. Enable automatic updates:
```shell
sudo systemctl enable clamav-freshclam
```

That's it! ClamAV is now installed and ready to use for malware analysis.
```
sudo apt-get install -y clamav
```
#### Analyse

L'√©tape initiale de l'analyse des logiciels malveillants consiste √† effectuer une analyse approfondie du fichier suspect. Cette analyse peut √™tre r√©alis√©e √† l'aide d'outils d'analyse de logiciels malveillants tels que des scanners antivirus, des outils de d√©tection de comportement malveillant et des outils d'analyse statique.

##### Analyse antivirus

Les scanners antivirus sont des outils couramment utilis√©s pour d√©tecter les logiciels malveillants. Ils fonctionnent en comparant les signatures des fichiers suspects avec une base de donn√©es de signatures de logiciels malveillants connus. Si une correspondance est trouv√©e, le fichier est consid√©r√© comme malveillant.

##### Analyse de comportement malveillant

L'analyse de comportement malveillant consiste √† ex√©cuter le fichier suspect dans un environnement contr√¥l√© pour observer son comportement. Cela peut inclure l'observation des actions effectu√©es par le fichier, telles que la cr√©ation de fichiers ou de processus, les communications r√©seau, les modifications du registre, etc. Les outils d'analyse de comportement malveillant peuvent aider √† d√©tecter les activit√©s suspectes.

##### Analyse statique

L'analyse statique consiste √† examiner le fichier suspect sans l'ex√©cuter. Cela peut inclure l'examen du code source, des m√©tadonn√©es du fichier, des cha√Ænes de caract√®res, des fonctions d'importation/exportation, etc. L'analyse statique peut r√©v√©ler des informations sur les fonctionnalit√©s du logiciel malveillant et aider √† identifier les indicateurs de compromission.

Une fois l'analyse initiale termin√©e, les r√©sultats peuvent √™tre utilis√©s pour d√©terminer si le fichier est malveillant ou non. Si le fichier est identifi√© comme malveillant, des mesures appropri√©es peuvent √™tre prises pour le neutraliser et pr√©venir toute autre infection.
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** d√©tecte les **capacit√©s potentiellement malveillantes** dans les ex√©cutables : PE, ELF, .NET. Il trouvera donc des choses telles que les tactiques Att\&ck, ou des capacit√©s suspectes telles que :

- v√©rification des erreurs OutputDebugString
- ex√©cution en tant que service
- cr√©ation de processus

Obtenez-le dans le [**d√©p√¥t Github**](https://github.com/mandiant/capa).

### IOCs

IOC signifie Indicator Of Compromise. Un IOC est un ensemble de **conditions qui identifient** un logiciel potentiellement ind√©sirable ou un **logiciel malveillant confirm√©**. Les √©quipes Blue utilisent ce type de d√©finition pour **rechercher ce type de fichiers malveillants** dans leurs **syst√®mes** et **r√©seaux**.\
Le partage de ces d√©finitions est tr√®s utile, car lorsque des logiciels malveillants sont identifi√©s sur un ordinateur et qu'un IOC pour ce logiciel malveillant est cr√©√©, d'autres √©quipes Blue peuvent l'utiliser pour identifier plus rapidement le logiciel malveillant.

Un outil pour cr√©er ou modifier des IOCs est [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Vous pouvez utiliser des outils tels que [**Redline**](https://www.fireeye.com/services/freeware/redline.html) pour **rechercher des IOCs d√©finis sur un appareil**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) est un scanner pour les Indicateurs Simples de Compromission.\
La d√©tection est bas√©e sur quatre m√©thodes de d√©tection :
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) est un scanner de logiciels malveillants pour Linux publi√© sous la licence GNU GPLv2, con√ßu pour faire face aux menaces rencontr√©es dans les environnements d'h√©bergement partag√©. Il utilise des donn√©es de menace provenant de syst√®mes de d√©tection d'intrusion en bordure de r√©seau pour extraire les logiciels malveillants utilis√©s activement dans les attaques et g√©n√®re des signatures pour la d√©tection. De plus, les donn√©es de menace sont √©galement obtenues √† partir des soumissions des utilisateurs avec la fonction de v√©rification de LMD et des ressources de la communaut√© des logiciels malveillants.

### rkhunter

Des outils comme [**rkhunter**](http://rkhunter.sourceforge.net) peuvent √™tre utilis√©s pour v√©rifier le syst√®me de fichiers √† la recherche de possibles **rootkits** et logiciels malveillants.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[FLOSS](https://github.com/mandiant/flare-floss) est un outil qui tentera de trouver des cha√Ænes de caract√®res obfusqu√©es √† l'int√©rieur des ex√©cutables en utilisant diff√©rentes techniques.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) v√©rifie quelques √©l√©ments de base √† l'int√©rieur de l'ex√©cutable (donn√©es binaires, entropie, URLs et IPs, certaines r√®gles yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) est un outil qui permet d'obtenir des informations sur les ex√©cutables Windows tels que les imports, les exports, les en-t√™tes, mais qui v√©rifiera √©galement VirusTotal et trouvera des techniques potentielles d'Att\&ck.

### Detect It Easy(DiE)

[DiE](https://github.com/horsicq/Detect-It-Easy/) est un outil permettant de d√©tecter si un fichier est **crypt√©** et de trouver des **packers**.

### NeoPI

[NeoPI](https://github.com/CiscoCXSecurity/NeoPI) est un script Python qui utilise diverses m√©thodes statistiques pour d√©tecter du contenu **obfusqu√©** et **crypt√©** dans des fichiers texte/script. L'objectif de NeoPI est d'aider √† la **d√©tection de code de coquille web cach√©**.

### php-malware-finder

[php-malware-finder](https://github.com/nbs-system/php-malware-finder) fait de son mieux pour d√©tecter du **code obfusqu√©**/**douteux** ainsi que des fichiers utilisant des fonctions **PHP** souvent utilis√©es dans les **malwares**/coquilles web.

### Signatures binaires Apple

Lors de l'analyse d'un **√©chantillon de malware**, vous devriez toujours **v√©rifier la signature** du binaire car le **d√©veloppeur** qui l'a sign√© peut d√©j√† √™tre **li√©** √† un **malware**.
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## Techniques de d√©tection

### Empilement de fichiers

Si vous savez qu'un dossier contenant les **fichiers** d'un serveur web a √©t√© **derni√®rement mis √† jour √† une certaine date**, **v√©rifiez** la **date** de cr√©ation et de modification de tous les **fichiers** du serveur web et si une date est **suspecte**, v√©rifiez ce fichier.

### Baselines

Si les fichiers d'un dossier **ne devraient pas avoir √©t√© modifi√©s**, vous pouvez calculer le **hash** des **fichiers originaux** du dossier et les **comparer** avec les **fichiers actuels**. Tout ce qui a √©t√© modifi√© sera **suspect**.

### Analyse statistique

Lorsque les informations sont enregistr√©es dans des journaux, vous pouvez **v√©rifier des statistiques telles que le nombre de fois o√π chaque fichier d'un serveur web a √©t√© acc√©d√©, car un web shell pourrait √™tre l'un des plus utilis√©s**.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
