# Kuvunja vipande vya Python vilivyokompiliwa (exe, elf) - Pata kutoka kwa .pyc

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

<img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Ikiwa una nia ya **kazi ya kudukua** na kudukua yasiyodukuliwa - **tunakupa ajira!** (_inahitajika uwezo wa kuandika na kuzungumza Kipolishi kwa ufasaha_).

{% embed url="https://www.stmcyber.com/careers" %}

## Kutoka kwa Kipande Kilichokompiliwa hadi .pyc

Kutoka kwa kipande kilichokompiliwa cha **ELF** unaweza **kupata .pyc** na:
```bash
pyi-archive_viewer <binary>
# The list of python modules will be given here:
[(0, 230, 311, 1, 'm', 'struct'),
(230, 1061, 1792, 1, 'm', 'pyimod01_os_path'),
(1291, 4071, 8907, 1, 'm', 'pyimod02_archive'),
(5362, 5609, 13152, 1, 'm', 'pyimod03_importers'),
(10971, 1473, 3468, 1, 'm', 'pyimod04_ctypes'),
(12444, 816, 1372, 1, 's', 'pyiboot01_bootstrap'),
(13260, 696, 1053, 1, 's', 'pyi_rth_pkgutil'),
(13956, 1134, 2075, 1, 's', 'pyi_rth_multiprocessing'),
(15090, 445, 672, 1, 's', 'pyi_rth_inspect'),
(15535, 2514, 4421, 1, 's', 'binary_name'),
...

? X binary_name
to filename? /tmp/binary.pyc
```
Katika **binary ya python exe** iliyokompiliwa unaweza **kupata .pyc** kwa kukimbia:
```bash
python pyinstxtractor.py executable.exe
```
## Kutoka .pyc hadi kodi ya Python

Kwa data ya **.pyc** ("imekompiliwa" python) unapaswa kuanza kujaribu **kuchimbua** **asili** ya **kodi ya Python**:
```bash
uncompyle6 binary.pyc  > decompiled.py
```
**Hakikisha** kuwa faili ya binary ina **kikasha** "**.pyc**" (kama sivyo, uncompyle6 haitafanya kazi)

Wakati wa kutekeleza **uncompyle6** unaweza kukutana na **makosa yafuatayo**:

### Kosa: Nambari ya uchawi isiyojulikana 227
```bash
/kali/.local/bin/uncompyle6 /tmp/binary.pyc
Unknown magic number 227 in /tmp/binary.pyc
```
Kuifanya hii iwe sawa, unahitaji **kuongeza nambari sahihi ya uchawi** mwanzoni mwa faili iliyoundwa.

**Nambari za uchawi hutofautiana na toleo la python**, ili kupata nambari ya uchawi ya **python 3.8** utahitaji **kufungua terminal ya python 3.8** na kutekeleza:
```
>> import imp
>> imp.get_magic().hex()
'550d0d0a'
```
**Namba ya uchawi** katika kesi hii kwa python3.8 ni **`0x550d0d0a`**, kwa hiyo, ili kurekebisha kosa hili utahitaji **kuongeza** kwenye **mwanzo** wa faili ya **.pyc** herufi zifuatazo: `0x0d550a0d000000000000000000000000`

**Marafiki** umekwisha **ongeza** kichwa cha uchawi huo, **kosa linapaswa kurekebishwa.**

Hivi ndivyo jinsi **kichwa cha uchawi cha .pyc python3.8** kilivyoongezwa kwa usahihi:
```bash
hexdump 'binary.pyc' | head
0000000 0d55 0a0d 0000 0000 0000 0000 0000 0000
0000010 00e3 0000 0000 0000 0000 0000 0000 0000
0000020 0700 0000 4000 0000 7300 0132 0000 0064
0000030 0164 006c 005a 0064 0164 016c 015a 0064
```
### Kosa: Kuvunja makosa ya kawaida

**Makosa mengine** kama vile: `class 'AssertionError'>; co_code should be one of the types (<class 'str'>, <class 'bytes'>, <class 'list'>, <class 'tuple'>); is type <class 'NoneType'>` yanaweza kuonekana.

Hii inamaanisha labda **haujazi nambari ya uchawi kwa usahihi** au haujatumia **nambari ya uchawi sahihi**, kwa hivyo hakikisha unatumia ile sahihi (au jaribu nyingine).

Angalia nyaraka za kosa la awali.

## Zana ya Kiotomatiki

Zana ya **[python-exe-unpacker](https://github.com/countercept/python-exe-unpacker)** inatumika kama muunganiko wa zana kadhaa zinazopatikana kwenye jamii iliyoundwa kusaidia watafiti katika kuvunja na kuvunja vipengele vilivyoandikwa kwa Python, haswa vile vilivyoundwa na py2exe na pyinstaller. Inajumuisha sheria za YARA kutambua ikiwa kutekelezeka ni msingi wa Python na kuthibitisha zana ya uundaji.

### ImportError: Jina la faili: 'unpacked/malware\_3.exe/**pycache**/archive.cpython-35.pyc' halipo

Shida ya kawaida inayojitokeza ni faili ya bytecode ya Python isiyokamilika kutokana na **mchakato wa kuvunja na unpy2exe au pyinstxtractor**, ambayo kisha **haiwezi kutambuliwa na uncompyle6 kutokana na kukosekana kwa nambari ya toleo la bytecode ya Python**. Ili kutatua hili, chaguo la kuongeza mbele limeongezwa, ambalo linaweka nambari sahihi ya toleo la bytecode ya Python, kurahisisha mchakato wa kuvunja. 

Mfano wa shida:
```python
# Error when attempting to decompile without the prepend option
test@test: uncompyle6 unpacked/malware_3.exe/archive.py
Traceback (most recent call last):
...
ImportError: File name: 'unpacked/malware_3.exe/__pycache__/archive.cpython-35.pyc' doesn't exist
```

```python
# Successful decompilation after using the prepend option
test@test:python python_exe_unpack.py -p unpacked/malware_3.exe/archive
[*] On Python 2.7
[+] Magic bytes are already appended.

# Successfully decompiled file
[+] Successfully decompiled.
```
## Uchambuzi wa mkutano wa python

Ikiwa haukuweza kuchambua "asili" ya msimbo wa python kwa kufuata hatua za awali, basi unaweza jaribu **kuchambua** mkutano (lakini **hauelezi sana**, kwa hivyo jaribu kuchambua tena msimbo wa asili). Hapa [hapa](https://bits.theorem.co/protecting-a-python-codebase/) nilipata msimbo rahisi sana wa **kuchambua** faili ya _.pyc_ (bahati nzuri kuelewa mtiririko wa msimbo). Ikiwa _.pyc_ ni kutoka python2, tumia python2:
```bash
>>> import dis
>>> import marshal
>>> import struct
>>> import imp
>>>
>>> with open('hello.pyc', 'r') as f:  # Read the binary file
...     magic = f.read(4)
...     timestamp = f.read(4)
...     code = f.read()
...
>>>
>>> # Unpack the structured content and un-marshal the code
>>> magic = struct.unpack('<H', magic[:2])
>>> timestamp = struct.unpack('<I', timestamp)
>>> code = marshal.loads(code)
>>> magic, timestamp, code
((62211,), (1425911959,), <code object <module> at 0x7fd54f90d5b0, file "hello.py", line 1>)
>>>
>>> # Verify if the magic number corresponds with the current python version
>>> struct.unpack('<H', imp.get_magic()[:2]) == magic
True
>>>
>>> # Disassemble the code object
>>> dis.disassemble(code)
1           0 LOAD_CONST               0 (<code object hello_world at 0x7f31b7240eb0, file "hello.py", line 1>)
3 MAKE_FUNCTION            0
6 STORE_NAME               0 (hello_world)
9 LOAD_CONST               1 (None)
12 RETURN_VALUE
>>>
>>> # Also disassemble that const being loaded (our function)
>>> dis.disassemble(code.co_consts[0])
2           0 LOAD_CONST               1 ('Hello  {0}')
3 LOAD_ATTR                0 (format)
6 LOAD_FAST                0 (name)
9 CALL_FUNCTION            1
12 PRINT_ITEM
13 PRINT_NEWLINE
14 LOAD_CONST               0 (None)
17 RETURN_VALUE
```
## Python hadi Kutekelezeka

Kuanza, tutakuonyesha jinsi mizigo inavyoweza kubadilishwa kuwa py2exe na PyInstaller.

### Kuunda mzigo kwa kutumia py2exe:

1. Sakinisha kifurushi cha py2exe kutoka [http://www.py2exe.org/](http://www.py2exe.org)
2. Kwa mzigo (katika kesi hii, tutamwita hello.py), tumia hati kama ile katika Figure 1. Chaguo "bundle\_files" lenye thamani ya 1 litajumuisha kila kitu, pamoja na mkalimani wa Python, kuwa exe moja.
3. Mara hati ikiwa tayari, tutatoa amri "python setup.py py2exe". Hii itaunda kutekelezeka, kama ilivyo katika Figure 2.
```python
from distutils.core import setup
import py2exe, sys, os

sys.argv.append('py2exe')

setup(
options = {'py2exe': {'bundle_files': 1}},
#windows = [{'script': "hello.py"}],
console = [{'script': "hello.py"}],
zipfile = None,
)
```

```bash
C:\Users\test\Desktop\test>python setup.py py2exe
running py2exe
*** searching for required modules ***
*** parsing results ***
*** finding dlls needed ***
*** create binaries ***
*** byte compile python files ***
*** copy extensions ***
*** copy dlls ***
copying C:\Python27\lib\site-packages\py2exe\run.exe -> C:\Users\test\Desktop\test\dist\hello.exe
Adding python27.dll as resource to C:\Users\test\Desktop\test\dist\hello.exe
```
### Kujenga payload kwa kutumia PyInstaller:

1. Sakinisha PyInstaller kwa kutumia pip (pip install pyinstaller).
2. Baada ya hapo, tutatoa amri "pyinstaller -onefile hello.py" (kumbuka kuwa 'hello.py' ni payload yetu). Hii itajumuisha kila kitu katika faili moja ya kutekelezwa.
```
C:\Users\test\Desktop\test>pyinstaller --onefile hello.py
108 INFO: PyInstaller: 3.3.1
108 INFO: Python: 2.7.14
108 INFO: Platform: Windows-10-10.0.16299
‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶
5967 INFO: checking EXE
5967 INFO: Building EXE because out00-EXE.toc is non existent
5982 INFO: Building EXE from out00-EXE.toc
5982 INFO: Appending archive to EXE C:\Users\test\Desktop\test\dist\hello.exe
6325 INFO: Building EXE from out00-EXE.toc completed successfully.
```
## Marejeo

* [https://blog.f-secure.com/how-to-decompile-any-python-binary/](https://blog.f-secure.com/how-to-decompile-any-python-binary/)

<img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Ikiwa una nia ya **kazi ya udukuzi** na kudukua yasiyoweza kudukuliwa - **tunatafuta wafanyakazi!** (_uwezo wa kuandika na kuzungumza Kipolishi kwa ufasaha unahitajika_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Jifunze udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inayotangazwa katika HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
