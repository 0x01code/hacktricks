# パーティション/ファイルシステム/カービング

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手してください
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つけてください
- **Discordグループ**に**参加**する💬（https://discord.gg/hRep4RUj7f）または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**🐦で**フォロー**する[**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
- **HackTricks**（https://github.com/carlospolop/hacktricks）と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>

## パーティション

ハードドライブまたは**SSDディスクには、物理的にデータを分離するための異なるパーティションが含まれる**ことがあります。\
ディスクの**最小**単位は**セクタ**です（通常、512Bで構成されています）。したがって、各パーティションのサイズはそのサイズの倍数である必要があります。

### MBR（Master Boot Record）

これは、**ブートコードの446Bの後のディスクの最初のセクタに割り当てられています**。このセクタは、PCにパーティションをどこからどのようにマウントすべきかを示すために不可欠です。\
最大で**4つのパーティション**を許可します（**最大で1つ**がアクティブ/**ブート可能**）。ただし、より多くのパーティションが必要な場合は、**拡張パーティション**を使用できます。この最初のセクタの最後のバイトは、ブートレコードの署名**0x55AA**です。1つのパーティションだけがアクティブにマークされることができます。\
MBRは**最大2.2TB**を許可します。

![](<../../../.gitbook/assets/image (489).png>)

![](<../../../.gitbook/assets/image (490).png>)

MBRの**バイト440から443**には、（Windowsを使用している場合）**Windowsディスクシグネチャ**が含まれています。ハードディスクの論理ドライブレターは、Windowsディスクシグネチャに依存します。このシグネチャを変更すると、Windowsの起動が阻害される可能性があります（ツール：[**Active Disk Editor**](https://www.disk-editor.org/index.html)**)**。

![](<../../../.gitbook/assets/image (493).png>)

**フォーマット**

| オフセット    | 長さ       | アイテム           |
| ----------- | ---------- | ------------------- |
| 0 (0x00)    | 446(0x1BE) | ブートコード         |
| 446 (0x1BE) | 16 (0x10)  | 最初のパーティション  |
| 462 (0x1CE) | 16 (0x10)  | 2番目のパーティション |
| 478 (0x1DE) | 16 (0x10)  | 3番目のパーティション |
| 494 (0x1EE) | 16 (0x10)  | 4番目のパーティション |
| 510 (0x1FE) | 2 (0x2)    | シグネチャ 0x55 0xAA |

**パーティションレコードフォーマット**

| オフセット    | 長さ     | アイテム                                                   |
| --------- | -------- | ------------------------------------------------------ |
| 0 (0x00)  | 1 (0x01) | アクティブフラグ（0x80 = ブート可能）                          |
| 1 (0x01)  | 1 (0x01) | 開始ヘッド                                             |
| 2 (0x02)  | 1 (0x01) | 開始セクタ（ビット0-5）；シリンダーの上位ビット（6-7） |
| 3 (0x03)  | 1 (0x01) | 開始シリンダーの下位8ビット                           |
| 4 (0x04)  | 1 (0x01) | パーティションタイプコード（0x83 = Linux）                     |
| 5 (0x05)  | 1 (0x01) | 終了ヘッド                                               |
| 6 (0x06)  | 1 (0x01) | 終了セクタ（ビット0-5）；シリンダーの上位ビット（6-7）   |
| 7 (0x07)  | 1 (0x01) | 終了シリンダーの下位8ビット                             |
| 8 (0x08)  | 4 (0x04) | パーティションの前のセクタ数（リトルエンディアン）            |
| 12 (0x0C) | 4 (0x04) | パーティション内のセクタ数                                   |

LinuxでMBRをマウントするには、まず開始オフセットを取得する必要があります（`fdisk`と`p`コマンドを使用できます）

![](<../../../.gitbook/assets/image (413) (3) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (12).png>)

その後、次のコードを使用します。
```bash
#Mount MBR in Linux
mount -o ro,loop,offset=<Bytes>
#63x512 = 32256Bytes
mount -o ro,loop,offset=32256,noatime /path/to/image.dd /media/part/
```
**LBA（Logical block addressing）**

**Logical block addressing**（**LBA**）は、コンピュータのストレージデバイスに保存されているデータのブロックの場所を指定するために使用される一般的なスキームです。一般的に、ハードディスクドライブなどの二次記憶システムで使用されます。LBAは特にシンプルな線形アドレッシングスキームで、**ブロックは整数インデックスによって特定され**、最初のブロックはLBA 0、2番目はLBA 1、というようになります。

### GPT（GUID Partition Table）

GUID Partition Table、通称GPTは、MBR（Master Boot Record）と比較して拡張された機能を持つために好まれています。GPTの特徴は以下の通りです：

- **位置とサイズ**：GPTとMBRはどちらも**セクタ0**から開始します。ただし、GPTは**64ビット**で動作し、MBRの32ビットとは異なります。
- **パーティション制限**：GPTはWindowsシステムで最大**128個のパーティション**をサポートし、**9.4ZB**のデータを収容できます。
- **パーティション名**：最大36文字のUnicode文字でパーティションに名前を付ける機能を提供します。

**データの弾力性と回復**：

- **冗長性**：MBRとは異なり、GPTはパーティションとブートデータを単一の場所に制限しません。これらのデータをディスク全体に複製することで、データの整合性と弾力性を向上させます。
- **巡回冗長性チェック（CRC）**：GPTはデータの整合性を確保するためにCRCを使用します。データの破損を積極的に監視し、検出された場合、GPTは別のディスク位置から破損したデータを回復しようとします。

**保護MBR（LBA0）**：

- GPTは保護MBRを介して後方互換性を維持します。この機能は、レガシーMBRスペースに存在しますが、古いMBRベースのユーティリティが誤ってGPTディスクを上書きするのを防ぐように設計されており、それによりGPTフォーマットされたディスク上のデータの整合性を保護します。

![https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/GUID_Partition_Table_Scheme.svg/800px-GUID_Partition_Table_Scheme.svg.png](<../../../.gitbook/assets/image (491).png>)

**ハイブリッドMBR（LBA 0 + GPT）**

[Wikipediaより](https://en.wikipedia.org/wiki/GUID_Partition_Table)

BIOSを介した**GPTベースのブートをサポートするオペレーティングシステム**では、最初のセクタは**ブートローダー**コードの最初のステージを格納するために使用される場合がありますが、**GPTパーティション**を認識するように**変更**されます。 MBR内のブートローダーは、セクタサイズが512バイトであるとは仮定してはいけません。

**パーティションテーブルヘッダー（LBA 1）**

[Wikipediaより](https://en.wikipedia.org/wiki/GUID_Partition_Table)

パーティションテーブルヘッダーはディスク上の使用可能なブロックを定義します。また、パーティションテーブルを構成するパーティションエントリの数とサイズを定義します（テーブル内のオフセット80および84）。

| オフセット | 長さ | 内容                                                                                                                                                                        |
| --------- | ---- | ----------------------------------------------------------------------------------------------------------- |
| 0（0x00） | 8バイト | シグネチャ（「EFI PART」、リトルエンディアンマシン上の45h 46h 49h 20h 50h 41h 52h 54hまたは0x5452415020494645ULL[ ](https://en.wikipedia.org/wiki/GUID\_Partition\_Table#cite\_note-8)） |
| 8（0x08） | 4バイト | UEFI 2.8用のリビジョン1.0（00h 00h 01h 00h）                                                                                                                                     |
| 12（0x0C） | 4バイト | リトルエンディアンでのヘッダーサイズ（バイト単位、通常は5Ch 00h 00h 00hまたは92バイト）                                                                                                    |
| 16（0x10） | 4バイト | ヘッダーのCRC32（リトルエンディアンでオフセット+0からヘッダーサイズまで）                                                                                                                                      |
| 20（0x14） | 4バイト | 予約済み；ゼロである必要があります                                                                                                                                                          |
| 24（0x18） | 8バイト | 現在のLBA（このヘッダーコピーの場所）                                                                                                                                      |
| 32（0x20） | 8バイト | バックアップLBA（他のヘッダーコピーの場所）                                                                                                                                  |
| 40（0x28） | 8バイト | パーティションの最初の使用可能なLBA（プライマリパーティションテーブルの最後のLBA + 1）                                                                                                          |
| 48（0x30） | 8バイト | 最後の使用可能なLBA（セカンダリパーティションテーブルの最初のLBA − 1）                                                                                                                       |
| 56（0x38） | 16バイト | ミックスエンディアンのディスクGUID                                                                                                                                                       |
| 72（0x48） | 8バイト | パーティションエントリの配列の開始LBA（プライマリコピーでは常に2）                                                                                                        |
| 80（0x50） | 4バイト | 配列内のパーティションエントリの数                                                                                                                                            |
| 84（0x54） | 4バイト | 単一のパーティションエントリのサイズ（通常は80hまたは128）                                                                                                                           |
| 88（0x58） | 4バイト | パーティションエントリ配列のCRC32（リトルエンディアン）                                                                                                                               |
| 92（0x5C） | \*       | 残りのブロック用にゼロである必要がある予約領域（セクタサイズが512バイトの場合は420バイトですが、より大きなセクタサイズの場合はそれ以上になる可能性があります）                                         |

**パーティションエントリ（LBA 2–33）**

| GUIDパーティションエントリフォーマット |          |                                                                                                                   |
| --------------------------- | -------- | ----------------------------------------------------------------------------------------------------------------- |
| オフセット                      | 長さ   | 内容                                                                                                          |
| 0（0x00）                    | 16バイト | [パーティションタイプGUID](https://en.wikipedia.org/wiki/GUID\_Partition\_Table#Partition\_type\_GUIDs)（ミックスエンディアン） |
| 16（0x10）                   | 16バイト | ユニークなパーティションGUID（ミックスエンディアン）                                                                              |
| 32（0x20）                   | 8バイト  | 最初のLBA（[リトルエンディアン](https://en.wikipedia.org/wiki/Little\_endian)）                                         |
| 40（0x28）                   | 8バイト  | 最終LBA（包括的、通常は奇数）                                                                                 |
| 48（0x30）                   | 8バイト  | 属性フラグ（例：ビット60は読み取り専用を示す）                                                                   |
| 56（0x38）                   | 72バイト | パーティション名（36 [UTF-16](https://en.wikipedia.org/wiki/UTF-16)LEコードユニット）                                   |

**パーティションタイプ**

![](<../../../.gitbook/assets/image (492).png>)

[https://en.wikipedia.org/wiki/GUID\_Partition\_Table](https://en.wikipedia.org/wiki/GUID\_Partition\_Table)でさらに多くのパーティションタイプを確認できます。

### 検査

[**ArsenalImageMounter**](https://arsenalrecon.com/downloads/)を使用してフォレンジックイメージをマウントした後、Windowsツール[**Active Disk Editor**](https://www.disk-editor.org/index.html)**を使用して最初のセクタを検査**できます。次の画像では、**セクタ0**に**MBR**が検出され、解釈されています：

![](<../../../.gitbook/assets/image (494).png>)

もし**MBRの代わりにGPTテーブル**があれば、**セクタ1**に署名_EFI PART_が表示されるはずです（前の画像では空白です）。

## ファイルシステム

### Windowsファイルシステムリスト

* **FAT12/16**: MSDOS、WIN95/98/NT/200
* **FAT32**: 95/2000/XP/2003/VISTA/7/8/10
* **ExFAT**: 2008/2012/2016/VISTA/7/8/10
* **NTFS**: XP/2003/2008/2012/VISTA/7/8/10
* **ReFS**: 2012/2016

### FAT

**FAT（File Allocation Table）**ファイルシステムは、その中核コンポーネントであるファイル割り当てテーブルをボリュームの先頭に配置するように設計されています。このシステムは、テーブルの**2つのコピー**を維持することでデータの整合性を保護し、1つが破損してもデータの整合性を確保します。テーブルとルートフォルダは**固定の場所**になければならず、システムの起動プロセスには重要です。

ファイルシステムの基本的な記憶単位は、通常512Bの**クラスタ**で構成される複数のセクタです。FATは次のバージョンを経て進化してきました：

- **FAT12**：12ビットのクラスタアドレスをサポートし、最大4078クラスタ（UNIXを含めると4084クラスタ）を処理します。
- **FAT16**：16ビットアドレスに拡張され、最大65,517クラスタを収容できるようになりました。
- **FAT32**：32ビットアドレスにさらに進化し、ボリュームごとに驚異的な268,435,456クラスタを可能にしました。

FATバージョン全体での重要な制限は、ファイルサイズの格納に使用される32ビットフィールドによる**4GBの最大ファイルサイズ**です。

特にFAT12とFAT16のルートディレクトリの主要なコンポーネントには、次のものが含まれます：

- **ファイル/フォルダ名**（最大8文字）
- **属性**
- **作成、変更、最終アクセス日時**
- **FATテーブルアドレス**（ファイルの開始クラスタを示す）
- **ファイルサイズ**

### EXT

**Ext2**は、**ジャーナリングを行わない**パーティション（**あまり変更されないパーティション**）に最も一般的なファイルシステムです。**Ext3/4**は**ジャーナリング**であり、通常は**残りのパーティション**に使用されます。

## **メタデータ**

一部のファイルにはメタデータが含まれています。この情報はファイルの内容についてであり、ファイルタイプによっては、次のような情報が含まれることがあり、アナリストにとって興味深いかもしれません：

* タイトル
* 使用されたMS Officeバージョン
* 作成および最終変更日時
* カメラのモデル
* GPS座標
* 画像情報

ファイルのメタデータを取得するために、[**exiftool**](https://exiftool.org)や[**Metadiver**](https://www.easymetadata.com/metadiver-2/)などのツールを使用できます。

## **削除されたファイルの回復**

### ログされた削除されたファイル

以前に見られたように、ファイルが「削除」された後もファイルが保存されている場所がいくつかあります。これは通常、ファイルシステムからファイルを削除すると、ファイルが削除されたとマークされるが、データは触れられないためです。その後、ファイルの登録（MFTなど）を検査し、削除されたファイルを見つけることが可能です。

また、OSは通常、ファイルシステムの変更やバックアップに関する多くの情報を保存するため、ファイルを回復したり、可能な限り多くの情報を取得するためにそれらを使用することができます。

{% content-ref url="file-data-carving-recovery-tools.md" %}
[file-data-carving-recovery-tools.md](file-data-carving-recovery-tools.md)
{% endcontent-ref %}

### **ファイルカービング**

**ファイルカービング**は、データの塊からファイルを見つけようとする技術です。このようなツールが動作する主な方法には、**ファイルタイプのヘッダーとフッター**に基づく方法、ファイルタイプの**構造**に基づく方法、および**コンテンツ**自体に基づく方法があります。

この技術は、**断片化されたファイルを取得することはできません**。ファイルが**連続したセクタに保存されていない**場合、この技術はそれを
