# パーティション/ファイルシステム/カービング

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[Telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**@hacktricks_live**をフォローする
- **HackTricks**および**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

## パーティション

ハードドライブまたは**SSDディスクには、物理的にデータを分離するための異なるパーティションが含まれて**いる可能性があります。\
ディスクの**最小**単位は**セクタ**です（通常、512Bで構成されています）。したがって、各パーティションのサイズはそのサイズの倍数である必要があります。

### MBR（Master Boot Record）

これは、**ブートコードの446Bの後のディスクの最初のセクタに割り当てられて**います。このセクタは、PCにパーティションをどこからマウントすべきかを示すために不可欠です。\
最大で**4つのパーティション**を許可します（**最大で1つ**がアクティブ/**ブート可能**）。ただし、より多くのパーティションが必要な場合は、**拡張パーティション**を使用できます。この最初のセクタの最後のバイトは、ブートレコードの署名**0x55AA**です。1つのパーティションだけがアクティブにマークされます。\
MBRは**最大2.2TB**を許可します。

![](<../../../.gitbook/assets/image (489).png>)

![](<../../../.gitbook/assets/image (490).png>)

MBRの**バイト440から443**には、（Windowsを使用している場合）**Windowsディスクシグネチャ**が含まれています。ハードディスクの論理ドライブレターは、Windowsディスクシグネチャに依存します。このシグネチャを変更すると、Windowsの起動が阻害される可能性があります（ツール：[**Active Disk Editor**](https://www.disk-editor.org/index.html)**）**。

![](<../../../.gitbook/assets/image (493).png>)

**フォーマット**

| オフセット    | 長さ       | アイテム            |
| ----------- | ---------- | ------------------- |
| 0 (0x00)    | 446(0x1BE) | ブートコード         |
| 446 (0x1BE) | 16 (0x10)  | 第1パーティション     |
| 462 (0x1CE) | 16 (0x10)  | 第2パーティション     |
| 478 (0x1DE) | 16 (0x10)  | 第3パーティション     |
| 494 (0x1EE) | 16 (0x10)  | 第4パーティション     |
| 510 (0x1FE) | 2 (0x2)    | シグネチャ 0x55 0xAA |

**パーティションレコードフォーマット**

| オフセット    | 長さ       | アイテム                                                   |
| --------- | -------- | ------------------------------------------------------ |
| 0 (0x00)  | 1 (0x01) | アクティブフラグ（0x80 = ブート可能）                          |
| 1 (0x01)  | 1 (0x01) | 開始ヘッド                                             |
| 2 (0x02)  | 1 (0x01) | 開始セクタ（ビット0-5）；シリンダーの上位ビット（6-7） |
| 3 (0x03)  | 1 (0x01) | 開始シリンダーの下位8ビット                           |
| 4 (0x04)  | 1 (0x01) | パーティションタイプコード（0x83 = Linux）                     |
| 5 (0x05)  | 1 (0x01) | 終了ヘッド                                               |
| 6 (0x06)  | 1 (0x01) | 終了セクタ（ビット0-5）；シリンダーの上位ビット（6-7）   |
| 7 (0x07)  | 1 (0x01) | 終了シリンダーの下位8ビット                             |
| 8 (0x08)  | 4 (0x04) | パーティションの前のセクタ数（リトルエンディアン）            |
| 12 (0x0C) | 4 (0x04) | パーティション内のセクタ数                                   |

LinuxでMBRをマウントするには、まず開始オフセットを取得する必要があります（`fdisk`と`p`コマンドを使用できます）

![](<../../../.gitbook/assets/image (413) (3) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (12).png>)

その後、次のコードを使用します。
```bash
#Mount MBR in Linux
mount -o ro,loop,offset=<Bytes>
#63x512 = 32256Bytes
mount -o ro,loop,offset=32256,noatime /path/to/image.dd /media/part/
```
**LBA（Logical block addressing）**

**Logical block addressing**（**LBA**）は、コンピュータの記憶装置に保存されているデータのブロックの場所を指定するために使用される一般的なスキームです。一般的にはハードディスクドライブなどの二次記憶システムで使用されます。LBAは特にシンプルな線形アドレッシングスキームで、**ブロックは整数インデックスによって特定され**、最初のブロックはLBA 0、2番目はLBA 1、というようになります。

### GPT（GUID Partition Table）

これは、ドライブ上の各パーティションに**グローバルに一意な識別子**があるため、GUID Partition Tableと呼ばれます。

MBRと同様に、**セクタ0**から始まります。 MBRは32ビットを占有していますが、**GPT**は**64ビット**を使用します。\
GPTでは、Windowsでは最大**128個のパーティション**を許可し、最大**9.4ZB**までの容量をサポートしています。\
また、パーティションには36文字のUnicode名を持たせることができます。

MBRディスクでは、パーティショニングとブートデータが1か所に保存されます。このデータが上書きされたり破損した場合、問題が発生します。これに対して、**GPTはディスク全体にこのデータの複数のコピーを保存**するため、はるかに堅牢で、データが破損した場合でも回復できます。

GPTはまた、データが整合性を持つかどうかを確認するために**巡回冗長検査（CRC）**値を保存します。データが破損している場合、GPTは問題に気付き、ディスク上の別の場所から**破損したデータを回復しようとします**。

**保護MBR（LBA0）**

過去の互換性のために、GPT仕様では従来のMBRの領域が予約されていますが、これはMBRベースのディスクユーティリティがGPTディスクを誤認識して誤って上書きするのを防ぐ**方法で使用**されています。これを保護MBRと呼びます。

![](<../../../.gitbook/assets/image (491).png>)

**ハイブリッドMBR（LBA 0 + GPT）**

BIOSサービスを介して**GPTベースのブートをサポート**するオペレーティングシステムでは、最初のセクタを**ブートローダー**コードの最初のステージを保存するために使用することがありますが、**変更**して**GPTパーティション**を認識できるようにします。 MBR内のブートローダーは、512バイトのセクタサイズを前提としてはいけません。

**パーティションテーブルヘッダー（LBA 1）**

パーティションテーブルヘッダーはディスク上の使用可能なブロックを定義します。また、パーティションテーブルを構成するパーティションエントリの数とサイズを定義します（テーブル内のオフセット80と84）。

| オフセット | 長さ | 内容                                                                                                                                                                        |
| --------- | ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0（0x00） | 8バイト | シグネチャ（リトルエンディアンマシン上の「EFI PART」、45h 46h 49h 20h 50h 41h 52h 54hまたは0x5452415020494645ULL[ ](https://en.wikipedia.org/wiki/GUID\_Partition\_Table#cite\_note-8)） |
| 8（0x08） | 4バイト | UEFI 2.8用のリビジョン1.0（00h 00h 01h 00h）                                                                                                                               |
| 12（0x0C） | 4バイト | ヘッダーサイズ（リトルエンディアンでのバイト単位、通常は5Ch 00h 00h 00hまたは92バイト）                                                                                     |
| 16（0x10） | 4バイト | ヘッダーのCRC32（オフセット+0からヘッダーサイズまで）のリトルエンディアンでの値。このフィールドは計算中にゼロになります。                                           |
| 20（0x14） | 4バイト | 予約済み。ゼロである必要があります                                                                                                                                      |
| 24（0x18） | 8バイト | 現在のLBA（このヘッダーコピーの場所）                                                                                                                                   |
| 32（0x20） | 8バイト | バックアップLBA（他のヘッダーコピーの場所）                                                                                                                               |
| 40（0x28） | 8バイト | パーティションの最初の使用可能なLBA（プライマリパーティションテーブルの最後のLBA+1）                                                                                     |
| 48（0x30） | 8バイト | 最後の使用可能なLBA（セカンダリパーティションテーブルの最初のLBA−1）                                                                                                      |
| 56（0x38） | 16バイト | ミックスエンディアン形式のディスクGUID                                                                                                                                    |
| 72（0x48） | 8バイト | パーティションエントリの配列の開始LBA（プライマリコピーでは常に2）                                                                                                        |
| 80（0x50） | 4バイト | 配列内のパーティションエントリの数                                                                                                                                       |
| 84（0x54） | 4バイト | 単一のパーティションエントリのサイズ（通常は80hまたは128）                                                                                                                  |
| 88（0x58） | 4バイト | パーティションエントリ配列のCRC32（リトルエンディアン）                                                                                                                      |
| 92（0x5C） | \* | 残りのブロック用にゼロである必要がある予約領域（セクタサイズが512バイトの場合は420バイトですが、より大きなセクタサイズの場合はそれ以上になる可能性があります） |

**パーティションエントリ（LBA 2–33）**

| GUIDパーティションエントリ形式 |          |                                                                                                                 |
| --------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------- |
| オフセット                      | 長さ   | 内容                                                                                                            |
| 0（0x00）                    | 16バイト | [パーティションタイプGUID](https://en.wikipedia.org/wiki/GUID\_Partition\_Table#Partition\_type\_GUIDs)（ミックスエンディアン） |
| 16（0x10）                   | 16バイト | ユニークなパーティションGUID（ミックスエンディアン）                                                               |
| 32（0x20）                   | 8バイト  | 最初のLBA（[リトルエンディアン](https://en.wikipedia.org/wiki/Little\_endian)）                                         |
| 40（0x28）                   | 8バイト  | 最後のLBA（包括的、通常は奇数）                                                                                     |
| 48（0x30）                   | 8バイト  | 属性フラグ（例：ビット60は読み取り専用を示す）                                                                       |
| 56（0x38）                   | 72バイト | パーティション名（36 [UTF-16](https://en.wikipedia.org/wiki/UTF-16)LEコードユニット）                                   |

**パーティションタイプ**

![](<../../../.gitbook/assets/image (492).png>)

詳細なパーティションタイプは[https://en.wikipedia.org/wiki/GUID\_Partition\_Table](https://en.wikipedia.org/wiki/GUID\_Partition\_Table)で確認できます。

### 検査

[**ArsenalImageMounter**](https://arsenalrecon.com/downloads/)を使用してフォレンジックイメージをマウントした後、Windowsツール[**Active Disk Editor**](https://www.disk-editor.org/index.html)**を使用して最初のセクタを検査**できます。次の画像では、**セクタ0**に**MBR**が検出され、解釈されています：

![](<../../../.gitbook/assets/image (494).png>)

もし**MBRの代わりにGPTテーブル**があれば、**セクタ1**にシグネチャ_EFI PART_が表示されるはずです（前の画像では空白です）。

## ファイルシステム

### Windowsファイルシステムリスト

* **FAT12/16**: MSDOS、WIN95/98/NT/200
* **FAT32**: 95/2000/XP/2003/VISTA/7/8/10
* **ExFAT**: 2008/2012/2016/VISTA/7/8/10
* **NTFS**: XP/2003/2008/2012/VISTA/7/8/10
* **ReFS**: 2012/2016

### FAT

**FAT（File Allocation Table）**ファイルシステムは、その組織方法であるファイル割り当てテーブルにちなんで名付けられています。このテーブルはボリュームの先頭にあり、ボリュームを保護するためにテーブルの**2つのコピー**が保持されています。さらに、ファイル割り当てテーブルとルートフォルダは**固定された位置**に保存されている必要があります。これにより、システムを起動するために必要なファイルが正しく位置付けられます。

![](<../../../.gitbook/assets/image (495).png>)

このファイルシステムで使用される最小の空間単位は**クラスタ**であり、通常は512Bです（複数のセクタで構成されています）。

以前の**FAT12**は、最大**4078**の**クラスタ**までの12ビット値のクラスタアドレスを持ち、UNIXでは4084のクラスタまで許可していました。より効率的な**FAT16**は、最大**65,517のクラスタ**を許可する16ビットのクラスタアドレスを使用しています。FAT32は、最大**268,435,456のクラスタ**を許可する32ビットのクラスタアドレスを使用しています。

FATが許可する**最大ファイルサイズは4GB**（1バイトを引いた値）です。これは、ファイルシステムがファイルサイズをバイト単位で保存するために32ビットフィールドを使用しており、2^32バイト = 4 GiBになるためです。これはFAT12、FAT16、FAT32の場合に該当します。

**ルートディレクトリ**は、FAT12とFAT16の両方で**特定の位置**を占有しています（FAT32では他のフォルダと同様の位置を占有しています）。各ファイル/フォルダエントリには、次の情報が含まれています：

* ファイル/フォルダの名前（最大8文字）
* 属性
* 作成日
* 変更日
* 最終アクセス日
* ファイルの開始クラスタが格納されているFATテーブルのアドレス
* サイズ

FATファイルシステムを使用してファイルが「削除」されると、ディレクトリエントリは**ほとんど変更されず**に残りますが、ファイル名の**最初の文字**が変更されて（0xE5に変更）、「削除された」ファイルの名前の大部分、タイムスタンプ、ファイルの長さ、そして重要なのはディスク上の物理的な場所が保存されます。ただし、ファイルが占有するディスククラスタのリストは、その後に作成または変更された他のファイルによって使用可能になるように、ファイル割り当てテーブルから消去されます。 FAT32の場合、ファイルの開始クラスタ値の上位16ビットを担当する消去されたフィールドが追加されます。

### **NTFS**

{% content-ref url="ntfs.md" %}
[ntfs.md](ntfs.md)
{% endcontent-ref %}

### EXT

**Ext2**は**ジャーナリングを行わない**パーティション（**あまり変更されないパーティション**）に最も一般的なファイルシステムです。**Ext3/4**は**ジャーナリング**を行い、通常は**残りのパーティション**に使用されます。

{% content-ref url="ext.md" %}
[ext.md](ext.md)
{% endcontent-ref %}

## **メタデータ**

一部のファイルにはメタデータが含まれています。この情報はファイルの内容についてであり、ファイルの種類によっては、次のような情報が含まれることがあります：

* タイトル
* 使用されたMS Officeバージョン
* 作成日と最終変更日
* カメラのモデル
* GPS座標
* 画像情報

ファイルのメタデータを取得するために、[**exiftool**](https://exiftool.org)や[**Metadiver**](https://www.easymetadata.com/metadiver-2/)などのツールを使用できます。

## **削除されたファイルの回復**

### ログされた削除されたファイル

以前に見たように、ファイルが「削除」された後もファイルが保存されている場所がいくつかあります。通常、ファイルシステムからファイルを削除すると、ファイルは削除されたとマークされますが、データは変更されません。その後、ファイルの登録（MFTなど）を検査し、削除されたファイルを
