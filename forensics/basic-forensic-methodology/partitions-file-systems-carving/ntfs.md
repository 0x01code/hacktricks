# NTFS

## NTFS

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **ハッキングのコツを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出する。

</details>

## **NTFS**

**NTFS**（**New Technology File System**）は、Microsoftによって開発された独自のジャーナリングファイルシステムです。

クラスタはNTFSの最小サイズ単位であり、クラスタのサイズはパーティションのサイズに依存します。

| パーティションサイズ           | クラスタあたりのセクター | クラスタサイズ |
| ------------------------ | ------------------- | ------------ |
| 512MB以下            | 1                   | 512バイト    |
| 513MB-1024MB (1GB)       | 2                   | 1KB          |
| 1025MB-2048MB (2GB)      | 4                   | 2KB          |
| 2049MB-4096MB (4GB)      | 8                   | 4KB          |
| 4097MB-8192MB (8GB)      | 16                  | 8KB          |
| 8193MB-16,384MB (16GB)   | 32                  | 16KB         |
| 16,385MB-32,768MB (32GB) | 64                  | 32KB         |
| 32,768MB超          | 128                 | 64KB         |

### **スラックスペース**

NTFSの最小サイズ単位は**クラスタ**です。各ファイルは複数の完全なクラスタを占有します。そのため、**各ファイルが必要以上のスペースを占有する可能性が高い**です。これらの**未使用の** **スペース**はファイルによって**予約されている**もので、**スラッキング** **スペース**と呼ばれ、人々はこの領域を利用して**情報を隠す**ことができます。

![](<../../../.gitbook/assets/image (498).png>)

### **NTFSブートセクタ**

NTFSボリュームをフォーマットすると、フォーマットプログラムはブートメタデータファイル用に最初の16セクタを割り当てます。最初のセクタは"bootstrap"コードを含むブートセクタで、次の15セクタはブートセクタのIPL（Initial Program Loader）です。ファイルシステムの信頼性を高めるために、NTFSパーティションの最後のセクタにはブートセクタのスペアコピーが含まれています。

### **マスターファイルテーブル（MFT）**

NTFSファイルシステムにはマスターファイルテーブル（MFT）と呼ばれるファイルが含まれています。NTFSファイルシステムボリューム上のすべてのファイルには、MFT自体を含め、少なくとも**MFTに1つのエントリがあります**。ファイルに関するすべての情報、**サイズ、タイムスタンプ、権限、データ内容**などは、MFTエントリ内またはMFTエントリによって記述されたMFT外のスペース内に格納されます。

NTFSファイルシステムボリュームに**ファイルが追加される**と、MFTに新しいエントリが追加され、**MFTのサイズが増加します**。NTFSファイルシステムボリュームから**ファイルが削除される**と、それらの**MFTエントリは空きとしてマークされ**、再利用される可能性があります。しかし、これらのエントリに割り当てられたディスクスペースは再割り当てされず、MFTのサイズは減少しません。

NTFSファイルシステムは、成長するにつれてMFTをできるだけ連続した状態に保つために、MFT用のスペースを**予約します**。各ボリュームのNTFSファイルシステムによって予約されたMFTのスペースは、**MFTゾーン**と呼ばれます。ファイルやディレクトリのスペースもこのスペースから割り当てられますが、MFTゾーン外のボリュームスペースがすべて割り当てられた後にのみ割り当てられます。

平均ファイルサイズやその他の変数に応じて、**予約されたMFTゾーンまたは予約されていないディスク上のスペースが、ディスクが満杯になるにつれて最初に割り当てられる**ことがあります。比較的大きなファイルが少ないボリュームは、最初に予約されていないスペースを割り当てますが、比較的小さなファイルが多いボリュームは、最初にMFTゾーンを割り当てます。いずれの場合も、一方または他方の領域が完全に割り当てられると、MFTの断片化が始まります。予約されていないスペースが完全に割り当てられた場合、ユーザーファイルとディレクトリのスペースはMFTゾーンから割り当てられます。MFTゾーンが完全に割り当てられた場合、新しいMFTエントリのスペースは予約されていないスペースから割り当てられます。

NTFSファイルシステムはまた、**$MFTMirror**を生成します。これはMFTの**最初の4エントリ**の**コピー**です：$MFT、$MFT Mirror、$Log、$Volume。

NTFSはテーブルの最初の16レコードを特別な情報用に予約しています：

| システムファイル           | ファイル名 | MFTレコード | ファイルの目的                                                                                                                                                                                                           |
| --------------------- | --------- | ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| マスターファイルテーブル     | $Mft      | 0          | NTFSボリューム上の各ファイルとフォルダに対して1つの基本ファイルレコードが含まれています。ファイルまたはフォルダの割り当て情報が単一のレコードに収まらない場合、他のファイルレコードが割り当てられます。            |
| マスターファイルテーブル2   | $MftMirr  | 1          | MFTの最初の4レコードの複製イメージです。このファイルは単一セクターの障害が発生した場合にMFTへのアクセスを保証します。                                                                                            |
| ログファイル              | $LogFile  | 2          | NTFSの回復性のために使用されるトランザクションステップのリストが含まれています。ログファイルのサイズはボリュームサイズに依存し、最大4MBになることがあります。Windows NT/2000ではシステム障害後にNTFSの整合性を復元するために使用されます。 |
| ボリューム                | $Volume   | 3          | ボリュームラベルやボリュームバージョンなど、ボリュームに関する情報が含まれています。                                                                                                                                       |
| 属性定義 | $AttrDef  | 4          | 属性名、番号、および説明のテーブル。                                                                                                                                                                        |
| ルートファイル名インデックス  | $         | 5          | ルートフォルダ。                                                                                                                                                                                                              |
| クラスタビットマップ        | $Bitmap   | 6          | 使用中のクラスタを示すボリュームの表現。                                                                                                                                                             |
| ブートセクタ           | $Boot     | 7          | ボリュームをマウントするために使用されるBPBと、ボリュームがブータブルである場合に使用される追加のブートストラップローダーコードが含まれています。                                                                                                                |
| バッドクラスタファイル      | $BadClus  | 8          | ボリュームのバッドクラスタが含まれています。                                                                                                                                                                                         |
| セキュリティファイル         | $Secure   | 9          | ボリューム内のすべてのファイルに対するユニークなセキュリティ記述子が含まれています。                                                                                                                                                           |
| アップケーステーブル          | $Upcase   | 10         | 小文字を対応するUnicode大文字に変換します。                                                                                                                                                       |
| NTFS拡張ファイル   | $Extend   | 11         | クォータ、リパースポイントデータ、オブジェクト識別子など、さまざまなオプショナル拡張に使用されます。                                                                                                                              |
|                       |           | 12-15      | 将来の使用のために予約されています。                                                                                                                                                                                                      |
| クォータ管理ファイル | $Quota    | 24         | ボリュームスペースに対するユーザー割り当てクォータ制限が含まれています。                                                                                                                                                                      |
| オブジェクトIDファイル        | $ObjId    | 25         | ファイルオブジェクトIDが含まれています。                                                                                                                                                                                                     |
| リパースポイントファイル    | $Reparse  | 26         | ボリューム上のファイルとフォルダに関する情報が含まれており、リパースポイントデータを含みます。                                                                                                                            |

### MFTの各エントリは以下のようになります：

![](<../../../.gitbook/assets/image (499).png>)

各エントリが"FILE"で始まることに注意してください。各エントリは1024ビットを占めます。したがって、MFTエントリの開始から1024ビット後に次のエントリが見つかります。

[**Active Disk Editor**](https://www.disk-editor.org/index.html)を使用すると、MFT内のファイルのエントリを簡単に調べることができます。ファイルを右クリックしてから"Inspect File Record"をクリックします。

![](<../../../.gitbook/assets/image (500).png>)

![](<../../../.gitbook/assets/image (501).png>)

**"In use"**フラグをチェックすると、ファイルが削除されたかどうかが非常に簡単にわかります（**0x0は削除されたことを意味します**）。

![](<../../../.gitbook/assets/image (510).png>)

FTKImagerを使用して削除されたファイルを復元することも可能です：

![](<../../../.gitbook/assets/image (502).png>)

### MFT属性

各MFTエントリには、以下の画像が示すようにいくつかの属性があります：

![](<../../../.gitbook/assets/image (506).png>)

各属性は、タイプによって識別されるいくつかのエントリ情報を示します：

| タイプ識別子 | 名前                     | 説明                                                                                                       |
| --------------- | ------------------------ | ----------------------------------------------------------------------------------------------------------------- |
| 16              | $STANDARD\_INFORMATION   | フラグ、最終アクセス、書き込み、作成日時、所有者、セキュリティIDなどの一般情報。 |
| 32              | $ATTRIBUTE\_LIST         | ファイルの他の属性が見つかる場所のリスト。                                                              |
| 48              | $FILE\_NAME              | Unicodeでのファイル名、最終アクセス、書き込み、作成日時。                                         |
| 64              | $VOLUME\_VERSION         | ボリューム情報。バージョン1.2（Windows NT）でのみ存在します。                                                      |
| 64              | $OBJECT\_ID              | ファイルまたはディレクトリに対する16バイトの一意の識別子。バージョン3.0+以降（Windows 2000+）でのみ存在します。    |
| 80              | $SECURITY\_ DESCRIPTOR   | ファイルのアクセス制御とセキュリティプロパティ。                                                           |
| 96              | $VOLUME\_NAME            | ボリューム名。                                                                                                      |
| 112             | $VOLUME\_ INFORMATION    | ファイルシステムバージョンとその他のフラグ。                                                                              |
| 128             | $DATA                    | ファイルの内容。                                                                                                    |
| 144             | $INDEX\_ROOT             | インデックスツリーのルートノード。                                                                                       |
| 160             | $INDEX\_ALLOCATION       | $INDEX\_ROOT属性に根ざしたインデックスツリーのノード。                                                          |
| 176
