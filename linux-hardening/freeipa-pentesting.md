# Teste de Penetra√ß√£o no FreeIPA

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

O FreeIPA √© uma **alternativa** de c√≥digo aberto ao **Active Directory** da Microsoft, principalmente para ambientes **Unix**. Ele combina um diret√≥rio **LDAP completo** com um Centro de Distribui√ß√£o de Chaves MIT **Kerberos** para gerenciamento semelhante ao Active Directory. Utilizando o Sistema de Certificados Dogtag para gerenciamento de certificados CA & RA, ele suporta autentica√ß√£o **multi-fator**, incluindo cart√µes inteligentes. O SSSD √© integrado para processos de autentica√ß√£o Unix.

## Impress√µes Digitais

### Arquivos e Vari√°veis de Ambiente

* O arquivo em `/etc/krb5.conf` √© onde as informa√ß√µes do cliente Kerberos, necess√°rias para a inscri√ß√£o no dom√≠nio, s√£o armazenadas. Isso inclui as localiza√ß√µes dos KDCs e servidores de administra√ß√£o, configura√ß√µes padr√£o e mapeamentos.
* As configura√ß√µes padr√£o do sistema para clientes e servidores IPA s√£o definidas no arquivo localizado em `/etc/ipa/default.conf`.
* Os hosts dentro do dom√≠nio devem ter um arquivo `krb5.keytab` em `/etc/krb5.keytab` para processos de autentica√ß√£o.
* V√°rias vari√°veis de ambiente (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) s√£o usadas para apontar para arquivos espec√≠ficos e configura√ß√µes relevantes para autentica√ß√£o Kerberos.

### Bin√°rios

Ferramentas como `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` e `kvno` s√£o essenciais para gerenciar dom√≠nios FreeIPA, lidar com tickets Kerberos, alterar senhas e adquirir tickets de servi√ßo, entre outras funcionalidades.

### Rede

Uma ilustra√ß√£o √© fornecida para representar uma configura√ß√£o t√≠pica de servidor FreeIPA.

## Autentica√ß√£o

A autentica√ß√£o no FreeIPA, aproveitando o **Kerberos**, espelha a do **Active Directory**. O acesso a recursos do dom√≠nio requer um ticket Kerberos v√°lido, que pode ser armazenado em v√°rios locais, dependendo da configura√ß√£o do dom√≠nio FreeIPA.

### Arquivos de Ticket CCACHE

Os arquivos CCACHE, armazenados tipicamente em **`/tmp`** com permiss√µes **600**, s√£o formatos bin√°rios para armazenar credenciais Kerberos, importantes para autentica√ß√£o sem a senha em texto simples do usu√°rio devido √† sua portabilidade. Analisar um ticket CCACHE pode ser feito usando o comando `klist`, e reutilizar um Ticket CCACHE v√°lido envolve exportar `KRB5CCNAME` para o caminho do arquivo de ticket.

### Chaveiro Unix

Alternativamente, os Tickets CCACHE podem ser armazenados no chaveiro do Linux, oferecendo mais controle sobre o gerenciamento de tickets. O escopo de armazenamento de tickets varia (`KEYRING:nome`, `KEYRING:processo:nome`, `KEYRING:thread:nome`, `KEYRING:sess√£o:nome`, `KEYRING:persistente:uidn√∫mero`), com `klist` capaz de analisar essas informa√ß√µes para o usu√°rio. No entanto, reutilizar um Ticket CCACHE do chaveiro Unix pode apresentar desafios, com ferramentas como **Tickey** dispon√≠veis para extrair tickets Kerberos.

### Keytab

Arquivos Keytab, contendo princ√≠pios Kerberos e chaves criptografadas, s√£o cr√≠ticos para obter tickets de concess√£o de tickets (TGT) v√°lidos sem precisar da senha do princ√≠pio. Analisar e reutilizar credenciais de arquivos Keytab pode ser facilmente realizado com utilit√°rios como `klist` e scripts como **KeytabParser**.

### Cheatsheet

Voc√™ pode encontrar mais informa√ß√µes sobre como usar tickets no Linux no seguinte link:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumera√ß√£o

{% hint style="warning" %}
Voc√™ pode realizar a **enumera√ß√£o** via **ldap** e outras **ferramentas bin√°rias**, ou **conectando-se √† p√°gina da web na porta 443 do servidor FreeIPA**.
{% endhint %}

### Hosts, Usu√°rios e Grupos <a href="#id-4b3b" id="id-4b3b"></a>

√â poss√≠vel criar **hosts**, **usu√°rios** e **grupos**. Hosts e usu√°rios s√£o classificados em cont√™ineres chamados "**Grupos de Hosts**" e "**Grupos de Usu√°rios**" respectivamente. Esses s√£o semelhantes √†s **Unidades Organizacionais** (OU).

Por padr√£o no FreeIPA, o servidor LDAP permite **liga√ß√µes an√¥nimas**, e uma grande quantidade de dados √© enumer√°vel **n√£o autenticada**. Isso pode enumerar todos os dados dispon√≠veis n√£o autenticados:
```
ldapsearch -x
```
Para obter **mais informa√ß√µes**, voc√™ precisa usar uma sess√£o **autenticada** (verifique a se√ß√£o de Autentica√ß√£o para aprender como preparar uma sess√£o autenticada).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
A partir de uma m√°quina integrada ao dom√≠nio, voc√™ poder√° usar **bin√°rios instalados** para enumerar o dom√≠nio:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
O usu√°rio **admin** do **FreeIPA** √© equivalente aos **administradores de dom√≠nio** do **AD**.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

O usu√°rio **root** do **servidor IPA** tem acesso aos **hashes** de senha.

- O hash da senha de um usu√°rio √© armazenado como **base64** no atributo "**userPassword**". Esse hash pode ser **SSHA512** (vers√µes antigas do FreeIPA) ou **PBKDF2\_SHA256**.
- O **Nthash** da senha √© armazenado como **base64** em "**ipaNTHash**" se o sistema tiver **integra√ß√£o** com o **AD**.

Para quebrar esses hashes:

- Se o FreeIPA estiver integrado com o AD, o **ipaNTHash** √© f√°cil de quebrar: Voc√™ deve **decodificar** o **base64** -> re-codific√°-lo como **hexadecimal ASCII** -> John The Ripper ou **hashcat** podem ajudar a quebr√°-lo rapidamente.

- Se uma vers√£o antiga do FreeIPA for usada, ent√£o o **SSHA512** √© usado: Voc√™ deve decodificar o **base64** -> encontrar o **hash SSHA512** -> John The Ripper ou **hashcat** podem ajudar a quebr√°-lo.

- Se uma nova vers√£o do FreeIPA for usada, ent√£o o **PBKDF2\_SHA256** √© usado: Voc√™ deve decodificar o **base64** -> encontrar o PBKDF2\_SHA256 -> seu **comprimento** √© de 256 bytes. O John pode trabalhar com 256 bits (32 bytes) -> SHA-265 √© usado como a fun√ß√£o pseudo-aleat√≥ria, o tamanho do bloco √© de 32 bytes -> voc√™ pode usar apenas os primeiros 256 bits do nosso hash PBKDF2\_SHA256 -> John The Ripper ou hashcat podem ajudar a quebr√°-lo.

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Para extrair os hashes, voc√™ precisa ser **root no servidor FreeIPA**, l√° voc√™ pode usar a ferramenta **`dbscan`** para extra√≠-los:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### Regras HBAC <a href="#id-482b" id="id-482b"></a>

S√£o regras que concedem permiss√µes espec√≠ficas a usu√°rios ou hosts sobre recursos (hosts, servi√ßos, grupos de servi√ßos...).
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Regras do Sudo

O FreeIPA permite controle centralizado sobre as **permiss√µes do sudo** via regras do sudo. Essas regras permitem ou limitam a execu√ß√£o de comandos com sudo em hosts dentro do dom√≠nio. Um atacante poderia potencialmente identificar os hosts aplic√°veis, usu√°rios e comandos permitidos examinando esses conjuntos de regras.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Controle de Acesso Baseado em Fun√ß√£o

Um **papel** √© composto por v√°rios **privil√©gios**, cada um dos quais engloba uma cole√ß√£o de **permiss√µes**. Esses pap√©is podem ser atribu√≠dos a Usu√°rios, **Grupos** de Usu√°rios, **Hosts**, Grupos de Hosts e Servi√ßos. Por exemplo, considere o papel padr√£o de "Administrador de Usu√°rio" no FreeIPA para exemplificar essa estrutura.

O papel `Administrador de Usu√°rio` possui esses privil√©gios:

- **Administradores de Usu√°rios**
- **Administradores de Grupos**
- **Administradores de Usu√°rios de Est√°gio**

Com os seguintes comandos √© poss√≠vel enumerar os pap√©is, privil√©gios e permiss√µes:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Exemplo de Cen√°rio de Ataque

Em [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) voc√™ pode encontrar um exemplo simples de como abusar de algumas permiss√µes para comprometer o dom√≠nio.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~Cria√ß√£o de usu√°rio root~~

{% hint style="warning" %}
Se voc√™ puder **criar um novo usu√°rio com o nome `root`**, voc√™ pode se passar por ele e ser√° capaz de **fazer SSH em qualquer m√°quina como root.**

**ISSO FOI CORRIGIDO.**
{% endhint %}

Voc√™ pode conferir uma explica√ß√£o detalhada em [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Refer√™ncias

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
