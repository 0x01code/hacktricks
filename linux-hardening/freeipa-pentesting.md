# Pentesting de FreeIPA

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci√≥n B√°sica

FreeIPA es una **alternativa** de c√≥digo abierto a Microsoft Windows **Active Directory**, principalmente para entornos **Unix**. Combina un directorio **LDAP completo** con un Centro de Distribuci√≥n de Claves MIT **Kerberos** para la gesti√≥n similar a Active Directory. Utiliza el Sistema de Certificados Dogtag para la gesti√≥n de certificados CA y RA, admite autenticaci√≥n **multifactor**, incluidas tarjetas inteligentes. SSSD est√° integrado para procesos de autenticaci√≥n de Unix.

## Huellas Digitales

### Archivos y Variables de Entorno

- El archivo en `/etc/krb5.conf` es donde se almacena la informaci√≥n del cliente Kerberos, necesaria para la inscripci√≥n en el dominio. Esto incluye las ubicaciones de los KDC y servidores de administraci√≥n, configuraciones predeterminadas y asignaciones.
- Las configuraciones predeterminadas del sistema para clientes y servidores IPA se establecen en el archivo ubicado en `/etc/ipa/default.conf`.
- Los hosts dentro del dominio deben tener un archivo `krb5.keytab` en `/etc/krb5.keytab` para procesos de autenticaci√≥n.
- Se utilizan varias variables de entorno (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) para apuntar a archivos espec√≠ficos y configuraciones relevantes para la autenticaci√≥n de Kerberos.

### Binarios

Herramientas como `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` y `kvno` son fundamentales para administrar dominios FreeIPA, manejar tickets de Kerberos, cambiar contrase√±as y adquirir tickets de servicio, entre otras funcionalidades.

### Red

Se proporciona una ilustraci√≥n para representar una configuraci√≥n t√≠pica del servidor FreeIPA.

## Autenticaci√≥n

La autenticaci√≥n en FreeIPA, aprovechando **Kerberos**, refleja la de **Active Directory**. El acceso a los recursos del dominio requiere un ticket Kerberos v√°lido, que puede almacenarse en varias ubicaciones dependiendo de la configuraci√≥n del dominio FreeIPA.

### Archivos de Tickets CCACHE

Los archivos CCACHE, almacenados t√≠picamente en **`/tmp`** con permisos **600**, son formatos binarios para almacenar credenciales de Kerberos, importantes para la autenticaci√≥n sin la contrase√±a en texto plano del usuario debido a su portabilidad. Analizar un ticket CCACHE se puede hacer utilizando el comando `klist`, y reutilizar un ticket CCACHE v√°lido implica exportar `KRB5CCNAME` a la ruta del archivo del ticket.

### Llavero de Unix

Alternativamente, los Tickets CCACHE se pueden almacenar en el llavero de Linux, ofreciendo m√°s control sobre la gesti√≥n de tickets. El alcance del almacenamiento de tickets var√≠a (`KEYRING:nombre`, `KEYRING:proceso:nombre`, `KEYRING:hilo:nombre`, `KEYRING:sessi√≥n:nombre`, `KEYRING:persistent:uidn√∫mero`), con `klist` capaz de analizar esta informaci√≥n para el usuario. Sin embargo, reutilizar un Ticket CCACHE desde el llavero de Unix puede plantear desaf√≠os, con herramientas como **Tickey** disponibles para extraer tickets de Kerberos.

### Keytab

Los archivos Keytab, que contienen principios de Kerberos y claves encriptadas, son cr√≠ticos para obtener tickets de concesi√≥n de tickets (TGT) v√°lidos sin necesidad de la contrase√±a del principio. Analizar y reutilizar credenciales de archivos Keytab se puede realizar f√°cilmente con utilidades como `klist` y scripts como **KeytabParser**.

### Hoja de Trucos

Puedes encontrar m√°s informaci√≥n sobre c√≥mo usar tickets en Linux en el siguiente enlace:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeraci√≥n

{% hint style="warning" %}
Podr√≠as realizar la **enumeraci√≥n** a trav√©s de **ldap** y otras **herramientas binarias**, o **conect√°ndote a la p√°gina web en el puerto 443 del servidor FreeIPA**.
{% endhint %}

### Hosts, Usuarios y Grupos <a href="#4b3b" id="4b3b"></a>

Es posible crear **hosts**, **usuarios** y **grupos**. Los hosts y usuarios se clasifican en contenedores llamados "**Grupos de Hosts**" y "**Grupos de Usuarios**" respectivamente. Estos son similares a las **Unidades Organizativas** (OU).

De forma predeterminada en FreeIPA, el servidor LDAP permite **v√≠nculos an√≥nimos**, y una gran cantidad de datos son enumerables **sin autenticaci√≥n**. Esto puede enumerar todos los datos disponibles sin autenticaci√≥n:
```
ldapsearch -x
```
Para obtener **m√°s informaci√≥n**, necesitas usar una sesi√≥n **autenticada** (consulta la secci√≥n de Autenticaci√≥n para aprender c√≥mo preparar una sesi√≥n autenticada).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Desde una m√°quina unida al dominio podr√°s utilizar **binarios instalados** para enumerar el dominio:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
El usuario **admin** de **FreeIPA** es equivalente a los **administradores de dominio** de **AD**.
{% endhint %}

### Hashes <a href="#482b" id="482b"></a>

El usuario **root** del **servidor IPA** tiene acceso a los **hashes** de contrase√±as.

* El hash de la contrase√±a de un usuario se almacena en formato **base64** en el atributo ‚Äú**userPassword**‚Äù. Este hash puede ser **SSHA512** (versiones antiguas de FreeIPA) o **PBKDF2\_SHA256**.
* El **Nthash** de la contrase√±a se almacena en formato **base64** en ‚Äú**ipaNTHash**‚Äù si el sistema est√° integrado con **AD**.

Para crackear estos hashes:

‚Ä¢ Si FreeIPA est√° integrado con AD, el **ipaNTHash** es f√°cil de crackear: Debes **decodificar** el **base64** -> re-codificarlo como **ASCII** hexadecimal -> John The Ripper o **hashcat** pueden ayudarte a crackearlo r√°pidamente

‚Ä¢ Si se utiliza una versi√≥n antigua de FreeIPA, se utiliza **SSHA512**: Debes decodificar el **base64** -> encontrar el hash SSHA512 -> John The Ripper o **hashcat** pueden ayudarte a crackearlo

‚Ä¢ Si se utiliza una nueva versi√≥n de FreeIPA, se utiliza **PBKDF2\_SHA256**: Debes decodificar el **base64** -> encontrar PBKDF2\_SHA256 -> su **longitud** es de 256 bytes. John puede trabajar con 256 bits (32 bytes) -> SHA-265 se utiliza como funci√≥n pseudoaleatoria, el tama√±o del bloque es de 32 bytes -> puedes usar solo los primeros 256 bits de nuestro hash PBKDF2\_SHA256 -> John The Ripper o hashcat pueden ayudarte a crackearlo

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

Para extraer los hashes necesitas ser **root en el servidor FreeIPA**, all√≠ puedes usar la herramienta **`dbscan`** para extraerlos:

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### Reglas HBAC <a href="#482b" id="482b"></a>

Estas son las reglas que otorgan permisos espec√≠ficos a usuarios o hosts sobre recursos (hosts, servicios, grupos de servicios...).
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Reglas de Sudo

FreeIPA permite el control centralizado sobre los **permisos de sudo** a trav√©s de las reglas de sudo. Estas reglas permiten o limitan la ejecuci√≥n de comandos con sudo en hosts dentro del dominio. Un atacante podr√≠a potencialmente identificar los hosts aplicables, usuarios y comandos permitidos examinando estos conjuntos de reglas.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Control de Acceso Basado en Roles

Un **rol** est√° compuesto por varios **privilegios**, cada uno de los cuales abarca una colecci√≥n de **permisos**. Estos roles pueden asignarse a Usuarios, **Grupos** de Usuarios, **Hosts**, Grupos de Hosts y Servicios. Por ejemplo, considera el rol predeterminado de "Administrador de Usuarios" en FreeIPA para ejemplificar esta estructura.

El rol `Administrador de Usuarios` tiene los siguientes privilegios:

* **Administradores de Usuarios**
* **Administradores de Grupos**
* **Administradores de Usuarios de Etapa**

Con los siguientes comandos es posible enumerar los roles, privilegios y permisos:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Ejemplo de Escenario de Ataque

En [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) puedes encontrar un ejemplo simple de c√≥mo abusar de algunos permisos para comprometer el dominio.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Elevaci√≥n de Privilegios

### ~~Creaci√≥n de usuario root~~

{% hint style="warning" %}
Si puedes **crear un nuevo usuario con el nombre `root`**, puedes hacerse pasar por √©l y ser capaz de **SSH en cualquier m√°quina como root.**

**ESTO HA SIDO PARCHADO.**
{% endhint %}

Puedes consultar una explicaci√≥n detallada en [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Referencias
* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
