# FreeIPA Pentesting

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen** m√∂chten oder **HackTricks in PDF herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandising**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

FreeIPA ist eine Open-Source-**Alternative** zu Microsoft Windows **Active Directory**, haupts√§chlich f√ºr **Unix**-Umgebungen. Es kombiniert ein vollst√§ndiges **LDAP-Verzeichnis** mit einem MIT **Kerberos** Key Distribution Center f√ºr das Management √§hnlich wie Active Directory. Unter Verwendung des Dogtag **Certificate Systems** f√ºr CA & RA-Zertifikatsverwaltung unterst√ºtzt es **Multi-Faktor**-Authentifizierung, einschlie√ülich Smartcards. SSSD ist f√ºr Unix-Authentifizierungsprozesse integriert.

## Fingerabdr√ºcke

### Dateien & Umgebungsvariablen

* Die Datei unter `/etc/krb5.conf` ist der Speicherort f√ºr Kerberos-Clientinformationen, die f√ºr die Einschreibung in die Dom√§ne erforderlich sind. Dies umfasst die Standorte der KDCs und Admin-Server, Standardeinstellungen und Zuordnungen.
* Systemweite Standardeinstellungen f√ºr IPA-Clients und -Server sind in der Datei unter `/etc/ipa/default.conf` festgelegt.
* Hosts innerhalb der Dom√§ne m√ºssen eine `krb5.keytab`-Datei unter `/etc/krb5.keytab` f√ºr Authentifizierungsprozesse haben.
* Verschiedene Umgebungsvariablen (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) werden verwendet, um auf spezifische Dateien und Einstellungen im Zusammenhang mit der Kerberos-Authentifizierung zu verweisen.

### Bin√§rdateien

Werkzeuge wie `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` und `kvno` sind zentral f√ºr das Management von FreeIPA-Dom√§nen, die Behandlung von Kerberos-Tickets, das √Ñndern von Passw√∂rtern und das Abrufen von Servicetickets, unter anderem.

### Netzwerk

Eine Illustration wird bereitgestellt, um eine typische FreeIPA-Serverkonfiguration darzustellen.

## Authentifizierung

Die Authentifizierung in FreeIPA, die **Kerberos** nutzt, √§hnelt der in **Active Directory**. Der Zugriff auf Dom√§nenressourcen erfordert ein g√ºltiges Kerberos-Ticket, das je nach FreeIPA-Dom√§nenkonfiguration an verschiedenen Orten gespeichert werden kann.

### **CCACHE-Ticketdateien**

CCACHE-Dateien, die normalerweise in **`/tmp`** mit **600** Berechtigungen gespeichert sind, sind bin√§re Formate zur Speicherung von Kerberos-Anmeldeinformationen, die aufgrund ihrer Portabilit√§t wichtig sind f√ºr die Authentifizierung ohne das Klartextpasswort eines Benutzers. Das Parsen eines CCACHE-Tickets kann mit dem Befehl `klist` durchgef√ºhrt werden, und die Wiederverwendung eines g√ºltigen CCACHE-Tickets beinhaltet das Exportieren von `KRB5CCNAME` zum Pfad der Ticketdatei.

### **Unix-Schl√ºsselbund**

Alternativ k√∂nnen CCACHE-Tickets im Linux-Schl√ºsselbund gespeichert werden, was eine genauere Kontrolle √ºber das Ticketmanagement bietet. Der Speicherbereich f√ºr die Ticket-Speicherung variiert (`KEYRING:Name`, `KEYRING:Prozess:Name`, `KEYRING:Thread:Name`, `KEYRING:Sitzung:Name`, `KEYRING:Dauerhaft:Benutzerkennung`), wobei `klist` in der Lage ist, diese Informationen f√ºr den Benutzer zu parsen. Die Wiederverwendung eines CCACHE-Tickets aus dem Unix-Schl√ºsselbund kann jedoch Herausforderungen darstellen, wobei Tools wie **Tickey** zum Extrahieren von Kerberos-Tickets verf√ºgbar sind.

### Keytab

Keytab-Dateien, die Kerberos-Prinzipale und verschl√ºsselte Schl√ºssel enthalten, sind entscheidend f√ºr das Erhalten g√ºltiger Ticket Granting Tickets (TGT) ohne das Passwort des Prinzipals zu ben√∂tigen. Das Parsen und Wiederverwenden von Anmeldeinformationen aus Keytab-Dateien kann mithilfe von Dienstprogrammen wie `klist` und Skripten wie **KeytabParser** problemlos durchgef√ºhrt werden.

### Spickzettel

Weitere Informationen zur Verwendung von Tickets in Linux finden Sie unter folgendem Link:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeration

{% hint style="warning" %}
Sie k√∂nnten die **Enumeration** √ºber **ldap** und andere **bin√§re** Tools durchf√ºhren oder **die Webseite im Port 443 des FreeIPA-Servers aufrufen**.
{% endhint %}

### Hosts, Benutzer und Gruppen <a href="#id-4b3b" id="id-4b3b"></a>

Es ist m√∂glich, **Hosts**, **Benutzer** und **Gruppen** zu erstellen. Hosts und Benutzer werden in Container namens "**Hostgruppen**" bzw. "**Benutzergruppen**" einsortiert. Diese √§hneln **Organisationseinheiten** (OU).

Standardm√§√üig erlaubt der LDAP-Server in FreeIPA **anonyme Bindungen**, und eine gro√üe Menge an Daten ist **unauthentifiziert** abrufbar. Dadurch k√∂nnen alle verf√ºgbaren Daten unauthentifiziert abgerufen werden:
```
ldapsearch -x
```
Um **weitere Informationen** zu erhalten, m√ºssen Sie eine **authentifizierte** Sitzung verwenden (√ºberpr√ºfen Sie den Abschnitt zur Authentifizierung, um zu erfahren, wie Sie eine authentifizierte Sitzung vorbereiten).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Von einer dom√§nengebundenen Maschine aus k√∂nnen Sie **installierte Bin√§rdateien** verwenden, um die Dom√§ne aufzulisten:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
Der **admin** Benutzer von **FreeIPA** entspricht den **Dom√§nenadministratoren** von **AD**.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

Der **root** Benutzer des **IPA-Servers** hat Zugriff auf die Passwort-**Hashes**.

* Der Passworthash eines Benutzers wird als **Base64** im Attribut "**userPassword**" gespeichert. Dieser Hash kann **SSHA512** (√§ltere Versionen von FreeIPA) oder **PBKDF2\_SHA256** sein.
* Der **Nthash** des Passworts wird als **Base64** im Attribut "**ipaNTHash**" gespeichert, wenn das System eine **Integration** mit **AD** hat.

Um diese Hashes zu knacken:

‚Ä¢ Wenn FreeIPA mit AD integriert ist, ist es einfach, den **ipaNTHash** zu knacken: Sie sollten **Base64** **dekodieren** -> es als **ASCII** Hexadezimal neu codieren -> John The Ripper oder **hashcat** k√∂nnen Ihnen helfen, ihn schnell zu knacken

‚Ä¢ Wenn eine √§ltere Version von FreeIPA verwendet wird und somit **SSHA512** verwendet wird: Sie sollten **Base64** dekodieren -> den SSHA512 **Hash** finden -> John The Ripper oder **hashcat** k√∂nnen Ihnen helfen, ihn zu knacken

‚Ä¢ Wenn eine neue Version von FreeIPA verwendet wird und somit **PBKDF2\_SHA256** verwendet wird: Sie sollten **Base64** dekodieren -> PBKDF2\_SHA256 finden -> seine **L√§nge** betr√§gt 256 Byte. John kann mit 256 Bits (32 Byte) arbeiten -> SHA-265 wird als die Pseudo-Zufallsfunktion verwendet, die Blockgr√∂√üe betr√§gt 32 Byte -> Sie k√∂nnen nur die ersten 256 Bits unseres PBKDF2\_SHA256-Hashes verwenden -> John The Ripper oder hashcat k√∂nnen Ihnen helfen, ihn zu knacken

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Um die Hashes zu extrahieren, m√ºssen Sie **root auf dem FreeIPA-Server** sein, dort k√∂nnen Sie das Tool **`dbscan`** verwenden, um sie zu extrahieren:

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Regeln <a href="#id-482b" id="id-482b"></a>

Hierbei handelt es sich um Regeln, die bestimmten Benutzern oder Hosts spezifische Berechtigungen f√ºr Ressourcen (Hosts, Dienste, Dienstgruppen usw.) gew√§hren.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Regeln

FreeIPA erm√∂glicht eine zentrale Kontrolle √ºber **sudo-Berechtigungen** √ºber sudo-Regeln. Diese Regeln erlauben oder beschr√§nken die Ausf√ºhrung von Befehlen mit sudo auf Hosts innerhalb der Dom√§ne. Ein Angreifer k√∂nnte potenziell die zutreffenden Hosts, Benutzer und erlaubten Befehle identifizieren, indem er diese Regels√§tze untersucht.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Rollenbasierte Zugriffskontrolle

Eine **Rolle** besteht aus verschiedenen **Privilegien**, von denen jedes eine Sammlung von **Berechtigungen** umfasst. Diese Rollen k√∂nnen Benutzern, Benutzer-**Gruppen**, **Hosts**, Host-Gruppen und Diensten zugewiesen werden. Betrachten Sie beispielsweise die Standardrolle "Benutzeradministrator" in FreeIPA, um diese Struktur zu veranschaulichen.

Die Rolle `Benutzeradministrator` hat folgende Privilegien:

- **Benutzeradministratoren**
- **Gruppenadministratoren**
- **Stufenbenutzeradministratoren**

Mit den folgenden Befehlen ist es m√∂glich, die Rollen, Privilegien und Berechtigungen aufzulisten:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Angriffszenario Beispiel

In [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) findest du ein einfaches Beispiel, wie man einige Berechtigungen missbrauchen kann, um die Dom√§ne zu kompromittieren.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privilege Escalation

### ~~root Benutzererstellung~~

{% hint style="warning" %}
Wenn du **einen neuen Benutzer mit dem Namen `root` erstellen kannst**, kannst du ihn imitieren und wirst in der Lage sein, **auf jede Maschine als root per SSH zuzugreifen.**

**DIES WURDE GEFIXT.**
{% endhint %}

Eine detaillierte Erkl√§rung findest du unter [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Referenzen

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>Lerne AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn du deine **Firma in HackTricks beworben sehen m√∂chtest** oder **HackTricks als PDF herunterladen m√∂chtest**, sieh dir die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop) an!
* Hol dir das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecke [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Trete der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile deine Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichst.

</details>
