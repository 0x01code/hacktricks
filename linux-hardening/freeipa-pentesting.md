# Uchunguzi wa FreeIPA

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalam wa juu</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Taarifa Msingi

FreeIPA ni **mbadala** wa chanzo wazi kwa Microsoft Windows **Active Directory**, haswa kwa mazingira ya **Unix**. Inaunganisha **directory ya LDAP kamili** na Kituo cha Usambazaji cha **Kerberos** cha MIT kwa usimamizi kama Active Directory. Kwa kutumia Mfumo wa Cheti wa Dogtag kwa usimamizi wa cheti cha CA & RA, inasaidia uwakiki wa **hatua nyingi**, ikiwa ni pamoja na kadi za akili. SSSD imeingizwa kwa mchakato wa uwakiki wa Unix.

## Vidole

### Faili na Mazingira ya Mazingira

- Faili katika `/etc/krb5.conf` ndio mahali ambapo habari ya mteja wa Kerberos, inayohitajika kwa usajili katika kikoa, imehifadhiwa. Hii ni pamoja na maeneo ya KDC na seva za utawala, mipangilio ya chaguo-msingi, na ramani.
- Chaguo-msingi ya mfumo kwa wateja na seva za IPA imewekwa katika faili iliyo katika `/etc/ipa/default.conf`.
- Wenyewe ndani ya kikoa lazima wawe na faili ya `krb5.keytab` katika `/etc/krb5.keytab` kwa mchakato wa uwakiki.
- Mazingira mbalimbali ya mazingira (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) hutumiwa kuashiria faili na mipangilio maalum inayohusiana na uwakiki wa Kerberos.

### Programu

Zana kama vile `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch`, na `kvno` ni muhimu katika kusimamia uwanja wa FreeIPA, kushughulikia tiketi za Kerberos, kubadilisha nywila, na kupata tiketi za huduma, kati ya utendaji mwingine.

### Mtandao

Mchoro unatolewa kuonyesha usanidi wa kawaida wa seva ya FreeIPA.

## Uwakiki

Uwakiki katika FreeIPA, kwa kutumia **Kerberos**, unaakisi huo katika **Active Directory**. Kupata rasilimali za kikoa kunahitaji tiketi sahihi ya Kerberos, ambayo inaweza kuhifadhiwa katika maeneo mbalimbali kulingana na usanidi wa kikoa cha FreeIPA.

### **Faili za Tiketi za CCACHE**

Faili za CCACHE, zilizohifadhiwa kawaida katika **`/tmp`** na ruhusa za **600**, ni muundo wa binary wa kuhifadhi sifa za Kerberos, muhimu kwa uwakiki bila nywila ya wazi ya mtumiaji kutokana na uhamishaji wao. Kupasua tiketi ya CCACHE kunaweza kufanywa kwa kutumia amri ya `klist`, na kutumia tena Tiketi sahihi ya CCACHE kunahusisha kuuza nje `KRB5CCNAME` kwa njia ya faili ya tiketi.

### **Unix Keyring**

Kwa upande mwingine, Tiketi za CCACHE zinaweza kuhifadhiwa katika keyring ya Linux, ikitoa udhibiti zaidi juu ya usimamizi wa tiketi. Wigo wa uhifadhi wa tiketi hutofautiana (`KEYRING:jina`, `KEYRING:prosesi:jina`, `KEYRING:thread:jina`, `KEYRING:kikao:jina`, `KEYRING:thabiti:uidnumber`), na `klist` inaweza kuchambua habari hii kwa mtumiaji. Walakini, kutumia tena Tiketi ya CCACHE kutoka kwa keyring ya Unix kunaweza kuleta changamoto, na zana kama **Tickey** inapatikana kwa kuchambua tiketi za Kerberos.

### Keytab

Faili za keytab, zinazojumuisha mabwana wa Kerberos na funguo zilizofichwa, ni muhimu kupata tiketi sahihi za utoaji wa tiketi (TGT) bila kuhitaji nywila ya mabwana. Kupasua na kutumia tena sifa kutoka kwa faili za keytab kunaweza kufanywa kwa urahisi na zana kama `klist` na hati kama **KeytabParser**.

### Cheatsheet

Unaweza kupata habari zaidi juu ya jinsi ya kutumia tiketi katika linux kwenye kiungo kifuatacho:

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Uchunguzi

{% hint style="warning" %}
Unaweza kufanya **uchunguzi** kupitia **ldap** na zana zingine **binary**, au **kuunganisha kwenye ukurasa wa wavuti kwenye bandari 443 ya seva ya FreeIPA**.
{% endhint %}


### Wenyewe, Watumiaji, na Vikundi <a href="#4b3b" id="4b3b"></a>

Inawezekana kuunda **wenyewe**, **watumiaji**, na **vikundi**. Wenyewe na watumiaji wanasortiwa katika vyombo vinavyoitwa "**Vikundi vya Wenyewe**" na "**Vikundi vya Watumiaji**" mtawaliwa. Hivi ni sawa na **Vipengele vya Shirika** (OU).

Kwa chaguo-msingi katika FreeIPA, seva ya LDAP inaruhusu **kufunga kwa siri**, na seti kubwa ya data inaweza kuchunguzwa **bila kufungua**. Hii inaweza kuchunguza data yote inayopatikana bila kufungua:
```
ldapsearch -x
```
Ili kupata **habari zaidi**, unahitaji kutumia kikao **kilichothibitishwa** (angalia sehemu ya Uthibitishaji kujifunza jinsi ya kuandaa kikao kilichothibitishwa).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
Kutoka kwenye kifaa kilichounganishwa na kikoa, utaweza kutumia **faili za programu zilizosakinishwa** kuorodhesha kikoa:
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
Mtumiaji wa **admin** wa **FreeIPA** ni sawa na **domain admins** kutoka **AD**.
{% endhint %}

### Hashes <a href="#482b" id="482b"></a>

Mtumiaji wa **root** kutoka kwenye **IPA server** ana ufikiaji wa **hashes** za nywila.

* Hash ya nywila ya mtumiaji imehifadhiwa kama **base64** kwenye "sifa" ya "userPassword". Hash hii inaweza kuwa **SSHA512** (toleo za zamani za FreeIPA) au **PBKDF2\_SHA256**.
* **Nthash** ya nywila imehifadhiwa kama **base64** kwenye "ipaNTHash" ikiwa mfumo una **integration** na **AD**.

Kuweza kuvunja hash hizi:

‚Ä¢ Ikiwa freeIPA imeunganishwa na AD, **ipaNTHash** ni rahisi kuvunja: Unapaswa **decode** **base64** -> re-encode kama **ASCII** hex -> John The Ripper au **hashcat** inaweza kukusaidia kuvunja haraka

‚Ä¢ Ikiwa toleo la zamani la FreeIPA linatumika, basi **SSHA512** inatumika: Unapaswa kudecode **base64** -> tafuta SSHA512 **hash** -> John The Ripper au **hashcat** inaweza kukusaidia kuvunja

‚Ä¢ Ikiwa toleo jipya la FreeIPA linatumika, basi **PBKDF2\_SHA256** inatumika: Unapaswa kudecode **base64** -> tafuta PBKDF2\_SHA256 -> urefu wake ni 256 byte. John anaweza kufanya kazi na bits 256 (32 byte) -> SHA-265 inatumika kama kazi ya pseudo-random, ukubwa wa block ni 32 byte -> unaweza kutumia tu biti za kwanza 256 za hash yetu ya PBKDF2\_SHA256 -> John The Ripper au hashcat inaweza kukusaidia kuvunja

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

Kuweza kutoa hash, unahitaji kuwa **root kwenye FreeIPA server**, hapo unaweza kutumia zana **`dbscan`** kuiondoa:

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#482b" id="482b"></a>

Hizi ni sheria ambazo hutoa ruhusa maalum kwa watumiaji au mwenyeji juu ya rasilimali (wenyeji, huduma, vikundi vya huduma...)
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Mikakati

FreeIPA inawezesha udhibiti wa kati juu ya **ruhusa za sudo** kupitia sudo-mikakati. Mikakati hii inaruhusu au inazuia utekelezaji wa amri za sudo kwenye mwenyeji ndani ya kikoa. Mshambuliaji anaweza kwa uwezekano kutambua watumiaji, mwenyeji husika, na amri zilizoruhusiwa kwa kuchunguza mikakati hii.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Udhibiti wa Upatikanaji kulingana na Majukumu

**Jukumu** linajumuisha **mamlaka** mbalimbali, kila moja ikijumuisha mkusanyiko wa **ruhusa**. Majukumu haya yanaweza kupewa Watumiaji, **Vikundi** vya Watumiaji, **Wenyeji**, Vikundi vya Wenyeji, na Huduma. Kwa mfano, fikiria jukumu la msingi la "Msimamizi wa Mtumiaji" katika FreeIPA kuonyesha muundo huu.

Jukumu la `Msimamizi wa Mtumiaji` lina mamlaka yafuatayo:

* **Msimamizi wa Watumiaji**
* **Msimamizi wa Vikundi**
* **Msimamizi wa Hatua za Mtumiaji**

Kwa kutumia amri zifuatazo, ni rahisi kuorodhesha majukumu, mamlaka, na ruhusa:
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Mfano wa Skena ya Shambulio

Katika [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e) unaweza kupata mfano rahisi wa jinsi ya kutumia baadhi ya ruhusa kuhatarisha kikoa.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~Uundaji wa mtumiaji wa root~~

{% hint style="warning" %}
Ikiwa unaweza **kuunda mtumiaji mpya na jina la `root`**, unaweza kujifanya kuwa yeye na utaweza **kuingia kwa SSH kwenye kifaa chochote kama root.**

**HII IMESAHIHISHWA.**
{% endhint %}

Unaweza kuangalia maelezo ya kina katika [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## Marejeo
* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
