# Test de p√©n√©tration FreeIPA

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

FreeIPA est une **alternative** open-source √† Microsoft Windows **Active Directory**, principalement pour les environnements **Unix**. Il combine un **annuaire LDAP** complet avec un centre de distribution de cl√©s MIT **Kerberos** pour la gestion similaire √† Active Directory. En utilisant le syst√®me de certificats Dogtag pour la gestion des certificats CA & RA, il prend en charge l'authentification **multi-facteurs**, y compris les cartes √† puce. SSSD est int√©gr√© pour les processus d'authentification Unix.

## Empreintes digitales

### Fichiers et variables d'environnement

- Le fichier `/etc/krb5.conf` est l'endroit o√π les informations du client Kerberos, n√©cessaires pour l'inscription dans le domaine, sont stock√©es. Cela inclut les emplacements des KDC et des serveurs d'administration, les param√®tres par d√©faut et les mappings.
- Les param√®tres par d√©faut du syst√®me pour les clients et serveurs IPA sont d√©finis dans le fichier situ√© √† `/etc/ipa/default.conf`.
- Les h√¥tes dans le domaine doivent avoir un fichier `krb5.keytab` √† l'emplacement `/etc/krb5.keytab` pour les processus d'authentification.
- Diverses variables d'environnement (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) sont utilis√©es pour pointer vers des fichiers sp√©cifiques et des param√®tres pertinents √† l'authentification Kerberos.

### Binaires

Des outils tels que `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch` et `kvno` sont essentiels pour la gestion des domaines FreeIPA, la manipulation des tickets Kerberos, le changement de mots de passe et l'acquisition de tickets de service, entre autres fonctionnalit√©s.

### R√©seau

Une illustration est fournie pour repr√©senter une configuration typique du serveur FreeIPA.

## Authentification

L'authentification dans FreeIPA, en utilisant **Kerberos**, est similaire √† celle dans **Active Directory**. L'acc√®s aux ressources du domaine n√©cessite un ticket Kerberos valide, qui peut √™tre stock√© √† divers emplacements en fonction de la configuration du domaine FreeIPA.

### **Fichiers de ticket CCACHE**

Les fichiers CCACHE, stock√©s g√©n√©ralement dans **`/tmp`** avec des permissions **600**, sont des formats binaires pour stocker les informations d'identification Kerberos, importantes pour l'authentification sans le mot de passe en clair de l'utilisateur en raison de leur portabilit√©. L'analyse d'un ticket CCACHE peut √™tre effectu√©e en utilisant la commande `klist`, et la r√©utilisation d'un ticket CCACHE valide implique d'exporter `KRB5CCNAME` vers le chemin du fichier de ticket.

### **Trousseau Unix**

Alternativement, les tickets CCACHE peuvent √™tre stock√©s dans le trousseau Linux, offrant plus de contr√¥le sur la gestion des tickets. La port√©e du stockage des tickets varie (`KEYRING:name`, `KEYRING:process:name`, `KEYRING:thread:name`, `KEYRING:session:name`, `KEYRING:persistent:uidnumber`), avec `klist` capable d'analyser ces informations pour l'utilisateur. Cependant, la r√©utilisation d'un ticket CCACHE √† partir du trousseau Unix peut poser des d√©fis, avec des outils comme **Tickey** disponibles pour extraire les tickets Kerberos.

### Keytab

Les fichiers Keytab, contenant des principaux Kerberos et des cl√©s chiffr√©es, sont essentiels pour obtenir des tickets de distribution de tickets (TGT) valides sans avoir besoin du mot de passe du principal. L'analyse et la r√©utilisation des informations d'identification √† partir des fichiers Keytab peuvent √™tre facilement effectu√©es avec des utilitaires comme `klist` et des scripts tels que **KeytabParser**.

### Feuille de triche

Vous pouvez trouver plus d'informations sur l'utilisation des tickets dans Linux en suivant le lien suivant :

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## √ânum√©ration

{% hint style="warning" %}
Vous pourriez effectuer l'**√©num√©ration** via **ldap** et d'autres **outils binaires**, ou **vous connecter √† la page web sur le port 443 du serveur FreeIPA**.
{% endhint %}

### H√¥tes, Utilisateurs et Groupes <a href="#4b3b" id="4b3b"></a>

Il est possible de cr√©er des **h√¥tes**, des **utilisateurs** et des **groupes**. Les h√¥tes et les utilisateurs sont class√©s dans des conteneurs appel√©s "**Groupes d'h√¥tes**" et "**Groupes d'utilisateurs**" respectivement. Ceux-ci sont similaires aux **Unit√©s organisationnelles** (OU).

Par d√©faut dans FreeIPA, le serveur LDAP permet les **liaisons anonymes**, et une grande quantit√© de donn√©es est √©num√©rable **non authentifi√©e**. Cela peut √©num√©rer toutes les donn√©es disponibles non authentifi√©es:
```
ldapsearch -x
```
Pour obtenir **plus d'informations**, vous devez utiliser une session **authentifi√©e** (consultez la section Authentification pour apprendre comment pr√©parer une session authentifi√©e).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
√Ä partir d'une machine jointe au domaine, vous pourrez utiliser **les binaires install√©s** pour √©num√©rer le domaine :
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
L'utilisateur **admin** de **FreeIPA** est l'√©quivalent des **domain admins** d'**AD**.
{% endhint %}

### Hashes <a href="#482b" id="482b"></a>

L'utilisateur **root** du serveur **IPA** a acc√®s aux **hashes** de mots de passe.

* Le hash de mot de passe d'un utilisateur est stock√© en **base64** dans l'attribut "**userPassword**". Ce hash peut √™tre **SSHA512** (anciennes versions de FreeIPA) ou **PBKDF2\_SHA256**.
* Le **Nthash** du mot de passe est stock√© en **base64** dans "ipaNTHash" si le syst√®me est int√©gr√© √† **AD**.

Pour casser ces hashes :

‚Ä¢ Si FreeIPA est int√©gr√© √† AD, **ipaNTHash** est facile √† casser : Vous devez d√©coder en **base64** -> le r√©encoder en **hexad√©cimal ASCII** -> John The Ripper ou **hashcat** peuvent vous aider √† le casser rapidement

‚Ä¢ Si une ancienne version de FreeIPA est utilis√©e, donc **SSHA512** est utilis√© : Vous devez d√©coder en **base64** -> trouver le hash SSHA512 -> John The Ripper ou **hashcat** peuvent vous aider √† le casser

‚Ä¢ Si une nouvelle version de FreeIPA est utilis√©e, donc **PBKDF2\_SHA256** est utilis√© : Vous devez d√©coder en **base64** -> trouver PBKDF2\_SHA256 -> sa **longueur** est de 256 octets. John peut travailler avec 256 bits (32 octets) -> SHA-265 est utilis√© comme fonction pseudo-al√©atoire, la taille du bloc est de 32 octets -> vous pouvez utiliser uniquement les premiers 256 bits de notre hash PBKDF2\_SHA256 -> John The Ripper ou hashcat peuvent vous aider √† le casser

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

Pour extraire les hashes, vous devez √™tre **root dans le serveur FreeIPA**, l√† vous pouvez utiliser l'outil **`dbscan`** pour les extraire :

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### R√®gles HBAC <a href="#482b" id="482b"></a>

Ce sont les r√®gles qui accordent des autorisations sp√©cifiques aux utilisateurs ou aux h√¥tes sur les ressources (h√¥tes, services, groupes de services...).
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### R√®gles Sudo

FreeIPA permet un contr√¥le centralis√© des **permissions sudo** via les r√®gles sudo. Ces r√®gles permettent ou limitent l'ex√©cution de commandes avec sudo sur les h√¥tes du domaine. Un attaquant pourrait potentiellement identifier les h√¥tes, utilisateurs et commandes autoris√©es en examinant ces ensembles de r√®gles.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Contr√¥le d'acc√®s bas√© sur les r√¥les

Un **r√¥le** est compos√© de diverses **privil√®ges**, chacun englobant une collection de **permissions**. Ces r√¥les peuvent √™tre attribu√©s √† des Utilisateurs, des **Groupes** d'utilisateurs, des **H√¥tes**, des Groupes d'h√¥tes et des Services. Par exemple, consid√©rez le r√¥le par d√©faut "Administrateur d'utilisateurs" dans FreeIPA pour illustrer cette structure.

Le r√¥le `Administrateur d'utilisateurs` a ces privil√®ges :

* **Administrateurs d'utilisateurs**
* **Administrateurs de groupes**
* **Administrateurs d'utilisateurs de sc√®ne**

Avec les commandes suivantes, il est possible d'√©num√©rer les r√¥les, privil√®ges et permissions :
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Exemple de Sc√©nario d'Attaque

Dans [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e), vous pouvez trouver un exemple simple de comment abuser de certaines autorisations pour compromettre le domaine.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## √âl√©vation de Privil√®ges

### ~~Cr√©ation d'un utilisateur root~~

{% hint style="warning" %}
Si vous pouvez **cr√©er un nouvel utilisateur avec le nom `root`**, vous pouvez vous faire passer pour lui et vous pourrez **vous connecter en SSH sur n'importe quelle machine en tant que root.**

**CELA A √âT√â CORRIG√â.**
{% endhint %}

Vous pouvez consulter une explication d√©taill√©e dans [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

# R√©f√©rences
* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
