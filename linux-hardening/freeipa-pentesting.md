# FreeIPA Pentesting

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Cette information a √©t√© prise des articles :

* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ\&feature=youtu.be](https://www.youtube.com/watch?v=9dOu-7BTwPQ\&feature=youtu.be)

## Informations de base

C'est une **alternative** open source √† Microsoft Windows **Active Directory**, principalement utilis√©e comme solution de gestion int√©gr√©e pour les environnements **Unix**. Semblable √† Active Directory, FreeIPA impl√©mente une infrastructure compl√®te d'**annuaire LDAP** soutenue par un MIT **Kerberos** Key Distribution Center. Il utilise le **Certificate System** Dogtag pour la gestion des certificats CA & RA, lui donnant la capacit√© de g√©rer l'authentification **multi-facteurs**, y compris les cartes √† puce. SSSD est utilis√© pour int√©grer FreeIPA dans le processus d'authentification Unix standard.

## Empreintes

### Fichiers & Variables d'Environnement

* **`/etc/krb5.conf` :** Le fichier `krb5.conf` contient les informations du client Kerberos n√©cessaires pour √™tre **inscrit dans le domaine**. Cela inclut les **emplacements des KDCs et des serveurs admin** pour les royaumes Kerberos d'int√©r√™t, les valeurs par d√©faut pour le royaume actuel et pour les applications Kerberos, et les mappages des noms d'h√¥tes sur les royaumes Kerberos.
* **`/etc/ipa/default.conf` :** C'est le **fichier de configuration par d√©faut pour les serveurs IPA**, il est utilis√© pour d√©finir les valeurs par d√©faut √† appliquer lors de l'ex√©cution des clients et serveurs IPA.
* **`/etc/krb5.keytab` :** Le fichier `krb5.keytab` est **requis** sur tous les h√¥tes √† l'int√©rieur du **domaine**. Il est n√©cessaire dans le cadre du processus d'**authentification** au KDC.
* **`KRB5CCNAME` :** Si d√©fini, cette variable indique l'**emplacement du Ticket CCACHE** √† utiliser pour l'authentification.
* **`KRB5_KTNAME` :** Si d√©fini, cette variable indique l'**emplacement** du fichier **Keytab** √† utiliser pour l'authentification.
* **`KRB5_CONFIG` :** Si d√©fini, cette variable indique l'**emplacement** du fichier de **configuration Kerberos**.
* **`KRB5_KDC_PROFILE` :** Si d√©fini, cette variable indique l'**emplacement du fichier de configuration KDC**, qui contient des directives de configuration suppl√©mentaires pour le d√©mon Key Distribution Center.
* **`KRB5RCACHETYPE` :** Cette variable sp√©cifie le **type par d√©faut de cache de rejeu** √† utiliser pour les serveurs.
* **`KRB5RCACHEDIR` :** Cette variable sp√©cifie le **r√©pertoire par d√©faut pour les caches de rejeu** utilis√©s par les serveurs.
* **`KRB5_TRACE` :** Cette variable sp√©cifie un **nom de fichier pour √©crire la sortie du journal de trace**. Les journaux de trace peuvent aider √† √©clairer les d√©cisions prises en interne par les biblioth√®ques Kerberos.
* **`KRB5_CLIENT_KTNAME` :** Cette variable d√©finit le nom de fichier **keytab client par d√©faut**.
* **`KPROP_PORT` :** Cette variable d√©finit le **port par d√©faut pour kprop** √† utiliser.

### Binaires

* **ipa :** Ce binaire est la norme pour **g√©rer un domaine FreeIPA**. Il peut √™tre utilis√© pour g√©rer des h√¥tes, des utilisateurs, des r√®gles sudo, et bien plus encore.
* **kdestroy :** Le binaire kdestroy est utilis√© pour **d√©truire** tout **ticket Kerberos** actuel dans la session de l'utilisateur.
* **kinit :** Le binaire kinit est utilis√© pour **√©tablir**, ou **renouveler** des **tickets Kerberos**.
* **klist :** Le binaire klist **liste** tout **ticket Kerberos en cours d'utilisation**, et quels principaux les tickets donnent acc√®s.
* **kpasswd :** La commande kpasswd est utilis√©e pour **changer le mot de passe d'un principal Kerberos**. kpasswd demande d'abord le mot de passe Kerberos actuel, puis demande deux fois √† l'utilisateur le nouveau mot de passe, et le mot de passe est chang√©.
* **ksu :** Ksu peut √™tre utilis√© comme une **alternative au binaire su**, pour changer le **contexte utilisateur actuel**.
* **kswitch :** La commande kswitch va **changer** le **cache d'identification en cours d'utilisation**.
* **kvno :** Le binaire kvno acquiert un **ticket de service** pour les **principaux Kerberos sp√©cifi√©s** et imprime les num√©ros de version des cl√©s de chacun.

### R√©seau

Voici √† quoi pourrait ressembler un serveur FreeIPA :

<figure><img src="../.gitbook/assets/image (197).png" alt=""><figcaption></figcaption></figure>

## Authentification

Puisque FreeIPA utilise **Kerberos pour l'authentification**, ce processus est tr√®s similaire √† l'**authentification** dans **Active Directory**. Pour **acc√©der** aux ressources sur le domaine, un utilisateur doit avoir un **ticket Kerberos valide** pour cette ressource. Ces tickets peuvent √™tre stock√©s dans diff√©rents emplacements en fonction de la configuration du domaine FreeIPA.

### **Fichiers Ticket CCACHE**

Lorsque les tickets sont configur√©s pour √™tre **stock√©s** sous forme de **fichier** sur **disque**, le format et le type standard est un fichier **CCACHE**. Il s'agit d'un format de fichier binaire simple pour stocker les informations d'identification Kerberos. Ces fichiers sont g√©n√©ralement stock√©s dans **`/tmp`** et ont des permissions **600**. Du point de vue d'un attaquant, cela est important pour les raisons suivantes :

1. Les tickets valides peuvent √™tre **utilis√©s pour s'authentifier**, **sans** avoir besoin du **mot de passe en clair** de l'utilisateur respectif.
2. Les tickets **CCACHE** sont tr√®s **portables**. Ils peuvent √™tre t√©l√©charg√©s et charg√©s sur un autre h√¥te sans avoir besoin de renouveler ou de valider le ticket.

**Analyser** un Ticket CCACHE est facilement r√©alisable de diff√©rentes mani√®res. La m√©thode la plus simple est de l'analyser avec le binaire klist.
```
klist /tmp/krb5cc_0
```
```markdown
<figure><img src="../.gitbook/assets/image (70).png" alt=""><figcaption></figcaption></figure>

Pour un attaquant, r√©utiliser un ticket CCACHE est tr√®s facile. Pour **r√©utiliser** un ticket CCACHE valide, **exportez** **KRB5CCNAME** vers le **chemin** du fichier de ticket valide. Le syst√®me devrait reconna√Ætre la variable d'environnement et tentera d'utiliser ce mat√©riel d'identification lors de l'interaction avec le domaine.
```
```bash
export KRB5CCNAME=/tmp/krb5cc_0
klist
```
### **Porte-cl√©s Unix**

Les tickets CCACHE peuvent √©galement √™tre **stock√©s** dans le **porte-cl√©s** Linux. Le porte-cl√©s r√©side √† l'int√©rieur du **noyau**, et offre aux administrateurs **plus de contr√¥le sur la r√©cup√©ration et l'utilisation des tickets stock√©s**. Les tickets peuvent √™tre d√©limit√©s de diff√©rentes mani√®res :

* **`KEYRING:name` :** Les tickets sont d√©limit√©s √† un porte-cl√©s nomm√© sp√©cifique.
* **`KEYRING:process:name` :** Les tickets sont d√©limit√©s √† un identifiant de processus sp√©cifique.
* **`KEYRING:thread:name` :** Les tickets sont d√©limit√©s √† un thread sp√©cifique.
* **`KEYRING:session:name` :** Les tickets sont d√©limit√©s √† une session utilisateur sp√©cifique.
* **`KEYRING:persistent:uidnumber` :** Les tickets sont d√©limit√©s √† un utilisateur sp√©cifique ind√©pendamment de la session (par d√©faut).

Selon la mani√®re dont l'administrateur a d√©limit√© le ticket stock√© dans le porte-cl√©s Unix, l'extraire peut √™tre difficile. Cependant, la **port√©e** **par d√©faut** pour les tickets CCACHE dans le porte-cl√©s Unix est **`KEYRING:persistent:uidnumber`**. Heureusement, si vous √™tes dans le **contexte** de l'**utilisateur**, `klist` peut **analyser** cette information pour nous.

En tant qu'attaquant, **r√©utiliser un ticket CCACHE** stock√© dans le porte-cl√©s Unix est assez **difficile** selon la port√©e du ticket. Heureusement, [@Zer1t0](https://github.com/Zer1t0) de [@Tarlogic](https://twitter.com/Tarlogic) a d√©velopp√© un outil qui peut extraire les tickets Kerberos du porte-cl√©s Unix. L'outil s'appelle **Tickey** et peut √™tre trouv√© [**ici**](https://github.com/TarlogicSecurity/tickey).

### Keytab <a href="#ff38" id="ff38"></a>

{% hint style="warning" %}
habituellement, chaque h√¥te est d√©ploy√© avec des informations d'identification keytab pour cet h√¥te qui peuvent √™tre utilis√©es pour obtenir un Ticket Granting Ticket (TGT) CCACHE valide pour l'h√¥te lui-m√™me.
{% endhint %}

Il se compose de paires de **principaux Kerberos et de cl√©s chiffr√©es** qui sont d√©riv√©es du mot de passe Kerberos associ√© au principal. √âtant donn√© que ces cl√©s sont d√©riv√©es du mot de passe du principal, si ce **mot de passe change, le fichier keytab sera invalid√©**.

Les fichiers keytab peuvent √™tre utilis√©s pour **obtenir un ticket granting ticket** (TGT) valide pour le principal auquel il est d√©limit√©. Ce processus d'authentification **ne n√©cessite pas le mot de passe**, car il contient des cl√©s d√©riv√©es du mot de passe.

Analyser un fichier keytab est tr√®s facile et peut √™tre accompli de plusieurs mani√®res. La mani√®re la plus simple d'**analyser** un fichier **keytab** est avec **klist**. La deuxi√®me m√©thode utilise un excellent utilitaire python que [Cody Thomas](https://medium.com/u/645ffcef8682?source=post\_page-----77e73d837d6a--------------------------------) a cr√©√©. Son projet [**KeytabParser**](https://github.com/its-a-feature/KeytabParser) **analysera** le principal et ses cl√©s chiffr√©es pertinentes.

Les attaquants peuvent **r√©utiliser les informations d'identification stock√©es dans les fichiers keytab en g√©n√©rant un ticket CCACHE** via le binaire kinit.
```powershell
# Parse keytab
klist -k /rtc/krb5.keytab

# Get TGT
kinit -kt /etc/krb5.keytab host/bastion.westeros.local@WESTEROS.LOCAL
```
### Cheatsheet

Vous pouvez trouver plus d'informations sur comment utiliser les tickets dans linux dans le lien suivant :

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## √ânum√©ration

{% hint style="warning" %}
Vous pouvez effectuer l'**√©num√©ration** via **ldap** et d'autres outils **binaires**, ou en **vous connectant √† la page web sur le port 443 du serveur FreeIPA**.
{% endhint %}

### H√¥tes, Utilisateurs et Groupes <a href="#4b3b" id="4b3b"></a>

Il est possible de cr√©er des **h√¥tes**, **utilisateurs** et **groupes**. Les h√¥tes et les utilisateurs sont tri√©s dans des conteneurs appel√©s respectivement ‚Äú**Groupes d'H√¥tes**‚Äù et ‚Äú**Groupes d'Utilisateurs**‚Äù. Ceux-ci sont similaires aux **Unit√©s Organisationnelles** (OU).

Par d√©faut dans FreeIPA, le serveur LDAP permet des **liaisons anonymes**, et une grande quantit√© de donn√©es est √©num√©rable de mani√®re **non authentifi√©e**. Ceci peut √©num√©rer toutes les donn√©es disponibles non authentifi√©es :
```
ldapsearch -x
```
Pour obtenir **plus d'informations**, vous devez utiliser une session **authentifi√©e** (consultez la section Authentication pour apprendre √† pr√©parer une session authentifi√©e).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
√Ä partir d'une machine jointe au domaine, vous pourrez utiliser les **binaires install√©s** pour √©num√©rer le domaine :
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
L'utilisateur **admin** de **FreeIPA** est l'√©quivalent des **domain admins** de **AD**.
{% endhint %}

### Hashes <a href="#482b" id="482b"></a>

L'utilisateur **root** du **serveur IPA** a acc√®s aux **hashes** de mot de passe.

* Le hash de mot de passe d'un utilisateur est stock√© en **base64** dans l'**attribut** "**userPassword**". Ce hash peut √™tre **SSHA512** (anciennes versions de FreeIPA) ou **PBKDF2\_SHA256**.
* Le **Nthash** du mot de passe est stock√© en **base64** dans "**ipaNTHash**" si le syst√®me a une **int√©gration** avec **AD**.

Pour craquer ces hashes :

‚Ä¢ Si FreeIPA est int√©gr√© avec AD, **ipaNTHash** est facile √† craquer : Vous devez **d√©coder** le **base64** -> le r√©encoder en hex **ASCII** -> John The Ripper ou **hashcat** peuvent vous aider √† le craquer rapidement

‚Ä¢ Si une ancienne version de FreeIPA est utilis√©e, donc **SSHA512** est utilis√© : Vous devez d√©coder le **base64** -> trouver le hash **SSHA512** -> John The Ripper ou **hashcat** peuvent vous aider √† le craquer

‚Ä¢ Si une nouvelle version de FreeIPA est utilis√©e, donc **PBKDF2\_SHA256** est utilis√© : Vous devez d√©coder le **base64** -> trouver PBKDF2\_SHA256 -> sa **longueur** est de 256 octets. John peut travailler avec 256 bits (32 octets) -> SHA-256 utilis√© comme fonction pseudo-al√©atoire, la taille du bloc est de 32 octets -> vous pouvez utiliser seulement les premiers 256 bits de notre hash PBKDF2\_SHA256 -> John The Ripper ou hashcat peuvent vous aider √† le craquer

<figure><img src="../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

Pour extraire les hashes, vous devez √™tre **root sur le serveur FreeIPA**, l√† vous pouvez utiliser l'outil **`dbscan`** pour les extraire :

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

### R√®gles HBAC <a href="#482b" id="482b"></a>

Ce sont les r√®gles qui accordent des permissions sp√©cifiques aux utilisateurs ou aux h√¥tes sur des ressources (h√¥tes, services, groupes de services...).
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### R√®gles Sudo

FreeIPA offre la possibilit√© de **g√©rer les permissions sudo** √† partir d'une source **centralis√©e** gr√¢ce aux r√®gles sudo. Ces ensembles de r√®gles peuvent √™tre utilis√©s pour restreindre ou d√©l√©guer la capacit√© d'**ex√©cuter des commandes en tant que sudo** sur les h√¥tes inscrits dans le domaine. En tant qu'attaquant, nous pouvons √©num√©rer quels h√¥tes et utilisateurs ces ensembles de r√®gles sont appliqu√©s, et quelles commandes sont autoris√©es √† travers l'ensemble de r√®gles.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Contr√¥le d'Acc√®s Bas√© sur les R√¥les

Chaque **r√¥le** contient un ensemble de **privil√®ges**, et ces privil√®ges respectifs contiennent un **ensemble** de **permissions**. Les r√¥les peuvent √™tre **appliqu√©s aux Utilisateurs**, aux **Groupes** d'Utilisateurs, aux **H√¥tes**, aux Groupes d'H√¥tes et aux Services. Pour illustrer ce concept, discutons du r√¥le par d√©faut "Administrateur d'Utilisateur" dans FreeIPA.

<figure><img src="../.gitbook/assets/image (161).png" alt=""><figcaption></figcaption></figure>

Comme le montre la capture d'√©cran ci-dessus, le r√¥le "Administrateur d'Utilisateur" contient les privil√®ges suivants :

* **Administrateurs d'Utilisateurs**
* **Administrateurs de Groupes**
* **Administrateurs d'Utilisateurs en Attente**

Nous pouvons aller plus loin et √©num√©rer les **permissions** d√©l√©gu√©es √† chaque **privil√®ge** :

<figure><img src="../.gitbook/assets/image (189).png" alt=""><figcaption></figcaption></figure>

Comme nous pouvons le voir, le r√¥le "**Administrateur d'Utilisateur**" contient **beaucoup de permissions** au sein de l'environnement. Comprendre le concept g√©n√©ral et la structure des **r√¥les**, **privil√®ges** et **permissions** peut √™tre crucial pour identifier les chemins d'attaque √† travers un environnement.
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Exemple de sc√©nario d'attaque

Dans [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e), vous pouvez trouver un exemple simple de comment abuser de certaines permissions pour compromettre le domaine.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## √âl√©vation de privil√®ges

### ~~cr√©ation d'utilisateur root~~

{% hint style="warning" %}
Si vous pouvez **cr√©er un nouvel utilisateur avec le nom `root`**, vous pouvez vous faire passer pour lui et vous serez capable de **vous connecter en SSH sur n'importe quelle machine en tant que root.**

**CELA A √âT√â CORRIG√â.**
{% endhint %}

Le privil√®ge "**User Administrators**" est tr√®s puissant (comme son nom l'indique) :

<figure><img src="../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

Avec ce privil√®ge vient beaucoup de diff√©rents pouvoirs pour affecter les utilisateurs √† l'int√©rieur de l'environnement. En utilisant ce privil√®ge, nous pouvons **cr√©er un nouvel utilisateur dans le domaine FreeIPA nomm√© \_root**\_.

<figure><img src="../.gitbook/assets/image (158).png" alt=""><figcaption></figcaption></figure>

Une fois l'utilisateur cr√©√© dans le domaine, nous pouvons **obtenir un ticket pour le compte avec \_kinit**\_.

<figure><img src="../.gitbook/assets/image (178).png" alt=""><figcaption></figcaption></figure>

Maintenant, nous pouvons tenter de **nous connecter en SSH** en utilisant notre nouveau compte root du domaine.

<figure><img src="../.gitbook/assets/image (176).png" alt=""><figcaption></figcaption></figure>

Comme montr√©, cela **connecte l'utilisateur au compte root local** ! Donc, simplement en cr√©ant un utilisateur de domaine pour un utilisateur local, nous avons pu nous authentifier en utilisant le compte _root@WESTEROS.LOCAL_ et obtenir le **contexte utilisateur du compte root local**_._

_Pour plus de d√©tails sur cette vuln√©rabilit√©, consultez_ [_https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b_](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)\

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
