<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>


PAM是一组模块，基本上形成了系统上的服务与服务的用户之间的屏障。这些模块可以有各种不同的目的，从禁止特定UNIX组（或网络组，或子网…）的用户登录，到实现资源限制，以防止您的“研究”组占用系统资源。

# 配置文件

Solaris和其他商业UNIX系统具有略有不同的配置模型，围绕一个单一文件**`/etc/pam.conf`**。在大多数Linux系统上，这些配置文件位于**`/etc/pam.d`**目录中，并以服务命名 - 例如，'login'配置文件称为**`/etc/pam.d/login`**。让我们快速查看该文件的一个版本：
```text
auth required /lib/security/pam_securetty.so
auth required /lib/security/pam_nologin.so
auth sufficient /lib/security/pam_ldap.so
auth required /lib/security/pam_unix_auth.so try_first_pass
account sufficient /lib/security/pam_ldap.so
account required /lib/security/pam_unix_acct.so
password required /lib/security/pam_cracklib.so
password required /lib/security/pam_ldap.so
password required /lib/security/pam_pwdb.so use_first_pass
session required /lib/security/pam_unix_session.so
```
## **PAM管理领域**

最左侧的列可以包含四个独特的单词，代表PAM管理的四个领域：**auth**，**account**，**password**和**session**。虽然有许多模块支持多个领域（实际上，例如pam_unix支持所有这些领域），但其他模块，比如pam_cracklib，只适用于其中一个（在pam_cracklib的情况下是‘password’功能）。

- **auth**：‘auth’领域（我称之为领域 - 文档称其为‘管理组’或‘功能’）负责检查用户是否是其所说的人。可以在此区域列出的模块通常支持**提示输入密码**。
- **account**：此区域负责各种可能的**账户验证功能**。有许多可用于此功能的模块。基于**检查组成员资格**、一天中的时间、用户帐户是本地还是远程等约束通常由支持此功能的模块强制执行。
- **password**：此区域中的模块负责在为给定服务**更新密码**过程中需要的任何功能。大多数情况下，此部分相当‘平淡无奇’，只需调用一个**提示输入当前密码**的模块，假设成功后，提示您输入新密码。还可以添加其他模块来执行**密码复杂性**或字典检查，例如pam_cracklib和pam_pwcheck模块执行的操作。
- **session**：此区域中的模块执行在为给定用户的服务**设置或清理过程中发生的任何事情**。这可能包括许多事情；启动系统范围的初始化脚本、执行特殊日志记录、**挂载用户的主目录**或设置资源限制。

## **PAM模块控制**

**中间列**包含一个关键字，基本上确定了**如果模块成功或失败，PAM应该执行什么操作**。这些关键字在PAM术语中称为‘**控制**’。在90%的情况下，您可以使用常见关键字（**requisite**，**required**，**sufficient**或**optional**）。但是，这只是释放PAM灵活性和功能的冰山一角。

- **required**：如果‘required’模块返回的状态不是‘success’，**操作将始终失败**，但只有在**调用它下面的模块后**才会失败。乍一看似乎毫无意义，但它的目的是从用户尝试使用服务的角度**始终以相同的方式操作**。其净效果是，潜在的黑客**无法确定**是哪个**模块**导致了**失败**。
- **requisite**：如果‘requisite’模块失败，**操作不仅失败**，而且**立即**以失败终止，而不调用任何其他模块。
- **sufficient**：如果**sufficient**模块**成功**，则足以满足该领域中用于使用服务的足够模块的要求，并且**不会调用**列为‘sufficient’的**下面的模块**。**如果失败，则操作失败，除非在其后调用的模块成功**。
- **optional**：根据pam\(8\)手册，‘optional’模块**仅在堆栈中的该功能的唯一模块**时才会导致操作失败。

## 示例

在我们的示例文件中，我们为auth领域堆叠了四个模块：
```text
auth       required     /lib/security/pam_securetty.so
auth       required     /lib/security/pam_env.so
auth       sufficient   /lib/security/pam_ldap.so
auth       required     /lib/security/pam_unix.so try_first_pass
```
1. 当模块按顺序调用时，将会发生以下情况：

   - ‘**pam\_securetty**’ 模块将检查其配置文件 **`/etc/securetty`**，查看正在用于此登录的终端是否在文件中列出。如果**不在文件中，则不允许 root 登录**。如果您尝试在‘不良’终端上以 root 身份登录，此模块将失败。由于它是‘required’，它仍将调用堆栈中的所有模块。但是，即使它们都成功，登录也将失败。值得注意的是，如果模块被列为‘requisite’，则操作将立即以失败结束，而不会调用任何其他模块，无论它们的状态如何。
   
2. ‘**pam\_env**’ 模块将根据管理员在 **/etc/security/pam\_env.conf** 中设置的内容设置环境变量。在 Redhat 9、Fedora Core 1 和 Mandrake 9.2 的默认设置中，此模块的配置文件实际上不设置任何变量。这可能的一个很好的用途是，自动为通过 SSH 登录的用户设置 DISPLAY 环境变量，这样他们就不必自己设置了，如果他们想将‘xterm’发送回远程桌面（尽管 OpenSSH 可以自动处理这个问题）。

3. ‘**pam\_ldap**’ 模块将**提示**用户输入**密码**，然后检查 **`/etc/ldap.conf`** 中指示的 ldap 目录以验证用户。如果失败，如果 ‘pam\_unix’ 在验证用户身份时成功，操作仍然可以成功。如果 pam\_ldap 成功，将不会调用 ‘pam\_unix’。

4. 在这种情况下，‘**pam\_unix**’ 模块将**不会提示用户输入密码**。‘try\_first\_pass’ 参数将告诉模块**使用前一个模块**（在本例中为 pam\_ldap）给出的密码。它将尝试使用标准的 getpw\* 系统调用来验证用户。如果 pam\_unix 失败，并且 pam\_ldap 也失败，操作将失败。如果 pam\_ldap 失败，但 pam\_unix 成功，操作将成功（这在 root 不在 ldap 目录中，但仍在本地 /etc/passwd 文件中的情况下非常有帮助！）。
