<details>

<summary><strong>零基础学习AWS黑客攻击到高手</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>


PAM是一组模块的集合，它们基本上在系统上的服务和使用该服务的用户之间形成了一个屏障。这些模块可以有广泛不同的目的，从禁止特定UNIX组（或网络组，或子网...）的用户登录，到实施资源限制，以便您的‘研究’组不能占用系统资源。

# 配置文件

Solaris和其他商业UNIX系统有一个略有不同的配置模型，围绕一个单一文件**`/etc/pam.conf`**。在大多数Linux系统上，这些配置文件位于**`/etc/pam.d`**，并以服务命名 - 例如，‘登录’配置文件被称为**`/etc/pam.d/login`**。让我们快速看一下该文件的一个版本：
```text
auth required /lib/security/pam_securetty.so
auth required /lib/security/pam_nologin.so
auth sufficient /lib/security/pam_ldap.so
auth required /lib/security/pam_unix_auth.so try_first_pass
account sufficient /lib/security/pam_ldap.so
account required /lib/security/pam_unix_acct.so
password required /lib/security/pam_cracklib.so
password required /lib/security/pam_ldap.so
password required /lib/security/pam_pwdb.so use_first_pass
session required /lib/security/pam_unix_session.so
```
## **PAM 管理领域**

最左边的列可以包含四个独特的词，它们代表了 PAM 管理的四个领域：**auth**、**account**、**password** 和 **session**。虽然有许多模块支持这些领域中的不止一个（实际上，pam_unix 支持所有这些领域），但其他模块，例如 pam_cracklib，只适用于一个（在 pam_cracklib 的情况下是‘password’功能）。

* **auth**: ‘auth’ 领域（我称之为领域 - 文档将其称为‘管理组’或‘设施’）负责检查用户是否是他们所说的那个人。在这个区域中可以列出的模块**通常**支持**提示输入密码**。
* **account**: 这个区域负责广泛的可能的**账户验证功能**。有许多模块可用于这个设施。基于**检查组成员资格**、一天中的时间、用户账户是本地还是远程等条件对服务的使用进行限制，通常由支持此设施的模块强制执行。
* **password**: 这个区域的模块负责在**更新给定服务的密码**过程中所需的任何功能。大多数时候，这个部分相当‘平淡无奇’，只是调用一个模块，**会提示输入当前密码**，并且，假设成功了，提示你输入一个新的。其他模块也可以添加来执行**密码复杂性**或字典检查，例如由 pam_cracklib 和 pam_pwcheck 模块执行的那样。
* **session**: 这个区域的模块执行在为给定用户**设置或清理服务**期间可能发生的任何数量的事情。这可能包括任何数量的事情；启动系统范围的初始化脚本，执行特殊日志记录，**挂载用户的主目录**，或设置资源限制。

## **PAM 模块控制**

**中间列**包含一个关键字，本质上决定了如果模块**成功或失败**，**PAM 应该做什么**。这些关键字在 PAM 术语中被称为‘**控制**’。在 90% 的情况下，你可以使用一个常见的关键字（**requisite**、**required**、**sufficient** 或 **optional**）。然而，这只是释放 PAM 灵活性和力量的冰山一角。

* **required**: 如果一个‘required’模块返回的状态**不是‘成功’**，那么**操作最终总是会失败**，但只有在**调用了它下面的模块之后**。乍一看这似乎毫无意义，但它的目的是**始终以用户试图使用服务的角度来保持相同的行为方式**。最终效果是，对于潜在的黑客来说，变得**不可能****确定**是**哪个**模块导致了**失败**。
* **requisite**: 如果一个‘requisite’模块失败了，那么**操作**不仅**失败**，而且操作会**立即**以失败告终，而不调用任何其他模块。
* **sufficient**: 如果一个**sufficient**模块**成功了**，它足以满足该领域使用服务的充分模块的要求，并且**下面也列为‘sufficient’的模块不会被调用**。**如果它失败了，操作失败，除非在它之后调用的模块成功**。
* **optional**: 根据 pam(8) 手册页，一个‘optional’模块**只有在它是该设施堆栈中唯一的模块时才会导致操作失败**。

## 示例

在我们的示例文件中，我们为 auth 领域堆叠了四个模块：
```text
auth       required     /lib/security/pam_securetty.so
auth       required     /lib/security/pam_env.so
auth       sufficient   /lib/security/pam_ldap.so
auth       required     /lib/security/pam_unix.so try_first_pass
```
模块按顺序调用时，将会发生以下情况：

1. '**pam\_securetty**' 模块将检查其配置文件 **`/etc/securetty`**，并查看用于此登录的终端是否在文件中列出。如果**没有列出，将不允许 root 登录**。如果您尝试在“不好”的终端上以 root 身份登录，此模块将失败。由于它是“必需的”，它仍将调用堆栈中的所有模块。然而，即使它们每一个都成功了，登录也会失败。有趣的是，如果将模块列为“必要的”，操作将立即以失败告终，而不调用任何其他模块，无论它们的状态如何。
2. '**pam\_env**' 模块将根据管理员在 /etc/security/pam\_env.conf 中设置的内容**设置环境变量**。在 Redhat 9、Fedora Core 1 和 Mandrake 9.2 的默认设置中，此模块的配置文件实际上并未设置任何变量。这可能的一个好用途是为通过 SSH 登录的用户自动设置 DISPLAY 环境变量，这样如果他们想将 'xterm' 发送回远程桌面，就不必自己设置（尽管 OpenSSH 可以自动处理这个问题）。
3. '**pam\_ldap**' 模块将**提示**用户输入**密码**，然后检查 **`/etc/ldap.conf`** 中指示的 ldap 目录来认证用户。如果这失败了，如果 'pam\_unix' 成功认证用户，操作仍然可以成功。如果 pam\_ldap 成功，将不会调用 'pam\_unix'。
4. 在这种情况下，'**pam\_unix**' 模块**不会提示用户输入密码**。'try\_first\_pass' 参数将告诉模块**使用前一个模块提供的密码**（在这种情况下，是 pam\_ldap）。它将尝试使用标准的 getpw\* 系统调用来认证用户。如果 pam\_unix 失败，并且 pam\_ldap 也失败了，操作将失败。如果 pam\_ldap 失败，但 pam\_unix 成功，操作将成功（这在 root 不在 ldap 目录中，但仍在本地 /etc/passwd 文件中的情况下非常有帮助！）。

<details>

<summary><strong>从零开始学习 AWS 黑客攻击成为英雄，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。**

</details>
