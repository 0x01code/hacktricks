<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>


PAMは、システム上のサービスとそのサービスのユーザーとの間に形成されるモジュールの集合体です。モジュールは、特定のUNIXグループ（またはネットグループ、サブネットなど）からのログインを禁止することから、あなたの「研究」グループがシステムリソースを独占することを防ぐためのリソース制限を実装することまで、目的が大きく異なることがあります。

# 設定ファイル

Solarisや他の商用UNIXシステムは、**`/etc/pam.conf`**という単一のファイルを中心としたやや異なる設定モデルを持っています。ほとんどのLinuxシステムでは、これらの設定ファイルは**`/etc/pam.d`**にあり、サービス名にちなんで命名されています。例えば、「login」の設定ファイルは**`/etc/pam.d/login`**と呼ばれています。そのファイルのバージョンを簡単に見てみましょう：
```text
auth required /lib/security/pam_securetty.so
auth required /lib/security/pam_nologin.so
auth sufficient /lib/security/pam_ldap.so
auth required /lib/security/pam_unix_auth.so try_first_pass
account sufficient /lib/security/pam_ldap.so
account required /lib/security/pam_unix_acct.so
password required /lib/security/pam_cracklib.so
password required /lib/security/pam_ldap.so
password required /lib/security/pam_pwdb.so use_first_pass
session required /lib/security/pam_unix_session.so
```
## **PAM 管理領域**

最左列には、PAM 管理の四つの領域を表す四つのユニークな単語が含まれています: **auth**, **account**, **password** と **session**。多くのモジュールがこれらの領域の複数をサポートしています（実際、pam_unix は全てをサポートしています）、他のモジュール、例えば pam_cracklib は一つの領域（pam_cracklib の場合は 'password' 施設）にのみ適しています。

* **auth**: 'auth' 領域（私はそれを領域と呼んでいます - ドキュメントでは '管理グループ' または '施設' として参照されています）は、ユーザーが自分の言う通りの人物であるかを確認する責任があります。このエリアにリストされるモジュールは、**一般的に** **パスワードのプロンプト**をサポートしています。
* **account**: このエリアは、**アカウント検証機能**の広範な可能性に責任があります。この施設には多くのモジュールが利用可能です。サービスの使用に対する制約は、**グループメンバーシップの確認**、時間帯、ユーザーアカウントがローカルかリモートかなど、一般的にこの施設をサポートするモジュールによって強制されます。
* **password**: このエリアのモジュールは、特定のサービスの**パスワード更新**に必要な機能に責任があります。ほとんどの場合、このセクションはかなり 'ありふれた' もので、単に**現在のパスワードのプロンプト**を表示するモジュールを呼び出し、それが成功したと仮定すると、新しいパスワードのプロンプトを表示します。他のモジュールも追加されて、**パスワードの複雑さ**や辞書チェックなどを実行することもできます。例えば、pam_cracklib や pam_pwcheck モジュールが実行します。
* **session**: このエリアのモジュールは、特定のユーザーのサービスの**セットアップまたはクリーンアップ中に発生する**様々なことを実行します。これには、システム全体の初期化スクリプトの起動、特別なログの実行、**ユーザーのホームディレクトリのマウント**、リソース制限の設定など、数多くのことが含まれるかもしれません。

## **PAM モジュールコントロール**

**中央の列**には、モジュールが成功した場合や失敗した場合に PAM がどうするべきかを基本的に決定するキーワードが含まれています。これらのキーワードは PAM 用語で 'コントロール' と呼ばれています。90%のケースでは、一般的なキーワード（**requisite**、**required**、**sufficient**、**optional**）のいずれかを使用できます。しかし、これは PAM の柔軟性とパワーを解き放つための氷山の一角に過ぎません。

* **required**: 'required' モジュールが **'success' でない** 状態を返した場合、**操作は最終的に常に失敗します**が、それは**下にあるモジュールが呼び出された後**です。一見無意味に思えるかもしれませんが、サービスを利用しようとするユーザーの視点から**常に同じ方法で行動する**という目的を果たします。その結果、潜在的なクラッカーが**どの** **モジュール**が**失敗**を引き起こしたかを**特定する**ことが**不可能**になります。
* **requisite**: 'requisite' モジュールが失敗すると、**操作**はただちに**失敗**し、他のモジュールを呼び出すことなく失敗で**即座に** **終了**します。
* **sufficient**: **十分な** モジュールが**成功**すると、その領域でのサービスの使用に十分であり、**それより下にリストされている 'sufficient' とされたモジュールは呼び出されません**。**失敗した場合、操作は失敗しますが、それ以降に呼び出されたモジュールが成功した場合を除きます**。
* **optional**: 'optional' モジュールは、pam(8) manpage によると、**その施設のスタック内で唯一のモジュールである場合にのみ操作が失敗する**とされています。

## 例

私たちの例のファイルでは、auth 領域に対して四つのモジュールが積み重ねられています：
```text
auth       required     /lib/security/pam_securetty.so
auth       required     /lib/security/pam_env.so
auth       sufficient   /lib/security/pam_ldap.so
auth       required     /lib/security/pam_unix.so try_first_pass
```
モジュールが順番に呼び出されると、次のようなことが起こります：

1. '**pam\_securetty**' モジュールは、その設定ファイル **`/etc/securetty`** をチェックし、このログインに使用されている端末がファイルにリストされているかどうかを確認します。**もしリストされていなければ、root ログインは許可されません**。'悪い'端末で root としてログインしようとすると、このモジュールは失敗します。'required' としてリストされているため、スタック内のすべてのモジュールが呼び出されます。しかし、それらがすべて成功しても、ログインは失敗します。注目すべき点は、もしモジュールが 'requisite' としてリストされていた場合、他のモジュールを呼び出すことなく、直ちに失敗で操作が終了することです。
2. '**pam\_env**' モジュールは、管理者が /etc/security/pam\_env.conf で設定した内容に基づいて **環境変数を設定** します。Redhat 9、Fedora Core 1、および Mandrake 9.2 のデフォルト設定では、このモジュールの設定ファイルは実際には変数を設定しません。これの良い使用例は、SSH 経由でログインするユーザーに対して DISPLAY 環境変数を自動的に設定することで、リモートデスクトップに 'xterm' を戻したい場合に自分で設定する必要がないようにすることです（ただし、これは OpenSSH によって自動的に処理されることもあります）。
3. '**pam\_ldap**' モジュールは、ユーザーに **パスワードの入力を促し**、**`/etc/ldap.conf`** で指示された ldap ディレクトリをチェックしてユーザーを認証します。これが失敗した場合でも、'pam\_unix' がユーザーの認証に成功すれば操作は成功する可能性があります。pam\_ldap が成功した場合、'pam\_unix' は呼び出されません。
4. この場合の '**pam\_unix**' モジュールは、**ユーザーにパスワードの入力を促しません**。'try\_first\_pass' 引数は、モジュールに **先行するモジュールから与えられたパスワードを使用するように指示** します（この場合は pam\_ldap）。標準の getpw\* システムコールを使用してユーザーを認証しようとします。もし pam\_unix が失敗し、pam\_ldap も失敗していた場合、操作は失敗します。pam\_ldap が失敗しても、pam\_unix が成功すれば、操作は成功します（これは、root が ldap ディレクトリには含まれていないが、ローカルの /etc/passwd ファイルには存在する場合に非常に役立ちます！）。



<details>

<summary><strong>AWS ハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) コレクションをチェックしてください。
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegram グループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォロー**してください。
* **HackTricks** の [**GitHub リポジトリ**](https://github.com/carlospolop/hacktricks) に PR を提出して、あなたのハッキングのコツを共有してください。

</details>
