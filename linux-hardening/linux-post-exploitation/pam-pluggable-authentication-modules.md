<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>


PAM是一组模块，基本上形成了系统上的服务和服务的用户之间的屏障。这些模块可以有各种不同的目的，从禁止特定UNIX组（或netgroup、子网...）的用户登录，到实现资源限制，以防止你的“研究”组占用系统资源。

# 配置文件

Solaris和其他商业UNIX系统有一个稍微不同的配置模型，以一个单独的文件**`/etc/pam.conf`**为中心。在大多数Linux系统上，这些配置文件位于**`/etc/pam.d`**目录下，并以服务的名称命名 - 例如，“登录”配置文件被称为**`/etc/pam.d/login`**。让我们快速查看一个版本的该文件：
```text
auth required /lib/security/pam_securetty.so
auth required /lib/security/pam_nologin.so
auth sufficient /lib/security/pam_ldap.so
auth required /lib/security/pam_unix_auth.so try_first_pass
account sufficient /lib/security/pam_ldap.so
account required /lib/security/pam_unix_acct.so
password required /lib/security/pam_cracklib.so
password required /lib/security/pam_ldap.so
password required /lib/security/pam_pwdb.so use_first_pass
session required /lib/security/pam_unix_session.so
```
## **PAM管理领域**

最左边的列包含四个独特的单词，代表PAM管理的四个领域：**auth**（认证）、**account**（账户）、**password**（密码）和**session**（会话）。虽然有许多模块支持多个领域（例如，pam_unix支持所有领域），但其他模块（例如pam_cracklib）只适用于一个领域（在pam_cracklib的情况下是“password”功能）。

* **auth**：‘auth’领域（我称之为领域，文档中称之为‘管理组’或‘设施’）负责检查用户是否是他们所说的人。可以在此区域中列出的模块通常支持提示输入密码。
* **account**：此区域负责各种可能的账户验证功能。有许多可用于此功能的模块。通常，支持此功能的模块会根据检查组成员资格、时间、用户帐户是本地还是远程等来限制对服务的使用。
* **password**：此区域中的模块负责在为给定服务更新密码的过程中需要的任何功能。大多数情况下，此部分非常普通，只需调用一个模块，该模块将提示您输入当前密码，并在成功后提示您输入新密码。还可以添加其他模块来执行密码复杂性或字典检查，例如pam_cracklib和pam_pwcheck模块执行的操作。
* **session**：此区域中的模块执行在为给定用户设置或清理服务期间发生的任何事情。这可能包括许多事情；启动系统范围的初始化脚本、执行特殊日志记录、挂载用户的主目录或设置资源限制。

## **PAM模块控制**

**中间列**包含一个关键字，实际上确定了**如果模块成功或失败，PAM应该执行什么操作**。在PAM中，这些关键字称为‘**控制**’。在90%的情况下，您可以使用常见的关键字（**requisite**、**required**、**sufficient**或**optional**）。然而，这只是释放PAM的灵活性和功能的冰山一角。

* **required**：如果‘required’模块返回的状态不是‘success’，则**操作将始终失败**，但只有在调用**它下面的模块**之后才会失败。乍一看，这似乎毫无意义，但它的目的是从用户试图使用服务的角度始终以相同的方式行事。其净效果是，潜在的黑客**无法确定**是哪个模块导致了**失败**。
* **requisite**：如果‘requisite’模块失败，则**操作不仅失败**，而且操作**立即终止**并以失败结束，而不调用任何其他模块。
* **sufficient**：如果**sufficient**模块**成功**，则足以满足该领域中足够模块对于使用该服务的要求，**不会调用下面列出的其他被标记为‘sufficient’的模块**。**如果失败，则操作失败，除非在其后调用的模块成功**。
* **optional**：根据pam\(8\)手册，‘optional’模块**只会在该领域的堆栈中只有它一个模块时导致操作失败**。

## 示例

在我们的示例文件中，我们为auth领域堆叠了四个模块：
```text
auth       required     /lib/security/pam_securetty.so
auth       required     /lib/security/pam_env.so
auth       sufficient   /lib/security/pam_ldap.so
auth       required     /lib/security/pam_unix.so try_first_pass
```
由于模块按顺序调用，以下是会发生的情况：

1. '**pam\_securetty**'模块将检查其配置文件**`/etc/securetty`**，并查看是否在文件中列出了用于此登录的终端。如果**没有列出，将不允许root登录**。如果您尝试在“不良”终端上以root身份登录，此模块将失败。由于它是“required”，它仍将调用堆栈中的所有模块。但是，即使它们都成功，登录也将失败。有趣的是，如果将模块列为“requisite”，则操作将立即以失败终止，而不管其他模块的状态如何。
2. '**pam\_env**'模块将根据管理员在**`/etc/security/pam\_env.conf`**中设置的内容设置环境变量。在Redhat 9、Fedora Core 1和Mandrake 9.2的默认设置中，此模块的配置文件实际上不设置任何变量。一个很好的用途可能是为通过SSH登录的用户自动设置DISPLAY环境变量，这样他们就不必自己设置了，如果他们想将“xterm”发送回远程桌面（尽管OpenSSH可以自动处理这个问题）。
3. '**pam\_ldap**'模块将**提示**用户输入**密码**，然后检查**`/etc/ldap.conf`**中指定的ldap目录以对用户进行身份验证。如果失败，如果‘pam\_unix’成功对用户进行身份验证，操作仍然可以成功。如果pam\_ldap成功，将不会调用‘pam\_unix’。
4. 在这种情况下，'**pam\_unix**'模块将**不会提示用户输入密码**。'try\_first\_pass'参数将告诉模块使用前一个模块（在本例中为pam\_ldap）提供的密码。它将尝试使用标准的getpw\*系统调用对用户进行身份验证。如果pam\_unix失败，并且pam\_ldap也失败，操作将失败。如果pam\_ldap失败，但pam\_unix成功，操作将成功（这在root不在ldap目录中，但仍在本地的/etc/passwd文件中的情况下非常有帮助！）。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 您在**网络安全公司**工作吗？您想在HackTricks中看到您的**公司广告**吗？或者您想获得最新版本的PEASS或下载PDF格式的HackTricks吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks衣物**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享您的黑客技巧**。

</details>
