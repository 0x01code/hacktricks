<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>


PAMは、システム上のサービスとそのユーザーの間に本質的にバリアを形成するモジュールのコレクションです。これらのモジュールには、特定のUNIXグループ（またはネットグループ、サブネットなど）からのユーザーログインを禁止する、システムリソースを占有しないようにリソース制限を実装するなど、さまざまな目的があります。

# 設定ファイル

Solarisおよび他の商用UNIXシステムは、**`/etc/pam.conf`**という単一のファイルを中心にしたわずかに異なる設定モデルを持っています。ほとんどのLinuxシステムでは、これらの設定ファイルは**`/etc/pam.d`**にあり、サービスに基づいて名前が付けられています。たとえば、'login'の設定ファイルは**`/etc/pam.d/login`**と呼ばれます。以下はそのファイルのバージョンです：
```text
auth required /lib/security/pam_securetty.so
auth required /lib/security/pam_nologin.so
auth sufficient /lib/security/pam_ldap.so
auth required /lib/security/pam_unix_auth.so try_first_pass
account sufficient /lib/security/pam_ldap.so
account required /lib/security/pam_unix_acct.so
password required /lib/security/pam_cracklib.so
password required /lib/security/pam_ldap.so
password required /lib/security/pam_pwdb.so use_first_pass
session required /lib/security/pam_unix_session.so
```
## **PAM管理の領域**

左側の列には、PAM管理の4つの領域を表す4つのユニークな単語が含まれています：**auth**、**account**、**password**、**session**。これらの領域をサポートする多くのモジュールがあります（実際には、pam_unixはすべてをサポートしています）、一方、pam_cracklibのような他のモジュールは1つにしか適していません（pam_cracklibの場合は「password」機能）。

* **auth**：「auth」領域（私はこれを領域と呼んでいますが、ドキュメントでは「管理グループ」または「施設」と呼ばれています）は、ユーザーが自分自身であることを確認する責任があります。この領域にリストアップできるモジュールは、**パスワードの入力を求める**ことが一般的です。
* **account**：この領域は、さまざまな**アカウントの検証機能**に責任を持ちます。この施設には多くのモジュールがあります。グループメンバーシップのチェック、時刻、ユーザーアカウントがローカルかリモートかなどに基づいてサービスの使用に制約を加えることは、一般的にこの施設をサポートするモジュールによって強制されます。
* **password**：この領域のモジュールは、特定のサービスの**パスワードの更新**に必要な機能を担当します。ほとんどの場合、このセクションは非常に単調です。現在のパスワードの入力を求めるモジュールを呼び出し、それが成功した場合は新しいパスワードの入力を求めます。他のモジュールを追加して、パスワードの複雑さや辞書のチェックなども実行できます。これは、pam_cracklibやpam_pwcheckモジュールによって実行されるものです。
* **session**：この領域のモジュールは、特定のユーザーのサービスの**セットアップまたはクリーンアップ**中に発生するさまざまな操作を実行します。これには、システム全体の初期化スクリプトの起動、特別なログ記録、ユーザーのホームディレクトリのマウント、リソース制限の設定など、さまざまな操作が含まれる場合があります。

## **PAMモジュールの制御**

**中央の列**には、モジュールが成功または失敗した場合に**PAMがどのように動作するかを決定するキーワード**が含まれています。これらのキーワードはPAM用語では「**制御**」と呼ばれます。90％の場合、一般的なキーワード（**requisite**、**required**、**sufficient**、**optional**）のいずれかを使用できます。ただし、これはPAMの柔軟性とパワーを解放するための氷山の一角に過ぎません。

* **required**：「required」モジュールが「成功」でないステータスを返す場合、**操作は常に失敗します**が、その後に**下位のモジュールが呼び出されます**。初めて見ると無意味に思えるかもしれませんが、これはサービスを利用しようとするユーザーの視点からは常に同じ方法で動作することを目的としています。その結果、潜在的なクラッカーが**どのモジュール**が**失敗**の原因であるかを**特定することが不可能**になります。
* **requisite**：「requisite」モジュールが失敗すると、**操作は失敗し、他のモジュールは呼び出されずに即座に終了**します。
* **sufficient**：**sufficient**モジュールが**成功すると、その領域の十分なモジュールの要件を満たすのに十分です**。また、その下にリストされている「sufficient」としても指定されているモジュールは呼び出されません。**失敗すると、後続のモジュールが成功しても操作は失敗します**。
* **optional**：「optional」モジュールは、pam\(8\)マニュアルによれば、その施設のスタック内で唯一のモジュールである場合にのみ、操作が失敗することになります。

## 例

例のファイルでは、auth領域に4つのモジュールがスタックされています：
```text
auth       required     /lib/security/pam_securetty.so
auth       required     /lib/security/pam_env.so
auth       sufficient   /lib/security/pam_ldap.so
auth       required     /lib/security/pam_unix.so try_first_pass
```
モジュールは順番に呼び出されるため、次のようなことが起こります：

1. '**pam_securetty**'モジュールは、その設定ファイルである**`/etc/securetty`**をチェックし、ログインに使用されている端末がファイルにリストされているかどうかを確認します。もしリストにない場合、rootログインは許可されません。もし「悪い」端末でrootとしてログインしようとすると、このモジュールは失敗します。このモジュールは「必須」であるため、スタック内のすべてのモジュールを呼び出します。しかし、それらのすべてが成功しても、ログインは失敗します。興味深いことに、もしモジュールが「必須」ではなく「必要」としてリストされている場合、操作は失敗として即座に終了し、他のモジュールのステータスに関係なく、呼び出されません。

2. '**pam_env**'モジュールは、管理者が**`/etc/security/pam_env.conf`**で設定した内容に基づいて環境変数を設定します。Redhat 9、Fedora Core 1、およびMandrake 9.2のデフォルト設定では、このモジュールの設定ファイルは実際には変数を設定しません。SSH経由でログインするユーザーにDISPLAY環境変数を自動的に設定するのに役立ちます（ただし、これはOpenSSHが自動的に処理することもできます）。

3. '**pam_ldap**'モジュールは、ユーザーに**パスワードを入力**してから、**`/etc/ldap.conf`**で指定されたldapディレクトリを認証するために使用されます。これが失敗した場合、操作は「pam_unix」がユーザーを認証することに成功した場合にも成功する可能性があります。pam_ldapが成功した場合、pam_unixは呼び出されません。

4. '**pam_unix**'モジュールは、この場合、ユーザーにパスワードを入力させません。'try_first_pass'引数は、モジュールに対して前のモジュール（この場合はpam_ldap）から与えられたパスワードを使用するように指示します。標準のgetpw\*システムコールを使用してユーザーを認証しようとします。pam_unixが失敗し、pam_ldapも失敗した場合、操作は失敗します。pam_ldapが失敗したが、pam_unixが成功した場合、操作は成功します（これは、rootがldapディレクトリに存在しないが、ローカルの/etc/passwdファイルには存在する場合に非常に役立ちます！）。
