# Linux Post-Exploitation

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories senden.

</details>

## Mitschneiden von Anmeldepassw√∂rtern mit PAM

Konfigurieren wir ein PAM-Modul, um jedes Passwort zu protokollieren, das ein Benutzer zum Anmelden verwendet. Wenn Sie nicht wissen, was PAM ist, √ºberpr√ºfen Sie:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Weitere Details finden Sie im [Originalbeitrag](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Hier handelt es sich nur um eine Zusammenfassung:

**Technik√ºbersicht:**
Pluggable Authentication Modules (PAM) bieten Flexibilit√§t bei der Verwaltung der Authentifizierung in Unix-basierten Systemen. Sie k√∂nnen die Sicherheit verbessern, indem sie Anmeldeprozesse anpassen, bergen jedoch auch Risiken bei unsachgem√§√üer Verwendung. Diese Zusammenfassung beschreibt eine Technik zum Erfassen von Anmeldeinformationen mithilfe von PAM sowie Ma√ünahmen zur Minderung.

**Erfassen von Anmeldeinformationen:**
- Ein Bash-Skript mit dem Namen `toomanysecrets.sh` wird erstellt, um Anmeldeversuche zu protokollieren. Dabei werden das Datum, der Benutzername (`$PAM_USER`), das Passwort (√ºber stdin) und die IP-Adresse des Remote-Hosts (`$PAM_RHOST`) in `/var/log/toomanysecrets.log` erfasst.
- Das Skript wird ausf√ºhrbar gemacht und in die PAM-Konfiguration (`common-auth`) integriert, wobei das Modul `pam_exec.so` mit Optionen verwendet wird, um leise zu laufen und das Authentifizierungstoken dem Skript zur Verf√ºgung zu stellen.
- Der Ansatz zeigt, wie ein kompromittierter Linux-Host heimlich Anmeldeinformationen protokollieren kann.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**F√ºr weitere Details siehe den [Originalbeitrag](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Hier ist nur eine Zusammenfassung:

Das Pluggable Authentication Module (PAM) ist ein unter Linux verwendetes System zur Benutzerauthentifizierung. Es basiert auf drei Hauptkonzepten: **Benutzername**, **Passwort** und **Dienst**. Konfigurationsdateien f√ºr jeden Dienst befinden sich im Verzeichnis `/etc/pam.d/`, wo gemeinsam genutzte Bibliotheken die Authentifizierung verwalten.

**Ziel**: PAM so √§ndern, dass die Authentifizierung mit einem bestimmten Passwort m√∂glich ist, wodurch das tats√§chliche Benutzerpasswort umgangen wird. Dies konzentriert sich insbesondere auf die gemeinsam genutzte Bibliothek `pam_unix.so`, die von der Datei `common-auth` verwendet wird und von fast allen Diensten zur Passwort√ºberpr√ºfung eingebunden wird.

### Schritte zur Modifizierung von `pam_unix.so`:

1. **Authentifizierungsanweisung finden** in der Datei `common-auth`:
- Die Zeile, die das Benutzerpasswort √ºberpr√ºft, ruft `pam_unix.so` auf.
2. **Quellcode √§ndern**:
- F√ºgen Sie eine bedingte Anweisung in der Quelldatei `pam_unix_auth.c` hinzu, die den Zugriff gew√§hrt, wenn ein vordefiniertes Passwort verwendet wird. Andernfalls wird der √ºbliche Authentifizierungsprozess fortgesetzt.
3. **Kompilieren und Ersetzen** der modifizierten Bibliothek `pam_unix.so` im entsprechenden Verzeichnis.
4. **Testen**:
- Der Zugriff wird mit dem vordefinierten Passwort f√ºr verschiedene Dienste (Anmeldung, SSH, sudo, su, Bildschirmschoner) gew√§hrt, w√§hrend normale Authentifizierungsprozesse unber√ºhrt bleiben.

{% hint style="info" %}
Diesen Vorgang k√∂nnen Sie mit [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor) automatisieren.
{% endhint %}

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) **bei oder folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie Pull Requests an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) **und** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories senden.**

</details>
