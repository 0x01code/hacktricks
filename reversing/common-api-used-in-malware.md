<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

# Gen√©rico

## Redes

| Raw Sockets   | WinAPI Sockets |
| ------------- | -------------- |
| socket()      | WSAStratup()   |
| bind()        | bind()         |
| listen()      | listen()       |
| accept()      | accept()       |
| connect()     | connect()      |
| read()/recv() | recv()         |
| write()       | send()         |
| shutdown()    | WSACleanup()   |

## Persistencia

| Registro          | Archivo       | Servicio                     |
| ----------------- | ------------- | ---------------------------- |
| RegCreateKeyEx()  | GetTempPath() | OpenSCManager                |
| RegOpenKeyEx()    | CopyFile()    | CreateService()              |
| RegSetValueEx()   | CreateFile()  | StartServiceCtrlDispatcher() |
| RegDeleteKeyEx()  | WriteFile()   |                              |
| RegGetValue()     | ReadFile()    |                              |

## Encriptaci√≥n

| Nombre                 |
| ---------------------- |
| WinCrypt               |
| CryptAcquireContext()  |
| CryptGenKey()          |
| CryptDeriveKey()       |
| CryptDecrypt()         |
| CryptReleaseContext()  |

## Anti-An√°lisis/VM

| Nombre de la Funci√≥n                                      | Instrucciones de Ensamblador |
| --------------------------------------------------------- | --------------------------- |
| IsDebuggerPresent()                                       | CPUID()                     |
| GetSystemInfo()                                           | IN()                        |
| GlobalMemoryStatusEx()                                    |                             |
| GetVersion()                                              |                             |
| CreateToolhelp32Snapshot \[Comprobar si un proceso se est√° ejecutando] |                             |
| CreateFileW/A \[Comprobar si un archivo existe]            |                             |

## Sigilo

| Nombre                    |                                                                            |
| ------------------------- | -------------------------------------------------------------------------- |
| VirtualAlloc              | Asignar memoria (empaquetadores)                                            |
| VirtualProtect            | Cambiar los permisos de memoria (empaquetador que da permiso de ejecuci√≥n a una secci√≥n) |
| ReadProcessMemory         | Inyecci√≥n en procesos externos                                             |
| WriteProcessMemoryA/W     | Inyecci√≥n en procesos externos                                             |
| NtWriteVirtualMemory      |                                                                            |
| CreateRemoteThread        | Inyecci√≥n de DLL/proceso...                                                |
| NtUnmapViewOfSection      |                                                                            |
| QueueUserAPC              |                                                                            |
| CreateProcessInternalA/W  |                                                                            |

## Ejecuci√≥n

| Nombre de la Funci√≥n    |
| ----------------------- |
| CreateProcessA/W        |
| ShellExecute            |
| WinExec                 |
| ResumeThread            |
| NtResumeThread          |

## Varios

* GetAsyncKeyState() -- Registro de teclas
* SetWindowsHookEx -- Registro de teclas
* GetForeGroundWindow -- Obtener el nombre de la ventana en ejecuci√≥n (o el sitio web de un navegador)
* LoadLibrary() -- Importar biblioteca
* GetProcAddress() -- Importar biblioteca
* CreateToolhelp32Snapshot() -- Enumerar procesos en ejecuci√≥n
* GetDC() -- Captura de pantalla
* BitBlt() -- Captura de pantalla
* InternetOpen(), InternetOpenUrl(), InternetReadFile(), InternetWriteFile() -- Acceder a Internet
* FindResource(), LoadResource(), LockResource() -- Acceder a los recursos del ejecutable

# T√©cnicas de Malware

## Inyecci√≥n de DLL

Ejecuta una DLL arbitraria dentro de otro proceso

1. Localiza el proceso en el que se va a inyectar la DLL maliciosa: CreateToolhelp32Snapshot, Process32First, Process32Next
2. Abre el proceso: GetModuleHandle, GetProcAddress, OpenProcess
3. Escribe la ruta de la DLL dentro del proceso: VirtualAllocEx, WriteProcessMemory
4. Crea un hilo en el proceso que cargar√° la DLL maliciosa: CreateRemoteThread, LoadLibrary

Otras funciones a utilizar: NTCreateThreadEx, RtlCreateUserThread

## Inyecci√≥n de DLL Reflectante

Carga una DLL maliciosa sin llamar a las llamadas normales de la API de Windows.\
La DLL se mapea dentro de un proceso, resolver√° las direcciones de importaci√≥n, corregir√° las reubicaciones y llamar√° a la funci√≥n DllMain.
## Secuestro de hilos

Encuentra un hilo de un proceso y haz que cargue una DLL maliciosa

1. Encuentra el hilo objetivo: CreateToolhelp32Snapshot, Thread32First, Thread32Next
2. Abre el hilo: OpenThread
3. Suspende el hilo: SuspendThread
4. Escribe la ruta de la DLL maliciosa dentro del proceso v√≠ctima: VirtualAllocEx, WriteProcessMemory
5. Reanuda el hilo cargando la biblioteca: ResumeThread

## Inyecci√≥n PE

Inyecci√≥n de Ejecuci√≥n Port√°til: El ejecutable se escribir√° en la memoria del proceso v√≠ctima y se ejecutar√° desde all√≠.

## Hollowing de procesos

El malware desmapear√° el c√≥digo leg√≠timo de la memoria del proceso y cargar√° un binario malicioso

1. Crea un nuevo proceso: CreateProcess
2. Desmapea la memoria: ZwUnmapViewOfSection, NtUnmapViewOfSection
3. Escribe el binario malicioso en la memoria del proceso: VirtualAllocEx, WriteProcessMemory
4. Establece el punto de entrada y ejecuta: SetThreadContext, ResumeThread

# Hooking

* La **SSDT** (**System Service Descriptor Table**) apunta a funciones del kernel (ntoskrnl.exe) o controlador GUI (win32k.sys) para que los procesos de usuario puedan llamar a estas funciones.
* Un rootkit puede modificar estos punteros a direcciones que √©l controla.
* **IRP** (**I/O Request Packets**) transmite fragmentos de datos de un componente a otro. Casi todo en el kernel utiliza IRPs y cada objeto de dispositivo tiene su propia tabla de funciones que se pueden enganchar: DKOM (Direct Kernel Object Manipulation).
* La **IAT** (**Import Address Table**) es √∫til para resolver dependencias. Es posible enganchar esta tabla para secuestrar el c√≥digo que se llamar√°.
* Hooks de **EAT** (**Export Address Table**). Estos hooks se pueden hacer desde el **userland**. El objetivo es enganchar funciones exportadas por DLLs.
* **Inline Hooks**: Este tipo es dif√≠cil de lograr. Esto implica modificar el c√≥digo de las propias funciones. Tal vez colocando un salto al principio de esto.


<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos de amenazas proactivas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm_source=referral&utm_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al repositorio [hacktricks](https://github.com/carlospolop/hacktricks) y [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
