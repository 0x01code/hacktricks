<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使って、<strong>ゼロからヒーローまでAWSハッキングを学ぼう</strong>！</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
- **ハッキングテクニックを共有する**には、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>


# 基本用語

- **スマートコントラクト**: スマートコントラクトは、**特定の条件が満たされたときに実行されるブロックチェーン上のプログラム**です。通常、**合意**の**実行**を自動化するために使用され、すべての参加者が中間業者の関与や時間の損失なしに即座に結果を確認できます（[こちら](https://www.ibm.com/topics/smart-contracts)から）。
- 基本的に、スマートコントラクトは、人々が契約にアクセスして受け入れるときに実行される**コードの一部**です。スマートコントラクトは**ブロックチェーンで実行**され（その結果は不変に保存され）、人々がそれを受け入れる前に読むことができます。
- **dApps**: **分散型アプリケーション**は、**スマートコントラクト**の上に実装されます。通常、ユーザーがアプリとやり取りできるフロントエンドがあり、**バックエンド**は公開されています（したがって監査可能）し、**スマートコントラクト**として実装されています。場合によっては、データベースの使用が必要となり、Ethereumブロックチェーンは各アカウントに一定のストレージを割り当てます。
- **トークン＆コイン**: **コイン**は**デジタル通貨**として機能し、**トークン**は**何らかの価値を表す**ものですが、コインではありません。
- **ユーティリティトークン**: これらのトークンは、ユーザーが**後で特定のサービスにアクセス**できるようにします（特定の環境で価値を持つものです）。
- **セキュリティトークン**: これらは**所有権**またはある資産を表します。
- **DeFi**: **分散型金融**。
- **DEX: 分散型取引所プラットフォーム**。
- **DAOs**: **分散型自治組織**。

# コンセンサスメカニズム

ブロックチェーントランザクションが認識されるためには、それが**ブロックチェーンに追加**される必要があります。検証者（マイナー）がこれを行います。ほとんどのプロトコルでは、これを行うと**報酬を受け取ります**。ブロックチェーンが安全であるためには、**悪意のあるユーザーやグループが検証の大部分を占有するのを防ぐメカニズム**が必要です。

Proof of workは、よく使われるコンセンサスメカニズムで、トランザクションを検証するために計算能力の検証を使用し、潜在的な攻撃者が検証者ネットワークの計算能力の大部分を取得する必要があります。

## Proof Of Work（PoW）

これは、トランザクションを検証するために**計算能力の検証**を使用し、潜在的な攻撃者が検証者ネットワークの計算能力の大部分を取得する必要があるメカニズムです。\
**マイナー**は**複数のトランザクションを選択**し、その後**Proof Of Workの計算を開始**します。**計算リソースが最も多いマイナー**がProof of Workを**早く完了**し、すべてのトランザクションの手数料を受け取る可能性が高くなります。

## Proof Of Stake（PoS）

PoSは、検証者が一定量のブロックチェーントークンを持っていることを要求することで、**潜在的な攻撃者が攻撃を行うためにはブロックチェーン上のトークンの大部分を取得する必要がある**ようにします。\
この種のコンセンサスでは、マイナーが持っているトークンが多いほど、そのマイナーが次のブロックを作成する可能性が高くなります。\
PoWと比較して、これによりマイナーが消費するエネルギーが大幅に**削減**されます。

# Bitcoin

## トランザクション

単純な**トランザクション**は、アドレスから別のアドレスへの**資金移動**です。\
Bitcoinの**アドレス**は**公開鍵**のハッシュであり、したがって、アドレスからトランザクションを行うには、その公開鍵（アドレス）に関連付けられた秘密鍵を知っている必要があります。\
その後、**トランザクション**が実行されると、そのトランザクションはアドレスの秘密鍵で**署名**され、トランザクションが**正当であることを示します**。

Bitcoinでデジタル署名を生成する最初の部分は、次のように数学的に表現できます：\
_**Sig**_ = _**Fsig**_(_**Fhash**_(_**m**_),_**dA**_)

ここで：

- _d_**A**は署名の**秘密鍵**
- _m_は**トランザクション**
- Fhashはハッシュ関数
- Fsigは署名アルゴリズム
- Sigは生成された署名

署名関数（Fsig）は、RとSからなる署名（Sig）を生成します。

RとSが計算された後、それらはDER（Distinguished Encoding Rules）として知られる国際標準エンコーディングスキームを使用してエンコードされたバイトストリームに直列化されます。署名が有効であることを検証するには、署名検証アルゴリズムが使用されます。デジタル署名の検証には、次のものが必要です：

- 署名（RとS）
- トランザクションハッシュ
- 署名を作成するために使用された秘密鍵に対応する公開鍵

署名の検証は、実際には、秘密鍵の所有者（公開鍵を生成した秘密鍵の所有者）だけがトランザクションに署名を生成できた可能性があることを意味します。署名検証アルゴリズムは、署名が実際に有効である場合に「TRUE」を返します。

### マルチシグネチャトランザクション

マルチシグネチャ**アドレス**は、複数のECDSA秘密鍵に関連付けられたアドレスです。最も単純なタイプはm-of-nアドレスであり、n個の秘密鍵に関連付けられており、このアドレスからビットコインを送信するには、少なくともm個の鍵から署名が必要です。マルチシグネチャ**トランザクション**は、マルチシグネチャアドレスから資金を送信するトランザクションです。

### トランザクションフィールド

各Bitcoinトランザクションにはいくつかのフィールドがあります：

- **Inputs**: **ビットコイン**が**送信元のアドレス**と金額
- **Outputs**: 各**出力**に**転送される**アドレスと金額
- **Fee:** トランザクションの**マイナーに支払われる**金額
- **Script\_sig**: トランザクションのスクリプト署名
- **Script\_type**: トランザクションのタイプ

トランザクションには**2つの主要なタイプ**があります：

- **P2PKH: "公開鍵ハッシュへ支払い"**: これがトランザクションが行われる方法です。**送信者**に、有効な**署名**（秘密鍵から）と**公開鍵**を提供することを要求します。トランザクションの出力スクリプトは、署名と公開鍵を使用し、一部の暗号関数を介して**公開鍵ハッシュと一致するかどうか**を確認し、一致する場合は**資金が使える**ようになります。この方法では、セキュリティを高めるために公開鍵をハッシュの形で隠します。
- **P2SH: "スクリプトハッシュへ支払い"**: トランザクションの出力は、単に**スクリプト**（つまり、このお金を送りたい人がスクリプトを送信する）であり、特定のパラメータで実行されると`true`または`false`のブール値が結果として得られます。マイナーが出力スクリプトを提供されたパラメータで実行し、`true`になると、**資金は希望の出力に送信**されます。`P2SH`は、**マルチシグネチャ**ウォレットに使用され、トランザクションを受け入れる前に複数の署名をチェックするロジックを出力スクリプトに作成します。`P2SH`は、誰でも、または誰もが資金を使えるようにするためにも使用できます。P2SHトランザクションの出力スクリプトが`true`の場合、パラメータを提供せずに出力を使おうとすると、結果が`1`になり、誰でもが試みると資金が使えるようになります。これは、`0`を返すスクリプトにも適用され、誰もが試みても出力を使えなくなります。

## Lightning Network

このプロトコルは、**チャネルに複数のトランザクションを実行**し、**最終状態**をブロックチェーンに保存するだけで**送信**します。\
これにより、Bitcoinブロックチェーンの**スピードが向上**し（1秒あたり最大7回の支払いしか許可されない）、Bitcoinブロックチェーンのノードを介してチャネルが作成されるため、**追跡が難しいトランザクションを作成**できます：

![](<../../.gitbook/assets/image (611).png>)

Lightning Networkの通常の使用方法は、関連する基本ブロックチェーン（レイヤー1）に資金トランザクションを確定させることによって**支払いチャネルを開設**し、その後、ブロックチェーンにそれらを**ブロードキャストせずにチャネルの資金の仮分配を更新する**任意の数のLightning Network **トランザクション**を行い、最終的な決済トランザクションの**最終バージョンをブロードキャスト**してチャネルの資金を分配することで**支払いチャネルを閉じる**ことです。

チャネルの両メンバーのどちらでも、いつでもチャネルを停止して最終状態をブロックチェーンに送信できます。

# Bitcoinプライバシー攻撃

## 共通の入力

理論的には、1つのトランザクションの入力は異なるユーザーに属する可能性がありますが、実際には追加の手順が必要です。したがって、非常に頻繁に**同じトランザクション内の2つの入力アドレスは同じ所有者に属していると仮定**されることがあります。

## UTXOのおつりアドレスの検出

**UTXO**は**未使用トランザクション出力**（
```
2 btc --> 4 btc
3 btc     1 btc
```
仮定されるのは、出力の1つがおつりであり、もう1つの出力が支払いであるとします。2つの解釈があります：支払い出力は4 BTC出力または1 BTC出力のいずれかです。しかし、1 BTC出力が支払い金額である場合、3 BTC入力は不要です。なぜなら、ウォレットは2 BTC入力のみを使って支払いを行い、より低いマイナー手数料を支払うことができたからです。これは、実際の支払い出力が4 BTCであり、1 BTCがおつり出力であることを示しています。

これは、複数の入力を持つトランザクションに対する問題です。このリークを修正する1つの方法は、おつり出力がどの入力よりも高くなるように、より多くの入力を追加することです。例えば：
```
2 btc --> 4 btc
3 btc     6 btc
5 btc
```
## 強制アドレス再利用

**強制アドレス再利用**または**インセンティブ付きアドレス再利用**は、敵対者がビットコインの少額を支払って、すでにブロックチェーンで使用されたアドレスに支払うことです。敵対者は、ユーザーやウォレットソフトウェアがこれらの支払いを入力として使用し、共通の入力所有ヒューリスティックを介して他のアドレスを明らかにすることを期待しています。これらの支払いは、アドレス所有者を意図しないアドレス再利用に強制する手段として理解できます。

この攻撃は、時々**ダスト攻撃**と誤って呼ばれます。

ウォレットの正しい振る舞いは、すでに使用された空のアドレスに着地したコインを使わないことです。

## その他のブロックチェーン分析

* **正確な支払額**: おつりのないトランザクションを避けるためには、支払いはUTXOと等しくなければなりません（これは非常に予期しないことです）。したがって、**おつりのないアドレス間のトランスファーである可能性が高い**。
* **丸められた数値**: トランザクションで、出力の1つが「**丸められた数値**」である場合、これはおそらくその「丸められた数値」の価格を設定した人への**支払い**であるため、もう一方は残りです。
* **ウォレットのフィンガープリント**: 慎重な分析者は、異なるウォレットソフトウェアが常にまったく同じ方法でトランザクションを作成しないため、特定のトランザクションを作成したソフトウェアを推測することがあります。ウォレットのフィンガープリントは、おつりの出力を検出するために使用できます。おつりの出力は、同じウォレットのフィンガープリントで使われるものです。
* **金額とタイミングの相関**: トランザクションを実行した人がトランザクションの**時間**や**金額**を開示した場合、それは簡単に**発見**できます。

## トラフィック分析

いくつかの組織があなたのトラフィックを**スニッフィング**してビットコインネットワークで通信しているのを見ることができます。\
敵対者が、以前に入力されていなかったトランザクションやブロックがあなたのノードから出てくるのを見ると、それはほぼ確実に**あなたによってトランザクションが行われたか、ブロックがあなたによって採掘されたことを知る**ことができます。インターネット接続が関係しているため、敵対者はIPアドレスを発見したビットコイン情報と関連付けることができます。

インターネットトラフィックをすべてスニッフィングすることができない攻撃者でも、**多くのビットコインノード**を持っていることで**ソースに近づく**ことができ、トランザクションやブロックを発表しているIPアドレスを知ることができるかもしれません。\
また、一部のウォレットは、未確認のトランザクションを定期的に再放送するため、ネットワーク全体に広く伝播し、採掘されやすくなります。

## アドレス所有者の情報を見つけるためのその他の攻撃

より多くの攻撃については、[https://en.bitcoin.it/wiki/Privacy](https://en.bitcoin.it/wiki/Privacy)を参照してください。

# 匿名ビットコイン

## 匿名でビットコインを入手する方法

* **現金取引**: 現金を使ってビットコインを購入します。
* **現金代替**: ギフトカードなどを購入し、オンラインでビットコインと交換します。
* **マイニング**: マイニングは最も匿名性の高いビットコインの入手方法です。これは、[マイニングプール](https://en.bitcoin.it/wiki/Pooled\_mining)が一般的にハッシャーのIPアドレスを知っているため、ソロマイニングにも当てはまります。
* **窃盗**: 理論的には、匿名ビットコインを入手する別の方法は窃盗です。

## ミキサー

ユーザーは**ビットコインをミキシングサービスに送信**し、サービスは**異なるビットコインをユーザーに返送**します（手数料を差し引いた状態で）。理論的には、ブロックチェーンを観察している敵対者は、着金と送金のトランザクションを**リンクすることができません**。

ただし、ユーザーはミキシングサービスがビットコインを返送し、お金の受け取りと送信の関係についてのログを保存していないことを信頼する必要があります。\
Bitcoinカジノなど、他のサービスもミキサーとして使用できます。

## CoinJoin

**CoinJoin**は、異なるユーザーの複数のトランザクションを1つに混合して、外部の観察者が**どの入力がどの出力に関連しているか**を見つけにくくすることを目的としています。\
これは新しいプライバシーレベルを提供しますが、**一部のトランザクション**では、一部の入力と出力金額が相関しているか、他の入力と出力と非常に異なる場合、**外部の観察者によって相関付けられる可能性があります**。

ビットコインのブロックチェーン上で（おそらく）CoinJoinトランザクションIDの例は、`402d3e1df685d1fdf82f36b220079c1bf44db227df2d676625ebcbee3f6cb22a`と`85378815f6ee170aa8c26694ee2df42b99cff7fa9357f073c1192fff1f540238`です。

[**https://coinjoin.io/en**](https://coinjoin.io/en)\
**CoinJoinに似ていますが、イーサリアム用のより優れたものとして** [**Tornado Cash**](https://tornado.cash) **（お金はマイナーから提供されるため、ウォレットに表示されるだけです）。**

## PayJoin

前のセクションで議論されたCoinJoinのタイプは、同じ値の複数の出力をチェックすることで簡単に特定できます。

PayJoin（または支払い先ポイントまたはP2EPとも呼ばれる）は、2つの当事者間の特別なCoinJoinであり、一方の当事者が他方に支払います。そのトランザクションには**同じ値の複数の出力がない**ため、平等な出力のCoinJoinとして明らかに見えません。このトランザクションを考慮してください。
```
2 btc --> 3 btc
5 btc     4 btc
```
単純な取引として解釈される可能性があり、残りのおつりを支払う取引（支払いとおつりのどちらがどのアウトプットかは無視する）。この取引を別の方法で解釈すると、2 BTCのインプットが商人の所有であり、5 BTCが顧客の所有であり、この取引は顧客が商人に1 BTCを支払うものとなる。これら2つの解釈のどちらが正しいかはわからない。その結果、共通インプット所有ヒューリスティックを破り、プライバシーを向上させるコインジョイン取引が行われるが、これは**通常のビットコイン取引と区別がつかず、検出不可能**である。

PayJoin取引が適度に使用されるようになると、**実践上共通インプット所有ヒューリスティックは完全に間違っている**ことになる。これらは検出不可能なので、現在使用されているかどうかさえわからない。取引監視会社はほとんどがこのヒューリスティックに依存しているため、2019年時点ではPayJoinのアイデアに大きな期待が寄せられている。

# ビットコインのプライバシーの良い実践方法

## ウォレットの同期

ビットコインウォレットは、自分の残高や履歴に関する情報をどこかから取得する必要がある。2018年末時点で、最も実用的でプライベートな既存の解決策は、**フルノードウォレット**（最大限にプライベート）と**クライアントサイドブロックフィルタリング**（非常に優れている）を使用することである。

* **フルノード:** フルノードは、ビットコインでこれまでに行われたすべてのオンチェーン[取引](https://en.bitcoin.it/wiki/Transaction)を含むブロックチェーン全体をダウンロードする。したがって、ユーザーのインターネット接続を監視している敵対者は、ユーザーが興味を持っている取引やアドレスを知ることができない。
* **クライアントサイドブロックフィルタリング:** クライアントサイドブロックフィルタリングは、ブロック内のすべての取引のすべての**アドレス**を含む**フィルター**を作成することで機能する。フィルターは要素がセット内にあるかどうかをテストできる。誤検知は可能だが、誤検出はない。軽量ウォレットは、**ブロックチェーン**内のすべての**ブロック**のすべてのフィルターをダウンロードし、自分の**アドレス**と一致するかどうかをチェックする。一致するブロックはピアツーピアネットワークから完全にダウンロードされ、そのブロックを使用してウォレットの履歴と現在の残高を取得する。

## Tor

ビットコインネットワークはピアツーピアネットワークを使用しているため、他のピアはあなたのIPアドレスを知ることができる。これが、**ビットコインネットワークとやり取りする際に毎回Torを介して接続することをお勧めする理由**です。

## アドレス再利用の回避

**アドレスを複数回使用することは、プライバシーに非常に損害を与えるため、それによってより多くのブロックチェーン取引が同じエンティティによって作成されたことの証拠と結びつく**。ビットコインを最もプライベートで安全に使用する方法は、支払いを行うたびに支払いを行う各人に新しいアドレスを送信することです。受け取ったコインを使い切った後は、そのアドレスを再利用しないようにするべきです。また、ビットコインを送信する際には新しいビットコインアドレスを要求すべきです。すべての優れたビットコインウォレットには、アドレスの再利用を desu するユーザーインターフェースが備わっています。

## 複数の取引

**1回のチェーン上の取引で複数の支払いを行う**ことは、金額に基づくプライバシー攻撃（金額の相関や丸められた数値など）の影響を大幅に軽減することができます。例えば、ユーザーが誰かに5 BTCを支払いたいが、その5 BTCの価値が簡単に検索されたくない場合、2 BTCと3 BTCの2つの取引を送信して、合計5 BTCになるようにすることができます。

## おつりの回避

おつりの回避とは、取引のインプットとアウトプットが慎重に選択され、全くおつりのアウトプットが必要ないようにすることです。**おつりのアウトプットがないことはプライバシーに優れている**ため、おつりの検出ヒューリスティックを破るのに役立ちます。

## 複数のおつりのアウトプット

おつりの回避が選択肢でない場合、**1つ以上のおつりのアウトプットを作成することでプライバシーを向上**させることができます。これは通常のより多くのブロックスペースを使用するため、おつりの回避が望ましいです。

# Monero

Moneroが開発されたとき、**完全な匿名性**への切実なニーズを解決しようとしたものであり、大きな部分でその空白を埋めています。

# Ethereum

## ガス

ガスとは、Ethereumネットワーク上で特定の操作を実行するために必要な**計算労力**の単位を指します。ガスは、Ethereum上で**取引**を成功裏に実行するために必要な**手数料**を指します。

ガス価格は**gwei**で表され、これ自体がETHの単位であり、1 gweiは**0.000000001 ETH**（10^-9 ETH）に等しいです。例えば、ガスが0.000000001イーサであると言う代わりに、ガスが1 gweiであると言うことができます。'gwei'という言葉自体は'ギガウェイ'を意味し、**1,000,000,000 wei**に等しいです。Wei自体が**ETHの最小単位**です。

取引にかかるガスを計算するための例を読んでみましょう：

ジョーダンがテイラーに1 ETH支払わなければならないとします。取引では、ガスリミットは21,000ユニットで、ベース料金は100 gweiです。ジョーダンは10 gweiのチップを含めます。

上記の式を使用して、これを`21,000 * (100 + 10) = 2,310,000 gwei`または0.00231 ETHと計算できます。

ジョーダンがお金を送ると、ジョーダンの口座から1.00231 ETHが差し引かれます。テイラーは1.0000 ETHが入金されます。マイナーは0.00021 ETHのチップを受け取ります。0.0021 ETHのベース料金が燃やされます。

さらに、ジョーダンは取引のために`maxFeePerGas`を設定することもできます。最大料金と実際の料金の差額はジョーダンに返金されます。つまり、`返金 = 最大料金 - （ベース料金 + 優先料金）`です。ジョーダンは取引が実行される際にベース料金を超過する心配をせずに、取引の実行に支払う最大金額を設定することができます。

ベース料金は、ブロックスペースの需要に基づいてネットワークによって計算されるため、この最後のパラメータである`maxFeePerGas`は、支払う最大料金を制御するのに役立ちます。

## 取引

**Ethereum**ネットワークでは、取引は2つのアドレス間で行われ、これらは**ユーザーまたはスマートコントラクトアドレス**である可能性があります。\
**スマートコントラクト**は、**特別な** **取引**を介して分散台帳に格納されます。

EVMの状態を変更する取引は、ネットワーク全体にブロードキャストする必要があります。任意のノードは、EVMで実行される取引のリクエストをブロードキャストできます。その後、**マイナー**が**取引**を**実行**し、その結果の状態変更をネットワーク全体に伝播します。\
取引には**手数料**が必要であり、有効になるためにはマイニングされなければなりません。

提出された取引には、次の情報が含まれます：

* `recipient` – 受信アドレス（外部所有アカウントの場合、取引は価値を転送します。コントラクトアカウントの場合、取引はコントラクトコードを実行します）
* `signature` – 送信者の識別子。これは、送信者の秘密鍵が取引に署名し、送信者がこの取引を承認したことを確認すると生成されます
* `value` – 送信者から受信者に転送するETHの金額（WEIで表されるETHの単位）
* `data` – 任意のデータを含めるためのフィールド
* `gasLimit` – 取引で消費できる最大ガスユニット数。ガスの単位は計算ステップを表します
* `maxPriorityFeePerGas` - マイナーにチップとして含めることができる最大ガス量
* `maxFeePerGas` - 取引に支払うことができる最大ガス量（`baseFeePerGas`と`maxPriorityFeePerGas`を含む）

起源アドレスのフィールドは存在しないことに注意してください。これは、これが署名から推測できるためです。

# 参考文献

* [https://en.wikipedia.org/wiki/Proof\_of\_stake](https://en.wikipedia.org/wiki/Proof\_of\_stake)
* [https://www.mycryptopedia.com/public-key-private-key-explained/](https://www.mycryptopedia.com/public-key-private-key-explained/)
* [https://bitcoin.stackexchange.com/questions/3718/what-are-multi-signature-transactions](https://bitcoin.stackexchange.com/questions/3718/what-are-multi-signature-transactions)
* [https://ethereum.org/en/developers/docs/transactions/](https://ethereum.org/en/developers/docs/transactions/)
* [https://ethereum.org/en/developers/docs/gas/](https://ethereum.org/en/developers/docs/gas/)
* [https://en.bitcoin.it/wiki/Privacy](https://en.bitcoin.it/wiki/Privacy#Forced\_address\_reuse)
